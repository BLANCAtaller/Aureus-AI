<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AUREUS AI - Finance OS</title>
    <meta name="description"
        content="Advanced Financial Operating System driven by AI. Manage wealth, track expenses, and optimize growth with AUREUS.">

    <!-- PWA & Mobile -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0B0D14">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Open Graph / Social -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="AUREUS AI - Finance OS">
    <meta property="og:description" content="Advanced Financial Operating System.">
    <meta property="og:image" content="assets/card-preview.png">

    <link rel="icon" type="image/svg+xml" href="assets/logo.svg">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Indie+Flower&family=Inter:wght@300;400;500;600;700;800;900&family=Outfit:wght@300;400;500;600;700;800;900&family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;0,800;0,900;1,400&family=Rajdhani:wght@300;400;500;600;700&family=Roboto+Slab:wght@100;200;300;400;500;600;700;800;900&family=MedievalSharp&family=Metal+Mania&family=Pirata+One&family=UnifrakturMaguntia&display=swap"
        rel="stylesheet">

    <!-- SweetAlert2 for nice alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Add jsPDF library explicitly -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            900: '#0B0D14', // Deeper, colder background
                            800: '#141724', // Richer card background
                            700: '#1C2133', // Lighter surface
                            600: '#2A3042',
                        },
                        primary: 'var(--color-primary)',
                        adaptive: 'var(--text-primary)',
                        subtle: 'var(--text-secondary)',
                    },
                    spacing: {
                        '1': 'calc(0.25rem * var(--spacing-factor))',
                        '2': 'calc(0.5rem * var(--spacing-factor))',
                        '3': 'calc(0.75rem * var(--spacing-factor))',
                        '4': 'calc(1rem * var(--spacing-factor))',
                        '5': 'calc(1.25rem * var(--spacing-factor))',
                        '6': 'calc(1.5rem * var(--spacing-factor))',
                        '8': 'calc(2rem * var(--spacing-factor))',
                        '10': 'calc(2.5rem * var(--spacing-factor))',
                        '12': 'calc(3rem * var(--spacing-factor))',
                        '16': 'calc(4rem * var(--spacing-factor))',
                        '20': 'calc(5rem * var(--spacing-factor))',
                        '24': 'calc(6rem * var(--spacing-factor))',
                        '32': 'calc(8rem * var(--spacing-factor))',
                    },
                    borderRadius: {
                        'none': '0px',
                        'sm': 'calc(0.125rem * (var(--radius-base) / 0.75rem))',
                        'md': 'calc(0.375rem * (var(--radius-base) / 0.75rem))',
                        'lg': 'calc(0.5rem * (var(--radius-base) / 0.75rem))',
                        'xl': 'var(--radius-base)',
                        '2xl': 'calc(var(--radius-base) * 1.5)',
                        '3xl': 'calc(var(--radius-base) * 2)',
                        'full': '9999px',
                    },
                    boxShadow: {
                        'glow': '0 0 20px -5px var(--color-primary)',
                        'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.37)'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --color-primary: #6366F1;
            /* Dark Theme (Default) */
            --bg-main: #0B0D14;
            --bg-card: #141724;
            --text-primary: #F8FAFC;
            --text-secondary: #64748B;

            /* Dynamic Settings Defaults */
            --radius-base: 0.75rem;
            --glass-blur: 12px;
            --spacing-factor: 1;
            --font-scale: 1;
            --font-tracking: 0em;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            background-image:
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.03) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(168, 85, 247, 0.03) 0px, transparent 50%);
            background-attachment: fixed;
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(20, 23, 36, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .glass-input {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .glass-input:focus {
            background: rgba(15, 23, 42, 0.8);
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        /* --- BORDER FX ENGINE --- */
        /* Targets elements with the common border class to apply effects */

        /* Subtle: Just a bit more visible white border */
        [data-border-fx="subtle"] .border-white\/5,
        [data-border-fx="subtle"] .border-white\/10 {
            border-color: rgba(255, 255, 255, 0.2) !important;
            transition: border-color 0.5s ease;
        }

        /* Glow: Primary color border with soft shadow */
        [data-border-fx="glow"] .border-white\/5,
        [data-border-fx="glow"] .border-white\/10 {
            border-color: var(--color-primary) !important;
            box-shadow: 0 0 15px -5px var(--color-primary);
            transition: all 0.5s ease;
        }

        /* Neon: Hard primary border with inner quench */
        [data-border-fx="neon"] .border-white\/5,
        [data-border-fx="neon"] .border-white\/10 {
            border-color: var(--color-primary) !important;
            box-shadow: 0 0 5px var(--color-primary), inset 0 0 10px rgba(0, 0, 0, 0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Pulse: Breeding animation */
        [data-border-fx="pulse"] .border-white\/5,
        [data-border-fx="pulse"] .border-white\/10 {
            animation: fxPulse 3s infinite alternate;
        }

        @keyframes fxPulse {
            0% {
                border-color: rgba(255, 255, 255, 0.1);
                box-shadow: none;
            }

            100% {
                border-color: var(--color-primary);
                box-shadow: 0 0 20px -5px var(--color-primary);
            }
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .apexcharts-tooltip {
            background: #1E293B !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5) !important;
            color: #fff;
        }

        .apexcharts-tooltip-title {
            background: #0F172A !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important;
            font-family: 'Inter', sans-serif !important;
        }

        .smooth-shadow {
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.3);
        }

        /* --- PRIVACY MASKING --- */
        .mask-active .maskable {
            filter: blur(8px) saturate(1.2);
            pointer-events: none;
            user-select: none;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .maskable {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-block;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Outfit:wght@300;400;500;600;700;800&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Rajdhani:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Force Dark Mode Always -->
    <script>
            // Execute immediately to prevent flash
            (function () {
                const saved = localStorage.getItem('theme') || 'dark';
                if (saved === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            })();
    </script>
</head>

<body class="dark bg-dark-900 text-adaptive overflow-hidden h-screen flex">

    <!-- LOGIN SCREEN OVERLAY -->
    <!-- Managed by auth_service.js. Hidden by default, shown if no session. -->


    <!-- State Manager (Multi-User Core) -->
    <script src="state_manager.js"></script>

    <!-- Auth Service -->
    <script src="auth_service.js"></script>

    <!-- Sidebar -->
    <aside
        class="hidden lg:flex flex-col w-72 h-full glass-panel backdrop-blur-2xl shadow-[0_0_40px_-10px_rgba(0,0,0,0.5)] relative z-20 font-inter border-r-0">

        <!-- App Branding -->
        <div class="w-full flex flex-col items-center justify-center px-6 pt-8 pb-6">
            <!-- AUREUS AI Logo - Compact Design v5 -->
            <!-- Sacred Geometry Logo (Recreation) -->
            <svg id="sidebar-logo" class="w-16 h-16 mb-4" viewBox="0 0 100 100" fill="none"
                xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="premiumGold" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#bf953f" />
                        <stop offset="25%" style="stop-color:#fcf6ba" />
                        <stop offset="50%" style="stop-color:#b38728" />
                        <stop offset="75%" style="stop-color:#fcf6ba" />
                        <stop offset="100%" style="stop-color:#aa771c" />
                    </linearGradient>
                    <filter id="logoGlow" x="-20%" y="-20%" width="140%" height="140%">
                        <feGaussianBlur stdDeviation="1.5" result="blur" />
                        <feComposite in="SourceGraphic" in2="blur" operator="over" />
                    </filter>
                </defs>

                <g filter="url(#logoGlow)">
                    <!-- Outer Circle -->
                    <circle cx="50" cy="50" r="46" stroke="url(#premiumGold)" stroke-width="2.5" />

                    <!-- Vertical Line -->
                    <line x1="50" y1="4" x2="50" y2="96" stroke="url(#premiumGold)" stroke-width="1.5" />

                    <!-- Horizontal Line -->
                    <line x1="4" y1="50" x2="96" y2="50" stroke="url(#premiumGold)" stroke-width="1.5" opacity="0.5" />

                    <!-- Seed of Life Pattern (6 overlapping circles) -->
                    <!-- Center: (50, 50), Radius: 23 -->
                    <circle cx="50" cy="27" r="23" stroke="url(#premiumGold)" stroke-width="1.5" />
                    <circle cx="50" cy="73" r="23" stroke="url(#premiumGold)" stroke-width="1.5" />
                    <circle cx="30" cy="38.5" r="23" stroke="url(#premiumGold)" stroke-width="1.5" />
                    <circle cx="70" cy="38.5" r="23" stroke="url(#premiumGold)" stroke-width="1.5" />
                    <circle cx="30" cy="61.5" r="23" stroke="url(#premiumGold)" stroke-width="1.5" />
                    <circle cx="70" cy="61.5" r="23" stroke="url(#premiumGold)" stroke-width="1.5" />

                    <!-- Inner Decorative Arcs -->
                    <circle cx="50" cy="50" r="28" stroke="url(#premiumGold)" stroke-width="1" opacity="0.6" />

                    <!-- Central Core Circle -->
                    <circle cx="50" cy="50" r="6" fill="url(#premiumGold)" />
                    <circle cx="50" cy="50" r="10" stroke="url(#premiumGold)" stroke-width="1.5" />
                </g>
            </svg>

            <!-- Brand Name -->
            <h1 class="text-3xl font-black tracking-tight mb-1">
                <span class="text-white">AUREUS</span><span class="text-purple-400">AI</span>
            </h1>
            <!-- Tagline -->
            <p class="text-[10px] font-semibold text-slate-500 uppercase tracking-[0.25em]">Finance OS</p>
        </div>

        <!-- Top Stats Widget -->
        <div class="flex flex-col items-center mb-2 w-full mt-2">
            <div class="flex justify-between w-full mb-2 px-3">
                <div class="text-center">
                    <p class="text-2xl font-black text-adaptive font-sans" id="sidebar-goal-count">3</p>
                    <p class="text-[9px] font-bold text-subtle uppercase tracking-wider">WASTE</p>
                </div>
                <div class="text-center">
                    <p class="text-2xl font-black text-adaptive font-sans" id="sidebar-wants-pct">--%</p>
                    <p class="text-[9px] font-bold text-subtle uppercase tracking-wider" id="sidebar-wants-label">WANTS
                    </p>
                </div>
            </div>

            <!-- Ring Chart -->
            <div class="relative w-44 h-44 flex items-center justify-center mt-2 mb-2">
                <div id="sidebarRingChart" class="w-full h-full flex items-center justify-center scale-110"></div>
                <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none pt-2">
                    <span class="text-3xl font-black text-slate-800 dark:text-white tracking-tight">13%</span>
                    <span class="text-[9px] text-slate-500 font-bold uppercase w-16 text-center leading-tight">GASTO
                        MENSUAL</span>
                </div>
            </div>

            <div id="sidebar-today-stats" class="flex justify-between w-full px-4 mt-6 mb-2">
                <div class="text-center group cursor-default">
                    <p id="sidebar-today-amount" class="text-2xl font-black text-white font-sans tracking-tight">$0</p>
                    <p class="text-[8px] font-bold text-slate-500 uppercase leading-tight tracking-widest mt-1">GASTO
                        DIARIO</p>
                </div>
                <div class="text-center group cursor-default">
                    <p id="sidebar-today-count" class="text-2xl font-black text-white font-sans tracking-tight">0</p>
                    <p class="text-[8px] font-bold text-slate-500 uppercase leading-tight tracking-widest mt-1">
                        TRANSACCIONES</p>
                </div>
            </div>
        </div>

        <nav class="flex-1 w-full flex flex-col justify-end space-y-2 pb-6" id="sidebarNav">
            <!-- 1. Dashboard -->
            <!-- 1. Dashboard -->
            <a href="#" onclick="switchTab('dashboard'); setTimeout(renderMegaDashboard, 100); return false;"
                id="nav-dashboard"
                class="nav-item flex items-center gap-4 px-6 py-2.5 rounded-2xl bg-white/5 text-slate-400 hover:text-white hover:bg-white/10 transition-all duration-300 transform hover:scale-[1.02] group border border-dashed border-white/5 hover:border-white/20 hover:shadow-glow">
                <i data-lucide="layout-dashboard"
                    class="w-5 h-5 opacity-70 group-hover:opacity-100 group-hover:text-primary transition-all"></i>
                <span class="font-bold tracking-widest text-[10px] uppercase">DASHBOARD</span>
            </a>
            <!-- 1b. Dashboard 2.0 Moved Below -->
            <!-- 2. Wallet -->
            <a href="#" onclick="switchTab('wallet'); return false;" id="nav-wallet"
                class="nav-item flex items-center gap-4 px-6 py-2.5 rounded-2xl bg-white/5 text-slate-400 hover:text-white hover:bg-white/10 transition-all duration-300 transform hover:scale-[1.02] group border border-dashed border-white/5 hover:border-white/20 hover:shadow-glow">
                <i data-lucide="wallet"
                    class="w-5 h-5 opacity-70 group-hover:opacity-100 group-hover:text-primary transition-all"></i>
                <span class="font-bold tracking-widest text-[10px] uppercase">WALLET</span>
            </a>
            <!-- 3. Budget (Presupuesto) -->
            <a href="#" onclick="switchTab('budget'); setTimeout(renderBudgetTabAnalytics, 200); return false;"
                id="nav-budget"
                class="nav-item flex items-center gap-4 px-6 py-2.5 rounded-2xl bg-white/5 text-slate-400 hover:text-white hover:bg-white/10 transition-all duration-300 transform hover:scale-[1.02] group border border-dashed border-white/5 hover:border-white/20 hover:shadow-glow">
                <i data-lucide="landmark"
                    class="w-5 h-5 opacity-70 group-hover:opacity-100 group-hover:text-primary transition-all"></i>
                <span class="font-bold tracking-widest text-[10px] uppercase">FINANZAS</span>
            </a>
            <!-- 4. Analytics Overview -->

            <!-- 3.5 Savings (Ahorro) -->
            <a href="#" onclick="switchTab('savings'); return false;" id="nav-savings"
                class="nav-item flex items-center gap-4 px-6 py-2.5 rounded-2xl bg-white/5 text-slate-400 hover:text-white hover:bg-white/10 transition-all duration-300 transform hover:scale-[1.02] group border border-dashed border-white/5 hover:border-white/20 hover:shadow-glow">
                <i data-lucide="piggy-bank"
                    class="w-5 h-5 opacity-70 group-hover:opacity-100 group-hover:text-primary transition-all"></i>
                <span class="font-bold tracking-widest text-[10px] uppercase">AHORRO</span>
            </a>

            <!-- 5. Settings -->
            <a href="#" onclick="switchTab('settings'); return false;" id="nav-settings"
                class="nav-item flex items-center gap-4 px-6 py-2.5 rounded-2xl bg-white/5 text-slate-400 hover:text-white hover:bg-white/10 transition-all duration-300 transform hover:scale-[1.02] group border border-dashed border-white/5 hover:border-white/20 hover:shadow-glow">
                <i data-lucide="settings"
                    class="w-5 h-5 opacity-70 group-hover:opacity-100 group-hover:text-primary transition-all"></i>
                <span class="font-bold tracking-widest text-[10px] uppercase">SETTINGS</span>
            </a>

            <!-- 6. Logout Removed from Sidebar -->
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-8 overflow-y-auto h-full relative">
        <!-- Header -->
        <!-- Header -->
        <header class="flex flex-row items-center justify-between gap-4 mb-8">
            <!-- Header Branding removed as requested -->
            <!-- Header Branding / Mobile Menu -->
            <div class="flex items-center gap-4">
                <button onclick="toggleMobileMenu()"
                    class="lg:hidden p-2 rounded-xl bg-white/5 border border-white/5 text-slate-400 hover:text-white transition active:scale-95">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <div class="lg:hidden text-xl font-black tracking-tight">
                    <span class="text-white">AUREUS</span><span class="text-purple-400">AI</span>
                </div>
            </div>

            <!-- Mobile Dropdown Menu (Top Left) -->
            <div id="mobile-menu-dropdown"
                class="fixed top-20 left-4 z-[60] w-64 bg-[#0F1116]/95 backdrop-blur-2xl border border-white/10 rounded-2xl shadow-2xl transform transition-all duration-300 origin-top-left scale-95 opacity-0 pointer-events-none hidden">
                <div class="p-2 space-y-1">
                    <a href="#" onclick="switchTab('dashboard'); toggleMobileMenu(); return false;"
                        class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 text-slate-400 hover:text-white transition group">
                        <div class="p-2 rounded-lg bg-indigo-500/10 text-indigo-400 group-hover:bg-indigo-500/20">
                            <i data-lucide="layout-grid" class="w-5 h-5"></i>
                        </div>
                        <span class="font-bold tracking-wider text-xs uppercase">Inicio</span>
                    </a>
                    <a href="#" onclick="switchTab('wallet'); toggleMobileMenu(); return false;"
                        class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 text-slate-400 hover:text-white transition group">
                        <div class="p-2 rounded-lg bg-emerald-500/10 text-emerald-400 group-hover:bg-emerald-500/20">
                            <i data-lucide="wallet" class="w-5 h-5"></i>
                        </div>
                        <span class="font-bold tracking-wider text-xs uppercase">Wallet</span>
                    </a>
                    <a href="#" onclick="switchTab('budget'); toggleMobileMenu(); return false;"
                        class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 text-slate-400 hover:text-white transition group">
                        <div class="p-2 rounded-lg bg-amber-500/10 text-amber-500 group-hover:bg-amber-500/20">
                            <i data-lucide="map" class="w-5 h-5"></i>
                        </div>
                        <span class="font-bold tracking-wider text-xs uppercase">Plan</span>
                    </a>
                    <a href="#" onclick="switchTab('savings'); toggleMobileMenu(); return false;"
                        class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 text-slate-400 hover:text-white transition group">
                        <div class="p-2 rounded-lg bg-indigo-500/10 text-indigo-500 group-hover:bg-indigo-500/20">
                            <i data-lucide="piggy-bank" class="w-5 h-5"></i>
                        </div>
                        <span class="font-bold tracking-wider text-xs uppercase">Ahorro</span>
                    </a>
                    <div class="h-px bg-white/5 my-1"></div>
                    <a href="#" onclick="switchTab('settings'); toggleMobileMenu(); return false;"
                        class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 text-slate-400 hover:text-white transition group">
                        <div class="p-2 rounded-lg bg-slate-700/30 text-slate-400 group-hover:bg-slate-700/50">
                            <i data-lucide="settings" class="w-5 h-5"></i>
                        </div>
                        <span class="font-bold tracking-wider text-xs uppercase">Ajustes</span>
                    </a>
                </div>
            </div>

            <script>
                function toggleMobileMenu() {
                    const menu = document.getElementById('mobile-menu-dropdown');
                    if (menu.classList.contains('hidden')) {
                        menu.classList.remove('hidden');
                        // Small delay to allow transition
                        setTimeout(() => {
                            menu.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
                            menu.classList.add('opacity-100', 'scale-100', 'pointer-events-auto');
                        }, 10);
                    } else {
                        menu.classList.remove('opacity-100', 'scale-100', 'pointer-events-auto');
                        menu.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
                        setTimeout(() => {
                            menu.classList.add('hidden');
                        }, 300);
                    }
                }
            </script>
            <div class="flex items-center gap-4">
                <button onclick="universalSave()"
                    class="flex items-center gap-2 bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-400 px-4 py-2 rounded-full text-xs font-bold transition border border-emerald-500/20 hover:border-emerald-500/40 shadow-lg shadow-emerald-500/5 group"
                    title="Guardar información">
                    <i data-lucide="save" class="w-4 h-4 group-hover:scale-110 transition-transform"></i>
                    <span>GUARDAR</span>
                </button>
                <button onclick="downloadBackup()"
                    class="flex items-center justify-center bg-dark-800 hover:bg-dark-700 text-slate-400 hover:text-emerald-400 w-9 h-9 rounded-full transition border border-white/5 hover:border-emerald-500/30 group"
                    title="Descargar respaldo físico (JSON)">
                    <i data-lucide="download-cloud" class="w-4 h-4 group-hover:scale-110 transition-transform"></i>
                </button>
                <button onclick="manualRefresh()"
                    class="flex items-center justify-center bg-dark-800 hover:bg-dark-700 text-slate-400 hover:text-indigo-400 w-9 h-9 rounded-full transition border border-white/5 hover:border-indigo-500/30 group"
                    title="Actualizar Gráficas y Elementos">
                    <i data-lucide="refresh-cw"
                        class="w-4 h-4 group-hover:rotate-180 transition-transform duration-500"></i>
                </button>
            </div>
        </header>

        <script>
            function manualRefresh() {
                console.log("Manual Refresh Triggered");
                if (typeof renderMergedDashboard === 'function') renderMergedDashboard();
                if (typeof renderWalletHistory === 'function') renderWalletHistory();
                if (typeof renderSavingsTab === 'function') renderSavingsTab();
                if (typeof renderNetWorthChart === 'function') renderNetWorthChart();
                if (typeof lucide !== 'undefined') lucide.createIcons();

                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: 'Interfaz Actualizada',
                    showConfirmButton: false,
                    timer: 1500,
                    background: '#1e293b',
                    color: '#fff'
                });
            }
        </script>

        <!-- FOCUS DETAILS MODAL (New Premium UI) -->
        <!-- FOCUS DETAILS MODAL (Premium Glass Design) -->
        <div id="modal-focus-details" class="fixed inset-0 z-[100] hidden">
            <!-- Backdrop -->
            <div class="absolute inset-0 bg-black/80 backdrop-blur-md transition-opacity duration-300"
                onclick="closeFocusModal()"></div>

            <!-- Modal Content -->
            <div
                class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-sm transform transition-all duration-300 scale-100">
                <div
                    class="bg-[#0B0D14]/90 backdrop-blur-2xl rounded-[3rem] p-1 border border-white/10 shadow-[0_0_50px_-10px_rgba(0,0,0,0.5)] relative overflow-hidden group/modal">

                    <!-- Inner Container -->
                    <div class="rounded-[2.8rem] bg-[#141724]/50 p-8 relative overflow-hidden">

                        <!-- Dynamic Background Spotlights -->
                        <div
                            class="absolute -top-20 -right-20 w-40 h-40 bg-indigo-500/20 rounded-full blur-[50px] pointer-events-none group-hover/modal:bg-indigo-500/30 transition-all duration-1000">
                        </div>
                        <div
                            class="absolute -bottom-20 -left-20 w-40 h-40 bg-purple-500/20 rounded-full blur-[50px] pointer-events-none group-hover/modal:bg-purple-500/30 transition-all duration-1000">
                        </div>

                        <!-- Close Button -->
                        <button onclick="closeFocusModal()"
                            class="absolute top-6 right-6 w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 border border-white/5 flex items-center justify-center text-slate-400 hover:text-white transition z-20">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>

                        <!-- Content Stack -->
                        <div class="relative z-10 flex flex-col items-center">

                            <!-- Icon/Badge -->
                            <div class="mb-5 relative">
                                <div
                                    class="w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-500/20 to-purple-500/20 border border-indigo-500/30 flex items-center justify-center shadow-[0_0_20px_rgba(99,102,241,0.2)]">
                                    <i data-lucide="target" class="w-8 h-8 text-indigo-400"></i>
                                </div>
                                <div class="absolute -bottom-3 inset-x-0 flex justify-center">
                                    <div
                                        class="px-3 py-1 rounded-full bg-[#0B0D14] border border-indigo-500/30 shadow-lg">
                                        <span id="focus-modal-badge"
                                            class="text-[9px] uppercase font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400 tracking-widest leading-none">NEEDS</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Title -->
                            <h2 id="focus-modal-title"
                                class="text-2xl font-black text-white text-center mb-1 tracking-tight mt-2">Detalles
                            </h2>
                            <p class="text-[10px] uppercase font-bold text-slate-500 tracking-[0.2em] mb-8">Análisis
                                Financiero</p>

                            <!-- Percentage Big Metric -->
                            <div class="relative mb-8 text-center">
                                <h3 id="focus-modal-percent"
                                    class="text-7xl font-black text-white tracking-tighter drop-shadow-2xl bg-gradient-to-b from-white to-slate-400 bg-clip-text text-transparent">
                                    45%</h3>
                                <p id="focus-modal-label"
                                    class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mt-[-5px]">Del
                                    Ingreso Total</p>
                            </div>

                            <!-- Progress Card -->
                            <div class="w-full bg-white/5 rounded-2xl p-4 border border-white/5 mb-6">
                                <div class="flex justify-between items-end mb-2">
                                    <div>
                                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">Gastado
                                        </p>
                                        <p id="focus-modal-spent" class="text-sm font-black text-white">$1,250</p>
                                    </div>
                                    <!-- Límite removed -->
                                </div>
                                <div
                                    class="w-full h-3 bg-black/40 rounded-full overflow-hidden border border-white/5 relative">
                                    <div id="focus-modal-bar"
                                        class="h-full bg-gradient-to-r from-indigo-500 via-purple-500 to-indigo-400 shadow-[0_0_15px_rgba(99,102,241,0.5)] transition-all duration-1000 relative">
                                        <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Description -->
                            <p id="focus-modal-desc"
                                class="text-center text-slate-400 text-[11px] leading-relaxed mb-8 px-4 font-medium">
                                Esta categoría representa tus gastos esenciales. Mantener esto por debajo del 50% es
                                ideal para una salud financiera robusta.
                            </p>

                            <!-- Actions -->
                            <div class="grid grid-cols-1 gap-3 w-full">
                                <button onclick="filterWalletByFocus()"
                                    class="py-3.5 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 hover:border-white/20 text-slate-300 font-bold text-[10px] uppercase tracking-widest transition transform active:scale-95 flex justify-center items-center gap-2">
                                    <i data-lucide="list-filter" class="w-3.5 h-3.5"></i> Ver Todos en Billetera
                                </button>
                            </div>



                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL ADD TRANSACTION -->
        <!-- DASHBOARD TAB -->
        <div id="view-dashboard" class="tab-content active">
            <!-- New Tab Header -->
            <div class="flex items-center gap-6 mb-10 pl-2">
                <div
                    class="w-16 h-16 rounded-[24px] bg-gradient-to-br from-indigo-500/20 to-purple-500/20 border border-white/10 flex items-center justify-center shadow-xl shadow-indigo-500/10">
                    <i data-lucide="layout-grid" class="w-8 h-8 text-indigo-400"></i>
                </div>
                <div class="flex flex-col">
                    <h2 class="text-4xl font-black text-white tracking-tight leading-tight uppercase">Dashboard</h2>
                    <p class="text-slate-500 text-xs font-bold tracking-[0.3em] uppercase">RESUMEN GENERAL</p>
                </div>
            </div>

            <!-- Mega Grid Layout -->
            <!-- HERO SECTION: Net Worth (Left) + Stats/Comparison (Right) -->
            <div class="grid grid-cols-1 xl:grid-cols-12 gap-6 mb-6">

                <!-- LEFT COLUMN: NET WORTH (Tall) -->
                <div
                    class="col-span-1 xl:col-span-7 bg-[#151921] rounded-[32px] p-8 border border-white/5 relative overflow-hidden shadow-2xl h-[500px] xl:h-[600px] flex flex-col group hover:border-white/10 transition-all duration-500 order-2 xl:order-1">
                    <!-- Ambient Glow -->
                    <div
                        class="absolute -top-20 -right-20 w-96 h-96 bg-indigo-500/5 rounded-full blur-[100px] pointer-events-none group-hover:bg-indigo-500/10 transition-all duration-1000">
                    </div>
                    <div class="flex justify-between items-start mb-6 z-10 relative">
                        <h3 class="text-slate-400 text-sm font-bold uppercase tracking-[0.2em] flex items-center gap-2">
                            <div class="p-1.5 rounded-lg bg-indigo-500/10 text-indigo-400"><i data-lucide="bar-chart-2"
                                    class="w-4 h-4"></i></div>
                            Seguimiento de Patrimonio Neto
                        </h3>
                        <div class="flex bg-[#0B0D14] rounded-lg p-1 border border-white/5 gap-1">
                            <button onclick="updateNetWorthRange(12, this)"
                                class="nw-range-btn px-2 py-1 text-[9px] font-bold text-white bg-indigo-500 rounded transition-all">1Y</button>
                            <button onclick="updateNetWorthRange(6, this)"
                                class="nw-range-btn px-2 py-1 text-[9px] font-bold text-slate-500 hover:text-white transition-all">6M</button>
                            <button onclick="updateNetWorthRange(3, this)"
                                class="nw-range-btn px-2 py-1 text-[9px] font-bold text-slate-500 hover:text-white transition-all">3M</button>
                            <button onclick="updateNetWorthRange('1M', this)"
                                class="nw-range-btn px-2 py-1 text-[9px] font-bold text-slate-500 hover:text-white transition-all">1M</button>
                            <button onclick="updateNetWorthRange('2W', this)"
                                class="nw-range-btn px-2 py-1 text-[9px] font-bold text-slate-500 hover:text-white transition-all">2W</button>
                        </div>
                        <script>
                            function updateNetWorthRange(range, btn) {
                                if (window.appState && window.appState.chartPreferences) {
                                    window.appState.chartPreferences.netWorth = range;
                                }
                                renderNetWorthChart(null, null, null, null, range);
                                setActiveNwBtn(btn);
                            }

                            function setActiveNwBtn(btn) {
                                document.querySelectorAll('.nw-range-btn').forEach(b => {
                                    b.classList.remove('text-white', 'bg-indigo-500');
                                    b.classList.add('text-slate-500');
                                });
                                btn.classList.remove('text-slate-500');
                                btn.classList.add('text-white', 'bg-indigo-500');
                            }

                            function updateComparisonRange(range, btn) {
                                if (window.appState && window.appState.chartPreferences) {
                                    window.appState.chartPreferences.comparison = range;
                                }
                                renderComparisonChart(null, null, null, range);
                                setActiveCompBtn(btn);
                            }

                            function setActiveCompBtn(btn) {
                                document.querySelectorAll('.comp-range-btn').forEach(b => {
                                    b.classList.remove('text-white', 'bg-indigo-500');
                                    b.classList.add('text-slate-500');
                                });
                                btn.classList.remove('text-slate-500');
                                btn.classList.add('text-white', 'bg-indigo-500');
                            }
                        </script>
                    </div>
                    <div id="netWorthChart" class="w-full flex-1"></div>
                </div>

                <!-- RIGHT COLUMN: STATS + COMPARISON (Wrapper acts as 'contents' on mobile to allow reordering children into main grid) -->
                <div class="contents xl:col-span-5 xl:flex xl:flex-col xl:gap-6 xl:h-[600px] xl:order-2">

                    <!-- ROW A: STATS (Balance, Income, Expense) -->
                    <div class="grid grid-cols-2 gap-4 h-auto min-h-[160px] shrink-0 order-1">

                        <!-- Total Balance (Span 2) -->
                        <div class="col-span-2 relative group">
                            <!-- Border Gradient (masked) -->
                            <div
                                class="absolute -inset-[1px] bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 rounded-[2rem] opacity-75 group-hover:opacity-100 blur-sm transition duration-500">
                            </div>

                            <!-- Card Content -->
                            <div
                                class="relative h-full bg-[#0F0F16] rounded-[2rem] p-6 overflow-hidden flex flex-col justify-between z-10">
                                <!-- Background Effects -->
                                <div
                                    class="absolute top-0 right-0 w-64 h-64 bg-indigo-500/10 rounded-full blur-[80px] pointer-events-none">
                                </div>
                                <div
                                    class="absolute bottom-0 left-0 w-48 h-48 bg-purple-500/10 rounded-full blur-[60px] pointer-events-none">
                                </div>

                                <!-- Header -->
                                <div class="flex items-center gap-3 mb-4 relative z-10">
                                    <div
                                        class="p-2.5 rounded-2xl bg-gradient-to-br from-indigo-500/20 to-purple-500/20 border border-indigo-500/30 text-indigo-400 shadow-[0_0_15px_rgba(99,102,241,0.2)]">
                                        <i data-lucide="wallet" class="w-5 h-5"></i>
                                    </div>
                                    <div>
                                        <h3
                                            class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.2em] leading-tight">
                                            Total Balance</h3>
                                        <p class="text-slate-500 text-[9px] font-medium tracking-wide">Lifetime Wealth
                                        </p>
                                    </div>
                                </div>

                                <!-- Number -->
                                <div class="relative z-10 flex flex-col gap-2">
                                    <h2 class="text-4xl lg:text-5xl font-black text-white tracking-tighter drop-shadow-lg"
                                        id="dash-balance">$0</h2>
                                    <!-- Decorative Bar (Restored) -->
                                    <div
                                        class="h-1.5 w-16 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full shadow-[0_0_15px_rgba(99,102,241,0.6)] animate-pulse">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Income -->
                        <div class="col-span-1 relative group">
                            <div
                                class="absolute inset-0 bg-emerald-500/5 rounded-[2rem] opacity-0 group-hover:opacity-100 transition duration-500">
                            </div>

                            <div
                                class="h-full bg-[#13131F] rounded-[2rem] p-5 border border-white/5 relative overflow-hidden flex flex-col justify-between hover:border-emerald-500/30 transition-all duration-300">
                                <!-- Mobile/Compact Layout adjust -->
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <h3 class="text-slate-400 text-[9px] font-bold uppercase tracking-[0.2em] mb-1">
                                            Ingresos (YTD)</h3>
                                    </div>
                                    <div
                                        class="p-2 rounded-xl bg-emerald-500/10 text-emerald-400 border border-emerald-500/10">
                                        <i data-lucide="arrow-down-left" class="w-4 h-4"></i>
                                    </div>
                                </div>

                                <div>
                                    <h2 class="text-2xl font-black text-white tracking-tight mb-2" id="dash-income">$0
                                    </h2>
                                    <!-- Dynamic Badge -->
                                    <div
                                        class="inline-flex items-center gap-1.5 px-2 py-1 rounded-lg bg-emerald-500/10 border border-emerald-500/10 w-fit">
                                        <i data-lucide="trending-up" class="w-3 h-3 text-emerald-400"></i>
                                        <span class="text-[9px] font-bold text-emerald-400">VS. PRIOR MONTH</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Expense -->
                        <div class="col-span-1 relative group">
                            <div
                                class="absolute inset-0 bg-rose-500/5 rounded-[2rem] opacity-0 group-hover:opacity-100 transition duration-500">
                            </div>

                            <div
                                class="h-full bg-[#13131F] rounded-[2rem] p-5 border border-white/5 relative overflow-hidden flex flex-col justify-between hover:border-rose-500/30 transition-all duration-300">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <h3 class="text-slate-400 text-[9px] font-bold uppercase tracking-[0.2em] mb-1">
                                            Gastos (YTD)</h3>
                                    </div>
                                    <div class="p-2 rounded-xl bg-rose-500/10 text-rose-500 border border-rose-500/10">
                                        <i data-lucide="arrow-up-right" class="w-4 h-4"></i>
                                    </div>
                                </div>

                                <div>
                                    <h2 class="text-2xl font-black text-white tracking-tight mb-2" id="dash-expense">$0
                                    </h2>
                                    <div
                                        class="inline-flex items-center gap-1.5 px-2 py-1 rounded-lg bg-rose-500/10 border border-rose-500/10 w-fit">
                                        <i data-lucide="trending-up" class="w-3 h-3 text-rose-500"></i>
                                        <span class="text-[9px] font-bold text-rose-500">VS. PRIOR MONTH</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ROW B: COMPARISON CHART (Fill Remainder) -->
                    <div
                        class="flex-1 bg-[#151921] rounded-[32px] p-6 border border-white/5 relative overflow-hidden shadow-2xl flex flex-col group hover:border-white/10 transition-all duration-500 order-3 h-[400px] xl:h-auto">
                        <!-- Dual Ambient Glow -->
                        <div
                            class="absolute -top-10 -right-10 w-40 h-40 bg-emerald-500/5 rounded-full blur-[60px] pointer-events-none group-hover:bg-emerald-500/10 transition-all duration-1000">
                        </div>
                        <div
                            class="absolute -bottom-10 -left-10 w-40 h-40 bg-rose-500/5 rounded-full blur-[60px] pointer-events-none group-hover:bg-rose-500/10 transition-all duration-1000">
                        </div>

                        <div class="flex justify-between items-start mb-2 relative z-10">
                            <div>
                                <h3
                                    class="text-slate-400 text-sm font-bold uppercase tracking-[0.2em] leading-tight flex items-center gap-2">
                                    <div class="p-1.5 rounded-lg bg-slate-700/30 text-slate-400"><i
                                            data-lucide="arrow-left-right" class="w-4 h-4"></i></div>
                                    Comparativa
                                </h3>
                            </div>
                            <div class="flex items-center gap-4">
                                <!-- Legend (Restored) -->
                                <div class="hidden sm:flex items-center gap-3">
                                    <div class="flex items-center gap-1.5">
                                        <span
                                            class="w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]"></span>
                                        <span class="text-[9px] font-bold text-slate-500 uppercase">Ing.</span>
                                    </div>
                                    <div class="flex items-center gap-1.5">
                                        <span
                                            class="w-1.5 h-1.5 rounded-full bg-rose-500 shadow-[0_0_8px_rgba(244,63,94,0.5)]"></span>
                                        <span class="text-[9px] font-bold text-slate-500 uppercase">Gas.</span>
                                    </div>
                                </div>
                                <!-- Range Buttons -->
                                <div class="flex bg-[#0B0D14] rounded-lg p-1 border border-white/5 gap-1">
                                    <button onclick="updateComparisonRange('1Y', this)"
                                        class="comp-range-btn px-2 py-1 text-[9px] font-bold text-slate-500 hover:text-white transition-all">1Y</button>
                                    <button onclick="updateComparisonRange('6M', this)"
                                        class="comp-range-btn px-2 py-1 text-[9px] font-bold text-slate-500 hover:text-white transition-all">6M</button>
                                    <button onclick="updateComparisonRange('3M', this)"
                                        class="comp-range-btn px-2 py-1 text-[9px] font-bold text-white bg-indigo-500 rounded transition-all">3M</button>
                                    <button onclick="updateComparisonRange('1M', this)"
                                        class="comp-range-btn px-2 py-1 text-[9px] font-bold text-slate-500 hover:text-white transition-all">1M</button>
                                    <button onclick="updateComparisonRange('2W', this)"
                                        class="comp-range-btn px-2 py-1 text-[9px] font-bold text-slate-500 hover:text-white transition-all">2W</button>
                                </div>
                            </div>
                            <script>
                                // Comparison logic moved to shared script block above
                            </script>
                            </script>
                        </div>
                        <div id="comparisonChart" class="w-full flex-1"></div>
                    </div>
                </div>
            </div>

            <!-- SECONDARY GRID: Dissection, Forecast, Analytics (3 Columns) -->
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 pb-32">

                <!-- Dissection (Moved here) -->


                <!-- AI Forecast Widget -->
                <!-- AI Forecast Widget (Redesigned) -->
                <!-- Financial Health Shield Widget (Option 1) -->
                <!-- Dashboard Calendar Widget (Swapped to Left) -->
                <div
                    class="col-span-1 bg-[#0f1115] rounded-[24px] p-5 border border-white/5 relative shadow-2xl min-h-[350px] h-auto flex flex-col group/calendar overflow-hidden hover:border-indigo-500/20 transition-all duration-500">

                    <!-- Calendar Header -->
                    <div class="flex justify-between items-start mb-2 relative z-10 shrink-0">
                        <!-- Left: Title & Navigator -->
                        <div class="flex flex-col gap-1.5">
                            <h3
                                class="text-slate-400 text-[11px] font-bold uppercase tracking-[0.2em] flex items-center gap-2">
                                <i data-lucide="calendar" class="w-3.5 h-3.5 text-indigo-400"></i> Daily Breakdown
                            </h3>

                            <!-- Premium Month Navigator (Unified Pill) -->
                            <div
                                class="flex items-center justify-between bg-white/5 px-1 py-1 rounded-xl border border-white/5 w-[160px] backdrop-blur-md shadow-inner">
                                <button onclick="window.changeDashboardMonth(-1)"
                                    class="p-1 hover:bg-white/10 rounded-lg transition text-slate-400 hover:text-white active:scale-95">
                                    <i data-lucide="chevron-left" class="w-3 h-3"></i>
                                </button>
                                <span id="dash-cal-month-title"
                                    class="font-bold text-white capitalize text-[10px] text-center font-sans tracking-wide">--</span>
                                <button onclick="window.changeDashboardMonth(1)"
                                    class="p-1 hover:bg-white/10 rounded-lg transition text-slate-400 hover:text-white active:scale-95">
                                    <i data-lucide="chevron-right" class="w-3 h-3"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Right: Date & Badge -->
                        <div class="text-right">
                            <h3 class="text-lg font-black text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-400 tracking-tighter"
                                id="dash-cal-current-date-short">
                                --
                            </h3>
                            <p class="text-[8px] font-bold text-indigo-400 uppercase tracking-widest mt-0 leading-none">
                                Today</p>
                        </div>
                    </div>

                    <!-- Weekday Headers (More spacing from header) -->
                    <div class="grid grid-cols-7 gap-1 text-center mb-1 mt-2 relative z-10 px-1 shrink-0">
                        <div class="text-[8px] font-bold text-slate-600 uppercase">Dom</div>
                        <div class="text-[8px] font-bold text-slate-600 uppercase">Lun</div>
                        <div class="text-[8px] font-bold text-slate-600 uppercase">Mar</div>
                        <div class="text-[8px] font-bold text-slate-600 uppercase">Mié</div>
                        <div class="text-[8px] font-bold text-slate-600 uppercase">Jue</div>
                        <div class="text-[8px] font-bold text-slate-600 uppercase">Vie</div>
                        <div class="text-[8px] font-bold text-slate-600 uppercase">Sáb</div>
                    </div>

                    <!-- Calendar Grid -->
                    <div id="dash-cal-grid"
                        class="grid grid-cols-7 gap-1 text-center text-[10px] mb-1 relative z-10 flex-1 content-start px-0.5">
                        <!-- Populated by JS -->
                    </div>

                    <!-- Calendar Legend (Matches Reference) -->
                    <div
                        class="flex justify-between items-center mt-auto relative z-10 px-1 pt-1 border-t border-white/5 shrink-0">
                        <div class="flex gap-3">
                            <div class="flex items-center gap-1.5">
                                <span
                                    class="w-1.5 h-1.5 rounded-full bg-rose-500 shadow-[0_0_6px_rgba(244,63,94,0.6)]"></span>
                                <span class="text-[8px] font-bold text-slate-500 uppercase tracking-wide">High</span>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <span
                                    class="w-1.5 h-1.5 rounded-full bg-amber-500 shadow-[0_0_6px_rgba(245,158,11,0.6)]"></span>
                                <span class="text-[8px] font-bold text-slate-500 uppercase tracking-wide">Med</span>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <span
                                    class="w-1.5 h-1.5 rounded-full bg-indigo-500 shadow-[0_0_6px_rgba(99,102,241,0.6)]"></span>
                                <span class="text-[8px] font-bold text-slate-500 uppercase tracking-wide">Low</span>
                            </div>
                        </div>
                        <!-- Add Reminder Button (Mirrored from Budget) -->
                        <button onclick="window.addMonthlyReminder()"
                            class="flex items-center gap-1.5 px-2 py-1 rounded-lg bg-indigo-500/10 hover:bg-indigo-500/20 border border-indigo-500/20 text-indigo-400 text-[9px] font-bold uppercase tracking-wider transition-all shadow-lg hover:scale-105">
                            <i data-lucide="plus-circle" class="w-3 h-3"></i> Recordatorio
                        </button>
                    </div>

                    <!-- Background Decor -->
                    <div
                        class="absolute top-0 right-0 w-64 h-64 bg-indigo-500/5 rounded-full blur-[80px] pointer-events-none group-hover/calendar:bg-indigo-500/10 transition-all duration-700">
                    </div>
                    <div
                        class="absolute bottom-0 left-0 w-40 h-40 bg-purple-500/5 rounded-full blur-[60px] pointer-events-none group-hover/calendar:bg-purple-500/10 transition-all duration-700">
                    </div>
                </div>

                <!-- Burndown (Swapped to Right) -->
                <div
                    class="col-span-1 xl:col-span-2 bg-[#0f1115] rounded-[24px] p-6 border border-white/5 shadow-2xl relative group min-h-[350px] h-full flex flex-col overflow-hidden hover:border-indigo-500/20 transition-all duration-500">
                    <!-- Ambient Glow Effects -->
                    <div
                        class="absolute -top-20 -right-20 w-80 h-80 bg-indigo-500/5 rounded-full blur-[80px] pointer-events-none group-hover:bg-indigo-500/10 transition-all duration-1000">
                    </div>
                    <div
                        class="absolute -bottom-20 -left-20 w-60 h-60 bg-purple-500/5 rounded-full blur-[60px] pointer-events-none group-hover:bg-purple-500/10 transition-all duration-1000">
                    </div>

                    <div class="flex justify-between items-start mb-4 relative z-10 shrink-0">
                        <h3
                            class="text-slate-400 text-[11px] font-bold uppercase tracking-[0.2em] flex items-center gap-2">
                            <i data-lucide="trending-down" class="w-3.5 h-3.5 text-indigo-400"></i>
                            Burndown
                        </h3>
                        <div
                            class="flex items-center gap-2 px-3 py-1 rounded-full bg-indigo-500/10 border border-indigo-500/20 backdrop-blur-sm shadow-inner">
                            <span id="d2-burndown-badge-text"
                                class="text-[9px] font-black text-indigo-300 uppercase tracking-wider">MONTHLY
                                PACE</span>
                        </div>
                    </div>
                    <!-- Legend -->
                    <div class="flex justify-between items-center mb-2 relative z-10 text-[10px]">
                        <!-- Left: Time Selector -->


                        <!-- Right: Legend -->
                        <div class="flex gap-3">
                            <button onclick="toggleChartSeries('burndown-chart-inst', 'Ideal Burn', this)"
                                class="flex items-center gap-1.5 transition hover:opacity-80">
                                <span class="w-2 h-2 rounded-full border border-slate-400"></span>
                                <span class="text-slate-400 font-bold">Ideal Burn</span>
                            </button>
                            <button onclick="toggleChartSeries('burndown-chart-inst', 'Actual Spend', this)"
                                class="flex items-center gap-1.5 transition hover:opacity-80">
                                <span
                                    class="w-2 h-2 rounded-full bg-rose-500 shadow-[0_0_8px_rgba(244,63,94,0.5)]"></span>
                                <span class="text-white font-bold">Actual</span>
                            </button>
                        </div>
                    </div>
                    <div id="d2-burndown-chart" class="w-full flex-1 min-h-0"></div>
                </div>





            </div>
        </div>

        <!-- ANALYTICS OVERVIEW TAB -->
        <div id="view-analytics-overview" class="tab-content hidden">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6 pl-2">
                <h2 class="text-3xl font-black text-white tracking-tight flex items-center gap-3">
                    <span class="bg-indigo-500/20 text-indigo-400 p-2 rounded-xl border border-indigo-500/30">
                        <i data-lucide="layout-grid" class="w-6 h-6"></i>
                    </span>
                    ANALYTICS OVERVIEW
                </h2>
                <div class="text-right">
                    <p class="text-slate-500 text-[10px] uppercase font-bold tracking-widest">LIVE DATA SYNC</p>
                    <div class="flex items-center gap-2 justify-end">
                        <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                        <span class="text-emerald-400 text-xs font-mono">Connected</span>
                    </div>
                </div>
            </div>

            <!-- BENTO GRID WRAPPER -->
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 pb-20">

                <!-- 1. BURNDOWN CHART (Wide) -->
                <div
                    class="md:col-span-2 bg-[#0f1115] rounded-[24px] p-6 border border-white/5 shadow-2xl relative group hover:border-white/10 transition duration-500">
                    <div class="flex justify-between items-start mb-4 relative z-10">
                        <h3 class="text-slate-400 text-[11px] font-bold uppercase tracking-[0.2em]">Budget Burn-down
                        </h3>
                        <div
                            class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-indigo-500/10 border border-indigo-500/20 backdrop-blur-md shadow-[0_0_10px_rgba(99,102,241,0.15)] group transition-all duration-300 hover:bg-indigo-500/20">
                            <span class="relative flex h-2 w-2">
                                <span
                                    class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
                                <span
                                    class="relative inline-flex rounded-full h-2 w-2 bg-indigo-500 shadow-[0_0_8px_rgba(99,102,241,0.8)]"></span>
                            </span>
                            <span id="ao-burndown-badge-text"
                                class="text-[10px] font-black text-indigo-300 uppercase tracking-[0.15em] font-sans">DECEMBER
                                PACE</span>
                        </div>
                    </div>
                    <div id="ao-burndown-chart" class="w-full h-64"></div>
                </div>

                <!-- 2. FORECAST WIDGET -->
                <div
                    class="bg-[#0f1115] rounded-[24px] p-6 border border-white/5 shadow-2xl relative overflow-hidden flex flex-col justify-center group hover:border-indigo-500/20 transition duration-500">
                    <div class="absolute inset-0 bg-indigo-500/5"></div>
                    <!-- Glow -->
                    <div
                        class="absolute -top-10 -right-10 w-32 h-32 bg-indigo-500/10 rounded-full blur-3xl pointer-events-none group-hover:bg-indigo-500/20 transition duration-500">
                    </div>

                    <div class="flex justify-between items-start mb-2 relative z-10">
                        <div>
                            <h3
                                class="text-slate-400 text-[11px] font-bold uppercase tracking-[0.2em] flex items-center gap-2">
                                <i data-lucide="sparkles" class="w-3 h-3 text-indigo-400"></i> AI Forecast
                            </h3>
                            <div class="flex items-center gap-1.5 mt-1">
                                <span class="relative flex h-1.5 w-1.5">
                                    <span
                                        class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                                    <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-emerald-500"></span>
                                </span>
                                <span class="text-[9px] font-bold text-slate-500">Model Confidence: <span
                                        class="text-white">84%</span></span>
                            </div>
                        </div>
                        <span id="ao-days-left-badge"
                            class="px-2 py-0.5 rounded bg-white/5 border border-white/5 text-[9px] text-slate-500 font-mono">17
                            Days Left</span>
                    </div>

                    <!-- Main Projection -->
                    <div class="relative z-10 my-1">
                        <p class="text-slate-500 text-[10px] uppercase font-bold tracking-wider mb-1">Projected Month
                            End</p>
                        <h2 id="ao-projected-total"
                            class="text-3xl font-black text-white tracking-tighter leading-none">$17,687.71</h2>
                    </div>

                    <!-- Progress Bar -->
                    <div class="w-full h-1.5 bg-slate-800 rounded-full overflow-hidden mb-3 relative z-10">
                        <div id="ao-forecast-bar"
                            class="h-full bg-gradient-to-r from-amber-500 via-orange-500 to-red-500 w-[87%] transition-all duration-1000">
                        </div>
                    </div>

                    <!-- Stats Grid -->
                    <div class="grid grid-cols-2 gap-2 mb-3 relative z-10">
                        <div class="bg-white/5 rounded-xl p-2 border border-white/5">
                            <p class="text-[9px] text-slate-500 uppercase font-bold">Current Avg</p>
                            <p id="ao-daily-avg" class="text-sm font-bold text-slate-300">$570.57</p>
                        </div>
                        <div class="bg-white/5 rounded-xl p-2 border border-white/5">
                            <p class="text-[9px] text-slate-500 uppercase font-bold">Safe Daily</p>
                            <p id="ao-safe-daily" class="text-sm font-bold text-emerald-400">$412.47</p>
                        </div>
                    </div>

                    <!-- AI Insight Section -->
                    <div id="ao-ai-tip-container" class="mb-3 relative z-10 animate-fade-in-up">
                        <div
                            class="p-3 rounded-xl bg-gradient-to-r from-indigo-500/10 to-purple-500/10 border border-white/5 flex gap-3 items-start">
                            <div class="p-1.5 bg-indigo-500/20 rounded-lg text-indigo-400 shrink-0">
                                <i data-lucide="lightbulb" class="w-3.5 h-3.5"></i>
                            </div>
                            <div>
                                <h4 class="text-[10px] font-bold text-white uppercase tracking-wider mb-0.5">Smart
                                    Insight</h4>
                                <p id="ao-ai-tip-text" class="text-[10px] text-slate-300 leading-snug">
                                    To get back on track, try to spend $9 for the next 4.7 days.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Message Capsule -->
                    <div id="ao-forecast-msg-scan"
                        class="mt-auto px-3 py-2 rounded-xl bg-red-500/10 border border-red-500/20 flex items-center gap-2 relative z-10 justify-between">
                        <div class="flex items-center gap-2">
                            <div id="ao-msg-icon-bg"
                                class="w-5 h-5 rounded-full bg-red-500/20 flex items-center justify-center shrink-0">
                                <i id="ao-msg-icon" data-lucide="alert-triangle" class="w-3 h-3 text-red-400"></i>
                            </div>
                            <p id="ao-forecast-msg" class="text-[10px] font-medium text-red-300 leading-snug">
                                Danger: Projected to exceed limit by $2,687.71</p>
                        </div>
                        <div id="ao-burn-status"
                            class="hidden px-2 py-0.5 rounded bg-red-500/20 text-red-300 text-[9px] font-black">CRITICAL
                            VELOCITY</div>
                    </div>
                </div>

                <!-- 6. CATEGORY PERFORMANCE (Wide) -->
                <div
                    class="md:col-span-2 bg-[#0f1115] rounded-[24px] p-6 border border-white/5 shadow-2xl relative overflow-hidden hover:border-white/10 transition duration-500">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-slate-400 text-[11px] font-bold uppercase tracking-[0.2em]">Category Performance
                        </h3>
                        <div class="flex items-center gap-4 text-[10px] font-bold uppercase tracking-wider">
                            <span class="flex items-center gap-1.5"><span
                                    class="w-2 h-2 rounded-full bg-slate-700"></span> Limit</span>
                            <span class="flex items-center gap-1.5"><span
                                    class="w-2 h-2 rounded-full bg-blue-500"></span> Actual</span>
                            <span class="flex items-center gap-1.5"><span
                                    class="w-2 h-2 rounded-full bg-red-500"></span> Over</span>
                        </div>
                    </div>
                    <div id="ao-cat-perf-list" class="space-y-4 max-h-80 overflow-y-auto pr-2 custom-scrollbar">
                        <!-- Generated Bars -->
                    </div>
                </div>

                <!-- 7. TOP OFFENDERS -->
                <div
                    class="bg-[#0f1115] rounded-[24px] p-6 border border-white/5 shadow-2xl relative overflow-hidden hover:border-red-500/20 transition duration-500 group">
                    <!-- Glow -->
                    <div
                        class="absolute -top-10 -right-10 w-32 h-32 bg-red-500/5 rounded-full blur-3xl pointer-events-none group-hover:bg-red-500/10 transition duration-500">
                    </div>

                    <div class="flex items-center gap-2 mb-6 relative z-10">
                        <div class="p-1.5 bg-red-500/10 rounded text-red-500"><i data-lucide="siren"
                                class="w-4 h-4"></i></div>
                        <h3 class="text-red-400 text-[11px] font-bold uppercase tracking-[0.2em]">Top Offenders</h3>
                    </div>
                    <div id="ao-offenders-list" class="space-y-3 relative z-10">
                        <!-- List -->
                        <div class="text-center text-slate-500 text-xs py-8 italic">No budget violations yet. Good job!
                        </div>
                    </div>
                </div>



            </div>
        </div>

        <!-- ANALYTICS TAB -->
        <div id="view-analytics" class="tab-content">
            <div class="grid grid-cols-1 xl:grid-cols-12 gap-6 pb-8">
                <!-- (Existing Analytics Content - preserved) -->
                <div class="xl:col-span-5 flex flex-col gap-6">
                    <div class="grid grid-cols-2 gap-6 h-40">
                        <div class="bg-dark-700 rounded-3xl p-5 relative overflow-hidden flex flex-col justify-between">
                            <div>
                                <h3 class="text-slate-400 text-sm mb-1">Total balance</h3>
                                <p class="text-2xl font-bold text-white">$857,850</p>
                            </div>
                            <div class="flex items-center gap-1 text-sm font-semibold text-accent-green z-10"><i
                                    data-lucide="arrow-up-right" class="w-4 h-4"></i> 25.3%</div>
                            <div id="spark1" class="absolute bottom-0 right-0 w-2/3 h-2/3 opacity-50"></div>
                        </div>
                        <div class="bg-dark-700 rounded-3xl p-5 relative overflow-hidden flex flex-col justify-between">
                            <div>
                                <h3 class="text-slate-400 text-sm mb-1">Total expenses</h3>
                                <p class="text-2xl font-bold text-white maskable">$198,110</p>
                            </div>
                            <div class="flex items-center gap-1 text-sm font-semibold text-accent-pink z-10"><i
                                    data-lucide="arrow-down-right" class="w-4 h-4"></i> 5.77%</div>
                            <div id="spark2" class="absolute bottom-0 right-0 w-2/3 h-2/3 opacity-50"></div>
                        </div>
                    </div>
                    <div class="bg-dark-700 rounded-3xl p-6 h-64 flex flex-col">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-white font-semibold">Dissection</h3>
                        </div>
                        <div id="dissectionChart" class="flex-1 w-full h-full"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-80">
                        <div class="bg-dark-700 rounded-3xl p-6 flex flex-col overflow-hidden">
                            <h3 class="text-white font-semibold mb-4">Translations</h3>
                            <div class="flex-1 overflow-y-auto space-y-4 pr-1" id="transactionsList">
                                <!-- Transactions will be injected here -->
                            </div>
                        </div>
                        <div class="bg-dark-700 rounded-3xl p-6 flex flex-col">
                            <h3 class="text-white font-semibold mb-4">Investments</h3>
                            <div class="space-y-5">
                                <div>
                                    <div class="flex justify-between text-xs mb-1 text-white">
                                        <span>Studies</span><span class="maskable">$520.00</span>
                                    </div>
                                    <div class="h-2 bg-dark-800 rounded-full">
                                        <div class="h-full bg-primary rounded-full" style="width: 60%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-xs mb-1 text-white">
                                        <span>Crypto</span><span class="maskable">$220.00</span>
                                    </div>
                                    <div class="h-2 bg-dark-800 rounded-full">
                                        <div class="h-full bg-primary rounded-full" style="width: 40%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-xs mb-1 text-white">
                                        <span>Stocks</span><span class="maskable">$420.00</span>
                                    </div>
                                    <div class="h-2 bg-dark-800 rounded-full">
                                        <div class="h-full bg-primary rounded-full" style="width: 55%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-xs mb-1 text-white">
                                        <span>Assets</span><span class="maskable">$827.00</span>
                                    </div>
                                    <div class="h-2 bg-dark-800 rounded-full">
                                        <div class="h-full bg-primary rounded-full" style="width: 75%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Right Column -->
                <div class="xl:col-span-7 flex flex-col gap-6">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-6 h-64">
                        <div
                            class="md:col-span-3 bg-gradient-to-br from-[#1E2333] to-[#0F111A] rounded-3xl p-6 relative overflow-hidden flex flex-col justify-between border border-white/5">
                            <div class="flex justify-between items-start z-10">
                                <div>
                                    <p class="text-slate-400 text-xs font-medium">PriorBank</p>
                                    <p class="text-white text-xs font-medium">BCA Bank</p>
                                </div>
                                <div class="text-white font-bold italic text-lg tracking-wider">VISA</div>
                            </div>
                            <div class="z-10 mt-auto">
                                <p class="text-2xl font-bold text-white tracking-widest mb-4 maskable">$ 1452,22</p>
                                <div class="flex justify-between items-end">
                                    <div>
                                        <p class="text-slate-500 text-[10px] uppercase mb-0.5">Card number</p>
                                        <div class="flex gap-2 text-slate-300 text-sm font-mono">
                                            <span>3125</span><span>7856</span><span>....</span><span>4578</span>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-slate-500 text-[10px] uppercase mb-0.5">Exp</p>
                                        <p class="text-white text-sm font-mono">12/26</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="md:col-span-2 bg-dark-700 rounded-3xl p-4 flex flex-col relative">
                            <h3 class="text-white font-semibold text-sm mb-1">Categories</h3>
                            <div class="flex-1 flex items-center justify-center relative">
                                <div id="donutChart" class="w-full h-full"></div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-dark-700 rounded-3xl p-6 h-48 flex flex-col">
                        <h3 class="text-white font-semibold mb-2">Spending parameters</h3>
                        <div class="flex-1 flex items-center justify-around">
                            <div class="text-center relative">
                                <div id="gauge1" class="w-20 h-20"></div><span
                                    class="text-xs text-slate-400">food</span>
                            </div>
                            <div class="text-center">
                                <div id="gauge2" class="w-20 h-20"></div><span
                                    class="text-xs text-slate-400">house</span>
                            </div>
                            <div class="text-center">
                                <div id="gauge3" class="w-20 h-20"></div><span class="text-xs text-slate-400">car</span>
                            </div>
                            <div class="text-center">
                                <div id="gauge4" class="w-20 h-20"></div><span
                                    class="text-xs text-slate-400">gravity</span>
                            </div>
                            <div class="text-center">
                                <div id="gauge5" class="w-20 h-20"></div><span
                                    class="text-xs text-slate-400">holiday</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-dark-700 rounded-3xl p-6 flex-1 min-h-[200px] flex flex-col">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-white font-semibold">Income and expenses</h3>
                        </div>
                        <div id="areaChart" class="flex-1 w-full"></div>
                    </div>
                </div>
            </div>

        </div>
        </div>




        <!-- Wallet Tab -->
        <!-- Wallet Tab (Totally Refactored) -->
        <div id="view-wallet" class="tab-content">
            <!-- Header -->
            <!-- New Tab Header -->
            <div class="flex items-center gap-6 mb-10 pl-2">
                <div
                    class="w-16 h-16 rounded-[24px] bg-gradient-to-br from-indigo-500/20 to-purple-500/20 border border-white/10 flex items-center justify-center shadow-xl shadow-indigo-500/10">
                    <i data-lucide="wallet" class="w-8 h-8 text-indigo-400"></i>
                </div>
                <div class="flex flex-col">
                    <h2 class="text-4xl font-black text-white tracking-tight leading-tight uppercase">Billetera</h2>
                    <p class="text-slate-500 text-xs font-bold tracking-[0.3em] uppercase">ADMINISTRACIÓN DE FONDOS</p>
                </div>
            </div>


            <!-- Monthly Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 px-2">
                <!-- Balance Actual -->
                <div
                    class="bg-gradient-to-br from-indigo-900/50 to-dark-800 rounded-[2rem] p-6 border border-indigo-500/20 relative overflow-hidden group hover:border-indigo-500/40 transition-all">
                    <div
                        class="absolute top-0 right-0 w-32 h-32 bg-indigo-500/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2">
                    </div>
                    <div class="relative z-10">
                        <p class="text-indigo-200 text-xs font-bold uppercase tracking-wider mb-1">BALANCE ACTUAL</p>
                        <h3 class="text-4xl font-black text-white tracking-tight maskable" id="w-net-balance">$0.00</h3>
                        <div class="h-1.5 w-24 bg-indigo-500 rounded-full mt-4 shadow-[0_0_10px_rgba(99,102,241,0.5)]">
                        </div>
                    </div>
                </div>

                <!-- Ingresos -->
                <div
                    class="bg-gradient-to-br from-emerald-900/30 to-dark-800 rounded-[2rem] p-6 border border-emerald-500/20 relative overflow-hidden group hover:border-emerald-500/40 transition-all">
                    <div
                        class="absolute top-0 right-0 w-32 h-32 bg-emerald-500/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2">
                    </div>
                    <div class="relative z-10">
                        <p class="text-emerald-200 text-xs font-bold uppercase tracking-wider mb-1">INGRESOS</p>
                        <h3 class="text-4xl font-black text-white tracking-tight maskable" id="monthly-income">$0.00
                        </h3>
                        <div class="flex items-center gap-2 mt-2">
                            <span id="inc-variation"
                                class="text-emerald-400 font-bold text-sm bg-emerald-500/10 px-2 py-0.5 rounded-lg border border-emerald-500/20 flex items-center gap-1">
                                <i data-lucide="trending-up" class="w-3 h-3"></i> 0%
                            </span>
                            <span class="text-slate-500 text-[10px] font-bold uppercase">vs. mes anterior</span>
                        </div>
                    </div>
                </div>

                <!-- Gastos -->
                <div
                    class="bg-gradient-to-br from-rose-900/30 to-dark-800 rounded-[2rem] p-6 border border-rose-500/20 relative overflow-hidden group hover:border-rose-500/40 transition-all">
                    <div
                        class="absolute top-0 right-0 w-32 h-32 bg-rose-500/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2">
                    </div>
                    <div class="relative z-10">
                        <p class="text-rose-200 text-xs font-bold uppercase tracking-wider mb-1">GASTOS</p>
                        <h3 class="text-4xl font-black text-white tracking-tight maskable" id="monthly-expenses">$0.00
                        </h3>
                        <div class="flex items-center gap-2 mt-2">
                            <span id="exp-variation"
                                class="text-rose-400 font-bold text-sm bg-rose-500/10 px-2 py-0.5 rounded-lg border border-rose-500/20 flex items-center gap-1">
                                <i data-lucide="trending-down" class="w-3 h-3"></i> 0%
                            </span>
                            <span class="text-slate-500 text-[10px] font-bold uppercase">vs. mes anterior</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Layout Grid -->
            <div class="grid grid-cols-1 xl:grid-cols-12 gap-6 min-h-[800px]">

                <!-- COL 1: Input & Quick Stats (Span 4) -->
                <div class="xl:col-span-4 flex flex-col gap-6">

                    <!-- Nuevo Movimiento Form -->
                    <div
                        class="bg-dark-800 rounded-[2rem] p-6 border border-white/5 relative overflow-hidden shadow-2xl group">
                        <div
                            class="absolute top-0 right-0 w-32 h-32 bg-indigo-500/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none">
                        </div>

                        <h3 class="text-white font-bold text-lg mb-5 flex items-center gap-2">
                            <i data-lucide="plus-circle" class="w-5 h-5 text-indigo-400"></i> Nuevo Movimiento
                        </h3>

                        <form onsubmit="event.preventDefault(); addWalletTransaction()"
                            class="flex flex-col gap-4 relative z-10">
                            <!-- Type Toggle -->
                            <div class="grid grid-cols-2 bg-dark-900 rounded-xl p-1.5 relative border border-white/5">
                                <input type="radio" name="w-type" id="wt-income" value="income"
                                    class="peer/income hidden" checked onchange="updateWalletCategories()">
                                <input type="radio" name="w-type" id="wt-expense" value="expense"
                                    class="peer/expense hidden" onchange="updateWalletCategories()">

                                <div
                                    class="absolute top-1.5 left-1.5 bottom-1.5 w-[calc(50%-6px)] bg-emerald-500 rounded-lg transition-all duration-300 peer-checked/expense:translate-x-full peer-checked/expense:bg-red-500 shadow-lg">
                                </div>

                                <label for="wt-income"
                                    class="relative z-10 text-center py-2.5 text-xs font-bold text-white cursor-pointer transition-colors flex items-center justify-center gap-2">
                                    <i data-lucide="arrow-down-left" class="w-3 h-3"></i> Ingreso
                                </label>
                                <label for="wt-expense"
                                    class="relative z-10 text-center py-2.5 text-xs font-bold text-slate-500 peer-checked/expense:text-white cursor-pointer transition-colors flex items-center justify-center gap-2">
                                    Gasto <i data-lucide="arrow-up-right" class="w-3 h-3"></i>
                                </label>
                            </div>

                            <!-- Ticket Scan Option -->
                            <div class="relative group">
                                <input type="file" id="ticket-upload" accept="image/*" class="hidden"
                                    onchange="handleTicketUpload(event)">
                                <button type="button" onclick="document.getElementById('ticket-upload').click()"
                                    class="w-full flex items-center justify-center gap-2 py-2.5 rounded-xl bg-indigo-500/10 border border-indigo-500/20 text-indigo-400 font-bold text-xs hover:bg-indigo-500/20 hover:text-indigo-300 transition-all group-hover:shadow-[0_0_15px_rgba(99,102,241,0.3)]">
                                    <i data-lucide="scan-line" class="w-4 h-4"></i>
                                    <span>Escaneo AI / Ticket</span>
                                </button>
                                <div
                                    class="absolute inset-0 bg-indigo-500/5 rounded-xl blur opacity-0 group-hover:opacity-100 transition duration-500 -z-10">
                                </div>
                            </div>

                            <!-- Amount -->
                            <div class="relative group">
                                <label
                                    class="text-[9px] uppercase font-bold text-slate-500 mb-1 block pl-1">Monto</label>
                                <div class="relative">
                                    <span
                                        class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 font-bold">$</span>
                                    <input type="number" id="w-amount" step="0.01" placeholder="0.00"
                                        class="w-full bg-dark-900 border border-white/5 rounded-2xl py-3 pl-8 pr-4 text-white font-mono font-bold focus:outline-none focus:border-indigo-500 transition shadow-inner">
                                </div>
                            </div>

                            <!-- Date (Compact) -->
                            <div>
                                <label
                                    class="text-[9px] uppercase font-bold text-slate-500 mb-1 block pl-1">Fecha</label>
                                <input type="date" id="w-date" style="color-scheme: dark;"
                                    class="w-full bg-dark-900 border border-white/5 rounded-2xl py-3 px-4 text-slate-300 text-xs font-bold focus:outline-none focus:border-indigo-500 transition">
                            </div>

                            <!-- Description -->
                            <div>
                                <label
                                    class="text-[9px] uppercase font-bold text-slate-500 mb-1 block pl-1">Descripción</label>
                                <input type="text" id="w-desc" placeholder="Detalle..."
                                    class="w-full bg-dark-900 border border-white/5 rounded-2xl py-3 px-4 text-slate-300 text-xs focus:outline-none focus:border-indigo-500 transition placeholder-slate-600">
                            </div>

                            <!-- Category (Hidden Input + Grid) -->
                            <div>
                                <label
                                    class="text-[9px] uppercase font-bold text-slate-500 mb-2 block pl-1">Categoría</label>
                                <input type="hidden" id="w-category" value="">
                                <div id="category-grid" class="grid grid-cols-4 gap-2">
                                    <!-- Populated by JS -->
                                    <div class="col-span-4 text-center py-4 text-xs text-slate-500 animate-pulse">
                                        Loading Categories...</div>
                                </div>
                            </div>

                            <!-- Budget Focus (Restored Buttons) -->
                            <div id="budget-focus-container">
                                <label class="text-[9px] uppercase font-bold text-slate-500 mb-2 block pl-1">Focus
                                    Tag</label>
                                <input type="hidden" id="w-focus" value="Wants">
                                <div class="grid grid-cols-3 gap-2">
                                    <!-- Needs -->
                                    <div onclick="selectFocus('Needs')" id="focus-Needs"
                                        class="focus-item flex flex-col items-center justify-center p-2 rounded-xl border border-white/5 bg-dark-800 hover:bg-dark-700 cursor-pointer transition-all duration-200 group">
                                        <i data-lucide="home"
                                            class="w-4 h-4 mb-1 text-slate-400 group-hover:text-slate-200 transition-colors"></i>
                                        <span
                                            class="text-[8px] uppercase font-bold text-slate-500 group-hover:text-slate-300 transition-colors">Needs</span>
                                    </div>
                                    <!-- Wants -->
                                    <div onclick="selectFocus('Wants')" id="focus-Wants"
                                        class="focus-item flex flex-col items-center justify-center p-2 rounded-xl border border-primary bg-primary/20 ring-1 ring-primary shadow-[0_0_10px_rgba(99,102,241,0.2)] cursor-pointer transition-all duration-200 scale-[0.98]">
                                        <i data-lucide="star" class="w-4 h-4 mb-1 text-primary transition-colors"></i>
                                        <span
                                            class="text-[8px] uppercase font-bold text-primary transition-colors">Wants</span>
                                    </div>
                                    <!-- Save -->
                                    <div onclick="selectFocus('Saving')" id="focus-Saving"
                                        class="focus-item flex flex-col items-center justify-center p-2 rounded-xl border border-white/5 bg-dark-800 hover:bg-dark-700 cursor-pointer transition-all duration-200 group">
                                        <i data-lucide="piggy-bank"
                                            class="w-4 h-4 mb-1 text-slate-400 group-hover:text-slate-200 transition-colors"></i>
                                        <span
                                            class="text-[8px] uppercase font-bold text-slate-500 group-hover:text-slate-300 transition-colors">Save</span>
                                    </div>
                                    <!-- Invest -->
                                    <div onclick="selectFocus('Investment')" id="focus-Investment"
                                        class="focus-item flex flex-col items-center justify-center p-2 rounded-xl border border-white/5 bg-dark-800 hover:bg-dark-700 cursor-pointer transition-all duration-200 group">
                                        <i data-lucide="trending-up"
                                            class="w-4 h-4 mb-1 text-slate-400 group-hover:text-slate-200 transition-colors"></i>
                                        <span
                                            class="text-[8px] uppercase font-bold text-slate-500 group-hover:text-slate-300 transition-colors">Invest</span>
                                    </div>
                                    <!-- Debt -->
                                    <div onclick="selectFocus('Debt')" id="focus-Debt"
                                        class="focus-item flex flex-col items-center justify-center p-2 rounded-xl border border-white/5 bg-dark-800 hover:bg-dark-700 cursor-pointer transition-all duration-200 group">
                                        <i data-lucide="credit-card"
                                            class="w-4 h-4 mb-1 text-slate-400 group-hover:text-slate-200 transition-colors"></i>
                                        <span
                                            class="text-[8px] uppercase font-bold text-slate-500 group-hover:text-slate-300 transition-colors">Debt</span>
                                    </div>
                                    <!-- Waste -->
                                    <div onclick="selectFocus('Waste')" id="focus-Waste"
                                        class="focus-item flex flex-col items-center justify-center p-2 rounded-xl border border-white/5 bg-dark-800 hover:bg-dark-700 cursor-pointer transition-all duration-200 group">
                                        <i data-lucide="trash-2"
                                            class="w-4 h-4 mb-1 text-slate-400 group-hover:text-slate-200 transition-colors"></i>
                                        <span
                                            class="text-[8px] uppercase font-bold text-slate-500 group-hover:text-slate-300 transition-colors">Waste</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <button type="submit"
                                class="w-full py-4 mt-2 bg-white text-black rounded-2xl font-black text-sm uppercase tracking-wider hover:bg-slate-200 transition shadow-lg shadow-white/10 flex items-center justify-center gap-2 group">
                                Agregar <i data-lucide="check" class="w-4 h-4 group-hover:scale-125 transition"></i>
                            </button>
                        </form>
                    </div>

                    <!-- Top Offenders (Moved to Left Column) -->
                    <div
                        class="bg-[#0f1115] rounded-[2rem] p-6 border border-white/5 relative overflow-hidden flex flex-col group">
                        <!-- Glow -->
                        <div
                            class="absolute -top-10 -right-10 w-32 h-32 bg-red-500/5 rounded-full blur-3xl pointer-events-none group-hover:bg-red-500/10 transition duration-500">
                        </div>

                        <div class="flex items-center gap-2 mb-4 relative z-10">
                            <div class="p-1.5 bg-red-500/10 rounded text-red-500"><i data-lucide="siren"
                                    class="w-4 h-4"></i></div>
                            <h3 class="text-red-400 text-[11px] font-bold uppercase tracking-[0.2em]">Top Offenders
                            </h3>
                        </div>
                        <div id="wallet-offenders-list" class="space-y-3 relative z-10">
                            <!-- List populated by JS -->
                            <div class="text-center text-slate-500 text-xs py-8 italic">Analyzing spending...</div>
                        </div>
                    </div>

                </div>

                <!-- COL 2: MAIN VISUALIZATION (Span 8) -->
                <div class="xl:col-span-8 flex flex-col gap-6 h-full overflow-hidden">

                    <!-- Top: Weekly Comparison Chart -->
                    <div
                        class="h-[250px] bg-dark-800 rounded-[2rem] p-6 border border-white/5 relative overflow-hidden flex flex-col">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="text-lg font-bold text-white">Income and expenses</h3>
                            </div>
                            <p class="text-slate-500 text-xs" id="weekly-activity-label">Last 7 Days</p>
                        </div>
                        <div id="weekly-activity-bars" class="flex-1 w-full h-full relative"></div>
                    </div>




                    <!-- Bottom: Transactions List -->
                    <div
                        class="flex-1 bg-dark-800 rounded-[2rem] p-6 border border-white/5 relative flex flex-col min-h-0 overflow-visible">
                        <div
                            class="flex flex-wrap justify-between items-center mb-6 pb-4 border-b border-white/5 gap-3">
                            <h3 class="text-lg font-bold text-white flex items-center gap-2">
                                <i data-lucide="history" class="w-5 h-5 text-slate-400"></i> Historial
                            </h3>

                            <div class="flex flex-col gap-3 w-full sm:w-auto items-end">
                                <!-- Row 1: Time Filters -->
                                <div
                                    class="flex items-center gap-2 bg-dark-900/50 p-1 rounded-xl border border-white/5">
                                    <!-- Month Picker (Premium) -->
                                    <div class="relative z-50">
                                        <button onclick="toggleMonthPicker();" id="btn-time-month"
                                            class="text-[10px] bg-indigo-500/10 text-indigo-300 hover:bg-indigo-500 hover:text-white px-3 py-1.5 rounded-lg transition-all duration-300 font-bold border border-indigo-500/30 hover:border-indigo-500 flex items-center gap-2 shadow-lg shadow-indigo-500/10 group">
                                            <i data-lucide="calendar"
                                                class="w-3 h-3 group-hover:scale-110 transition-transform"></i>
                                            <span id="history-month-label">Mes</span>
                                            <i data-lucide="chevron-down"
                                                class="w-3 h-3 opacity-50 group-hover:translate-y-0.5 transition-transform"></i>
                                        </button>

                                        <!-- Premium Dropdown Panel -->
                                        <div id="custom-month-picker"
                                            class="hidden absolute top-full right-0 mt-3 w-72 bg-[#161b22]/95 backdrop-blur-2xl border border-white/10 rounded-3xl shadow-[0_20px_60px_-15px_rgba(0,0,0,0.9)] p-5 animate-fade-in-up origin-top-right z-[100] transform transition-all">

                                            <!-- Header -->
                                            <div class="flex items-center justify-between mb-5">
                                                <button onclick="changePickerYear(-1)"
                                                    class="w-8 h-8 rounded-xl flex items-center justify-center hover:bg-white/5 text-slate-400 hover:text-white transition active:scale-95 border border-transparent hover:border-white/5">
                                                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                                                </button>

                                                <div class="flex flex-col items-center">
                                                    <span
                                                        class="text-[10px] text-indigo-400 font-bold uppercase tracking-widest mb-0.5">Año</span>
                                                    <span id="picker-year-display"
                                                        class="text-xl font-black text-white tracking-tight leading-none font-mono">2025</span>
                                                </div>

                                                <button onclick="changePickerYear(1)"
                                                    class="w-8 h-8 rounded-xl flex items-center justify-center hover:bg-white/5 text-slate-400 hover:text-white transition active:scale-95 border border-transparent hover:border-white/5">
                                                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                                                </button>
                                            </div>

                                            <!-- Grid -->
                                            <div class="grid grid-cols-3 gap-2 mb-4" id="picker-months-grid">
                                                <!-- JS Generated -->
                                            </div>

                                            <!-- Footer / Today -->
                                            <div class="pt-4 border-t border-white/5">
                                                <button onclick="selectCurrentMonth()"
                                                    class="w-full py-2 rounded-xl bg-indigo-500/10 hover:bg-indigo-500/20 text-indigo-400 hover:text-indigo-300 text-xs font-bold transition flex items-center justify-center gap-2">
                                                    <i data-lucide="calendar-check" class="w-3 h-3"></i>
                                                    Ir al Mes Actual
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <button onclick="filterTime('week')" id="btn-time-week"
                                        class="text-[10px] bg-transparent text-slate-400 hover:text-white px-3 py-1.5 rounded-lg transition font-bold hover:bg-white/5">Semana</button>
                                    <button onclick="filterTime('day')" id="btn-time-day"
                                        class="text-[10px] bg-transparent text-slate-400 hover:text-white px-3 py-1.5 rounded-lg transition font-bold hover:bg-white/5">Día</button>
                                </div>

                                <!-- Row 2: Type & Attribute Filters -->
                                <div class="flex items-center gap-2 flex-wrap justify-end">
                                    <div
                                        class="flex items-center gap-1 bg-dark-900/50 p-1 rounded-xl border border-white/5">
                                        <button onclick="filterWallet('all')" id="btn-type-all"
                                            class="text-[10px] bg-white text-black px-3 py-1.5 rounded-lg transition font-bold shadow-lg shadow-white/10">Todos</button>
                                        <button onclick="filterWallet('income')" id="btn-type-income"
                                            class="text-[10px] bg-transparent text-emerald-400 hover:bg-emerald-500/10 px-3 py-1.5 rounded-lg transition font-bold">Ingresos</button>
                                        <button onclick="filterWallet('expense')" id="btn-type-expense"
                                            class="text-[10px] bg-transparent text-rose-400 hover:bg-rose-500/10 px-3 py-1.5 rounded-lg transition font-bold">Gastos</button>
                                    </div>

                                    <div
                                        class="flex items-center gap-1 bg-dark-900/50 p-1 rounded-xl border border-white/5">
                                        <button onclick="openCategoryFilter()" id="btn-filter-cat"
                                            class="text-[10px] bg-transparent text-slate-400 hover:text-white px-3 py-1.5 rounded-lg transition font-bold hover:bg-white/5 flex items-center gap-1">
                                            <i data-lucide="grid" class="w-3 h-3"></i> <span
                                                id="lbl-filter-cat">Cat.</span>
                                        </button>
                                        <button onclick="openFocusFilter()" id="btn-filter-focus"
                                            class="text-[10px] bg-transparent text-slate-400 hover:text-white px-3 py-1.5 rounded-lg transition font-bold hover:bg-white/5 flex items-center gap-1">
                                            <i data-lucide="tag" class="w-3 h-3"></i> <span
                                                id="lbl-filter-focus">Focus</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Scrollable List -->
                        <div id="wallet-history-list" class="flex-1 overflow-y-auto pr-2 custom-scrollbar space-y-3">
                            <div class="text-center py-10 opacity-50">Loading History...</div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- COL 3 -> REMOVED. Adjusting previous column to span 9. -->

        </div>
        </div>

        <!-- Budget Tab -->
        <div id="view-budget" class="tab-content relative min-h-screen pb-24">
            <!-- Header Background Effect -->
            <div
                class="absolute top-0 left-0 w-full h-64 bg-gradient-to-b from-primary/10 to-transparent pointer-events-none">
            </div>

            <div class="relative z-10 p-6 max-w-7xl mx-auto space-y-6">
                <!-- Title & Actions -->
                <!-- New Tab Header -->
                <div class="flex items-center gap-6 mb-10 pl-2">
                    <div
                        class="w-16 h-16 rounded-[24px] bg-gradient-to-br from-indigo-500/20 to-purple-500/20 border border-white/10 flex items-center justify-center shadow-xl shadow-indigo-500/10">
                        <i data-lucide="calculator" class="w-8 h-8 text-indigo-400"></i>
                    </div>
                    <div class="flex flex-col">
                        <h2 class="text-4xl font-black text-white tracking-tight leading-tight uppercase">Finanzas</h2>
                        <p class="text-slate-500 text-xs font-bold tracking-[0.3em] uppercase">PRESUPUESTO Y CONTROL</p>
                    </div>
                </div>


                <!-- NEW: ANALYTICS SUMMARY (Burndown + Forecast) -->
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 animate-fade-in-up">
                    <!-- 1. BURNDOWN CHART (Wide) -->
                    <!-- 1. BURNDOWN CHART (Wide & Premium) -->
                    <div
                        class="xl:col-span-3 bg-[#0B0D14] rounded-[32px] p-8 border border-white/5 relative group transition-all duration-500 hover:border-white/10 overflow-hidden shadow-2xl">
                        <!-- Background Ambient Glow -->
                        <div
                            class="absolute -top-20 -right-20 w-96 h-96 bg-indigo-500/5 rounded-full blur-[100px] pointer-events-none group-hover:bg-indigo-500/10 transition-colors duration-1000">
                        </div>
                        <div
                            class="absolute bottom-0 left-0 w-64 h-64 bg-rose-500/5 rounded-full blur-[80px] pointer-events-none">
                        </div>

                        <!-- Header -->
                        <div class="flex justify-between items-center mb-6 relative z-10">
                            <div class="flex items-center gap-4">
                                <div
                                    class="w-12 h-12 rounded-2xl bg-gradient-to-br from-white/5 to-transparent border border-white/5 flex items-center justify-center shadow-[inset_0_0_20px_rgba(0,0,0,0.2)] group-hover:scale-105 transition-transform duration-500">
                                    <i data-lucide="flame"
                                        class="w-5 h-5 text-rose-500 drop-shadow-[0_0_10px_rgba(244,63,94,0.6)]"></i>
                                </div>
                                <div>
                                    <h3
                                        class="text-white text-lg font-black uppercase tracking-tight leading-none bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">
                                        Burndown</h3>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="w-1 h-1 rounded-full bg-slate-500"></span>
                                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-[0.2em]"
                                            id="d2-burndown-badge-text">PACE ANALYSIS</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Custom Legend (Pill) -->
                            <div
                                class="hidden sm:flex items-center gap-5 bg-[#141724]/80 px-5 py-2.5 rounded-2xl border border-white/5 backdrop-blur-md shadow-lg">
                                <div class="flex items-center gap-2 opacity-60 hover:opacity-100 transition-opacity">
                                    <div class="w-1.5 h-1.5 rounded-full bg-slate-400"></div>
                                    <div class="w-8 border-t border-dashed border-slate-500"></div>
                                    <span
                                        class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">Ideal</span>
                                </div>
                                <div class="w-px h-4 bg-white/5"></div>
                                <div class="flex items-center gap-2">
                                    <div
                                        class="w-2 h-2 rounded-full bg-rose-500 shadow-[0_0_10px_rgba(244,63,94,0.8)] animate-pulse">
                                    </div>
                                    <div class="w-8 h-1 rounded-full bg-gradient-to-r from-rose-600 to-orange-500">
                                    </div>
                                    <span
                                        class="text-[9px] font-bold text-white uppercase tracking-wider shadow-black drop-shadow-md">Actual</span>
                                </div>
                            </div>
                        </div>

                        <!-- Chart Container -->
                        <div id="budget-tab-burndown-chart"
                            class="w-full h-80 relative z-10 scale-[1.02] origin-bottom"></div>
                    </div>

                    <!-- 2. FORECAST WIDGET -->
                    <!-- AI Forecast Widget Removed -->

                    <!-- Main Overview Stats -->
                    <!-- Main Overview Stats (Unwrapped) -->
                    <!-- Left: Circular Health Chart -->
                    <!-- Left: Circular Health Chart -->
                    <div
                        class="bg-dark-800/60 backdrop-blur-xl p-6 rounded-[32px] border border-white/10 flex flex-col items-center justify-between relative shadow-2xl overflow-hidden group">
                        <!-- Ambient Glow -->
                        <div
                            class="absolute -top-10 -left-10 w-32 h-32 bg-indigo-500/10 rounded-full blur-3xl opacity-0 group-hover:opacity-100 transition-opacity duration-700">
                        </div>

                        <div class="flex justify-between items-center w-full z-10 mb-2">
                            <h3 class="text-slate-500 font-extrabold uppercase text-[10px] tracking-[0.2em] pt-1">Salud
                                Financiera</h3>
                            <button onclick="openBatchBudgetEditor2()"
                                class="p-2 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 text-slate-400 hover:text-white transition group"
                                title="Configurar Presupuesto">
                                <i data-lucide="settings-2"
                                    class="w-4 h-4 group-hover:rotate-90 transition-transform"></i>
                            </button>
                        </div>

                        <div id="budgetHealthChart" class="flex justify-center items-center relative z-10"></div>

                        <div class="flex flex-col items-center z-10 -mt-8 relative">
                            <span
                                class="text-[9px] text-slate-500 font-bold uppercase tracking-[0.2em] mb-2 opacity-60">Disponible</span>
                            <div class="relative">
                                <span id="b-total-remaining"
                                    class="text-4xl font-black text-white tracking-tighter drop-shadow-2xl transition-colors font-mono">--</span>
                                <div
                                    class="absolute -bottom-1 left-0 w-full h-[2px] bg-gradient-to-r from-transparent via-indigo-500/50 to-transparent">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Summary Cards & Focus (Stacked vertically) -->
                    <div class="xl:col-span-2 space-y-4">
                        <!-- Comparison Section -->
                        <div
                            class="bg-dark-800/60 backdrop-blur-xl p-5 rounded-[32px] border border-white/10 relative shadow-2xl overflow-hidden group">
                            <!-- Ambient Glow -->
                            <div
                                class="absolute -top-10 -right-10 w-32 h-32 bg-emerald-500/10 rounded-full blur-3xl opacity-0 group-hover:opacity-100 transition-opacity duration-700">
                            </div>

                            <div class="flex justify-between items-start mb-6 relative z-10">
                                <h3 class="text-slate-500 font-extrabold uppercase text-[10px] tracking-[0.2em] pt-1">
                                    Comparativa Mensual</h3>
                                <div class="flex gap-8 text-right">
                                    <div class="flex flex-col group/val">
                                        <span
                                            class="text-[8px] text-slate-500 font-bold uppercase tracking-[0.2em] mb-1 opacity-60">Presupuesto</span>
                                        <span id="b-total-limit"
                                            class="text-lg font-black text-emerald-400 font-mono tracking-tight drop-shadow-lg">$0.00</span>
                                        <div
                                            class="h-[2px] w-0 group-hover/val:w-full bg-emerald-500/30 transition-all duration-500 mt-0.5">
                                        </div>
                                    </div>
                                    <div class="flex flex-col group/val">
                                        <span
                                            class="text-[8px] text-slate-500 font-bold uppercase tracking-[0.2em] mb-1 opacity-60">Gasto
                                            Real</span>
                                        <span id="b-total-spent"
                                            class="text-lg font-black text-rose-400 font-mono tracking-tight drop-shadow-lg">$0.00</span>
                                        <div
                                            class="h-[2px] w-0 group-hover/val:w-full bg-rose-500/30 transition-all duration-500 mt-0.5">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Comparison Chart -->
                            <div id="budgetComparisonChart" class="w-full relative z-10"></div>
                        </div>

                        <!-- Budget Focus Stats -->
                        <div
                            class="bg-dark-800/60 backdrop-blur-xl p-5 rounded-[32px] border border-white/10 relative shadow-2xl overflow-hidden group">
                            <!-- Ambient Glow -->
                            <div
                                class="absolute -top-10 -left-10 w-32 h-32 bg-pink-500/10 rounded-full blur-3xl opacity-0 group-hover:opacity-100 transition-opacity duration-700">
                            </div>

                            <div class="flex justify-between items-center mb-6 relative z-10">
                                <h3 class="text-slate-500 font-extrabold uppercase text-[10px] tracking-[0.2em] cursor-pointer hover:text-white transition"
                                    onclick="updateBudgetFocusStats();" title="Click to refresh chart">Distribución del
                                    Gasto</h3>
                                <div class="bg-white/5 p-1.5 rounded-lg border border-white/5">
                                    <i data-lucide="pie-chart" class="w-3.5 h-3.5 text-slate-400"></i>
                                </div>
                            </div>
                            <div class="grid grid-cols-5 gap-3 text-center mt-3 relative z-10">
                                <!-- NEEDS -->
                                <div class="cursor-pointer group relative" onclick="openFocusDetails('Needs')">
                                    <div class="h-1.5 w-full bg-[#1a1d2e] rounded-full overflow-hidden">
                                        <div id="bar-focus-needs"
                                            class="h-full bg-indigo-500 rounded-full w-0 transition-all duration-1000 group-hover:shadow-[0_0_10px_rgba(99,102,241,0.5)]">
                                        </div>
                                    </div>
                                    <div class="mt-2 text-center">
                                        <p class="text-[9px] font-bold text-slate-500 uppercase tracking-wider mb-0.5">
                                            Needs
                                        </p>
                                        <h4 id="val-focus-needs"
                                            class="text-lg font-black text-white tracking-tight group-hover:text-indigo-400 transition">
                                            0%</h4>
                                    </div>
                                </div>

                                <!-- WANTS -->
                                <div class="cursor-pointer group relative" onclick="openFocusDetails('Wants')">
                                    <div class="h-1.5 w-full bg-[#1a1d2e] rounded-full overflow-hidden">
                                        <div id="bar-focus-wants"
                                            class="h-full bg-pink-500 rounded-full w-0 transition-all duration-1000 group-hover:shadow-[0_0_10px_rgba(236,72,153,0.5)]">
                                        </div>
                                    </div>
                                    <div class="mt-2 text-center">
                                        <p class="text-[9px] font-bold text-slate-500 uppercase tracking-wider mb-0.5">
                                            Wants
                                        </p>
                                        <h4 id="val-focus-wants"
                                            class="text-lg font-black text-white tracking-tight group-hover:text-pink-400 transition">
                                            0%</h4>
                                    </div>
                                </div>
                                <!-- Save -->
                                <div class="cursor-pointer group relative" onclick="openFocusDetails('Saving')">
                                    <div class="h-1.5 w-full bg-[#1a1d2e] rounded-full overflow-hidden">
                                        <div id="bar-focus-saving"
                                            class="h-full bg-emerald-500 rounded-full w-0 transition-all duration-1000 group-hover:shadow-[0_0_10px_rgba(16,185,129,0.5)]">
                                        </div>
                                    </div>
                                    <div class="mt-2 text-center">
                                        <p class="text-[9px] font-bold text-slate-500 uppercase tracking-wider mb-0.5">
                                            Saving
                                        </p>
                                        <h4 id="val-focus-saving"
                                            class="text-lg font-black text-white tracking-tight group-hover:text-emerald-400 transition">
                                            0%</h4>
                                    </div>
                                </div>

                                <!-- Investment -->
                                <div class="cursor-pointer group relative" onclick="openFocusDetails('Investment')">
                                    <div class="h-1.5 w-full bg-[#1a1d2e] rounded-full overflow-hidden">
                                        <div id="bar-focus-investment"
                                            class="h-full bg-orange-500 rounded-full w-0 transition-all duration-1000 group-hover:shadow-[0_0_10px_rgba(249,115,22,0.5)]">
                                        </div>
                                    </div>
                                    <div class="mt-2 text-center">
                                        <p class="text-[9px] font-bold text-slate-500 uppercase tracking-wider mb-0.5">
                                            Invest
                                        </p>
                                        <h4 id="val-focus-investment"
                                            class="text-lg font-black text-white tracking-tight group-hover:text-orange-400 transition">
                                            0%</h4>
                                    </div>
                                </div>

                                <!-- Waste -->
                                <div class="cursor-pointer group relative" onclick="openFocusDetails('Waste')">
                                    <div class="h-1.5 w-full bg-[#1a1d2e] rounded-full overflow-hidden">
                                        <div id="bar-focus-waste"
                                            class="h-full bg-red-500 rounded-full w-0 transition-all duration-1000 group-hover:shadow-[0_0_10px_rgba(239,68,68,0.5)]">
                                        </div>
                                    </div>
                                    <div class="mt-2 text-center">
                                        <p class="text-[9px] font-bold text-slate-500 uppercase tracking-wider mb-0.5">
                                            Waste
                                        </p>
                                        <h4 id="val-focus-waste"
                                            class="text-lg font-black text-white tracking-tight group-hover:text-red-400 transition">
                                            0%</h4>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 3. TOP OFFENDERS (New) -->

                    </div>
                    <!-- End of Summary Cards Wrapper (was 3. TOP OFFENDERS) -->


                    <!-- Bottom Section: Categories & Calendar Layout (Stacked) -->
                    <div class="mt-8 flex flex-col gap-8 xl:col-span-3">
                        <!-- Categories List (Full Width) -->
                        <div class="w-full">
                            <div class="flex justify-between items-center mb-6 pl-2">
                                <h3 class="text-xl font-bold text-white flex items-center gap-2"><i data-lucide="layers"
                                        class="w-5 h-5 text-primary"></i> Categorías</h3>
                            </div>
                            <!-- Full width grid -->
                            <div id="budget-list"
                                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                <!-- JS Content -->
                            </div>
                        </div>

                        <!-- Calendar Section (Full Width, below Categories) -->
                        <div class="bg-dark-800 rounded-3xl p-8 border border-white/5 relative w-full group">
                            <!-- Background Ambient Effect (Wrapped to clip) -->
                            <div class="absolute inset-0 overflow-hidden rounded-3xl pointer-events-none">
                                <div
                                    class="absolute top-0 right-0 w-96 h-96 bg-indigo-500/5 rounded-full blur-[100px] pointer-events-none group-hover:bg-indigo-500/10 transition-colors duration-1000">
                                </div>
                            </div>

                            <!-- Header -->
                            <div class="flex items-start justify-between mb-8 relative z-10">
                                <!-- Left: Title & Month Nav -->
                                <div class="flex flex-col items-start gap-4">
                                    <h3
                                        class="text-xs font-bold text-slate-500 uppercase tracking-[0.25em] flex items-center gap-2">
                                        <i data-lucide="calendar" class="w-4 h-4 text-indigo-500"></i>
                                        Daily Breakdown
                                    </h3>

                                    <!-- Month Nav Pill -->
                                    <div
                                        class="flex items-center gap-1 bg-[#0f1115] rounded-full p-1 border border-white/5 shadow-inner">
                                        <button onclick="changeBudgetMonth(-1)"
                                            class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-white/10 text-slate-400 hover:text-white transition group/btn">
                                            <i data-lucide="chevron-left"
                                                class="w-4 h-4 group-hover:-translate-x-0.5 transition-transform"></i>
                                        </button>
                                        <span id="budget-cal-month-title"
                                            class="text-xs font-bold text-white px-4 min-w-[140px] text-center capitalize tracking-wide font-mono">
                                            --
                                        </span>
                                        <button onclick="changeBudgetMonth(1)"
                                            class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-white/10 text-slate-400 hover:text-white transition group/btn">
                                            <i data-lucide="chevron-right"
                                                class="w-4 h-4 group-hover:translate-x-0.5 transition-transform"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Right: Current Date & Badge -->
                                <div class="flex flex-col items-end">
                                    <h2 id="budget-cal-current-date"
                                        class="text-3xl font-black text-white tracking-tighter drop-shadow-lg text-right">
                                        --
                                    </h2>
                                    <span
                                        class="text-[10px] font-black text-indigo-400 bg-indigo-500/10 px-2 py-1 rounded-lg uppercase tracking-widest border border-indigo-500/20 mt-1 shadow-[0_0_10px_rgba(99,102,241,0.2)]">
                                        Today
                                    </span>
                                </div>
                            </div>

                            <!-- Weekdays Header -->
                            <div class="grid grid-cols-7 text-center mb-2 px-2 relative z-10">
                                <div class="text-[10px] text-slate-600 font-bold uppercase tracking-widest py-2">Dom
                                </div>
                                <div class="text-[10px] text-slate-600 font-bold uppercase tracking-widest py-2">Lun
                                </div>
                                <div class="text-[10px] text-slate-600 font-bold uppercase tracking-widest py-2">Mar
                                </div>
                                <div class="text-[10px] text-slate-600 font-bold uppercase tracking-widest py-2">Mié
                                </div>
                                <div class="text-[10px] text-slate-600 font-bold uppercase tracking-widest py-2">Jue
                                </div>
                                <div class="text-[10px] text-slate-600 font-bold uppercase tracking-widest py-2">Vie
                                </div>
                                <div class="text-[10px] text-slate-600 font-bold uppercase tracking-widest py-2">Sáb
                                </div>
                            </div>

                            <!-- Calendar Grid -->
                            <div id="budget-cal-grid"
                                class="grid grid-cols-7 gap-y-6 text-center text-sm relative z-10 px-2">
                                <!-- Days will be injected here by JS -->
                            </div>

                            <!-- Legend -->
                            <div
                                class="mt-8 pt-6 border-t border-white/5 flex items-center justify-between relative z-10">
                                <div class="flex items-center gap-4">
                                    <div class="flex items-center gap-2">
                                        <span
                                            class="w-1.5 h-1.5 rounded-full bg-rose-500 shadow-[0_0_6px_rgba(244,63,94,0.6)]"></span>
                                        <span
                                            class="text-[9px] font-bold text-slate-500 uppercase tracking-wider">High</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span
                                            class="w-1.5 h-1.5 rounded-full bg-amber-500 shadow-[0_0_6px_rgba(245,158,11,0.6)]"></span>
                                        <span
                                            class="text-[9px] font-bold text-slate-500 uppercase tracking-wider">Med</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span
                                            class="w-1.5 h-1.5 rounded-full bg-indigo-500 shadow-[0_0_6px_rgba(99,102,241,0.6)]"></span>
                                        <span
                                            class="text-[9px] font-bold text-slate-500 uppercase tracking-wider">Low</span>
                                    </div>
                                </div>
                                <div class="text-[10px] text-slate-600 italic">
                                    <i data-lucide="filter" class="w-3 h-3 inline mr-1"></i> Interactive
                                </div>

                                <!-- New Reminder Button (Bottom) -->
                                <button onclick="window.addMonthlyReminder()"
                                    class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-indigo-500/10 hover:bg-indigo-500/20 border border-indigo-500/20 text-indigo-400 text-[10px] font-bold uppercase tracking-wider transition-all shadow-lg shadow-indigo-500/5 hover:scale-105">
                                    <i data-lucide="plus-circle" class="w-3 h-3"></i> Recordatorio
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- End of view-budget container -->

        <!-- SAVINGS VIEW: FINANCIAL STRATEGY CENTER -->
        <section id="view-savings" class="tab-content hidden animate-fade-in space-y-8 pb-12">
            <!-- New Tab Header -->
            <div class="flex items-center gap-6 mb-10 pl-2">
                <div
                    class="w-16 h-16 rounded-[24px] bg-gradient-to-br from-indigo-500/20 to-purple-500/20 border border-white/10 flex items-center justify-center shadow-xl shadow-indigo-500/10">
                    <i data-lucide="piggy-bank" class="w-8 h-8 text-indigo-400"></i>
                </div>
                <div class="flex flex-col">
                    <h2 class="text-4xl font-black text-white tracking-tight leading-tight uppercase">Ahorro</h2>
                    <p class="text-slate-500 text-xs font-bold tracking-[0.3em] uppercase">OBJETIVOS Y PATRIMONIO</p>
                </div>
            </div>


            <!-- 1. The Strategy Header (REMOVED) -->

            <!-- 2. Split Strategy: Debt vs Wealth -->
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">

                <!-- ZONE B: ACTIVE PORTFOLIO (Restored) -->
                <div
                    class="bg-[#161b22]/50 rounded-[2.5rem] p-8 border border-emerald-500/10 relative overflow-hidden flex flex-col">
                    <div class="absolute top-0 right-0 w-full h-1 bg-gradient-to-l from-emerald-500 to-transparent">
                    </div>

                    <div class="flex items-center justify-between mb-8">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-12 h-12 rounded-2xl bg-emerald-500/10 flex items-center justify-center text-emerald-500 border border-emerald-500/20 shadow-[0_0_15px_rgba(16,185,129,0.1)]">
                                <i data-lucide="layers" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-black text-white">Active Portfolio</h3>
                                <div class="flex items-center gap-3">
                                    <p class="text-xs text-emerald-400 font-bold uppercase tracking-wider">Total
                                        Value
                                    </p>
                                    <span class="w-1 h-1 rounded-full bg-slate-600"></span>
                                    <p id="savings-net-worth-header" class="text-xs text-white/50 font-mono">$0.00
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- The Grid Container for JS to populate -->
                    <div id="savings-goals-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Content Injected by JS -->
                    </div>
                </div>

                <!-- ZONE A: LIABILITY LIQUIDATION -->
                <div class="bg-dark-900/50 rounded-[2.5rem] p-8 border border-red-500/10 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-red-500 to-transparent">
                    </div>

                    <div class="flex items-center justify-between mb-8">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-12 h-12 rounded-2xl bg-red-500/10 flex items-center justify-center text-red-500 border border-red-500/20 shadow-[0_0_15px_rgba(239,68,68,0.1)]">
                                <i data-lucide="bomb" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-black text-white">Liability Liquidation</h3>
                                <p class="text-xs text-red-400 font-bold uppercase tracking-wider">Destroy Debt</p>
                            </div>
                        </div>
                        <button onclick="addDebtItem()"
                            class="w-10 h-10 rounded-full bg-white/5 hover:bg-red-500 hover:text-white text-slate-400 flex items-center justify-center transition border border-white/5">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <div id="savings-debt-list" class="space-y-4">
                        <!-- Debt Items -->
                    </div>
                </div>

            </div>

            <!-- 3. Strategic Outlook (REMOVED) -->
        </section>

        <!-- Settings Tab -->
        <div id="view-analytics-2" class="tab-content hidden animate-fade-in">
            <!-- Header -->
            <div class="flex justify-between items-end mb-8 pl-2">
                <div>
                    <h2 class="text-4xl font-black text-white tracking-tight flex items-center gap-3">
                        <span class="bg-indigo-500/20 text-indigo-400 p-2 rounded-2xl">
                            <i data-lucide="layout-grid" class="w-8 h-8"></i>
                        </span>
                        AUREUS ANALYTICS
                    </h2>
                    <p class="text-slate-400 text-sm mt-1 ml-1 font-mono tracking-widest">SYSTEM STATUS: OPTIMAL</p>
                </div>
            </div>

            <!-- BENTO GRID -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

                <!-- ROW 1 -->
                <!-- Widget A: Balance -->
                <!-- Widget A: Historical Income -->
                <div
                    class="bg-[#0f1115] rounded-[24px] p-6 border border-white/5 relative overflow-hidden group hover:border-emerald-500/20 transition-all duration-500 shadow-2xl shadow-black/50">
                    <!-- Glow -->
                    <div
                        class="absolute -top-10 -right-10 w-32 h-32 bg-emerald-500/10 rounded-full blur-3xl pointer-events-none group-hover:bg-emerald-500/20 transition duration-500">
                    </div>

                    <div class="flex items-center gap-3 mb-4 relative z-10">
                        <div
                            class="w-10 h-10 rounded-xl bg-emerald-500/20 flex items-center justify-center border border-emerald-500/20 text-emerald-400 group-hover:scale-110 transition duration-300">
                            <i data-lucide="trending-up" class="w-5 h-5"></i>
                        </div>
                        <h3 class="text-emerald-100/60 text-[11px] font-bold uppercase tracking-[0.2em]">Total
                            Ingresos
                        </h3>
                    </div>

                    <div class="relative z-10">
                        <div class="text-4xl font-black text-white mb-1 tracking-tighter drop-shadow-lg"
                            id="a2-balance-val">$--</div>
                        <div class="text-slate-500 text-xs font-mono font-medium tracking-wide flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                            Histórico Acumulado
                        </div>
                    </div>

                    <div id="a2-spark-balance" class="h-14 w-[110%] -ml-[5%] mt-4 opacity-70"></div>
                </div>

                <!-- Widget B: Expenses -->
                <!-- Widget B: Historical Expenses -->
                <div
                    class="bg-[#0f1115] rounded-[24px] p-6 border border-white/5 relative overflow-hidden group hover:border-rose-500/20 transition-all duration-500 shadow-2xl shadow-black/50">
                    <!-- Glow -->
                    <div
                        class="absolute -top-10 -right-10 w-32 h-32 bg-rose-500/10 rounded-full blur-3xl pointer-events-none group-hover:bg-rose-500/20 transition duration-500">
                    </div>

                    <div class="flex items-center gap-3 mb-4 relative z-10">
                        <div
                            class="w-10 h-10 rounded-xl bg-rose-500/20 flex items-center justify-center border border-rose-500/20 text-rose-400 group-hover:scale-110 transition duration-300">
                            <i data-lucide="trending-down" class="w-5 h-5"></i>
                        </div>
                        <h3 class="text-rose-100/60 text-[11px] font-bold uppercase tracking-[0.2em]">Total Gastos
                        </h3>
                    </div>

                    <div class="relative z-10">
                        <div class="text-4xl font-black text-white mb-1 tracking-tighter drop-shadow-lg"
                            id="a2-expense-val">$--</div>
                        <div class="text-slate-500 text-xs font-mono font-medium tracking-wide flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-rose-500 animate-pulse"></span>
                            Histórico Acumulado
                        </div>
                    </div>

                    <div id="a2-spark-expense" class="h-14 w-[110%] -ml-[5%] mt-4 opacity-70"></div>
                </div>

                <!-- Widget C: Virtual Card -->
                <div
                    class="bg-gradient-to-br from-[#0d1117] to-black rounded-[20px] p-6 border border-white/10 relative overflow-hidden flex flex-col justify-between h-48 shadow-2xl group hover:scale-[1.02] transition duration-500">
                    <div
                        class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-20">
                    </div>
                    <div class="flex justify-between items-start z-10">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg"
                            class="h-5 w-auto opacity-70 invert">
                        <i data-lucide="wifi" class="w-6 h-6 text-white/30 rotate-90"></i>
                    </div>
                    <div class="mt-4 z-10">
                        <div class="text-slate-500 text-[9px] uppercase tracking-[0.2em] mb-1 font-bold">Main
                            Account
                        </div>
                        <div class="text-2xl font-mono text-white tracking-widest drop-shadow-md" id="a2-card-balance">
                            $0.00</div>
                    </div>
                    <div class="flex justify-between items-end mt-4 z-10">
                        <div class="text-white/40 font-mono text-xs tracking-widest">**** 4299</div>
                        <div class="flex gap-2">
                            <div class="w-2 h-2 rounded-full bg-red-500 shadow-[0_0_10px_red]"></div>
                            <div class="w-2 h-2 rounded-full bg-yellow-500 shadow-[0_0_10px_orange]"></div>
                            <div class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_green]"></div>
                        </div>
                    </div>
                </div>

                <!-- Widget D: Categories Donut -->
                <div
                    class="bg-[#161b22] rounded-[20px] p-4 border border-white/5 flex flex-col items-center justify-center relative hover:border-white/10 transition">
                    <h3
                        class="absolute top-4 left-6 text-slate-400 text-[10px] font-bold uppercase tracking-widest font-mono">
                        Distribution</h3>
                    <div id="a2-chart-donut" class="w-full h-full flex items-center justify-center pt-6"></div>
                </div>

                <!-- ROW 2 -->
                <!-- Widget E: Monthly Bars -->


                <!-- Widget F: Spending Parameters (CRITICAL) -->
                <div
                    class="bg-[#161b22] rounded-[20px] p-6 border border-white/5 md:col-span-2 lg:col-span-3 h-96 flex flex-col hover:bg-[#1c222b] transition relative overflow-hidden">
                    <div
                        class="absolute top-0 right-0 p-32 bg-primary/5 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none">
                    </div>
                    <h3 class="text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-4 font-mono z-10">
                        Budget Health Parameters <span class="text-indigo-400 ml-2 animate-pulse">● LIVE</span></h3>
                    <div class="flex-1 flex items-center justify-around w-full z-10 gap-2 overflow-x-auto"
                        id="a2-gauges-container">
                        <!-- Injected via JS: 5 divs -->
                        <div class="text-slate-600 animate-pulse text-xs font-mono">Waiting for data stream...</div>
                    </div>
                </div>

                <!-- ROW 3 -->
                <!-- Widget G: Recent -->
                <div
                    class="bg-[#161b22] rounded-[20px] p-6 border border-white/5 h-80 overflow-hidden flex flex-col hover:border-white/10 transition">
                    <h3 class="text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-4 font-mono">Latest
                        Transactions</h3>
                    <div id="a2-recent-list" class="space-y-3 flex-1 overflow-y-auto pr-1"></div>
                </div>

                <!-- Widget H: Investments -->
                <div
                    class="bg-[#161b22] rounded-[20px] p-6 border border-white/5 h-80 flex flex-col justify-center hover:border-emerald-500/20 transition relative">
                    <h3 class="text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-6 font-mono">Growth
                        Targets</h3>
                    <div id="a2-invest-list" class="space-y-6 w-full relative z-10"></div>
                    <div
                        class="absolute bottom-0 right-0 p-24 bg-emerald-500/5 rounded-full blur-2xl -mr-10 -mb-10 pointer-events-none">
                    </div>
                </div>

                <!-- Widget I: SPENDING VELOCITY (Replaces AI Forecast) -->
                <div
                    class="bg-black/40 rounded-[32px] p-8 border border-white/10 md:col-span-2 h-96 relative overflow-hidden backdrop-blur-xl group hover:border-white/20 transition-all duration-500 shadow-2xl flex flex-col justify-between">

                    <!-- Background Effects -->
                    <div
                        class="absolute top-0 right-0 w-full h-full bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-indigo-500/10 via-transparent to-transparent pointer-events-none">
                    </div>
                    <div
                        class="absolute bottom-0 left-0 w-64 h-64 bg-fuchsia-500/5 rounded-full blur-[80px] pointer-events-none">
                    </div>

                    <!-- Header -->
                    <div class="flex justify-between items-center relative z-10">
                        <div>
                            <h3 class="text-white text-lg font-black uppercase tracking-tight flex items-center gap-2">
                                <i data-lucide="activity" class="w-5 h-5 text-fuchsia-400"></i> Spending Velocity
                            </h3>
                            <p class="text-[10px] text-slate-400 font-medium mt-1">Real-time burn rate analysis</p>
                        </div>
                        <div class="px-3 py-1.5 rounded-lg bg-white/5 border border-white/5 flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse" id="vel-status-dot"></span>
                            <span class="text-[10px] font-bold text-white uppercase tracking-wider"
                                id="vel-status-text">ACTIVE</span>
                        </div>
                    </div>

                    <!-- Main Metric: Velocity Gauge -->
                    <div class="relative z-10 flex-1 flex flex-col justify-center items-center py-4">
                        <!-- Projected Big Number -->
                        <div class="text-center mb-6">
                            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em] mb-2">
                                Projected
                                Month End</p>
                            <h2 id="vel-projected-val"
                                class="text-6xl font-black text-white tracking-tighter drop-shadow-[0_0_20px_rgba(255,255,255,0.1)]">
                                $0.00</h2>
                        </div>

                        <!-- Progress Bar Container -->
                        <div class="w-full max-w-sm">
                            <div class="flex justify-between items-end mb-2">
                                <span class="text-[10px] font-bold text-fuchsia-300 uppercase">Budget Usage</span>
                                <span class="text-xs font-mono font-bold text-white" id="vel-pct-text">0%</span>
                            </div>
                            <div
                                class="h-3 w-full bg-white/5 rounded-full overflow-hidden border border-white/5 relative">
                                <!-- The Bar -->
                                <div id="vel-progress-bar"
                                    class="h-full bg-gradient-to-r from-indigo-500 via-purple-500 to-fuchsia-500 w-0 transition-all duration-1000 relative">
                                    <div class="absolute right-0 top-0 bottom-0 w-1 bg-white/50 blur-[2px]"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer Details -->
                    <div class="grid grid-cols-2 gap-4 pt-6 border-t border-white/5 relative z-10">
                        <div>
                            <p class="text-[9px] font-bold text-slate-500 uppercase tracking-wider mb-1">Time
                                Elapsed
                            </p>
                            <div class="flex items-center gap-2">
                                <div class="w-1.5 h-1.5 rounded-full bg-slate-600"></div>
                                <span id="vel-time-elapsed" class="text-sm font-bold text-slate-300 font-mono">0%</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[9px] font-bold text-slate-500 uppercase tracking-wider mb-1">Safe Daily
                                Spend</p>
                            <span id="vel-safe-daily" class="text-lg font-bold text-white font-mono">$0.00</span>
                        </div>
                    </div>

                </div>

            </div>
        </div>

        <div id="view-settings" class="tab-content hidden animate-fade-in min-h-screen pb-24">
            <!-- Header -->
            <!-- New Tab Header -->
            <div class="flex items-center gap-6 mb-10 pl-2">
                <div
                    class="w-16 h-16 rounded-[24px] bg-gradient-to-br from-indigo-500/20 to-purple-500/20 border border-white/10 flex items-center justify-center shadow-xl shadow-indigo-500/10">
                    <i data-lucide="settings-2" class="w-8 h-8 text-indigo-400"></i>
                </div>
                <div class="flex flex-col">
                    <h2 class="text-4xl font-black text-white tracking-tight leading-tight uppercase">Settings</h2>
                    <p class="text-slate-500 text-xs font-bold tracking-[0.3em] uppercase">CONFIGURACIÓN DEL SISTEMA</p>
                </div>
            </div>


            <!-- Top Row: Profile & Stats -->
            <!-- Profile Header Card (Full Width) -->
            <!-- Profile Header Card (Responsive: Vertical on Mobile, Horizontal on Desktop) -->
            <div
                class="bg-[#1a1d2e] rounded-[32px] p-8 border border-white/[0.08] relative overflow-hidden flex flex-col md:flex-row items-center justify-between gap-10 group mb-8 w-full shadow-2xl">

                <!-- Background Decorations -->
                <div
                    class="absolute top-0 right-0 w-96 h-96 bg-indigo-500/10 rounded-full blur-[120px] -translate-y-1/2 translate-x-1/2 pointer-events-none">
                </div>
                <div
                    class="absolute bottom-0 left-0 w-64 h-64 bg-purple-500/5 rounded-full blur-[100px] translate-y-1/2 -translate-x-1/2 pointer-events-none">
                </div>

                <!-- Column 1: Avatar Section -->
                <div class="relative shrink-0 flex flex-col items-center">
                    <div
                        class="w-24 h-24 rounded-full p-[2px] bg-gradient-to-br from-indigo-500 to-purple-500 shadow-2xl shadow-indigo-500/20 group-hover:shadow-indigo-500/40 transition duration-500">
                        <div class="w-full h-full rounded-full bg-[#0f1115] p-1">
                            <img id="profile-image"
                                src="https://ui-avatars.com/api/?name=Jesus+Rodriguez&background=random&color=fff"
                                alt="Profile" class="w-full h-full rounded-full object-cover">
                        </div>
                    </div>
                    <input type="file" id="profile-upload" class="hidden" accept="image/*"
                        onchange="handleProfileUpload(event)">
                    <button onclick="document.getElementById('profile-upload').click()"
                        class="absolute bottom-0 right-0 bg-[#1e293b] text-white p-2 rounded-full border border-white/10 hover:bg-white hover:text-black transition shadow-lg hover:scale-110 active:scale-95">
                        <i data-lucide="camera" class="w-3.5 h-3.5"></i>
                    </button>
                </div>

                <!-- Column 2: User Info -->
                <div class="flex flex-col gap-5 flex-1 min-w-[200px] items-center md:items-start">
                    <div class="w-full">
                        <label
                            class="text-[9px] uppercase font-bold text-slate-500 mb-1.5 block tracking-widest text-center md:text-left">Nombre</label>
                        <div class="relative w-full max-w-sm">
                            <input type="text" id="profile-name-input" value="Jesus Rodriguez" readonly
                                class="w-full bg-[#0a0c10] border border-white/5 rounded-xl px-4 py-2.5 text-slate-400 font-bold text-sm focus:outline-none transition cursor-default shadow-inner text-center md:text-left">
                            <i data-lucide="lock"
                                class="absolute right-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-700 pointer-events-none"></i>
                        </div>
                    </div>
                    <div class="w-full">
                        <label
                            class="text-[9px] uppercase font-bold text-slate-500 mb-1.5 block tracking-widest text-center md:text-left">Usuario</label>
                        <div class="relative w-full max-w-sm">
                            <input type="text" id="profile-username-input" value="BlindSnk" readonly
                                class="w-full bg-[#0a0c10] border border-white/5 rounded-xl px-4 py-2.5 text-slate-400 font-bold text-sm focus:outline-none transition cursor-default shadow-inner text-center md:text-left">
                            <i data-lucide="lock"
                                class="absolute right-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-700 pointer-events-none"></i>
                        </div>
                    </div>
                </div>

                <!-- Column 3: Security / Password -->
                <div class="flex flex-col gap-4 flex-1 min-w-[240px] items-center md:items-start">
                    <div class="w-full">
                        <label
                            class="text-[9px] uppercase font-bold text-slate-500 mb-1.5 block tracking-widest text-center md:text-left">Contraseña</label>
                        <div class="relative w-full max-w-sm">
                            <input type="password" id="profile-password-input" value="dummy-password" readonly
                                class="w-full bg-[#0a0c10] border border-white/10 rounded-xl px-4 py-2.5 text-slate-400 font-bold text-sm focus:outline-none shadow-inner tracking-[0.4em] focus:ring-0 text-center md:text-left">
                        </div>
                    </div>
                    <button onclick="changePassword()"
                        class="w-full max-w-sm py-2.5 rounded-xl bg-indigo-500/10 hover:bg-indigo-500 border border-indigo-500/20 text-indigo-400 hover:text-white font-bold text-[10px] uppercase tracking-widest transition-all duration-300 shadow-xl hover:shadow-indigo-500/20 active:scale-95">
                        Cambiar Contraseña
                    </button>
                </div>

                <!-- Column 4: Logout Action -->
                <div class="flex items-center justify-center shrink-0">
                    <button onclick="handleLogout()"
                        class="px-8 py-3.5 rounded-xl bg-rose-500/10 hover:bg-rose-500 border border-rose-500/20 text-rose-400 hover:text-white transition-all duration-300 font-black text-[10px] uppercase tracking-[0.25em] flex items-center justify-center gap-3 group shadow-2xl active:scale-95">
                        <i data-lucide="log-out" class="w-4 h-4 group-hover:-translate-x-1 transition-transform"></i>
                        Cerrar Sesión
                    </button>
                </div>

                <!-- Column 5: Stats Section -->
                <div
                    class="flex flex-col gap-6 shrink-0 border-t md:border-t-0 md:border-l border-white/5 pt-6 md:pt-0 md:pl-8 items-center md:items-start">
                    <div class="text-center md:text-left">
                        <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-1.5">Status</p>
                        <div
                            class="flex items-center gap-2 text-emerald-400 text-[10px] font-bold tracking-widest uppercase">
                            <span class="relative flex h-2 w-2">
                                <span
                                    class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                            </span>
                            Active
                        </div>
                    </div>
                    <div class="text-center md:text-left">
                        <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-1.5">Joined</p>
                        <p class="text-white text-[11px] font-bold tracking-widest uppercase">Dec 2024</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-12 gap-8 items-start">
                <!-- COLUMN 1: Theme Aesthetic -->
                <div
                    class="xl:col-span-4 bg-[#1a1d2e] rounded-3xl p-6 border border-white/[0.08] relative overflow-hidden flex flex-col gap-6">
                    <div class="flex items-center gap-3">
                        <div class="bg-indigo-500/20 p-2 rounded-xl text-indigo-400">
                            <i data-lucide="palette" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-white text-lg">Theme Aesthetic</h3>
                            <p class="text-xs text-slate-500">Design your unique gradient signature
                            </p>
                        </div>
                    </div>

                    <!-- Control Row: Interface Mode Only -->
                    <div class="mb-4">
                        <div
                            class="bg-[#12141f]/50 rounded-2xl p-4 border border-white/5 flex items-center justify-between group hover:border-white/10 transition">
                            <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Interface
                                Mode</span>
                            <div class="flex bg-black/40 rounded-xl p-1 border border-white/5 relative w-48">
                                <div id="mode-indicator"
                                    class="absolute inset-y-1 w-[calc(50%-4px)] bg-[#1a1d2e] rounded-lg shadow-sm transition-all duration-300 left-1 border border-white/5">
                                </div>
                                <button onclick="toggleInterfaceMode('dark')" id="btn-mode-dark"
                                    class="flex-1 relative z-10 py-1.5 rounded-lg text-indigo-400 transition hover:text-white flex items-center justify-center">
                                    <i data-lucide="moon" class="w-4 h-4"></i>
                                </button>
                                <button onclick="toggleInterfaceMode('light')" id="btn-mode-light"
                                    class="flex-1 relative z-10 py-1.5 rounded-lg text-slate-500 transition hover:text-white flex items-center justify-center">
                                    <i data-lucide="sun" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Color Pickers -->
                    <!-- Visual Identity Engine (Redesigned) -->
                    <div
                        class="bg-[#12141f]/80 rounded-[2rem] p-8 border border-white/5 relative overflow-hidden backdrop-blur-2xl">
                        <!-- Subtle Background Light -->
                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-indigo-500/10 rounded-full blur-[80px] pointer-events-none"
                            id="tm-ambient-glow">
                        </div>

                        <div class="relative z-10 flex flex-col gap-8">
                            <!-- Header -->
                            <div class="flex items-center justify-between">
                                <h3 class="font-black text-white text-xl tracking-tight flex items-center gap-3">
                                    <span class="p-2 rounded-xl bg-white/5 border border-white/5 text-indigo-400">
                                        <i data-lucide="zap" class="w-5 h-5"></i>
                                    </span>
                                    Visual Identity
                                </h3>
                                <button onclick="randomizeGradient()"
                                    class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 text-slate-400 hover:text-white flex items-center justify-center transition border border-white/5 group shadow-lg">
                                    <i data-lucide="shuffle"
                                        class="w-4 h-4 group-hover:rotate-180 transition duration-500"></i>
                                </button>
                            </div>

                            <!-- Main Control Area -->
                            <div class="grid grid-cols-1 xl:grid-cols-5 gap-12 items-center">

                                <!-- Left: Color Controls (Span 3) -->
                                <div class="xl:col-span-3 space-y-6">

                                    <!-- Primary Color -->
                                    <div class="space-y-3">
                                        <div
                                            class="flex justify-between text-xs font-bold uppercase tracking-widest text-slate-500">
                                            <span>Primary Tint</span>
                                            <span id="tm-badge-primary" class="text-indigo-400">#6366F1</span>
                                        </div>
                                        <div
                                            class="flex items-center gap-4 bg-[#0a0c10] p-2 pr-4 rounded-xl border border-white/10 focus-within:border-indigo-500/50 transition duration-300">
                                            <div class="relative group shrink-0">
                                                <input type="color" id="tm-primary-picker" value="#6366F1"
                                                    class="w-12 h-12 rounded-lg cursor-pointer bg-transparent border-none opacity-0 absolute inset-0 z-20">
                                                <div class="w-12 h-12 rounded-lg bg-indigo-500 shadow-inner ring-1 ring-white/10 group-hover:scale-105 transition"
                                                    id="tm-indicator-primary" style="background-color: #6366F1;">
                                                </div>
                                            </div>
                                            <input type="text" id="tm-primary-input" value="#6366F1"
                                                class="bg-transparent border-none text-white font-mono text-base font-bold w-full focus:outline-none uppercase tracking-wider placeholder-slate-700">
                                        </div>
                                    </div>

                                    <!-- Accent Color -->
                                    <div class="space-y-3">
                                        <div
                                            class="flex justify-between text-xs font-bold uppercase tracking-widest text-slate-500">
                                            <span>Accent Shade</span>
                                            <span id="tm-badge-accent" class="text-purple-400">#A855F7</span>
                                        </div>
                                        <div
                                            class="flex items-center gap-4 bg-[#0a0c10] p-2 pr-4 rounded-xl border border-white/10 focus-within:border-purple-500/50 transition duration-300">
                                            <div class="relative group shrink-0">
                                                <input type="color" id="tm-accent-picker" value="#A855F7"
                                                    class="w-12 h-12 rounded-lg cursor-pointer bg-transparent border-none opacity-0 absolute inset-0 z-20">
                                                <div class="w-12 h-12 rounded-lg bg-purple-500 shadow-inner ring-1 ring-white/10 group-hover:scale-105 transition"
                                                    id="tm-indicator-accent" style="background-color: #A855F7;">
                                                </div>
                                            </div>
                                            <input type="text" id="tm-accent-input" value="#A855F7"
                                                class="bg-transparent border-none text-white font-mono text-base font-bold w-full focus:outline-none uppercase tracking-wider placeholder-slate-700">
                                        </div>
                                    </div>

                                </div>

                                <!-- Right: Preview Orb (Span 2) -->
                                <div
                                    class="xl:col-span-2 flex flex-col items-center justify-center relative min-h-[200px]">
                                    <!-- The Glow Orb -->
                                    <div
                                        class="w-40 h-40 rounded-full relative group shadow-[0_0_50px_rgba(0,0,0,0.5)] transition-transform duration-700 hover:scale-105">
                                        <div id="tm-preview-gradient"
                                            class="absolute inset-0 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 animate-[spin_10s_linear_infinite]">
                                        </div>
                                        <div
                                            class="absolute inset-0 rounded-full bg-gradient-to-t from-black/20 to-transparent">
                                        </div>
                                        <div
                                            class="absolute inset-1 rounded-full bg-[#12141f] flex items-center justify-center z-10">
                                            <div class="text-center">
                                                <p
                                                    class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">
                                                    Preview</p>
                                                <h4 class="text-2xl font-black text-white tracking-tighter">
                                                    Aureus</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <p
                                        class="mt-6 text-xs text-slate-500 font-medium text-center max-w-[150px] leading-relaxed">
                                        Your custom gradient signature
                                    </p>
                                </div>
                            </div>

                            <!-- Presets Strip -->


                        </div>
                    </div>

                    <!-- Appearance Controls & Density Consolidated -->
                    <!-- Interface Dynamics -->
                    <div
                        class="bg-[#12141f]/50 rounded-2xl p-5 border border-white/5 relative overflow-hidden group hover:border-white/10 transition">
                        <div class="flex items-center gap-3 mb-5">
                            <div class="p-2 rounded-lg bg-emerald-500/10 text-emerald-400">
                                <i data-lucide="scan-face" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <span
                                    class="text-[10px] font-bold text-slate-500 uppercase tracking-wider block">Dynamics</span>
                                <p class="text-[10px] text-slate-600 font-medium">Shape &
                                    transparency</p>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <!-- Corner Radius Selector -->
                            <div>
                                <div class="flex justify-between items-center mb-3">
                                    <span class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">Corner
                                        Radius</span>
                                </div>
                                <div class="grid grid-cols-4 gap-2">
                                    <button onclick="setAppRadius('sharp')"
                                        class="aspect-square bg-white/5 hover:bg-white/10 border border-white/5 hover:border-white/20 transition flex items-center justify-center group/opt relative overflow-hidden rounded-none">
                                        <div
                                            class="w-3 h-3 border border-slate-500 group-hover/opt:border-white transition rounded-none">
                                        </div>
                                    </button>
                                    <button onclick="setAppRadius('standard')"
                                        class="aspect-square bg-white/5 hover:bg-white/10 border border-white/5 hover:border-white/20 transition flex items-center justify-center group/opt relative overflow-hidden rounded-md">
                                        <div
                                            class="w-3 h-3 border border-slate-500 group-hover/opt:border-white transition rounded-[2px]">
                                        </div>
                                    </button>
                                    <button onclick="setAppRadius('round')"
                                        class="aspect-square bg-white/5 hover:bg-white/10 border border-white/5 hover:border-white/20 transition flex items-center justify-center group/opt relative overflow-hidden rounded-xl">
                                        <div
                                            class="w-3 h-3 border border-slate-500 group-hover/opt:border-white transition rounded-[4px]">
                                        </div>
                                    </button>
                                    <button onclick="setAppRadius('playful')"
                                        class="aspect-square bg-white/5 hover:bg-white/10 border border-white/5 hover:border-white/20 transition flex items-center justify-center group/opt relative overflow-hidden rounded-2xl">
                                        <div
                                            class="w-3 h-3 border border-slate-500 group-hover/opt:border-white transition rounded-full">
                                        </div>
                                    </button>
                                </div>
                            </div>

                            <!-- Blur & Density Sliders -->
                            <div class="space-y-4 pt-4 border-t border-white/5">
                                <!-- Blur -->
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <span
                                            class="text-[9px] font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2">
                                            <i data-lucide="droplets" class="w-3 h-3"></i> Glass
                                            Blur
                                        </span>
                                        <span id="setting-blur-label"
                                            class="text-[9px] font-mono text-emerald-400 bg-emerald-500/10 px-1.5 py-0.5 rounded border border-emerald-500/20">70px</span>
                                    </div>
                                    <input type="range" id="setting-blur-slider"
                                        class="w-full h-1.5 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-emerald-500 hover:accent-emerald-400 transition-all"
                                        min="0" max="100" value="70" oninput="setAppBlur(this.value)">
                                </div>


                            </div>
                        </div>
                    </div>

                    <!-- Typography -->
                    <!-- Typography -->
                    <!-- Premium Typography Dashboard -->
                    <div
                        class="bg-[#12141f]/50 rounded-3xl p-6 border border-white/5 relative overflow-hidden group hover:border-white/10 transition flex flex-col justify-between min-h-[420px] shadow-2xl">
                        <!-- NEW ULTRA-PREMIUM TYPEFACE HEADER -->
                        <div
                            class="relative h-48 rounded-[2rem] overflow-hidden mb-8 group transition-all duration-500 hover:shadow-[0_0_40px_rgba(99,102,241,0.2)] border border-white/10 shrink-0">
                            <!-- Dynamic Background -->
                            <div class="absolute inset-0 bg-[#0f111a]">
                                <div
                                    class="absolute inset-0 bg-gradient-to-tr from-indigo-500/10 via-transparent to-purple-500/10 opacity-60">
                                </div>
                                <div
                                    class="absolute -top-24 -right-24 w-64 h-64 bg-indigo-500/20 rounded-full blur-[80px] group-hover:bg-indigo-500/30 transition duration-700">
                                </div>
                                <div
                                    class="absolute bottom-0 left-0 w-full h-1/2 bg-gradient-to-t from-[#0f111a] to-transparent">
                                </div>
                            </div>

                            <!-- Content -->
                            <div class="relative z-10 h-full p-6 flex flex-col justify-between">
                                <!-- Top Row -->
                                <div class="flex justify-between items-start">
                                    <div class="flex items-center gap-3">
                                        <div
                                            class="w-10 h-10 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center backdrop-blur-sm shadow-inner group-hover:scale-110 transition duration-300">
                                            <i data-lucide="type" class="w-5 h-5 text-indigo-400"></i>
                                        </div>
                                        <div>
                                            <div class="flex items-center gap-2">
                                                <span
                                                    class="text-[9px] font-black text-slate-400 uppercase tracking-[0.25em]">Typeface</span>
                                                <span
                                                    class="w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_#10b981] animate-pulse"></span>
                                            </div>
                                            <h2 id="typ-current-name"
                                                class="text-3xl font-black text-white tracking-tighter leading-none mt-1 group-hover:text-indigo-100 transition">
                                                Inter</h2>
                                        </div>
                                    </div>

                                    <!-- Big Decorative Watermark -->
                                    <div
                                        class="text-6xl font-black text-white/5 font-serif select-none transform group-hover:scale-110 group-hover:rotate-12 transition duration-700 ease-out origin-top-right">
                                        Aa
                                    </div>
                                </div>

                                <!-- Integrated Live Preview (Reusing ID for JS compatibility) -->
                                <div
                                    class="bg-white/5 rounded-2xl p-3 border border-white/5 backdrop-blur-md hover:bg-white/10 transition group/edit cursor-text">
                                    <input id="typ-live-test" type="text"
                                        value="The quick brown fox jumps over the lazy dog."
                                        class="w-full bg-transparent border-none text-lg text-slate-200 font-normal leading-tight placeholder-slate-600 focus:outline-none focus:ring-0 truncate"
                                        style="font-family: 'Inter', sans-serif;" spellcheck="false">
                                </div>
                            </div>
                        </div>

                        <!-- Favorites Row -->
                        <div class="relative mb-6">
                            <div class="flex justify-between items-end mb-3 px-1">
                                <span class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em]">Favorites
                                    &
                                    Library</span>
                                <button onclick="openFontLibrary()"
                                    class="text-[10px] text-indigo-400 hover:text-indigo-300 font-black uppercase tracking-widest transition-all hover:gap-2 flex items-center gap-1">
                                    VIEW 200+ <i data-lucide="arrow-right" class="w-3 h-3"></i>
                                </button>
                            </div>
                            <!-- Horizontal Scroll Container -->
                            <div id="typography-favorites-container"
                                class="flex gap-3 overflow-x-auto pb-4 scrollbar-hide snap-x">
                                <!-- JS Injected Content -->
                                <div class="w-20 h-20 rounded-xl bg-white/5 animate-pulse"></div>
                                <div class="w-20 h-20 rounded-xl bg-white/5 animate-pulse"></div>
                                <div class="w-20 h-20 rounded-xl bg-white/5 animate-pulse"></div>
                            </div>
                        </div>

                        <!-- NEW: Live Preview Text Area -->

                        <!-- REDESIGNED: Visual Type Showcase -->
                        <!-- Advanced Controls -->
                        <div class="mt-auto pt-6 border-t border-white/5 grid grid-cols-2 gap-6">
                            <!-- Scale -->
                            <div>
                                <div class="flex justify-between items-center mb-3">
                                    <span
                                        class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Scale</span>
                                    <span id="lbl-font-scale"
                                        class="text-[10px] text-indigo-400 font-mono font-bold">100%</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <input type="range" min="80" max="120" step="5" value="100" id="setting-font-scale"
                                        class="flex-1 h-1.5 bg-white/10 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                                        oninput="setFontScale(this.value)">
                                </div>
                            </div>

                            <!-- Spacing -->
                            <div>
                                <div class="flex justify-between items-center mb-3">
                                    <span
                                        class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Kerning</span>
                                </div>
                                <div class="flex gap-1.5">
                                    <button onclick="setFontSpacing('-1')" data-spacing-btn data-value="-1"
                                        class="flex-1 h-8 rounded-xl bg-white/5 hover:bg-white/10 text-[10px] text-slate-400 border border-white/10 flex items-center justify-center transition"
                                        title="Tight">
                                        <i data-lucide="align-justify" class="w-3.5 h-3.5 rotate-90"></i>
                                    </button>
                                    <button onclick="setFontSpacing('0')" data-spacing-btn data-value="0"
                                        class="flex-1 h-8 rounded-xl bg-indigo-500 text-white text-[10px] border-transparent flex items-center justify-center transition shadow-lg shadow-indigo-500/20"
                                        title="Normal">
                                        <i data-lucide="minus" class="w-3.5 h-3.5"></i>
                                    </button>
                                    <button onclick="setFontSpacing('1')" data-spacing-btn data-value="1"
                                        class="flex-1 h-8 rounded-xl bg-white/5 hover:bg-white/10 text-[10px] text-slate-400 border border-white/10 flex items-center justify-center transition"
                                        title="Wide">
                                        <i data-lucide="align-horizontal-distribute-center" class="w-3.5 h-3.5"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Absolute Background Deco -->
                        <div
                            class="absolute -bottom-10 -right-10 w-32 h-32 bg-indigo-500/5 rounded-full blur-3xl pointer-events-none">
                        </div>
                    </div>


                </div>

                <!-- COLUMN 2: Wallpapers -->
                <div class="xl:col-span-4">
                    <div
                        class="bg-[#1a1d2e] rounded-3xl p-6 border border-white/[0.08] relative overflow-hidden flex flex-col gap-6 shadow-2xl">
                        <!-- Header -->
                        <div class="flex items-center gap-4 border-b border-white/5 pb-4">
                            <div
                                class="bg-blue-500/10 p-3 rounded-2xl text-blue-400 border border-blue-500/20 shadow-[0_0_15px_rgba(59,130,246,0.2)]">
                                <i data-lucide="image" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h3 class="font-black text-white text-xl tracking-tight">Wallpapers
                                </h3>
                                <p class="text-[11px] font-bold text-slate-500 uppercase tracking-widest mt-0.5">
                                    Customize
                                    Experience</p>
                            </div>
                            <div class="ml-auto">
                                <span
                                    class="bg-white/5 border border-white/10 px-2 py-1 rounded-lg text-[10px] text-slate-400 font-bold uppercase tracking-wider">v2.0</span>
                            </div>
                        </div>

                        <div class="flex-1 overflow-y-auto custom-scrollbar pr-2 space-y-8">

                            <!-- Section 1: Studio (Upload + Basics) -->
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <h4
                                        class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] flex items-center gap-2">
                                        <i data-lucide="upload-cloud" class="w-3 h-3"></i> Studio
                                    </h4>
                                    <span
                                        class="text-[9px] font-bold text-slate-600 bg-white/5 px-2 py-1 rounded-md border border-white/5">Custom</span>
                                </div>

                                <!-- Upload Area -->
                                <label
                                    class="block w-full h-24 rounded-2xl border border-dashed border-slate-700 bg-slate-800/20 hover:bg-slate-800/40 hover:border-blue-500/50 transition-all duration-300 cursor-pointer group relative overflow-hidden">
                                    <input type="file" class="hidden" accept="image/*" onchange="uploadWallpaper(this)">
                                    <div
                                        class="absolute inset-0 bg-blue-500/5 opacity-0 group-hover:opacity-100 transition-opacity">
                                    </div>
                                    <div class="flex flex-col items-center justify-center h-full relative z-10 gap-2">
                                        <div
                                            class="w-8 h-8 rounded-full bg-blue-500/10 flex items-center justify-center text-blue-400 group-hover:scale-110 transition shadow-[0_0_15px_rgba(59,130,246,0.15)]">
                                            <i data-lucide="plus" class="w-4 h-4"></i>
                                        </div>
                                        <span
                                            class="text-[10px] font-black text-slate-400 group-hover:text-blue-200 uppercase tracking-widest transition">Upload
                                            Image</span>
                                    </div>
                                </label>

                                <!-- Basics Row -->
                                <div class="grid grid-cols-2 gap-3">
                                    <button onclick="setWallpaper('solid', '#0B0D14', this)"
                                        class="h-12 rounded-xl bg-[#0B0D14] border border-white/10 hover:border-white/30 transition flex items-center justify-center gap-3 group relative overflow-hidden">
                                        <div class="w-2 h-2 rounded-full bg-white/20"></div>
                                        <span
                                            class="text-[10px] font-bold text-slate-500 group-hover:text-white uppercase tracking-wider">Solid
                                            Dark</span>
                                    </button>
                                    <button onclick="setWallpaper('solid', '#1e293b', this)"
                                        class="h-12 rounded-xl bg-[#1e293b] border border-white/10 hover:border-white/30 transition flex items-center justify-center gap-3 group relative overflow-hidden">
                                        <div class="w-2 h-2 rounded-full bg-white/20"></div>
                                        <span
                                            class="text-[10px] font-bold text-slate-400 group-hover:text-white uppercase tracking-wider">Slate</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Section 2: Cinematic Grid -->
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <h4
                                        class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] flex items-center gap-2">
                                        <i data-lucide="clapperboard" class="w-3 h-3"></i> Cinematic
                                    </h4>
                                    <span
                                        class="text-[9px] font-bold text-slate-600 bg-white/5 px-2 py-1 rounded-md border border-white/5">18
                                        Presets</span>
                                </div>

                                <div class="grid grid-cols-2 gap-3">
                                    <!-- Preset 1: Fluid Noir -->
                                    <button
                                        onclick="setWallpaper('image', 'https://images.unsplash.com/photo-1620641788421-7a1c342ea42e?q=80&w=1200', this)"
                                        class="aspect-[16/9] rounded-xl bg-cover bg-center relative overflow-hidden group hover:border-blue-500/50 border border-white/10 shadow-lg transition-all hover:scale-[1.02] hover:shadow-blue-900/20"
                                        style="background-image: url('https://images.unsplash.com/photo-1620641788421-7a1c342ea42e?q=80&w=400&fit=crop');">
                                        <div
                                            class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition duration-500">
                                        </div>
                                        <div
                                            class="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black/90 to-transparent">
                                            <span
                                                class="text-[9px] font-bold text-white uppercase tracking-wider flex items-center gap-1">
                                                <span class="w-1 h-1 rounded-full bg-blue-500"></span>
                                                Fluid Noir
                                            </span>
                                        </div>
                                    </button>

                                    <!-- Preset 2: Tokyo Nights -->
                                    <button
                                        onclick="setWallpaper('image', 'https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?q=80&w=1200', this)"
                                        class="aspect-[16/9] rounded-xl bg-cover bg-center relative overflow-hidden group hover:border-pink-500/50 border border-white/10 shadow-lg transition-all hover:scale-[1.02] hover:shadow-pink-900/20"
                                        style="background-image: url('https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?q=80&w=400&fit=crop');">
                                        <div
                                            class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition duration-500">
                                        </div>
                                        <div
                                            class="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black/90 to-transparent">
                                            <span
                                                class="text-[9px] font-bold text-white uppercase tracking-wider flex items-center gap-1">
                                                <span class="w-1 h-1 rounded-full bg-pink-500"></span>
                                                Tokyo
                                            </span>
                                        </div>
                                    </button>

                                    <!-- Preset 3: Deep Space -->
                                    <button
                                        onclick="setWallpaper('image', 'https://images.unsplash.com/photo-1462331940025-496dfbfc7564?q=80&w=1200', this)"
                                        class="aspect-[16/9] rounded-xl bg-cover bg-center relative overflow-hidden group hover:border-indigo-500/50 border border-white/10 shadow-lg transition-all hover:scale-[1.02] hover:shadow-indigo-900/20"
                                        style="background-image: url('https://images.unsplash.com/photo-1462331940025-496dfbfc7564?q=80&w=400&fit=crop');">
                                        <div
                                            class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition duration-500">
                                        </div>
                                        <div
                                            class="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black/90 to-transparent">
                                            <span
                                                class="text-[9px] font-bold text-white uppercase tracking-wider flex items-center gap-1">
                                                <span class="w-1 h-1 rounded-full bg-indigo-500"></span>
                                                Deep Space
                                            </span>
                                        </div>
                                    </button>

                                    <!-- Preset 4: Nordic -->
                                    <button
                                        onclick="setWallpaper('image', 'https://images.unsplash.com/photo-1476610182048-b716b8518aae?q=80&w=1200', this)"
                                        class="aspect-[16/9] rounded-xl bg-cover bg-center relative overflow-hidden group hover:border-emerald-500/50 border border-white/10 shadow-lg transition-all hover:scale-[1.02] hover:shadow-emerald-900/20"
                                        style="background-image: url('https://images.unsplash.com/photo-1476610182048-b716b8518aae?q=80&w=400&fit=crop');">
                                        <div
                                            class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition duration-500">
                                        </div>
                                        <div
                                            class="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black/90 to-transparent">
                                            <span
                                                class="text-[9px] font-bold text-white uppercase tracking-wider flex items-center gap-1">
                                                <span class="w-1 h-1 rounded-full bg-emerald-500"></span>
                                                Nordic
                                            </span>
                                        </div>
                                    </button>

                                    <!-- Preset 5: Cyber Mesh -->
                                    <button
                                        onclick="setWallpaper('image', 'https://images.unsplash.com/photo-1550751827-4bd374c3f58b?q=80&w=1200', this)"
                                        class="aspect-[16/9] rounded-xl bg-cover bg-center relative overflow-hidden group hover:border-cyan-500/50 border border-white/10 shadow-lg transition-all hover:scale-[1.02] hover:shadow-cyan-900/20"
                                        style="background-image: url('https://images.unsplash.com/photo-1550751827-4bd374c3f58b?q=80&w=400&fit=crop');">
                                        <div
                                            class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition duration-500">
                                        </div>
                                        <div
                                            class="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black/90 to-transparent">
                                            <span
                                                class="text-[9px] font-bold text-white uppercase tracking-wider flex items-center gap-1">
                                                <span class="w-1 h-1 rounded-full bg-cyan-500"></span>
                                                Cyber Mesh
                                            </span>
                                        </div>
                                    </button>

                                    <!-- Preset 6: Golden -->
                                    <button
                                        onclick="setWallpaper('image', 'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=1200', this)"
                                        class="aspect-[16/9] rounded-xl bg-cover bg-center relative overflow-hidden group hover:border-amber-500/50 border border-white/10 shadow-lg transition-all hover:scale-[1.02] hover:shadow-amber-900/20"
                                        style="background-image: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=400&fit=crop');">
                                        <div
                                            class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition duration-500">
                                        </div>
                                        <div
                                            class="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black/90 to-transparent">
                                            <span
                                                class="text-[9px] font-bold text-white uppercase tracking-wider flex items-center gap-1">
                                                <span class="w-1 h-1 rounded-full bg-amber-500"></span>
                                                Golden
                                            </span>
                                        </div>
                                    </button>

                                    <!-- Preset 7: Urban -->
                                    <button
                                        onclick="setWallpaper('image', 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?q=80&w=1200', this)"
                                        class="aspect-[16/9] rounded-xl bg-cover bg-center relative overflow-hidden group hover:border-slate-500/50 border border-white/10 shadow-lg transition-all hover:scale-[1.02] hover:shadow-slate-900/20"
                                        style="background-image: url('https://images.unsplash.com/photo-1449824913935-59a10b8d2000?q=80&w=400&fit=crop');">
                                        <div
                                            class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition duration-500">
                                        </div>
                                        <div
                                            class="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black/90 to-transparent">
                                            <span
                                                class="text-[9px] font-bold text-white uppercase tracking-wider flex items-center gap-1">
                                                <span class="w-1 h-1 rounded-full bg-slate-500"></span>
                                                Urban
                                            </span>
                                        </div>
                                    </button>

                                    <!-- Preset 8: Midnight -->
                                    <button
                                        onclick="setWallpaper('image', 'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=3840', this)"
                                        class="aspect-[16/9] rounded-xl bg-cover bg-center relative overflow-hidden group hover:border-indigo-500/50 border border-white/10 shadow-lg transition-all hover:scale-[1.02] hover:shadow-indigo-900/20"
                                        style="background-image: url('https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=400&fit=crop');">
                                        <div
                                            class="absolute inset-0 bg-black/40 group-hover:bg-transparent transition duration-500">
                                        </div>
                                        <div
                                            class="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black/90 to-transparent">
                                            <span
                                                class="text-[9px] font-bold text-white uppercase tracking-wider flex items-center gap-1">
                                                <span class="w-1 h-1 rounded-full bg-indigo-500"></span>
                                                Midnight
                                            </span>
                                        </div>
                                    </button>

                                    <!-- Preset 9: Crimson -->
                                    <button
                                        onclick="setWallpaper('image', 'https://images.unsplash.com/photo-1541701494587-cb58502866ab?q=80&w=3840', this)"
                                        class="aspect-[16/9] rounded-xl bg-cover bg-center relative overflow-hidden group hover:border-red-500/50 border border-white/10 shadow-lg transition-all hover:scale-[1.02] hover:shadow-red-900/20"
                                        style="background-image: url('https://images.unsplash.com/photo-1541701494587-cb58502866ab?q=80&w=400&fit=crop');">
                                        <div
                                            class="absolute inset-0 bg-black/30 group-hover:bg-transparent transition duration-500">
                                        </div>
                                        <div
                                            class="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black/90 to-transparent">
                                            <span
                                                class="text-[9px] font-bold text-white uppercase tracking-wider flex items-center gap-1">
                                                <span class="w-1 h-1 rounded-full bg-red-500"></span> Crimson
                                            </span>
                                        </div>
                                    </button>

                                    <!-- Preset 10: Alpine -->
                                    <button
                                        onclick="setWallpaper('image', 'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?q=80&w=3840', this)"
                                        class="aspect-[16/9] rounded-xl bg-cover bg-center relative overflow-hidden group hover:border-sky-500/50 border border-white/10 shadow-lg transition-all hover:scale-[1.02] hover:shadow-sky-900/20"
                                        style="background-image: url('https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?q=80&w=400&fit=crop');">
                                        <div
                                            class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition duration-500">
                                        </div>
                                        <div
                                            class="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black/90 to-transparent">
                                            <span
                                                class="text-[9px] font-bold text-white uppercase tracking-wider flex items-center gap-1">
                                                <span class="w-1 h-1 rounded-full bg-sky-500"></span> Alpine
                                            </span>
                                        </div>
                                    </button>

                                    <!-- Preset 11: Neon City -->
                                    <button
                                        onclick="setWallpaper('image', 'https://images.unsplash.com/photo-1514565131-fce0801e5785?q=80&w=3840', this)"
                                        class="aspect-[16/9] rounded-xl bg-cover bg-center relative overflow-hidden group hover:border-pink-500/50 border border-white/10 shadow-lg transition-all hover:scale-[1.02] hover:shadow-pink-900/20"
                                        style="background-image: url('https://images.unsplash.com/photo-1514565131-fce0801e5785?q=80&w=400&fit=crop');">
                                        <div
                                            class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition duration-500">
                                        </div>
                                        <div
                                            class="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black/90 to-transparent">
                                            <span
                                                class="text-[9px] font-bold text-white uppercase tracking-wider flex items-center gap-1">
                                                <span class="w-1 h-1 rounded-full bg-pink-500"></span> Neon City
                                            </span>
                                        </div>
                                    </button>

                                    <!-- Preset 12: Cyberpunk City -->
                                    <button
                                        onclick="setWallpaper('image', 'https://images.unsplash.com/photo-1535905557558-afc4877a26fc?q=80&w=3840', this)"
                                        class="aspect-[16/9] rounded-xl bg-cover bg-center relative overflow-hidden group hover:border-pink-500/50 border border-white/10 shadow-lg transition-all hover:scale-[1.02] hover:shadow-pink-900/20"
                                        style="background-image: url('https://images.unsplash.com/photo-1535905557558-afc4877a26fc?q=80&w=400&fit=crop');">
                                        <div
                                            class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition duration-500">
                                        </div>
                                        <div
                                            class="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black/90 to-transparent">
                                            <span
                                                class="text-[9px] font-bold text-white uppercase tracking-wider flex items-center gap-1">
                                                <span class="w-1 h-1 rounded-full bg-pink-500"></span> Cyberpunk
                                            </span>
                                        </div>
                                    </button>

                                    <!-- Preset 13: Aurora -->
                                    <button
                                        onclick="setWallpaper('image', 'https://images.unsplash.com/photo-1531366936337-7c912a4589a7?q=80&w=3840', this)"
                                        class="aspect-[16/9] rounded-xl bg-cover bg-center relative overflow-hidden group hover:border-green-500/50 border border-white/10 shadow-lg transition-all hover:scale-[1.02] hover:shadow-green-900/20"
                                        style="background-image: url('https://images.unsplash.com/photo-1531366936337-7c912a4589a7?q=80&w=400&fit=crop');">
                                        <div
                                            class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition duration-500">
                                        </div>
                                        <div
                                            class="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black/90 to-transparent">
                                            <span
                                                class="text-[9px] font-bold text-white uppercase tracking-wider flex items-center gap-1">
                                                <span class="w-1 h-1 rounded-full bg-green-500"></span> Aurora
                                            </span>
                                        </div>
                                    </button>

                                    <!-- Preset 14: Zen Garden -->
                                    <button
                                        onclick="setWallpaper('image', 'https://images.unsplash.com/photo-1470770841072-f978cf4d019e?q=80&w=3840', this)"
                                        class="aspect-[16/9] rounded-xl bg-cover bg-center relative overflow-hidden group hover:border-stone-500/50 border border-white/10 shadow-lg transition-all hover:scale-[1.02] hover:shadow-stone-900/20"
                                        style="background-image: url('https://images.unsplash.com/photo-1470770841072-f978cf4d019e?q=80&w=400&fit=crop');">
                                        <div
                                            class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition duration-500">
                                        </div>
                                        <div
                                            class="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black/90 to-transparent">
                                            <span
                                                class="text-[9px] font-bold text-white uppercase tracking-wider flex items-center gap-1">
                                                <span class="w-1 h-1 rounded-full bg-stone-500"></span> Zen
                                            </span>
                                        </div>
                                    </button>

                                    <!-- Preset 15: Sunset -->
                                    <button
                                        onclick="setWallpaper('image', 'https://images.unsplash.com/photo-1495616811223-4d98c6e9c869?q=80&w=3840', this)"
                                        class="aspect-[16/9] rounded-xl bg-cover bg-center relative overflow-hidden group hover:border-orange-500/50 border border-white/10 shadow-lg transition-all hover:scale-[1.02] hover:shadow-orange-900/20"
                                        style="background-image: url('https://images.unsplash.com/photo-1495616811223-4d98c6e9c869?q=80&w=400&fit=crop');">
                                        <div
                                            class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition duration-500">
                                        </div>
                                        <div
                                            class="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black/90 to-transparent">
                                            <span
                                                class="text-[9px] font-bold text-white uppercase tracking-wider flex items-center gap-1">
                                                <span class="w-1 h-1 rounded-full bg-orange-500"></span> Sunset
                                            </span>
                                        </div>
                                    </button>

                                    <!-- Preset 16: Misty Peaks -->
                                    <button
                                        onclick="setWallpaper('image', 'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?q=80&w=3840', this)"
                                        class="aspect-[16/9] rounded-xl bg-cover bg-center relative overflow-hidden group hover:border-sky-400/50 border border-white/10 shadow-lg transition-all hover:scale-[1.02] hover:shadow-sky-900/20"
                                        style="background-image: url('https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?q=80&w=400&fit=crop');">
                                        <div
                                            class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition duration-500">
                                        </div>
                                        <div
                                            class="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black/90 to-transparent">
                                            <span
                                                class="text-[9px] font-bold text-white uppercase tracking-wider flex items-center gap-1">
                                                <span class="w-1 h-1 rounded-full bg-sky-400"></span> Misty
                                                Peaks
                                            </span>
                                        </div>
                                    </button>

                                    <!-- Preset 17: Desert Glow -->
                                    <button
                                        onclick="setWallpaper('image', 'https://images.unsplash.com/photo-1473580044384-7ba9967e16a0?q=80&w=3840', this)"
                                        class="aspect-[16/9] rounded-xl bg-cover bg-center relative overflow-hidden group hover:border-orange-400/50 border border-white/10 shadow-lg transition-all hover:scale-[1.02] hover:shadow-orange-900/20"
                                        style="background-image: url('https://images.unsplash.com/photo-1473580044384-7ba9967e16a0?q=80&w=400&fit=crop');">
                                        <div
                                            class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition duration-500">
                                        </div>
                                        <div
                                            class="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black/90 to-transparent">
                                            <span
                                                class="text-[9px] font-bold text-white uppercase tracking-wider flex items-center gap-1">
                                                <span class="w-1 h-1 rounded-full bg-orange-400"></span> Desert
                                            </span>
                                        </div>
                                    </button>

                                    <!-- Preset 18: Deep Forest -->
                                    <button
                                        onclick="setWallpaper('image', 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=3840', this)"
                                        class="aspect-[16/9] rounded-xl bg-cover bg-center relative overflow-hidden group hover:border-emerald-600/50 border border-white/10 shadow-lg transition-all hover:scale-[1.02] hover:shadow-emerald-900/20"
                                        style="background-image: url('https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=400&fit=crop');">
                                        <div
                                            class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition duration-500">
                                        </div>
                                        <div
                                            class="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black/90 to-transparent">
                                            <span
                                                class="text-[9px] font-bold text-white uppercase tracking-wider flex items-center gap-1">
                                                <span class="w-1 h-1 rounded-full bg-emerald-600"></span> Forest
                                            </span>
                                        </div>
                                    </button>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- COLUMN 3: System Preferences -->
                <div class="xl:col-span-4 space-y-6">
                    <div class="flex items-center gap-3">
                        <div class="bg-indigo-500/10 p-2 rounded-xl text-indigo-400">
                            <i data-lucide="settings-2" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-white text-lg">System Preferences</h3>
                            <p class="text-xs text-slate-500">Configure your personal dashboard
                                experience</p>
                        </div>
                    </div>

                    <!-- Localization -->
                    <div class="bg-dark-800 rounded-3xl p-6 border border-white/5">
                        <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4">
                            Localization
                        </h4>
                        <div class="space-y-4">
                            <div>
                                <label class="text-[9px] font-bold text-slate-500 uppercase mb-1.5 block ml-1">Display
                                    Currency</label>
                                <select id="setting-display-currency" onchange="setCurrencyProfile(this.value)"
                                    class="w-full bg-[#161b22] border border-white/5 rounded-xl px-4 py-3 text-sm text-white focus:ring-1 focus:ring-blue-500/50 outline-none appearance-none font-bold">
                                    <option value="MXN" selected>MXN ($) - Mexican Peso</option>
                                    <option value="USD">USD ($) - US Dollar</option>
                                    <option value="EUR">EUR (€) - Euro</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[9px] font-bold text-slate-500 uppercase mb-1.5 block ml-1">App
                                    Language</label>
                                <select id="setting-app-language" onchange="setLanguageProfile(this.value)"
                                    class="w-full bg-[#161b22] border border-white/5 rounded-xl px-4 py-3 text-sm text-white focus:ring-1 focus:ring-blue-500/50 outline-none appearance-none font-bold">
                                    <option value="es" selected>Español (Latinoamérica)</option>
                                    <option value="en">English (US)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Notifications -->
                    <div class="bg-dark-800 rounded-3xl p-6 border border-white/5">
                        <h4 class="text-[10px] font-bold text-yellow-500 uppercase tracking-widest mb-4">
                            Notifications
                        </h4>
                        <div class="space-y-4">
                            <div
                                class="flex items-center justify-between p-3 rounded-xl bg-[#161b22] border border-white/5 hover:border-white/10 transition">
                                <div class="flex items-center gap-3">
                                    <div class="w-2 h-2 rounded-full bg-red-500"></div>
                                    <div>
                                        <span class="block text-xs font-bold text-white">Budget
                                            Alerts</span>
                                        <span class="text-[9px] text-slate-500">Notify when
                                            approaching limits</span>
                                    </div>
                                </div>
                                <div class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" checked class="sr-only peer">
                                    <div
                                        class="w-10 h-5 bg-slate-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-yellow-500">
                                    </div>
                                </div>
                            </div>
                            <div
                                class="flex items-center justify-between p-3 rounded-xl bg-[#161b22] border border-white/5 hover:border-white/10 transition">
                                <div class="flex items-center gap-3">
                                    <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                                    <div>
                                        <span class="block text-xs font-bold text-white">Smart
                                            Insights</span>
                                        <span class="text-[9px] text-slate-500">Weekly AI financial
                                            tips</span>
                                    </div>
                                </div>
                                <div class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" checked class="sr-only peer">
                                    <div
                                        class="w-10 h-5 bg-slate-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-yellow-500">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Privacy Zone -->
                    <div class="bg-dark-800 rounded-[2.5rem] p-8 border border-white/5 relative overflow-hidden group">
                        <div
                            class="absolute top-0 right-0 p-6 opacity-[0.03] pointer-events-none group-hover:opacity-[0.07] transition-all duration-700">
                            <i data-lucide="eye-off" class="w-24 h-24 text-purple-500"></i>
                        </div>

                        <h4
                            class="text-[11px] font-bold text-slate-500 uppercase tracking-[0.2em] mb-6 flex items-center gap-2">
                            Privacy Zone
                        </h4>

                        <div
                            class="relative p-5 rounded-[1.5rem] border border-white/5 bg-[#161b22]/50 hover:bg-[#1c222e]/80 transition-all duration-500 flex items-center justify-between group/row">
                            <div class="flex items-center gap-4">
                                <div class="relative">
                                    <div
                                        class="w-2 h-2 rounded-full bg-purple-500 shadow-[0_0_10px_rgba(168,85,247,0.8)]">
                                    </div>
                                    <div
                                        class="absolute inset-0 w-2 h-2 rounded-full bg-purple-400 animate-ping opacity-40">
                                    </div>
                                </div>
                                <div>
                                    <span
                                        class="block text-sm font-black text-white group-hover/row:text-purple-200 transition-colors">Mask
                                        Sensitive Data</span>
                                    <span class="text-[10px] text-slate-500 font-medium">Blur balances in
                                        dashboard</span>
                                </div>
                            </div>

                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="chk-privacy-mask" onchange="togglePrivacyMask(this.checked)"
                                    class="sr-only peer">
                                <div
                                    class="w-11 h-6 bg-slate-800 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600 shadow-lg">
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="bg-dark-800 rounded-3xl p-6 border border-white/5 relative overflow-hidden group">
                        <!-- Background Decor -->
                        <div
                            class="absolute top-0 right-0 p-32 bg-slate-500/5 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none group-hover:bg-slate-500/10 transition-all duration-700">
                        </div>

                        <h4
                            class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-6 relative z-10 flex items-center gap-2">
                            <i data-lucide="database" class="w-3 h-3 text-slate-500"></i> Data Management
                        </h4>

                        <div class="grid grid-cols-1 gap-4 relative z-10">
                            <!-- PDF Report (Primary) -->
                            <button onclick="generateFinancialReportPDF()"
                                class="w-full py-4 bg-gradient-to-r from-[#161b22] to-[#1c222e] hover:from-emerald-900/40 hover:to-emerald-900/40 border border-white/5 hover:border-emerald-500/30 rounded-2xl flex items-center justify-center gap-4 group/btn transition-all duration-300 shadow-lg shadow-black/20">
                                <div
                                    class="p-2.5 rounded-xl bg-emerald-500/10 text-emerald-400 group-hover/btn:scale-110 transition-transform border border-emerald-500/10">
                                    <i data-lucide="file-text" class="w-5 h-5"></i>
                                </div>
                                <div class="text-left">
                                    <span
                                        class="block text-xs font-bold text-slate-200 group-hover/btn:text-white tracking-wide">Generar
                                        Reporte PDF</span>
                                    <span
                                        class="block text-[9px] text-slate-500 font-medium group-hover/btn:text-emerald-400/70 transition-colors">Resumen
                                        financiero completo</span>
                                </div>
                            </button>

                            <!-- Data Management Grid -->
                            <div class="grid grid-cols-2 gap-4">
                                <!-- Download -->
                                <button onclick="downloadBackup()"
                                    class="py-4 bg-[#161b22] hover:bg-blue-600/10 border border-white/5 hover:border-blue-500/30 rounded-xl flex flex-col items-center justify-center gap-2 group/btn transition-all duration-300">
                                    <i data-lucide="download-cloud"
                                        class="w-5 h-5 text-slate-400 group-hover/btn:text-blue-400 transition-colors"></i>
                                    <span
                                        class="text-[9px] font-bold text-slate-400 group-hover/btn:text-blue-300 uppercase tracking-wider">Descargar
                                        JSON</span>
                                </button>
                                <!-- Upload -->
                                <button onclick="triggerBackupLoad()"
                                    class="py-4 bg-[#161b22] hover:bg-purple-600/10 border border-white/5 hover:border-purple-500/30 rounded-xl flex flex-col items-center justify-center gap-2 group/btn transition-all duration-300">
                                    <i data-lucide="upload-cloud"
                                        class="w-5 h-5 text-slate-400 group-hover/btn:text-purple-400 transition-colors"></i>
                                    <span
                                        class="text-[9px] font-bold text-slate-400 group-hover/btn:text-purple-300 uppercase tracking-wider">Cargar
                                        Respaldo</span>
                                </button>
                                <!-- Simulation -->
                                <!-- Simulation -->
                                <button onclick="generateRandomData()"
                                    class="py-4 bg-[#161b22] hover:bg-indigo-600/10 border border-white/5 hover:border-indigo-500/30 rounded-xl flex flex-col items-center justify-center gap-2 group/btn transition-all duration-300">
                                    <i data-lucide="play"
                                        class="w-5 h-5 text-indigo-400 group-hover/btn:text-indigo-300"></i>
                                    <span
                                        class="text-[9px] font-bold text-indigo-400/80 group-hover/btn:text-indigo-300 uppercase tracking-wider">Simular
                                        Demo</span>
                                </button>
                                <!-- Reset -->
                                <button onclick="clearAllData()"
                                    class="py-4 bg-[#161b22] hover:bg-red-600/10 border border-white/5 hover:border-red-500/30 rounded-xl flex flex-col items-center justify-center gap-2 group/btn transition-all duration-300">
                                    <i data-lucide="trash-2"
                                        class="w-5 h-5 text-red-400 group-hover/btn:text-red-300"></i>
                                    <span
                                        class="text-[9px] font-bold text-red-400/80 group-hover/btn:text-red-300 uppercase tracking-wider">Reset</span>
                                </button>
                            </div>
                        </div>

                        <!-- Hidden Input for File Upload -->
                        <input type="file" id="backup-upload" accept=".json" class="hidden"
                            onchange="handleBackupFile(this)">
                    </div>

                    <!-- Security & Access (Premium Redesign) -->


                    <!-- AI Persona -->
                    <div class="bg-dark-800 rounded-3xl p-6 border border-white/5 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-5 pointer-events-none">
                            <i data-lucide="bot"
                                class="w-24 h-24 text-indigo-500 -rotate-12 translate-x-4 -translate-y-4"></i>
                        </div>
                        <h4 class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-4">
                            AI Financial Persona
                        </h4>
                        <div class="space-y-3">
                            <!-- Balanced Advisor -->
                            <div id="persona-advisor" onclick="setAIPersona('advisor')"
                                class="persona-card active relative p-4 rounded-2xl border bg-indigo-500/10 border-indigo-500 shadow-[0_0_20px_rgba(99,102,241,0.15)] ring-1 ring-indigo-500/50 cursor-pointer group overflow-hidden transition-all duration-300">
                                <div class="flex items-start gap-4 relative z-10">
                                    <div
                                        class="w-10 h-10 rounded-full bg-indigo-500/10 flex items-center justify-center text-indigo-400 shadow-[0_0_15px_rgba(99,102,241,0.2)]">
                                        <i data-lucide="scale" class="w-5 h-5"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="text-sm font-bold text-white transition">Balanced
                                                Advisor</span>
                                        </div>
                                        <p class="text-[10px] text-slate-400 leading-relaxed max-w-[90%]">
                                            Balanced
                                            tips
                                            on spending & saving. Keeps you steady.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Strict Coach -->
                            <div id="persona-coach" onclick="setAIPersona('coach')"
                                class="persona-card relative p-4 rounded-2xl border border-white/5 bg-[#161b22] hover:bg-[#1c222e] hover:border-white/10 cursor-pointer group overflow-hidden transition-all duration-300">
                                <div class="flex items-start gap-4 relative z-10">
                                    <div
                                        class="w-10 h-10 rounded-full bg-orange-500/10 flex items-center justify-center text-orange-400 group-hover:scale-110 transition">
                                        <i data-lucide="shield-alert" class="w-5 h-5"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-center mb-1">
                                            <span
                                                class="text-sm font-bold text-white group-hover:text-orange-200 transition">Strict
                                                Coach</span>
                                        </div>
                                        <p class="text-[10px] text-slate-500 leading-relaxed max-w-[90%]">
                                            Aggressive
                                            debt reduction. Zero tolerance for waste.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Growth Strategist -->
                            <div id="persona-strategist" onclick="setAIPersona('strategist')"
                                class="persona-card relative p-4 rounded-2xl border border-white/5 bg-[#161b22] hover:bg-[#1c222e] hover:border-white/10 cursor-pointer group overflow-hidden transition-all duration-300">
                                <div class="flex items-start gap-4 relative z-10">
                                    <div
                                        class="w-10 h-10 rounded-full bg-emerald-500/10 flex items-center justify-center text-emerald-400 group-hover:scale-110 transition">
                                        <i data-lucide="trending-up" class="w-5 h-5"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-center mb-1">
                                            <span
                                                class="text-sm font-bold text-white group-hover:text-emerald-200 transition">Growth
                                                Strategist</span>
                                        </div>
                                        <p class="text-[10px] text-slate-500 leading-relaxed max-w-[90%]">Focus
                                            on
                                            investing & scaling income streams.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>




                </div>
            </div>
        </div>


    </main>

    <!-- FAB for Quick Add -->
    <button onclick="openTransactionModal()"
        class="fixed bottom-8 right-8 bg-primary hover:bg-indigo-500 text-white p-4 rounded-full shadow-2xl shadow-indigo-500/50 transition transform hover:scale-110 z-50 flex items-center justify-center group">
        <i data-lucide="plus" class="w-8 h-8 group-hover:rotate-90 transition duration-300"></i>
    </button>

    <!-- Transaction Modal -->
    <!-- Transaction Modal -->
    <div id="transactionModal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-dark-800 border border-white/10 p-8 rounded-3xl w-full max-w-md transform scale-95 transition-transform duration-300 relative shadow-2xl"
            id="modalContent">
            <button onclick="closeTransactionModal()"
                class="absolute right-4 top-4 text-slate-400 hover:text-white transition">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>

            <h3 class="text-2xl font-bold text-white mb-6 flex items-center gap-2" id="modalTitle">
                <span class="bg-primary/20 text-primary p-2 rounded-lg"><i data-lucide="wallet-2"
                        class="w-6 h-6"></i></span>
                Nuevo Movimiento
            </h3>

            <form onsubmit="event.preventDefault(); addTransaction()" class="space-y-5" id="walletForm">
                <!-- Type Toggle -->
                <div class="grid grid-cols-2 gap-4 p-1 bg-dark-900 rounded-2xl">
                    <button type="button" onclick="setTransType('expense')" id="btn-expense"
                        class="p-3 rounded-xl bg-red-500/20 text-red-400 border border-red-500/50 font-medium text-center transition flex items-center justify-center gap-2">
                        <i data-lucide="arrow-down-circle" class="w-4 h-4"></i> Gasto
                    </button>
                    <button type="button" onclick="setTransType('income')" id="btn-income"
                        class="p-3 rounded-xl bg-transparent text-slate-400 border border-transparent font-medium text-center transition flex items-center justify-center gap-2 hover:text-white">
                        <i data-lucide="arrow-up-circle" class="w-4 h-4"></i> Ingreso
                    </button>
                </div>

                <!-- Amount -->
                <div>
                    <label class="block text-slate-400 text-xs uppercase mb-2 font-bold tracking-wider">Monto</label>
                    <div class="relative">
                        <span class="absolute left-4 top-4 text-slate-500 font-bold">$</span>
                        <input type="number" id="inp-amount" required step="0.01" placeholder="0.00"
                            class="w-full bg-dark-700 text-white text-2xl font-bold rounded-xl py-3 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-primary transition border border-transparent focus:border-primary/50">
                    </div>
                </div>

                <!-- Date & Time -->
                <div>
                    <label class="block text-slate-400 text-xs uppercase mb-2 font-bold tracking-wider">Fecha</label>
                    <input type="date" id="inp-date" required
                        class="w-full bg-dark-700 text-white rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-primary transition border border-transparent focus:border-primary/50 appearance-none">
                </div>

                <!-- Description -->
                <div>
                    <label
                        class="block text-slate-400 text-xs uppercase mb-2 font-bold tracking-wider">Descripción</label>
                    <input type="text" id="inp-desc" required placeholder="Ej: Supermercado"
                        class="w-full bg-dark-700 text-white rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-primary transition border border-transparent focus:border-primary/50">
                </div>

                <div>
                    <label
                        class="block text-slate-400 text-xs uppercase mb-2 font-bold tracking-wider">Categoría</label>
                    <div class="relative">
                        <select id="inp-cat"
                            class="w-full bg-dark-700 text-white rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-primary appearance-none cursor-pointer transition border border-transparent focus:border-primary/50">
                            <option value="Food">Food</option>
                            <option value="Groceries">Groceries</option>
                            <option value="Housing">Housing</option>
                            <option value="Transport">Transport</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Shopping">Shopping</option>
                            <option value="Health">Health</option>
                            <option value="Education">Education</option>
                            <option value="Travel">Travel</option>
                            <option value="Beer">Beer</option>
                            <option value="Junk Food">Junk Food</option>
                            <option value="Weed">Weed</option>
                            <option value="Love">Love</option>
                            <option value="Gas">Gas</option>
                            <option value="Others">Others</option>
                        </select>
                        <i data-lucide="chevron-down"
                            class="absolute right-4 top-3.5 text-slate-400 pointer-events-none w-5 h-5"></i>
                    </div>
                </div>

                <!-- Budget Focus (Only for Expense) -->
                <div id="modal-focus-container" class="transition-all duration-300">
                    <label class="block text-slate-400 text-xs uppercase mb-2 font-bold tracking-wider">Enfoque de
                        Presupuesto</label>
                    <input type="hidden" id="inp-focus">
                    <div class="grid grid-cols-5 gap-2">
                        <div onclick="selectModalFocus('Needs')" id="m-focus-Needs"
                            class="m-focus-item cursor-pointer text-[10px] font-bold uppercase p-2 rounded-xl border border-white/5 bg-dark-700 text-slate-400 hover:text-white hover:bg-dark-600 text-center transition">
                            Needs</div>
                        <div onclick="selectModalFocus('Wants')" id="m-focus-Wants"
                            class="m-focus-item cursor-pointer text-[10px] font-bold uppercase p-2 rounded-xl border border-white/5 bg-dark-700 text-slate-400 hover:text-white hover:bg-dark-600 text-center transition">
                            Wants</div>
                        <div onclick="selectModalFocus('Saving')" id="m-focus-Saving"
                            class="m-focus-item cursor-pointer text-[10px] font-bold uppercase p-2 rounded-xl border border-white/5 bg-dark-700 text-slate-400 hover:text-white hover:bg-dark-600 text-center transition">
                            Saving</div>
                        <div onclick="selectModalFocus('Investment')" id="m-focus-Investment"
                            class="m-focus-item cursor-pointer text-[10px] font-bold uppercase p-2 rounded-xl border border-white/5 bg-dark-700 text-slate-400 hover:text-white hover:bg-dark-600 text-center transition">
                            Invest</div>
                        <div onclick="selectModalFocus('Waste')" id="m-focus-Waste"
                            class="m-focus-item cursor-pointer text-[10px] font-bold uppercase p-2 rounded-xl border border-white/5 bg-dark-700 text-slate-400 hover:text-white hover:bg-dark-600 text-center transition">
                            Waste</div>
                    </div>
                </div>

                <div class="pt-2 flex gap-3">
                    <button type="button" onclick="closeTransactionModal()"
                        class="flex-1 bg-dark-700 text-white py-3.5 rounded-xl font-medium hover:bg-dark-600 transition">Cancelar</button>
                    <button type="submit" id="modalSubmitBtn"
                        class="flex-1 bg-gradient-to-r from-primary to-indigo-600 text-white py-3.5 rounded-xl font-bold hover:shadow-lg hover:shadow-primary/40 transition transform active:scale-95">Guardar</button>
                    <button type="button" id="modalDeleteBtn" onclick="deleteTransaction()"
                        class="hidden bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white p-3.5 rounded-xl transition"><i
                            data-lucide="trash-2" class="w-6 h-6"></i></button>
                </div>
            </form>
        </div>
    </div>

    <!-- Category Manager Modal -->
    <div id="catManagerModal" class="fixed inset-0 z-[60] hidden transition-opacity duration-300 opacity-0">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeCategoryManager()"></div>
        <div id="catManagerContent"
            class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-dark-800 rounded-3xl p-6 border border-white/10 shadow-2xl transition-transform duration-300 scale-95">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white flex items-center gap-2"><i data-lucide="settings-2"
                        class="w-5 h-5 text-primary"></i> Gestionar Categorías</h3>
                <button onclick="closeCategoryManager()" class="p-2 hover:bg-white/10 rounded-full transition"><i
                        data-lucide="x" class="w-5 h-5 text-slate-400"></i></button>
            </div>

            <!-- Add New -->
            <div class="bg-dark-900/50 p-4 rounded-2xl mb-6 border border-white/5">
                <h4 class="text-xs uppercase font-bold text-slate-500 mb-3 tracking-wider">Crear Nueva</h4>
                <div class="flex gap-2 mb-3">
                    <input type="text" id="newCatName" placeholder="Nombre (ej: Mascotas)"
                        class="flex-1 bg-dark-800 border-none rounded-xl text-white text-sm px-4 py-2 focus:ring-1 focus:ring-primary">
                </div>
                <div class="flex gap-2 mb-3 overflow-x-auto pb-2" id="newCatIconList">
                    <!-- Icons populated by JS -->
                </div>
                <input type="hidden" id="newCatIcon" value="circle">
                <button onclick="addCustomCategory()"
                    class="w-full bg-primary/20 hover:bg-primary/30 text-primary font-bold py-2 rounded-xl transition text-sm border border-primary/20">Agregar
                    Categoría</button>
            </div>

            <!-- List -->
            <div class="max-h-60 overflow-y-auto space-y-2 pr-1" id="catManagerList">
                <!-- Items injected -->
            </div>
        </div>
    </div>

    <!-- Category Details Modal -->
    <div id="categoryDetailsModal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-dark-800 border border-white/10 p-8 rounded-3xl w-full max-w-lg transform scale-95 transition-transform duration-300 relative shadow-2xl h-[80vh] flex flex-col"
            id="catDetailsContent">
            <button onclick="closeCategoryDetails()"
                class="absolute right-4 top-4 text-slate-400 hover:text-white transition">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>



            <div class="flex items-center gap-4 mb-6">
                <div id="catDetailsIcon"
                    class="w-16 h-16 rounded-2xl bg-gradient-to-br from-primary/20 to-primary/5 text-primary flex items-center justify-center shadow-lg shadow-primary/10 border border-primary/20">
                    <!-- Icon -->
                </div>
                <div>
                    <h3 class="text-3xl font-bold text-white tracking-tight" id="catDetailsTitle">Category</h3>
                    <p class="text-slate-400 font-medium">Historial de gastos</p>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto space-y-3 pr-2" id="catDetailsList">
                <!-- Transactions List -->
            </div>

            <div class="pt-4 border-t border-white/5 mt-4">
                <div class="flex justify-between items-center text-xs text-slate-500 font-medium">
                    <span>* Toca un gasto para editarlo</span>
                    <span id="catDetailsTotal" class="text-white font-bold">Total: $0.00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- TRANSACTION MODAL (New & Edit) -->
    <div id="transaction-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-md z-[100] hidden flex items-center justify-center opacity-0 transition-all duration-300">
        <div class="bg-[#0f1115] border border-white/10 p-8 rounded-3xl w-full max-w-md transform scale-95 transition-all duration-300 shadow-2xl relative"
            id="txn-modal-content">
            <button onclick="closeTransactionModal()"
                class="absolute right-6 top-6 text-slate-400 hover:text-white transition">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>

            <h3 id="txn-modal-title" class="text-2xl font-black text-white mb-6 flex items-center gap-3">
                <span class="bg-indigo-500/20 text-indigo-400 p-2.5 rounded-2xl border border-indigo-500/30">
                    <i data-lucide="pencil-line" class="w-5 h-5"></i>
                </span>
                Editar Transacción
            </h3>

            <input type="hidden" id="txn-modal-id">

            <div class="space-y-6">
                <!-- Amount -->
                <div class="group/field">
                    <label
                        class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 px-1">Monto</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-emerald-400 font-bold">$</span>
                        <input type="number" id="txn-modal-amount" placeholder="0.00" step="0.01"
                            class="w-full bg-[#161b22] border border-white/5 rounded-2xl py-4 pl-10 pr-4 text-white font-mono text-xl focus:border-indigo-500/50 outline-none transition-all focus:shadow-[0_0_20px_rgba(99,102,241,0.1)]">
                    </div>
                </div>

                <!-- Description -->
                <div class="group/field">
                    <label
                        class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 px-1">Descripción</label>
                    <div class="relative">
                        <input type="text" id="txn-modal-name" placeholder="Ej: Cena con amigos"
                            class="w-full bg-[#161b22] border border-white/5 rounded-2xl py-4 px-5 text-white font-medium focus:border-indigo-500/50 outline-none transition-all">
                        <i data-lucide="tag"
                            class="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-600 transition-colors group-focus-within/field:text-indigo-400"></i>
                    </div>
                </div>

                <!-- Category & Type Row -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label
                            class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 px-1">Categoría</label>
                        <div class="relative group/select">
                            <select id="txn-modal-category"
                                class="w-full bg-[#161b22] border border-white/5 rounded-2xl py-4 px-5 text-white text-sm appearance-none focus:border-indigo-500/50 outline-none transition-all cursor-pointer">
                                <!-- Populated by JS -->
                            </select>
                            <i data-lucide="grid"
                                class="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-600 pointer-events-none group-focus-within/select:text-indigo-400 transition-all"></i>
                        </div>
                    </div>
                    <div>
                        <label
                            class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 px-1">Tipo</label>
                        <div class="relative group/select">
                            <select id="txn-modal-type"
                                class="w-full bg-[#161b22] border border-white/5 rounded-2xl py-4 px-5 text-white text-sm appearance-none focus:border-indigo-500/50 outline-none transition-all cursor-pointer">
                                <option value="expense">Gasto (-)</option>
                                <option value="income">Ingreso (+)</option>
                            </select>
                            <i data-lucide="arrow-up-right"
                                class="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-600 pointer-events-none group-focus-within/select:text-indigo-400 transition-all"></i>
                        </div>
                    </div>
                </div>

                <!-- Account & Date Row -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label
                            class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 px-1">Billetera</label>
                        <div class="relative group/select">
                            <select id="txn-modal-account"
                                class="w-full bg-[#161b22] border border-white/5 rounded-2xl py-4 px-5 text-white text-sm appearance-none focus:border-indigo-500/50 outline-none transition-all cursor-pointer">
                                <option value="pocket">Efectivo (Bolsillo)</option>
                                <option value="bank">Banco / Debito</option>
                                <option value="credit">Tarjeta Credito</option>
                                <option value="loan">Préstamo</option>
                            </select>
                            <i data-lucide="wallet"
                                class="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-600 pointer-events-none group-focus-within/select:text-indigo-400 transition-all"></i>
                        </div>
                    </div>
                    <div>
                        <label
                            class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 px-1">Fecha</label>
                        <div class="relative">
                            <input type="date" id="txn-modal-date"
                                class="w-full bg-[#161b22] border border-white/5 rounded-2xl py-4 px-5 text-white text-sm focus:border-indigo-500/50 outline-none transition-all [color-scheme:dark]">
                        </div>
                    </div>
                </div>

                <button onclick="saveTransactionFromModal()"
                    class="w-full py-5 rounded-2xl bg-indigo-600 hover:bg-indigo-550 text-white font-black uppercase tracking-widest text-xs shadow-xl shadow-indigo-500/20 transition-all transform hover:scale-[1.02] active:scale-[0.98] mt-4 flex items-center justify-center gap-3">
                    <i data-lucide="save" class="w-4 h-4"></i> Guardar Cambios
                </button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // --- TRANSACTION MODAL & EDIT LOGIC ---

        function populateCategorySelect() {
            const select = document.getElementById('txn-modal-category');
            if (!select) return;
            select.innerHTML = '';

            // Get categories from budgets or defaults
            // We use the same set as the rest of the app for consistency
            let categories = Object.keys(appState.categoryBudgets || {});

            // Add defaults if empty or incomplete
            const defaults = ['Food', 'Transport', 'Entertainment', 'Housing', 'Utilities', 'Shopping', 'Health', 'Tech', 'Travel', 'Education', 'Income', 'Salary', 'Investments'];
            const allCats = new Set([...categories, ...defaults]);

            Array.from(allCats).sort().forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.innerText = cat;
                select.appendChild(opt);
            });
        }

        function openTransactionModal(mode, id = null) {
            const modal = document.getElementById('transaction-modal');
            const content = document.getElementById('txn-modal-content');
            if (!modal) return;

            populateCategorySelect(); // Ensure cats are fresh

            const titleEl = document.getElementById('txn-modal-title');
            const idInput = document.getElementById('txn-modal-id');
            const amtInput = document.getElementById('txn-modal-amount');
            const nameInput = document.getElementById('txn-modal-name');
            const catInput = document.getElementById('txn-modal-category');
            const typeInput = document.getElementById('txn-modal-type');
            const dateInput = document.getElementById('txn-modal-date');
            const accountInput = document.getElementById('txn-modal-account');
            const notesInput = document.getElementById('txn-modal-notes');

            if (mode === 'edit' && id) {
                // Find txn
                const txn = appState.transactions.find(t => t.id == id);
                if (!txn) return;

                titleEl.innerHTML = '<span class="bg-indigo-500/20 text-indigo-400 p-2.5 rounded-2xl border border-indigo-500/30"><i data-lucide="pencil-line" class="w-5 h-5"></i></span> Editar Transacción';
                idInput.value = txn.id;
                amtInput.value = txn.amount;
                nameInput.value = txn.name || '';
                catInput.value = txn.category || 'Food';
                typeInput.value = txn.type || 'expense';
                if (accountInput) accountInput.value = txn.account || 'pocket';
                if (notesInput) notesInput.value = txn.notes || '';

                // Format date for input type=date (YYYY-MM-DD)
                let dateStr = '';
                if (txn.dateIso && txn.dateIso.includes('-')) {
                    dateStr = txn.dateIso.split('T')[0];
                } else if (txn.date && txn.date.includes('-')) {
                    // Try parsing localized date or YYYY-MM-DD
                    const d = new Date(txn.date);
                    if (!isNaN(d)) dateStr = d.toISOString().split('T')[0];
                } else {
                    const d = new Date(txn.id);
                    if (!isNaN(d)) dateStr = d.toISOString().split('T')[0];
                }
                dateInput.value = dateStr;

            } else {
                // Add Mode
                titleEl.innerHTML = '<span class="bg-emerald-500/20 text-emerald-400 p-2.5 rounded-2xl border border-emerald-500/30"><i data-lucide="plus" class="w-5 h-5"></i></span> Nuevo Movimiento';
                idInput.value = '';
                amtInput.value = '';
                nameInput.value = '';
                catInput.value = 'Food';
                typeInput.value = 'expense';
                if (accountInput) accountInput.value = 'pocket';
                if (notesInput) notesInput.value = '';
                dateInput.value = new Date().toISOString().split('T')[0];
            }

            // Show
            modal.classList.remove('hidden');
            // Animate
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);

            lucide.createIcons();
        }

        function closeTransactionModal() {
            const modal = document.getElementById('transaction-modal');
            const content = document.getElementById('txn-modal-content');
            if (!modal) return;

            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            modal.classList.add('opacity-0');

            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function saveTransactionFromModal() {
            const id = document.getElementById('txn-modal-id').value;
            const amount = parseFloat(document.getElementById('txn-modal-amount').value);
            const name = document.getElementById('txn-modal-name').value;
            const category = document.getElementById('txn-modal-category').value;
            const type = document.getElementById('txn-modal-type').value;
            const dateVal = document.getElementById('txn-modal-date').value; // YYYY-MM-DD
            const account = document.getElementById('txn-modal-account').value;
            const notes = document.getElementById('txn-modal-notes').value;

            if (isNaN(amount) || amount <= 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Monto inválido',
                    text: 'Por favor ingresa un monto mayor a cero.',
                    background: '#0f1115',
                    color: '#fff',
                    confirmButtonColor: '#4f46e5'
                });
                return;
            }

            if (id) {
                // EDIT
                const txn = appState.transactions.find(t => t.id == id);
                if (txn) {
                    txn.amount = amount;
                    txn.name = name;
                    txn.description = name;
                    txn.category = category;
                    txn.type = type;
                    txn.dateIso = dateVal;
                    txn.date = dateVal;
                    txn.account = account;
                    txn.notes = notes;
                }
            } else {
                // ADD
                const newTxn = {
                    id: Date.now(),
                    amount: amount,
                    name: name,
                    description: name,
                    category: category,
                    type: type,
                    dateIso: dateVal,
                    date: dateVal,
                    account: account,
                    notes: notes
                };
                appState.transactions.push(newTxn);
            }

            // Persistence & UI Refresh
            if (typeof saveState === 'function') saveState();
            if (typeof loadState === 'function') loadState();

            // Refresh specific components if needed (legacy fallback)
            if (typeof calculateDashboardMetrics === 'function') calculateDashboardMetrics();
            if (typeof renderMergedDashboard === 'function') renderMergedDashboard();
            if (typeof filterWallet === 'function') {
                if (typeof currentWalletFilter !== 'undefined') filterWallet(currentWalletFilter);
                else filterWallet('all');
            }

            closeTransactionModal();

            Swal.fire({
                icon: 'success',
                title: id ? 'Actualizado' : 'Guardado',
                text: 'La transacción se ha procesado correctamente.',
                timer: 1500,
                showConfirmButton: false,
                background: '#0f1115',
                color: '#fff'
            });
        }


        // Update Focus Distribution (Needs/Wants/etc) - DEPRECATED/REMOVED to avoid conflict with budget_analytics.js
        // function updateFocusStats() { ... }

        // --- FOCUS DETAILS MODAL LOGIC ---
        let currentDetailFocus = null;

        function setFocusGoal() {
            if (!currentDetailFocus) return;

            // Check if goal exists
            const currentGoal = (appState.budgetFocusGoals && appState.budgetFocusGoals[currentDetailFocus]) ?
                appState.budgetFocusGoals[currentDetailFocus] :
                0; // 0 means auto

            Swal.fire({
                title: `Meta para ${currentDetailFocus}`,
                text: 'Define un límite mensual. Deja en 0 para cálculo automático.',
                input: 'number',
                inputValue: currentGoal,
                showCancelButton: true,
                confirmButtonText: 'Guardar',
                confirmButtonColor: '#6366f1',
                background: '#1e293b',
                color: '#fff'
            }).then((result) => {
                if (result.isConfirmed) {
                    const amount = parseFloat(result.value);
                    if (!appState.budgetFocusGoals) appState.budgetFocusGoals = {};

                    // Save
                    appState.budgetFocusGoals[currentDetailFocus] = isNaN(amount) ? 0 : amount;
                    saveState();

                    // Refresh Modal
                    openFocusDetails(currentDetailFocus);

                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: 'Meta actualizada',
                        timer: 1500,
                        showConfirmButton: false,
                        background: '#1e293b',
                        color: '#fff'
                    });
                }
            });
        }

        function filterWalletByFocus() {
            if (!currentDetailFocus) return;

            closeFocusModal();
            walletFocusFilter = currentDetailFocus;
            // Set type to 'expense' because focus is expense-only concept mostly
            walletFilter = 'expense';

            // Switch to Wallet
            switchTab('wallet');

            // Force Render
            renderWalletHistory();

            // Show toast
            Swal.fire({
                toast: true,
                position: 'top',
                icon: 'info',
                title: `Viendo gastos: ${currentDetailFocus}`,
                timer: 2000,
                showConfirmButton: false,
                background: '#1e293b',
                color: '#fff'
            });
        }

        function openFocusDetails(type) {
            console.log("🔍 openFocusDetails triggered for:", type);
            const modal = document.getElementById('modal-focus-details');

            if (!modal) {
                console.error("❌ Modal 'modal-focus-details' not found in DOM");
                Swal.fire({ icon: 'error', title: 'Error', text: 'Modal de detalles no encontrado.' });
                return;
            }

            if (!window.appState || !window.appState.transactions) {
                console.warn("⚠️ appState or transactions missing. Attempting to load...");
                if (!window.appState) window.appState = {};
                if (!window.appState.transactions) window.appState.transactions = []; // Prevent crash, shows empty modal
            }

            window.currentDetailFocus = type; // Explicit Global for external access

            // 1. Calculate Data
            // Filter Expenses
            // Ensure we are filtering by CURRENT MONTH for context consistency?
            // The previous chart used current month. The modal title says "Detalles de X".
            // Usually goals are monthly. So let's filter expenses by Current Month here too.
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            // Synced Map from budget_analytics.js
            const focusMap = {
                'Housing': 'Needs', 'Groceries': 'Needs', 'Transport': 'Needs', 'Health': 'Needs', 'Education': 'Needs', 'Utilities': 'Needs', 'Gas': 'Needs',
                'Food': 'Wants', 'Shopping': 'Wants', 'Entertainment': 'Wants', 'Travel': 'Wants', 'Personal': 'Wants', 'Love': 'Wants', 'Others': 'Wants',
                'Savings': 'Saving', 'Emergency Fund': 'Saving',
                'Investment': 'Investment', 'Stocks': 'Investment', 'Crypto': 'Investment',
                'Waste': 'Waste', 'Alcohol': 'Waste', 'Gambling': 'Waste', 'Beer': 'Waste', 'Junk Food': 'Waste'
            };

            const categoryExpenses = appState.transactions.filter(t => {
                if (t.type !== 'expense') return false;

                // 1. Category Check (Mandatory)
                let focus = t.budgetFocus;
                if (!focus) {
                    const catName = (window.appState.categories && Array.isArray(window.appState.categories))
                        ? (window.appState.categories.find(c => c.id == t.category)?.name || t.category)
                        : t.category;
                    focus = focusMap[catName] || focusMap[t.category] || 'Wants';
                    // Manual override descriptions
                    const desc = (t.description || '').toLowerCase();
                    if (desc.includes('uber') || desc.includes('taxi')) focus = 'Wants';
                }
                // Normalize
                if (focus === 'Save') focus = 'Saving';
                if (focus === 'Invest') focus = 'Investment';

                if (focus !== type) return false;

                // 2. Date Check
                let d;
                let validDate = false;

                if (t.dateIso) {
                    d = new Date(t.dateIso.includes('T') ? t.dateIso : t.dateIso + 'T12:00:00');
                    validDate = !isNaN(d.getTime());
                } else if (typeof t.id === 'number' && t.id > 1600000000000) {
                    d = new Date(t.id);
                    validDate = !isNaN(d.getTime());
                } else {
                    // Try parsing "3 ene"
                    const SpanishMonths = {
                        'ene': 0, 'feb': 1, 'mar': 2, 'abr': 3, 'may': 4, 'jun': 5,
                        'jul': 6, 'ago': 7, 'sep': 8, 'oct': 9, 'nov': 10, 'dic': 11
                    };
                    const parts = (t.date || "").toLowerCase().split(' ');
                    if (parts.length >= 2 && SpanishMonths[parts[1].substring(0, 3)] !== undefined) {
                        const day = parseInt(parts[0]);
                        const month = SpanishMonths[parts[1].substring(0, 3)];
                        d = new Date(currentYear, month, day);
                        validDate = true;
                    } else {
                        d = new Date(t.date + ", " + currentYear);
                        validDate = !isNaN(d.getTime());
                    }
                }

                if (!validDate) return true; // Fallback: If date is broken but Cat matches, include it.

                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });

            // Calculate Total for this Focus
            const spent = categoryExpenses.reduce((sum, t) => sum + t.amount, 0);

            // Calculate Total Income for % context (Monthly Income)
            const monthlyIncome = appState.transactions
                .filter(t => {
                    if (t.type !== 'income') return false;
                    let d;
                    if (t.dateIso) d = new Date(t.dateIso.includes('T') ? t.dateIso : t.dateIso + 'T12:00:00');
                    else d = new Date(t.id);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                })
                .reduce((sum, t) => sum + t.amount, 0);

            // Calculate Total Expenses for Fallback (Match Dashboard "Distribution")
            const monthlyExpenses = appState.transactions
                .filter(t => {
                    if (t.type !== 'expense') return false;
                    let d;
                    if (t.dateIso) d = new Date(t.dateIso.includes('T') ? t.dateIso : t.dateIso + 'T12:00:00');
                    else d = new Date(t.id);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                })
                .reduce((sum, t) => sum + t.amount, 0);

            // Percentage Logic
            let percent = 0;
            let percentLabel = "Del Ingreso Total";

            if (monthlyIncome > 0) {
                // Scenario A: We have Income data -> Show % of Income (Financial Health)
                percent = Math.round((spent / monthlyIncome) * 100);
                percentLabel = "Del Ingreso Total";
            } else if (monthlyExpenses > 0) {
                // Scenario B: No Income data -> Show % of Total Spend (Matches Dashboard Distribution)
                percent = Math.round((spent / monthlyExpenses) * 100);
                percentLabel = "Del Gasto Total";
            }

            // 2. Configuration (Colors, Text, Limits)
            const config = {
                'Needs': { color: 'text-indigo-400', barInfo: 'bg-indigo-500 shadow-[0_0_15px_rgba(99,102,241,0.5)]', desc: 'Gastos esenciales. Meta: < 50% de ingresos.', limitRatio: 0.50 },
                'Wants': { color: 'text-pink-400', barInfo: 'bg-pink-500 shadow-[0_0_15px_rgba(236,72,153,0.5)]', desc: 'Estilo de vida. Meta: < 30% de ingresos.', limitRatio: 0.30 },
                'Saving': { color: 'text-emerald-400', barInfo: 'bg-emerald-500 shadow-[0_0_15px_rgba(16,185,129,0.5)]', desc: 'Ahorro futuro. Meta: > 20% de ingresos.', limitRatio: 0.20 },
                'Investment': { color: 'text-orange-400', barInfo: 'bg-orange-500 shadow-[0_0_15px_rgba(249,115,22,0.5)]', desc: 'Creación de riqueza. ¡Invierte con sabiduría!', limitRatio: 0.20 },
                'Waste': { color: 'text-red-400', barInfo: 'bg-red-500 shadow-[0_0_15px_rgba(239,68,68,0.5)]', desc: 'Gastos a eliminar. ¡Reduce a cero!', limitRatio: 0.05 }
            };

            const cfg = config[type] || config['Needs']; // Fallback

            // LIMIT CALCULATION: Custom Goal OR Auto Ratio
            let limitAmount = 0;
            let isCustomGoal = false;

            if (appState.budgetFocusGoals && appState.budgetFocusGoals[type] > 0) {
                limitAmount = appState.budgetFocusGoals[type];
                isCustomGoal = true;
            } else {
                limitAmount = monthlyIncome * cfg.limitRatio;
            }

            // 3. Update DOM
            document.getElementById('focus-modal-badge').innerText = type;
            document.getElementById('focus-modal-badge').className = `text-[10px] uppercase font-bold tracking-widest ${cfg.color}`;

            document.getElementById('focus-modal-title').innerText = "Detalles de " + type;

            document.getElementById('focus-modal-percent').innerText = percent + "%";
            const labelEl = document.getElementById('focus-modal-label');
            if (labelEl) labelEl.innerText = percentLabel;

            // Dynamic Description based on status
            if (isCustomGoal) {
                document.getElementById('focus-modal-desc').innerText = `${cfg.desc} (Meta Personalizada: $${limitAmount.toLocaleString()})`;
            } else {
                document.getElementById('focus-modal-desc').innerText = cfg.desc;
            }

            document.getElementById('focus-modal-spent').innerText = "$" + spent.toLocaleString();
            document.getElementById('focus-modal-spent').innerText = "$" + spent.toLocaleString();
            // Removed limit update as element was deleted


            // Bar Animation Reset
            const bar = document.getElementById('focus-modal-bar');
            bar.className = `h-full w-0 transition-all duration-1000 ${cfg.barInfo}`;
            bar.style.width = '0%';

            // Calculate Bar Width
            let barWidth = 0;
            if (limitAmount > 0) {
                barWidth = (spent / limitAmount) * 100;
            } else if (spent > 0) {
                barWidth = 100;
            }

            if (barWidth > 100) barWidth = 100;





            // 5. Show Modal
            modal.classList.remove('hidden');

            // Animate
            setTimeout(() => {
                bar.style.width = barWidth + "%";
            }, 100);
        }

        function closeFocusModal() {
            document.getElementById('modal-focus-details').classList.add('hidden');
        }

        // --- SIMULATION LOGIC ---
        window.runSimulation = function () {
            Swal.fire({
                title: 'Initializing Simulation',
                text: 'Generating comprehensive financial data...',
                background: '#1E293B',
                color: '#fff',
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                    setTimeout(() => {
                        // 1. Clear Data
                        appState.transactions = [];
                        // Reset balances
                        appState.balanceAccounts = { pocket: 0, bank: 0, credit: 0, loan: 0 };

                        // 2. Generate Data (Up to Today)
                        const today = new Date();
                        const numTxs = 60; // Generate enough data for charts
                        const categories = appState.categories.length > 0 ? appState.categories : defaultState.categories;

                        for (let i = 0; i < numTxs; i++) {
                            const daysAgo = Math.floor(Math.random() * 30); // Last 30 days
                            const d = new Date(today);
                            d.setDate(d.getDate() - daysAgo);
                            d.setHours(Math.floor(Math.random() * 24), Math.floor(Math.random() * 60));

                            // Respect "Today" limit (already done by subtracting from today)

                            const type = Math.random() > 0.35 ? 'expense' : 'income'; // 65% expenses
                            const cat = categories[Math.floor(Math.random() * categories.length)];
                            const amount = type === 'income' ? (Math.random() * 2500 + 500) : (Math.random() * 200 + 10);

                            const focusOptions = ['Needs', 'Wants', 'Saving', 'Investment', 'Waste'];
                            // Weighted focus for realism
                            let focus = 'Needs';
                            const rand = Math.random();

                            // Fixed Logic: Check strictly
                            if (rand > 0.9) focus = 'Waste';
                            else if (rand > 0.8) focus = 'Wants';
                            else if (rand > 0.65) focus = 'Saving';
                            else if (rand > 0.5) focus = 'Investment';

                            if (type === 'income') focus = null;

                            appState.transactions.push({
                                id: Date.now() + i,
                                dateIso: d.toISOString(),
                                date: d.toLocaleDateString('en-US', { month: 'short', day: '2-digit' }),
                                name: `Simulated ${cat.name}`,
                                category: cat.id,
                                type: type,
                                amount: parseFloat(amount.toFixed(2)),
                                budgetFocus: focus,
                                icon: cat.icon
                            });
                        }

                        // Recalculate Balance (Simple Sum)
                        let total = 0;
                        appState.transactions.forEach(t => {
                            if (t.type === 'income') total += t.amount;
                            else total -= t.amount;
                        });
                        appState.balanceAccounts.bank = total > 0 ? total : 0;

                        // 3. Save
                        saveState();

                        // Force Update of Focus Chart specifically
                        if (typeof updateBudgetFocusStats === 'function') {
                            console.log("Updating Focus Stats after simulation...");
                            updateBudgetFocusStats();
                        }

                        // 4. Redirect
                        Swal.close();
                        switchTab('dashboard'); // Redirect to Dashboard

                        setTimeout(() => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Simulation Active',
                                text: 'Dashboard updated with new data.',
                                toast: true,
                                position: 'top-end',
                                background: '#1E293B',
                                color: '#fff',
                                timer: 3000,
                                showConfirmButton: false
                            });
                        }, 500);

                    }, 800);
                }
            });
        };

        // Global Chart Instance for Weekly Activity
        let globalWalletChart = null;

        // IMMEDIATE Tab Restoration (executes synchronously during page load)
        (function () {
            const savedTab = localStorage.getItem('activeTab');
            if (savedTab && savedTab !== 'dashboard') {
                // Remove active from dashboard
                const dashboard = document.getElementById('view-dashboard');
                if (dashboard) dashboard.classList.remove('active');

                // Add active to saved tab
                const savedView = document.getElementById('view-' + savedTab);
                if (savedView) savedView.classList.add('active');
            }
        })();

        // --- STATE MANAGEMENT Engine ---
        let currentDetailCategory = null; // Global for Detail View Context

        // Dynamic Default Data Generator for "TODAY"
        const genDate = (hours, minutes) => {
            const d = new Date();
            d.setHours(hours, minutes, 0, 0);
            return d.toISOString();
        };

        const defaultState = {
            profile: {
                name: 'User',
                balance: 0
            },
            transactions: [],
            budget: {
                'Food': 0, 'Groceries': 0, 'Housing': 0, 'Transport': 0, 'Entertainment': 0,
                'Shopping': 0, 'Health': 0, 'Education': 0, 'Travel': 0, 'Beer': 0,
                'Junk Food': 0, 'Weed': 0, 'Love': 0, 'Gas': 0, 'Others': 0
            },
            balanceAccounts: {
                pocket: 0,
                bank: 0,
                credit: 0,
                loan: 0
            },
            categories: [
                { id: 'Food', name: 'Food', label: 'Food', icon: 'utensils' },
                { id: 'Groceries', name: 'Groceries', label: 'Groceries', icon: 'shopping-cart' },
                { id: 'Housing', name: 'Housing', label: 'Housing', icon: 'home' },
                { id: 'Transport', name: 'Transport', label: 'Transport', icon: 'bus' },
                { id: 'Entertainment', name: 'Entertainment', label: 'Entertainment', icon: 'film' },
                { id: 'Shopping', name: 'Shopping', label: 'Shopping', icon: 'shopping-bag' },
                { id: 'Health', name: 'Health', label: 'Health', icon: 'heart-pulse' },
                { id: 'Education', name: 'Education', label: 'Education', icon: 'graduation-cap' },
                { id: 'Travel', name: 'Travel', label: 'Travel', icon: 'plane' },
                { id: 'Beer', name: 'Beer', label: 'Beer', icon: 'beer' },
                { id: 'Junk Food', name: 'Junk Food', label: 'Junk Food', icon: 'pizza' },
                { id: 'Weed', name: 'Weed', label: 'Weed', icon: 'leaf' },
                { id: 'Love', name: 'Love', label: 'Love', icon: 'heart' },
                { id: 'Gas', name: 'Gas', label: 'Gas', icon: 'fuel' },
                { id: 'Others', name: 'Others', label: 'Others', icon: 'help-circle' }
            ],
            goals: [],
            portfolio: [],
            customAssets: [],
            debts: []
        };

        // --- DATA NORMALIZATION ENGINE ---
        function normalizeDatabase() {
            if (!appState.transactions) {
                appState.transactions = [];
                return;
            }
            // ... (normalization code omitted for brevity as it is fine)
        }

        // --- FORCE STATE MANAGER COMPATIBILITY ---
        // We comment out the legacy loader to force reliance on state_manager.js
        // window.appState = JSON.parse(localStorage.getItem('developMeApp_v1')) || ... 

        // Instead, we initialize a temporary empty state if undefined, until state_manager loads
        if (typeof window.appState === 'undefined') {
            window.appState = JSON.parse(JSON.stringify(defaultState));
        }

        // Ensure categories exist
        if (!appState.categories) appState.categories = JSON.parse(JSON.stringify(defaultState.categories));

        // Ensure Chart Preferences exist (User Request: Persistence for Chart Views)
        if (!appState.chartPreferences) {
            appState.chartPreferences = {
                netWorth: 12,      // Default 1Y
                comparison: '3M',  // Default 3M
                burndown: '1M'     // Default Monthly
            };
        }

        // Note: Real data loading happens in state_manager.js via loadState()


        // --- UNIVERSAL SAVE SYSTEM (Storage Only) ---
        function universalSave() {
            try {
                // 1. Force Save to LocalStorage
                saveState();

                // 2. Success Notification (No Download)
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: 'Información Guardada',
                    text: 'Tus datos se han guardado correctamente.',
                    background: '#064e3b', // Dark Emerald
                    color: '#fff',
                    timer: 2000,
                    showConfirmButton: false,
                    customClass: { popup: 'border border-emerald-500/50 shadow-2xl shadow-emerald-900/50' }
                });

            } catch (e) {
                console.error("Universal Save Failed:", e);
                Swal.fire({
                    icon: 'error',
                    title: 'Error al Guardar',
                    text: 'Hubo un problema guardando los datos.',
                    background: '#1E293B',
                    color: '#fff'
                });
            }
        }

        function downloadBackup() {
            try {
                if (!appState) return;
                const dataStr = JSON.stringify(appState, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);

                const date = new Date();
                const timestamp = date.toISOString().replace(/[:.]/g, '-').slice(0, 19);
                const filename = `aureus_backup_${timestamp}.json`;

                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                Swal.fire({
                    toast: true, position: 'top-end', icon: 'success',
                    title: 'Backup Descargado', background: '#064e3b', color: '#fff', timer: 2000, showConfirmButton: false
                });
            } catch (e) { console.error(e); alert('Error downloading backup'); }
        }

        function saveState() {
            try {
                if (!appState || !Array.isArray(appState.transactions)) {
                    console.error("Critical Error: Attempted to save invalid state!", appState);
                    alert("Critical Error: State corrupted. Saving aborted to prevent data loss.");
                    return;
                }

                // 1. Correct Persistence Logic
                // Use State Manager's dynamic key if available, otherwise default to finance_app_state
                let key = 'finance_app_state';
                if (typeof window.getCurrentUserKey === 'function') {
                    key = window.getCurrentUserKey();
                }

                const serialized = JSON.stringify(appState);
                localStorage.setItem(key, serialized);

                // Backup to session just in case
                sessionStorage.setItem(key + '_backup', serialized);

                console.log("saveState SUCCESS. Key:", key, "Items:", appState.transactions.length);
            } catch (e) {
                console.error("saveState FAILED:", e);
                alert("Failed to save data! Storage might be full.");
            }

            // 2. Refresh UI
            renderAll();
            renderWalletHistory();
            if (document.getElementById('view-budget').classList.contains('active')) {
                renderBudgetTab();
            }
            // Update monthly totals in Wallet tab
            if (typeof updateMonthlyTotals === 'function') updateMonthlyTotals();
        }

        // Chart References
        let mountainChart, cashFlowChart, financialGoalChart, spark1, spark2, dissectionChart, donutChart, areaChart, sidebarRingChart;
        let gaugeCharts = [];

        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');

            if (isDark) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                const btn = document.getElementById('themeIcon');
                if (btn) btn.setAttribute('data-lucide', 'sun');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                const btn = document.getElementById('themeIcon');
                if (btn) btn.setAttribute('data-lucide', 'moon');
            }

            if (typeof lucide !== 'undefined') lucide.createIcons();
            if (typeof updateChartsTheme === 'function') {
                updateChartsTheme(isDark ? 'light' : 'dark');
            }
        }

        function updateHeaderBranding(tabId) {
            // Ensure currentGradient available
            if (typeof currentGradient === 'undefined') window.currentGradient = { start: '#6366F1', end: '#A855F7' };
            if (typeof appState !== 'undefined' && appState.settings) {
                if (appState.settings.gradientStart) currentGradient.start = appState.settings.gradientStart;
                if (appState.settings.gradientEnd) currentGradient.end = appState.settings.gradientEnd;
            }

            // 1. Update Title and Subtitle based on Tab
            const config = {
                'dashboard': { title: 'DASHBOARD', sub: 'ARTIFICIAL INTELLIGENCE FINANCE', icon: 'layers' },
                'wallet': { title: 'WALLET', sub: 'TRANSACTION MANAGEMENT', icon: 'wallet' },
                'budget': { title: 'FINANZAS', sub: 'SMART PLANNING & LIMITS', icon: 'landmark' },
                'savings': { title: 'AHORRO', sub: 'GROWTH & GOALS', icon: 'piggy-bank' },
                'analytics': { title: 'ANALYTICS', sub: 'DEEP DIVE INSIGHTS', icon: 'bar-chart' },
                'analytics-overview': { title: 'ANALYTICS', sub: 'DEEP DIVE INSIGHTS', icon: 'bar-chart' },
                'settings': { title: 'SETTINGS', sub: 'PREFERENCES & CONFIG', icon: 'sliders' }
            };

            const active = config[tabId] || config['dashboard'];

            // Select Elements by ID
            const titleEl = document.getElementById('pageTitle');
            const subEl = document.getElementById('pageSubtitle');
            const bgEl = document.getElementById('headerIconBg');
            const svgEl = document.getElementById('headerIconSvg');

            // Update Text
            if (titleEl) {
                titleEl.innerText = active.title;
                titleEl.style.backgroundImage = `linear-gradient(to right, ${currentGradient.start}, ${currentGradient.end})`;
                titleEl.className = "text-3xl font-black text-transparent bg-clip-text tracking-tight";
            }

            if (subEl) {
                subEl.innerText = active.sub;
            }

            // 2. Update Header Icon Background
            if (bgEl) {
                // Set gradient & shadow
                bgEl.style.background = `linear-gradient(135deg, ${currentGradient.start}, ${currentGradient.end})`;
                bgEl.style.boxShadow = `0 10px 25px -5px ${currentGradient.start}66`;
            }

            // 3. Update Icon Path
            if (svgEl) {
                const icons = {
                    layers: `<path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />`,
                    wallet: `<path d="M20 7h-3a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h3a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2Z"/><path d="M4 17V7a2 2 0 0 1 2-2h2"/><path d="M22 13h-2"/><rect x="4" y="11" width="6" height="6" rx="1"/>`,
                    calculator: `<rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/>`,
                    landmark: `<line x1="3" x2="21" y1="22" y2="22"/><line x1="6" x2="6" y1="18" y2="11"/><line x1="10" x2="10" y1="18" y2="11"/><line x1="14" x2="14" y1="18" y2="11"/><line x1="18" x2="18" y1="18" y2="11"/><polygon points="12 2 20 7 4 7"/>`,
                    'piggy-bank': `<path d="M19 5c-1.5 0-2.8 1.4-3 2-3.5-1.5-11-.3-11 5 0 1.8 0 3 2 4.5V20h4v-2h3v2h4v-4c1-.5 1.7-1 2-2.5V5z"/><path d="M2 9v1c0 1.1.9 2 2 2h1"/><path d="M16 11h.01"/>`,
                    'bar-chart': `<line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/>`,
                    sliders: `<line x1="4" x2="4" y1="21" y2="14"/><line x1="4" x2="4" y1="10" y2="3"/><line x1="12" x2="12" y1="21" y2="12"/><line x1="12" x2="12" y1="8" y2="3"/><line x1="20" x2="20" y1="21" y2="16"/><line x1="20" x2="20" y1="12" y2="3"/><line x1="2" x2="6" y1="14" y2="14"/><line x1="10" x2="14" y1="8" y2="8"/><line x1="18" x2="22" y1="16" y2="16"/>`
                };
                const p = icons[active.icon] || icons['layers'];
                svgEl.innerHTML = p;
            }
        }

        function switchTab(tabId) {
            if (typeof updateSidebarCategories === 'function') updateSidebarCategories();
            // Save current tab to localStorage
            localStorage.setItem('activeTab', tabId);

            document.querySelectorAll('[id^="view-"]').forEach(el => {
                el.classList.remove('active');
                el.classList.add('hidden'); // Ensure hidden
            });
            // Fix: Handle 'analytics-overview' vs 'analytics' ID mismatch if exists
            const viewTarget = document.getElementById('view-' + tabId);
            if (viewTarget) {
                viewTarget.classList.add('active');
                viewTarget.classList.remove('hidden'); // Explicitly show
            } else {
                // Fallback if ID is different
                if (tabId === 'analytics-overview' && document.getElementById('view-analytics')) {
                    const fallback = document.getElementById('view-analytics');
                    fallback.classList.add('active');
                    fallback.classList.remove('hidden');
                }
            }

            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-primary/20', 'text-white', 'scale-[1.05]', 'shadow-glow', 'border-primary/50', 'bg-primary');
                el.classList.add('bg-white/5', 'text-slate-400', 'hover:bg-white/10', 'hover:text-white', 'border-white/5');
            });
            const activeBtn = document.getElementById('nav-' + tabId);
            if (activeBtn) {
                activeBtn.classList.remove('bg-white/5', 'text-slate-400', 'hover:bg-white/10', 'hover:text-white', 'border-white/5');
                activeBtn.classList.add('bg-primary/20', 'text-white', 'scale-[1.05]', 'shadow-glow', 'border-primary/50');
            }

            // NEW: Branding Update
            updateHeaderBranding(tabId);

            window.dispatchEvent(new Event('resize'));
            if (tabId === 'budget') {
                renderBudgetTab();
                // Reset Calendar
                calendarDate = new Date();
                selectedDate = new Date();
                if (typeof initCalendar === 'function') initCalendar();
                // Update focus stats with animation
                if (typeof updateBudgetFocusStats === 'function') setTimeout(updateBudgetFocusStats, 300);
            }
            if (tabId === 'wallet') {
                setTimeout(() => {
                    // Simulate Click on "Hoy" (Today) Button to ensure full UI/Login sync
                    const btnToday = document.getElementById('btn-type-today');
                    if (btnToday) {
                        btnToday.click();
                    } else if (typeof filterWallet === 'function') {
                        filterWallet('today');
                    }

                    if (typeof updateWalletHeaderDate === 'function') updateWalletHeaderDate();
                    if (typeof updateBalanceDisplay === 'function') updateBalanceDisplay();
                    if (typeof renderWalletHistory === 'function') renderWalletHistory();
                    if (typeof populateWalletCategories === 'function') populateWalletCategories();
                    if (typeof updateBalanceDisplay === 'function') updateBalanceDisplay();
                    if (typeof updateMonthlyTotals === 'function') updateMonthlyTotals();

                    // Call standalone chart function
                    if (typeof renderWalletWeeklyChart === 'function') {
                        console.log('Calling renderWalletWeeklyChart...');
                        renderWalletWeeklyChart();

                        // Try again after delays
                        setTimeout(renderWalletWeeklyChart, 300);
                        setTimeout(renderWalletWeeklyChart, 800);
                    }
                }, 100);
            }
            if (tabId === 'savings') {
                if (typeof renderSavingsTab === 'function') renderSavingsTab();
            }
        }

        // --- CHART INITIALIZATION (Simplified for restoration) ---
        // We will assume charts render function is called at bottom.
        // Re-injecting chart defs:

        mountainChart = new ApexCharts(document.querySelector("#mountainChart"), {
            chart: { type: 'area', height: '100%', toolbar: { show: false }, zoom: { enabled: false }, animations: { enabled: true, easing: 'easeinout', speed: 800 } },
            series: [{ name: 'Patrimonio', data: [15, 40, 35, 60, 45, 90, 65, 85, 95, 110, 100, 130] }],
            colors: ['#cbd5e1'],
            fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.8, opacityTo: 0.1, stops: [0, 90, 100], colorStops: [{ offset: 0, color: '#f97316', opacity: 0.4 }, { offset: 40, color: '#64748b', opacity: 0.9 }, { offset: 100, color: '#1e293b', opacity: 0.1 }] } },
            stroke: { curve: 'smooth', width: 2, colors: ['#94a3b8'] },
            dataLabels: { enabled: false }, grid: { show: false, padding: { left: 0, right: 0, bottom: -10 } },
            xaxis: { labels: { show: false }, axisBorder: { show: false }, axisTicks: { show: false } }, yaxis: { show: false }, tooltip: { theme: 'dark' }
        }); mountainChart.render();

        cashFlowChart = new ApexCharts(document.querySelector("#cashFlowChart"), {
            chart: { type: 'line', height: '100%', toolbar: { show: false }, animations: { enabled: true } },
            series: [{ name: 'Flujo', data: [40, 38, 50, 45, 60, 55, 70, 80] }],
            colors: ['#F97316'], stroke: { curve: 'monotoneCubic', width: 3, dashArray: 5 }, markers: { size: 4, colors: ['#F97316'], strokeWidth: 0 }, grid: { show: false },
            xaxis: { labels: { show: false }, axisBorder: { show: false }, axisTicks: { show: false } }, yaxis: { show: false }, tooltip: { theme: 'dark' }
        }); cashFlowChart.render();

        const financialGoalChartEl = document.querySelector("#financialGoalChart");
        if (financialGoalChartEl) {
            financialGoalChart = new ApexCharts(financialGoalChartEl, {
                chart: { type: 'radialBar', height: '120%', animations: { enabled: true } }, series: [70], colors: ['#F97316'],
                plotOptions: { radialBar: { startAngle: -135, endAngle: 135, hollow: { size: '60%' }, track: { background: '#1E293B', strokeWidth: '100%' }, dataLabels: { show: true, name: { show: false }, value: { color: '#fff', fontSize: '24px', fontWeight: 'bold', offsetY: 10 } } } }, stroke: { lineCap: 'round' }
            });
            financialGoalChart.render();
        }

        const sidebarRingChartEl = document.querySelector("#sidebarRingChart");
        if (sidebarRingChartEl) {
            window.sidebarRingChart = new ApexCharts(sidebarRingChartEl, {
                chart: { type: 'radialBar', height: '125%', sparkline: { enabled: true } },
                series: [13],
                colors: ['#F59E0B'],
                plotOptions: { radialBar: { hollow: { size: '50%' }, track: { background: '#1E293B', strokeWidth: '100%' }, dataLabels: { show: false } } },
                stroke: { lineCap: 'round' }
            });
            window.sidebarRingChart.render();
            // Initial forced scale for max size
            sidebarRingChartEl.style.transform = "scale(1.25)";
        }

        const sparkOptions = { chart: { type: 'area', height: 80, sparkline: { enabled: true } }, stroke: { curve: 'smooth', width: 2 }, fill: { type: 'gradient', gradient: { opacityFrom: 0.5, opacityTo: 0 } }, tooltip: { fixed: { enabled: false }, x: { show: false }, marker: { show: false } } };
        spark1 = new ApexCharts(document.querySelector("#spark1"), { ...sparkOptions, series: [{ data: [10, 15, 12, 20, 18, 28, 22, 35] }], colors: ['#6366F1'] }); spark1.render();
        spark2 = new ApexCharts(document.querySelector("#spark2"), { ...sparkOptions, series: [{ data: [35, 25, 30, 15, 20, 10, 15, 8] }], colors: ['#EC4899'] }); spark2.render();

        dissectionChart = new ApexCharts(document.querySelector("#dissectionChart"), {
            chart: { type: 'bar', toolbar: { show: false }, height: '100%' },
            series: [{ name: 'Income', data: [40, 50, 60, 45, 30, 50, 45, 60, 70, 45, 30, 40] }, { name: 'Expense', data: [30, 40, 45, 30, 20, 35, 30, 45, 50, 30, 20, 30] }],
            colors: ['#6366F1', '#EC4899'], plotOptions: { bar: { borderRadius: 3, columnWidth: '40%' } }, dataLabels: { enabled: false }, legend: { show: false }, grid: { show: false },
            xaxis: { categories: ['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D'], axisBorder: { show: false }, axisTicks: { show: false }, labels: { style: { colors: '#64748b' } } }, yaxis: { show: false }, tooltip: { theme: 'dark' }
        }); dissectionChart.render();

        donutChart = new ApexCharts(document.querySelector("#donutChart"), {
            chart: { type: 'donut', height: 220 }, series: [24, 24, 29, 27, 8], labels: ['Food', 'House', 'Car', 'Gravity', 'Holiday'], events: { animationEnd: undefined },
            colors: ['#6366F1', '#EAB308', '#D946EF', '#22C55E', '#F97316'],
            plotOptions: { donut: { size: '65%', labels: { show: true, total: { show: true, label: 'Expenses', color: '#fff' } } } }, dataLabels: { enabled: false }, legend: { show: true, position: 'right', labels: { colors: '#94a3b8' }, markers: { width: 8, height: 8 } }, stroke: { show: false }
        }); donutChart.render();

        const gaugeCommon = { chart: { type: 'radialBar', height: 140, width: 100, sparkline: { enabled: true } }, plotOptions: { radialBar: { hollow: { size: '55%' }, track: { background: '#1E293B' }, dataLabels: { name: { show: false }, value: { color: '#fff', fontSize: '14px', fontWeight: 'bold', offsetY: 6 } } } } };
        ['#6366F1', '#EAB308', '#D946EF', '#22C55E', '#F97316'].forEach((col, i) => {
            const el = document.querySelector("#gauge" + (i + 1));
            if (el) {
                let g = new ApexCharts(el, { ...gaugeCommon, series: [Math.max(1, Math.floor(Math.random() * 100))], colors: [col] });
                g.render();
                gaugeCharts.push(g);
            }
        });

        areaChart = new ApexCharts(document.querySelector("#areaChart"), {
            chart: { type: 'area', height: '100%', toolbar: { show: false } },
            series: [{ name: 'Income', data: [31, 40, 28, 51, 42, 109, 100] }, { name: 'Expense', data: [11, 32, 45, 32, 34, 52, 41] }],
            stroke: { curve: 'smooth', width: 3 }, colors: ['#6366F1', '#EC4899'], fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.05, stops: [0, 100] } }, dataLabels: { enabled: false }, grid: { borderColor: '#334155', strokeDashArray: 4, xaxis: { lines: { show: false } } },
            xaxis: { categories: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], labels: { style: { colors: '#64748b' } }, axisBorder: { show: false }, axisTicks: { show: false } }, yaxis: { labels: { style: { colors: '#64748b' } } }, legend: { show: false }, tooltip: { theme: 'dark' }
        }); areaChart.render();

        function formatCurrency(num) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        }

        function setText(id, val) {
            const el = document.getElementById(id);
            if (el) el.innerText = val;
        }

        function renderAll() {
            const totalIncome = appState.transactions.filter(t => t.type === 'income').reduce((acc, t) => acc + t.amount, 0);
            const totalExpense = appState.transactions.filter(t => t.type === 'expense').reduce((acc, t) => acc + t.amount, 0);
            const currentBalance = appState.profile.balance + totalIncome - totalExpense;

            setText('val-balance', formatCurrency(currentBalance));
            setText('val-income', formatCurrency(totalIncome));
            setText('val-expense', formatCurrency(totalExpense));
            const saving = Math.max(0, totalIncome - totalExpense);
            setText('val-saving', formatCurrency(saving));
            renderTransactionsList(appState.transactions);
            appState.goals.forEach((g, i) => {
                const bar = document.getElementById(`goal-${i + 1}-bar`);
                if (bar) {
                    const pct = Math.min(100, Math.round((g.current / g.target) * 100));
                    bar.style.width = pct + '%';
                }
            });
            renderBudgetTab(); // Update Budget Tab Visuals

            // Render Moved Analytics Chart
            if (typeof renderA2MonthlyBars === 'function') {
                renderA2MonthlyBars(appState.transactions);
            }
        }

        function renderTransactionsList(data) {
            const list = document.getElementById('transactionsList');
            if (!list) return;
            if (data.length === 0) {
                list.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-slate-500 italic text-sm"><i data-lucide="inbox" class="w-6 h-6 mb-2 opacity-50"></i>No transactions yet</div>';
                lucide.createIcons();
                return;
            }
            const recent = [...data].reverse().slice(0, 50);
            list.innerHTML = recent.map(t => `
                <div class="flex items-center justify-between group p-2 hover:bg-white/5 rounded-xl transition cursor-default">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-dark-800 flex items-center justify-center text-slate-400 group-hover:text-white transition shadow-sm">
                            <i data-lucide="${getCategoryIcon(t.category, t.type)}" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-white">${t.name}</p>
                            <p class="text-[10px] text-slate-500 uppercase tracking-wide">${t.date}</p>
                        </div>
                    </div>
                    <span class="text-sm font-bold ${t.type === 'income' ? 'text-accent-green' : 'text-white'}">
                        ${t.type === 'income' ? '+' : '-'} ${formatCurrency(t.amount)}
                    </span>
                </div>
            `).join('');
            lucide.createIcons();
        }

        setTimeout(() => { renderAll(); }, 1000);

        // Legacy generateRandomData removed to use the advanced simulation defined later.

        function clearAllData() {
            // 1. Clear State (Comprehensive)
            appState.transactions = [];
            appState.goals = [];
            if (appState.profile) appState.profile.balance = 0; // Clear initial balance
            appState.balanceAccounts = {}; // Clear account balances
            appState.portfolio = []; // Clear savings/assets
            appState.debts = []; // Clear debts

            saveState();

            // 2. Force DOM Updates immediately (Visual Feedback)
            // Dashboard
            const dbBal = document.getElementById('dash-balance'); if (dbBal) dbBal.innerText = "$0";
            const dbInc = document.getElementById('dash-income'); if (dbInc) dbInc.innerText = "$0";
            const dbExp = document.getElementById('dash-expense'); if (dbExp) dbExp.innerText = "$0";

            // Wallet
            const wBal = document.getElementById('w-net-balance'); if (wBal) wBal.innerText = "$0.00";
            const wInc = document.getElementById('monthly-income'); if (wInc) wInc.innerText = "$0.00";
            const wExp = document.getElementById('monthly-expenses'); if (wExp) wExp.innerText = "$0.00";
            const sbToday = document.getElementById('sidebar-today-amount'); if (sbToday) sbToday.innerText = "$0";
            const sbCount = document.getElementById('sidebar-today-count'); if (sbCount) sbCount.innerText = "0";

            // 3. Clear Charts
            if (window.netWorthChartInstance) {
                window.netWorthChartInstance.updateSeries([{ data: [] }]);
            }

            // 4. Re-render Views to ensure consistency
            if (typeof renderMegaDashboard === 'function') renderMegaDashboard();
            if (typeof updateWalletData === 'function') updateWalletData();
            if (typeof renderTransactionList === 'function') renderTransactionList();
            if (typeof updateSidebarStats === 'function') updateSidebarStats();

            // 5. Notify
            Swal.fire({
                toast: true,
                position: 'top',
                icon: 'success',
                title: 'All Data Wiped & Reset',
                timer: 1500,
                background: '#0f1115',
                color: '#fff'
            });
        }

        // --- TRANS MODAL LOGIC RESTORED & UPDATED ---
        let currentTransType = 'expense';
        let editingTransactionId = null;

        function loadTransactionIntoModal(id) {
            const t = appState.transactions.find(x => x.id === id);
            if (!t) return;

            editingTransactionId = t.id;

            // Populate Fields
            document.getElementById('inp-amount').value = t.amount;
            document.getElementById('inp-desc').value = t.name;
            document.getElementById('inp-cat').value = t.category;
            // Ensure Date is valid ISO
            document.getElementById('inp-date').value = t.dateIso || new Date().toISOString().split('T')[0];

            // Set Type
            setTransType(t.type);

            // Set Focus if expense
            if (t.type === 'expense') {
                selectModalFocus(t.budgetFocus);
            }

            openTransactionModal(true);
        }

        function openTransactionModal(isEdit = false) {
            const modal = document.getElementById('transactionModal');
            const title = document.getElementById('modalTitle');
            const submitBtn = document.getElementById('modalSubmitBtn');
            const deleteBtn = document.getElementById('modalDeleteBtn');

            if (!isEdit) {
                document.getElementById('walletForm').reset();
                editingTransactionId = null;
                title.innerHTML = '<span class="bg-primary/20 text-primary p-2 rounded-lg"><i data-lucide="wallet-2" class="w-6 h-6"></i></span> Nuevo Movimiento';
                submitBtn.innerText = 'Guardar';
                if (deleteBtn) deleteBtn.classList.add('hidden');

                // Default Today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('inp-date').value = today;
                selectModalFocus(null);
            } else {
                title.innerHTML = '<span class="bg-primary/20 text-primary p-2 rounded-lg"><i data-lucide="edit-3" class="w-6 h-6"></i></span> Editar Movimiento';
                submitBtn.innerText = 'Actualizar';
                if (deleteBtn) deleteBtn.classList.remove('hidden');
            }
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                document.getElementById('modalContent').classList.remove('scale-95');
                document.getElementById('modalContent').classList.add('scale-100');
            }, 10);

            setTransType(currentTransType);
        }

        function closeTransactionModal() {
            const modal = document.getElementById('transactionModal');
            modal.classList.add('opacity-0');
            document.getElementById('modalContent').classList.remove('scale-100');
            document.getElementById('modalContent').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function setTransType(type) {
            currentTransType = type;
            const btnExp = document.getElementById('btn-expense');
            const btnInc = document.getElementById('btn-income');
            const focusContainer = document.getElementById('modal-focus-container');

            if (type === 'expense') {
                btnExp.className = "p-3 rounded-xl bg-red-500/20 text-red-400 border border-red-500/50 font-medium text-center transition flex items-center justify-center gap-2 shadow-lg shadow-red-500/10";
                btnInc.className = "p-3 rounded-xl bg-transparent text-slate-400 border border-transparent font-medium text-center transition flex items-center justify-center gap-2 hover:text-white";
                if (focusContainer) focusContainer.classList.remove('hidden');
            } else {
                btnInc.className = "p-3 rounded-xl bg-accent-green/20 text-accent-green border border-accent-green/50 font-medium text-center transition flex items-center justify-center gap-2 shadow-lg shadow-green-500/10";
                btnExp.className = "p-3 rounded-xl bg-transparent text-slate-400 border border-transparent font-medium text-center transition flex items-center justify-center gap-2 hover:text-white";
                if (focusContainer) focusContainer.classList.add('hidden');
            }
        }

        function selectModalFocus(val) {
            document.getElementById('inp-focus').value = val || '';
            const items = document.querySelectorAll('.m-focus-item');
            items.forEach(el => {
                el.className = 'm-focus-item cursor-pointer text-[10px] font-bold uppercase p-2 rounded-xl border border-white/5 bg-dark-700 text-slate-400 hover:text-white hover:bg-dark-600 text-center transition';
            });
            if (val) {
                const active = document.getElementById('m-focus-' + val);
                if (active) {
                    active.className = 'm-focus-item cursor-pointer text-[10px] font-bold uppercase p-2 rounded-xl border border-primary bg-primary/20 text-primary text-center transition shadow-lg shadow-primary/20';
                }
            }
        }

        function addTransaction() {
            const amt = parseFloat(document.getElementById('inp-amount').value);
            const desc = document.getElementById('inp-desc').value;
            const cat = document.getElementById('inp-cat').value;
            const dateIso = document.getElementById('inp-date').value;
            const focus = document.getElementById('inp-focus').value;

            if (!amt || !desc) { Swal.fire({ toast: true, position: 'top', icon: 'error', title: 'Info Missing', timer: 1500 }); return; }

            const icons = {
                'Food': 'utensils', 'Groceries': 'shopping-cart', 'Housing': 'home',
                'Transport': 'bus', 'Entertainment': 'film', 'Shopping': 'shopping-bag',
                'Health': 'heart-pulse', 'Education': 'graduation-cap', 'Travel': 'plane',
                'Beer': 'beer', 'Junk Food': 'pizza', 'Weed': 'leaf',
                'Love': 'heart', 'Gas': 'fuel', 'Others': 'help-circle'
            };
            const icon = icons[cat] || 'circle-dollar-sign';

            const dObj = new Date(dateIso + 'T12:00:00');
            const dateDisplay = dObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

            if (editingTransactionId) {
                const index = appState.transactions.findIndex(t => t.id === editingTransactionId);
                if (index !== -1) {
                    appState.transactions[index] = {
                        ...appState.transactions[index],
                        amount: amt, name: desc, category: cat, type: currentTransType, icon: icon,
                        date: dateDisplay, dateIso: dateIso,
                        budgetFocus: currentTransType === 'expense' ? focus : null
                    };
                    Swal.fire({ toast: true, position: 'top', icon: 'success', title: 'Updated', timer: 1000, showConfirmButton: false });
                }
            } else {
                const newT = {
                    id: Date.now(),
                    name: desc, amount: amt, type: currentTransType, category: cat, icon: icon,
                    date: dateDisplay, dateIso: dateIso,
                    budgetFocus: currentTransType === 'expense' ? focus : null
                };
                appState.transactions.unshift(newT);
                Swal.fire({ toast: true, position: 'top', icon: 'success', title: 'Saved', timer: 1000, showConfirmButton: false });
            }
            saveState();

            // Refresh Wallet view if currently active
            const walletView = document.getElementById('view-wallet');
            if (walletView && walletView.classList.contains('active')) {
                if (typeof refreshWalletView === 'function') {
                    setTimeout(() => refreshWalletView(), 100);
                }
            }

            // If editing from Category Details, close that modal too to return to Budget View
            if (!document.getElementById('categoryDetailsModal').classList.contains('hidden')) {
                closeCategoryDetails();
            }

            closeTransactionModal();
        }

        function editTransaction(id) {
            const t = appState.transactions.find(tr => tr.id === id);
            if (!t) return;
            editingTransactionId = id;
            document.getElementById('inp-amount').value = t.amount;
            document.getElementById('inp-desc').value = t.name;
            document.getElementById('inp-cat').value = t.category;

            const iso = t.dateIso || new Date(isFinite(t.id) ? t.id : Date.now()).toISOString().split('T')[0];
            document.getElementById('inp-date').value = iso;

            selectModalFocus(t.budgetFocus);
            setTransType(t.type);
            openTransactionModal(true);
        }

        function deleteTransaction(id) {
            const targetId = id || editingTransactionId;
            if (!targetId) return;

            // --- 1. CRITICAL: DATA DELETION IMMEDIATELY (NO CONFIRMATION) ---
            const idx = appState.transactions.findIndex(t => String(t.id).trim() == String(targetId).trim());
            let deletionSuccess = false;

            console.log(`Direct delete. Target: "${targetId}", Found Index: ${idx}`);

            if (idx !== -1) {
                appState.transactions.splice(idx, 1);

                // Robust Save Immediately
                if (typeof saveAppState === 'function') saveAppState();
                else if (typeof saveState === 'function') saveState();

                deletionSuccess = true;

                // Update Monthly Totals Immediately
                if (typeof updateMonthlyTotals === 'function') updateMonthlyTotals();
            } else {
                console.warn("Delete Failed: ID not found via trim match", targetId);
                const looseIdx = appState.transactions.findIndex(t => t.id == targetId);
                if (looseIdx !== -1) {
                    appState.transactions.splice(looseIdx, 1);
                    if (typeof saveState === 'function') saveState();
                    deletionSuccess = true;
                }
            }

            if (!deletionSuccess) return;

            editingTransactionId = null;

            // --- 2. VISUAL ANIMATION & CLEANUP ---
            const listItems = document.querySelectorAll('#wallet-history-list > div');
            let targetElement = null;

            listItems.forEach(item => {
                const btn = item.querySelector(`button[onclick*="${targetId}"]`);
                if (btn) targetElement = item;
            });

            // UI Refresh Logic
            const finalizeUI = () => {
                // Refresh Wallet List
                if (typeof renderWalletHistory === 'function') {
                    if (typeof filterWallet === 'function' && typeof currentWalletFilter !== 'undefined') {
                        filterWallet(currentWalletFilter);
                    } else {
                        renderWalletHistory(appState.transactions);
                    }
                }

                // Refresh Charts
                if (typeof renderMergedDashboard === 'function') renderMergedDashboard();
                if (typeof renderWeeklyActivityChart === 'function') renderWeeklyActivityChart();
                if (typeof updateFocusStats === 'function') updateFocusStats();

                // Close any open modals
                if (typeof closeTransactionModal === 'function') closeTransactionModal();
                if (typeof closeTransactionModalV2 === 'function') closeTransactionModalV2();
                if (typeof closeCategoryDetails === 'function') closeCategoryDetails();

                // Non-blocking Success Toast
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: false,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer)
                        toast.addEventListener('mouseleave', Swal.resumeTimer)
                    }
                });

                Toast.fire({
                    icon: 'success',
                    title: 'Eliminado'
                });
            };

            if (targetElement) {
                targetElement.style.transition = 'all 0.3s ease';
                targetElement.style.opacity = '0';
                targetElement.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    targetElement.remove();
                    finalizeUI();
                }, 300);
            } else {
                finalizeUI();
            }
        }

        function updateSidebarRingChart() {
            try {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                // Robust Date Filtering (Matches budget_analytics.js)
                const expenses = appState.transactions.filter(t => {
                    if (t.type !== 'expense') return false;
                    const d = new Date(t.dateIso || t.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });

                const totalSpent = expenses.reduce((a, t) => a + t.amount, 0);

                let totalBudget = 0;
                if (appState.budget) {
                    for (const [key, value] of Object.entries(appState.budget)) {
                        if (key !== 'limit') totalBudget += value;
                    }
                    if (totalBudget === 0 && appState.budget.limit) totalBudget = appState.budget.limit;
                }

                // LOGIC CHANGE: Show REMAINING % (Available) instead of SPENT %
                // 100% means Full Budget Available. 0% means Budget Depleted.
                const remaining = Math.max(0, totalBudget - totalSpent);
                const percentage = totalBudget > 0 ? Math.round((remaining / totalBudget) * 100) : 0;

                // Dynamic Color Logic (Fuel Gauge Style)
                // > 50%: Healthy (Theme/Green/Indigo)
                // 25-50%: Warning (Orange)
                // < 25%: Critical (Red)
                let startColor = '#6366F1'; // Default Indigo
                let endColor = '#A855F7';   // Default Purple

                if (percentage < 25) {
                    startColor = '#ef4444'; endColor = '#ef4444'; // Red
                } else if (percentage < 50) {
                    startColor = '#f97316'; endColor = '#f97316'; // Orange
                }

                const isDark = document.documentElement.classList.contains('dark');
                const trackColor = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)'; // Darker track for light mode? No, faint grey.

                const options = {
                    series: [percentage],
                    chart: {
                        height: '100%',
                        type: 'radialBar',
                        fontFamily: 'Inter, sans-serif',
                        animations: { enabled: true, dynamicAnimation: { enabled: true, speed: 800 } },
                        sparkline: { enabled: true }
                    },
                    plotOptions: {
                        radialBar: {
                            hollow: { size: '60%', margin: 0 },
                            track: { background: trackColor },
                            dataLabels: { show: false }
                        }
                    },
                    colors: [startColor],
                    fill: {
                        type: 'gradient',
                        gradient: {
                            shade: 'dark',
                            type: 'horizontal',
                            gradientToColors: [endColor],
                            stops: [0, 100]
                        }
                    },
                    stroke: { lineCap: 'round' }
                };

                const chartEl = document.querySelector("#sidebarRingChart");
                if (chartEl && chartEl.offsetParent !== null && chartEl.offsetWidth > 0) {
                    if (typeof sidebarRingChart !== 'undefined' && sidebarRingChart) {
                        sidebarRingChart.updateSeries([percentage]);
                        sidebarRingChart.updateOptions({
                            colors: [startColor],
                            fill: { gradient: { gradientToColors: [endColor] } },
                            plotOptions: { radialBar: { track: { background: trackColor } } }
                        });
                    } else {
                        chartEl.innerHTML = '';
                        sidebarRingChart = new ApexCharts(chartEl, options);
                        sidebarRingChart.render();
                    }

                    // Update Text Overlay
                    const overlayParam = chartEl.nextElementSibling;
                    if (overlayParam && overlayParam.classList.contains('absolute')) {
                        const spans = overlayParam.querySelectorAll('span');
                        if (spans.length >= 2) {
                            spans[0].innerText = percentage + '%';
                            spans[1].innerText = 'DISPONIBLE'; // Changed from 'DEL PRESUPUESTO'
                        }
                    }
                }
            } catch (e) { console.error("Sidebar update error", e); }
        }

        function getBudgetCategoryDefinitions() {
            if (!appState.categoryDefinitions) {
                appState.categoryDefinitions = [
                    { id: 'Food', name: 'Food', icon: 'utensils', color: 'text-orange-400', bar: 'bg-orange-500' },
                    { id: 'Groceries', name: 'Groceries', icon: 'shopping-cart', color: 'text-blue-400', bar: 'bg-blue-500' },
                    { id: 'Housing', name: 'Housing', icon: 'home', color: 'text-indigo-400', bar: 'bg-indigo-500' },
                    { id: 'Transport', name: 'Transport', icon: 'bus', color: 'text-emerald-400', bar: 'bg-emerald-500' },
                    { id: 'Entertainment', name: 'Entertainment', icon: 'clapperboard', color: 'text-purple-400', bar: 'bg-purple-500' },
                    { id: 'Shopping', name: 'Shopping', icon: 'shopping-bag', color: 'text-pink-400', bar: 'bg-pink-500' },
                    { id: 'Health', name: 'Health', icon: 'heart-pulse', color: 'text-red-400', bar: 'bg-red-500' },
                    { id: 'Education', name: 'Education', icon: 'graduation-cap', color: 'text-cyan-400', bar: 'bg-cyan-500' },
                    { id: 'Travel', name: 'Travel', icon: 'plane', color: 'text-sky-400', bar: 'bg-sky-500' },
                    { id: 'Beer', name: 'Beer', icon: 'beer', color: 'text-yellow-400', bar: 'bg-yellow-500' },
                    { id: 'Junk Food', name: 'Junk Food', icon: 'pizza', color: 'text-orange-600', bar: 'bg-orange-600' },
                    { id: 'Weed', name: 'Weed', icon: 'leaf', color: 'text-green-500', bar: 'bg-green-500' },
                    { id: 'Love', name: 'Love', icon: 'heart', color: 'text-rose-500', bar: 'bg-rose-500' },
                    { id: 'Gas', name: 'Gas', icon: 'fuel', color: 'text-slate-400', bar: 'bg-slate-500' },
                    { id: 'Others', name: 'Others', icon: 'help-circle', color: 'text-gray-400', bar: 'bg-gray-500' }
                ];
            }
            return appState.categoryDefinitions;
        }

        function getGlobalBudgetLimit() {
            let budgetMap = appState.budget || {};
            let totalLimit = 0;

            if (typeof budgetMap.limit === 'number' && budgetMap.limit > 0) {
                totalLimit = budgetMap.limit;
            } else {
                const categories = getBudgetCategoryDefinitions();
                categories.forEach(cat => {
                    totalLimit += (budgetMap[cat.id] || 0);
                });
            }

            // Fallback purely for visualization if everything is 0
            if (totalLimit === 0) {
                // Try legacy or income-based fallback
                const txs = appState.transactions || [];
                const mInc = txs.filter(t => t.type === 'income').reduce((a, b) => a + (parseFloat(b.amount) || 0), 0);
                if (mInc > 0) totalLimit = mInc * 0.8;
                else totalLimit = 5000;
            }
            return totalLimit;
        }

        function renameCategoryInState(oldId, newId) {
            if (oldId === newId) return;
            if (!appState.budget) appState.budget = {};

            // 1. Move Budget
            if (appState.budget[oldId] !== undefined) {
                appState.budget[newId] = appState.budget[oldId];
                delete appState.budget[oldId];
            }

            // 2. Update Transactions
            if (appState.transactions) {
                appState.transactions.forEach(t => {
                    if (t.category === oldId) t.category = newId;
                });
            }
        }

        function renderBudgetTab() {
            updateSidebarRingChart();
            const budgetList = document.getElementById('budget-list');
            if (!budgetList) return;

            const categories = getBudgetCategoryDefinitions();

            // Filter expenses for current month using robust date parsing
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            const expenses = appState.transactions.filter(t => {
                const d = new Date(t.dateIso || t.id || t.date);
                return t.type === 'expense' && d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });

            // Group Expenses
            const catMap = {};
            expenses.forEach(t => {
                const cat = t.category || 'Otros';
                catMap[cat] = (catMap[cat] || 0) + Math.abs(parseFloat(t.amount) || 0);
            });

            // Calculate exact total spent for the month
            const totalSpent = expenses.reduce((sum, t) => sum + Math.abs(parseFloat(t.amount) || 0), 0);
            const totalBudget = getGlobalBudgetLimit();

            budgetList.innerHTML = categories.map(cat => {
                const spent = catMap[cat.id] || 0;
                const budget = appState.budget[cat.id] || 0;
                const pct = budget > 0 ? Math.min(100, (spent / budget) * 100) : 0;


                return `
                <div class="bg-dark-800 rounded-3xl p-5 border border-white/5 relative group hover:border-white/10 transition-all">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-4 cursor-pointer flex-1" onclick="openCategoryDetails('${cat.id}', '${cat.id}', '${cat.icon}')">
                            <div class="w-12 h-12 rounded-2xl bg-dark-900 border border-white/5 flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
                                <i data-lucide="${cat.icon}" class="w-6 h-6 ${cat.color}"></i>
                            </div>
                            <div>
                                <h3 class="text-white font-bold text-lg leading-tight mb-1 group-hover:text-primary transition-colors">${cat.id}</h3>
                                <div class="flex items-center gap-1 text-xs font-mono">
                                    <span class="${spent > budget && budget > 0 ? 'text-red-400' : 'text-emerald-400'} font-bold">$${formatCurrency(spent).replace('$', '')}</span>
                                    <span class="text-slate-600">/</span>
                                    <span class="text-slate-500">$${formatCurrency(budget).replace('$', '')}</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="editCategoryBudget('${cat.id}')" class="text-slate-600 hover:text-white transition p-2 rounded-lg hover:bg-white/5 z-10">
                            <i data-lucide="pencil" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="h-1.5 w-full bg-dark-900 rounded-full overflow-hidden">
                        <div class="h-full ${spent > budget && budget > 0 ? 'bg-red-500' : cat.bar} transition-all duration-1000" style="width: ${pct}%"></div>
                    </div>
                    
                    ${budget > 0 && spent >= budget ?
                        '<span class="absolute top-2 right-2 flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span></span>'
                        : ''}
                </div>
                `;
            }).join('');

            lucide.createIcons();

            // Update Top Widgets
            const elTotalLimit = document.getElementById('b-total-limit');
            const elTotalSpent = document.getElementById('b-total-spent');
            const elRemaining = document.getElementById('b-total-remaining');

            if (elTotalLimit) elTotalLimit.innerText = formatCurrency(totalBudget);
            if (elTotalSpent) elTotalSpent.innerText = formatCurrency(totalSpent);

            const remaining = totalBudget - totalSpent;
            if (elRemaining) {
                elRemaining.innerText = formatCurrency(remaining);
                elRemaining.className = `text-4xl font-black tracking-tighter drop-shadow-lg transition-colors ${remaining < 0 ? 'text-rose-500' : 'text-accent-green'}`;
            }

            // --- BUDGET HEALTH CHART ---
            // --- BUDGET HEALTH CHART ---
            const healthContainer = document.querySelector("#budgetHealthChart");

            // Start Fresh or Update
            // Logic moved to specific states below to support transitions

            if (totalBudget === 0) {
                // EMPTY STATE (Large Button)
                // Ensure we clean up any existing chart first
                if (window.budgetHealthChart) {
                    try { window.budgetHealthChart.destroy(); } catch (e) { }
                    window.budgetHealthChart = null;
                }

                if (healthContainer) {
                    healthContainer.innerHTML = `
                        <div class="flex flex-col items-center justify-center text-center opacity-70 py-6 cursor-pointer hover:opacity-100 transition h-full" onclick="generateRandomData()">
                            <div class="w-12 h-12 rounded-full bg-dark-700 flex items-center justify-center mb-2 animate-pulse">
                                <i data-lucide="alert-circle" class="w-6 h-6 text-slate-400"></i>
                            </div>
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider max-w-[120px]">
                                Sin Presupuesto
                            </p>
                            <button class="mt-2 bg-primary/20 text-primary text-[10px] font-bold px-3 py-1 rounded-full uppercase hover:bg-primary hover:text-white transition">
                                Generar Demo
                            </button>
                        </div>
                    `;
                    lucide.createIcons();
                }
            } else {
                // CHART RENDER
                const remaining = totalBudget - totalSpent;
                const gaugeVal = Math.max(0, Math.min(100, (remaining / totalBudget) * 100));

                // Use Main Theme Gradient for Healthy state to interact with Theme Aesthetic
                let startColor = '#22C55E';
                let endColor = '#22C55E';

                if (typeof currentGradient !== 'undefined' && currentGradient.start && currentGradient.end) {
                    startColor = currentGradient.start;
                    endColor = currentGradient.end;
                }

                // Logic: If unhealthy, override with Red/Orange. If healthy, use Theme Gradient.
                let finalStartColor = startColor;
                let finalEndColor = endColor;

                if (remaining < 0) {
                    finalStartColor = '#EF4444';
                    finalEndColor = '#EF4444';
                } else if (gaugeVal < 20) {
                    finalStartColor = '#F97316';
                    finalEndColor = '#F97316';
                }

                const options = {
                    series: [gaugeVal],
                    chart: { height: 180, type: 'radialBar', sparkline: { enabled: true }, animations: { enabled: true } },
                    plotOptions: {
                        radialBar: {
                            startAngle: -90, endAngle: 90,
                            hollow: { size: '60%', margin: 0, dropShadow: { enabled: true, top: 0, left: 0, blur: 5, opacity: 0.5 } },
                            track: { background: '#1E293B', strokeWidth: '100%', margin: 0 },
                            dataLabels: {
                                name: { show: false },
                                value: { offsetY: -2, fontSize: '24px', fontWeight: '900', color: '#fff', formatter: val => Math.round(val) + '%' }
                            }
                        }
                    },
                    stroke: { lineCap: 'round' },
                    colors: [finalStartColor], // Start Color
                    fill: { type: 'gradient', gradient: { shade: 'dark', type: 'horizontal', gradientToColors: [finalEndColor], stops: [0, 100] } }
                };

                // Ensure layout is computed before rendering
                // Ensure layout is computed before rendering
                setTimeout(() => {
                    if (healthContainer) {
                        // Sanitize input values
                        const safeGaugeVal = isNaN(gaugeVal) ? 0 : Math.max(0, Math.min(100, gaugeVal));

                        // UPDATE EXISTING OR CREATE NEW
                        if (window.budgetHealthChart) {
                            window.budgetHealthChart.updateOptions({
                                colors: [finalStartColor],
                                fill: { gradient: { gradientToColors: [finalEndColor] } }
                            });
                            window.budgetHealthChart.updateSeries([safeGaugeVal]);
                        } else {
                            healthContainer.innerHTML = ''; // Clear container only if creating new
                            options.series = [safeGaugeVal];
                            window.budgetHealthChart = new ApexCharts(healthContainer, options);
                            window.budgetHealthChart.render();
                        }
                    }
                }, 100);
            }

            // --- COMPARISON CHART ---
            if (window.budgetComparisonChart && typeof window.budgetComparisonChart.updateSeries === 'function') {
                window.budgetComparisonChart.updateSeries([{ data: [totalBudget, totalSpent] }]);
                window.budgetComparisonChart.updateOptions({ colors: ['#10B981', totalSpent > totalBudget ? '#EF4444' : '#F43F5E'] });
            } else {
                const compEl = document.querySelector("#budgetComparisonChart");
                if (compEl) {
                    const compOptions = {
                        series: [{ data: [totalBudget, totalSpent] }],
                        chart: { type: 'bar', height: 80, sparkline: { enabled: true }, toolbar: { show: false } },
                        plotOptions: {
                            bar: {
                                borderRadius: 4,
                                horizontal: true,
                                barHeight: '60%',
                                distributed: true,
                            }
                        },
                        colors: ['#10B981', totalSpent > totalBudget ? '#EF4444' : '#F43F5E'],
                        tooltip: {
                            theme: 'dark',
                            y: { formatter: function (val) { return "$" + formatCurrency(val).replace('$', '') } }
                        },
                        xaxis: { categories: ['Límite', 'Gasto'] },
                        grid: { padding: { top: 0, bottom: 0, left: 0, right: 0 } }
                    };
                    window.budgetComparisonChart = new ApexCharts(compEl, compOptions);
                    window.budgetComparisonChart.render();
                }
            }
            // --- WEEKLY BUDGET VS EXPENSE LOGIC ---
            // 1. Calculate weekly limits (Total Budget / 4)
            const weeklyLimit = totalBudget / 4;

            // 2. Initialize weekly buckets
            const weeklySpent = [0, 0, 0, 0]; // Weeks 1-4

            // 3. Bucket expenses into weeks
            // Assuming "date" is like "May 01" or we use 'id' timestamp
            // We'll use the 'expenses' array calculated earlier (filtered by current month)
            expenses.forEach(t => {
                const dateObj = new Date(t.id); // Assuming ID is timestamp
                const day = dateObj.getDate();
                // Simple week bucketing: 1-7=W1, 8-14=W2, 15-21=W3, 22+=W4
                let weekIdx = 0;
                if (day > 7) weekIdx = 1;
                if (day > 14) weekIdx = 2;
                if (day > 21) weekIdx = 3;
                weeklySpent[weekIdx] += t.amount;
            });

            // 4. Update the DOM Bars (Dynamic Rendering)
            const weeklyListEl = document.getElementById('weekly-budget-list');
            if (weeklyListEl) {
                weeklyListEl.innerHTML = weeklySpent.map((spent, idx) => {
                    const limit = weeklyLimit;
                    const isOver = spent > limit;

                    const excess = isOver ? spent - limit : 0;
                    const remaining = isOver ? 0 : limit - spent;
                    const regularSpent = isOver ? limit : spent;

                    // Calculate Percentages relative to Max(Limit, Spent)
                    const totalBase = Math.max(limit, spent);
                    // Prevent division by zero
                    const base = totalBase > 0 ? totalBase : 1;

                    const pSpent = (regularSpent / base) * 100;
                    const pRem = (remaining / base) * 100;
                    const pExcess = (excess / base) * 100;

                    return `
                    <div class="mb-10 relative group">
                        <!-- Floating Info Chips -->
                        <div class="flex flex-wrap justify-between items-end absolute bottom-full left-0 w-full mb-3 pointer-events-none z-20">
                             
                             <!-- SPENT Label -->
                             <div class="glass-panel px-3 py-1.5 rounded-xl border border-orange-500/30 flex items-center gap-2 shadow-lg mb-1 transition-all duration-500 transform translate-y-2 opacity-0 group-hover:translate-y-0 group-hover:opacity-100" style="margin-left: ${Math.min(70, pSpent / 2)}%">
                                <span class="text-orange-400 text-[10px] font-bold whitespace-nowrap">Gasto: $${formatCurrency(spent).replace('$', '')}</span>
                                <span class="text-xs text-orange-500 font-black">${Math.round((spent / base) * 100)}%</span>
                             </div>

                             <!-- REMAINING Label -->
                             ${!isOver ? `
                             <div class="glass-panel px-3 py-1.5 rounded-xl border border-emerald-500/30 flex items-center gap-2 shadow-lg mb-1 transition-all duration-500 transform translate-y-2 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 delay-100">
                                <span class="text-emerald-400 text-[10px] font-bold whitespace-nowrap">Disp: $${formatCurrency(remaining).replace('$', '')}</span>
                                <span class="text-xs text-emerald-500 font-black">${Math.round((remaining / base) * 100)}%</span>
                             </div>
                             ` : ''}

                             <!-- EXCESS Label -->
                             ${isOver ? `
                             <div class="glass-panel px-3 py-1.5 rounded-xl border border-red-500/30 flex items-center gap-2 shadow-lg mb-1 ml-auto transition-all duration-500 transform translate-y-2 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 delay-100">
                                <span class="text-red-400 text-[10px] font-bold whitespace-nowrap">Excedido: $${formatCurrency(excess).replace('$', '')}</span>
                                <span class="text-xs text-red-500 font-black text-right">+${Math.round((excess / limit) * 100)}%</span>
                             </div>
                             ` : ''}
                        </div>

                        <div class="flex items-center gap-4">
                            <span class="w-12 text-slate-400 text-sm font-bold">Sem ${idx + 1}</span>
                            
                            <!-- BAR CONTAINER -->
                            <div class="flex-1 h-3.5 bg-dark-900 rounded-full flex relative overflow-visible border border-white/5 transition-all group-hover:bg-dark-800">
                                 <!-- SPENT -->
                                 <div class="h-full bg-gradient-to-r from-orange-600 to-orange-400 rounded-l-full relative shadow-[0_0_15px_rgba(249,115,22,0.3)] transition-all duration-1000" style="width: ${pSpent}%">
                                      ${spent > 0 ? '<div class="absolute inset-0 bg-white/20 animate-pulse rounded-l-full"></div>' : ''}
                                 </div>
                                 <!-- REMAINING -->
                                 <div class="h-full bg-emerald-900/30 border-l border-white/5 relative transition-all duration-1000 ${!isOver ? 'rounded-r-full' : ''}" style="width: ${pRem}%"></div>
                                 <!-- EXCESS -->
                                 <div class="h-full bg-gradient-to-r from-red-600 to-red-500 relative shadow-[0_0_15px_rgba(239,68,68,0.5)] transition-all duration-1000 rounded-r-full" style="width: ${pExcess}%">
                                      ${isOver ? '<div class="absolute top-0 right-0 -mt-2 -mr-1 w-3 h-3 bg-red-500 border-2 border-dark-900 rounded-full animate-ping"></div>' : ''}
                                 </div>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
                lucide.createIcons();
            }
            initCalendar();
            renderBudgetVariations();

            // Sync Burndown Chart
            if (typeof renderD2Burndown === 'function') {
                renderD2Burndown(totalBudget, expenses);
            }

            if (typeof updateBudgetFocusStats === 'function') setTimeout(updateBudgetFocusStats, 500);
        }

        // --- CALENDAR LOGIC ---
        let calendarDate = new Date(); // State for current view
        let selectedDate = new Date(); // State for selected day

        function initCalendar() {
            renderCalendar();
            updateCalendarHeader();
        }

        function updateCalendarHeader() {
            // "viernes, 12 de diciembre"
            const options = { weekday: 'long', day: 'numeric', month: 'long' };
            // Use Spanish locale as requested/implied by "viernes"
            const dateStr = selectedDate.toLocaleDateString('es-ES', options);
            const el = document.getElementById('cal-current-date');
            if (el) el.innerText = dateStr;

            // "diciembre de 2025"
            const monthStr = calendarDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            const titleEl = document.getElementById('cal-month-title');
            if (titleEl) titleEl.innerText = monthStr;
        }

        function changeMonth(delta) {
            calendarDate.setMonth(calendarDate.getMonth() + delta);
            renderCalendar();
            updateCalendarHeader();
        }

        function renderCalendar() {
            const grid = document.getElementById('cal-grid');
            if (!grid) return;
            grid.innerHTML = '';

            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();

            // Headers (Re-render every time since we clear grid)
            const days = ['do.', 'lu.', 'ma.', 'mi.', 'ju.', 'vi.', 'sá.'];
            days.forEach(d => {
                const sp = document.createElement('span');
                sp.className = "text-slate-500 font-bold text-xs py-2 uppercase tracking-wider";
                sp.innerText = d;
                grid.appendChild(sp);
            });

            // Data Analysis for Heatmap
            const dailyData = {};
            const startRange = new Date(year, month, 1).getTime();
            const endRange = new Date(year, month + 1, 1).getTime();

            // Analyze daily expenses
            if (appState && appState.transactions) {
                appState.transactions.forEach(t => {
                    // Robust Date Parsing
                    let d;
                    if (t.dateIso) {
                        d = new Date(t.dateIso);
                    } else if (typeof t.id === 'number' && t.id > 1600000000000) {
                        d = new Date(t.id);
                    } else {
                        // Attempt to parse date string "Dec 12"
                        d = new Date(t.date + ", " + new Date().getFullYear());
                        // If invalid or way off, fallback to ID
                        if (isNaN(d.getTime())) d = new Date(t.id);
                    }

                    if (!isNaN(d.getTime()) && d.getMonth() === month && d.getFullYear() === year) {
                        const dayNum = d.getDate();
                        if (!dailyData[dayNum]) dailyData[dayNum] = { total: 0, hasInfo: false, txs: [] };

                        // Strict Expense Summing
                        if (t.type === 'expense') {
                            dailyData[dayNum].total += parseFloat(t.amount) || 0;
                        }

                        dailyData[dayNum].hasInfo = true;
                        dailyData[dayNum].txs.push(t);
                    }
                });
            }

            // Calc avg for heatmap threshold
            const totalMonthly = Object.values(dailyData).reduce((a, b) => a + b.total, 0);
            const activeDays = Object.keys(dailyData).length || 1;
            const avgDaily = activeDays > 0 ? totalMonthly / activeDays : 100;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const prevMonthDays = new Date(year, month, 0).getDate();

            // Prev Month Padding
            for (let i = 0; i < firstDay; i++) {
                const d = document.createElement('div');
                d.className = "text-center py-2 text-slate-700 text-sm font-medium opacity-20 select-none";
                d.innerText = prevMonthDays - firstDay + 1 + i;
                grid.appendChild(d);
            }

            const today = new Date();
            const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;

            for (let i = 1; i <= daysInMonth; i++) {
                const dayData = dailyData[i] || { total: 0, hasInfo: false, txs: [] };
                const isToday = isCurrentMonth && i === today.getDate();
                const isSelected = selectedDate.getDate() === i && selectedDate.getMonth() === month && selectedDate.getFullYear() === year;

                const btn = document.createElement('button');

                // Base Styling
                let baseClass = "relative flex flex-col items-center justify-center w-full h-10 rounded-xl transition-all duration-300 group ";
                let contentClass = "text-sm font-bold z-10 w-8 h-8 flex items-center justify-center rounded-full transition-all ";

                // Color Logic
                if (isSelected) {
                    contentClass += "bg-white text-dark-900 shadow-[0_0_15px_rgba(255,255,255,0.4)] scale-110";
                } else if (isToday) {
                    contentClass += "bg-indigo-500 text-white shadow-lg shadow-indigo-500/40";
                } else if (dayData.total > (avgDaily * 1.5) && dayData.total > 0) {
                    // High Spend -> Red
                    contentClass += "bg-red-500/20 text-red-500 border border-red-500/30 shadow-[0_0_10px_rgba(239,68,68,0.1)]";
                } else if (dayData.total > 0) {
                    // Moderate Spend -> Orange
                    contentClass += "bg-orange-500/10 text-orange-400 border border-orange-500/20";
                } else {
                    // Empty -> Slate
                    contentClass += "text-slate-400 hover:text-white hover:bg-white/10";
                }

                btn.className = baseClass;

                // Info Dot
                const dotHtml = dayData.hasInfo ?
                    `<div class="absolute -bottom-1 flex justify-center w-full"><span class="w-1 h-1 rounded-full ${dayData.total > 0 ? 'bg-red-500 opacity-50' : 'bg-blue-400'}"></span></div>`
                    : '';

                btn.innerHTML = `<div class="${contentClass}">${i}</div>${dotHtml}`;

                btn.onclick = () => {
                    selectedDate = new Date(year, month, i);
                    renderCalendar(); // Re-render to update selected state
                    updateCalendarHeader();

                    // Show Details Modal
                    if (dayData.hasInfo) {
                        showDayDetails(i, dayData);
                    } else {
                        // Optional: Prompt to add info?
                    }
                };
                grid.appendChild(btn);
            }
        }

        function showDayDetails(day, data) {
            const listHtml = data.txs.length > 0 ? data.txs.map(t => `
                <div class="flex items-center justify-between p-3 rounded-xl bg-white/5 border border-white/5 mb-2 last:mb-0">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full ${t.type === 'income' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'} flex items-center justify-center">
                            <i data-lucide="${t.type === 'income' ? 'arrow-down-left' : 'arrow-up-right'}" class="w-4 h-4"></i>
                        </div>
                        <div class="text-left">
                           <p class="text-xs font-bold text-white line-clamp-1">${t.name || t.description || 'Transaction'}</p>
                           <p class="text-[10px] text-slate-400 uppercase">${t.category}</p>
                        </div>
                    </div>
                    <span class="text-sm font-black ${t.type === 'income' ? 'text-emerald-400' : 'text-slate-200'}">
                        ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount).replace('$', '')}
                    </span>
                </div>
             `).join('') : '<div class="text-center text-slate-500 text-xs py-4">No specific transactions recorded.</div>';

            Swal.fire({
                title: `<div class="flex flex-col items-center">
                            <span class="text-3xl font-black text-white">${day}</span>
                            <span class="text-xs text-slate-400 uppercase tracking-widest text-white/50">${calendarDate.toLocaleDateString('es-ES', { month: 'long' })}</span>
                        </div>`,
                html: `
                    <div class="mb-6 mt-2">
                        <div class="inline-block px-4 py-2 rounded-2xl bg-dark-800 border border-white/5">
                             <p class="text-[10px] text-slate-500 uppercase font-bold mb-1">Total Diario</p>
                             <h2 class="text-2xl font-black ${data.total > 0 ? 'text-red-400' : 'text-slate-200'}">$${formatCurrency(data.total).replace('$', '')}</h2>
                        </div>
                    </div>
                    <div class="text-left">
                        <h4 class="text-xs font-bold text-slate-400 mb-3 ml-1">Transacciones</h4>
                        <div class="max-h-[250px] overflow-y-auto custom-scrollbar">
                            ${listHtml}
                        </div>
                    </div>
                `,
                background: '#0F111A',
                showConfirmButton: false,
                showCloseButton: true,
                width: '900px',
                customClass: {
                    popup: 'rounded-[2.5rem] border border-white/10 shadow-2xl backdrop-blur-xl p-0 overflow-hidden',
                    closeButton: 'text-white hover:text-red-400 focus:outline-none'
                },
                didOpen: () => lucide.createIcons()
            });
        }


        function renderBudgetVariations() {
            // Safety check for dashboard context - if we're not on a view with these charts, don't crash
            if (!document.getElementById('v-chart-1') && !document.getElementById('v-chart-2')) {
                return; // Graceful exit if chart containers are missing (e.g. on Dashboard)
            }

            // Data Prep
            const cats = appState.categories || [];
            // Use same logic as renderBudgetTab to get spent
            const now = new Date();
            const startMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
            const expenses = appState.transactions.filter(t => t.type === 'expense' && t.id >= startMonth);
            const catMap = {};
            expenses.forEach(t => { catMap[t.category] = (catMap[t.category] || 0) + t.amount; });

            let labels = [];
            let spentData = [];
            let budgetData = [];

            const hasData = expenses.length > 0;

            if (!hasData) {
                // Example Data for Showcase
                labels = ['Food', 'Housing', 'Transport', 'Entertainment', 'Shopping'];
                spentData = [450, 1200, 300, 150, 200];

                budgetData = [600, 1500, 400, 200, 300];
            } else {
                cats.forEach(c => {
                    labels.push(c.id);
                    spentData.push(catMap[c.id] || 0);
                    budgetData.push(appState.budget[c.id] || 0);
                });
            }

            // Common Options
            const commonOpts = {
                chart: { background: 'transparent', toolbar: { show: false }, animations: { enabled: true } },
                theme: { mode: 'dark' },
                stroke: { show: false },
                dataLabels: { enabled: false },
                legend: { show: false },
                tooltip: { theme: 'dark', y: { formatter: (val) => formatCurrency(val) } }
            };

            // 1. Donut
            const donutOpts = {
                ...commonOpts,
                chart: { type: 'donut', height: 250 },
                series: spentData,
                labels: labels,
                plotOptions: { donut: { size: '65%', labels: { show: true, total: { show: true, label: 'Total', color: '#fff', formatter: (w) => formatCurrency(w.globals.seriesTotals.reduce((a, b) => a + b, 0)).replace('$', '') } } } },
                colors: ['#6366F1', '#EC4899', '#10B981', '#F59E0B', '#8B5CF6', '#EF4444', '#06B6D4']
            };
            // Clear prev
            const el1 = document.querySelector("#v-chart-1");
            if (el1) {
                el1.innerHTML = '';
                new ApexCharts(el1, donutOpts).render();
            }

            // 2. Treemap
            const treeData = cats.map(c => ({ x: c.id, y: catMap[c.id] || 0 })).filter(d => d.y > 0);
            if (treeData.length === 0) treeData.push({ x: 'Sin Datos', y: 1 });

            const treeOpts = {
                ...commonOpts,
                chart: { type: 'treemap', height: 250 },
                series: [{ data: treeData }],
                colors: ['#3B82F6'],
                plotOptions: { treemap: { distributed: true, enableShades: true } }
            };
            const el2 = document.querySelector("#v-chart-2");
            if (el2) {
                el2.innerHTML = '';
                new ApexCharts(el2, treeOpts).render();
            }
            // 3. Radar
            const radarOpts = {
                ...commonOpts,
                chart: { type: 'radar', height: 250 },
                series: [{ name: 'Presupuesto', data: budgetData }, { name: 'Gasto Real', data: spentData }],
                labels: labels,
                stroke: { show: true, width: 2, colors: ['#6366F1', '#F59E0B'] },
                colors: ['#6366F1', '#F59E0B'],
                fill: { opacity: 0.2 },
                xaxis: { labels: { style: { colors: new Array(labels.length).fill('#94a3b8'), fontSize: '10px' } } },
                yaxis: { show: false }
            };
            document.querySelector("#v-chart-3").innerHTML = '';
            new ApexCharts(document.querySelector("#v-chart-3"), radarOpts).render();

            // 4. Polar Area
            const polarOpts = {
                ...commonOpts,
                chart: { type: 'polarArea', height: 250 },
                series: spentData,
                labels: labels,
                stroke: { show: true, colors: ['#1e293b'] },
                fill: { opacity: 0.8 },
                yaxis: { show: false },
                colors: ['#6366F1', '#EC4899', '#10B981', '#F59E0B', '#8B5CF6', '#EF4444', '#06B6D4']
            };
            document.querySelector("#v-chart-4").innerHTML = '';
            new ApexCharts(document.querySelector("#v-chart-4"), polarOpts).render();

            // 5. Stacked Bar (100%) - Budget Composition
            // actually separate spent vs remaining stacked
            const barOpts = {
                ...commonOpts,
                chart: { type: 'bar', stacked: true, stackType: '100%', height: 250 },
                series: [{ name: 'Gasto', data: spentData }, { name: 'Restante', data: budgetData.map((b, i) => Math.max(0, b - spentData[i])) }],
                xaxis: { categories: labels, labels: { show: false }, axisBorder: { show: false }, axisTicks: { show: false } },
                yaxis: { show: false },
                grid: { show: false },
                colors: ['#F59E0B', '#10B981'],
                plotOptions: { bar: { horizontal: true, borderRadius: 4 } }
            };
            document.querySelector("#v-chart-5").innerHTML = '';
            new ApexCharts(document.querySelector("#v-chart-5"), barOpts).render();

            // 6. Ranking (Horizontal Bar)
            // Sort top 5 spenders
            const sortedIndices = spentData.map((val, i) => ({ val, label: labels[i] })).sort((a, b) => b.val - a.val).slice(0, 5);
            if (sortedIndices.length === 0) sortedIndices.push({ val: 0, label: 'Sin Datos' });

            const rankOpts = {
                ...commonOpts,
                chart: { type: 'bar', height: 250 },
                series: [{ name: 'Gasto', data: sortedIndices.map(i => i.val) }],
                xaxis: { categories: sortedIndices.map(i => i.label), labels: { style: { colors: '#94a3b8' } }, axisBorder: { show: false }, axisTicks: { show: false } },
                yaxis: { labels: { style: { colors: '#fff' } } },
                grid: { show: false },
                colors: ['#EC4899'],
                plotOptions: { bar: { horizontal: true, borderRadius: 3, barHeight: '50%', distributed: true } }
            };
            document.querySelector("#v-chart-6").innerHTML = '';
            new ApexCharts(document.querySelector("#v-chart-6"), rankOpts).render();
        }

        function openBatchBudgetEditor() {
            // Enhanced Category List for UI (Colors/BGs)
            const uiCategories = [
                { id: 'Food', icon: 'utensils', color: 'text-orange-400', bg: 'bg-orange-500/10', border: 'border-orange-500/20' },
                { id: 'Groceries', icon: 'shopping-cart', color: 'text-blue-400', bg: 'bg-blue-500/10', border: 'border-blue-500/20' },
                { id: 'Housing', icon: 'home', color: 'text-indigo-400', bg: 'bg-indigo-500/10', border: 'border-indigo-500/20' },
                { id: 'Transport', icon: 'bus', color: 'text-emerald-400', bg: 'bg-emerald-500/10', border: 'border-emerald-500/20' },
                { id: 'Entertainment', icon: 'clapperboard', color: 'text-purple-400', bg: 'bg-purple-500/10', border: 'border-purple-500/20' },
                { id: 'Shopping', icon: 'shopping-bag', color: 'text-pink-400', bg: 'bg-pink-500/10', border: 'border-pink-500/20' },
                { id: 'Health', icon: 'heart-pulse', color: 'text-red-400', bg: 'bg-red-500/10', border: 'border-red-500/20' },
                { id: 'Education', icon: 'graduation-cap', color: 'text-cyan-400', bg: 'bg-cyan-500/10', border: 'border-cyan-500/20' },
                { id: 'Travel', icon: 'plane', color: 'text-sky-400', bg: 'bg-sky-500/10', border: 'border-sky-500/20' },
                { id: 'Beer', icon: 'beer', color: 'text-yellow-400', bg: 'bg-yellow-500/10', border: 'border-yellow-500/20' },
                { id: 'Junk Food', icon: 'pizza', color: 'text-orange-600', bg: 'bg-orange-600/10', border: 'border-orange-600/20' },
                { id: 'Weed', icon: 'leaf', color: 'text-green-500', bg: 'bg-green-500/10', border: 'border-green-500/20' },
                { id: 'Love', icon: 'heart', color: 'text-rose-500', bg: 'bg-rose-500/10', border: 'border-rose-500/20' },
                { id: 'Gas', icon: 'fuel', color: 'text-slate-400', bg: 'bg-slate-500/10', border: 'border-slate-500/20' },
                { id: 'Others', icon: 'help-circle', color: 'text-gray-400', bg: 'bg-gray-500/10', border: 'border-gray-500/20' }
            ];

            const cats = appState.categories || uiCategories;
            let currentTotal = 0;

            const inputs = cats.map(c => {
                const val = appState.budget[c.id] || 0;
                currentTotal += val;

                // Match with UI styling
                const ui = uiCategories.find(u => u.id === c.id) || { color: 'text-slate-400', bg: 'bg-dark-800', border: 'border-white/5', icon: c.icon || 'circle' };

                return `
                    <div class="flex items-center justify-between p-3 rounded-2xl bg-dark-800/40 border border-transparent hover:border-white/10 hover:bg-dark-800 transition-all group mb-2">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl ${ui.bg} flex items-center justify-center ${ui.color} shadow-sm border ${ui.border}">
                                <i data-lucide="${ui.icon}" class="w-5 h-5"></i>
                            </div>
                            <span class="text-sm font-bold text-slate-300 group-hover:text-white transition-colors tracking-wide">${c.id}</span>
                        </div>
                        <div class="relative w-36">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 font-bold text-xs pointer-events-none">$</span>
                            <input type="number" 
                                id="batch-budget-${c.id}" 
                                value="${val}"
                                min="0" 
                                step="any"
                                class="batch-budget-input w-full bg-dark-900 border border-white/5 rounded-xl py-2.5 pl-8 pr-4 text-white text-sm font-bold text-right focus:border-primary focus:ring-1 focus:ring-primary/50 outline-none transition-all placeholder-slate-700 hover:bg-dark-900/80 shadow-inner"
                            >
                        </div>
                    </div>
                `;
            }).join('');

            Swal.fire({
                title: `
                    <div class="flex flex-col items-center mb-1">
                        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-indigo-500/20 to-purple-500/20 border border-indigo-500/30 flex items-center justify-center mb-4 text-indigo-400 shadow-xl shadow-indigo-500/10">
                            <i data-lucide="sliders-horizontal" class="w-7 h-7"></i>
                        </div>
                        <span class="text-2xl font-black text-white tracking-tight">Ajustar Presupuestos</span>
                        <p class="text-slate-400 text-xs font-medium mt-1">Simula y define tus límites de gasto mensual</p>
                    </div>
                `,
                html: `
                    <div class="relative mt-2">
                        <!-- List (Grid Layout now) -->
                        <div class="max-h-[50vh] overflow-y-auto custom-scrollbar pr-2 -mr-2 grid grid-cols-1 md:grid-cols-2 gap-3 py-1">
                            ${inputs}
                        </div>
                        
                        <!-- Footer / Total sticky -->
                        <div class="mt-6 pt-5 border-t border-white/10 flex justify-between items-end bg-dark-900/30 rounded-xl p-4 border border-white/5">
                            <div>
                                <p class="text-[10px] uppercase font-bold text-slate-500 tracking-widest mb-1">Presupuesto Total</p>
                                <p class="text-xs text-slate-400 font-medium">Suma de categorías</p>
                            </div>
                            <div class="text-right">
                                <span id="batch-total-display" class="text-3xl font-black text-emerald-400 tracking-tight drop-shadow-lg">$${currentTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                            </div>
                        </div>
                    </div>
                `,
                background: '#0F111A',
                color: '#fff',
                confirmButtonText: 'Guardar Cambios',
                confirmButtonColor: '#6366F1',
                showCancelButton: true,
                cancelButtonText: 'Cancelar',
                cancelButtonColor: '#1E293B',
                width: '750px',
                padding: '2.5rem',
                customClass: {
                    popup: 'rounded-[2.5rem] border border-white/10 shadow-2xl backdrop-blur-xl',
                    confirmButton: 'rounded-xl px-8 py-4 font-bold text-sm shadow-xl shadow-indigo-500/20 hover:scale-105 transition-transform',
                    cancelButton: 'rounded-xl px-6 py-4 font-bold text-sm text-slate-400 hover:text-white hover:bg-white/5 transition-colors',
                    actions: 'gap-4 mt-4 w-full grid grid-cols-2'
                },
                didOpen: () => {
                    lucide.createIcons();

                    const inputsEl = document.querySelectorAll('.batch-budget-input');
                    const totalEl = document.getElementById('batch-total-display');

                    const updateTotal = () => {
                        let total = 0;
                        inputsEl.forEach(inp => total += parseFloat(inp.value) || 0);
                        totalEl.innerText = '$' + total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    };

                    inputsEl.forEach(inp => {
                        inp.addEventListener('input', updateTotal);
                    });
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    let newTotal = 0;
                    cats.forEach(c => {
                        const el = document.getElementById(`batch-budget-${c.id}`);
                        if (el) {
                            const val = parseFloat(el.value) || 0;
                            appState.budget[c.id] = val;
                            newTotal += val;
                        }
                    });
                    // Sync global limit
                    appState.budget.limit = newTotal;
                    saveState();
                    renderBudgetTab();

                    Swal.fire({
                        toast: true,
                        position: 'top',
                        icon: 'success',
                        title: 'Presupuestos Guardados',
                        background: '#1E293B',
                        color: '#fff',
                        timer: 2000,
                        showConfirmButton: false,
                        customClass: { popup: 'rounded-2xl border border-white/10 shadow-xl' }
                    });
                }
            });
        }

        function editCategoryBudget(catId) {
            const categories = getBudgetCategoryDefinitions();
            const cat = categories.find(c => c.id === catId);
            const currentVal = appState.budget[catId] || 0;

            Swal.fire({
                title: `<span class="flex items-center gap-3 justify-center text-2xl font-black tracking-tight"><i data-lucide="settings-2" class="w-7 h-7 text-indigo-500"></i> CONFIGURAR</span>`,
                html: `
                    <div class="flex flex-col gap-5 text-left p-2">
                        <div class="space-y-1.5 pt-2">
                            <label class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] ml-1">Nombre de la Categoría</label>
                            <input id="swal-cat-name" type="text" class="w-full bg-dark-900 border border-white/5 text-white rounded-2xl p-4 font-bold focus:border-indigo-500/50 outline-none transition shadow-inner" value="${cat.id}">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] ml-1">Icono (Lucide)</label>
                            <div class="flex gap-3">
                                <div class="w-14 h-14 rounded-2xl bg-dark-900 border border-white/5 flex items-center justify-center shrink-0 shadow-lg" id="swal-icon-container">
                                    <i data-lucide="${cat.icon}" class="w-7 h-7 text-indigo-400" id="swal-icon-preview"></i>
                                </div>
                                <input id="swal-cat-icon" type="text" class="flex-1 bg-dark-900 border border-white/5 text-white rounded-2xl p-4 font-mono text-xs focus:border-indigo-500/50 outline-none transition shadow-inner" value="${cat.icon}" placeholder="p.e. wallet, heart, star..." oninput="const el = document.getElementById('swal-icon-preview'); el.setAttribute('data-lucide', this.value); lucide.createIcons();">
                            </div>
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] ml-1">Presupuesto Mensual ($)</label>
                            <input id="swal-cat-budget" type="number" step="0.01" class="w-full bg-dark-900 border border-white/5 text-white rounded-2xl p-4 font-black text-xl text-center focus:border-indigo-500/50 outline-none transition shadow-inner text-indigo-400" value="${currentVal}">
                        </div>
                    </div>
                `,
                background: '#0B0D14',
                color: '#fff',
                confirmButtonText: 'GUARDAR CAMBIOS',
                showCancelButton: true,
                cancelButtonText: 'CANCELAR',
                customClass: {
                    container: 'custom-swal-container',
                    popup: 'rounded-[32px] border border-white/5 shadow-2xl p-6',
                    confirmButton: 'bg-indigo-600 hover:bg-indigo-500 text-white font-black py-4 px-8 rounded-2xl text-xs tracking-widest transition-all w-full mb-2',
                    cancelButton: 'bg-white/5 hover:bg-white/10 text-slate-400 hover:text-white font-bold py-3 px-8 rounded-2xl text-[10px] tracking-widest transition-all w-full mr-2'
                },
                didOpen: () => {
                    lucide.createIcons();
                    // Inject custom style to remove swal default button wrapper layout if needed
                    const act = Swal.getActions();
                    if (act) act.style.flexDirection = 'column-reverse';
                },
                preConfirm: () => {
                    const name = document.getElementById('swal-cat-name').value.trim();
                    const icon = document.getElementById('swal-cat-icon').value.trim();
                    const budget = parseFloat(document.getElementById('swal-cat-budget').value);
                    if (!name) return Swal.showValidationMessage('El nombre es requerido');
                    return { name, icon, budget };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const { name, icon, budget } = result.value;

                    // Update Definitions
                    if (name !== cat.id) {
                        renameCategoryInState(cat.id, name);
                        cat.id = name;
                    }
                    cat.icon = icon;

                    // Update Budget Amount
                    appState.budget[name] = isNaN(budget) ? 0 : Math.max(0, budget);

                    saveState();
                    renderBudgetTab();
                    if (typeof updateSidebarRingChart === 'function') updateSidebarRingChart();
                    if (typeof updateMonthlyTotals === 'function') updateMonthlyTotals();

                    Swal.fire({
                        toast: true, position: 'top', icon: 'success', title: 'Categoría actualizada correctamente',
                        background: '#1E293B', color: '#fff', timer: 2000, showConfirmButton: false,
                        customClass: { popup: 'rounded-2xl border border-white/10 shadow-xl' }
                    });
                }
            });
        }

        function saveBudgetInputs() {
            const inputs = document.querySelectorAll('.budget-input');
            let total = 0;
            inputs.forEach(inp => {
                const cat = inp.dataset.cat;
                const val = parseFloat(inp.value) || 0;
                appState.budget[cat] = val;
                total += val;
            });
            saveState();
            Swal.fire({ toast: true, position: 'top', icon: 'success', title: 'Budget Updated', background: '#1E293B', color: '#fff', timer: 1000, showConfirmButton: false });
        }

        function editMonthlyLimit() {
            Swal.fire({
                title: 'Set Monthly Budget',
                input: 'number',
                inputValue: appState.budget.limit,
                background: '#1E293B', color: '#fff',
                showCancelButton: true,
                confirmButtonText: 'Save',
                confirmButtonColor: '#6366F1'
            }).then((result) => {
                if (result.isConfirmed) {
                    appState.budget.limit = parseFloat(result.value);
                    saveState();
                    Swal.fire({ toast: true, position: 'top', icon: 'success', title: 'Limit Updated', background: '#1E293B', color: '#fff', timer: 1500, showConfirmButton: false });
                }
            })
        }

        // --- NEW WALLET TAB LOGIC ---

        // 1. Wallet Mini Chart
        let walletCategoryChart;
        walletCategoryChart = new ApexCharts(document.querySelector("#walletCategoryChart"), {
            chart: { type: 'donut', height: '100%', animations: { enabled: true } },
            series: [40, 25, 20, 15],
            labels: ['Food', 'Home', 'Fun', 'Other'],
            colors: ['#6366F1', '#EC4899', '#EAB308', '#22C55E'],
            legend: { show: false },
            dataLabels: { enabled: false },
            plotOptions: { donut: { size: '75%', labels: { show: false } } },
            stroke: { width: 0 }
        }); walletCategoryChart.render();

        const categoryMap = {
            'income': [
                { id: 'Salary', icon: 'banknote' },
                { id: 'Freelance', icon: 'laptop' },
                { id: 'Investments', icon: 'trending-up' },
                { id: 'Gift', icon: 'gift' },
                { id: 'Bonus', icon: 'award' },
                { id: 'Refund', icon: 'dollar-sign' },
                { id: 'Passive Income', icon: 'repeat' },
                { id: 'Other', icon: 'plus-circle' }
            ],
            'expense': [] // Managed dynamically via getBudgetCategoryDefinitions()
        };

        // Helper function to get transaction icon based on category and type
        function getTransactionIcon(category, type) {
            const catList = categoryMap[type] || [];
            const found = catList.find(c => c.id === category || c.id.toLowerCase() === category.toLowerCase());
            if (found) return found.icon;
            // Fallback icons
            return type === 'income' ? 'circle-dollar-sign' : 'receipt';
        }

        const iconMap = {
            'Needs': 'home',
            'Wants': 'star',
            'Saving': 'piggy-bank',
            'Investment': 'trending-up',
            'Debt': 'credit-card',
            'Waste': 'trash-2'
        };

        // --- BALANCE ACCOUNTS FUNCTIONS ---
        function updateBalanceDisplay() {
            if (!appState.balanceAccounts) {
                appState.balanceAccounts = { pocket: 0, bank: 0, credit: 0, loan: 0 };
            }

            document.getElementById('balance-pocket').innerText = formatCurrency(appState.balanceAccounts.pocket);
            document.getElementById('balance-bank').innerText = formatCurrency(appState.balanceAccounts.bank);
            document.getElementById('balance-credit').innerText = formatCurrency(appState.balanceAccounts.credit);
            document.getElementById('balance-loan').innerText = formatCurrency(appState.balanceAccounts.loan);

            const total = appState.balanceAccounts.pocket +
                appState.balanceAccounts.bank +
                appState.balanceAccounts.credit +
                appState.balanceAccounts.loan;

            document.getElementById('balance-total-breakdown').innerText = formatCurrency(total);

            // Update main balance display
            document.getElementById('w-net-balance').innerText = formatCurrency(total);
        }

        function editBalanceAccounts() {
            Swal.fire({
                title: 'Editar Cuentas',
                html: `
            <div class="space-y-4 text-left">
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-2 uppercase">Efectivo / Bolsillo</label>
                    <input type="number" id="edit-pocket" step="0.01" value="${appState.balanceAccounts.pocket}"
                        class="w-full bg-dark-900 border border-white/10 rounded-xl py-3 px-4 text-white font-mono focus:outline-none focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-2 uppercase">Banco / Débito</label>
                    <input type="number" id="edit-bank" step="0.01" value="${appState.balanceAccounts.bank}"
                        class="w-full bg-dark-900 border border-white/10 rounded-xl py-3 px-4 text-white font-mono focus:outline-none focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-2 uppercase">Crédito</label>
                    <input type="number" id="edit-credit" step="0.01" value="${appState.balanceAccounts.credit}"
                        class="w-full bg-dark-900 border border-white/10 rounded-xl py-3 px-4 text-white font-mono focus:outline-none focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-2 uppercase">Ahorro</label>
                    <input type="number" id="edit-loan" step="0.01" value="${appState.balanceAccounts.loan}"
                        class="w-full bg-dark-900 border border-white/10 rounded-xl py-3 px-4 text-white font-mono focus:outline-none focus:border-indigo-500">
                </div>
            </div>
        `,
                background: '#0F111A',
                color: '#fff',
                showCancelButton: true,
                confirmButtonText: 'Guardar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#6366F1',
                customClass: {
                    popup: 'rounded-3xl border border-white/10',
                    title: 'text-white font-bold',
                    htmlContainer: 'text-white'
                },
                preConfirm: () => {
                    return {
                        pocket: parseFloat(document.getElementById('edit-pocket').value) || 0,
                        bank: parseFloat(document.getElementById('edit-bank').value) || 0,
                        credit: parseFloat(document.getElementById('edit-credit').value) || 0,
                        loan: parseFloat(document.getElementById('edit-loan').value) || 0
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    appState.balanceAccounts = result.value;
                    saveState();
                    updateBalanceDisplay();
                    Swal.fire({
                        toast: true,
                        position: 'top',
                        icon: 'success',
                        title: 'Balance Actualizado',
                        background: '#1E293B',
                        color: '#fff',
                        showConfirmButton: false,
                        timer: 1500
                    });
                }
            });
        }

        function selectFocus(focusType) {
            document.getElementById('w-focus').value = focusType;

            const focusMap = {
                'Needs': { color: 'indigo', icon: 'home' },
                'Wants': { color: 'pink', icon: 'star' },
                'Saving': { color: 'emerald', icon: 'piggy-bank' },
                'Investment': { color: 'orange', icon: 'trending-up' },
                'Debt': { color: 'purple', icon: 'credit-card' },
                'Waste': { color: 'red', icon: 'trash-2' }
            };

            const allTypes = Object.keys(focusMap);

            allTypes.forEach(type => {
                const el = document.getElementById(`focus-${type}`);
                if (!el) return;

                if (type === focusType) {
                    // Active State
                    el.className = 'focus-item flex flex-col items-center justify-center p-2 rounded-xl border border-primary bg-primary/20 ring-1 ring-primary shadow-[0_0_10px_rgba(99,102,241,0.2)] cursor-pointer transition-all duration-200 scale-[0.98]';

                    // Update icon with active color
                    const icon = el.querySelector('i');
                    if (icon) {
                        icon.className = `w-4 h-4 mb-1 text-primary transition-colors`;
                        icon.setAttribute('data-lucide', focusMap[type].icon);
                    }

                    // Update text with active color
                    const span = el.querySelector('span');
                    if (span) {
                        span.className = 'text-[8px] uppercase font-bold text-primary transition-colors';
                    }
                } else {
                    // Inactive State
                    el.className = 'focus-item flex flex-col items-center justify-center p-2 rounded-xl border border-white/5 bg-dark-800 hover:bg-dark-700 cursor-pointer transition-all duration-200 group';

                    // Update icon with inactive color
                    const icon = el.querySelector('i');
                    if (icon) {
                        icon.className = `w-4 h-4 mb-1 text-slate-400 group-hover:text-slate-200 transition-colors`;
                        icon.setAttribute('data-lucide', focusMap[type].icon);
                    }

                    // Update text with inactive color
                    const span = el.querySelector('span');
                    if (span) {
                        span.className = 'text-[8px] uppercase font-bold text-slate-500 group-hover:text-slate-300 transition-colors';
                    }
                }
            });

            // Recreate Lucide icons
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        function updateWalletCategories() {
            const type = document.querySelector('input[name="w-type"]:checked').value;
            const grid = document.getElementById('category-grid');
            if (!grid) return;
            grid.innerHTML = '';

            let cats = (type === 'expense') ? getBudgetCategoryDefinitions() : categoryMap['income'];
            const hiddenInput = document.getElementById('w-category');
            if (hiddenInput && cats.length > 0) hiddenInput.value = cats[0].id; // Default first

            cats.forEach((c, idx) => {
                const btn = document.createElement('div');
                const isSelected = idx === 0;

                // Enhanced base styling with glassmorphism
                const baseClasses = 'flex flex-col items-center justify-center p-4 rounded-2xl cursor-pointer relative overflow-hidden group';
                const transitionClasses = 'transition-all duration-500 ease-out';
                const animationDelay = `style="animation-delay: ${idx * 50}ms;"`;

                btn.className = isSelected ?
                    `${baseClasses} ${transitionClasses} border-2 border-primary bg-gradient-to-br from-primary/20 via-primary/10 to-transparent backdrop-blur-sm shadow-lg shadow-primary/30 scale-105 animate-pulse-slow` :
                    `${baseClasses} ${transitionClasses} border border-white/10 bg-gradient-to-br from-white/5 to-transparent backdrop-blur-sm hover:border-primary/50 hover:shadow-xl hover:shadow-primary/20 hover:scale-105 hover:-translate-y-1 animate-fade-in-up`;

                btn.setAttribute('style', `animation-delay: ${idx * 50}ms;`);

                btn.onclick = () => {
                    if (hiddenInput) hiddenInput.value = c.id;

                    // Smooth visual toggle with staggered animations
                    Array.from(grid.children).forEach((ch, i) => {
                        ch.className = `${baseClasses} ${transitionClasses} border border-white/10 bg-gradient-to-br from-white/5 to-transparent backdrop-blur-sm hover:border-primary/50 hover:shadow-xl hover:shadow-primary/20 hover:scale-105 hover:-translate-y-1`;
                        ch.style.animationDelay = `${i * 30}ms`;

                        const icon = ch.querySelector('i') || ch.querySelector('svg');
                        if (icon) {
                            icon.className = 'w-6 h-6 mb-2 text-slate-400 transition-all duration-300 group-hover:scale-110 group-hover:rotate-3';
                        }
                        const span = ch.querySelector('span');
                        if (span) {
                            span.className = 'text-[9px] uppercase font-bold text-slate-500 tracking-widest transition-all duration-300';
                        }
                    });

                    // Highlight selected with premium effects
                    btn.className = `${baseClasses} ${transitionClasses} border-2 border-primary bg-gradient-to-br from-primary/20 via-primary/10 to-transparent backdrop-blur-sm shadow-lg shadow-primary/30 scale-105`;

                    const selectedIcon = btn.querySelector('i') || btn.querySelector('svg');
                    if (selectedIcon) {
                        selectedIcon.className = 'w-6 h-6 mb-2 text-primary transition-all duration-300 animate-bounce-soft';
                    }
                    const selectedSpan = btn.querySelector('span');
                    if (selectedSpan) {
                        selectedSpan.className = 'text-[9px] uppercase font-bold text-primary tracking-widest transition-all duration-300';
                    }

                    // Add selection pulse effect
                    btn.style.animation = 'pulse-select 0.6s ease-out';
                };

                btn.innerHTML = `
                    <!-- Animated gradient background overlay -->
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500 animate-shimmer"></div>
                    
                    <!-- Glow effect on hover -->
                    <div class="absolute -inset-1 bg-gradient-to-r from-primary/20 to-purple-500/20 rounded-2xl blur-lg opacity-0 group-hover:opacity-75 transition-all duration-500"></div>
                    
                    <!-- Icon with enhanced animations -->
                    <i data-lucide="${c.icon}" class="w-6 h-6 mb-2 ${isSelected ? 'text-primary animate-bounce-soft' : 'text-slate-400'} transition-all duration-300 relative z-10 group-hover:scale-110 group-hover:rotate-3"></i>
                    
                    <!-- Label with gradient on hover -->
                    <span class="text-[9px] uppercase font-bold ${isSelected ? 'text-primary' : 'text-slate-500'} tracking-widest transition-all duration-300 relative z-10 group-hover:text-white">${c.id}</span>
                `;
                grid.appendChild(btn);
            });

            // Add custom keyframe animations
            if (!document.getElementById('category-animations')) {
                const style = document.createElement('style');
                style.id = 'category-animations';
                style.textContent = `
                    @keyframes fade-in-up {
                        from {
                            opacity: 0;
                            transform: translateY(20px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                    @keyframes pulse-slow {
                        0%, 100% { opacity: 1; }
                        50% { opacity: 0.8; }
                    }
                    @keyframes bounce-soft {
                        0%, 100% { transform: translateY(0); }
                        50% { transform: translateY(-4px); }
                    }
                    @keyframes shimmer {
                        0% { transform: translateX(-100%); }
                        100% { transform: translateX(100%); }
                    }
                    @keyframes pulse-select {
                        0%, 100% { transform: scale(1.05); }
                        50% { transform: scale(1.15); }
                    }
                    .animate-fade-in-up {
                        animation: fade-in-up 0.6s ease-out forwards;
                        opacity: 0;
                    }
                    .animate-pulse-slow {
                        animation: pulse-slow 3s ease-in-out infinite;
                    }
                    .animate-bounce-soft {
                        animation: bounce-soft 2s ease-in-out infinite;
                    }
                    .animate-shimmer {
                        animation: shimmer 3s ease-in-out infinite;
                    }
                `;
                document.head.appendChild(style);
            }

            lucide.createIcons();

            // Allow Budget Focus for both now
            const focusContainer = document.getElementById('budget-focus-container');
            if (focusContainer) focusContainer.classList.remove('hidden');
        }


        // --- MONTHLY COMPARISON LOGIC ---
        function updateMonthlyTotals() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // Previous Month Logic
            let prevMonth = currentMonth - 1;
            let prevYear = currentYear;
            if (prevMonth < 0) {
                prevMonth = 11;
                prevYear = currentYear - 1;
            }

            let curInc = 0, curExp = 0;
            let prevInc = 0, prevExp = 0;

            if (appState.transactions) {
                appState.transactions.forEach(t => {
                    // Robust Date Parsing
                    let raw = t.dateIso || t.id;
                    if (typeof raw === 'string' && raw.length === 10) raw += 'T12:00:00';
                    const d = new Date(raw);
                    if (isNaN(d.getTime())) return;

                    // Current Month
                    if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                        if (t.type === 'income') curInc += t.amount;
                        if (t.type === 'expense') curExp += t.amount;
                    }

                    // Previous Month
                    if (d.getMonth() === prevMonth && d.getFullYear() === prevYear) {
                        if (t.type === 'income') prevInc += t.amount;
                        if (t.type === 'expense') prevExp += t.amount;
                    }
                });
            }

            // Update Main Cards
            const elInc = document.getElementById('monthly-income');
            const elExp = document.getElementById('monthly-expenses');
            const elNet = document.getElementById('w-net-balance');

            if (elInc) elInc.innerText = formatCurrency(curInc);
            if (elExp) elExp.innerText = formatCurrency(curExp);
            if (elNet) elNet.innerText = formatCurrency(curInc - curExp);

            // Variation Logic
            const updateVar = (elId, current, previous, isExpense) => {
                const el = document.getElementById(elId);
                if (!el) return;

                let pct = 0;
                if (previous > 0) {
                    pct = ((current - previous) / previous) * 100;
                } else if (current > 0) {
                    pct = 100;
                }

                const absPct = Math.abs(pct).toFixed(0);
                let icon = '';
                let colorClass = '';

                const isIncrease = pct >= 0;

                if (isExpense) {
                    // Expense: Up = Bad (Red), Down = Good (Green)
                    if (isIncrease) { // Bad
                        colorClass = 'text-rose-400 bg-rose-500/10 border-rose-500/20';
                        icon = 'trending-up';
                    } else { // Good
                        colorClass = 'text-emerald-400 bg-emerald-500/10 border-emerald-500/20';
                        icon = 'trending-down';
                    }
                } else {
                    // Income: Up = Good (Green), Down = Bad (Red)
                    if (isIncrease) { // Good
                        colorClass = 'text-emerald-400 bg-emerald-500/10 border-emerald-500/20';
                        icon = 'trending-up';
                    } else { // Bad
                        colorClass = 'text-rose-400 bg-rose-500/10 border-rose-500/20';
                        icon = 'trending-down';
                    }
                }

                if (current === 0 && previous === 0) {
                    colorClass = 'text-slate-400 bg-slate-500/10 border-slate-500/20';
                    icon = 'minus';
                }

                el.className = `text-sm font-bold px-2 py-0.5 rounded-lg border flex items-center gap-1 ${colorClass}`;
                el.innerHTML = `<i data-lucide="${icon}" class="w-3 h-3"></i> ${absPct}%`;
            };

            updateVar('inc-variation', curInc, prevInc, false);
            updateVar('exp-variation', curExp, prevExp, true);

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // Init on load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(updateMonthlyTotals, 1000);
        });

        function addWalletTransaction() {
            const type = document.querySelector('input[name="w-type"]:checked').value;
            const amt = parseFloat(document.getElementById('w-amount').value);
            const desc = document.getElementById('w-desc').value;
            const cat = document.getElementById('w-category').value;
            const focus = document.getElementById('w-focus').value;
            const dateInput = document.getElementById('w-date').value;

            if (!amt || !desc) {
                Swal.fire({
                    toast: true, position: 'top', icon: 'error', title: 'Por favor ingresa monto y descripción',
                    background: '#1E293B', color: '#fff', showConfirmButton: false, timer: 2000
                });
                return;
            }

            if (!cat) {
                Swal.fire({
                    toast: true, position: 'top', icon: 'error', title: 'Por favor selecciona una categoría',
                    background: '#1E293B', color: '#fff', showConfirmButton: false, timer: 2000
                });
                return;
            }

            // Find Icon
            let icon = 'circle';
            const catList = categoryMap[type];
            const found = catList.find(c => c.id === cat);
            if (found) icon = found.icon;

            // Use selected date or current date
            let transactionDate = new Date();
            let dateIso = '';
            if (dateInput) {
                transactionDate = new Date(dateInput);
                dateIso = dateInput;
            } else {
                dateIso = transactionDate.toISOString().split('T')[0];
            }

            const newT = {
                id: transactionDate.getTime(), // Use transaction date as ID
                name: desc,
                amount: amt,
                type: type,
                category: cat,
                date: transactionDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                dateIso: dateIso, // Store ISO date for proper filtering
                icon: icon,
                budgetFocus: focus
            };

            appState.transactions.unshift(newT);

            // Update balance based on transaction type
            if (!appState.balanceAccounts) {
                appState.balanceAccounts = { pocket: 0, bank: 0, credit: 0, loan: 0 };
            }

            // Add to pocket balance (you can modify this to ask which account to use)
            if (type === 'income') {
                appState.balanceAccounts.pocket += amt;
            } else if (type === 'expense') {
                appState.balanceAccounts.pocket -= amt;
            }

            saveState(); // Will trigger renderAll -> renderWalletHistory

            // Disable button to prevent double-submit
            const submitBtn = document.getElementById('add-transaction-btn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="animate-spin lucide lucide-loader-2 w-5 h-5"></i> Procesando...';
            }

            // Show success message with amount
            Swal.fire({
                toast: true,
                position: 'top',
                icon: 'success',
                title: `${type === 'income' ? '+' : '-'}${formatCurrency(amt)} agregado`,
                background: '#1E293B',
                color: '#fff',
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: true
            });

            // Reset form
            resetWalletForm();

            // Refresh entire wallet view
            if (typeof refreshWalletView === 'function') {
                refreshWalletView();
            }

            // Scroll to top of history to see new transaction
            setTimeout(() => {
                const historyList = document.getElementById('wallet-history-list');
                if (historyList) {
                    historyList.scrollTop = 0;
                }

                // Re-enable button
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'AGREGAR <i data-lucide="check" class="w-4 h-4 ml-2"></i>';
                    if (typeof lucide !== 'undefined' && lucide.createIcons) {
                        lucide.createIcons();
                    }
                }
            }, 650); // Slightly longer than refresh delay to ensure safety
        }


        function resetWalletForm() {
            // Clear text inputs
            document.getElementById('w-amount').value = '';
            document.getElementById('w-desc').value = '';
            document.getElementById('w-date').value = '';
            document.getElementById('w-category').value = '';

            // Deselect all category buttons
            const categoryButtons = document.querySelectorAll('.category-btn');
            categoryButtons.forEach(btn => {
                btn.classList.remove('ring-2', 'ring-primary', 'bg-primary/20', 'scale-105');
                btn.classList.add('bg-white/5');
            });

            // Reset to income type
            document.getElementById('wt-income').checked = true;
            document.getElementById('wt-expense').checked = false;

            // Reset focus to Wants
            selectFocus('Wants');

            // Refresh categories for income
            if (typeof updateWalletCategories === 'function') {
                updateWalletCategories();
            }
        }

        // Centralized Wallet Refresh Function - IDENCTICAL TO TAB SWITCH
        function refreshWalletView() {
            console.log('🔄 Refreshing Wallet View (Sync with Tab Switch)...');

            // 1. Reset Filters (matches switchTab behavior)
            if (typeof filterWallet === 'function') filterWallet('today');

            // 2. Update Header & Data
            if (typeof updateWalletHeaderDate === 'function') updateWalletHeaderDate();
            if (typeof renderWalletHistory === 'function') renderWalletHistory();
            if (typeof populateWalletCategories === 'function') populateWalletCategories();
            if (typeof updateBalanceDisplay === 'function') updateBalanceDisplay();
            if (typeof updateMonthlyTotals === 'function') updateMonthlyTotals();
            if (typeof updateFocusStats === 'function') updateFocusStats();

            // 3. Re-render Chart with Retries (Crucial for animation "repair" effect)
            if (typeof renderWalletWeeklyChart === 'function') {
                // Destroy existing to force re-animation if needed, or just update
                // switchTab just calls it, so we call it.
                renderWalletWeeklyChart();

                // Retries to ensure layout is settled and animation plays
                setTimeout(renderWalletWeeklyChart, 300);
                setTimeout(renderWalletWeeklyChart, 800);
            }

            // 4. Update Category Chart (Extra safe check)
            if (typeof walletCategoryChart !== 'undefined' && walletCategoryChart) {
                const catMap = {};
                if (appState && appState.transactions) {
                    appState.transactions.forEach(t => {
                        catMap[t.category] = (catMap[t.category] || 0) + t.amount;
                    });
                }
                const sortedCats = Object.entries(catMap).sort((a, b) => b[1] - a[1]).slice(0, 5);
                const labels = sortedCats.map(x => x[0]);
                const data = sortedCats.map(x => x[1]);

                if (data.length === 0) {
                    walletCategoryChart.updateOptions({ labels: ['No Data'] });
                    walletCategoryChart.updateSeries([1]);
                } else {
                    walletCategoryChart.updateOptions({ labels: labels });
                    walletCategoryChart.updateSeries(data);
                }
            }

            // 5. Recreate Icons
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }

            console.log('✅ Wallet View Refreshed (Instant)');
        }
        // Update monthly totals for current month
        function updateMonthlyTotals() {
            const now = new Date();
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const currentMonth = monthNames[now.getMonth()];
            const currentYear = now.getFullYear();

            // Update labels
            const incomeLabel = document.getElementById('monthly-income-label');
            const expensesLabel = document.getElementById('monthly-expenses-label');
            if (incomeLabel) incomeLabel.innerText = `${currentMonth} ${currentYear}`;
            if (expensesLabel) expensesLabel.innerText = `${currentMonth} ${currentYear}`;

            // Calculate totals for current month
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
            const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59).getTime();

            let totalIncome = 0;
            let totalExpenses = 0;

            if (appState && appState.transactions) {
                appState.transactions.forEach(t => {
                    // Check if transaction is in current month
                    if (t.id >= monthStart && t.id <= monthEnd) {
                        if (t.type === 'income') {
                            totalIncome += t.amount;
                        } else if (t.type === 'expense') {
                            totalExpenses += t.amount;
                        }
                    }
                });
            }

            // Update display
            const incomeEl = document.getElementById('monthly-income');
            const expensesEl = document.getElementById('monthly-expenses');

            if (incomeEl) incomeEl.innerText = formatCurrency(totalIncome);
            if (expensesEl) expensesEl.innerText = formatCurrency(totalExpenses);
        }

        // Quick delete transaction function
        function deleteTransactionQuick(transactionId) {
            // Robust ID Comparison
            const transaction = appState.transactions.find(t => String(t.id) === String(transactionId));

            if (!transaction) {
                console.error("Delete Error: Transaction not found", transactionId);
                return;
            }

            Swal.fire({
                title: '¿Eliminar transacción?',
                html: `
                    <div class="text-left space-y-2">
                        <p class="text-slate-400"><strong class="text-white">${transaction.name}</strong></p>
                        <p class="text-slate-400">${transaction.type === 'income' ? '+' : '-'}${formatCurrency(transaction.amount)}</p>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Eliminar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#EF4444',
                cancelButtonColor: '#64748B',
                background: '#0F111A',
                color: '#fff',
                customClass: {
                    popup: 'rounded-3xl border border-white/10'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // Adjust balance before deleting
                    if (!appState.balanceAccounts) {
                        appState.balanceAccounts = { pocket: 0, bank: 0, credit: 0, loan: 0 };
                    }

                    // Reverse the transaction effect on balance
                    if (transaction.type === 'income') {
                        appState.balanceAccounts.pocket -= transaction.amount;
                    } else if (transaction.type === 'expense') {
                        appState.balanceAccounts.pocket += transaction.amount;
                    }

                    // Remove transaction
                    appState.transactions = appState.transactions.filter(t => String(t.id) !== String(transactionId));
                    saveState();

                    // Refresh entire wallet view
                    if (typeof refreshWalletView === 'function') {
                        refreshWalletView();
                    }

                    Swal.fire({
                        toast: true,
                        position: 'top',
                        icon: 'success',
                        title: 'Transacción eliminada',
                        background: '#1E293B',
                        color: '#fff',
                        showConfirmButton: false,
                        timer: 2000
                    });
                }
            });
        }

        let walletFilter = 'all'; // all, income, expense
        let walletTimeFilter = 'month'; // month, week, day
        let walletFocusFilter = null;
        let walletCategoryFilter = null; // New Global
        let walletTargetMonth = null; // New Global for Custom Month Picker

        // --- FILTERING LOGIC ---

        function filterTime(period) {
            walletTimeFilter = period;

            // Visual Reset Time Buttons
            const btnMonth = document.getElementById('btn-time-month');
            const btnWeek = document.getElementById('btn-time-week');
            const btnDay = document.getElementById('btn-time-day');

            // Defaults
            if (btnMonth) btnMonth.className = "text-[10px] bg-indigo-500/20 text-indigo-300 hover:bg-indigo-500 hover:text-white px-3 py-1.5 rounded-lg transition font-bold border border-indigo-500/30 flex items-center gap-2";
            if (btnWeek) btnWeek.className = "text-[10px] bg-transparent text-slate-400 hover:text-white px-3 py-1.5 rounded-lg transition font-bold hover:bg-white/5";
            if (btnDay) btnDay.className = "text-[10px] bg-transparent text-slate-400 hover:text-white px-3 py-1.5 rounded-lg transition font-bold hover:bg-white/5";

            // Active State
            if (period === 'month' && btnMonth) {
                btnMonth.classList.remove('bg-indigo-500/20', 'text-indigo-300');
                btnMonth.classList.add('bg-indigo-500', 'text-white', 'shadow-lg', 'shadow-indigo-500/30');
            } else if (period === 'week' && btnWeek) {
                btnWeek.classList.remove('bg-transparent', 'text-slate-400');
                btnWeek.classList.add('bg-slate-700', 'text-white', 'shadow-lg');
            } else if (period === 'day' && btnDay) {
                btnDay.classList.remove('bg-transparent', 'text-slate-400');
                btnDay.classList.add('bg-slate-700', 'text-white', 'shadow-lg');
            }

            // AUTO-RESET TYPE TO 'ALL' (User Feedback Requirement)
            // When changing time, show EVERYTHING (Income + Expense)
            walletFilter = 'all';

            // Visual Update for Type Buttons
            document.getElementById('btn-type-all').className = "text-[10px] bg-white text-black px-3 py-1.5 rounded-lg transition font-bold shadow-lg shadow-white/10";
            document.getElementById('btn-type-income').className = "text-[10px] bg-transparent text-emerald-400 hover:bg-emerald-500/10 px-3 py-1.5 rounded-lg transition font-bold";
            document.getElementById('btn-type-expense').className = "text-[10px] bg-transparent text-rose-400 hover:bg-rose-500/10 px-3 py-1.5 rounded-lg transition font-bold";

            renderWalletHistory();
        }

        function filterWallet(type) {
            walletFilter = type;
            // Removed automatic reset of Focus/Category filters to allow intersection

            // Visual Update
            const btns = {
                'all': 'btn-type-all',
                'income': 'btn-type-income',
                'expense': 'btn-type-expense'
            };

            // Reset
            document.getElementById('btn-type-all').className = "text-[10px] bg-transparent text-slate-400 hover:text-white px-3 py-1.5 rounded-lg transition font-bold";
            document.getElementById('btn-type-income').className = "text-[10px] bg-transparent text-emerald-400 hover:bg-emerald-500/10 px-3 py-1.5 rounded-lg transition font-bold";
            document.getElementById('btn-type-expense').className = "text-[10px] bg-transparent text-rose-400 hover:bg-rose-500/10 px-3 py-1.5 rounded-lg transition font-bold";

            // Active
            if (type === 'all') document.getElementById('btn-type-all').className = "text-[10px] bg-white text-black px-3 py-1.5 rounded-lg transition font-bold shadow-lg shadow-white/10";
            if (type === 'income') document.getElementById('btn-type-income').className = "text-[10px] bg-emerald-500 text-white px-3 py-1.5 rounded-lg transition font-bold shadow-lg shadow-emerald-500/30";
            if (type === 'expense') document.getElementById('btn-type-expense').className = "text-[10px] bg-rose-500 text-white px-3 py-1.5 rounded-lg transition font-bold shadow-lg shadow-rose-500/30";

            renderWalletHistory();
        }

        // --- GLOBAL CONFIGURATION (Architecture Improvement) ---
        const budgetFocusConfig = {
            'Needs': { icon: 'home', color: 'text-indigo-400', bg: 'bg-indigo-400/10', border: 'border-indigo-400/20', baseColor: 'indigo' },
            'Wants': { icon: 'star', color: 'text-pink-400', bg: 'bg-pink-400/10', border: 'border-pink-400/20', baseColor: 'pink' },
            'Save': { icon: 'piggy-bank', color: 'text-emerald-400', bg: 'bg-emerald-400/10', border: 'border-emerald-400/20', baseColor: 'emerald' },
            'Investment': { icon: 'trending-up', color: 'text-orange-400', bg: 'bg-orange-400/10', border: 'border-orange-400/20', baseColor: 'orange' },
            'Debt': { icon: 'credit-card', color: 'text-slate-400', bg: 'bg-slate-400/10', border: 'border-slate-400/20', baseColor: 'slate' },
            'Waste': { icon: 'trash-2', color: 'text-red-400', bg: 'bg-red-400/10', border: 'border-red-400/20', baseColor: 'red' },
            // Fallback
            'Other': { icon: 'tag', color: 'text-slate-400', bg: 'bg-slate-400/10', border: 'border-slate-400/20', baseColor: 'slate' }
        };

        // --- PREMIUM CATEGORY FILTER ARCHITECTURE (Rebuilt) ---

        // 1. Reliable Closer Function
        window.selectCategoryAndClose = function (category) {
            // Logic
            if (typeof filterCategory === 'function') {
                filterCategory(category);
            }
            // UI Feedback (optional, but instant close is requested)

            // Force Close
            if (typeof Swal !== 'undefined') Swal.close();
        };

        function openCategoryFilter() {
            // 2. Master Data Source
            const incomeCategories = [
                'Salary', 'Freelance', 'Investments', 'Gift',
                'Bonus', 'Refund', 'Passive Income', 'Other'
            ];

            const expenseCategories = [
                'Food', 'Groceries', 'Housing', 'Transport',
                'Entertainment', 'Shopping', 'Health', 'Education',
                'Travel', 'Beer', 'Junk Food', 'Weed',
                'Love', 'Gas', 'Others'
            ];

            // 3. Icon Mapping System
            const getIcon = (c) => {
                const lower = c.toLowerCase();
                const map = {
                    // Income
                    'salary': 'banknote',
                    'freelance': 'laptop',
                    'investments': 'trending-up',
                    'gift': 'gift',
                    'bonus': 'award',
                    'refund': 'dollar-sign',
                    'passive income': 'repeat',
                    'other': 'plus-circle',
                    // Expenses
                    'food': 'utensils',
                    'groceries': 'shopping-cart',
                    'housing': 'home',
                    'transport': 'bus',
                    'entertainment': 'clapperboard',
                    'shopping': 'shopping-bag',
                    'health': 'heart-pulse',
                    'education': 'graduation-cap',
                    'travel': 'plane',
                    'beer': 'beer',
                    'junk food': 'pizza',
                    'weed': 'leaf',
                    'love': 'heart',
                    'gas': 'fuel',
                    'others': 'tag'
                };
                for (const key in map) {
                    if (lower === key || lower.includes(key)) return map[key];
                }
                return 'tag';
            };

            // New: Unique Color Mapping
            const getCategoryColor = (c) => {
                const lower = c.toLowerCase();
                // Income Colors
                if (lower.includes('salary')) return 'emerald';
                if (lower.includes('freelance')) return 'blue';
                if (lower.includes('investments')) return 'indigo';
                if (lower.includes('gift')) return 'pink';
                if (lower.includes('bonus')) return 'amber';
                if (lower.includes('refund')) return 'teal';
                if (lower.includes('passive')) return 'cyan';
                if (lower === 'other') return 'slate';

                // Expense Colors
                if (lower.includes('junk')) return 'red';
                if (lower.includes('food')) return 'orange';
                if (lower.includes('groceries')) return 'lime';
                if (lower.includes('housing')) return 'blue';
                if (lower.includes('transport')) return 'cyan';
                if (lower.includes('entertainment')) return 'purple';
                if (lower.includes('shopping')) return 'pink';
                if (lower.includes('health')) return 'emerald';
                if (lower.includes('education')) return 'sky';
                if (lower.includes('travel')) return 'yellow';
                if (lower.includes('beer')) return 'amber';
                if (lower.includes('weed')) return 'green';
                if (lower.includes('love')) return 'rose';
                if (lower.includes('gas')) return 'slate';

                return 'indigo'; // default
            };

            // Helper to render grid items
            const renderGridItems = (cats, delayOffset = 0) => {
                let itemsHtml = '';

                // Color Definitions
                const colors = {
                    'orange': { bg: 'bg-orange-500/10', text: 'text-orange-400', border: 'group-hover:border-orange-500/30' },
                    'lime': { bg: 'bg-lime-500/10', text: 'text-lime-400', border: 'group-hover:border-lime-500/30' },
                    'blue': { bg: 'bg-blue-500/10', text: 'text-blue-400', border: 'group-hover:border-blue-500/30' },
                    'cyan': { bg: 'bg-cyan-500/10', text: 'text-cyan-400', border: 'group-hover:border-cyan-500/30' },
                    'purple': { bg: 'bg-purple-500/10', text: 'text-purple-400', border: 'group-hover:border-purple-500/30' },
                    'pink': { bg: 'bg-pink-500/10', text: 'text-pink-400', border: 'group-hover:border-pink-500/30' },
                    'emerald': { bg: 'bg-emerald-500/10', text: 'text-emerald-400', border: 'group-hover:border-emerald-500/30' },
                    'sky': { bg: 'bg-sky-500/10', text: 'text-sky-400', border: 'group-hover:border-sky-500/30' },
                    'yellow': { bg: 'bg-yellow-500/10', text: 'text-yellow-400', border: 'group-hover:border-yellow-500/30' },
                    'amber': { bg: 'bg-amber-500/10', text: 'text-amber-400', border: 'group-hover:border-amber-500/30' },
                    'red': { bg: 'bg-red-500/10', text: 'text-red-400', border: 'group-hover:border-red-500/30' },
                    'green': { bg: 'bg-green-500/10', text: 'text-green-400', border: 'group-hover:border-green-500/30' },
                    'rose': { bg: 'bg-rose-500/10', text: 'text-rose-400', border: 'group-hover:border-rose-500/30' },
                    'slate': { bg: 'bg-slate-500/10', text: 'text-slate-400', border: 'group-hover:border-slate-500/30' },
                    'indigo': { bg: 'bg-indigo-500/10', text: 'text-indigo-400', border: 'group-hover:border-indigo-500/30' },
                    'teal': { bg: 'bg-teal-500/10', text: 'text-teal-400', border: 'group-hover:border-teal-500/30' },
                };

                cats.forEach((c, idx) => {
                    const isActive = walletCategoryFilter === c;
                    const icon = getIcon(c);
                    const colorKey = getCategoryColor(c);
                    const theme = colors[colorKey] || colors['indigo'];
                    const delay = (idx * 30) + delayOffset;

                    let containerClass = isActive
                        ? `bg-dark-800 border-2 border-${colorKey}-500 shadow-[0_0_20px_-5px_rgba(0,0,0,0.5)]`
                        : `bg-[#161822] border border-white/5 hover:bg-[#1a1d29] ${theme.border}`;

                    itemsHtml += `
                     <button onclick="selectCategoryAndClose('${c.replace(/'/g, "\\'")}')" 
                        style="animation: fadeUp 0.4s forwards ${delay}ms; opacity: 0;"
                        class="${containerClass} cursor-pointer rounded-2xl transition-all duration-300 flex flex-col items-center justify-center gap-3 p-3 h-[110px] group relative active:scale-95 shadow-lg">
                        
                        <!-- Icon Bubble -->
                        <div class="w-10 h-10 rounded-xl ${theme.bg} ${theme.text} flex items-center justify-center transition-transform duration-300 group-hover:scale-110 shadow-inner">
                            <i data-lucide="${icon}" class="w-5 h-5 stroke-[2]"></i>
                        </div>
                        
                        <span class="text-[10px] font-bold uppercase tracking-wider truncate w-full text-center select-none ${isActive ? 'text-white' : 'text-slate-400 group-hover:text-slate-200'} transition-colors">${c}</span>
                        
                        <!-- Active Indicator Dot -->
                        ${isActive ? `<div class="absolute top-2 right-2 w-1.5 h-1.5 rounded-full bg-${colorKey}-500 shadow-[0_0_5px_currentColor]"></div>` : ''}
                     </button>`;
                });
                return itemsHtml;
            };

            // 4. Component Construction

            // -- Header --
            let html = `
            <div class="flex items-center justify-between px-8 pt-8 pb-4 select-none relative z-10">
                <div class="flex items-center gap-5">
                    <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-[#1e1b2e] to-[#161822] border border-white/10 flex items-center justify-center shadow-lg shadow-indigo-500/10 group">
                        <i data-lucide="filter" class="w-5 h-5 text-indigo-400 group-hover:rotate-180 transition-transform duration-500"></i>
                    </div>
                    <div class="flex flex-col items-start">
                        <h3 class="text-xl font-black text-white tracking-tight leading-none mb-1">Filtrar</h3>
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em]">Selecciona Categoría</p>
                    </div>
                </div>
                <button onclick="Swal.close()" class="w-9 h-9 rounded-xl flex items-center justify-center bg-white/5 hover:bg-white/10 text-slate-400 hover:text-white border border-white/5 transition-all duration-300">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            
            <div class="px-4 pb-2 space-y-4 relative z-10">
                <!-- All Categories Button -->
                <button onclick="selectCategoryAndClose(null)"
                    class="w-full py-3.5 px-4 rounded-2xl bg-[#161822] hover:bg-[#1c202e] border border-white/5 hover:border-indigo-500/30 transition-all duration-300 group flex items-center justify-center gap-3 shadow-lg active:scale-[0.98]">
                    <i data-lucide="layout-grid" class="w-4 h-4 text-slate-400 group-hover:text-indigo-400 transition-colors"></i>
                    <span class="text-[10px] font-bold text-slate-300 uppercase tracking-widest group-hover:text-white transition-colors">Mostrar Todo</span>
                </button>
            </div>

            <!-- Scrollable Content -->
            <div class="px-4 pb-6 space-y-6 max-h-[480px] overflow-y-auto custom-scrollbar">
                
                <!-- INCOME SECTION -->
                <div>
                    <div class="flex items-center gap-3 mb-3 px-1">
                        <div class="h-px flex-1 bg-gradient-to-r from-emerald-500/50 to-transparent opacity-30"></div>
                        <span class="text-[10px] font-black text-emerald-500/80 uppercase tracking-widest">Ingresos</span>
                        <div class="h-px flex-1 bg-gradient-to-l from-emerald-500/50 to-transparent opacity-30"></div>
                    </div>
                    <div class="grid grid-cols-4 gap-3">
                        ${renderGridItems(incomeCategories, 0)}
                    </div>
                </div>

                <!-- EXPENSES SECTION -->
                <div>
                    <div class="flex items-center gap-3 mb-3 px-1 mt-2">
                        <div class="h-px flex-1 bg-gradient-to-r from-red-500/50 to-transparent opacity-30"></div>
                        <span class="text-[10px] font-black text-red-500/80 uppercase tracking-widest">Gastos</span>
                         <div class="h-px flex-1 bg-gradient-to-l from-red-500/50 to-transparent opacity-30"></div>
                    </div>
                    <div class="grid grid-cols-4 gap-3">
                        ${renderGridItems(expenseCategories, 200)}
                    </div>
                </div>
                
                <!-- Fade overlay at bottom -->
                <div class="h-6"></div> 
            </div>`;

            // 5. Render
            Swal.fire({
                html: html,
                background: '#0b0d10',
                showConfirmButton: false,
                showCloseButton: false,
                width: '600px',
                padding: '0',
                backdrop: `rgba(0,0,0,0.85) backdrop-blur-md`,
                customClass: {
                    popup: 'rounded-[2.5rem] border border-white/10 shadow-2xl !overflow-hidden animate-scale-in glass-panel',
                    htmlContainer: '!overflow-hidden !m-0 !p-0'
                },
                didOpen: () => {
                    lucide.createIcons();
                    // Force close on any button click
                    const container = Swal.getHtmlContainer();
                    if (container) {
                        const buttons = container.querySelectorAll('button');
                        buttons.forEach(b => {
                            b.addEventListener('click', () => {
                                setTimeout(() => Swal.close(), 100);
                            });
                        });
                    }
                }
            });
        }


        // Wrapper to handle closing - Explicitly Global
        window.selectCategoryFilter = function (cat) {
            if (typeof filterCategory === 'function') filterCategory(cat);

            // Close SweetAlert immediately
            if (typeof Swal !== 'undefined') Swal.close();

            // Fallback if it was a custom modal (though we used Swal)
            const modal = document.querySelector('.swal2-container');
            if (modal) modal.click(); // Dispatch click to overlay if Swal.close fails
        };
        window.selectFocusFilter = function (f) {
            filterFocus(f);
            Swal.close();
        };

        function filterCategory(cat) {
            walletCategoryFilter = cat;
            // Update Label
            const lbl = document.getElementById('lbl-filter-cat');
            const btn = document.getElementById('btn-filter-cat');
            if (lbl && btn) {
                if (cat) {
                    lbl.innerText = cat.substring(0, 5) + (cat.length > 5 ? '..' : '');
                    btn.classList.add('bg-white/10', 'text-white');
                    btn.classList.remove('text-slate-400');
                } else {
                    lbl.innerText = 'Cat.';
                    btn.classList.remove('bg-white/10', 'text-white');
                    btn.classList.add('text-slate-400');
                }
            }
            renderWalletHistory();
        }

        function openFocusFilter() {
            const focuses = ['Needs', 'Wants', 'Save', 'Investment', 'Debt', 'Waste'];

            // Icon Mapping (Fallback/Override for visual consistency)
            const getFocusIcon = (f) => {
                const map = {
                    'Needs': 'home',
                    'Wants': 'star',
                    'Save': 'piggy-bank',
                    'Investment': 'trending-up',
                    'Debt': 'credit-card',
                    'Waste': 'trash-2'
                };
                return map[f] || 'circle';
            };

            // Color Mapping
            const getFocusColor = (f) => {
                const map = {
                    'Needs': 'blue',
                    'Wants': 'pink',
                    'Save': 'emerald',
                    'Investment': 'purple',
                    'Debt': 'amber', // Orange-ish
                    'Waste': 'red'
                };
                return map[f] || 'slate';
            };

            // -- Header --
            let html = `
            <div class="flex items-center justify-between px-8 pt-8 pb-4 select-none relative z-10">
                <div class="flex items-center gap-5">
                    <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-[#1e1b2e] to-[#161822] border border-white/10 flex items-center justify-center shadow-lg shadow-indigo-500/10 group">
                        <i data-lucide="target" class="w-6 h-6 text-indigo-400 group-hover:scale-110 transition-transform duration-300"></i>
                    </div>
                    <div class="flex flex-col items-start">
                        <h3 class="text-xl font-black text-white tracking-tight leading-none mb-1">Focus</h3>
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em]">Selecciona Objetivo</p>
                    </div>
                </div>
                <button onclick="Swal.close()" class="w-10 h-10 rounded-xl flex items-center justify-center bg-white/5 hover:bg-white/10 text-slate-400 hover:text-white border border-white/5 transition-all duration-300 transform hover:rotate-90">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="p-4 space-y-4 relative z-10">`;

            // -- "All Focus" Action --
            html += `
            <div class="px-2">
                <button onclick="selectFocusFilter(null)"
                    class="w-full py-4 px-4 rounded-2xl bg-[#161b22]/80 hover:bg-[#1c222b] border border-white/5 hover:border-indigo-500/50 transition-all duration-300 group flex items-center justify-center gap-4 shadow-lg hover:shadow-indigo-500/10 active:scale-[0.98]">
                    <div class="w-8 h-8 rounded-lg bg-[#0b0d10] border border-white/5 text-slate-400 group-hover:text-indigo-400 group-hover:bg-indigo-500/10 flex items-center justify-center group-hover:scale-110 transition-all duration-300">
                        <i data-lucide="layers" class="w-4 h-4"></i>
                    </div>
                    <span class="text-[11px] font-bold text-slate-300 uppercase tracking-widest group-hover:text-white transition-colors">Todos los Focus</span>
                </button>
            </div>`;

            // -- Grid --
            html += `<div class="grid grid-cols-2 gap-3 px-2 pb-4">`;

            // Color Theme Map
            const colors = {
                'blue': { t: 'text-blue-400', b: 'border-blue-500', bg: 'bg-blue-500/10', h: 'group-hover:text-blue-300', g: 'from-blue-500/20 to-transparent' },
                'pink': { t: 'text-pink-400', b: 'border-pink-500', bg: 'bg-pink-500/10', h: 'group-hover:text-pink-300', g: 'from-pink-500/20 to-transparent' },
                'emerald': { t: 'text-emerald-400', b: 'border-emerald-500', bg: 'bg-emerald-500/10', h: 'group-hover:text-emerald-300', g: 'from-emerald-500/20 to-transparent' },
                'purple': { t: 'text-purple-400', b: 'border-purple-500', bg: 'bg-purple-500/10', h: 'group-hover:text-purple-300', g: 'from-purple-500/20 to-transparent' },
                'amber': { t: 'text-amber-400', b: 'border-amber-500', bg: 'bg-amber-500/10', h: 'group-hover:text-amber-300', g: 'from-amber-500/20 to-transparent' },
                'red': { t: 'text-red-400', b: 'border-red-500', bg: 'bg-red-500/10', h: 'group-hover:text-red-300', g: 'from-red-500/20 to-transparent' },
                'slate': { t: 'text-slate-400', b: 'border-slate-500', bg: 'bg-slate-500/10', h: 'group-hover:text-slate-300', g: 'from-slate-500/20 to-transparent' },
            };

            focuses.forEach((f, idx) => {
                const isActive = walletFocusFilter === f;
                const icon = getFocusIcon(f);
                const colorKey = getFocusColor(f);
                const theme = colors[colorKey] || colors['slate'];

                // Button Styling
                let buttonClass = "";

                if (isActive) {
                    buttonClass = `bg-[#161b22] border-2 ${theme.b} shadow-[0_0_20px_rgba(0,0,0,0.4)] relative overflow-hidden`;
                } else {
                    buttonClass = `bg-[#161b22]/50 border border-white/5 hover:border-white/10 hover:bg-[#1e232e] ${theme.h}`;
                }

                // Staggered Animation
                const delay = idx * 50;

                html += `
                 <button onclick="selectFocusFilter('${f}')" 
                    style="animation: fadeUp 0.4s forwards ${delay}ms; opacity: 0;"
                    class="${buttonClass} cursor-pointer rounded-2xl transition-all duration-300 flex items-center gap-4 p-4 group relative active:scale-[0.98] shadow-lg h-20 text-left w-full">
                    
                    <!-- Background Gradient -->
                    <div class="absolute inset-0 bg-gradient-to-r ${theme.g} opacity-0 ${isActive ? 'opacity-20' : 'group-hover:opacity-10'} transition-opacity duration-300"></div>
                    
                    ${isActive ? `<div class="absolute inset-0 bg-${colorKey}-500/5 animate-pulse"></div>` : ''}

                    <!-- Icon Bubble -->
                    <div class="w-10 h-10 rounded-xl flex-shrink-0 ${theme.bg} ${theme.t} flex items-center justify-center transition-transform duration-300 group-hover:scale-110 shadow-inner relative z-10 border border-white/5">
                        <i data-lucide="${icon}" class="w-5 h-5 stroke-[2]"></i>
                    </div>

                    <div class="flex flex-col relative z-10">
                        <span class="text-[9px] font-black uppercase tracking-widest opacity-60 mb-0.5 ${isActive ? theme.t : 'text-slate-500'}">Focus</span>
                        <span class="text-sm font-bold ${isActive ? 'text-white' : 'text-slate-300 group-hover:text-white'} transition-colors">${f}</span>
                    </div>

                    <!-- Selected Checkmark (Optional) -->
                    ${isActive ? `<i data-lucide="check" class="w-5 h-5 ml-auto ${theme.t}"></i>` : ''}

                 </button>`;
            });
            html += `</div>
                <div class="h-4"></div>
            </div>`;

            Swal.fire({
                html: html,
                background: '#0b0d10',
                showConfirmButton: false,
                showCloseButton: false,
                width: '500px',
                padding: '0',
                backdrop: `rgba(0,0,0,0.85) backdrop-blur-md`,
                customClass: {
                    popup: 'rounded-[2rem] border border-white/10 shadow-2xl !overflow-hidden animate-scale-in glass-panel',
                    htmlContainer: '!overflow-hidden !m-0 !p-0'
                },
                didOpen: () => {
                    lucide.createIcons();
                    // Robust closer
                    const container = Swal.getHtmlContainer();
                    if (container) {
                        const buttons = container.querySelectorAll('button');
                        buttons.forEach(b => {
                            b.addEventListener('click', () => {
                                setTimeout(() => Swal.close(), 100);
                            });
                        });
                    }
                }
            });
        }




        function filterFocus(focus) {
            walletFocusFilter = focus;
            const lbl = document.getElementById('lbl-filter-focus');
            const btn = document.getElementById('btn-filter-focus');
            if (lbl && btn) {
                if (focus) {
                    lbl.innerText = focus;
                    btn.classList.add('bg-white/10', 'text-white');
                    btn.classList.remove('text-slate-400');
                } else {
                    lbl.innerText = 'Focus';
                    btn.classList.remove('bg-white/10', 'text-white');
                    btn.classList.add('text-slate-400');
                }
            }
            renderWalletHistory();
        }

        function renderWalletHistory(arg = null) {
            const dateFilter = (arg instanceof Date) ? arg : null;
            const list = document.getElementById('wallet-history-list');
            if (!list) return;

            // --- 1. Get Base Data ---
            let allTransactions = appState.transactions || [];
            let filtered = [...allTransactions]; // Copy for filtering

            // --- 2. Calculate Dashboard Metrics (Source of Truth) ---
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // Calculate Previous Month Date
            const prevDate = new Date(currentYear, currentMonth - 1, 1);
            const prevMonth = prevDate.getMonth();
            const prevYear = prevDate.getFullYear();

            // NET WORTH CALCULATION (Patrimonio)
            // Starts with initial profile balance + all historic transactions
            // MATCHING CHART LOGIC: Base 10,000 if not set
            let currentNetWorth = (appState.profile && appState.profile.balance !== undefined) ? appState.profile.balance : 10000;

            // We need to iterate ALL transactions to get true Net Worth
            // IMPORTANT: To match the Net Worth Chart (which is 2025 specific), we must filter by year.
            allTransactions.forEach(t => {
                const amount = parseFloat(t.amount) || 0;
                // Parse Date
                // Robust Date Parsing for Filter
                let raw = t.dateIso || t.id;
                if (typeof raw === 'string' && raw.length === 10) raw += 'T12:00:00'; // Force middle of day for YYYY-MM-DD
                const d = new Date(raw);
                // Strict 2025 Net Worth (Chart Logic matches this)
                if (d.getFullYear() === currentYear) {
                    if (t.type === 'income') currentNetWorth += amount;
                    else currentNetWorth -= amount;
                }
            });

            // Local variables for current month view
            let mInc = 0;
            let mExp = 0;
            let prevMInc = 0;
            let prevMExp = 0;

            allTransactions.forEach(t => {
                const amount = parseFloat(t.amount) || 0;
                // Robust Date Parsing for Filter
                let raw = t.dateIso || t.id;
                if (typeof raw === 'string' && raw.length === 10) raw += 'T12:00:00'; // Force middle of day for YYYY-MM-DD
                const d = new Date(raw);

                // Monthly Stats (Current Month)
                if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                    if (t.type === 'income') mInc += amount;
                    else mExp += amount;
                }

                // Monthly Stats (Previous Month)
                if (d.getMonth() === prevMonth && d.getFullYear() === prevYear) {
                    if (t.type === 'income') prevMInc += amount;
                    else prevMExp += amount;
                }
            });

            // Update Cards (Dashboard/Wallet Top Section)
            // Using Intl for clean formatting
            const fmt = (n) => n.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 2 });

            const elBal = document.getElementById('w-net-balance');
            const elInc = document.getElementById('monthly-income');
            const elExp = document.getElementById('monthly-expenses');

            if (elBal) {
                // Display the Calculated Net Worth
                elBal.innerText = fmt(currentNetWorth);

                // Update Label if needed to match screenshot
                const balLabel = elBal.previousElementSibling;
                if (balLabel && balLabel.tagName === 'P') balLabel.innerText = "TOTAL BALANCE";
            }
            if (elInc) {
                elInc.innerText = fmt(mInc);
                // Update Label
                const incLabel = elInc.parentElement.querySelector('p');
                if (incLabel) incLabel.innerText = "INGRESOS";

                // Update Variation
                const elVar = document.getElementById('inc-variation');
                if (elVar) {
                    let pct = 0;
                    if (prevMInc > 0) pct = ((mInc - prevMInc) / prevMInc) * 100;
                    else if (mInc > 0) pct = 100; // From 0 to something is 100% growth effectively (or infinite)

                    const isPositive = pct >= 0;
                    const icon = isPositive ? 'trending-up' : 'trending-down';
                    const colorClass = isPositive ? 'text-emerald-400' : 'text-rose-400';
                    const bgClass = isPositive ? 'bg-emerald-500/10' : 'bg-rose-500/10';
                    const borderClass = isPositive ? 'border-emerald-500/20' : 'border-rose-500/20';

                    // Apply Classes
                    elVar.className = `${colorClass} font-bold text-sm ${bgClass} px-2 py-0.5 rounded-lg border ${borderClass} flex items-center gap-1`;
                    elVar.innerHTML = `<i data-lucide="${icon}" class="w-3 h-3"></i> ${isPositive ? '+' : ''}${Math.round(pct)}%`;
                }
            }
            if (elExp) {
                elExp.innerText = fmt(mExp);
                // Update Label
                const expLabel = elExp.parentElement.querySelector('p');
                if (expLabel) expLabel.innerText = "GASTOS";

                // Update Variation
                const elVar = document.getElementById('exp-variation');
                if (elVar) {
                    let pct = 0;
                    if (prevMExp > 0) pct = ((mExp - prevMExp) / prevMExp) * 100;
                    else if (mExp > 0) pct = 100;

                    // For expenses, Increase is "Bad" (Red), Decrease is "Good" (Green) - BUT usually UI follows direction
                    // Standard: Up Arrow = Increase. 
                    // Color: Let's stick to standard Red for expense, Green for income, OR Red for increase in expense?
                    // Screenshot shows Green for Income Increase. Usually Expense Increase is Red.

                    const isIncrease = pct >= 0;
                    const isGood = !isIncrease; // Spending less is good? Or just show direction?
                    // Let's keep it simple: Directional.
                    // Color: Increase = Red (More spending), Decrease = Green (Saving).

                    const colorClass = isIncrease ? 'text-rose-400' : 'text-emerald-400';
                    const bgClass = isIncrease ? 'bg-rose-500/10' : 'bg-emerald-500/10';
                    const borderClass = isIncrease ? 'border-rose-500/20' : 'border-emerald-500/20';
                    const icon = isIncrease ? 'trending-up' : 'trending-down';

                    elVar.className = `${colorClass} font-bold text-sm ${bgClass} px-2 py-0.5 rounded-lg border ${borderClass} flex items-center gap-1`;
                    elVar.innerHTML = `<i data-lucide="${icon}" class="w-3 h-3"></i> ${isIncrease ? '+' : ''}${Math.round(pct)}%`;
                }
            }


            // --- 3. FILTERING FOR LIST VIEW ---
            // Focus Filter
            if (walletFocusFilter) {
                filtered = filtered.filter(t =>
                (t.budgetFocus === walletFocusFilter ||
                    (walletFocusFilter === 'Saving' && t.budgetFocus === 'Save') || // Handle old 'Saving' to new 'Save'
                    (walletFocusFilter === 'Investment' && t.budgetFocus === 'Invest')) // Handle old 'Investment' to new 'Invest'
                );
            }

            // Category Filter
            if (walletCategoryFilter) {
                filtered = filtered.filter(t => t.category === walletCategoryFilter);
            }

            // Type Filter & Today Filter
            if (walletFilter === 'today') {
                filtered = filtered.filter(t => {
                    let d;
                    if (t.dateIso && t.dateIso.length === 10) d = new Date(t.dateIso + 'T12:00:00');
                    else if (t.dateIso) d = new Date(t.dateIso);
                    else if (typeof t.id === 'number' && t.id > 1600000000000) d = new Date(t.id);
                    else { d = new Date(t.date + ", " + new Date().getFullYear()); }
                    if (isNaN(d.getTime())) return false;
                    return d.getDate() === now.getDate() && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });
            } else if (walletFilter !== 'all') {
                filtered = filtered.filter(t => t.type === walletFilter);
            }

            // Time Filter
            if (dateFilter) {
                filtered = filtered.filter(t => {
                    let d;
                    if (t.dateIso) d = new Date(t.dateIso);
                    else if (typeof t.id === 'number' && t.id > 1600000000000) d = new Date(t.id);
                    else { d = new Date(t.date + ", " + new Date().getFullYear()); if (isNaN(d.getTime())) d = new Date(t.id); }
                    return d.getDate() === dateFilter.getDate() && d.getMonth() === dateFilter.getMonth() && d.getFullYear() === dateFilter.getFullYear();
                });
            } else {
                // Pre-defined time ranges - Robust Date Parsing
                if (walletTimeFilter !== 'all') {
                    filtered = filtered.filter(t => {
                        let d;
                        if (t.dateIso && t.dateIso.length === 10) d = new Date(t.dateIso + 'T12:00:00');
                        else if (t.dateIso) d = new Date(t.dateIso);
                        else if (typeof t.id === 'number' && t.id > 1600000000000) d = new Date(t.id);
                        else { d = new Date(t.date + ", " + new Date().getFullYear()); if (isNaN(d.getTime())) d = new Date(t.id); }

                        // Fallback
                        if (!d || isNaN(d.getTime())) return false;

                        const tTime = d.getTime();

                        // Timestamps for ranges
                        // WEEK LOGIC: Start on Monday
                        const startOfWeek = new Date(now);
                        startOfWeek.setHours(0, 0, 0, 0);
                        const day = startOfWeek.getDay(); // 0(Sun) - 6(Sat)
                        const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
                        startOfWeek.setDate(diff);
                        const weekStartTs = startOfWeek.getTime();

                        // MONTH LOGIC
                        // MONTH LOGIC
                        let monthStartStr = '';
                        if (walletTimeFilter === 'month') {
                            if (walletTargetMonth) {
                                // Custom Month
                                const [y, m] = walletTargetMonth.split('-');
                                // Check if transaction is in this month
                                // Use Local Year/Month from robust date 'd'
                                if (d.getFullYear() === parseInt(y) && d.getMonth() === (parseInt(m) - 1)) return true;
                                return false;
                            } else {
                                // Default: Current Month
                                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
                                return tTime >= monthStart;
                            }
                        }

                        if (walletTimeFilter === 'day') {
                            return d.getDate() === now.getDate() && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                        }
                        if (walletTimeFilter === 'week') return tTime >= weekStartTs;
                        // if (walletTimeFilter === 'month') return tTime >= monthStart; // Handled above
                        if (walletTimeFilter === 'prev') {
                            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
                            return tTime < monthStart;
                        }
                        return true;
                    });
                }

                // Update Month Label if taking action
                const lbl = document.getElementById('history-month-label');
                if (lbl) {
                    if (walletTimeFilter === 'month') {
                        lbl.innerText = walletTargetMonth ? getMonthName(walletTargetMonth) : 'Mes Actual';
                    } else {
                        lbl.innerText = 'Mes';
                    }
                }
            }

            // Sort
            filtered = filtered.sort((a, b) => b.id - a.id); // Newest first

            // Update Chart with Filtered Data
            if (typeof walletCategoryChart !== 'undefined' && walletCategoryChart) {
                const catMap = {}; filtered.forEach(t => { catMap[t.category] = (catMap[t.category] || 0) + t.amount; });
                const sortedCats = Object.entries(catMap).sort((a, b) => b[1] - a[1]).slice(0, 5);

                if (sortedCats.length === 0) {
                    walletCategoryChart.updateOptions({ labels: ['No Data'] });
                    walletCategoryChart.updateSeries([1]);
                } else {
                    walletCategoryChart.updateOptions({ labels: sortedCats.map(x => x[0]) });
                    walletCategoryChart.updateSeries(sortedCats.map(x => x[1]));
                }
            }

            // Render List
            // --- SUMMARY CALCULATION ---
            const sInc = filtered.filter(t => t.type === 'income').reduce((a, t) => a + (parseFloat(t.amount) || 0), 0);
            const sExp = filtered.filter(t => t.type === 'expense').reduce((a, t) => a + (parseFloat(t.amount) || 0), 0);
            const fSum = (n) => formatCurrency(n);

            const summaryHtml = `
            <div class="flex items-center justify-between mb-4 p-5 rounded-[1.5rem] bg-[#161b22] border border-white/5 shadow-xl relative overflow-hidden group/summary backdrop-blur-sm">
                <div class="absolute top-0 right-0 w-32 h-32 bg-indigo-500/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none transition-opacity duration-500 group-hover/summary:opacity-100 opacity-50"></div>
                
                <div class="flex items-center gap-3.5 relative z-10">
                    <div class="w-10 h-10 rounded-2xl bg-emerald-500/10 flex items-center justify-center border border-emerald-500/20 text-emerald-400 shadow-[0_0_15px_rgba(16,185,129,0.15)] group-hover/summary:scale-110 transition-transform duration-300">
                        <i data-lucide="arrow-up" class="w-5 h-5 stroke-[2.5]"></i>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[9px] font-black uppercase tracking-[0.2em] text-emerald-500/60 mb-0.5">Ingresos</span>
                        <span class="text-base font-black text-white font-mono tracking-tight">${fSum(sInc)}</span>
                    </div>
                </div>
                
                <div class="w-px h-10 bg-gradient-to-b from-transparent via-white/10 to-transparent mx-2 opacity-50"></div>
                
                <div class="flex items-center gap-3.5 relative z-10">
                    <div class="flex flex-col items-end">
                        <span class="text-[9px] font-black uppercase tracking-[0.2em] text-rose-500/60 mb-0.5">Gastos</span>
                        <span class="text-base font-black text-white font-mono tracking-tight">${fSum(sExp)}</span>
                    </div>
                    <div class="w-10 h-10 rounded-2xl bg-rose-500/10 flex items-center justify-center border border-rose-500/20 text-rose-400 shadow-[0_0_15px_rgba(244,63,94,0.15)] group-hover/summary:scale-110 transition-transform duration-300">
                        <i data-lucide="arrow-down" class="w-5 h-5 stroke-[2.5]"></i>
                    </div>
                </div>
            </div>`;

            let listItems = '';
            if (filtered.length === 0) {
                listItems = `<div class="text-center py-10 text-slate-500 italic flex flex-col items-center gap-2 animate-pulse rounded-2xl border border-white/5 bg-white/5">
                        <i data-lucide="filter-x" class="w-8 h-8 opacity-50 mb-2"></i>
                        <span>No transactions found</span>
                    </div>`;
            } else {
                listItems = filtered.map((t, index) => {
                    // Infer focus if missing
                    let focusKey = t.budgetFocus;

                    // Normalization (Legacy Data Patch)
                    if (focusKey === 'Invest') focusKey = 'Investment';
                    if (focusKey === 'Saving') focusKey = 'Save';

                    if (!focusKey && t.category) {
                        const catLower = t.category.toLowerCase();
                        if (['shopping', 'tech', 'entertainment', 'travel', 'hobbies'].some(k => catLower.includes(k))) focusKey = 'Wants';
                        else if (['food', 'housing', 'transport', 'health', 'education', 'groceries', 'utilities'].some(k => catLower.includes(k))) focusKey = 'Needs';
                        else if (['gym', 'subscription', 'drinks'].some(k => catLower.includes(k))) focusKey = 'Wants';
                        else if (['waste', 'fee', 'fine'].some(k => catLower.includes(k))) focusKey = 'Waste';
                        else if (['save', 'saving', 'investment'].some(k => catLower.includes(k))) focusKey = 'Save';
                        else focusKey = 'Needs'; // Default fallback
                    }

                    // Use Global Config
                    const focusData = budgetFocusConfig[focusKey] || budgetFocusConfig['Other'];

                    // Show Focus Tag for both Income and Expense
                    const focusTagHtml = focusData
                        ? `<span class="flex items-center gap-1.5 text-[9px] uppercase font-bold px-2 py-0.5 rounded-lg ${focusData.bg} ${focusData.color} border ${focusData.border} transition-colors">
                        <i data-lucide="${focusData.icon}" class="w-3 h-3"></i> ${focusKey}
                    </span>`
                        : '';

                    return `
                    <div class="flex items-center justify-between p-4 rounded-2xl bg-dark-800/40 hover:bg-dark-800 border border-white/5 hover:border-white/10 transition-all duration-300 group relative overflow-hidden animate-slide-in-bottom"
                        style="opacity: 0; animation: fadeUp 0.3s forwards ${index * 0.05}s;" onclick="editTransaction(${t.id})">
                        <style>@keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }</style>
                        <div class="flex items-center gap-4 z-10 flex-1 cursor-pointer">
                            <div class="w-12 h-12 rounded-2xl ${t.type === 'income' ? 'bg-emerald-500/10 text-emerald-500' : 'bg-rose-500/10 text-rose-500'} flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                                <i data-lucide="${getTransactionIcon(t.category, t.type)}" class="w-6 h-6"></i>
                            </div>
                            <div class="flex flex-col gap-1">
                                <p class="text-base font-bold text-adaptive group-hover:text-primary transition-colors">${t.name}</p>
                                <div class="flex items-center gap-2 flex-wrap">
                                    <span class="text-[10px] uppercase font-bold px-1.5 py-0.5 rounded bg-white/5 text-slate-400 border border-white/5 tracking-wider">${t.category}</span>
                                    ${focusTagHtml}
                                    <span class="text-[10px] text-slate-500 font-medium ml-1 flex items-center gap-1">
                                        <i data-lucide="calendar" class="w-3 h-3"></i>
                                        ${new Date(t.dateIso || t.id).toLocaleDateString('es-ES', { month: 'short', day: 'numeric' })}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 z-10">
                            <div class="text-right">
                                <p class="text-base font-black ${t.type === 'income' ? 'text-emerald-400' : 'text-rose-400'} tracking-tight">
                                    ${t.type === 'income' ? '+' : '-'} $${formatCurrency(t.amount).replace('$', '')}
                                </p>
                            </div>
                            <button onclick="event.stopPropagation(); deleteTransactionQuick(${t.id})" class="w-10 h-10 rounded-xl bg-red-500/10 hover:bg-red-500/20 border border-red-500/20 hover:border-red-500/40 flex items-center justify-center text-red-400 hover:text-red-300 transition-all duration-200 opacity-0 group-hover:opacity-100 hover:scale-110" title="Eliminar">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>`;
                }).join('');
            }

            list.innerHTML = summaryHtml + listItems;

            lucide.createIcons();
            updateBudgetFocusStats();
        }

        function updateBudgetFocusStats() {
            // Filter for CURRENT MONTH transactions only, to match the Budget Tab logic
            const now = new Date();
            const startMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();

            const expenses = appState.transactions.filter(t => t.type === 'expense' && t.id >= startMonth);
            const totalExp = expenses.reduce((a, t) => a + t.amount, 0);

            const focuses = ['Needs', 'Wants', 'Saving', 'Investment', 'Waste'];

            focuses.forEach(f => {
                // Determine CSS bar color class based on focus type
                const colorMap = {
                    'Needs': 'bg-primary',
                    'Wants': 'bg-pink-500',
                    'Saving': 'bg-emerald-500',
                    'Investment': 'bg-orange-500',
                    'Waste': 'bg-red-500'
                };

                const fAmt = expenses.filter(t => t.budgetFocus === f).reduce((a, t) => a + t.amount, 0);
                const pct = totalExp > 0 ? Math.round((fAmt / totalExp) * 100) : 0;

                // Update Percentage Text
                const elText = document.getElementById('val-focus-' + f.toLowerCase());
                if (elText) elText.innerText = pct + '%';

                // Update Progress Bar Width (Visual)
                const elBar = document.getElementById('bar-focus-' + f.toLowerCase());
                if (elBar) {
                    elBar.style.width = pct + '%';
                    // Optional: Reset color class if needed, or assume it's set in HTML
                }
            });
        }

        // --- SETTINGS - THEME & WALLPAPER ---
        // --- SETTINGS - THEME & WALLPAPER ---
        // --- SETTINGS - THEME & WALLPAPER ---

        // Store current gradient colors
        window.currentGradient = {
            start: '#6366F1', // Indigo
            end: '#A855F7'    // Purple
        };

        function uploadWallpaper(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const uploadedUrl = e.target.result;
                    document.querySelector('main').style.backgroundImage = `url('${uploadedUrl}')`;
                    document.querySelector('main').className = "flex-1 overflow-x-hidden overflow-y-auto bg-cover bg-center bg-no-repeat bg-fixed transition-all duration-500 relative";

                    appState.settings = appState.settings || {};
                    appState.settings.wallpaper = 'custom';
                    appState.settings.customWallpaperUrl = uploadedUrl;
                    saveState();

                    Swal.fire({
                        toast: true, position: 'top', icon: 'success',
                        title: 'Custom wallpaper set',
                        background: '#1E293B', color: '#fff', timer: 2000, showConfirmButton: false
                    });
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function setThemeColor(colorName, role = 'primary') {
            const colors = {
                'indigo': '#6366F1',
                'purple': '#A855F7',
                'pink': '#EC4899',
                'rose': '#F43F5E',
                'orange': '#F97316',
                'amber': '#F59E0B',
                'gold': '#EAB308', // yellow-500
                'lime': '#84CC16',
                'green': '#22C55E',
                'emerald': '#10B981',
                'teal': '#14B8A6',
                'cyan': '#06B6D4',
                'sky': '#0EA5E9',
                'blue': '#3B82F6',
                'violet': '#8B5CF6',
                'fuchsia': '#D946EF',
                'slate': '#64748B',
                'zinc': '#71717A',
                'red': '#EF4444',
                'stone': '#78716C'
            };

            const hex = colors[colorName] || '#6366F1';

            if (role === 'primary') {
                currentGradient.start = hex;
                document.documentElement.style.setProperty('--color-primary', hex);
            } else {
                currentGradient.end = hex;
            }

            if (typeof sidebarRingChart !== 'undefined' && sidebarRingChart) {
                sidebarRingChart.updateOptions({ colors: [currentGradient.start] });
            }
        }

        // Update gradient preview and related UI elements
        function updateGradientPreview() {
            // 1. Update Preview Orb (Visual Identity Engine)
            const orb = document.getElementById('tm-preview-gradient');
            if (orb) {
                orb.style.background = `linear-gradient(135deg, ${currentGradient.start}, ${currentGradient.end})`;
            }

            // 2. Update Indicators (Visual Identity Engine)
            const indPrim = document.getElementById('tm-indicator-primary');
            const indAcc = document.getElementById('tm-indicator-accent');
            const badgePrim = document.getElementById('tm-badge-primary');
            const badgeAcc = document.getElementById('tm-badge-accent');

            if (indPrim) indPrim.style.backgroundColor = currentGradient.start;
            if (indAcc) indAcc.style.backgroundColor = currentGradient.end;
            if (badgePrim) { badgePrim.innerText = currentGradient.start; badgePrim.style.color = currentGradient.start; }
            if (badgeAcc) { badgeAcc.innerText = currentGradient.end; badgeAcc.style.color = currentGradient.end; }

            // 3. Update App Branding (Sidebar)
            // Use querySelector for more robustness if IDs are duplicated (unlikely but safe)
            const elIcon = document.getElementById('sidebar-app-icon');
            const elAi = document.getElementById('sidebar-app-text-ai');

            if (elIcon) {
                // Ensure no conflicting bg classes
                // We set outline styles and important flags via cssText for maximum priority
                elIcon.style.cssText = `background-image: linear-gradient(to top right, ${currentGradient.start}, ${currentGradient.end}) !important; box-shadow: 0 0 35px ${currentGradient.start}66 !important;`;
            }

            if (elAi) {
                // Gradient Text Effect for "AI" - Webkit friendly
                elAi.style.background = `linear-gradient(to right, ${currentGradient.start}, ${currentGradient.end})`;
                elAi.style.webkitBackgroundClip = 'text';
                elAi.style.webkitTextFillColor = 'transparent';
                elAi.style.backgroundClip = 'text';
                elAi.style.color = 'transparent';

                // Also update the text class to remove any conflicting text colors
                elAi.className = "font-black transition-colors duration-500";
            }

            // 4. Update Header Title
            const titleEl = document.getElementById('pageTitle');
            if (titleEl) {
                titleEl.style.backgroundImage = `linear-gradient(to right, ${currentGradient.start}, ${currentGradient.end})`;
            }
        }



        // Enhanced theme color setter with visual indicators and HEX display
        // Enhanced theme color setter with visual indicators and HEX display
        function setThemeColorEnhanced(colorName, hexValue, role = 'primary') {
            // Ensure currentGradient exists
            if (typeof currentGradient === 'undefined') {
                window.currentGradient = { start: '#6366F1', end: '#A855F7' };
            }

            // Update gradient state
            if (role === 'primary') {
                currentGradient.start = hexValue;
                document.documentElement.style.setProperty('--color-primary', hexValue);
            } else {
                currentGradient.end = hexValue;
                document.documentElement.style.setProperty('--color-secondary', hexValue); // Ensure this var is set
            }

            // Visual Indicators: Find buttons that match this specific role and color/hex
            // We search for buttons whose onclick attribute contains the hexValue and role
            const allButtons = document.querySelectorAll('button[onclick^="setThemeColorEnhanced"]');

            allButtons.forEach(btn => {
                const onclickStr = btn.getAttribute('onclick');
                if (onclickStr.includes(`'${role}'`) || onclickStr.includes(`"${role}"`)) {
                    // This is a button for the current role
                    // Check if it's the selected one
                    if (onclickStr.includes(`'${hexValue}'`) || onclickStr.includes(`"${hexValue}"`)) {
                        // Selected: Add Ring
                        btn.classList.add('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-[#1a1d2e]', 'scale-110');
                    } else {
                        // Not Selected: Remove Ring
                        btn.classList.remove('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-[#1a1d2e]', 'scale-110');
                    }
                }
            });

            // Update gradient preview
            if (typeof updateGradientPreview === 'function') updateGradientPreview();

            // Update sidebar ring chart if it exists
            if (typeof window.sidebarRingChart !== 'undefined' && window.sidebarRingChart) {
                window.sidebarRingChart.updateOptions({ colors: [window.currentGradient.start] });
                // Force size fix via CSS
                const chartEl = document.querySelector("#sidebarRingChart");
                if (chartEl) chartEl.style.transform = "scale(1.25)";
            }

            // Save to state
            if (typeof appState !== 'undefined') {
                appState.settings = appState.settings || {};
                appState.settings.themeColor = colorName;
                appState.settings.gradientStart = currentGradient.start;
                appState.settings.gradientEnd = currentGradient.end;
                if (typeof saveState === 'function') saveState();
            }
        }

        // Apply a full Vibe Preset (Start + End colors)
        function setThemePreset(name) {
            let p, s, pName, sName;

            switch (name) {
                case 'neon':
                    p = '#8B5CF6'; pName = 'violet';
                    s = '#D946EF'; sName = 'fuchsia';
                    break;
                case 'warm':
                    p = '#F97316'; pName = 'orange';
                    s = '#F59E0B'; sName = 'amber';
                    break;
                case 'ocean':
                    p = '#06B6D4'; pName = 'cyan';
                    s = '#3B82F6'; sName = 'blue';
                    break;
                case 'nature':
                    p = '#10B981'; pName = 'emerald';
                    s = '#84CC16'; sName = 'lime';
                    break;
                case 'monochrome':
                    p = '#64748B'; pName = 'slate';
                    s = '#F8FAFC'; sName = 'white';
                    break;
            }

            if (p && s) {
                // Apply without saving intermediate state to avoid UI flicker/double save
                currentGradient.start = p;
                currentGradient.end = s;
                document.documentElement.style.setProperty('--color-primary', p);
                document.documentElement.style.setProperty('--color-secondary', s);

                // Update visual indicators for matching buttons
                setThemeColorEnhanced(pName, p, 'primary');
                setThemeColorEnhanced(sName, s, 'secondary');

                // Toast
                Swal.fire({
                    toast: true, position: 'top', icon: 'success',
                    title: `Vibe applied: ${name.charAt(0).toUpperCase() + name.slice(1)}`,
                    background: '#1E293B', color: '#fff', timer: 1500, showConfirmButton: false
                });
            }
        }

        // Update gradient preview and related UI elements
        function updateGradientPreview() {
            // Update preview strip
            const preview = document.getElementById('gradient-preview-strip');
            if (preview) {
                preview.style.background = `linear-gradient(135deg, ${currentGradient.start}, ${currentGradient.end})`;
            }

            // Update CSS code display
            const codeDisplay = document.getElementById('gradient-css-code');
            if (codeDisplay) {
                codeDisplay.textContent = `background: linear-gradient(135deg, ${currentGradient.start}, ${currentGradient.end});`;
            }

            // Update App Branding
            const elIcon = document.getElementById('sidebar-app-icon');
            const elAi = document.getElementById('sidebar-app-text-ai');
            if (elIcon) {
                elIcon.style.backgroundImage = `linear-gradient(to top right, ${currentGradient.start}, ${currentGradient.end})`;
                elIcon.style.boxShadow = `0 0 35px ${currentGradient.start}66`;
            }
            if (elAi) {
                elAi.style.color = currentGradient.end;
            }

            // Update page title
            const titleEl = document.getElementById('pageTitle');
            if (titleEl) {
                titleEl.className = "text-3xl font-black text-transparent bg-clip-text tracking-tight";
                titleEl.style.backgroundImage = `linear-gradient(to right, ${currentGradient.start}, ${currentGradient.end})`;
            }
        }

        // Generate random gradient
        function randomizeGradient() {
            const allColors = ['red', 'rose', 'orange', 'amber', 'yellow', 'lime', 'green', 'emerald', 'teal', 'cyan', 'sky', 'blue', 'indigo', 'violet', 'purple', 'fuchsia', 'pink'];
            const colorHexMap = {
                'red': '#EF4444',
                'rose': '#F43F5E',
                'orange': '#F97316',
                'amber': '#F59E0B',
                'yellow': '#EAB308',
                'lime': '#84CC16',
                'green': '#22C55E',
                'emerald': '#10B981',
                'teal': '#14B8A6',
                'cyan': '#06B6D4',
                'sky': '#0EA5E9',
                'blue': '#3B82F6',
                'indigo': '#6366F1',
                'violet': '#8B5CF6',
                'purple': '#A855F7',
                'fuchsia': '#D946EF',
                'pink': '#EC4899',
                'slate': '#64748B',
                'gray': '#6B7280',
                'zinc': '#71717A'
            };

            // Pick two different random colors
            const randomStart = allColors[Math.floor(Math.random() * allColors.length)];
            let randomEnd = allColors[Math.floor(Math.random() * allColors.length)];

            // Ensure start and end are different
            while (randomEnd === randomStart) {
                randomEnd = allColors[Math.floor(Math.random() * allColors.length)];
            }

            // Apply the colors
            setThemeColorEnhanced(randomStart, colorHexMap[randomStart], 'primary');
            setThemeColorEnhanced(randomEnd, colorHexMap[randomEnd], 'secondary');

            // Show success toast
            Swal.fire({
                toast: true,
                position: 'top',
                icon: 'success',
                title: `Random Gradient: ${randomStart} → ${randomEnd}`,
                background: '#1E293B',
                color: '#fff',
                timer: 1500,
                showConfirmButton: false
            });
        }

        // Copy gradient CSS code to clipboard
        async function copyGradientCode() {
            const cssCode = `background: linear-gradient(135deg, ${currentGradient.start}, ${currentGradient.end});`;

            try {
                await navigator.clipboard.writeText(cssCode);

                Swal.fire({
                    toast: true,
                    position: 'top',
                    icon: 'success',
                    title: 'CSS Code Copied!',
                    background: '#1E293B',
                    color: '#fff',
                    timer: 1500,
                    showConfirmButton: false
                });
            } catch (err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = cssCode;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();

                try {
                    document.execCommand('copy');
                    Swal.fire({
                        toast: true,
                        position: 'top',
                        icon: 'success',
                        title: 'CSS Code Copied!',
                        background: '#1E293B',
                        color: '#fff',
                        timer: 1500,
                        showConfirmButton: false
                    });
                } catch (err2) {
                    Swal.fire({
                        toast: true,
                        position: 'top',
                        icon: 'error',
                        title: 'Failed to copy',
                        background: '#1E293B',
                        color: '#fff',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }

                document.body.removeChild(textArea);
            }
        }

        // --- THEME MANAGEMENT ---
        function toggleInterfaceMode(mode) {
            const html = document.documentElement;
            const isDark = mode === 'dark';

            // 1. Set DOM Class
            html.setAttribute('data-theme', mode);
            if (isDark) {
                html.classList.add('dark');
                document.body.classList.add('bg-dark-900', 'text-adaptive');
                document.body.classList.remove('bg-gray-50', 'text-slate-900');
            } else {
                html.classList.remove('dark');
                document.body.classList.remove('bg-dark-900', 'text-adaptive');
                document.body.classList.add('bg-gray-50', 'text-slate-900');
            }

            // 2. Persist
            localStorage.setItem('theme', mode);

            // 3. Update UI Buttons
            updateInterfaceModeButtons(mode);

            // 4. Update Charts
            updateChartsTheme(mode);

            // 5. Update Legacy Icon (if used elsewhere)
            const icon = document.getElementById('themeIcon');
            if (icon) {
                icon.setAttribute('data-lucide', isDark ? 'moon' : 'sun');
                lucide.createIcons();
            }
        }

        function updateInterfaceModeButtons(mode) {
            const btnDark = document.getElementById('btn-mode-dark');
            const btnLight = document.getElementById('btn-mode-light');
            const indicator = document.getElementById('mode-indicator');

            if (btnDark && btnLight) {
                // Text Colors
                if (mode === 'dark') {
                    btnDark.className = "flex-1 relative z-10 py-1.5 rounded-lg text-indigo-400 transition hover:text-white flex items-center justify-center";
                    btnLight.className = "flex-1 relative z-10 py-1.5 rounded-lg text-slate-500 transition hover:text-white flex items-center justify-center";
                } else {
                    btnDark.className = "flex-1 relative z-10 py-1.5 rounded-lg text-slate-500 transition hover:text-white flex items-center justify-center";
                    btnLight.className = "flex-1 relative z-10 py-1.5 rounded-lg text-amber-500 transition hover:text-white flex items-center justify-center";
                }
            }

            // Slider Animation
            if (indicator) {
                if (mode === 'dark') {
                    indicator.style.transform = 'translateX(0)';
                } else {
                    indicator.style.transform = 'translateX(100%)';
                }
            }
        }
        // Init Theme
        const savedTheme = localStorage.getItem('theme') || 'dark';
        // Apply immediately
        if (savedTheme === 'dark') {
            document.documentElement.classList.add('dark');
            document.documentElement.setAttribute('data-theme', 'dark');
        } else {
            document.documentElement.classList.remove('dark');
            document.documentElement.setAttribute('data-theme', 'light');
            // Body might not be ready if this runs in head, but if at bottom of body it is ok.
            // We'll rely on DOMContentLoaded for body class fallback if needed, but usually safe here if script is at end.
        }

        // Post-load UI updates
        document.addEventListener('DOMContentLoaded', () => {
            // Sync Body Classes on load
            const curTheme = localStorage.getItem('theme') || 'dark';
            if (curTheme === 'light') {
                document.body.classList.remove('bg-dark-900', 'text-adaptive');
                document.body.classList.add('bg-gray-50', 'text-slate-900');
            } else {
                document.body.classList.add('bg-dark-900', 'text-adaptive');
                document.body.classList.remove('bg-gray-50', 'text-slate-900');
            }

            updateInterfaceModeButtons(curTheme);
            setTimeout(() => {
                updateChartsTheme(curTheme);
            }, 100);
        });

        function updateChartsTheme(theme) {
            const isDark = theme === 'dark';
            const textColor = isDark ? '#94a3b8' : '#334155'; // Slate-400 vs Slate-700 (Darker)
            const gridColor = isDark ? '#334155' : '#cbd5e1';
            const bgTrack = isDark ? '#1E293B' : '#e2e8f0';
            const tooltipTheme = isDark ? 'dark' : 'light';

            // Common Options
            const commonUpdate = {
                chart: { foreColor: textColor },
                grid: { borderColor: gridColor },
                tooltip: { theme: tooltipTheme },
                xaxis: { labels: { style: { colors: textColor } } },
                yaxis: { labels: { style: { colors: textColor } } }
            };

            // Update specific charts
            if (mountainChart) mountainChart.updateOptions(commonUpdate);
            if (cashFlowChart) cashFlowChart.updateOptions(commonUpdate);
            if (areaChart) areaChart.updateOptions(commonUpdate);

            if (dissectionChart) dissectionChart.updateOptions({
                ...commonUpdate,
                xaxis: { labels: { style: { colors: textColor } } }
            });

            if (donutChart) donutChart.updateOptions({
                legend: { labels: { colors: textColor } },
                plotOptions: { donut: { labels: { total: { color: isDark ? '#fff' : '#0F172A' } } } }
            });

            if (financialGoalChart) financialGoalChart.updateOptions({
                plotOptions: {
                    radialBar: {
                        track: { background: bgTrack }, dataLabels: {
                            value: {
                                color: isDark ?
                                    '#fff' : '#0F172A'
                            }
                        }
                    }
                }
            });

            if (sidebarRingChart) sidebarRingChart.updateOptions({
                plotOptions: { radialBar: { track: { background: bgTrack } } }
            });

            // Re-render gauges if needed, simpler to just let them be as they are simple
            gaugeCharts.forEach(g => {
                g.updateOptions({
                    plotOptions: {
                        radialBar: {
                            track: { background: bgTrack }, dataLabels: {
                                value: {
                                    color: isDark ? '#fff' : '#0F172A'
                                }
                            }
                        }
                    }
                });
            });
        }

        // --- PROFILE IMAGE MANAGEMENT ---
        function handleProfileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const base64Image = e.target.result;

                    // 1. Update UI
                    const img = document.getElementById('profile-image');
                    if (img) img.src = base64Image;

                    // 2. Persist
                    if (typeof appState !== 'undefined') {
                        if (!appState.settings) appState.settings = {};
                        appState.settings.profileImage = base64Image;
                        saveState();
                    }

                    // Also save to generic key for backup
                    localStorage.setItem('userProfileImage', base64Image);
                };
                reader.readAsDataURL(file);
            }
        }

        function loadProfileImage() {
            // Priority: AppState -> LocalStorage -> Default
            let imgSrc = '';
            if (typeof appState !== 'undefined' && appState.settings && appState.settings.profileImage) {
                imgSrc = appState.settings.profileImage;
            } else {
                imgSrc = localStorage.getItem('userProfileImage');
            }

            if (imgSrc) {
                const img = document.getElementById('profile-image');
                if (img) img.src = imgSrc;
            }
        }

        // Add to initialization
        document.addEventListener('DOMContentLoaded', loadProfileImage);

        function setWallpaper(bgClass, element) {
            // Keep bg-dark-900 as fallback/base if bgClass is just a pattern
            // But usually bgClass replaces the background.
            // Ensure critical classes are present.
            document.body.className = `bg-dark-900 text-adaptive overflow-hidden h-screen flex ${bgClass}`;

            appState.settings = appState.settings || {};
            appState.settings.wallpaper = bgClass;
            saveState();

            if (element) {
                updateWallpaperUI(element);
            }
        }

        function updateWallpaperUI(activeElement) {
            // Remove active state from all wallpaper buttons
            const buttons = document.querySelectorAll('[data-wallpaper-btn]');
            buttons.forEach(btn => {
                btn.classList.remove('ring-4', 'ring-primary', 'scale-[1.02]');
                btn.classList.add('border-white/5');
                // Reset checkmark if present
                const check = btn.querySelector('.active-indicator');
                if (check) check.classList.add('opacity-0');
            });

            // Add active state to clicked element
            if (activeElement) {
                activeElement.classList.remove('border-white/5');
                activeElement.classList.add('ring-4', 'ring-primary', 'scale-[1.02]');
                const check = activeElement.querySelector('.active-indicator');
                if (check) check.classList.remove('opacity-0');
            }
        }

        // Initialize Settings on Load
        // Legacy initialization removed to prevent conflicts with initSettingsPersistence
        /*
        setTimeout(() => {
            if (appState.settings) {
                // Initialize Wallpaper - MOVED TO initSettingsPersistence
                // Initialize Colors & Gradients - MOVED TO initSettingsPersistence
            }
        }, 500);
        */

        // --- UPDATE MONTHLY TOTALS FUNCTION ---
        function updateMonthlyTotals() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            let monthlyIncome = 0;
            let monthlyExpenses = 0;
            let netBalance = 0;
            let wasteTotal = 0; // New: Track Waste

            // Calcular totales del mes actual
            if (appState.transactions) {
                appState.transactions.forEach(t => {
                    // Robust Date Parsing
                    let txDate;
                    if (t.dateIso) {
                        txDate = new Date(t.dateIso);
                    } else if (t.id && !isNaN(new Date(t.id).getTime())) {
                        txDate = new Date(t.id);
                    } else if (t.date) {
                        txDate = new Date(t.date);
                    } else {
                        // Fallback: Check if description has date like "Nov 1"
                        if (typeof t.id === 'string' && !isNaN(parseInt(t.id)) && parseInt(t.id) > 1000000000000) {
                            txDate = new Date(parseInt(t.id));
                        }
                    }

                    if (txDate && !isNaN(txDate.getTime())) {
                        // Check Current Month
                        if (txDate.getMonth() === currentMonth && txDate.getFullYear() === currentYear) {
                            if (t.type === 'income') {
                                monthlyIncome += t.amount;
                            } else if (t.type === 'expense') {
                                monthlyExpenses += t.amount;
                                // New: Check for Waste Focus
                                if (t.budgetFocus === 'Waste') {
                                    wasteTotal += t.amount;
                                }
                            }
                        }
                    }
                });
            }

            // Calcular balance neto desde balance accounts
            if (appState.balanceAccounts) {
                netBalance = (appState.balanceAccounts.pocket || 0) +
                    (appState.balanceAccounts.bank || 0) +
                    (appState.balanceAccounts.credit || 0) +
                    (appState.balanceAccounts.loan || 0);
            }

            // Actualizar elementos del DOM
            const incomeEl = document.getElementById('monthly-income');
            const expensesEl = document.getElementById('monthly-expenses');
            const balanceEl = document.getElementById('w-net-balance');

            // Sidebar Goal Count -> Now Waste Total
            const sidebarWasteEl = document.getElementById('sidebar-goal-count');

            if (incomeEl) incomeEl.innerText = '$' + monthlyIncome.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            if (expensesEl) expensesEl.innerText = '$' + monthlyExpenses.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            if (balanceEl) balanceEl.innerText = '$' + netBalance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            if (sidebarWasteEl) {
                // Using global formatCurrency if available, otherwise manual
                if (typeof formatCurrency === 'function') {
                    // Force no decimals for Waste (Sidebar)
                    sidebarWasteEl.innerText = formatCurrency(wasteTotal).split('.')[0];
                } else {
                    sidebarWasteEl.innerText = '$' + wasteTotal.toLocaleString('en-US', { maximumFractionDigits: 0 });
                }
            }

            // Actualizar variaciones (vs mes anterior)
            updateMonthlyVariations(monthlyIncome, monthlyExpenses);
        }

        function updateMonthlyVariations(currentIncome, currentExpenses) {
            const now = new Date();
            const lastMonth = now.getMonth() - 1;
            const lastMonthYear = lastMonth < 0 ? now.getFullYear() - 1 : now.getFullYear();
            const lastMonthIndex = lastMonth < 0 ? 11 : lastMonth;

            let lastMonthIncome = 0;
            let lastMonthExpenses = 0;

            if (appState.transactions) {
                appState.transactions.forEach(t => {
                    // Robust Date Parsing
                    let txDate;
                    if (t.dateIso) {
                        txDate = new Date(t.dateIso);
                    } else if (t.id && !isNaN(new Date(t.id).getTime())) {
                        txDate = new Date(t.id);
                    } else if (t.date) {
                        txDate = new Date(t.date);
                    } else {
                        if (typeof t.id === 'string' && !isNaN(parseInt(t.id)) && parseInt(t.id) > 1000000000000) {
                            txDate = new Date(parseInt(t.id));
                        }
                    }

                    if (txDate && !isNaN(txDate.getTime())) {
                        if (txDate.getMonth() === lastMonthIndex && txDate.getFullYear() === lastMonthYear) {
                            if (t.type === 'income') lastMonthIncome += t.amount;
                            else if (t.type === 'expense') lastMonthExpenses += t.amount;
                        }
                    }
                });
            }

            // Calcular porcentajes
            const incVariation = lastMonthIncome > 0 ? ((currentIncome - lastMonthIncome) / lastMonthIncome * 100) : 0;
            const expVariation = lastMonthExpenses > 0 ? ((currentExpenses - lastMonthExpenses) / lastMonthExpenses * 100) : 0;

            // Actualizar elementos
            const incVarEl = document.getElementById('inc-variation');
            const expVarEl = document.getElementById('exp-variation');

            if (incVarEl) {
                const icon = incVariation >= 0 ? 'trending-up' : 'trending-down';
                const color = incVariation >= 0 ? 'emerald' : 'red';
                incVarEl.className = `text-${color}-400 font-bold text-sm bg-${color}-500/10 px-2 py-0.5 rounded-lg border border-${color}-500/20 flex items-center gap-1`;
                incVarEl.innerHTML = `<i data-lucide="${icon}" class="w-3 h-3"></i> ${Math.abs(incVariation).toFixed(0)}%`;
            }

            if (expVarEl) {
                const icon = expVariation >= 0 ? 'trending-up' : 'trending-down';
                const color = expVariation >= 0 ? 'rose' : 'emerald';
                expVarEl.className = `text-${color}-400 font-bold text-sm bg-${color}-500/10 px-2 py-0.5 rounded-lg border border-${color}-500/20 flex items-center gap-1`;
                expVarEl.innerHTML = `<i data-lucide="${icon}" class="w-3 h-3"></i> ${Math.abs(expVariation).toFixed(0)}%`;
            }

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // Initialize Wallet UI
        setTimeout(() => {
            updateWalletCategories();
            renderWalletHistory();
            updateMonthlyTotals(); // Initial update
        }, 1200);



        // --- BUDGET LOGIC ---


        // --- CATEGORY DETAILS LOGIC (RESTORED) ---
        // currentDetailCategory is already declared globally


        function openCategoryDetails(catId, catLabel, catIcon) {
            currentDetailCategory = { id: catId, label: catLabel, icon: catIcon };

            // Filter: Current Month Only
            const now = new Date();
            const startMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
            const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1).getTime();

            const transactions = appState.transactions.filter(t =>
                t.category === catId &&
                t.type === 'expense' &&
                t.id >= startMonth && t.id < nextMonth
            );

            // Set Header
            const titleEl = document.getElementById('catDetailsTitle');
            const iconEl = document.getElementById('catDetailsIcon');
            const totalEl = document.getElementById('catDetailsTotal');

            if (titleEl) titleEl.innerText = catLabel;
            if (iconEl) iconEl.innerHTML = `<i data-lucide="${catIcon}" class="w-8 h-8"></i>`;

            const total = transactions.reduce((sum, t) => sum + t.amount, 0);
            if (totalEl) totalEl.innerText = `Total Mes: $${formatCurrency(total)}`;

            // Render List
            const list = document.getElementById('catDetailsList');
            if (!list) return;

            if (transactions.length === 0) {
                list.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-20 opacity-50">
                        <i data-lucide="calendar-off" class="w-12 h-12 mb-2 text-slate-500"></i>
                        <p class="text-slate-500 italic">No hay gastos este mes</p>
                    </div>`;
            } else {
                list.innerHTML = transactions.sort((a, b) => new Date(b.dateIso || b.id) - new Date(a.dateIso || a.id)).map(t => `
                    <div onclick="loadTransactionIntoModal(${t.id})" class="flex items-center justify-between p-4 bg-dark-900 border border-white/5 hover:border-white/10 rounded-2xl cursor-pointer transition group mb-3 relative overflow-hidden">
                        
                        <!-- Hover Highlight -->
                        <div class="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-100 transition duration-300"></div>

                        <div class="flex items-center gap-4 z-10">
                            <div class="h-10 w-10 rounded-xl bg-dark-800 flex items-center justify-center text-slate-400 group-hover:text-white transition shadow-inner">
                                <i data-lucide="${getCategoryIcon(t.category, t.type)}" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <p class="text-sm font-bold text-white group-hover:text-primary transition">${t.name}</p>
                                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">${formatDateShort(t.dateIso || new Date(t.id).toISOString())}</p>
                            </div>
                        </div>
                        <div class="text-right z-10">
                             <span class="block text-white font-black text-sm mb-1">-$${formatCurrency(t.amount).replace('$', '')}</span>
                             ${t.budgetFocus ?
                        `<span class="text-[9px] text-slate-400 bg-white/10 px-2 py-0.5 rounded-md uppercase font-bold tracking-wider">${t.budgetFocus}</span>`
                        : ''}
                        </div>
                    </div>
                `).join('');
            }

            // Show Modal
            const modal = document.getElementById('categoryDetailsModal');
            if (modal) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    const content = document.getElementById('catDetailsContent');
                    if (content) {
                        content.classList.remove('scale-95');
                        content.classList.add('scale-100');
                    }
                }, 10);
            }
            lucide.createIcons();
        }

        function formatDateShort(isoDate) {
            if (!isoDate) return '';
            // Handle incomplete ISO strings just in case
            if (!isoDate.includes('T')) isoDate += 'T12:00:00';
            const d = new Date(isoDate);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }).toUpperCase();
        }

        function closeCategoryDetails() {
            const modal = document.getElementById('categoryDetailsModal');
            if (!modal) return;
            modal.classList.add('opacity-0');
            const content = document.getElementById('catDetailsContent');
            if (content) content.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function signOut() {
            Swal.fire({
                title: 'Signing Out...',
                text: 'See you soon!',
                icon: 'info',
                timer: 2000,
                showConfirmButton: false,
                background: '#1E293B',
                color: '#fff',
                willClose: () => {
                    window.location.reload();
                }
            });
        }

        // Profile Image Uploader Logic
        function handleProfileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const imageDataUrl = e.target.result;
                    // Update the image src
                    const profileImg = document.getElementById('profile-image');
                    if (profileImg) profileImg.src = imageDataUrl;

                    // Save to localStorage
                    localStorage.setItem('userProfileImage', imageDataUrl);

                    Swal.fire({
                        toast: true,
                        icon: 'success',
                        title: 'Foto de perfil actualizada',
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000,
                        background: '#1E293B',
                        color: '#fff'
                    });
                };
                reader.readAsDataURL(file);
            }
        }

        // Load Profile Image on Startup
        document.addEventListener('DOMContentLoaded', () => {
            const savedProfileImage = localStorage.getItem('userProfileImage');
            if (savedProfileImage) {
                const profileImg = document.getElementById('profile-image');
                if (profileImg) profileImg.src = savedProfileImage;
            }
        });

        function openBatchBudgetEditor2() {
            const uiCategories = getBudgetCategoryDefinitions();
            const cats = uiCategories;

            // --- DYNAMIC TIME CALCULATION ---
            const now = new Date();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const FACTOR = daysInMonth / 7; // Dynamic weeks based on actual days (e.g. 31/7 = 4.42)
            const monthName = now.toLocaleString('es-ES', { month: 'long' });

            // Mode State
            let currentViewMode = 'monthly';

            // Helper to generate inputs
            const generateInputs = (mode) => {
                let html = '';
                let total = 0;
                cats.forEach(c => {
                    let val = appState.budget[c.id] || 0;
                    if (mode === 'weekly') {
                        val = val / FACTOR;
                    }
                    total += val;

                    html += `
                    <div class="flex items-center gap-2 p-3 rounded-2xl bg-[#0F111A] border border-white/5 hover:border-indigo-500/30 hover:bg-[#141724] transition-all group relative overflow-hidden">
                        <!-- Hover Glow -->
                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent opacity-0 group-hover:opacity-100 -translate-x-full group-hover:translate-x-full transition-all duration-1000 pointer-events-none"></div>
                        
                        <div class="w-10 h-10 rounded-xl ${c.bg} flex items-center justify-center ${c.color} shrink-0 shadow-lg shadow-black/20 group-hover:scale-110 transition-transform duration-300">
                            <i data-lucide="${c.icon}" class="w-5 h-5"></i>
                        </div>
                        <div class="flex flex-col w-full overflow-hidden z-10">
                            <span class="text-[10px] uppercase font-bold text-slate-500 mb-0.5 truncate tracking-wider group-hover:text-indigo-300 transition-colors">${c.name || c.id}</span>
                            <div class="flex items-center relative">
                                <span class="text-xs font-bold text-slate-600 mr-1.5">$</span>
                                <input type="number"
                                    id="batch-budget-${c.id}"
                                    value="${val.toFixed(2)}"
                                    min="0"
                                    step="any"
                                    class="batch-budget-input w-full bg-transparent text-white text-base font-bold focus:outline-none p-0 h-auto placeholder-slate-700 font-mono tracking-wide"
                                >
                            </div>
                        </div>
                    </div>
                    `;
                });
                return { html, total };
            };

            const initial = generateInputs('monthly');

            Swal.fire({
                html: `
                    <div class="flex flex-col md:flex-row justify-between items-center w-full gap-4 pb-2 mb-4 border-b border-white/5">
                         <div class="flex items-center gap-3">
                            <div class="bg-indigo-500/20 p-2 rounded-xl border border-indigo-500/30 text-indigo-400">
                                <i data-lucide="sliders-horizontal" class="w-6 h-6"></i>
                            </div>
                            <div class="text-left">
                                <h2 class="text-2xl font-black text-white tracking-tight leading-none">Ajustar Presupuesto</h2>
                                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">PLANIFICACIÓN ${monthName.toUpperCase()}</p>
                            </div>
                         </div>
                         
                         <!-- Premium Segmented Control -->
                         <div class="flex items-center bg-[#080A10] p-1.5 rounded-xl border border-white/5 shadow-inner">
                            <button id="btn-mode-month" 
                                class="flex items-center gap-2 px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wider bg-indigo-600 text-white shadow-lg transition-all duration-300" 
                                onclick="window.toggleBudgetMode('monthly')">
                                <i data-lucide="calendar" class="w-3 h-3"></i> Mensual
                            </button>
                            <button id="btn-mode-week" 
                                class="flex items-center gap-2 px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wider text-slate-500 hover:text-white transition-all duration-300 hover:bg-white/5" 
                                onclick="window.toggleBudgetMode('weekly')">
                                <i data-lucide="clock" class="w-3 h-3"></i> Semanal
                            </button>
                         </div>
                    </div>

                    <div class="relative mt-2">
                        <!-- Info Banner for Logic -->
                        <div id="logic-banner" class="hidden mb-4 bg-indigo-500/10 border border-indigo-500/20 rounded-xl p-3 flex items-center justify-between animate-fade-in-down">
                            <div class="flex items-center gap-2">
                                <i data-lucide="info" class="w-4 h-4 text-indigo-400"></i>
                                <span class="text-xs text-indigo-200 font-medium">Cálculo basado en <strong>${daysInMonth} días</strong> este mes</span>
                            </div>
                            <span class="text-[10px] font-mono text-indigo-400 bg-indigo-500/20 px-2 py-0.5 rounded">${FACTOR.toFixed(2)} semanas</span>
                        </div>

                        <!-- Grid -->
                        <div id="batch-inputs-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 max-h-[60vh] overflow-y-auto pr-1 custom-scrollbar">
                            ${initial.html}
                        </div>
                        
                        <!-- Premium Footer -->
                        <div class="mt-6 pt-4 border-t border-white/5 flex justify-between items-center">
                            <div class="flex flex-col items-start gap-1">
                                 <div class="flex items-center gap-2">
                                     <p id="batch-total-label" class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Total Mensual</p>
                                     <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse shadow-[0_0_10px_#10B981]"></div>
                                 </div>
                                 <p class="text-[9px] text-slate-600 font-mono">Limit Global</p>
                            </div>
                            <div class="text-right">
                                <span id="batch-total-display" class="text-4xl font-black text-emerald-400 tracking-tighter drop-shadow-lg">$${initial.total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                            </div>
                        </div>
                    </div>
                `,
                background: '#161b22',
                color: '#fff',
                confirmButtonText: '<i class="fa fa-save"></i> Guardar Cambios',
                confirmButtonColor: '#6366F1',
                showCloseButton: true,
                showCancelButton: true,
                cancelButtonText: 'Cancelar',
                cancelButtonColor: '#0F111A',
                width: '1000px',
                padding: '2rem',
                backdrop: `rgba(0,0,0,0.85) backdrop-filter blur-sm`,
                customClass: {
                    popup: 'rounded-[2.5rem] border border-white/10 shadow-2xl ring-1 ring-white/5',
                    confirmButton: 'rounded-xl px-8 py-3 font-black text-xs uppercase tracking-widest shadow-lg shadow-indigo-500/20 hover:scale-[1.02] transition-transform',
                    cancelButton: 'rounded-xl px-6 py-3 font-bold text-xs text-slate-500 hover:text-white hover:bg-white/5 transition',
                    closeButton: 'text-slate-400 hover:text-white focus:outline-none p-2 hover:bg-white/5 rounded-full transition top-6 right-6',
                    actions: 'gap-4 mt-2 w-full flex justify-end',
                    title: 'p-0 mb-0'
                },
                didOpen: () => {
                    lucide.createIcons();

                    window.toggleBudgetMode = (mode) => {
                        if (mode === currentViewMode) return;
                        currentViewMode = mode;

                        const btnMonth = document.getElementById('btn-mode-month');
                        const btnWeek = document.getElementById('btn-mode-week');
                        const banner = document.getElementById('logic-banner');

                        if (mode === 'monthly') {
                            // Set Monthly UI
                            btnMonth.className = "flex items-center gap-2 px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wider bg-indigo-600 text-white shadow-lg transition-all duration-300";
                            btnWeek.className = "flex items-center gap-2 px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wider text-slate-500 hover:text-white transition-all duration-300 hover:bg-white/5";

                            document.getElementById('batch-total-label').innerText = "Total Mensual";
                            if (banner) banner.classList.add('hidden');
                        } else {
                            // Set Weekly UI
                            btnWeek.className = "flex items-center gap-2 px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wider bg-indigo-600 text-white shadow-lg transition-all duration-300";
                            btnMonth.className = "flex items-center gap-2 px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wider text-slate-500 hover:text-white transition-all duration-300 hover:bg-white/5";

                            document.getElementById('batch-total-label').innerText = "Total Semanal (Est.)";
                            if (banner) banner.classList.remove('hidden');
                        }

                        // Convert Input Values
                        const inputs = document.querySelectorAll('.batch-budget-input');
                        inputs.forEach(inp => {
                            let val = parseFloat(inp.value.replace(/[^0-9.-]+/g, "")) || 0;
                            if (mode === 'weekly') {
                                // Converting Monthly -> Weekly
                                inp.value = (val / FACTOR).toFixed(2);
                            } else {
                                // Converting Weekly -> Monthly
                                inp.value = (val * FACTOR).toFixed(2);
                            }
                        });
                        updateTotal();
                    };

                    const inputsEl = document.querySelectorAll('.batch-budget-input');
                    const totalEl = document.getElementById('batch-total-display');

                    const updateTotal = () => {
                        let total = 0;
                        inputsEl.forEach(inp => total += parseFloat(inp.value) || 0);
                        totalEl.innerText = '$' + total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    };

                    inputsEl.forEach(inp => {
                        // Select all text on focus for easier editing
                        inp.addEventListener('focus', function () { this.select(); });
                        inp.addEventListener('input', updateTotal);
                    });
                },
                willClose: () => {
                    delete window.toggleBudgetMode;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    let newTotal = 0;
                    cats.forEach(c => {
                        const el = document.getElementById(`batch-budget-${c.id}`);
                        if (el) {
                            let val = parseFloat(el.value) || 0;

                            // Convert back to Monthly if in Weekly mode
                            if (currentViewMode === 'weekly') {
                                val = val * FACTOR;
                            }

                            appState.budget[c.id] = val;
                            newTotal += val;
                        }
                    });

                    appState.budget.limit = newTotal;
                    saveState();
                    renderBudgetTab();

                    Swal.fire({
                        toast: true,
                        position: 'top',
                        icon: 'success',
                        title: 'Presupuesto Actualizado',
                        background: '#1E293B',
                        color: '#fff',
                        timer: 2000,
                        showConfirmButton: false,
                        customClass: { popup: 'rounded-xl border border-white/10 shadow-lg' }
                    });
                }
            });
        }

        function openCategoryModal(focusCategory) {
            // 1. DEFINITIONS & MAPPING
            const focusMap = {
                'Needs': ['Housing', 'Groceries', 'Transport', 'Health', 'Education', 'Gas'],
                'Wants': ['Food', 'Shopping', 'Entertainment', 'Travel', 'Love', 'Others'],
                'Invest': ['Investment'],
                'Waste': ['Beer', 'Junk Food', 'Weed'],
                'Save': [] // Special case
            };

            const colorTheme = {
                'Needs': { main: '#6366f1', bg: 'bg-indigo-500', text: 'text-indigo-400', name: 'indigo' },
                'Wants': { main: '#ec4899', bg: 'bg-pink-500', text: 'text-pink-400', name: 'pink' },
                'Save': { main: '#10b981', bg: 'bg-emerald-500', text: 'text-emerald-400', name: 'emerald' },
                'Invest': { main: '#f97316', bg: 'bg-orange-500', text: 'text-orange-400', name: 'orange' },
                'Waste': { main: '#ef4444', bg: 'bg-red-500', text: 'text-red-400', name: 'red' }
            };

            const theme = colorTheme[focusCategory] || colorTheme['Needs'];
            const targetCats = focusMap[focusCategory] || [];

            // 2. DATA AGGREGATION
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // Get Transactions
            const txs = (appState.transactions || []).filter(t => {
                const d = t.dateIso ? new Date(t.dateIso) : new Date(t.date);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });

            // Calculate Totals
            let totalIncome = 0;
            let totalExpense = 0;
            let focusTotal = 0;
            const subCatBreakdown = {};

            txs.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += parseFloat(t.amount) || 0;
                    return;
                }
                if (t.type === 'expense') {
                    const amt = Math.abs(parseFloat(t.amount) || 0);
                    totalExpense += amt;

                    if (focusCategory === 'Save') return; // Handled separately

                    if (targetCats.includes(t.category)) {
                        focusTotal += amt;
                        subCatBreakdown[t.category] = (subCatBreakdown[t.category] || 0) + amt;
                    }
                }
            });

            // Special Logic for SAVE
            if (focusCategory === 'Save') {
                focusTotal = Math.max(0, totalIncome - totalExpense);
                // Breakdown for Save could be "Retained Earnings" vs "Goal Deposits" (if tracked), 
                // for now just show single chunk
                subCatBreakdown['Savings'] = focusTotal;
            }

            // Calculations
            const incomePct = totalIncome > 0 ? (focusTotal / totalIncome) * 100 : 0;
            const formattedTotal = focusTotal.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });

            // Prepare Chart Data
            const chartLabels = Object.keys(subCatBreakdown);
            const chartSeries = Object.values(subCatBreakdown);

            // If empty (no spend), show mock empty state
            const hasData = chartSeries.length > 0 && chartSeries.some(v => v > 0);

            // 3. UI TEMPLATE
            Swal.fire({
                title: `
                    <div class="flex items-center gap-4 px-2">
                        <div class="w-12 h-12 rounded-2xl ${theme.bg}/20 border border-${theme.name}-500/30 flex items-center justify-center shadow-[0_0_15px_rgba(0,0,0,0.3)]">
                            <i data-lucide="${focusCategory === 'Waste' ? 'trash-2' : (focusCategory === 'Save' ? 'piggy-bank' : 'pie-chart')}" class="w-6 h-6 ${theme.text}"></i>
                        </div>
                        <div class="text-left">
                            <h2 class="text-3xl font-black text-white tracking-tighter">${focusCategory}</h2>
                            <span class="text-[10px] font-bold uppercase tracking-widest text-slate-500">ANÁLISIS DE IMPACTO</span>
                        </div>
                    </div>
                `,
                html: `
                    <div class="mt-6 flex flex-col gap-6">
                        
                        <!-- KPI Cards -->
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-[#0b0d10] p-4 rounded-2xl border border-white/5 relative overflow-hidden group">
                                <div class="absolute top-0 right-0 w-16 h-16 ${theme.bg}/5 rounded-full blur-xl -mr-4 -mt-4"></div>
                                <span class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">Total ${focusCategory === 'Save' ? 'Ahorrado' : 'Gastado'}</span>
                                <div class="text-2xl font-black text-white mt-1 tracking-tight">${formattedTotal}</div>
                            </div>
                            <div class="bg-[#0b0d10] p-4 rounded-2xl border border-white/5 relative overflow-hidden group">
                                <div class="absolute top-0 right-0 w-16 h-16 ${theme.bg}/5 rounded-full blur-xl -mr-4 -mt-4"></div>
                                <span class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">% de Ingresos</span>
                                <div class="text-2xl font-black ${theme.text} mt-1 tracking-tight">${incomePct.toFixed(1)}%</div>
                            </div>
                        </div>

                        <!-- Chart Section -->
                         <div class="bg-[#0b0d10] border border-white/5 rounded-3xl p-6 relative min-h-[250px] flex items-center justify-center">
                            ${!hasData
                        ? `<div class="text-center text-slate-600 text-xs italic">No hay datos registrados este mes.</div>`
                        : `<div id="focus-breakdown-chart" class="w-full h-full"></div>`
                    }
                        </div>

                        <!-- Top Offenders List -->
                        ${hasData ? `
                        <div class="space-y-3">
                            <div class="flex items-center justify-between px-1">
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Desglose</span>
                                <span class="text-[10px] font-bold text-slate-600 uppercase">Top 5</span>
                            </div>
                            <div class="space-y-2 max-h-[160px] overflow-y-auto pr-1 custom-scrollbar">
                                ${chartLabels.map((cat, i) => {
                        const val = chartSeries[i];
                        const pct = focusTotal > 0 ? (val / focusTotal) * 100 : 0;
                        return `
                                    <div class="flex items-center justify-between p-3 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 transition-colors group">
                                        <div class="flex items-center gap-3">
                                            <div class="w-2 h-2 rounded-full ${theme.bg} shadow-[0_0_8px_currentColor] opacity-80"></div>
                                            <span class="text-xs font-bold text-slate-200">${cat}</span>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <span class="text-[10px] font-bold text-slate-500">${pct.toFixed(0)}%</span>
                                            <span class="text-xs font-mono font-bold text-white">$${val.toLocaleString()}</span>
                                        </div>
                                    </div>
                                    `;
                    }).join('')}
                            </div>
                        </div>
                        ` : ''}

                    </div>
                `,
                background: '#161b22',
                color: '#fff',
                showConfirmButton: false, // Purely informational
                showCloseButton: true,
                width: '480px',
                padding: '2rem',
                backdrop: `rgba(0,0,0,0.85) backdrop-filter blur-md`,
                customClass: {
                    popup: 'rounded-[2.5rem] border border-white/10 shadow-2xl ring-1 ring-white/5',
                    closeButton: 'text-slate-400 hover:text-white focus:outline-none p-2 hover:bg-white/5 rounded-full transition top-6 right-6',
                },
                didOpen: () => {
                    lucide.createIcons();

                    if (hasData) {
                        const chartEl = document.getElementById('focus-breakdown-chart');
                        const options = {
                            series: chartSeries,
                            labels: chartLabels,
                            chart: {
                                type: 'donut',
                                height: 220,
                                fontFamily: 'Inter, sans-serif',
                                background: 'transparent'
                            },
                            colors: ['#6366f1', '#8b5cf6', '#ec4899', '#f43f5e', '#f97316', '#10b981', '#06b6d4', '#3b82f6'],
                            plotOptions: {
                                pie: {
                                    donut: {
                                        size: '75%',
                                        labels: {
                                            show: true,
                                            name: { show: false },
                                            value: {
                                                show: true,
                                                fontSize: '24px',
                                                fontWeight: 900,
                                                color: '#fff',
                                                formatter: function (val) {
                                                    return '$' + parseInt(val).toLocaleString();
                                                }
                                            },
                                            total: {
                                                show: true,
                                                showAlways: true,
                                                label: 'Total',
                                                fontSize: '10px',
                                                color: '#64748b',
                                                formatter: function (w) {
                                                    const sum = w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                                                    return '$' + sum.toLocaleString();
                                                }
                                            }
                                        }
                                    }
                                }
                            },
                            stroke: { show: false },
                            dataLabels: { enabled: false },
                            legend: { show: false },
                            tooltip: {
                                theme: 'dark',
                                y: {
                                    formatter: function (val) {
                                        return '$' + val.toLocaleString();
                                    }
                                }
                            }
                        };
                        new ApexCharts(chartEl, options).render();
                    }
                }
            });
        }


        // --- WALLET CATEGORY LOGIC ---
        function populateWalletCategories() {
            updateWalletCategories();
        }

        function selectWalletCategory(id) {
            document.getElementById('w-category').value = id;
            document.querySelectorAll('.cat-item').forEach(el => {
                el.classList.remove('bg-indigo-500', 'border-indigo-500');
                el.classList.add('bg-dark-800', 'border-white/5');
                const icon = el.querySelector('i');
                if (icon) icon.classList.remove('text-white');
                if (icon) icon.classList.add('text-slate-500');
            });
            const selected = document.getElementById(`cat-${id}`);
            if (selected) {
                selected.classList.remove('bg-dark-800', 'border-white/5');
                selected.classList.add('bg-indigo-500', 'border-indigo-500');
                const icon = selected.querySelector('i');
                if (icon) icon.classList.remove('text-slate-500');
                if (icon) icon.classList.add('text-white');
            }
        }

        // --- STANDALONE WEEKLY CHART RENDERER ---
        function renderWalletWeeklyChart() {
            // Wait for DOM layout to be ready via setTimeout
            setTimeout(() => {
                const container = document.getElementById('weekly-activity-bars');
                if (!container) {
                    // console.log('Chart container not found');
                    return;
                }

                // Get weekly data (Last 7 Days including today)
                const today = new Date();
                const categories = [];
                const incomeData = [];
                const expenseData = [];
                const dayNames = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];

                // Loop for last 7 days
                for (let i = 6; i >= 0; i--) {
                    const d = new Date(today);
                    d.setDate(today.getDate() - i);

                    const dStart = new Date(d); dStart.setHours(0, 0, 0, 0);
                    const dEnd = new Date(d); dEnd.setHours(23, 59, 59, 999);

                    let inc = 0;
                    let exp = 0;

                    if (typeof appState !== 'undefined' && appState.transactions) {
                        appState.transactions.forEach(t => {
                            let tDate;
                            if (t.dateIso) tDate = new Date(t.dateIso);
                            else if (typeof t.id === 'number' && t.id > 1600000000000) tDate = new Date(t.id);
                            else {
                                tDate = new Date(t.date);
                                if (isNaN(tDate.getTime())) {
                                    tDate = new Date(t.date + ", " + new Date().getFullYear());
                                }
                                if (isNaN(tDate.getTime())) tDate = new Date(t.id);
                            }

                            if (!isNaN(tDate.getTime()) && tDate >= dStart && tDate <= dEnd) {
                                if (t.type === 'income') inc += parseFloat(t.amount) || 0;
                                if (t.type === 'expense') exp += parseFloat(t.amount) || 0;
                            }
                        });
                    }

                    // Format: Day Name (e.g. "Lun")
                    categories.push(dayNames[d.getDay()]);
                    incomeData.push(inc);
                    expenseData.push(exp);
                }

                // Update the label
                const label = document.getElementById('weekly-activity-label');
                if (label) {
                    label.innerText = "Last 7 Days";
                }

                // If chart exists, try to update it
                if (globalWalletChart) {
                    // Check if DOM node is still valid and attached
                    if (document.body.contains(container) && container.innerHTML.trim() !== '') {
                        try {
                            globalWalletChart.updateOptions({
                                xaxis: { categories: categories }
                            });
                            globalWalletChart.updateSeries([
                                { name: 'Income', data: incomeData },
                                { name: 'Expense', data: expenseData }
                            ]);
                            return;
                        } catch (e) {
                            console.warn("Chart update failed, recreating...", e);
                            globalWalletChart.destroy();
                            globalWalletChart = null;
                        }
                    } else {
                        globalWalletChart = null;
                    }
                }

                // Check again if we need to clean container (if chart was nullified above)
                if (!globalWalletChart) {
                    container.innerHTML = '';
                }

                // Check if ApexCharts is available
                if (typeof ApexCharts === 'undefined') {
                    console.error('ApexCharts library not loaded');
                    container.innerHTML = '<div style="color: red; padding: 20px;">ApexCharts library not loaded</div>';
                    return;
                }

                try {
                    const options = {
                        chart: {
                            type: 'area',
                            height: '100%',
                            width: '100%',
                            toolbar: { show: false },
                            background: 'transparent',
                            fontFamily: 'Inter, sans-serif',
                            animations: { enabled: true }
                        },
                        series: [
                            { name: 'Income', data: incomeData },
                            { name: 'Expense', data: expenseData }
                        ],
                        stroke: { curve: 'smooth', width: 3 },
                        colors: ['#22C55E', '#EF4444'],
                        fill: {
                            type: 'gradient',
                            gradient: {
                                shadeIntensity: 1,
                                opacityFrom: 0.4,
                                opacityTo: 0.05,
                                stops: [0, 90, 100]
                            }
                        },
                        dataLabels: { enabled: false },
                        grid: {
                            borderColor: '#334155',
                            strokeDashArray: 4,
                            xaxis: { lines: { show: false } },
                            padding: { top: 10, right: 20, bottom: 10, left: 20 }
                        },
                        xaxis: {
                            categories: categories,
                            labels: {
                                style: { colors: '#64748b', fontSize: '12px' }
                            },
                            axisBorder: { show: false },
                            axisTicks: { show: false },
                            tooltip: { enabled: false }
                        },
                        yaxis: {
                            labels: {
                                style: { colors: '#64748b', fontSize: '12px' },
                                formatter: (value) => {
                                    return value >= 1000 ? `${(value / 1000).toFixed(1)}k` : value;
                                }
                            }
                        },
                        legend: { show: false },
                        tooltip: { theme: 'dark' }
                    };

                    // Assign to global variable properly
                    if (window.ApexCharts) {
                        globalWalletChart = new ApexCharts(container, options);
                        globalWalletChart.render();
                        console.log('Chart rendered successfully');
                    }
                } catch (error) {
                    console.error('Error rendering chart:', error);

                    // Fallback UI in case of error, to avoid empty box
                    container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-slate-500">
                    <i data-lucide="alert-circle" class="w-8 h-8 mb-2 opacity-50"></i>
                    <span class="text-xs">No se pudo cargar el gráfico</span>
                </div>
            `;
                    if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
                }
            }, 300); // Increased delay for layout stability
        }
        // --- WALLET CALENDAR V3 (Robust & Namespace Isolated) ---
        var WalletCalendarV3 = {
            date: new Date(),
            selectedDate: new Date(),
            initialized: false,
            init: function () {
                if (this.initialized) return;

                // Polling to ensure element exists
                const checkInterval = setInterval(() => {
                    const grid = document.getElementById('wc-v3-grid');
                    if (grid) {
                        clearInterval(checkInterval);
                        this.initialized = true;
                        document.getElementById('wc-v3-container').classList.remove('hidden');
                        this.render();
                    }
                }, 100);
            },
            changeMonth: function (delta) {
                this.date.setMonth(this.date.getMonth() + delta);
                this.render();
            },
            goToToday: function () {
                this.date = new Date();
                this.selectedDate = new Date();
                this.render();
                renderWalletHistory(this.selectedDate);
            },
            selectDate: function (year, month, day, data) {
                this.selectedDate = new Date(year, month, day);
                this.render();
                // Update History List instead of Popup
                renderWalletHistory(this.selectedDate);
            },
            getWeeklyData: function (centerDate) {
                // Calculate start of week (Sunday)
                const startOfWeek = new Date(centerDate);
                startOfWeek.setDate(centerDate.getDate() - centerDate.getDay());

                const weeklyData = [];
                let maxVal = 0;

                for (let i = 0; i < 7; i++) {
                    const d = new Date(startOfWeek);
                    d.setDate(startOfWeek.getDate() + i);

                    let total = 0;
                    if (appState && appState.transactions) {
                        appState.transactions.forEach(t => {
                            let tDate;
                            if (t.dateIso) tDate = new Date(t.dateIso);
                            else if (typeof t.id === 'number' && t.id > 1600000000000) tDate = new Date(t.id);
                            else { tDate = new Date(t.date + ", " + new Date().getFullYear()); if (isNaN(tDate.getTime())) tDate = new Date(t.id); }

                            if (!isNaN(tDate.getTime()) &&
                                tDate.getDate() === d.getDate() &&
                                tDate.getMonth() === d.getMonth() &&
                                tDate.getFullYear() === d.getFullYear()) {
                                if (t.type === 'expense') total += parseFloat(t.amount) || 0;
                            }
                        });
                    }
                    if (total > maxVal) maxVal = total;
                    weeklyData.push({ date: d, total: total });
                }
                return { data: weeklyData, max: maxVal > 0 ? maxVal : 100 };
            },
            getWeeklyData: function (centerDate) {
                // Ensure valid date, default to Today
                const targetDate = (centerDate instanceof Date && !isNaN(centerDate)) ? centerDate : new Date();

                // Calculate start of week (Sunday)
                const startOfWeek = new Date(targetDate);
                startOfWeek.setDate(targetDate.getDate() - targetDate.getDay());
                startOfWeek.setHours(0, 0, 0, 0);

                const weeklyData = [];
                let maxVal = 0;

                for (let i = 0; i < 7; i++) {
                    const d = new Date(startOfWeek);
                    d.setDate(startOfWeek.getDate() + i);
                    // Match full day range
                    const dStart = new Date(d); dStart.setHours(0, 0, 0, 0);
                    const dEnd = new Date(d); dEnd.setHours(23, 59, 59, 999);

                    let total = 0;
                    if (appState && appState.transactions) {
                        appState.transactions.forEach(t => {
                            let tDate;
                            if (t.dateIso) tDate = new Date(t.dateIso);
                            else if (typeof t.id === 'number' && t.id > 1600000000000) tDate = new Date(t.id);
                            else { tDate = new Date(t.date + ", " + new Date().getFullYear()); if (isNaN(tDate.getTime())) tDate = new Date(t.id); }

                            if (!isNaN(tDate.getTime()) && tDate >= dStart && tDate <= dEnd) {
                                if (t.type === 'expense') total += parseFloat(t.amount) || 0;
                            }
                        });
                    }
                    if (total > maxVal) maxVal = total;
                    weeklyData.push({ date: d, total: total });
                }
                // Return dummy max if 0 to avoid division by zero
                return { data: weeklyData, max: maxVal > 0 ? maxVal : 100 };
            },
            getWeeklyComparison: function (centerDate) {
                const targetDate = (centerDate instanceof Date && !isNaN(centerDate)) ? centerDate : new Date();
                const startOfWeek = new Date(targetDate);
                startOfWeek.setDate(targetDate.getDate() - targetDate.getDay());
                startOfWeek.setHours(0, 0, 0, 0);

                const days = [];
                const incomeData = [];
                const expenseData = [];

                for (let i = 0; i < 7; i++) {
                    const d = new Date(startOfWeek);
                    d.setDate(startOfWeek.getDate() + i);

                    const dStart = new Date(d); dStart.setHours(0, 0, 0, 0);
                    const dEnd = new Date(d); dEnd.setHours(23, 59, 59, 999);

                    let inc = 0;
                    let exp = 0;

                    if (appState && appState.transactions) {
                        appState.transactions.forEach(t => {
                            let tDate;
                            if (t.dateIso) tDate = new Date(t.dateIso);
                            else if (typeof t.id === 'number' && t.id > 1600000000000) tDate = new Date(t.id);
                            else { tDate = new Date(t.date + ", " + new Date().getFullYear()); if (isNaN(tDate.getTime())) tDate = new Date(t.id); }

                            if (!isNaN(tDate.getTime()) && tDate >= dStart && tDate <= dEnd) {
                                if (t.type === 'income') inc += parseFloat(t.amount) || 0;
                                if (t.type === 'expense') exp += parseFloat(t.amount) || 0;
                            }
                        });
                    }
                    days.push(d.toLocaleDateString('en-US', { weekday: 'short' }));
                    incomeData.push(inc);
                    expenseData.push(exp);
                }
                return { categories: days, income: incomeData, expense: expenseData };
            },

            renderWeeklyActivity: function () {
                const container = document.getElementById('weekly-activity-bars');
                const label = document.getElementById('weekly-activity-label');
                if (!container) return;

                const { categories, income, expense } = this.getWeeklyComparison(this.selectedDate || new Date());

                // Update Label
                if (label) {
                    const targetDate = (this.selectedDate instanceof Date && !isNaN(this.selectedDate)) ? this.selectedDate : new Date();
                    const start = new Date(targetDate); start.setDate(targetDate.getDate() - targetDate.getDay());
                    const end = new Date(start); end.setDate(start.getDate() + 6);
                    label.innerText = `${start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${end.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
                }

                // Check if container is empty or chart variable is missing
                const isContainerEmpty = container.innerHTML.trim() === '';

                if (!window.walletWeeklyChart || isContainerEmpty) {
                    container.innerHTML = ''; // Ensure clear
                    // Clean up potential stale instance
                    if (window.walletWeeklyChart) {
                        try { window.walletWeeklyChart.destroy(); } catch (e) { }
                    }

                    const options = {
                        chart: { type: 'area', height: '100%', width: '100%', toolbar: { show: false }, background: 'transparent' },
                        series: [{ name: 'Income', data: income }, { name: 'Expense', data: expense }],
                        stroke: { curve: 'smooth', width: 3 },
                        colors: ['#6366F1', '#EC4899'], // Indigo and Pink
                        fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.05, stops: [0, 100] } },
                        dataLabels: { enabled: false },
                        grid: { borderColor: '#334155', strokeDashArray: 4, xaxis: { lines: { show: false } }, padding: { top: 0, right: 10, bottom: 0, left: 10 } },
                        xaxis: { categories: categories, labels: { style: { colors: '#64748b', fontSize: '12px' } }, axisBorder: { show: false }, axisTicks: { show: false }, tooltip: { enabled: false } },
                        yaxis: { labels: { style: { colors: '#64748b', fontSize: '12px' }, formatter: (value) => { return value >= 1000 ? `${(value / 1000).toFixed(1)}k` : value; } } },
                        legend: { show: false },
                        tooltip: {
                            theme: 'dark',
                            y: {
                                formatter: function (val) {
                                    return formatCurrency(val).replace('$', '').trim();
                                }
                            }
                        }
                    };

                    window.walletWeeklyChart = new ApexCharts(container, options);
                    window.walletWeeklyChart.render();
                } else {
                    window.walletWeeklyChart.updateOptions({
                        xaxis: { categories: categories },
                        tooltip: {
                            y: {
                                formatter: function (val) {
                                    return formatCurrency(val).replace('$', '').trim();
                                }
                            }
                        }
                    });
                    window.walletWeeklyChart.updateSeries([{ name: 'Income', data: income }, { name: 'Expense', data: expense }]);
                }
            },
            showDetails: function (day, month, year, data) {
                const dateStr = new Date(year, month, day).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                const listHtml = data.txs.length > 0 ? data.txs.map(t => `
                    <div class="flex items-center justify-between p-3 rounded-xl bg-white/5 border border-white/5 mb-2 last:mb-0 hover:bg-white/10 transition">
                        <div class="flex items-center gap-3">
                             <div class="w-8 h-8 rounded-full ${t.type === 'income' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'} flex items-center justify-center">
                                <i data-lucide="${t.type === 'income' ? 'arrow-down-left' : 'arrow-up-right'}" class="w-4 h-4"></i>
                            </div>
                            <div class="text-left">
                               <p class="text-xs font-bold text-white line-clamp-1">${t.name || t.description || 'Transaction'}</p>
                               <span class="inline-block px-1.5 py-0.5 rounded text-[8px] font-bold uppercase tracking-wider ${t.type === 'income' ? 'bg-emerald-500/10 text-emerald-400' : 'bg-red-500/10 text-red-400'}">${t.category}</span>
                            </div>
                        </div>
                         <span class="text-sm font-black ${t.type === 'income' ? 'text-emerald-400' : 'text-slate-200'}">
                            ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount).replace('$', '')}
                        </span>
                    </div>
                `).join('') : '<div class="flex flex-col items-center justify-center py-8 text-slate-500"><i data-lucide="calendar-off" class="w-8 h-8 mb-2 opacity-50"></i><p class="text-xs">No transactions found</p></div>';

                Swal.fire({
                    title: `<div class="text-left w-full pl-2">
                                <span class="block text-2xl font-black text-white capitalize">${day}</span>
                                <span class="text-[10px] text-slate-500 uppercase tracking-widest font-bold block -mt-1 opacity-70">Daily Summary</span>
                            </div>`,
                    html: `
                        <div class="bg-dark-800 rounded-2xl p-4 border border-white/5 mb-4">
                            <div class="flex justify-between items-end">
                                <span class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Net Total</span>
                                <h2 class="text-3xl font-black ${data.total > 0 ? 'text-red-400' : 'text-white'}">$${formatCurrency(data.total).replace('$', '')}</h2>
                            </div>
                        </div>
                        <div class="text-left">
                            <h4 class="text-xs font-bold text-slate-400 mb-3 ml-1 uppercase tracking-wider">Activity Log</h4>
                            <div class="max-h-[300px] overflow-y-auto custom-scrollbar pr-1">
                                ${listHtml}
                            </div>
                        </div>
                    `,
                    background: '#0F111A',
                    color: '#fff',
                    showConfirmButton: false,
                    showCloseButton: true,
                    width: '400px',
                    padding: '1.5rem',
                    customClass: { popup: 'rounded-[2rem] border border-white/10 shadow-2xl backdrop-blur-xl' },
                    didOpen: () => lucide.createIcons()
                });
            },
            render: function () {
                try {
                    // Always try to render the chart first, as the calendar grid might be hidden/removed
                    this.renderWeeklyActivity();

                    const grid = document.getElementById('wc-v3-grid');
                    if (!grid) return;
                    grid.innerHTML = '';

                    const year = this.date.getFullYear();
                    const month = this.date.getMonth();

                    // Update Headers
                    const titleDay = document.getElementById('wc-v3-title-day');
                    const titleMonth = document.getElementById('wc-v3-title-month');
                    const selectedTotalEl = document.getElementById('wc-v3-selected-total');

                    if (titleDay) {
                        const dayName = this.selectedDate.toLocaleDateString('es-ES', { weekday: 'long' });
                        const dayNum = this.selectedDate.getDate();
                        // Capitalize first letter
                        titleDay.innerText = `${dayName.charAt(0).toUpperCase() + dayName.slice(1)}, ${dayNum}`;
                    }
                    if (titleMonth) {
                        const monthName = this.date.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                        titleMonth.innerText = monthName.toUpperCase();
                    }

                    // Highlight Current Day of Week in Header
                    const currentDayOfWeekIndex = new Date().getDay(); // 0 = Sunday
                    const headerDays = document.getElementById('wc-v3-header-row');
                    if (headerDays) {
                        Array.from(headerDays.children).forEach((child, index) => {
                            // index 0 is Sunday, which matches getDay()
                            if (index === currentDayOfWeekIndex) {
                                child.className = 'text-[9px] font-black text-white bg-white/20 rounded px-1 py-0.5';
                            } else {
                                child.className = 'text-[9px] font-bold text-slate-500';
                            }
                        });
                    }

                    // Render Weekly Activity based on selection
                    this.renderWeeklyActivity();


                    // Data Processing
                    const dailyData = {};
                    let selectedDayTotal = 0;

                    if (appState && appState.transactions) {
                        appState.transactions.forEach(t => {
                            let d;
                            // Robust Date Parsing
                            if (t.dateIso) d = new Date(t.dateIso);
                            else if (typeof t.id === 'number' && t.id > 1600000000000) d = new Date(t.id); // Timestamp ID
                            else {
                                // Try basic format + year
                                d = new Date(t.date + ", " + new Date().getFullYear());
                                if (isNaN(d.getTime())) d = new Date(t.id);
                            }

                            if (!isNaN(d.getTime()) && d.getMonth() === month && d.getFullYear() === year) {
                                const dayNum = d.getDate();
                                if (!dailyData[dayNum]) dailyData[dayNum] = { total: 0, count: 0, txs: [] };

                                const amt = parseFloat(t.amount) || 0;
                                if (t.type === 'expense') dailyData[dayNum].total += amt;

                                dailyData[dayNum].count++;
                                dailyData[dayNum].txs.push(t);

                                // Check if this tx belongs to selected date
                                if (d.getDate() === this.selectedDate.getDate() &&
                                    d.getMonth() === this.selectedDate.getMonth() &&
                                    d.getFullYear() === this.selectedDate.getFullYear()) {
                                    if (t.type === 'expense') selectedDayTotal += amt;
                                }
                            }
                        });
                    }

                    if (selectedTotalEl) selectedTotalEl.innerText = formatCurrency(selectedDayTotal);

                    // Stats for Heatmap
                    const totals = Object.values(dailyData).map(d => d.total);
                    const maxTotal = Math.max(...totals, 1); // Avoid div by zero

                    // Grid Generation
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    const firstDayIndex = new Date(year, month, 1).getDay(); // 0 is Sunday

                    const today = new Date();

                    // Empty cells
                    for (let i = 0; i < firstDayIndex; i++) {
                        const cell = document.createElement('div');
                        cell.className = "h-10 rounded-xl bg-white/0 border border-white/0"; // Invisible filler
                        grid.appendChild(cell);
                    }

                    // Days
                    for (let i = 1; i <= daysInMonth; i++) {
                        const dayData = dailyData[i] || { total: 0, count: 0, txs: [] };
                        const isToday = today.getDate() === i && today.getMonth() === month && today.getFullYear() === year;
                        const isSelected = this.selectedDate.getDate() === i && this.selectedDate.getMonth() === month && this.selectedDate.getFullYear() === year;

                        const btn = document.createElement('button');

                        // Dynamic Classes
                        let bgClass = "bg-dark-800 hover:bg-dark-600";
                        let textClass = "text-slate-400";
                        let borderClass = "border border-white/5";

                        // Heatmap Logic
                        if (dayData.total > 0) {
                            const intensity = dayData.total / maxTotal;
                            if (intensity > 0.7) {
                                bgClass = "bg-red-500/20 hover:bg-red-500/30";
                                textClass = "text-red-400 font-bold";
                                borderClass = "border border-red-500/30";
                            } else if (intensity > 0.3) {
                                bgClass = "bg-orange-500/15 hover:bg-orange-500/25";
                                textClass = "text-orange-300";
                                borderClass = "border border-orange-500/20";
                            } else {
                                bgClass = "bg-blue-500/10 hover:bg-blue-500/20";
                                textClass = "text-blue-300";
                                borderClass = "border border-blue-500/10";
                            }
                        }

                        // State Overrides
                        if (isSelected) {
                            bgClass = "bg-white shadow-[0_0_15px_rgba(255,255,255,0.3)] scale-110 z-10";
                            textClass = "text-dark-900 font-black";
                            borderClass = "border-transparent";
                        } else if (isToday) {
                            bgClass = "bg-indigo-500 shadow-indigo-500/50";
                            textClass = "text-white font-bold";
                            borderClass = "border-transparent";
                        }

                        btn.className = `h-10 rounded-xl flex flex-col items-center justify-center transition-all duration-300 ${bgClass} ${borderClass} group relative`;
                        btn.onclick = () => this.selectDate(year, month, i, dayData);

                        let innerContent = `<span class="${textClass} text-xs transition-colors">${i}</span>`;

                        // Dot for transactions
                        if (dayData.count > 0 && !isSelected) {
                            innerContent += `<span class="absolute bottom-1 w-1 h-1 rounded-full ${isToday ? 'bg-white' : 'bg-slate-500'} opacity-50"></span>`;
                        }

                        btn.innerHTML = innerContent;
                        grid.appendChild(btn);
                    }

                } catch (e) {
                    console.error("V3 Render Error", e);
                }
            }
        };

        // Initialize V3
        WalletCalendarV3.init();

        function selectFocus(focusType) {
            document.getElementById('w-focus').value = focusType;

            const focusMap = {
                'Needs': { color: 'indigo', icon: 'home' },
                'Wants': { color: 'pink', icon: 'star' },
                'Saving': { color: 'emerald', icon: 'piggy-bank' },
                'Investment': { color: 'orange', icon: 'trending-up' },
                'Debt': { color: 'purple', icon: 'credit-card' },
                'Waste': { color: 'red', icon: 'trash-2' }
            };

            const allTypes = Object.keys(focusMap);

            allTypes.forEach(type => {
                const el = document.getElementById(`focus-${type}`);
                if (!el) return;

                // Reset to default
                el.className = "focus-item flex flex-col items-center justify-center p-2 rounded-xl border border-white/5 bg-dark-800 hover:bg-dark-700 cursor-pointer transition-all";
                const icon = el.querySelector('i');
                const text = el.querySelector('span');

                if (icon) {
                    icon.className = `w-4 h-4 mb-1 text-slate-400`;
                    // Reset icon color
                }
                if (text) {
                    text.className = "text-[8px] uppercase font-bold text-slate-500";
                }
            });

            // Activate selected
            const activeEl = document.getElementById(`focus-${focusType}`);
            if (activeEl) {
                const config = focusMap[focusType] || { color: 'indigo' };
                // Using Tailwind arbitrary values for dynamic colors might be tricky if not safe-listed, 
                // but let's try standard palette classes or style attributes.

                // We'll use specific classes similar to the "Wants" example in the original HTML
                let activeClass = "";
                let iconClass = "w-4 h-4 mb-1 ";
                let textClass = "text-[8px] uppercase font-bold text-white";

                if (focusType === 'Needs') {
                    activeClass = "bg-indigo-500/20 border-indigo-500 ring-1 ring-indigo-500";
                    iconClass += "text-indigo-400";
                } else if (focusType === 'Wants') {
                    activeClass = "bg-pink-500/20 border-pink-500 ring-1 ring-pink-500";
                    iconClass += "text-pink-400";
                } else if (focusType === 'Saving') {
                    activeClass = "bg-emerald-500/20 border-emerald-500 ring-1 ring-emerald-500";
                    iconClass += "text-emerald-400";
                } else if (focusType === 'Investment') {
                    activeClass = "bg-orange-500/20 border-orange-500 ring-1 ring-orange-500";
                    iconClass += "text-orange-400";
                } else if (focusType === 'Debt') {
                    activeClass = "bg-purple-500/20 border-purple-500 ring-1 ring-purple-500";
                    iconClass += "text-purple-400";
                } else if (focusType === 'Waste') {
                    activeClass = "bg-red-500/20 border-red-500 ring-1 ring-red-500";
                    iconClass += "text-red-400";
                }

                activeEl.className = `focus-item flex flex-col items-center justify-center p-2 rounded-xl cursor-pointer transition-all border ${activeClass}`;
                const icon = activeEl.querySelector('i');
                const text = activeEl.querySelector('span');

                if (icon) icon.className = iconClass;
                if (text) text.className = textClass;
            }
        }

        // Init Call
        // Init Call
        function updateWalletHeaderDate() {
            try {
                const el = document.getElementById('wallet-header-date');
                if (!el) return;
                const now = new Date();
                const days = ['DOMINGO', 'LUNES', 'MARTES', 'MIÉRCOLES', 'JUEVES', 'VIERNES', 'SÁBADO'];
                const months = ['ENE', 'FEB', 'MAR', 'ABR', 'MAY', 'JUN', 'JUL', 'AGO', 'SEP', 'OCT', 'NOV', 'DIC'];

                const dayName = days[now.getDay()];
                const day = String(now.getDate()).padStart(2, '0');
                const month = months[now.getMonth()];
                const year = now.getFullYear();

                el.innerText = `${dayName}, ${day} ${month} ${year}`;
            } catch (e) {
                console.error("Date Header Error", e);
            }
        }

        // Call immediately
        updateWalletHeaderDate();

        // --- WALLET HISTORY & FILTERING ---


        // Initialize Filter
        // document.addEventListener('DOMContentLoaded', () => filterWallet('all'));

        // Robust Initialization
        document.addEventListener('DOMContentLoaded', () => {
            // Force dark mode always
            document.documentElement.classList.add('dark');
            document.body.classList.add('dark');

            // Restore active tab
            const savedTab = localStorage.getItem('activeTab') || 'dashboard';
            switchTab(savedTab);

            // Update Date Header
            updateWalletHeaderDate();

            // Initialize Calendar V3
            if (typeof WalletCalendarV3 !== 'undefined') {
                WalletCalendarV3.init();
            }

            // Update Balance Display
            if (typeof updateBalanceDisplay === 'function') {
                updateBalanceDisplay();
            }

            // Update Monthly Totals
            if (typeof updateMonthlyTotals === 'function') {
                updateMonthlyTotals();
            }

            // Initialize filter to "Todo" (all)
            if (typeof filterWallet === 'function') {
                filterWallet('all');
            }

            // Populate Categories with Retry
            const initCategories = () => {
                const grid = document.getElementById('category-grid');
                if (grid && grid.children.length === 0) {
                    if (typeof populateWalletCategories === 'function') {
                        populateWalletCategories();
                    }
                }
            };

            // Try immediately
            initCategories();

            // Initialize Weekly Activity
            const initWeeklyActivity = () => {
                if (typeof WalletCalendarV3 !== 'undefined') {
                    // Only render the chart, skip calendar render
                    WalletCalendarV3.renderWeeklyActivity();
                }
            };

            // Try after a short delay to ensure calendar is initialized
            setTimeout(initWeeklyActivity, 200);
            setTimeout(initWeeklyActivity, 800);
            setTimeout(initWeeklyActivity, 2000);

            // Retry just in case (e.g. dynamic injection)
            setTimeout(initCategories, 500);
            setTimeout(initCategories, 1500);

            // Initialize default Budget Focus selection
            setTimeout(() => {
                if (typeof selectFocus === 'function') {
                    selectFocus('Wants'); // Set default to Wants as shown in HTML
                }
            }, 300);
        });

        // Fallback for direct script execution
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            updateWalletHeaderDate();
            if (typeof populateWalletCategories === 'function') populateWalletCategories();
        }



        // --- ANALYTICS 2 LOGIC (FUTURISTIC DASHBOARD) ---

        // Global instances to manage updates/destroys
        window.a2ChartsInfo = {};

        function renderAnalytics2() {
            if (!document.getElementById('view-analytics-2').classList.contains('active')) return;

            console.log('Rendering Analytics 2...');
            const transactions = appState.transactions || [];

            // --- DATA PREP ---
            // 1. Historical Income (Total)
            const incomeTrans = transactions.filter(t => t.type === 'income');
            const historicalIncome = incomeTrans.reduce((a, b) => a + b.amount, 0);

            // 2. Historical Expenses (Total)
            const expenseTrans = transactions.filter(t => t.type === 'expense');
            const historicalExpenses = expenseTrans.reduce((a, b) => a + b.amount, 0);

            // Helper for Safe Date
            const safeGetDateStr = (t) => {
                try {
                    if (t.dateIso) return t.dateIso.split('T')[0];
                    const d = new Date(t.id);
                    // Check if date is valid
                    if (isNaN(d.getTime())) return 'Unknown';
                    return d.toISOString().split('T')[0];
                } catch (e) {
                    return 'Unknown';
                }
            };

            // Group Income
            const incomeMap = {};
            incomeTrans.forEach(t => {
                const dStr = safeGetDateStr(t);
                if (dStr !== 'Unknown') incomeMap[dStr] = (incomeMap[dStr] || 0) + t.amount;
            });
            const sortedDates = Object.keys(incomeMap).sort();
            const incomeData = sortedDates.map(d => incomeMap[d]);

            // Group Expenses
            const expenseMap = {};
            expenseTrans.forEach(t => {
                const dStr = safeGetDateStr(t);
                if (dStr !== 'Unknown') expenseMap[dStr] = (expenseMap[dStr] || 0) + t.amount;
            });
            const sortedExpDates = Object.keys(expenseMap).sort();
            const expenseData = sortedExpDates.map(d => expenseMap[d]);

            // Fallback for empty data chart visuals
            if (incomeData.length === 0) {
                sortedDates.push('No Data');
                incomeData.push(0);
            }
            if (expenseData.length === 0) {
                sortedExpDates.push('No Data');
                expenseData.push(0);
            }

            // 3. Balance (Current)
            const dashBal = document.getElementById('val-balance');
            const balanceVal = dashBal ? parseFloat(dashBal.innerText.replace(/[$,]/g, '')) : 0;

            // Update Top Cards
            safeSetText('a2-balance-val', '$' + formatCurrency(historicalIncome).replace('$', ''));
            safeSetText('a2-expense-val', '$' + formatCurrency(historicalExpenses).replace('$', ''));
            safeSetText('a2-card-balance', '$' + formatCurrency(balanceVal).replace('$', ''));

            // --- CHARTS ---
            // Widget A: Historical Income
            renderA2Sparkline('a2-spark-balance', '#6366f1', incomeData, sortedDates, "Ingreso");

            // Widget B: Historical Expenses
            renderA2Sparkline('a2-spark-expense', '#f43f5e', expenseData, sortedExpDates, "Gasto");

            renderA2Donut(transactions);
            renderA2MonthlyBars(transactions);
            renderA2Gauges(transactions);

            // Recent List
            renderA2Recent(transactions);

            // Investments
            renderA2Investments();

            // Area Chart
            renderA2AreaChart(transactions);
        }

        function safeSetText(id, val) {
            const el = document.getElementById(id);
            if (el) el.innerText = val;
        }

        function generateSparkData(baseVal, count, isVaried = false) {
            let data = [];
            let current = baseVal * 0.8;
            for (let i = 0; i < count; i++) {
                data.push(current);
                current += (Math.random() - 0.4) * (baseVal * 0.1);
            }
            data.push(baseVal); // End at current
            return data;
        }

        function renderA2Sparkline(id, color, data, categories = [], seriesName = "Valor") {
            const options = {
                series: [{
                    data: data,
                    name: seriesName
                }],
                chart: {
                    type: 'area',
                    height: 50,
                    sparkline: {
                        enabled: true
                    },
                    background: 'transparent'
                },
                stroke: {
                    curve: 'smooth',
                    width: 2
                },
                fill: {
                    type: 'gradient',
                    gradient: {
                        shadeIntensity: 1,
                        opacityFrom: 0.7,
                        opacityTo: 0,
                        stops: [0, 100]
                    }
                },
                colors: [color],
                labels: categories,
                tooltip: {
                    fixed: {
                        enabled: false
                    },
                    x: {
                        show: true,
                        formatter: function (val) {
                            return val;
                        }
                    },
                    y: {
                        title: {
                            formatter: function (seriesName) {
                                return seriesName + ': '
                            }
                        },
                        formatter: function (val) {
                            if (typeof val === 'number') return '$' + val.toLocaleString();
                            return val;
                        }
                    },
                    marker: {
                        show: true
                    },
                    theme: 'dark'
                }
            };
            renderA2Chart(id, options);
        }

        function renderA2Donut(transactions) {
            // Top 5 Categories
            const catMap = {};
            transactions.filter(t => t.type === 'expense').forEach(t => catMap[t.category] = (catMap[t.category] || 0) + t.amount);
            const sorted = Object.entries(catMap).sort((a, b) => b[1] - a[1]).slice(0, 5);

            const options = {
                series: sorted.map(x => x[1]),
                labels: sorted.map(x => x[0]),
                chart: {
                    type: 'donut',
                    height: '100%',
                    background: 'transparent'
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: '70%',
                            labels: {
                                show: false
                            }
                        }
                    }
                },
                stroke: {
                    show: false
                },
                dataLabels: {
                    enabled: false
                },
                legend: {
                    show: false
                },
                colors: ['#6366f1', '#ec4899', '#10b981', '#f59e0b', '#ef4444'],
                tooltip: {
                    theme: 'dark'
                }
            };
            renderA2Chart('a2-chart-donut', options);
        }

        function renderA2MonthlyBars(transactions) {
            // Aggregate by month (last 6)
            // Simplified for demo: Just generate last 6 months buckets
            const months = ['Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const data = [1200, 1900, 1500, 2200, 1800, 2500]; // Mocking history for visual fidelity if real data is scarce
            // We could calculate this real-time if we had enough history, but safe to mock for purely visual "Analytics 2" demo requested.

            const options = {
                series: [{
                    name: 'Gastos',
                    data: data
                }],
                chart: {
                    type: 'bar',
                    height: '100%',
                    toolbar: {
                        show: false
                    },
                    background: 'transparent'
                },
                plotOptions: {
                    bar: {
                        borderRadius: 4,
                        columnWidth: '50%',
                        distributed: true
                    }
                },
                dataLabels: {
                    enabled: false
                },
                legend: {
                    show: false
                },
                xaxis: {
                    categories: months,
                    labels: {
                        style: {
                            colors: '#64748b'
                        }
                    },
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    }
                },
                yaxis: {
                    labels: {
                        style: {
                            colors: '#64748b'
                        }
                    }
                },
                grid: {
                    show: false
                },
                colors: ['#6366f1', '#8b5cf6', '#d946ef', '#f43f5e', '#f97316', '#eab308'],
                tooltip: {
                    theme: 'dark'
                }
            };
            renderA2Chart('a2-chart-bars', options);
        }

        function renderA2Gauges(transactions) {
            const container = document.getElementById('a2-gauges-container');
            if (!container) return;
            container.innerHTML = '';

            const categories = ['Needs', 'Wants', 'Saving', 'Investment', 'Waste'];
            const colors = ['#6366f1', '#ec4899', '#10b981', '#f97316', '#ef4444'];

            categories.forEach((cat, idx) => {
                // Create Wrapper
                const wrap = document.createElement('div');
                wrap.className = "flex flex-col items-center justify-center min-w-[120px]";
                const chartId = `a2-gauge-${cat}`;
                const chartDiv = document.createElement('div');
                chartDiv.id = chartId;
                chartDiv.className = "w-full h-32 flex justify-center";

                const label = document.createElement('div');
                label.className = "text-[10px] font-bold uppercase text-slate-500 mt-2 font-mono";
                label.innerText = cat;

                wrap.appendChild(chartDiv);
                wrap.appendChild(label);
                container.appendChild(wrap);

                // Logic: Calculate %
                // Limit
                let limit = 0;
                if (appState.budgetFocusGoals && appState.budgetFocusGoals[cat] > 0) {
                    limit = appState.budgetFocusGoals[cat];
                } else {
                    // Default Ratios
                    const ratios = {
                        'Needs': 0.5,
                        'Wants': 0.3,
                        'Saving': 0.2,
                        'Investment': 0.2,
                        'Waste': 0.05
                    };
                    const totalIncome = transactions.filter(t => t.type === 'income').reduce((a, b) => a + b.amount, 0);
                    limit = totalIncome * (ratios[cat] || 0.1);
                }

                // Spent
                const spent = transactions.filter(t =>
                    t.type === 'expense' &&
                    (t.budgetFocus === cat || (cat === 'Saving' && t.budgetFocus === 'Save') || (cat === 'Investment' && t.budgetFocus === 'Invest'))
                ).reduce((a, b) => a + b.amount, 0);

                let percent = 0;
                if (limit > 0) percent = Math.min(100, Math.round((spent / limit) * 100));
                else if (spent > 0) percent = 100;

                // Color Logic
                let finalColor = colors[idx]; // Default cat color
                if (percent > 90) finalColor = '#ef4444'; // Red
                else if (percent > 75) finalColor = '#f59e0b'; // Yellow
                else if (percent < 30) finalColor = '#3b82f6'; // Blue-ish for low usage

                // Chart
                const options = {
                    series: [percent],
                    chart: {
                        type: 'radialBar',
                        height: 140,
                        sparkline: {
                            enabled: true
                        },
                        background: 'transparent'
                    },
                    plotOptions: {
                        radialBar: {
                            hollow: {
                                size: '60%',
                                background: 'rgba(255,255,255,0.02)'
                            },
                            track: {
                                background: 'rgba(255,255,255,0.05)'
                            },
                            dataLabels: {
                                name: {
                                    show: false
                                },
                                value: {
                                    fontSize: '14px',
                                    fontWeight: 'bold',
                                    color: '#fff',
                                    offsetY: 5,
                                    formatter: function (val) {
                                        return val + '%'
                                    }
                                }
                            }
                        }
                    },
                    colors: [finalColor],
                    stroke: {
                        lineCap: 'round'
                    }
                };

                const chart = new ApexCharts(document.getElementById(chartId), options);
                chart.render();
            });
        }

        function renderA2Recent(transactions) {
            const el = document.getElementById('a2-recent-list');
            if (!el) return;

            const recent = transactions.slice().sort((a, b) => b.id - a.id).slice(0, 5);
            el.innerHTML = recent.map(t => `
        <div class="flex items-center justify-between p-3 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 transition">
            <div class="flex items-center gap-3 overflow-hidden">
                <div class="w-8 h-8 rounded-full flex-shrink-0 ${t.type === 'income' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-rose-500/20 text-rose-400'} flex items-center justify-center">
                    <i data-lucide="${t.type === 'income' ? 'arrow-down-left' : 'arrow-up-right'}" class="w-4 h-4"></i>
                </div>
                <div class="min-w-0">
                    <div class="text-white text-xs font-bold truncate">${t.name}</div>
                    <div class="text-slate-500 text-[9px] uppercase">${t.category}</div>
                </div>
            </div>
            <div class="text-white font-mono text-xs font-bold whitespace-nowrap ${t.type === 'income' ? 'text-emerald-400' : 'text-rose-400'}">
                ${t.type === 'expense' ? '-' : '+'} $${t.amount.toLocaleString()}
            </div>
        </div>
    `).join('');
            lucide.createIcons();
        }

        function renderA2Investments() {
            const el = document.getElementById('a2-invest-list');
            if (!el) return;

            const goals = appState.goals || [];
            // If no goals, show dummy
            let displayGoals = goals.length ? goals : [{
                name: 'Crypto Portfolio',
                target: 50000,
                current: 35000
            },
            {
                name: 'Tech Stocks',
                target: 20000,
                current: 8500
            },
            {
                name: 'Real Estate Fund',
                target: 100000,
                current: 12000
            }
            ];

            el.innerHTML = displayGoals.map(g => {
                const pct = Math.min(100, Math.round((g.current / g.target) * 100));
                return `
            <div>
                <div class="flex justify-between items-end mb-2">
                    <span class="text-slate-300 text-[10px] font-bold uppercase tracking-wider font-mono">${g.name}</span>
                    <span class="text-cyan-400 text-xs font-mono font-bold">${pct}%</span>
                </div>
                <div class="h-2 w-full bg-dark-900 rounded-full overflow-hidden border border-white/5">
                    <div class="h-full bg-cyan-400 shadow-[0_0_15px_rgba(34,211,238,0.6)] relative overflow-hidden" style="width: ${pct}%">
                         <div class="absolute inset-0 bg-white/20 w-full h-full animate-pulse opacity-20"></div>
                    </div>
                </div>
            </div>
        `;
            }).join('');
        }

        function renderA2AreaChart(transactions) {
            // Income vs Expenses (Mocked curve for aesthetic as requested "Large Area Spline")
            // We use simulated data series to guarantee the "visual impact" requested.

            const options = {
                series: [{
                    name: 'Income',
                    data: [3100, 4000, 2800, 5100, 4200, 5800, 6000]
                }, {
                    name: 'Expenses',
                    data: [1100, 3200, 4500, 3200, 3400, 5200, 4100]
                }],
                chart: {
                    height: '100%',
                    type: 'area',
                    toolbar: {
                        show: false
                    },
                    background: 'transparent'
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    curve: 'smooth',
                    width: 3
                },
                xaxis: {
                    categories: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    labels: {
                        style: {
                            colors: '#64748b'
                        }
                    },
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    }
                },
                yaxis: {
                    show: false
                },
                grid: {
                    borderColor: 'rgba(255,255,255,0.05)',
                    strokeDashArray: 4
                },
                colors: ['#3b82f6', '#ec4899'], // Blue and Pink
                fill: {
                    type: 'gradient',
                    gradient: {
                        shadeIntensity: 1,
                        opacityFrom: 0.4,
                        opacityTo: 0.05,
                        stops: [0, 90, 100]
                    }
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'right',
                    labels: {
                        colors: '#cbd5e1'
                    }
                },
                tooltip: {
                    theme: 'dark'
                }
            };
            renderA2Chart('a2-chart-area', options);
        }

        function renderA2Chart(id, options) {
            const el = document.getElementById(id);
            if (!el) return;
            el.innerHTML = ''; // Destroy old
            new ApexCharts(el, options).render();
        }

        // --- DASHBOARD 2.0 LOGIC (BENTO GRID - ADVANCED) ---
        function renderDashboard2() {
            if (!document.getElementById('view-dashboard-2').classList.contains('active')) return;
            console.log('Rendering Dashboard 2.0 (Bento)...');

            // Clean up old charts
            if (window.d2Charts) {
                window.d2Charts.forEach(c => {
                    try { c.destroy(); } catch (e) { }
                });
            }
            window.d2Charts = [];

            const transactions = appState.transactions || [];

            // DATA PREP (Filtered by Current Month)
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            const incomeTrans = transactions.filter(t => {
                const d = new Date(t.dateIso || t.id || t.date);
                return t.type === 'income' && d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });
            const expenseTrans = transactions.filter(t => {
                const d = new Date(t.dateIso || t.id || t.date);
                return t.type === 'expense' && d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });

            const totalIncome = incomeTrans.reduce((a, b) => a + Math.abs(parseFloat(b.amount) || 0), 0);
            const totalExpense = expenseTrans.reduce((a, b) => a + Math.abs(parseFloat(b.amount) || 0), 0);

            // --- 0. BUDGET MAPPING ---
            const budgetMap = appState.budget || {};
            let totalBudget = 0;
            // Sum explicit categories
            Object.keys(budgetMap).forEach(k => {
                if (k !== 'limit' && typeof budgetMap[k] === 'number') totalBudget += budgetMap[k];
            });
            // Fallback logic
            if (totalBudget === 0 && budgetMap.limit) totalBudget = budgetMap.limit;
            if (totalBudget === 0) totalBudget = totalIncome > 0 ? totalIncome * 0.9 : 5000; // Default fallback

            // Current Balance
            const balance = totalIncome - totalExpense;
            safeSetText('dash-balance', formatCurrency(balance));
            safeSetText('dash-income', formatCurrency(totalIncome));
            safeSetText('dash-expense', formatCurrency(totalExpense));

            // Fix: Update Balance Breakdown (Manual Accounts)
            if (typeof updateBalanceDisplay === 'function') updateBalanceDisplay();

            // --- 1. BURN-DOWN CHART ---
            renderD2Burndown(totalBudget, expenseTrans);

            // --- 2. FORECAST WIDGET ---
            renderD2Forecast(expenseTrans, totalBudget);



            // --- 4. RADIAL RISK ---
            renderD2RadialRisk(expenseTrans, budgetMap);

            // --- 5. NEEDS VS WANTS ---
            renderD2Mix(expenseTrans);

            // --- 6. CATEGORY PERF ---
            renderD2CatPerf(expenseTrans, budgetMap);

            // --- 7. TOP OFFENDERS ---
            renderD2Offenders(expenseTrans, budgetMap);

            // --- 8. HEATMAP ---
            renderD2Heatmap(expenseTrans);

            if (window.lucide) lucide.createIcons();
        }

        // --- DASHBOARD HELPERS ---
        function safeSetText(id, val) {
            const el = document.getElementById(id);
            if (el) el.innerText = val;
        }

        function renderD2Forecast(expenses = [], limit = 0) {
            console.log('Rendering AI Forecast...', { count: expenses ? expenses.length : 0, limit });

            function renderVelocityWidget(currentSpend, totalLimit) {
                console.log("Rendering Velocity Widget", { currentSpend, totalLimit });

                // 1. Basic Dates
                const now = new Date();
                const today = now.getDate();
                const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();

                // 2. Calculations
                // Prevent division by zero if it's day 1 morning
                const safeToday = Math.max(today, 1);

                const dailyAvg = currentSpend / safeToday;
                const projected = dailyAvg * daysInMonth;
                const pctUsed = totalLimit > 0 ? (currentSpend / totalLimit) * 100 : 0;
                const pctTime = (today / daysInMonth) * 100;

                const remainingConfig = totalLimit - currentSpend;
                const daysLeft = daysInMonth - today;
                const safeDaily = daysLeft > 0 ? (remainingConfig / daysLeft) : 0;

                // 3. Update DOM
                safeSetText('vel-projected-val', formatCurrency(projected));
                safeSetText('vel-pct-text', pctUsed.toFixed(1) + '%');
                safeSetText('vel-time-elapsed', pctTime.toFixed(0) + '%');
                safeSetText('vel-safe-daily', formatCurrency(safeDaily));

                // 4. Visuals (Bar & Status)
                const barEl = document.getElementById('vel-progress-bar');
                if (barEl) {
                    barEl.style.width = Math.min(pctUsed, 100) + '%';

                    // Color Logic
                    if (pctUsed > pctTime) {
                        // Burning too fast
                        barEl.className = 'h-full bg-gradient-to-r from-orange-500 to-rose-500 w-0 transition-all duration-1000 relative';
                        safeSetText('vel-status-text', 'HIGH VELOCITY');
                        const dot = document.getElementById('vel-status-dot');
                        if (dot) dot.className = 'w-2 h-2 rounded-full bg-rose-500 animate-pulse';
                    } else {
                        // Safe
                        barEl.className = 'h-full bg-gradient-to-r from-emerald-500 to-teal-500 w-0 transition-all duration-1000 relative';
                        safeSetText('vel-status-text', 'OPTIMAL PACE');
                        const dot = document.getElementById('vel-status-dot');
                        if (dot) dot.className = 'w-2 h-2 rounded-full bg-emerald-500 animate-pulse';
                    }
                }
            }

            // Avoid division by zero
            const dailyAvg = today > 0 ? totalSpent / today : 0;
            const safeDaily = daysLeft > 0 ? remainingBudget / daysLeft : 0;
            const projected = dailyAvg * daysInMonth;

            // Update Stats
            safeSetText('d2-daily-avg', formatCurrency(dailyAvg));
            safeSetText('d2-safe-daily', formatCurrency(safeDaily));
            safeSetText('d2-projected-total', formatCurrency(projected));

            // Bar Logic
            const barEl = document.getElementById('d2-forecast-bar');
            if (barEl) {
                let pct = limit > 0 ? (projected / limit) * 100 : 0;
                if (pct > 100) pct = 100;
                barEl.style.width = pct + '%';

                // Enhanced Gradient based on status
                if (projected > limit) {
                    barEl.className = 'h-full bg-gradient-to-r from-orange-500 to-rose-600 rounded-full shadow-[0_0_15px_rgba(244,63,94,0.5)] transition-all duration-1000';
                } else {
                    barEl.className = 'h-full bg-gradient-to-r from-emerald-400 to-teal-500 rounded-full shadow-[0_0_15px_rgba(52,211,153,0.5)] transition-all duration-1000';
                }
            }

            // AI Insight Logic
            const tipContainer = document.getElementById('d2-ai-tip-container');
            const tipText = document.getElementById('d2-ai-tip-text');

            if (tipContainer && tipText) {
                tipContainer.classList.remove('hidden');

                if (projected > limit) {
                    const over = projected - limit;
                    const daysToFix = dailyAvg > 0 ? (over / dailyAvg).toFixed(1) : daysLeft;
                    // Danger
                    tipText.innerHTML = `Caution: On track to exceed by <span class="text-rose-400 font-bold">${formatCurrency(over)}</span>. Try to reduce spend for <span class="text-white font-bold">${daysToFix} days</span>.`;
                    // Update icon color
                    const iconBox = tipContainer.querySelector('.w-8');
                    if (iconBox) iconBox.className = 'w-8 h-8 rounded-full bg-rose-500/20 flex items-center justify-center text-rose-400 border border-rose-500/30 relative z-10 shrink-0';

                } else {
                    const save = limit - projected;
                    // Success
                    tipText.innerHTML = `Excellent! On track to save <span class="text-emerald-400 font-bold">${formatCurrency(save)}</span>. Great job sticking to the plan.`;
                    // Update icon color
                    const iconBox = tipContainer.querySelector('.w-8');
                    if (iconBox) iconBox.className = 'w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400 border border-emerald-500/30 relative z-10 shrink-0';
                }
            }
        }

        function renderD2Waterfall(income, expenses) {
            // Top 4 Expense Categories for better detail
            const catMap = {};
            expenses.forEach(t => catMap[t.category] = (catMap[t.category] || 0) + t.amount);
            const sorted = Object.entries(catMap).sort((a, b) => b[1] - a[1]);
            const topN = sorted.slice(0, 4);
            const other = sorted.slice(4).reduce((a, b) => a + b[1], 0);
            const net = income - (topN.reduce((a, b) => a + b[1], 0) + other);

            // Construct Data with Types for Coloring
            const seriesData = [];

            // 1. Income (Positive)
            seriesData.push({ x: 'Income', y: income.toFixed(0), fillColor: '#10b981', strokeColor: '#34d399' });

            // 2. Expenses (Negative)
            topN.forEach(c => {
                seriesData.push({ x: c[0], y: -c[1].toFixed(0), fillColor: '#f43f5e', strokeColor: '#fb7185' });
            });

            // 3. Others (Negative)
            if (other > 0) {
                seriesData.push({ x: 'Others', y: -other.toFixed(0), fillColor: '#f97316', strokeColor: '#fb923c' });
            }

            // 4. Net Flow (Result)
            seriesData.push({ x: 'Net Flow', y: net.toFixed(0), isTotal: true, fillColor: '#6366f1', strokeColor: '#818cf8' });

            const options = {
                series: [{
                    name: 'Cash Flow',
                    data: seriesData
                }],
                chart: {
                    type: 'bar',
                    height: '100%',
                    background: 'transparent',
                    toolbar: { show: false },
                    fontFamily: 'Inter, sans-serif'
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: '60%',
                        borderRadius: 6,
                        borderRadiusApplication: 'end', // Rounds only the "end" of the bar
                        colors: {
                            ranges: [{
                                from: -100000000,
                                to: -1,
                                color: '#f43f5e'
                            }, {
                                from: 0,
                                to: 100000000,
                                color: '#10b981'
                            }]
                        }
                    }
                },
                colors: seriesData.map(d => d.fillColor), // Use mapped colors if distributed logic fails
                fill: {
                    type: 'gradient',
                    gradient: {
                        shade: 'dark',
                        type: 'vertical',
                        shadeIntensity: 0.5,
                        gradientToColors: seriesData.map(d => d.strokeColor), // Lighter top
                        inverseColors: true,
                        opacityFrom: 1,
                        opacityTo: 1,
                        stops: [0, 100]
                    }
                },
                dataLabels: {
                    enabled: false, // Cleaner look, rely on tooltip
                },
                xaxis: {
                    type: 'category',
                    crosshairs: { show: false },
                    labels: {
                        style: {
                            colors: '#94a3b8',
                            fontSize: '10px',
                            fontWeight: 600,
                        },
                        offsetY: -5
                    },
                    axisBorder: { show: false },
                    axisTicks: { show: false },
                    tooltip: { enabled: false } // No X tooltip
                },
                yaxis: {
                    show: true,
                    labels: {
                        formatter: (val) => { return Math.abs(val) > 999 ? (Math.abs(val) / 1000).toFixed(1) + 'k' : Math.abs(val) },
                        style: { colors: '#475569', fontSize: '10px' },
                        offsetX: -5
                    }
                },
                grid: {
                    borderColor: '#1e293b',
                    strokeDashArray: 4,
                    padding: { top: 0, right: 0, bottom: 0, left: 10 }
                },
                tooltip: {
                    theme: 'dark',
                    y: {
                        formatter: function (val) {
                            return '$' + parseInt(val).toLocaleString();
                        }
                    },
                    marker: { show: false }
                },
                states: {
                    hover: {
                        filter: { type: 'lighten', value: 0.05 }
                    }
                }
            };

            const chart = new ApexCharts(document.querySelector("#d2-waterfall-chart"), options);
            chart.render();
            window.d2Charts.push(chart);
        }

        function renderD2RadialRisk(expenses, budgetMap) {
            if (!document.querySelector("#d2-radial-chart")) return;

            // Find top spenders
            const catMap = {};
            expenses.forEach(t => catMap[t.category] = (catMap[t.category] || 0) + t.amount);

            // Filter only those with budgets? Or all?
            // User wants "Top 4 categories with highest current spend"
            const sorted = Object.entries(catMap).sort((a, b) => b[1] - a[1]).slice(0, 4);

            // Calculate % of their specific budget
            const series = [];
            const labels = [];

            sorted.forEach(item => {
                const cat = item[0];
                const amt = item[1];
                const limit = budgetMap[cat] || 0;
                let pct = 0;
                if (limit > 0) pct = Math.min(100, (amt / limit) * 100);
                else pct = 100; // No limit = risky? or 0? 100 for visual alert.

                series.push(parseFloat(pct.toFixed(1)));
                labels.push(cat);
            });

            if (series.length === 0) { series.push(0); labels.push('No Data'); }

            const options = {
                series: series,
                chart: { type: 'radialBar', height: 250, background: 'transparent' },
                plotOptions: {
                    radialBar: {
                        dataLabels: {
                            name: { fontSize: '12px', color: '#94a3b8' },
                            value: { fontSize: '18px', color: '#fff', fontWeight: 900 },
                            total: { show: true, label: 'Highest Risk', formatter: function (w) { return series[0] + '%' } }
                        },
                        hollow: { size: '40%' },
                        track: { background: '#1e293b' }
                    }
                },
                labels: labels,
                colors: ['#f43f5e', '#f97316', '#eab308', '#3b82f6'],
                fill: { type: 'gradient', gradient: { shade: 'dark', type: 'vertical', gradientToColors: ['#be123c'], stops: [0, 100] } },
                stroke: { lineCap: 'round' }
            };

            const chart = new ApexCharts(document.querySelector("#d2-radial-chart"), options);
            chart.render();
            window.d2Charts.push(chart);
        }

        function renderD2Mix(expenses) {
            if (!document.querySelector("#d2-mix-chart")) return;

            // Needs: Housing, Groceries, Transport, Health, Education, Gas
            // Wants: Food, Entertain, Shopping, Travel, Beer, Junk, Weed, Love, Others

            const needsKeys = ['Housing', 'Groceries', 'Transport', 'Health', 'Education', 'Gas'];
            let needsTotal = 0;
            let wantsTotal = 0;

            expenses.forEach(t => {
                if (needsKeys.includes(t.category)) needsTotal += t.amount;
                else wantsTotal += t.amount;
            });

            const options = {
                series: [needsTotal, wantsTotal],
                labels: ['Needs', 'Wants'],
                chart: { type: 'donut', height: 200, background: 'transparent' },
                colors: ['#3b82f6', '#ec4899'],
                plotOptions: { pie: { donut: { size: '65%' } } },
                dataLabels: { enabled: false },
                legend: { position: 'bottom', labels: { colors: '#fff' } },
                tooltip: { theme: 'dark', y: { formatter: (val) => formatCurrency(val) } },
                stroke: { show: true, colors: ['#0f1115'], width: 2 }
            };

            const chart = new ApexCharts(document.querySelector("#d2-mix-chart"), options);
            chart.render();
            window.d2Charts.push(chart);
        }

        function renderD2CatPerf(expenses, budgetMap) {
            const list = document.getElementById('d2-cat-perf-list');
            if (!list) return;
            list.innerHTML = '';

            // Aggregate Actuals
            const catMap = {};
            expenses.forEach(t => catMap[t.category] = (catMap[t.category] || 0) + t.amount);

            // Fixed 15 Categories
            // 'Housing', 'Transport', 'Food', 'Groceries', 'Entertainment', 'Shopping', 'Health', 'Education', 'Travel', 'Beer', 'Junk Food', 'Weed', 'Love', 'Gas', 'Others'
            const allCats = [
                'Housing', 'Transport', 'Food', 'Groceries', 'Entertainment',
                'Shopping', 'Health', 'Education', 'Travel', 'Beer',
                'Junk Food', 'Weed', 'Love', 'Gas', 'Others'
            ];

            allCats.forEach(cat => {
                const limit = budgetMap[cat] || 0;
                const actual = catMap[cat] || 0;

                // Show all categories regardless of 0 values, or perhaps hidden if specifically requested? 
                // User said "falta categorias... deberian ser 15", implies showing all.

                const pct = limit > 0 ? (actual / limit) * 100 : (actual > 0 ? 100 : 0);
                const barColor = actual > limit ? 'bg-red-500' : 'bg-blue-500';

                const item = document.createElement('div');
                item.className = 'flex items-center gap-4 py-2 border-b border-white/5 last:border-0';
                item.innerHTML = `
                    <div class="w-24 shrink-0">
                        <div class="text-white text-xs font-bold truncate">${cat}</div>
                        <div class="text-slate-600 text-[10px] uppercase font-mono tracking-wider">${formatCurrency(actual)}</div>
                    </div>
                    <div class="flex-1 relative h-2 bg-slate-800 rounded-full overflow-hidden">
                         <div class="absolute top-0 left-0 h-full ${barColor} rounded-full" style="width: ${Math.min(100, pct)}%"></div>
                    </div>
                    <div class="w-16 shrink-0 text-right">
                         <div class="text-[10px] text-slate-500 font-bold">LIMIT</div>
                         <div class="text-xs text-white font-mono">${formatCurrency(limit)}</div>
                    </div>
                 `;
                list.appendChild(item);
            });
        }

        function renderD2Offenders(expenses, budgetMap) {
            const list = document.getElementById('d2-offenders-list');
            if (!list) return;
            list.innerHTML = '';

            const catMap = {};
            expenses.forEach(t => catMap[t.category] = (catMap[t.category] || 0) + t.amount);

            const offenders = [];
            Object.keys(catMap).forEach(cat => {
                const limit = budgetMap[cat] || 0;
                if (limit > 0 && catMap[cat] > limit) {
                    offenders.push({ cat: cat, over: catMap[cat] - limit, pct: (catMap[cat] / limit) * 100 });
                }
            });

            offenders.sort((a, b) => b.over - a.over); // Sort by amount over

            if (offenders.length === 0) {
                list.innerHTML = `<div class="text-center text-slate-500 text-xs py-8 italic">No budget violations yet. Good job!</div>`;
                return;
            }

            offenders.forEach(o => {
                const item = document.createElement('div');
                item.className = 'bg-red-500/5 border border-red-500/20 rounded-xl p-3 flex justify-between items-center';
                item.innerHTML = `
                      <div>
                          <div class="text-red-400 font-bold text-xs">${o.cat}</div>
                          <div class="text-[10px] text-red-300/60 font-mono">Over by ${formatCurrency(o.over)}</div>
                      </div>
                      <div class="px-2 py-1 bg-red-500/20 rounded text-red-500 font-black text-xs">
                          ${o.pct.toFixed(0)}%
                      </div>
                  `;
                list.appendChild(item);
            });
        }

        function renderD2Heatmap(expenses) {
            if (!document.querySelector("#d2-heatmap-chart")) return;

            // Simplified: Day of Month Heatmap (Single Series) for 30 days of Week/Day
            const weeks = ['W1', 'W2', 'W3', 'W4', 'W5'];
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const heatmapData = []; // [{name: 'Mon', data: [{x: 'W1', y: 50}, ...]}, ...]

            const matrix = Array(7).fill(null).map(() => Array(5).fill(0));

            expenses.forEach(t => {
                const date = new Date(t.id);
                // Assume current month
                if (date.getMonth() === new Date().getMonth()) {
                    const dayOfMonth = date.getDate();
                    const dObj = new Date(date.getFullYear(), date.getMonth(), 1);
                    const startOffset = dObj.getDay(); // 0=Sun

                    const gridIndex = dayOfMonth + startOffset - 1;
                    const col = Math.floor(gridIndex / 7);
                    const row = gridIndex % 7;

                    if (col < 5) matrix[row][col] += t.amount;
                }
            });

            // Build Series
            days.forEach((dayName, rowIdx) => {
                const rowData = [];
                weeks.forEach((weekName, colIdx) => {
                    rowData.push({ x: weekName, y: matrix[rowIdx][colIdx] });
                });
                heatmapData.push({ name: dayName, data: rowData });
            });

            // Dynamic Theme Colors
            let c1 = '#818cf8'; // Soft Indigo
            let c2 = '#c084fc'; // Soft Purple
            if (typeof currentGradient !== 'undefined' && currentGradient.start) {
                c1 = currentGradient.start;
                c2 = currentGradient.end || currentGradient.start;
            }

            const options = {
                series: heatmapData.reverse(),
                chart: {
                    type: 'heatmap',
                    height: '100%',
                    background: 'transparent',
                    toolbar: { show: false },
                    fontFamily: 'Inter, sans-serif',
                    animations: { enabled: true }
                },
                dataLabels: { enabled: false },
                plotOptions: {
                    heatmap: {
                        shadeIntensity: 0.5,
                        radius: 8, // Premium rounded look
                        useFillColorAsStroke: false,
                        colorScale: {
                            ranges: [
                                { from: 0, to: 0.99, color: '#1e293b', name: 'Inactivo' },
                                { from: 1, to: 150, color: c1, name: 'Moderado' },
                                { from: 150.01, to: 100000000, color: c2, name: 'Alto' }
                            ]
                        }
                    }
                },
                stroke: {
                    width: 6, // Significant gap for "card" effect
                    colors: ['#161b22'] // Matching container BG
                },
                legend: { show: false },
                xaxis: {
                    labels: { style: { colors: '#64748b', fontSize: '10px', fontFamily: 'Inter' } },
                    axisBorder: { show: false },
                    axisTicks: { show: false },
                    tooltip: { enabled: false }
                },
                yaxis: {
                    labels: { style: { colors: '#64748b', fontSize: '10px', fontFamily: 'Inter' } }
                },
                grid: { show: false, padding: { top: 0, bottom: 0, left: 10, right: 10 } },
                tooltip: {
                    theme: 'dark',
                    y: { formatter: (val) => formatCurrency(val) }
                },
                states: {
                    hover: { filter: { type: 'brightness', value: 1.2 } }
                }
            };

            const el = document.querySelector("#d2-heatmap-chart");
            if (el) {
                const chart = new ApexCharts(el, options);
                chart.render();
                window.d2Charts.push(chart);
            }
        }

        // --- OLD DASHBOARD (Deprecated) ---
        function renderDashboard2_OLD() {
            if (!document.getElementById('view-dashboard-2').classList.contains('active')) return;
            console.log('Rendering Dashboard 2.0...');

            const transactions = appState.transactions || [];

            // 1. Calculate Totals (Wallet Data)
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);

            // Current Balance
            const balance = income - expense;

            safeSetText('d2-balance', formatCurrency(balance));
            safeSetText('d2-income', formatCurrency(income));
            safeSetText('d2-expenses', formatCurrency(expense));

            // 2. Budget Logic (Budget Data)
            // Use appState.budgetFocusGoals (Needs, Wants, etc.)
            let totalBudget = 0;
            if (appState.budgetFocusGoals) {
                totalBudget = Object.values(appState.budgetFocusGoals).reduce((a, b) => a + b, 0);
            }

            // Fallback Ratio
            if (totalBudget === 0 && income > 0) {
                totalBudget = income * 0.8;
            }

            const remaining = totalBudget - expense;

            safeSetText('d2-total-budget', formatCurrency(totalBudget));
            safeSetText('d2-budget-remaining', formatCurrency(remaining));

            const remainingLabel = document.getElementById('d2-budget-remaining');
            if (remainingLabel) {
                if (remaining < 0) remainingLabel.classList.replace('text-emerald-400', 'text-red-400');
                else remainingLabel.classList.replace('text-red-400', 'text-emerald-400');
            }

            // Render Budget Chart
            const budgetOptions = {
                series: [{
                    name: 'Actual Spending',
                    data: [expense]
                }, {
                    name: 'Budget Limit',
                    data: [totalBudget]
                }],
                chart: {
                    type: 'bar',
                    height: 250,
                    toolbar: { show: false },
                    background: 'transparent',
                    fontFamily: 'Inter, sans-serif'
                },
                colors: ['#ef4444', '#6366f1'],
                plotOptions: {
                    bar: {
                        horizontal: true,
                        barHeight: '50%',
                        borderRadius: 6,
                        dataLabels: { position: 'top' }
                    }
                },
                dataLabels: {
                    enabled: true,
                    formatter: function (val) { return formatCurrency(val); },
                    offsetX: 0,
                    style: { fontSize: '12px', colors: ['#fff'], fontFamily: 'Inter, sans-serif', fontWeight: 600 }
                },
                stroke: { show: true, width: 0, colors: ['#fff'] },
                xaxis: {
                    categories: ['Total'],
                    labels: { style: { colors: '#94a3b8' } },
                    axisBorder: { show: false },
                    axisTicks: { show: false }
                },
                yaxis: {
                    labels: { show: false }
                },
                tooltip: { theme: 'dark' },
                grid: { show: false }
            };

            const chartDiv = document.querySelector("#d2-budget-chart");
            if (chartDiv) {
                chartDiv.innerHTML = "";
                new ApexCharts(chartDiv, budgetOptions).render();
            }


            // 3. Render Recent Transactions
            const recent = [...transactions].sort((a, b) => b.id - a.id).slice(0, 5);
            const listContainer = document.getElementById('d2-recent-list');
            if (listContainer) {
                listContainer.innerHTML = '';
                recent.forEach(t => {
                    const isInc = t.type === 'income';
                    const color = isInc ? 'text-emerald-400' : 'text-red-400';
                    const sign = isInc ? '+' : '-';
                    const icon = isInc ? 'arrow-up-right' : 'arrow-down-left';
                    const bg = isInc ? 'bg-emerald-500/10' : 'bg-red-500/10';
                    const lucideIcon = isInc ? 'trending-up' : 'trending-down';

                    const item = document.createElement('div');
                    item.className = 'flex items-center justify-between p-3 rounded-xl bg-[#161b22] border border-white/5 hover:bg-white/5 transition group';
                    item.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg ${bg} flex items-center justify-center text-${isInc ? 'emerald' : 'red'}-500">
                                <i data-lucide="${lucideIcon}" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <div class="text-white font-bold text-sm">${t.name || t.category}</div>
                                <div class="text-slate-500 text-[10px] uppercase font-mono tracking-wider">${t.category}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="${color} font-black text-sm">${sign}${formatCurrency(t.amount)}</div>
                            <div class="text-slate-600 text-[10px]">${new Date(t.id).toLocaleDateString()}</div>
                        </div>
                    `;
                    listContainer.appendChild(item);
                });
            }

            if (window.lucide) lucide.createIcons();
        }

    </script>
    <script src="chart_component.js"></script>
    <script>
        // --- SIDEBAR UPDATE FUNCTION ---
        function updateSidebarGoalCount(count) {
            const el = document.getElementById('sidebar-goal-count');
            if (el) {
                // Animate change
                el.style.transform = "scale(1.5)";
                el.style.color = "#4ade80"; // green-400
                setTimeout(() => {
                    el.innerText = count;
                    el.style.transform = "scale(1)";
                    el.style.color = ""; // reset
                }, 200);
            }
        }

        // --- DASHBOARD DATA & HISTORY MANAGER ---
        // --- DASHBOARD DATA & HISTORY MANAGER ---
        // --- DASHBOARD DATA & HISTORY MANAGER ---
        // --- DASHBOARD DATA & HISTORY MANAGER ---
        function ensureHistoricalData() {
            // DISABLED: Auto-injection of history causes persistent "zombie" data on reset.
            // Function retained empty to prevent ReferenceErrors if called elsewhere.
            if (!appState.transactions) appState.transactions = [];
            return;
        }

        function calculateDashboardMetrics() {
            const txs = appState.transactions || [];

            // Rolling 12 Months Logic (Aligns with Chart Components)
            // Index 0 = 11 Months Ago (Oldest)
            // Index 11 = Current Month (Newest)
            const incomeByMonth = new Array(12).fill(0);
            const expenseByMonth = new Array(12).fill(0);
            const netWorthByMonth = [];

            const labels = [];
            const labelsShort = [];

            const now = new Date();
            let currentNetWorth = (appState.profile && appState.profile.balance) ? parseFloat(appState.profile.balance) : 0;

            // 1. Calculate Historical Net Worth Baseline (if possible) or just project
            // For simplicity in this fix, we calculate Income/Expense properly first

            for (let i = 11; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const queryMonth = d.getMonth();
                const queryYear = d.getFullYear();

                // Labels
                const mName = d.toLocaleString('default', { month: 'short' });
                const mNameFull = d.toLocaleString('default', { month: 'long' });
                labels.push(mNameFull);
                labelsShort.push(mName.charAt(0).toUpperCase());

                // Filter Transactions for this month
                let mInc = 0;
                let mExp = 0;

                txs.forEach(t => {
                    // Robust Date Parsing
                    const tDate = new Date(t.dateIso || t.id || t.date);
                    if (!isNaN(tDate.getTime())) {
                        if (tDate.getMonth() === queryMonth && tDate.getFullYear() === queryYear) {
                            const amt = Math.abs(parseFloat(t.amount) || 0);
                            if (t.type === 'income') mInc += amt;
                            if (t.type === 'expense') mExp += amt;
                        }
                    }
                });

                const arrayIndex = 11 - i;
                incomeByMonth[arrayIndex] = mInc;
                expenseByMonth[arrayIndex] = mExp;

                // Net Worth accumulation (Simple approximation for chart shape)
                currentNetWorth += (mInc - mExp);
                netWorthByMonth.push(currentNetWorth);
            }

            // 2. Dissection (Current Month Categories)
            const curMonth = now.getMonth();
            const curYear = now.getFullYear();
            const catMap = {};

            txs.filter(t => {
                const d = new Date(t.dateIso || t.id || t.date);
                return t.type === 'expense' && d.getMonth() === curMonth && d.getFullYear() === curYear;
            }).forEach(t => {
                catMap[t.category] = (catMap[t.category] || 0) + t.amount;
            });
            const catLabels = Object.keys(catMap);
            const catValues = Object.values(catMap);

            // 3. AI Forecast Logic (Last 6 months actuals + forecast)
            const history = expenseByMonth.slice(6, 12); // Last 6 months
            const forecast = [];

            // Forecast logic
            const avgBurn = history.reduce((a, b) => a + b, 0) / (history.length || 1);
            let futureVal = avgBurn || 0;
            const growthRate = 1.02;

            // Pad history part of forecast array
            history.forEach(_ => forecast.push(null));

            for (let k = 0; k < 5; k++) {
                futureVal = (futureVal === 0 ? 2000 : futureVal) * growthRate; // Fallback if 0
                forecast.push(parseFloat(futureVal.toFixed(0)));
            }
            // Forecast Labels (Current + 5)
            const forecastLabels = [];
            for (let i = 0; i < 6; i++) {
                // Already generated labels for history? No, need future labels
                // Start from current month index
                const fD = new Date(now.getFullYear(), now.getMonth() + i, 1);
                forecastLabels.push(fD.toLocaleString('default', { month: 'short' }));
            }

            return {
                months: labels,
                monthsShort: labelsShort,
                income: incomeByMonth,
                expenses: expenseByMonth,
                netWorth: netWorthByMonth,
                catLabels: catLabels,
                catData: catValues,
                history: history,
                forecast: forecast,
                forecastLabels: forecastLabels,
                // PASS PREFS
                chartPrefs: (window.appState && window.appState.chartPreferences) ? window.appState.chartPreferences : {}
            };
        }

        // Merge logic inside renderMergedDashboard


        // --- MERGED DASHBOARD RENDERER ---
        function renderMergedDashboard() {
            // 0. Ensure Data Exists
            // if (typeof ensureHistoricalData === 'function') ensureHistoricalData(); // DISABLED

            console.log("Rendering Merged Dashboard...");

            // 1. Calculate Metrics from Wallet/Budget Data
            const dashboardData = calculateDashboardMetrics();

            // 2. Render Core Dashboard (Passing Data)
            if (typeof renderMegaDashboard === 'function') {
                renderMegaDashboard(dashboardData);
            }

            // --- FIX: Direct DOM Update for Dashboard Cards (Source of Truth) ---
            const allTxs = appState.transactions || [];
            const now = new Date();
            const curMonth = now.getMonth();
            const curYear = now.getFullYear();

            let mInc = 0;
            let mExp = 0;
            let totalBal = 0;

            allTxs.forEach(t => {
                // Robust Date Parsing for Filter
                let raw = t.dateIso || t.id;
                if (typeof raw === 'string' && raw.length === 10) raw += 'T12:00:00'; // Force middle of day for YYYY-MM-DD
                const d = new Date(raw);
                const am = parseFloat(t.amount) || 0;

                // Balance (All Time)
                if (t.type === 'income') totalBal += am;
                else totalBal -= am;

                // Monthly
                if (d.getMonth() === curMonth && d.getFullYear() === curYear) {
                    if (t.type === 'income') mInc += am;
                    else mExp += am;
                }
            });

            const elBal = document.getElementById('w-net-balance');
            const elInc = document.getElementById('monthly-income');
            const elExp = document.getElementById('monthly-expenses');

            // Formatting helper
            const fmt = (n) => n.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 2 });

            if (elBal) elBal.innerText = fmt(totalBal);
            if (elInc) elInc.innerText = fmt(mInc);
            if (elExp) elExp.innerText = fmt(mExp);

            // Update Month Labels (Localised)
            const monthName = now.toLocaleDateString('es-ES', { month: 'long' });
            const capMonth = monthName.charAt(0).toUpperCase() + monthName.slice(1);

            const elIncLbl = document.getElementById('monthly-income-label');
            const elExpLbl = document.getElementById('monthly-expenses-label');
            if (elIncLbl) elIncLbl.innerText = capMonth;
            if (elExpLbl) elExpLbl.innerText = capMonth;

            // --- FIX: Data Management Layout (Dynamic) ---
            // Finds the container with "Simulation" buttons and adjusts layout to be side-by-side (auto width)
            setTimeout(() => {
                const buttons = Array.from(document.querySelectorAll('button'));
                const targetBtn = buttons.find(b => b.innerText.includes('Simulación') || b.innerText.includes('Simulation'));
                if (targetBtn) {
                    const container = targetBtn.parentElement;
                    if (container) {
                        // Apply Flex Layout for Side-by-Side but Natural Width
                        container.className = "flex items-center gap-3 mt-4";

                        // Style Children - Remove full width forcing
                        Array.from(container.children).forEach(btn => {
                            btn.classList.remove('w-full', 'mb-3', 'h-full', 'flex-1');
                            btn.classList.add('px-6'); // Ensure decent clickable area
                        });
                    }
                }
            }, 500);


            // 3. Prep Data for Analytics Widgets
            // 3. Prep Data for Analytics Widgets
            const expensesCurrent = allTxs.filter(t => t.type === 'expense' && new Date(t.dateIso || t.id).getMonth() === curMonth);

            // --- DATA SOURCE: BUDGET LIMIT ---
            const totalLimit = (typeof getGlobalBudgetLimit === 'function') ? getGlobalBudgetLimit() : 0;
            const budgetMap = appState.budget || {};

            // 4. Render D2 Widgets
            const allExpenses = allTxs.filter(t => t.type === 'expense');
            const bdRange = (window.appState && window.appState.chartPreferences) ? window.appState.chartPreferences.burndown : '1M';
            if (typeof renderD2Burndown === 'function') renderD2Burndown(totalLimit, allExpenses, bdRange);
            // CALL NEW WIDGET: Passing simple primitives (Total Monthly Spend, Total Limit)
            if (typeof renderVelocityWidget === 'function') renderVelocityWidget(mExp, totalLimit);
            if (typeof renderProjectionChart === 'function') renderProjectionChart(dashboardData);
            if (typeof renderD2CatPerf === 'function') renderD2CatPerf(expensesCurrent, budgetMap);
            if (typeof renderD2Offenders === 'function') renderD2Offenders(expensesCurrent, budgetMap);
            if (typeof renderD2Heatmap === 'function') renderD2Heatmap(expensesCurrent);

            if (typeof updateFocusStats === 'function') updateFocusStats();

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        // --- ANALYTICS OVERVIEW LOGIC (BENTO GRID - ADVANCED) ---
        function renderAnalyticsOverview() {
            console.log('Rendering Analytics Overview (Bento)...');

            // Clean up old charts
            if (window.d2Charts) {
                window.d2Charts.forEach(c => {
                    try { c.destroy(); } catch (e) { }
                });
            }
            window.d2Charts = [];

            const transactions = appState.transactions || [];

            // DATA PREP
            const incomeTrans = transactions.filter(t => t.type === 'income');
            const expenseTrans = transactions.filter(t => t.type === 'expense');
            const totalIncome = incomeTrans.reduce((a, b) => a + b.amount, 0);
            const totalExpense = expenseTrans.reduce((a, b) => a + b.amount, 0);

            // --- 0. BUDGET MAPPING ---
            const totalBudget = getGlobalBudgetLimit();
            const budgetMap = appState.budget || {};

            // --- 1. BURN-DOWN CHART ---
            renderD2Burndown(totalBudget, expenseTrans);

            // --- 2. FORECAST WIDGET ---
            renderD2Forecast(expenseTrans, totalBudget);

            // --- 6. CATEGORY PERF ---
            renderD2CatPerf(expenseTrans, budgetMap);

            // --- 7. TOP OFFENDERS ---
            renderD2Offenders(expenseTrans, budgetMap);

            // --- 8. HEATMAP ---
            renderD2Heatmap(expenseTrans);

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function renderD2Burndown(limit, expenses, range = '1M') {
            const today = new Date();
            let idealData = [];
            let actualData = [];
            let xLabels = [];
            let currentDayIndex = 0;

            if (range === '2W') {
                // LAST 14 DAYS (Rolling)
                const days = 14;
                // Calculate starts
                const startDate = new Date();
                startDate.setDate(today.getDate() - (days - 1)); // Includes today

                // Pro-rate Limit (e.g. 5000 / 30 * 14)
                // Use 30.44 days for average month or just 30
                const averageDaysInMonth = 30;
                const periodLimit = (limit / averageDaysInMonth) * days;

                let cum = 0;

                for (let i = 0; i < days; i++) {
                    const d = new Date(startDate);
                    d.setDate(startDate.getDate() + i);

                    const dayStr = d.toLocaleDateString('es-MX', { day: 'numeric', month: 'short' });
                    xLabels.push(dayStr);

                    // Ideal (Linear from 0 to periodLimit)
                    idealData.push(parseFloat(((periodLimit / days) * (i + 1)).toFixed(2)));

                    // Actual (Cumulative in this period)
                    const dailyExp = expenses.reduce((sum, t) => {
                        let td = t.dateIso ? new Date(t.dateIso) : new Date(t.date || t.id);
                        if (typeof t.dateIso === 'string' && t.dateIso.length === 10) td.setHours(12);
                        if (td.getDate() === d.getDate() && td.getMonth() === d.getMonth() && td.getFullYear() === d.getFullYear()) {
                            return sum + Math.abs(parseFloat(t.amount) || 0);
                        }
                        return sum;
                    }, 0);

                    if (d <= today) {
                        cum += dailyExp;
                        actualData.push(parseFloat(cum.toFixed(2)));
                    } else {
                        actualData.push(null);
                    }
                }
                currentDayIndex = days - 1;

            } else {
                // MONTHLY (Default)
                const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                const currentDay = today.getDate();
                currentDayIndex = currentDay - 1;
                xLabels = Array.from({ length: daysInMonth }, (_, i) => i + 1);

                // Ideal
                for (let i = 1; i <= daysInMonth; i++) {
                    idealData.push(parseFloat(((limit / daysInMonth) * i).toFixed(2)));
                }

                // Actual
                let cum = 0;
                const expenseByDay = new Array(daysInMonth + 1).fill(0);
                expenses.forEach(t => {
                    let raw = t.dateIso || t.id || t.date;
                    if (typeof raw === 'string' && raw.length === 10) raw += 'T12:00:00';
                    const d = new Date(raw);
                    if (d.getMonth() === today.getMonth() && d.getFullYear() === today.getFullYear()) {
                        expenseByDay[d.getDate()] += Math.abs(parseFloat(t.amount) || 0);
                    }
                });

                for (let i = 1; i <= daysInMonth; i++) {
                    if (i > currentDay) {
                        actualData.push(null);
                    } else {
                        cum += expenseByDay[i];
                        actualData.push(parseFloat(cum.toFixed(2)));
                    }
                }
            }

            // Sync Badges
            const badgeText = document.getElementById('d2-burndown-badge-text');
            const aoBadgeText = document.getElementById('ao-burndown-badge-text');

            const currentActual = actualData.filter(x => x !== null).pop() || 0;
            // Safe access to ideal
            const currentIdeal = idealData[Math.min(currentDayIndex, idealData.length - 1)] || 0;
            const isOver = currentActual > currentIdeal;
            const statusText = isOver ? 'OVER PACE' : 'ON TRACK';

            const labelStart = range === '2W' ? '14 DAYS' : today.toLocaleString('default', { month: 'long' }).toUpperCase();
            const textToSet = labelStart + ' ' + statusText;

            if (badgeText) {
                badgeText.innerText = textToSet;
                badgeText.className = `text-[9px] font-bold uppercase tracking-[0.2em] ${isOver ? 'text-rose-400' : 'text-emerald-400'}`;
            }
            if (aoBadgeText) {
                aoBadgeText.innerText = textToSet;
                aoBadgeText.className = `text-[9px] font-black uppercase tracking-wider ${isOver ? 'text-rose-400' : 'text-emerald-300'}`;
            }

            // Global Hook for Buttons
            window.updateD2BurndownRange = (newRange) => {
                if (window.appState && window.appState.chartPreferences) {
                    window.appState.chartPreferences.burndown = newRange;
                }
                const limit = getGlobalBudgetLimit();
                // Only expenses
                const txs = (appState.transactions || []).filter(t => t.type === 'expense');
                renderD2Burndown(limit, txs, newRange);

                // Update Buttons Visuals
                document.querySelectorAll('.burndown-range-btn').forEach(btn => {
                    if (btn.dataset.range === newRange) {
                        btn.className = 'burndown-range-btn px-2 py-0.5 rounded text-[9px] font-bold transition flex items-center justify-center bg-indigo-500 text-white border border-indigo-500 shadow-sm';
                    } else {
                        btn.className = 'burndown-range-btn px-2 py-0.5 rounded text-[9px] font-bold transition flex items-center justify-center bg-transparent text-slate-400 border border-transparent hover:bg-white/5 hover:text-white';
                    }
                });
            };

            // Options Factory
            const getOptions = (chartId) => ({
                series: [
                    { name: 'Ideal Burn', type: 'line', data: idealData },
                    { name: 'Actual Spend', type: 'area', data: actualData }
                ],
                chart: {
                    id: chartId,
                    type: 'line',
                    height: '100%',
                    background: 'transparent',
                    toolbar: { show: false },
                    fontFamily: 'Inter, sans-serif',
                    dropShadow: { enabled: true, top: 4, left: 0, blur: 8, color: '#F43F5E', opacity: 0.15 },
                    animations: { enabled: true, easing: 'easeinout', speed: 800 }
                },
                colors: ['#475569', '#F43F5E'],
                stroke: { width: [2, 3], dashArray: [5, 0], curve: ['straight', 'smooth'], lineCap: 'round' },
                fill: { type: ['solid', 'gradient'], gradient: { shadeIntensity: 1, type: 'vertical', opacityFrom: 0.4, opacityTo: 0.05, stops: [0, 100] } },
                legend: { show: false },
                xaxis: {
                    categories: xLabels,
                    labels: {
                        style: { colors: '#64748B', fontSize: '9px', fontFamily: 'Inter, sans-serif', fontWeight: 600 },
                        offsetY: -3
                    },
                    axisBorder: { show: false }, axisTicks: { show: false }, tooltip: { enabled: false }
                },
                yaxis: { show: false },
                grid: { show: true, borderColor: '#FFFFFF', strokeDashArray: 2, padding: { bottom: 10, left: 10, right: 10 }, opacity: 0.08, xaxis: { lines: { show: false } } },
                tooltip: {
                    theme: 'dark',
                    cssClass: 'burndown-tooltip',
                    style: { fontSize: '12px' },
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        if (series[1][dataPointIndex] === null && seriesIndex === 1) return '';

                        const day = w.globals.labels[dataPointIndex];
                        const ideal = series[0][dataPointIndex];
                        const actual = series[1][dataPointIndex] || 0;
                        const isOver = actual > ideal;
                        const diff = Math.abs(actual - ideal);

                        return `
                            <div class="px-4 py-3 bg-[#0B0D14]/95 backdrop-blur-2xl border border-violet-500/20 rounded-2xl shadow-[0_20px_40px_-10px_rgba(0,0,0,0.8)] min-w-[180px]">
                                <div class="flex justify-between items-center mb-3">
                                    <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest">${range === '2W' ? 'ROLLING' : 'MONTHLY'}</span>
                                    <div class="px-2 py-0.5 rounded-full bg-white/5 border border-white/5">
                                        <span class="text-[10px] font-bold text-white">${day}</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="flex items-center gap-2 mb-1">
                                         <div class="w-1.5 h-1.5 rounded-full bg-rose-500 shadow-[0_0_8px_#f43f5e] animate-pulse"></div>
                                         <span class="text-[9px] font-bold text-rose-200 uppercase tracking-wider">Spent So Far</span>
                                    </div>
                                    <div class="text-xl font-black text-white tracking-tight drop-shadow-md">
                                        ${formatCurrency(actual)}
                                    </div>
                                </div>
                                <div class="pt-2 border-t border-white/10 flex items-center justify-between">
                                    <div class="flex flex-col">
                                        <span class="text-[8px] font-bold text-slate-500 uppercase">Vs Ideal</span>
                                        <span class="text-[10px] font-mono font-bold ${isOver ? 'text-rose-400' : 'text-emerald-400'}">
                                            ${isOver ? '+' : '-'}${formatCurrency(diff)}
                                        </span>
                                    </div>
                                    <div class="text-right">
                                         <span class="text-[8px] font-bold text-slate-500 uppercase">Status</span>
                                         <div class="text-[9px] font-bold ${isOver ? 'text-rose-400' : 'text-emerald-400'} uppercase tracking-wider">
                                            ${isOver ? 'OVER' : 'UNDER'}
                                         </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                },
                markers: { size: [0, 4], colors: ['#fff'], strokeColors: '#F43F5E', strokeWidth: 2, hover: { size: 6 } }
            });

            // 1. Burndown Global
            const d2El = document.getElementById('d2-burndown-chart');
            if (d2El && d2El.offsetParent !== null) {
                renderInto(d2El, 'burndown-chart-inst');
            }

            // 2. Analytics Overview
            const aoEl = document.getElementById('ao-burndown-chart');
            if (aoEl && aoEl.offsetParent !== null) {
                renderInto(aoEl, 'ao-burndown-chart-inst');
            }

            // 3. Budget Tab
            const btEl = document.getElementById('budget-tab-burndown-chart');
            if (btEl && btEl.offsetParent !== null) {
                renderInto(btEl, 'bt-burndown-chart-inst');
            }

            function renderInto(el, instId) {
                el.innerHTML = '';
                const chart = new ApexCharts(el, getOptions(instId));
                chart.render();
                if (!window.d2Charts) window.d2Charts = [];
                window.d2Charts.push(chart);
            }
        }

        function toggleChartSeries(chartId, seriesName, btn) {
            try {
                // Find chart by ID internally if possible, or use ApexCharts global execution
                ApexCharts.exec(chartId, 'toggleSeries', seriesName);
                if (btn) btn.classList.toggle('opacity-50');
            } catch (e) { console.error("Toggle failed", e); }
        }

        function renderProjectionChart(dashboardData) {
            const el = document.getElementById('aiForecastChart');
            if (!el) return;
            el.innerHTML = '';

            const months = ['Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Apr', 'May'];

            // Refined Data for Smoother Curve
            let hist = [2500, 3800, 2900, 3500, 2200, 2600, null, null, null, null, null];
            // Start projection EXACTLY where history ends (2600)
            let proj = [null, null, null, null, null, 2600, 2850, 3100, 3000, 3250, 3400];

            if (dashboardData && dashboardData.history && dashboardData.history.length > 0) {
                // If real data exists, use it (logic placeholders)
            }

            const options = {
                series: [
                    { name: 'Histórico', data: hist },
                    { name: 'Proyección IA', data: proj }
                ],
                chart: {
                    type: 'area', // Area for impact
                    height: '100%',
                    background: 'transparent',
                    toolbar: { show: false },
                    fontFamily: 'Inter, sans-serif',
                    dropShadow: {
                        enabled: true,
                        top: 0,
                        left: 0,
                        blur: 10,
                        color: '#A855F7',
                        opacity: 0.3
                    }
                },
                colors: ['#64748B', '#A855F7'],
                fill: {
                    type: ['gradient', 'gradient'], // Gradients for BOTH
                    gradient: {
                        shadeIntensity: 1,
                        type: "vertical",
                        opacityFrom: [0.3, 0.6], // Lower opacity for history
                        opacityTo: [0.05, 0.1],
                        stops: [0, 90, 100]
                    }
                },
                dataLabels: { enabled: false },
                stroke: {
                    curve: 'smooth',
                    width: [2, 4], // Thinner for history, Thicker for AI
                    dashArray: [0, 5], // Solid vs Dashed
                    lineCap: 'round'
                },
                xaxis: {
                    categories: months,
                    labels: {
                        style: { colors: '#64748B', fontSize: '10px', fontWeight: 600 },
                        offsetY: -5
                    },
                    axisBorder: { show: false },
                    axisTicks: { show: false },
                    tooltip: { enabled: false }
                },
                yaxis: { show: false },
                grid: {
                    show: true,
                    borderColor: '#FFFFFF',
                    strokeDashArray: 3,
                    opacity: 0.05,
                    padding: { left: 10, right: 10, bottom: 20 }
                },
                annotations: {
                    points: [{
                        x: 'Dec',
                        y: 2600,
                        marker: {
                            size: 6,
                            fillColor: '#fff',
                            strokeColor: '#A855F7',
                            strokeWidth: 4,
                            radius: 2,
                            cssClass: "apexcharts-custom-marker"
                        },
                        label: {
                            borderColor: '#A855F7',
                            style: {
                                color: '#fff',
                                background: '#A855F7',
                                fontSize: '10px',
                                padding: { left: 6, right: 6, top: 2, bottom: 2 }
                            },
                            text: 'Now',
                            offsetY: -30
                        }
                    }]
                },
                tooltip: {
                    theme: 'dark',
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const month = w.globals.labels[dataPointIndex];
                        const val = series[seriesIndex][dataPointIndex];
                        const isProj = seriesIndex === 1;

                        // Calculate pseudo-trend for demo (randomized for visual effect if no real prev data)
                        const trend = isProj ? '+12.5%' : '+4.2%';
                        const isUp = true;

                        return `
                            <div class="group relative overflow-hidden rounded-2xl bg-[#0B0D14]/95 p-4 shadow-[0_20px_50px_-10px_rgba(0,0,0,1)] backdrop-blur-2xl border border-white/10 min-w-[200px]">
                                <!--decorative ambient glow-->
                                <div class="absolute -top-10 -right-10 w-24 h-24 ${isProj ? 'bg-purple-500/20' : 'bg-slate-500/20'} rounded-full blur-2xl pointer-events-none transition-colors duration-500"></div>
                                
                                <!--Header -->
                                <div class="flex justify-between items-start mb-4 relative z-10">
                                    <div>
                                        <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-0.5">TIMELINE</p>
                                        <h4 class="text-sm font-black text-white uppercase tracking-wider font-inter">${month} ${isProj ? '2026' : '2025'}</h4>
                                    </div>
                                    <div class="px-2 py-1 rounded-lg ${isProj ? 'bg-purple-500/10 border-purple-500/20 text-purple-300' : 'bg-slate-500/10 border-slate-500/20 text-slate-300'} border text-[8px] font-black uppercase tracking-widest shadow-sm">
                                        ${isProj ? 'AI FORECAST' : 'HISTORY'}
                                    </div>
                                </div>

                                <!--Main Value-->
                                <div class="mb-4 relative z-10">
                                    <div class="flex items-center gap-2 mb-1">
                                         <div class="w-1.5 h-1.5 rounded-full ${isProj ? 'bg-purple-500 shadow-[0_0_8px_#a855f7] animate-pulse' : 'bg-slate-500'}"></div>
                                         <span class="text-[9px] text-slate-300 font-bold uppercase tracking-wider">Net Amount</span>
                                    </div>
                                    <div class="flex items-baseline gap-1">
                                        <span class="text-2xl font-black text-white tracking-tighter drop-shadow-xl font-sans">${formatCurrency(val)}</span>
                                    </div>
                                </div>

                                <!--Footer / Context-->
                            <div class="flex items-center justify-between pt-3 border-t border-white/5 relative z-10">
                                <div class="flex items-center gap-1.5">
                                    <div class="w-4 h-4 rounded-full bg-emerald-500/10 flex items-center justify-center text-emerald-400 border border-emerald-500/20">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                                    </div>
                                    <span class="text-[10px] font-bold text-emerald-400">${trend}</span>
                                </div>
                                <span class="text-[9px] text-slate-600 font-medium uppercase tracking-wider">vs Last Month</span>
                            </div>
                            </div>
                `;
                    }
                },
                legend: { show: false },
                markers: { size: 0, hover: { size: 5 } }
            };

            const chart = new ApexCharts(el, options);
            chart.render();
            if (!window.d2Charts) window.d2Charts = [];
            window.d2Charts.push(chart);
        }

        function renderD2Forecast(expenses, limit) {
            const today = new Date().getDate();
            const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
            const daysLeft = daysInMonth - today;

            const currentMonthExpenses = expenses.filter(t => {
                // Robust Date Parsing for Filter
                let raw = t.dateIso || t.id;
                if (typeof raw === 'string' && raw.length === 10) raw += 'T12:00:00'; // Force middle of day for YYYY-MM-DD
                const d = new Date(raw);
                return d.getMonth() === new Date().getMonth() && d.getFullYear() === new Date().getFullYear();
            });

            const totalSpent = currentMonthExpenses.reduce((a, b) => a + b.amount, 0);
            const remainingBudget = Math.max(0, limit - totalSpent);
            const dailyAvg = today > 0 ? totalSpent / today : 0;
            const safeDaily = daysLeft > 0 ? remainingBudget / daysLeft : 0;
            const projected = dailyAvg * daysInMonth;

            // Helper to set text safely for multiple IDs (d2- and ao-)
            const setText = (suffix, text) => {
                ['d2-', 'ao-'].forEach(prefix => {
                    const el = document.getElementById(prefix + suffix);
                    if (el) el.innerText = text;
                });
            };

            // UI Updates
            setText('days-left-badge', `${daysLeft} days left`);
            setText('daily-avg', formatCurrency(dailyAvg));
            setText('safe-daily', formatCurrency(safeDaily));
            setText('projected-total', formatCurrency(projected));

            // Bar Logic
            ['d2-forecast-bar', 'ao-forecast-bar'].forEach(id => {
                const barEl = document.getElementById(id);
                if (barEl) {
                    let pct = limit > 0 ? (projected / limit) * 100 : 0;
                    if (pct > 100) pct = 100;
                    barEl.style.width = pct + '%';

                    if (projected > limit) {
                        barEl.className = 'h-full bg-gradient-to-r from-orange-500 to-rose-600 w-0 transition-all duration-1000 relative shadow-[0_0_15px_rgba(244,63,94,0.5)]';
                    } else {
                        barEl.className = 'h-full bg-gradient-to-r from-emerald-400 to-teal-500 w-0 transition-all duration-1000 relative shadow-[0_0_15px_rgba(52,211,153,0.5)]';
                    }
                }
            });

            ['d2', 'ao'].forEach(prefix => {
                const msgEl = document.getElementById(`${prefix} -forecast - msg`);
                const msgScan = document.getElementById(`${prefix} -forecast - msg - scan`);
                const iconEl = document.getElementById(`${prefix} -msg - icon`);
                const iconBg = document.getElementById(`${prefix} -msg - icon - bg`);
                const tipContainer = document.getElementById(`${prefix} -ai - tip - container`);
                const tipText = document.getElementById(`${prefix} -ai - tip - text`);

                if (!msgEl) return;

                if (projected > limit) {
                    const over = projected - limit;
                    msgEl.innerText = `Danger: Projected to exceed limit by ${formatCurrency(over)} `;
                    msgEl.className = 'text-[10px] font-bold text-rose-300 leading-snug';

                    if (msgScan) msgScan.className = 'mt-auto px-4 py-3 rounded-2xl bg-rose-500/10 border border-rose-500/20 flex items-center gap-3 relative z-10 backdrop-blur-md';
                    if (iconBg) iconBg.className = 'w-6 h-6 rounded-full bg-rose-500/20 flex items-center justify-center shrink-0';
                    if (iconEl) iconEl.className = 'w-3 h-3 text-rose-400';

                    if (tipContainer && tipText) {
                        tipContainer.classList.remove('hidden');
                        const daysToSkip = dailyAvg > 0 ? (over / dailyAvg).toFixed(1) : 0;
                        tipText.innerHTML = `To get back on track, try to < span class="text-rose-300 font-bold" > spend $0</span > for the next < span class= "text-white font-bold" > ${daysToSkip} days</span >.`;
                    }

                } else {
                    const save = limit - projected;
                    msgEl.innerText = `Excellent: On track to save ${formatCurrency(save)} `;
                    msgEl.className = 'text-[10px] font-bold text-emerald-300 leading-snug';

                    if (msgScan) msgScan.className = 'mt-auto px-4 py-3 rounded-2xl bg-emerald-500/10 border border-emerald-500/20 flex items-center gap-3 relative z-10 backdrop-blur-md';
                    if (iconBg) iconBg.className = 'w-6 h-6 rounded-full bg-emerald-500/20 flex items-center justify-center shrink-0';
                    if (iconEl) iconEl.className = 'w-3 h-3 text-emerald-400';

                    if (tipContainer && tipText) {
                        tipContainer.classList.remove('hidden');
                        tipText.innerHTML = `You have < span class="text-emerald-300 font-bold" > ${formatCurrency(remainingBudget - (daysLeft * dailyAvg))}</span > extra buffer.Consider moving this to savings!`;
                    }
                }
            });
        }

        // 3. Category Performance (Updated to show ALL active categories)
        function renderD2CatPerf(expensesCurrent, budgetMap) {
            ['d2-cat-perf-list', 'ao-cat-perf-list'].forEach(id => {
                const list = document.getElementById(id);
                if (!list) return;
                list.innerHTML = '';

                // 1. Get expenses by category for current month (Wallet Data)
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                const expensesByCategory = {};

                appState.transactions.filter(t => {
                    // Robust Date Parsing for Filter
                    let raw = t.dateIso || t.id;
                    if (typeof raw === 'string' && raw.length === 10) raw += 'T12:00:00'; // Force middle of day for YYYY-MM-DD
                    const d = new Date(raw);
                    return t.type === 'expense' && d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).forEach(t => {
                    // Normalize category name to title case to avoid dupes
                    const cat = t.category;
                    if (!expensesByCategory[cat]) expensesByCategory[cat] = 0;
                    expensesByCategory[cat] += t.amount;
                });

                // 2. Merge with Budget Categories (ensure we show categories with budget but no spend too)
                const allCategoriesSet = new Set([
                    ...Object.keys(expensesByCategory),
                    ...Object.keys(budgetMap).filter(k => budgetMap[k] > 0)
                ]);
                const allCats = Array.from(allCategoriesSet).sort();

                if (allCats.length === 0) {
                    list.innerHTML = '<div class="text-center text-slate-500 text-xs py-8">No expenses yet this month.</div>';
                    return;
                }

                allCats.forEach(cat => {
                    const limit = budgetMap[cat] || 0;
                    const actual = expensesByCategory[cat] || 0;

                    // Logic: If limit exists, calc %. If no limit, treat as 100% filled visual or special state.
                    let percent = 0;
                    let barColor = 'bg-blue-500';
                    let statusText = '';
                    let statusColor = 'text-slate-400';

                    if (limit > 0) {
                        percent = (actual / limit) * 100;
                        if (actual > limit) {
                            barColor = 'bg-red-500';
                            statusText = `+ $${(actual - limit).toFixed(0)} OVER`;
                            statusColor = 'text-red-400';
                        } else {
                            statusText = `${percent.toFixed(0)}% `;
                            statusColor = 'text-blue-400';
                        }
                    } else {
                        // Scan logic: No budget set but has spending
                        percent = 100; // Visual fill
                        barColor = 'bg-slate-600'; // Neutral color indicating "Unbudgeted"
                        statusText = 'NO LIMIT';
                        statusColor = 'text-slate-500';
                    }

                    const item = document.createElement('div');
                    item.className = 'flex items-center gap-4 py-2 border-b border-white/5 last:border-0';
                    item.innerHTML = `
                < div class="w-24 shrink-0" >
                            <div class="text-white text-xs font-bold truncate" title="${cat}">${cat}</div>
                            <div class="text-slate-600 text-[10px] uppercase font-mono tracking-wider">${formatCurrency(actual)}</div>
                        </div >
                        <div class="flex-1 relative h-2 bg-slate-800 rounded-full overflow-hidden">
                             <div class="absolute top-0 left-0 h-full ${barColor} rounded-full" style="width: ${Math.min(100, percent)}%"></div>
                        </div>
                        <div class="w-16 shrink-0 text-right">
                             <div class="text-[10px] text-slate-500 font-bold">LIMIT</div>
                             <div class="text-xs text-white font-mono">${limit > 0 ? formatCurrency(limit) : '-'}</div>
                        </div>
            `;
                    list.appendChild(item);
                });
            });
        }

        // 4. Top Offenders / Highest Risks (Updated to show high consumption even if not over limit)
        function renderD2Offenders(expensesCurrent, budgetMap) {
            ['d2-offenders-list', 'ao-offenders-list'].forEach(id => {
                const list = document.getElementById(id);
                if (!list) return;
                list.innerHTML = '';

                // Get expenses
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                const expensesByCategory = {};

                appState.transactions.filter(t => {
                    // Robust Date Parsing for Filter
                    let raw = t.dateIso || t.id;
                    if (typeof raw === 'string' && raw.length === 10) raw += 'T12:00:00'; // Force middle of day for YYYY-MM-DD
                    const d = new Date(raw);
                    return t.type === 'expense' && d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).forEach(t => {
                    const cat = t.category;
                    if (!expensesByCategory[cat]) expensesByCategory[cat] = 0;
                    expensesByCategory[cat] += t.amount;
                });

                const risks = [];
                // Calculate consumption % for all categories with expenses OR budget
                const allCats = new Set([...Object.keys(expensesByCategory), ...Object.keys(budgetMap).filter(k => budgetMap[k] > 0)]);

                allCats.forEach(cat => {
                    const limit = budgetMap[cat] || 0;
                    const actual = expensesByCategory[cat] || 0;

                    if (actual > 0) { // Only show if there is activity
                        let pct = 0;
                        let overage = 0;

                        if (limit > 0) {
                            pct = (actual / limit) * 100;
                            overage = actual - limit;
                        } else {
                            pct = 100; // Treated as high risk if no limit
                        }

                        risks.push({
                            category: cat,
                            limit: limit,
                            actual: actual,
                            overage: overage,
                            pct: pct,
                            isOver: actual > limit && limit > 0
                        });
                    }
                });

                // Sort by Percentage descending
                risks.sort((a, b) => b.pct - a.pct);

                // Take top 5
                const topRisks = risks.slice(0, 5);

                if (topRisks.length === 0) {
                    list.innerHTML = `< div class="text-center text-slate-500 text-xs py-8 italic" > No spending activity to analyze yet.</div > `;
                } else {
                    list.innerHTML = topRisks.map((item, idx) => {
                        // Styles based on severity
                        const isOver = item.isOver;
                        const isHigh = item.pct > 80;

                        let badgeColor = isOver ? 'bg-red-500/20 text-red-500' : (isHigh ? 'bg-amber-500/20 text-amber-500' : 'bg-blue-500/20 text-blue-500');
                        let borderColor = isOver ? 'border-red-500/20' : 'border-white/5';
                        let textColor = isOver ? 'text-red-400' : 'text-white';
                        let subTextColor = isOver ? 'text-red-400/60' : 'text-slate-500';

                        let msg = '';
                        if (isOver) msg = `+ $${formatCurrency(item.overage)} over limit`;
                        else if (item.limit > 0) msg = `${formatCurrency(item.limit - item.actual)} remaining`;
                        else msg = 'No limit set';

                        return `
                < div class="flex items-center justify-between p-3 rounded-xl bg-slate-800/20 border ${borderColor} mb-2" >
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full ${badgeColor} flex items-center justify-center">
                                    <span class="font-black text-sm">${idx + 1}</span>
                                </div>
                                <div>
                                    <p class="text-sm font-bold ${textColor}">${item.category}</p>
                                    <p class="text-[10px] ${subTextColor}">${msg}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-xs font-mono text-slate-300">${formatCurrency(item.actual)}</p>
                                <p class="text-[9px] text-slate-500">${item.limit > 0 ? item.pct.toFixed(0) + '%' : 'Uncapped'}</p>
                            </div>
                        </div >
                `}).join('');
                }
            });
        }

        function renderD2Heatmap(expenses) {
            const weeks = ['W1', 'W2', 'W3', 'W4', 'W5'];
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const heatmapData = [];

            const matrix = Array(7).fill(null).map(() => Array(5).fill(0));

            expenses.forEach(t => {
                const date = new Date(t.dateIso || t.id);
                if (date.getMonth() === new Date().getMonth() && date.getFullYear() === new Date().getFullYear()) {
                    const dayOfMonth = date.getDate();
                    const dObj = new Date(date.getFullYear(), date.getMonth(), 1);
                    const startOffset = dObj.getDay();

                    const gridIndex = dayOfMonth + startOffset - 1;
                    const col = Math.floor(gridIndex / 7);
                    const row = gridIndex % 7;

                    if (col < 5) matrix[row][col] += t.amount;
                }
            });

            days.forEach((dayName, rowIdx) => {
                const rowData = [];
                weeks.forEach((weekName, colIdx) => {
                    rowData.push({ x: weekName, y: matrix[rowIdx][colIdx] });
                });
                heatmapData.push({ name: dayName, data: rowData });
            });

            const options = {
                series: heatmapData.reverse(),
                chart: {
                    type: 'heatmap',
                    height: '100%',
                    background: 'transparent',
                    toolbar: { show: false },
                    fontFamily: 'Inter, sans-serif'
                },
                dataLabels: { enabled: false },
                plotOptions: {
                    heatmap: {
                        shadeIntensity: 0.5,
                        radius: 6,
                        useFillColorAsStroke: false,
                        colorScale: {
                            ranges: [
                                { from: 0, to: 0.99, color: '#1e293b', name: 'No Spend' },
                                { from: 1, to: 100, color: '#06b6d4', name: 'Low' },
                                { from: 100.01, to: 500, color: '#3b82f6', name: 'Medium' },
                                { from: 500.01, to: 100000000, color: '#8b5cf6', name: 'High' }
                            ]
                        }
                    }
                },
                stroke: { width: 1, colors: ['#0f1115'] },
                legend: { show: false },
                xaxis: {
                    labels: { style: { colors: '#64748b', fontSize: '10px', fontFamily: 'Inter' } },
                    axisBorder: { show: false },
                    axisTicks: { show: false },
                    tooltip: { enabled: false }
                },
                yaxis: {
                    labels: { style: { colors: '#64748b', fontSize: '10px', fontFamily: 'Inter' } }
                },
                grid: { show: false, padding: { top: 0, bottom: 0, left: 10, right: 10 } },
                tooltip: {
                    theme: 'dark',
                    y: { formatter: (val) => formatCurrency(val) }
                }
            };

            ['d2-heatmap-chart', 'ao-heatmap-chart'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.innerHTML = '';
                    const chart = new ApexCharts(el, options);
                    chart.render();
                    if (!window.d2Charts) window.d2Charts = [];
                    window.d2Charts.push(chart);
                }
            });
        }

        // --- CUSTOM MONTH PICKER LOGIC ---
        let pickerYear = new Date().getFullYear();
        let isPickerOpen = false;

        function toggleMonthPicker() {
            const dropdown = document.getElementById('custom-month-picker');
            if (!dropdown) return;

            isPickerOpen = !isPickerOpen;
            if (isPickerOpen) {
                dropdown.classList.remove('hidden');
                initMonthPicker();
            } else {
                dropdown.classList.add('hidden');
            }
        }

        function changePickerYear(delta) {
            pickerYear += delta;
            document.getElementById('picker-year-display').innerText = pickerYear;
            initMonthPicker(); // Re-render grid to update active states if needed
        }

        function getMonthName(value) {
            if (!value) return 'Mes';
            const [y, m] = value.split('-');
            const date = new Date(parseInt(y), parseInt(m) - 1, 1);
            const str = date.toLocaleString('es-ES', { month: 'long', year: 'numeric' });
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function selectPickerMonth(monthIndex) {
            // monthIndex is 0-11
            const monthStr = String(monthIndex + 1).padStart(2, '0');
            const value = `${pickerYear} -${monthStr} `;

            // Set global target
            walletTargetMonth = value;
            walletTimeFilter = 'month'; // Ensure we are in month mode

            // Close picker
            toggleMonthPicker();

            // Render
            renderWalletHistory();
        }

        function initMonthPicker() {
            const grid = document.getElementById('picker-months-grid');
            const yearDisplay = document.getElementById('picker-year-display');
            if (!grid || !yearDisplay) return;

            yearDisplay.innerText = pickerYear;
            grid.innerHTML = '';

            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];

            // Calculate active month to highlight
            let activeMonthIndex = -1;
            if (walletTargetMonth) {
                const [y, m] = walletTargetMonth.split('-');
                if (parseInt(y) === pickerYear) {
                    activeMonthIndex = parseInt(m) - 1;
                }
            } else if (pickerYear === new Date().getFullYear() && walletTimeFilter === 'month') {
                // Default to current date if 'month' is selected but no specific target
                activeMonthIndex = new Date().getMonth();
            }

            months.forEach((m, idx) => {
                const btn = document.createElement('button');

                // Style logic
                const isActive = idx === activeMonthIndex;
                const isCurrentMonth = (pickerYear === new Date().getFullYear() && idx === new Date().getMonth());

                let cls = "h-10 rounded-xl text-xs font-bold transition-all duration-200 border flex flex-col items-center justify-center relative overflow-hidden group ";

                if (isActive) {
                    cls += "bg-indigo-600 text-white border-indigo-500 shadow-lg shadow-indigo-500/40 scale-105 z-10";
                } else if (isCurrentMonth) {
                    cls += "bg-white/5 text-indigo-400 border-indigo-500/30 hover:bg-indigo-500/10 hover:border-indigo-500/50";
                } else {
                    cls += "bg-transparent text-slate-500 border-transparent hover:bg-white/5 hover:text-slate-300";
                }

                btn.className = cls;
                btn.onclick = () => selectPickerMonth(idx);

                btn.innerHTML = `
                <span class="z-10">${m}</span>
                    ${isActive ? '<div class="absolute inset-0 bg-gradient-to-tr from-white/10 to-transparent"></div>' : ''}
                `;

                grid.appendChild(btn);
            });

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function selectCurrentMonth() {
            pickerYear = new Date().getFullYear();
            selectPickerMonth(new Date().getMonth());
        }

        // Close picker when clicking outside
        document.addEventListener('click', (e) => {
            const container = document.getElementById('custom-month-picker');
            const btn = document.getElementById('btn-type-month');
            if (isPickerOpen && container && btn && !container.contains(e.target) && !btn.contains(e.target)) {
                toggleMonthPicker();
            }
        });



        // --- CRITICAL REPAIR & SAFETY NET ---
        // Ensure essential functions exist to prevent crashes
        if (typeof switchTab !== 'function') {
            window.switchTab = function (tabId) {
                console.log('Safety switchTab called for:', tabId);
                document.querySelectorAll('.tab-content').forEach(el => {
                    el.style.display = 'none';
                    el.classList.remove('active');
                });
                const target = document.getElementById('view-' + tabId);
                if (target) {
                    target.style.display = 'block';
                    target.classList.add('active');
                }
                localStorage.setItem('activeTab', tabId);
            };
        }

        if (typeof updateWalletHeaderDate !== 'function') {
            window.updateWalletHeaderDate = function () {
                const el = document.getElementById('wallet-header-date');
                if (el) {
                    const now = new Date();
                    el.innerText = now.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                }
            };
        }

        if (typeof populateWalletCategories !== 'function') {
            window.populateWalletCategories = function () {
                console.log('Safety populateWalletCategories called');
                // Basic stub or logic if needed, usually just UI population
            };
        }

        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Creating icons and initializing...');

            // 0. Ensure Data Generation Happens Immediately
            // 0. Ensure Data Generation Happens Immediately - DISABLED to prevent zombie data after Reset
            // if (typeof ensureHistoricalData === 'function') {
            //     ensureHistoricalData();
            // }

            // Sync Icon with Theme
            if (localStorage.getItem('theme') === 'light') {
                const icon = document.getElementById('themeIcon');
                if (icon) icon.setAttribute('data-lucide', 'sun');
            }

            if (typeof lucide !== 'undefined') lucide.createIcons();

            // Restore active tab
            const lastTab = localStorage.getItem('activeTab') || 'dashboard';
            if (typeof switchTab === 'function') {
                console.log('Switching to saved tab:', lastTab);
                switchTab(lastTab);
            }

            // Specific Wallet Init if needed (restoring deleted logic)
            setTimeout(() => {
                if (typeof updateWalletHeaderDate === 'function') updateWalletHeaderDate();
                if (typeof populateWalletCategories === 'function') populateWalletCategories();
                if (lastTab === 'dashboard' && typeof renderMergedDashboard === 'function') {
                    renderMergedDashboard();
                }
                // Default to TODAY view as requested
                if (typeof filterWallet === 'function') filterWallet('today');
            }, 500);
        });
    </script>
    <!-- TRANSACTION MODAL (Re-injected & Enhanced) -->
    <div id="transaction-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-md z-[200] hidden flex items-center justify-center opacity-0 transition-all duration-300">
        <div class="bg-[#0f1115] border border-white/10 p-6 rounded-3xl w-full max-w-md transform scale-95 transition-all duration-300 shadow-2xl relative"
            id="txn-modal-content">
            <button onclick="closeTransactionModal()"
                class="absolute right-4 top-4 text-slate-400 hover:text-white transition">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>

            <h3 class="text-xl font-bold text-white mb-6 text-center">Editar Movimiento</h3>

            <input type="hidden" id="txn-modal-id">

            <!-- Type Toggles -->
            <div class="flex gap-2 mb-6 p-1 bg-[#161b22] rounded-xl border border-white/5">
                <button type="button" id="btn-modal-expense" onclick="setModalType('expense')"
                    class="flex-1 py-2 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2 text-rose-400 bg-rose-500/10 border border-rose-500/20">
                    <i data-lucide="arrow-down-right" class="w-4 h-4"></i> Gasto
                </button>
                <button type="button" id="btn-modal-income" onclick="setModalType('income')"
                    class="flex-1 py-2 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2 text-slate-400 hover:text-white">
                    <i data-lucide="arrow-up-right" class="w-4 h-4"></i> Ingreso
                </button>
            </div>
            <input type="hidden" id="txn-modal-type" value="expense">

            <div class="space-y-4">
                <!-- Amount -->
                <div>
                    <label
                        class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1">Monto</label>
                    <div class="relative group">
                        <span class="absolute left-4 top-3 text-slate-400 font-bold">$</span>
                        <input type="number" id="txn-modal-amount" placeholder="0.00" step="0.01"
                            class="w-full bg-[#161b22] border border-gray-800 focus:border-indigo-500 rounded-xl py-3 pl-8 pr-4 text-white font-mono text-lg font-bold outline-none transition">
                    </div>
                </div>

                <!-- Date -->
                <div>
                    <label
                        class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1">Fecha</label>
                    <div class="relative">
                        <input type="date" id="txn-modal-date"
                            class="w-full bg-[#161b22] border border-gray-800 focus:border-indigo-500 rounded-xl py-2 px-4 text-white text-sm outline-none transition [color-scheme:dark]">
                        <i data-lucide="calendar"
                            class="absolute right-3 top-2.5 w-4 h-4 text-slate-500 pointer-events-none"></i>
                    </div>
                </div>

                <!-- Name -->
                <div>
                    <label
                        class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1">Descripción</label>
                    <input type="text" id="txn-modal-name" placeholder="Ej: Supermercado"
                        class="w-full bg-[#161b22] border border-gray-800 focus:border-indigo-500 rounded-xl py-2 px-4 text-white text-sm outline-none transition">
                </div>

                <!-- Category -->
                <div>
                    <label
                        class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1">Categoría</label>
                    <div class="relative group/select">
                        <select id="txn-modal-category"
                            class="w-full bg-[#161b22] border border-gray-800 focus:border-indigo-500 rounded-xl py-2 px-4 text-white text-sm appearance-none outline-none transition cursor-pointer">
                            <!-- Populated by JS -->
                        </select>
                        <i data-lucide="chevron-down"
                            class="absolute right-3 top-2.5 w-4 h-4 text-slate-500 pointer-events-none group-hover/select:text-white transition"></i>
                    </div>
                </div>

                <!-- Budget Focus (Pills) -->
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">Enfoque de
                        Presupuesto</label>
                    <div class="flex flex-wrap gap-2" id="modal-focus-pills">
                        <button type="button" onclick="setModalFocus('Needs')"
                            class="focus-pill px-3 py-1 rounded-full text-[10px] font-bold border border-white/5 bg-white/5 text-slate-400 hover:bg-indigo-500/20 hover:text-indigo-300 transition"
                            data-val="Needs">NEEDS</button>
                        <button type="button" onclick="setModalFocus('Wants')"
                            class="focus-pill px-3 py-1 rounded-full text-[10px] font-bold border border-white/5 bg-white/5 text-slate-400 hover:bg-pink-500/20 hover:text-pink-300 transition"
                            data-val="Wants">WANTS</button>
                        <button type="button" onclick="setModalFocus('Saving')"
                            class="focus-pill px-3 py-1 rounded-full text-[10px] font-bold border border-white/5 bg-white/5 text-slate-400 hover:bg-emerald-500/20 hover:text-emerald-300 transition"
                            data-val="Saving">SAVING</button>
                        <button type="button" onclick="setModalFocus('Invest')"
                            class="focus-pill px-3 py-1 rounded-full text-[10px] font-bold border border-white/5 bg-white/5 text-slate-400 hover:bg-violet-500/20 hover:text-violet-300 transition"
                            data-val="Invest">INVEST</button>
                        <button type="button" onclick="setModalFocus('Waste')"
                            class="focus-pill px-3 py-1 rounded-full text-[10px] font-bold border border-white/5 bg-white/5 text-slate-400 hover:bg-red-500/20 hover:text-red-300 transition"
                            data-val="Waste">WASTE</button>
                    </div>
                    <input type="hidden" id="txn-modal-focus" value="Needs">
                </div>
            </div>

            <!-- Footer Buttons -->
            <div class="flex items-center gap-3 mt-8">
                <button onclick="closeTransactionModal()"
                    class="flex-1 py-3 rounded-xl bg-slate-800/50 hover:bg-slate-700 text-slate-300 font-bold text-sm transition text-center">Cancelar</button>
                <button onclick="saveTransactionFromModal()"
                    class="flex-1 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-bold text-sm shadow-lg shadow-indigo-500/20 transition transform hover:scale-[1.02] text-center">GUARDAR
                    TRANSACCION</button>

                <!-- Delete in Modal -->
                <button onclick="deleteFromModal()"
                    class="p-3 rounded-xl bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white transition border border-red-500/20">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- MODAL JS LOGIC (Re-injected) ---

        function setModalType(type) {
            document.getElementById('txn-modal-type').value = type;
            const btnExp = document.getElementById('btn-modal-expense');
            const btnInc = document.getElementById('btn-modal-income');

            if (type === 'expense') {
                btnExp.className = "flex-1 py-2 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2 text-rose-400 bg-rose-500/10 border border-rose-500/20 shadow-lg shadow-rose-900/20";
                btnInc.className = "flex-1 py-2 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2 text-slate-400 hover:text-white opacity-50 hover:opacity-100";
            } else {
                btnInc.className = "flex-1 py-2 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2 text-emerald-400 bg-emerald-500/10 border border-emerald-500/20 shadow-lg shadow-emerald-900/20";
                btnExp.className = "flex-1 py-2 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2 text-slate-400 hover:text-white opacity-50 hover:opacity-100";
            }
        }

        function setModalFocus(focusVal) {
            document.getElementById('txn-modal-focus').value = focusVal;
            document.querySelectorAll('.focus-pill').forEach(btn => {
                const val = btn.getAttribute('data-val');
                if (val === focusVal) {
                    let color = 'indigo';
                    if (val === 'Wants') color = 'pink';
                    if (val === 'Saving') color = 'emerald';
                    if (val === 'Invest') color = 'violet';
                    if (val === 'Waste') color = 'red';

                    btn.className = `focus - pill px - 4 py - 1.5 rounded - full text - [10px] font - bold border border - ${color} -500 / 50 bg - ${color} -500 / 20 text - ${color} -300 shadow - [0_0_10px_rgba(0, 0, 0, 0.3)] transition scale - 105`;
                } else {
                    btn.className = "focus-pill px-3 py-1 rounded-full text-[10px] font-bold border border-white/5 bg-white/5 text-slate-500 hover:bg-white/10 transition grayscale opacity-70 hover:opacity-100";
                }
            });
        }

        function openTransactionModal(mode, id = null) {
            const modal = document.getElementById('transaction-modal');
            const content = document.getElementById('txn-modal-content');
            if (!modal) return;

            populateCategorySelect();

            const idInput = document.getElementById('txn-modal-id');
            const amtInput = document.getElementById('txn-modal-amount');
            const nameInput = document.getElementById('txn-modal-name');
            const catInput = document.getElementById('txn-modal-category');
            const dateInput = document.getElementById('txn-modal-date');

            // Set defaults
            setModalType('expense');
            setModalFocus('Needs');

            if (mode === 'edit' && id) {
                const txn = appState.transactions.find(t => t.id == id);
                if (!txn) return;

                idInput.value = txn.id;
                amtInput.value = txn.amount;
                nameInput.value = txn.name || '';
                catInput.value = txn.category || 'Food';
                setModalType(txn.type || 'expense');
                setModalFocus(txn.budgetFocus || 'Needs');

                let dateStr = '';
                if (txn.dateIso && txn.dateIso.includes('-')) dateStr = txn.dateIso.split('T')[0];
                else {
                    const d = new Date(txn.dateIso || txn.id);
                    if (!isNaN(d)) dateStr = d.toISOString().split('T')[0];
                }
                dateInput.value = dateStr;

            } else {
                // Add Mode
                idInput.value = '';
                amtInput.value = '';
                nameInput.value = '';
                catInput.value = 'Food';
                dateInput.value = new Date().toISOString().split('T')[0];
            }

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function closeTransactionModal() {
            const modal = document.getElementById('transaction-modal');
            const content = document.getElementById('txn-modal-content');
            if (!modal) return;
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function saveTransactionFromModal() {
            const id = document.getElementById('txn-modal-id').value;
            const amount = parseFloat(document.getElementById('txn-modal-amount').value);
            const name = document.getElementById('txn-modal-name').value;
            const category = document.getElementById('txn-modal-category').value;
            const type = document.getElementById('txn-modal-type').value;
            const dateVal = document.getElementById('txn-modal-date').value;
            const focus = document.getElementById('txn-modal-focus').value;

            if (isNaN(amount)) return;

            if (id) {
                const txn = appState.transactions.find(t => t.id == id);
                if (txn) {
                    txn.amount = amount;
                    txn.name = name;
                    txn.category = category;
                    txn.type = type;
                    txn.dateIso = dateVal.includes('T') ? dateVal : dateVal + 'T12:00:00';
                    txn.budgetFocus = focus;
                }
            } else {
                const newTxn = {
                    id: Date.now(),
                    amount: amount,
                    name: name,
                    category: category,
                    type: type,
                    dateIso: dateVal.includes('T') ? dateVal : dateVal + 'T12:00:00',
                    date: new Date(dateVal).toLocaleDateString(),
                    budgetFocus: focus
                };
                appState.transactions.push(newTxn);
            }

            if (typeof saveAppState === 'function') saveAppState();
            else if (typeof saveState === 'function') saveState();

            // Recalculate everything
            if (typeof calculateDashboardMetrics === 'function') calculateDashboardMetrics();
            if (typeof renderMergedDashboard === 'function') renderMergedDashboard();
            if (typeof updateFocusStats === 'function') updateFocusStats(); // Update sidebar stats if exists

            if (typeof currentWalletFilter !== 'undefined') filterWallet(currentWalletFilter);
            else filterWallet('all');

            closeTransactionModal();
        }

        function deleteFromModal() {
            const id = document.getElementById('txn-modal-id').value;
            if (id) {
                deleteTransaction(id);
                closeTransactionModal();
            }
        }
    </script>
    <!-- PREMIUM TRANSACTION MODAL (V2) -->
    <div id="transaction-modal-premium"
        class="fixed inset-0 bg-black/90 backdrop-blur-xl z-[9999] hidden flex items-center justify-center opacity-0 transition-all duration-300">
        <div class="bg-[#0f1115] border border-white/10 w-full h-full md:h-auto md:max-h-[90vh] md:w-[600px] md:rounded-[32px] shadow-2xl relative flex flex-col overflow-hidden transform scale-95 transition-all duration-300"
            id="txn-modal-content-v2">

            <!-- Header -->
            <div
                class="p-6 border-b border-white/5 flex items-center justify-between bg-[#161b22]/50 backdrop-blur-md sticky top-0 z-10">
                <h3 class="text-xl font-black text-white flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-xl bg-indigo-500/20 text-indigo-400 flex items-center justify-center shadow-[0_0_15px_rgba(99,102,241,0.3)]">
                        <i data-lucide="layers" class="w-5 h-5"></i>
                    </div>
                    Detalles de Transacción
                </h3>
                <button onclick="closeTransactionModalV2()"
                    class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 text-slate-400 hover:text-white flex items-center justify-center transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-8 custom-scrollbar">
                <input type="hidden" id="v2-modal-id">

                <!-- Main Value Input -->
                <div class="relative group text-center py-4">
                    <div class="inline-flex items-center justify-center relative">
                        <span class="text-3xl font-bold text-slate-500 mr-2">$</span>
                        <input type="number" id="v2-modal-amount" placeholder="0.00" step="0.01"
                            class="bg-transparent border-none p-0 text-5xl font-black text-white placeholder-slate-700 focus:ring-0 text-center w-64 outline-none transition-all drop-shadow-[0_0_10px_rgba(255,255,255,0.2)]">
                    </div>
                    <p class="text-xs text-slate-500 font-bold uppercase tracking-[0.2em] mt-2">Monto Total</p>
                </div>

                <!-- Type Selector (Tabs) -->
                <div class="bg-[#0b0d10] p-1.5 rounded-2xl flex border border-white/5">
                    <button id="v2-btn-expense" onclick="setV2Type('expense')"
                        class="flex-1 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all">
                        Gasto
                    </button>
                    <button id="v2-btn-income" onclick="setV2Type('income')"
                        class="flex-1 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all">
                        Ingreso
                    </button>
                    <input type="hidden" id="v2-modal-type">
                </div>

                <!-- Category Grid (Visual) -->
                <div>
                    <label
                        class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-4 flex items-center gap-2">
                        <i data-lucide="grid" class="w-3 h-3"></i> Categoría
                    </label>
                    <div class="grid grid-cols-4 gap-3" id="v2-cat-grid">
                        <!-- Populated via JS -->
                    </div>
                    <input type="hidden" id="v2-modal-category">
                </div>

                <!-- Info Row (Date & Name) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div
                        class="bg-[#161b22] p-4 rounded-2xl border border-white/5 group focus-within:border-indigo-500/50 transition">
                        <label
                            class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">Fecha</label>
                        <label
                            class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">Fecha</label>

                        <!-- Custom Date Picker Trigger & Container -->
                        <div class="relative z-50">
                            <input type="hidden" id="v2-modal-date">
                            <button type="button" id="v2-date-trigger" onclick="toggleCustomDatePicker()"
                                class="w-full bg-[#0b0d10] hover:bg-black/40 border border-white/5 hover:border-indigo-500/50 rounded-xl py-2.5 px-4 text-white text-sm font-bold outline-none transition-all flex items-center justify-between group">
                                <span id="v2-date-display"
                                    class="group-hover:text-indigo-200 transition-colors">Hoy</span>
                                <i data-lucide="calendar"
                                    class="w-4 h-4 text-slate-500 group-hover:text-indigo-400 transition-colors"></i>
                            </button>

                            <!-- Custom Calendar Dropdown -->
                            <div id="v2-custom-date-picker"
                                class="hidden absolute left-0 bottom-full mb-2 w-72 bg-[#161b22]/95 backdrop-blur-2xl border border-white/10 rounded-3xl shadow-[0_20px_60px_-15px_rgba(0,0,0,0.9)] p-4 animate-fade-in-up origin-bottom-left">

                                <!-- Header -->
                                <div class="flex items-center justify-between mb-4">
                                    <button type="button" onclick="changeCustomPickerMonth(-1)"
                                        class="p-1 rounded-lg hover:bg-white/5 text-slate-400 hover:text-white transition"><i
                                            data-lucide="chevron-left" class="w-4 h-4"></i></button>
                                    <span id="v2-picker-title" class="text-sm font-black text-white tracking-wide">DIC
                                        2025</span>
                                    <button type="button" onclick="changeCustomPickerMonth(1)"
                                        class="p-1 rounded-lg hover:bg-white/5 text-slate-400 hover:text-white transition"><i
                                            data-lucide="chevron-right" class="w-4 h-4"></i></button>
                                </div>

                                <!-- Days Header -->
                                <div class="grid grid-cols-7 gap-1 mb-2 text-center">
                                    <span class="text-[10px] text-slate-500 font-bold">Do</span>
                                    <span class="text-[10px] text-slate-500 font-bold">Lu</span>
                                    <span class="text-[10px] text-slate-500 font-bold">Ma</span>
                                    <span class="text-[10px] text-slate-500 font-bold">Mi</span>
                                    <span class="text-[10px] text-slate-500 font-bold">Ju</span>
                                    <span class="text-[10px] text-slate-500 font-bold">Vi</span>
                                    <span class="text-[10px] text-slate-500 font-bold">Sa</span>
                                </div>

                                <!-- Days Grid -->
                                <div id="v2-picker-grid" class="grid grid-cols-7 gap-1">
                                    <!-- Generated via JS -->
                                </div>

                                <!-- Footer -->
                                <div class="mt-3 pt-3 border-t border-white/5 flex justify-between">
                                    <button type="button" onclick="selectCustomDate(new Date())"
                                        class="text-[10px] font-bold text-indigo-400 hover:text-white transition">Hoy</button>
                                    <button type="button" onclick="toggleCustomDatePicker()"
                                        class="text-[10px] font-bold text-slate-500 hover:text-white transition">Cerrar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div
                        class="bg-[#161b22] p-4 rounded-2xl border border-white/5 group focus-within:border-indigo-500/50 transition">
                        <label
                            class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">Descripción</label>
                        <input type="text" id="v2-modal-name" placeholder="Ej: Starbucks"
                            class="w-full bg-transparent text-white font-bold outline-none placeholder-slate-600">
                    </div>
                </div>

                <!-- Budget Focus Tags (The "Infrastructure") -->
                <div>
                    <label
                        class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-4 flex items-center gap-2">
                        <i data-lucide="target" class="w-3 h-3"></i> Enfoque de Presupuesto
                    </label>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" onclick="setV2Focus('Needs')"
                            class="v2-focus-pill px-4 py-2 rounded-xl text-xs font-bold border border-white/5 bg-[#161b22] text-slate-400 transition flex items-center gap-2"
                            data-val="Needs">
                            <span class="w-2 h-2 rounded-full bg-indigo-500"></span> NEEDS
                        </button>
                        <button type="button" onclick="setV2Focus('Wants')"
                            class="v2-focus-pill px-4 py-2 rounded-xl text-xs font-bold border border-white/5 bg-[#161b22] text-slate-400 transition flex items-center gap-2"
                            data-val="Wants">
                            <span class="w-2 h-2 rounded-full bg-pink-500"></span> WANTS
                        </button>
                        <button type="button" onclick="setV2Focus('Saving')"
                            class="v2-focus-pill px-4 py-2 rounded-xl text-xs font-bold border border-white/5 bg-[#161b22] text-slate-400 transition flex items-center gap-2"
                            data-val="Saving">
                            <span class="w-2 h-2 rounded-full bg-emerald-500"></span> SAVING
                        </button>
                        <button type="button" onclick="setV2Focus('Invest')"
                            class="v2-focus-pill px-4 py-2 rounded-xl text-xs font-bold border border-white/5 bg-[#161b22] text-slate-400 transition flex items-center gap-2"
                            data-val="Invest">
                            <span class="w-2 h-2 rounded-full bg-violet-500"></span> INVEST
                        </button>
                        <button type="button" onclick="setV2Focus('Waste')"
                            class="v2-focus-pill px-4 py-2 rounded-xl text-xs font-bold border border-white/5 bg-[#161b22] text-slate-400 transition flex items-center gap-2"
                            data-val="Waste">
                            <span class="w-2 h-2 rounded-full bg-red-500"></span> WASTE
                        </button>
                    </div>
                    <input type="hidden" id="v2-modal-focus">
                </div>

                <div class="h-10"></div> <!-- Spacer -->
            </div>

            <!-- Footer -->
            <div class="p-6 border-t border-white/5 bg-[#161b22]/80 backdrop-blur-md flex items-center gap-4">
                <button onclick="deleteV2()"
                    class="p-4 rounded-2xl bg-rose-500/10 hover:bg-rose-500 border border-rose-500/20 text-rose-500 hover:text-white transition group">
                    <i data-lucide="trash-2" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                </button>
                <button onclick="saveTransactionV2()"
                    class="flex-1 py-4 rounded-2xl bg-indigo-600 hover:bg-indigo-500 text-white font-bold tracking-wide shadow-lg shadow-indigo-500/25 transition transform hover:scale-[1.02]">
                    Guardar Cambios
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- PREMIUM V2 MODAL LOGIC ---

        // Config icons map
        const catIconsMap = {

            'Food': 'utensils',
            'Groceries': 'shopping-cart',
            'Housing': 'home',
            'Transport': 'car',
            'Entertainment': 'gamepad-2',
            'Shopping': 'shopping-bag',
            'Health': 'heart',
            'Education': 'graduation-cap',
            'Travel': 'plane',
            'Beer': 'beer',
            'Junk Food': 'pizza',
            'Weed': 'leaf',
            'Love': 'heart-handshake',
            'Gas': 'fuel',
            'Others': 'help-circle',
            'Tech': 'cpu',
            'Utilities': 'zap',

            // Income
            'Salary': 'briefcase',
            'Freelance': 'laptop',
            'Investments': 'trending-up',
            'Gift': 'gift',
            'Bonus': 'award',
            'Refund': 'rotate-ccw',
            'Passive Income': 'repeat',
            'Other': 'plus-circle'
        };

        // Helper: Get icon for any category (income or expense)
        function getCategoryIcon(category, type) {
            // Use the existing catIconsMap
            return catIconsMap[category] || (type === 'income' ? 'circle-dollar-sign' : 'shopping-bag');
        }



        const expenseCategories = ['Food', 'Groceries', 'Housing', 'Transport', 'Entertainment', 'Shopping', 'Health', 'Education', 'Travel', 'Beer', 'Junk Food', 'Weed', 'Love', 'Gas', 'Others'];
        const incomeCategories = ['Salary', 'Freelance', 'Investments', 'Gift', 'Bonus', 'Refund', 'Passive Income', 'Other'];

        function setV2Type(type) {
            document.getElementById('v2-modal-type').value = type;
            const btnExp = document.getElementById('v2-btn-expense');
            const btnInc = document.getElementById('v2-btn-income');

            if (type === 'expense') {
                btnExp.className = "flex-1 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all bg-rose-500 text-white shadow-lg shadow-rose-500/20";
                btnInc.className = "flex-1 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all bg-transparent text-slate-500 hover:text-white hover:bg-white/5";
                renderV2CategoryGrid('expense');
            } else {
                btnInc.className = "flex-1 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all bg-emerald-500 text-white shadow-lg shadow-emerald-500/20";
                btnExp.className = "flex-1 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all bg-transparent text-slate-500 hover:text-white hover:bg-white/5";
                renderV2CategoryGrid('income');
            }
        }

        function setV2Category(cat) {
            document.getElementById('v2-modal-category').value = cat;
            document.querySelectorAll('.v2-cat-btn').forEach(btn => {
                const btnCat = btn.dataset.cat;
                if (btnCat === cat) {
                    btn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-400', 'shadow-lg', 'scale-105');
                    btn.classList.remove('bg-[#161b22]', 'text-slate-400', 'border-white/5', 'hover:bg-white/10');
                } else {
                    btn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-400', 'shadow-lg', 'scale-105');
                    btn.classList.add('bg-[#161b22]', 'text-slate-400', 'border-white/5', 'hover:bg-white/10');
                }
            });
        }

        function setV2Focus(val) {
            document.getElementById('v2-modal-focus').value = val;
            document.querySelectorAll('.v2-focus-pill').forEach(btn => {
                const isActive = btn.dataset.val === val;
                const map = { 'Needs': 'indigo', 'Wants': 'pink', 'Saving': 'emerald', 'Invest': 'violet', 'Waste': 'red' };
                const c = map[btn.dataset.val] || 'indigo';

                if (isActive) {
                    btn.className = `v2-focus-pill px-4 py-2 rounded-xl text-xs font-bold border border-${c}-500 bg-${c}-500/20 text-${c}-400 transition flex items-center gap-2 shadow-[0_0_10px_rgba(0,0,0,0.3)] scale-105`;
                } else {
                    btn.className = "v2-focus-pill px-4 py-2 rounded-xl text-xs font-bold border border-white/5 bg-[#161b22] text-slate-500 hover:bg-white/10 transition flex items-center gap-2 opacity-70 hover:opacity-100";
                }
            });
        }

        function renderV2CategoryGrid(type = 'expense') {
            const grid = document.getElementById('v2-cat-grid');
            if (!grid) return;
            grid.innerHTML = '';

            const cats = type === 'income' ? incomeCategories : expenseCategories;

            // Current selected category (hidden input)
            const currentCat = document.getElementById('v2-modal-category').value;
            // If current cat is not in the new list, default to first item
            if (!cats.includes(currentCat)) {
                // Defer setting value to avoid race conditions if called during init
                // specific init logic handles this, but for toggle:
                if (document.activeElement && (document.activeElement.id === 'v2-btn-income' || document.activeElement.id === 'v2-btn-expense')) {
                    document.getElementById('v2-modal-category').value = cats[0];
                }
            }

            cats.forEach(cat => {
                const iconName = catIconsMap[cat] || 'tag';
                const isSelected = document.getElementById('v2-modal-category').value === cat;

                const btn = document.createElement('button');
                btn.type = 'button';
                // Base classes
                let classes = "v2-cat-btn p-3 rounded-xl border flex flex-col items-center justify-center gap-2 transition group ";
                // State classes
                if (isSelected) {
                    classes += "bg-indigo-600 text-white border-indigo-400 shadow-lg scale-105";
                } else {
                    classes += "bg-[#161b22] border-white/5 text-slate-400 hover:text-white hover:bg-white/10";
                }

                btn.className = classes;
                btn.onclick = () => setV2Category(cat);
                btn.dataset.cat = cat;

                btn.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center group-hover:scale-110 transition">
                        <i data-lucide="${iconName}" class="w-4 h-4"></i>
                    </div>
                    <span class="text-[9px] font-bold uppercase tracking-wider truncate w-full">${cat}</span>
                `;
                grid.appendChild(btn);
            });

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function openTransactionModalV2(mode, id = null) {
            const modal = document.getElementById('transaction-modal-premium');
            const content = document.getElementById('txn-modal-content-v2');
            if (!modal) return;

            // Inputs
            const idInput = document.getElementById('v2-modal-id');
            const amtInput = document.getElementById('v2-modal-amount');
            const nameInput = document.getElementById('v2-modal-name');
            // dateInput is hidden, handled by custom picker

            // Set defaults first
            if (mode === 'add') {
                document.getElementById('v2-modal-category').value = 'Food'; // Default
                renderV2CategoryGrid('expense'); // Default render
            }

            if (mode === 'edit' && id) {
                const txn = appState.transactions.find(t => t.id == id);
                if (!txn) return;

                idInput.value = txn.id;
                amtInput.value = txn.amount;
                nameInput.value = txn.name || '';

                // Date Handling
                let dateStr = '';
                if (txn.dateIso && txn.dateIso.includes('-')) dateStr = txn.dateIso.split('T')[0];
                else {
                    const d = new Date(txn.dateIso || txn.id);
                    if (!isNaN(d)) dateStr = d.toISOString().split('T')[0];
                }

                // Initialize Custom Picker
                if (typeof initCustomDatePicker === 'function') {
                    initCustomDatePicker(dateStr);
                }

                // Set Type & Render Grid
                const type = txn.type || 'expense';
                setV2Type(type); // This calls renderV2CategoryGrid internally

                // Set Category (after render)
                setV2Category(txn.category || (type === 'income' ? 'Salary' : 'Food'));
                setV2Focus(txn.budgetFocus || 'Needs');

            } else {
                // New
                idInput.value = '';
                amtInput.value = '';
                nameInput.value = '';

                // Default date: Today
                if (typeof initCustomDatePicker === 'function') {
                    initCustomDatePicker(new Date().toISOString().split('T')[0]);
                }

                setV2Type('expense'); // Renders Expense Grid
                setV2Category('Food');
                setV2Focus('Needs');
            }

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function closeTransactionModalV2() {
            const modal = document.getElementById('transaction-modal-premium');
            const content = document.getElementById('txn-modal-content-v2');
            if (!modal) return;
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function saveTransactionV2() {
            const id = document.getElementById('v2-modal-id').value;
            const amount = parseFloat(document.getElementById('v2-modal-amount').value);
            const name = document.getElementById('v2-modal-name').value;
            const category = document.getElementById('v2-modal-category').value;
            const type = document.getElementById('v2-modal-type').value;
            const dateVal = document.getElementById('v2-modal-date').value;
            const focus = document.getElementById('v2-modal-focus').value;

            if (isNaN(amount)) return;

            if (id) {
                const txn = appState.transactions.find(t => t.id == id);
                if (txn) {
                    txn.amount = amount;
                    txn.name = name;
                    txn.category = category;
                    txn.type = type;
                    txn.dateIso = dateVal.includes('T') ? dateVal : dateVal + 'T12:00:00';
                    txn.budgetFocus = focus;
                }
            } else {
                const newTxn = {
                    id: Date.now(),
                    amount: amount,
                    name: name,
                    category: category,
                    type: type,
                    dateIso: dateVal.includes('T') ? dateVal : dateVal + 'T12:00:00',
                    date: new Date(dateVal).toLocaleDateString(),
                    budgetFocus: focus
                };
                appState.transactions.push(newTxn);
            }

            if (typeof saveAppState === 'function') saveAppState();
            else if (typeof saveState === 'function') saveState();

            // Refresh UI
            if (typeof calculateDashboardMetrics === 'function') calculateDashboardMetrics();
            if (typeof renderMergedDashboard === 'function') renderMergedDashboard();
            if (typeof updateFocusStats === 'function') updateFocusStats();

            // Re-render Wallet List
            if (typeof filterWallet === 'function' && typeof currentWalletFilter !== 'undefined') {
                // Re-apply current filter
                filterWallet(currentWalletFilter, currentWalletFilter === 'month' ? document.getElementById('history-month-label').innerText : null);
            } else if (typeof renderWalletHistory === 'function') {
                renderWalletHistory(appState.transactions); // Fallback
            }

            // Close Immediately (No "Success" toast)
            closeTransactionModalV2();
        }

        // --- CUSTOM DATE PICKER LOGIC ---
        let customPickerDate = new Date(); // Internal logic date

        function toggleCustomDatePicker() {
            const el = document.getElementById('v2-custom-date-picker');
            if (el) el.classList.toggle('hidden');
        }

        function initCustomDatePicker(initialDateStr) {
            // initialDateStr format: YYYY-MM-DD (or Date object)
            let d = new Date();
            if (initialDateStr) {
                // Fix timezone by forcing T12:00:00 if plain string
                if (typeof initialDateStr === 'string' && initialDateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    d = new Date(initialDateStr + 'T12:00:00');
                } else {
                    d = new Date(initialDateStr);
                }
            }
            customPickerDate = d;

            // Set Hidden Input
            const iso = d.toISOString().split('T')[0];
            document.getElementById('v2-modal-date').value = iso;

            // Update Trigger Text
            updateCustomPickerTrigger(d);

            // Render Calendar
            renderCustomDatePicker();
        }

        function updateCustomPickerTrigger(date) {
            const el = document.getElementById('v2-date-display');
            if (el) {
                // Friendly Format: "Lun, 16 Dic 2025"
                const str = date.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
                el.innerText = str.charAt(0).toUpperCase() + str.slice(1);
            }
        }

        function changeCustomPickerMonth(delta) {
            customPickerDate.setMonth(customPickerDate.getMonth() + delta);
            renderCustomDatePicker();
        }

        function selectCustomDate(date) {
            // Update logic date
            customPickerDate = date;

            // Update Hidden & Visuals
            const iso = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
            document.getElementById('v2-modal-date').value = iso;
            updateCustomPickerTrigger(date);

            // Close
            toggleCustomDatePicker();

            // Re-render to show selection if re-opened
            renderCustomDatePicker();
        }

        function renderCustomDatePicker() {
            const grid = document.getElementById('v2-picker-grid');
            const title = document.getElementById('v2-picker-title');
            if (!grid || !title) return;

            grid.innerHTML = '';

            // Update Title
            const monthStr = customPickerDate.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' }).toUpperCase();
            title.innerText = monthStr;

            // Calendar Logic
            const year = customPickerDate.getFullYear();
            const month = customPickerDate.getMonth();

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = firstDay.getDay(); // 0 = Sun

            // Current selected value (from hidden input)
            const currentVal = document.getElementById('v2-modal-date').value;
            const [selY, selM, selD] = currentVal.split('-').map(Number);

            // Empty slots
            for (let i = 0; i < startDay; i++) {
                const empty = document.createElement('div');
                grid.appendChild(empty);
            }

            // Days
            for (let d = 1; d <= daysInMonth; d++) {
                const btn = document.createElement('button');
                btn.type = 'button';

                let isSelected = (selY === year && selM === (month + 1) && selD === d);
                let isToday = (new Date().toDateString() === new Date(year, month, d).toDateString());

                let cls = "h-8 w-8 rounded-lg text-xs font-bold transition flex items-center justify-center ";
                if (isSelected) {
                    cls += "bg-indigo-600 text-white shadow-lg shadow-indigo-500/50 scale-110";
                } else if (isToday) {
                    cls += "text-indigo-400 border border-indigo-500/30";
                } else {
                    cls += "text-slate-400 hover:text-white hover:bg-white/10";
                }

                btn.className = cls;
                btn.innerText = d;
                btn.onclick = (e) => {
                    e.stopPropagation();
                    selectCustomDate(new Date(year, month, d));
                };

                grid.appendChild(btn);
            }

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function deleteV2() {
            const id = document.getElementById('v2-modal-id').value;
            if (id) {
                // Instant delete, no confirmation
                deleteTransactionQuick(id);
                closeTransactionModalV2();
            }
        }

        // --- GLOBAL ALIAS FOR LIST INTERACTION ---
        window.editTransaction = function (id) {
            openTransactionModalV2('edit', id);
        };
    </script>
    <script>
        // Use openTransactionModalV2 for history items via the editTransaction global alias
        // (Removing redundant monkey-patch as it caused data ambiguity)
    </script>
    <script>
        // --- WEEKLY ACTIVITY CHART (Restored) ---
        let weeklyChartInstance = null; // Global instance for cleanup

        function renderWeeklyActivityChart() {
            const el = document.getElementById('weekly-activity-bars');
            if (!el) return;

            // Proper Cleanup of previous instance
            if (weeklyChartInstance) {
                weeklyChartInstance.destroy();
                weeklyChartInstance = null;
            }
            el.innerHTML = ''; // Double check clear

            // --- DATE LOGIC ---
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const categories = [];
            const incomeData = [];
            const expenseData = [];

            for (let day = 1; day <= daysInMonth; day++) {
                const dateObj = new Date(year, month, day);
                const yyyy = dateObj.getFullYear();
                const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
                const dd = String(dateObj.getDate()).padStart(2, '0');
                const dayStr = `${yyyy} -${mm} -${dd} `;
                const dayStrAlt = `${yyyy} -${dateObj.getMonth() + 1} -${dateObj.getDate()}`; // For loose parsing

                categories.push(day);

                let inc = 0;
                let exp = 0;

                appState.transactions.forEach(t => {
                    // Robust Date Parsing
                    let d;
                    if (t.dateIso) d = new Date(t.dateIso);
                    else if (t.id && !isNaN(new Date(t.id).getTime())) d = new Date(parseInt(t.id));
                    else if (t.date) d = new Date(t.date);

                    if (!d || isNaN(d.getTime())) return;

                    // Match Day
                    // Simplest: Check if Year, Month, Date matches current loop
                    if (d.getFullYear() === year && d.getMonth() === month && d.getDate() === day) {
                        if (t.type === 'income') inc += t.amount;
                        else exp += t.amount;
                    }
                });
                incomeData.push(inc);
                expenseData.push(exp);
            }

            // Update Header Text if it exists
            try {
                // Find previous sibling headers or specific IDs
                const container = el.parentElement;
                const header = container.querySelector('h3');
                if (header && header.innerText.includes('Week')) {
                    // header.innerText = 'Monthly Activity'; // Optional rename
                }
                const sub = container.querySelector('p');
                if (sub) sub.innerText = 'Current Month';
            } catch (e) { }

            const options = {
                series: [
                    { name: 'Income', data: incomeData },
                    { name: 'Expense', data: expenseData }
                ],
                chart: {
                    type: 'bar',
                    height: '100%',
                    toolbar: { show: false },
                    fontFamily: 'Inter, sans-serif',
                    background: 'transparent',
                    animations: { enabled: true }
                },
                colors: ['#34d399', '#fb7185'], // Brighter Emerald & Rose
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: '55%',
                        borderRadius: 3,
                        borderRadiusApplication: 'end', // Only round top
                    },
                },
                dataLabels: { enabled: false },
                stroke: { show: true, width: 2, colors: ['transparent'] },
                xaxis: {
                    categories: categories,
                    axisBorder: { show: false },
                    axisTicks: { show: false },
                    labels: {
                        style: { colors: '#94a3b8', fontSize: '11px', fontWeight: 600 },
                        rotate: -45,
                        hideOverlappingLabels: false
                    },
                    tooltip: { enabled: false }
                },
                yaxis: {
                    show: true,
                    labels: {
                        style: { colors: '#64748b', fontSize: '10px' },
                        formatter: (val) => { return val >= 1000 ? (val / 1000).toFixed(1) + 'k' : val.toFixed(0) }
                    }
                },
                fill: { opacity: 1 },
                tooltip: {
                    theme: 'dark',
                    y: { formatter: function (val) { return "$ " + formatCurrency(val) } }
                },
                grid: {
                    show: true,
                    borderColor: '#334155',
                    strokeDashArray: 4,
                    yaxis: { lines: { show: true } },
                    xaxis: { lines: { show: false } },
                    padding: { top: 0, right: 0, bottom: 0, left: 10 }
                },
                legend: { show: false }
            };
            weeklyChartInstance = new ApexCharts(el, options);
            weeklyChartInstance.render();
        }

        // Hook into initialization and updates
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(renderWeeklyActivityChart, 800);
        });

        // 2. Monkey-patch saveTransactionV2 to update chart
        const oldSaveV2 = saveTransactionV2;
        saveTransactionV2 = function () {
            oldSaveV2();
            setTimeout(renderWeeklyActivityChart, 100);
        };

        // 3. Monkey-patch deleteTransaction to update chart
        // Since deleteTransaction is defined earlier, we can wrap it
        if (typeof deleteTransaction === 'function') {
            const oldDelete = deleteTransaction;
            deleteTransaction = function (id) {
                oldDelete(id);
                setTimeout(renderWeeklyActivityChart, 100);
            };
        }
    </script>

    <!-- Theme Utils -->
    <script src="theme_utils.js"></script>
    <script src="wallpaper_utils.js"></script>
    <!-- HISTORY EDITOR MODAL -->
    <div id="history-editor-modal"
        class="fixed inset-0 bg-black/90 backdrop-blur-md z-[250] hidden flex items-center justify-center opacity-0 transition-all duration-300">
        <div class="bg-[#0f1115] border border-white/10 p-8 rounded-[32px] w-full max-w-2xl h-[85vh] flex flex-col shadow-2xl transform scale-95 transition-all duration-300 relative overflow-hidden"
            id="history-modal-content">
            <div
                class="absolute top-0 right-0 w-64 h-64 bg-indigo-500/10 rounded-full blur-3xl pointer-events-none -translate-y-1/2 translate-x-1/2">
            </div>

            <div class="flex justify-between items-center mb-8 relative z-10">
                <div>
                    <h3 class="text-xl font-black text-white uppercase tracking-wider flex items-center gap-3">
                        <span class="p-2 bg-indigo-500/20 rounded-lg text-indigo-400"><i data-lucide="database"
                                class="w-5 h-5"></i></span>
                        Editor de Historial
                    </h3>
                    <p class="text-xs text-slate-500 font-bold uppercase tracking-widest mt-1 ml-1">Ajuste Manual de
                        Meses</p>
                </div>
                <button onclick="closeHistoryEditor()"
                    class="p-2 rounded-full hover:bg-white/10 text-slate-400 hover:text-white transition"><i
                        data-lucide="x" class="w-6 h-6"></i></button>
            </div>

            <div class="flex-1 overflow-y-auto pr-2 space-y-3 custom-scrollbar relative z-10" id="history-editor-rows">
                <!-- Rows injected by JS -->
            </div>

            <div class="mt-8 flex justify-end gap-3 relative z-10 border-t border-white/5 pt-6">
                <button onclick="closeHistoryEditor()"
                    class="px-6 py-3 rounded-xl bg-slate-800/50 text-slate-400 font-bold text-xs hover:bg-slate-700 hover:text-white transition uppercase tracking-wider">Cancelar</button>
                <button onclick="saveHistoryEditor()"
                    class="px-8 py-3 rounded-xl bg-indigo-600 text-white font-bold text-xs hover:bg-indigo-500 shadow-lg shadow-indigo-500/20 transition transform hover:scale-105 uppercase tracking-wider flex items-center gap-2">
                    <i data-lucide="save" class="w-4 h-4"></i> Guardar Cambios
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- SMART SIMULATION (Full Scenario Reset) ---
        function generateRandomData() {
            // Wrapper for the new robust simulation logic in state_manager.js
            if (typeof window.simulateDemoData === 'function') {
                window.simulateDemoData(6);
            } else {
                console.error("simulateDemoData function not found in state_manager.js");
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Simulation function missing. Please reload the page.',
                    background: '#1E293B',
                    color: '#fff'
                });
            }
        }

        // --- BACKUP SYSTEM ---
        function downloadBackup() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(window.appState));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "Aureus_Backup_" + new Date().toISOString().slice(0, 10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();

            Swal.fire({
                icon: 'success',
                title: 'Respaldo Descargado',
                text: 'Guarda este archivo en un lugar seguro.',
                background: '#1E293B', color: '#fff', timer: 2000, showConfirmButton: false
            });
        }

        function triggerBackupLoad() {
            document.getElementById('backup-upload').click();
        }

        function handleBackupFile(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data && typeof data === 'object') {
                        // Restore logic
                        if (data.transactions) window.appState.transactions = data.transactions;
                        if (data.budget) window.appState.budget = data.budget;
                        if (data.savingsGoals) window.appState.savingsGoals = data.savingsGoals;
                        if (data.debts) window.appState.debts = data.debts;
                        if (data.assets) window.appState.assets = data.assets;
                        if (data.user) window.appState.user = data.user;

                        // Save
                        if (typeof window.saveAppState === 'function') window.saveAppState();
                        else localStorage.setItem('financeAppState', JSON.stringify(window.appState));

                        Swal.fire({
                            icon: 'success',
                            title: 'Restauración Exitosa',
                            text: 'Tus datos han sido cargados correctamente.',
                            background: '#1E293B', color: '#fff',
                            timer: 2000, showConfirmButton: false
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        throw new Error("Invalid structure");
                    }
                } catch (err) {
                    console.error(err);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de Archivo',
                        text: 'El archivo seleccionado no es un respaldo válido de Aureus.',
                        background: '#1E293B', color: '#fff'
                    });
                }
            };
            reader.readAsText(file);
        }

        // --- HISTORY EDITOR LOGIC ---
        function openHistoryEditor() {
            const modal = document.getElementById('history-editor-modal');
            const content = document.getElementById('history-modal-content');
            const container = document.getElementById('history-editor-rows');
            if (!modal) return;

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);

            container.innerHTML = '';
            const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const year = 2025;
            const txs = appState.transactions || [];

            const getTotals = (mIndex) => {
                let inc = 0, exp = 0;
                txs.forEach(t => {
                    // Robust Date Parsing for Filter
                    let raw = t.dateIso || t.id;
                    if (typeof raw === 'string' && raw.length === 10) raw += 'T12:00:00'; // Force middle of day for YYYY-MM-DD
                    const d = new Date(raw);
                    if (d.getFullYear() === year && d.getMonth() === mIndex) {
                        if (t.type === 'income') inc += t.amount;
                        if (t.type === 'expense') exp += t.amount;
                    }
                });
                return { inc, exp };
            };

            months.forEach((mName, idx) => {
                const { inc, exp } = getTotals(idx);

                const row = document.createElement('div');
                row.className = "group flex items-center gap-4 bg-[#161b22] p-4 rounded-2xl border border-white/5 hover:border-indigo-500/30 transition-colors shadow-lg";
                row.innerHTML = `
                <div class="w-24 shrink-0">
                    <div class="text-white font-black text-sm uppercase tracking-wider">` + mName + `</div>
                    <div class="text-[10px] text-slate-500 font-bold mt-0.5">2025</div>
                </div>

                <div class="flex-1 grid grid-cols-2 gap-4">
                    <div class="relative group/input">
                        <label class="absolute -top-2 left-3 px-1 bg-[#161b22] text-[9px] text-emerald-500 font-bold uppercase tracking-wider group-focus-within/input:text-emerald-400">Ingresos</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-xs font-bold">$</span>
                            <input type="number" step="0.01" id="hist-inc-` + idx + `" value="` + parseFloat(inc.toFixed(2)) + `" class="w-full bg-black/20 border border-white/10 rounded-xl py-2.5 pl-7 pr-3 text-emerald-400 font-mono text-sm font-bold focus:border-emerald-500/50 focus:bg-emerald-500/5 outline-none transition text-right">
                        </div>
                    </div>

                    <div class="relative group/input">
                        <label class="absolute -top-2 left-3 px-1 bg-[#161b22] text-[9px] text-rose-500 font-bold uppercase tracking-wider group-focus-within/input:text-rose-400">Gastos</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-xs font-bold">$</span>
                            <input type="number" step="0.01" id="hist-exp-` + idx + `" value="` + parseFloat(exp.toFixed(2)) + `" class="w-full bg-black/20 border border-white/10 rounded-xl py-2.5 pl-7 pr-3 text-rose-400 font-mono text-sm font-bold focus:border-rose-500/50 focus:bg-rose-500/5 outline-none transition text-right">
                        </div>
                    </div>
                </div>
            `;
                container.appendChild(row);
            });

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function closeHistoryEditor() {
            const modal = document.getElementById('history-editor-modal');
            const content = document.getElementById('history-modal-content');
            if (!modal) return;
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function saveHistoryEditor() {
            try {
                console.log("Starting saveHistoryEditor...");
                const year = 2025;

                // Remove old adjustments
                if (appState.transactions) {
                    appState.transactions = appState.transactions.filter(t => t.category !== 'Manual Adjustment');
                } else {
                    appState.transactions = [];
                }

                for (let m = 0; m < 12; m++) {
                    const rowInc = document.getElementById('hist-inc-' + m);
                    const rowExp = document.getElementById('hist-exp-' + m);
                    if (!rowInc || !rowExp) continue;

                    const targetInc = parseFloat(rowInc.value) || 0;
                    const targetExp = parseFloat(rowExp.value) || 0;

                    let currentInc = 0;
                    let currentExp = 0;

                    appState.transactions.forEach(t => {
                        // Robust Date Parsing for Filter
                        let raw = t.dateIso || t.id;
                        if (typeof raw === 'string' && raw.length === 10) raw += 'T12:00:00'; // Force middle of day for YYYY-MM-DD
                        const d = new Date(raw);
                        if (d.getFullYear() === year && d.getMonth() === m && t.category !== 'Manual Adjustment') {
                            if (t.type === 'income') currentInc += t.amount;
                            if (t.type === 'expense') currentExp += t.amount;
                        }
                    });

                    const diffInc = targetInc - currentInc;
                    const diffExp = targetExp - currentExp;

                    if (Math.abs(diffInc) > 0.01) {
                        appState.transactions.push({
                            id: Date.now() + Math.random(),
                            dateIso: new Date(year, m, 1).toISOString(),
                            type: 'income',
                            category: 'Manual Adjustment',
                            name: 'Ajuste de Ingresos',
                            amount: diffInc
                        });
                    }

                    if (Math.abs(diffExp) > 0.01) {
                        appState.transactions.push({
                            id: Date.now() + Math.random(),
                            dateIso: new Date(year, m, 1).toISOString(),
                            type: 'expense',
                            category: 'Manual Adjustment',
                            name: 'Ajuste de Gastos',
                            amount: diffExp
                        });
                    }
                }

                if (typeof saveAppState === 'function') saveAppState();

                console.log("History saved. Updating charts...");
                if (typeof calculateDashboardMetrics === 'function') calculateDashboardMetrics();
                if (typeof renderMergedDashboard === 'function') renderMergedDashboard();
                if (typeof renderNetWorthChart === 'function') renderNetWorthChart(); // Ensure new chart updates!

                closeHistoryEditor();
                Swal.fire({
                    title: 'Historial Actualizado',
                    text: 'Los nuevos totales han sido aplicados.',
                    icon: 'success',
                    background: '#0f1115',
                    color: '#fff',
                    confirmButtonColor: '#6366f1'
                });
            } catch (e) {
                console.error("Error saving history:", e);
                Swal.fire({
                    title: 'Error',
                    text: 'No se pudo guardar el historial: ' + e.message,
                    icon: 'error'
                });
            }
        }
    </script>
    <script>
        // --- DATA PERSISTENCE & INITIALIZATION FIX ---
        // Ensures that when the page reloads (F5), existing data in localStorage is immediately rendered.
        document.addEventListener('DOMContentLoaded', () => {
            console.log("🚀 Initializing App State & UI...");

            // --- ZOMBIE DATA SAFETY NET ---
            // If transactions are empty but balance is huge, it's a ghost. Kill it.
            if (window.appState && window.appState.transactions && window.appState.transactions.length === 0) {
                if (window.appState.profile && window.appState.profile.balance > 0) {
                    console.warn("💀 Zombie Balance Detected ($" + window.appState.profile.balance + "). Force-correcting to $0.");
                    window.appState.profile.balance = 0;

                    // Also reset accounts just in case
                    if (window.appState.balanceAccounts) {
                        window.appState.balanceAccounts.pocket = 0;
                        window.appState.balanceAccounts.bank = 0;
                        window.appState.balanceAccounts.credit = 0;
                        window.appState.balanceAccounts.loan = 0;
                    }
                    if (typeof saveState === 'function') saveState();
                }
            }

            // 1. Ensure Icons
            if (typeof lucide !== 'undefined') lucide.createIcons();

            // 2. Render Core Views from AppState (loaded from localStorage)
            if (typeof renderMergedDashboard === 'function') renderMergedDashboard();
            if (typeof renderWalletHistory === 'function') renderWalletHistory();
            if (typeof renderBudgetTab === 'function') renderBudgetTab();
            if (typeof updateBudgetFocusStats === 'function') updateBudgetFocusStats();

            // 3. Render Legacy/Global Elements
            if (typeof renderAll === 'function') renderAll();

            // 4. Force Update of Dashboard Cards (Explicitly)
            // Sometimes renderMergedDashboard might run before DOM is fully ready for specific IDs
            setTimeout(() => {
                if (typeof renderMergedDashboard === 'function') renderMergedDashboard();
                if (typeof renderWalletHistory === 'function') renderWalletHistory();
            }, 500);

            console.log("✅ App Initialized with Saved Data.");
        });
    </script>
    <script>
        // --- DYNAMIC APPEARANCE LOGIC ---
        function initDynamicStyles() {
            if (!document.getElementById('dynamic-overrides')) {
                const style = document.createElement('style');
                style.id = 'dynamic-overrides';
                style.innerHTML = `
                    :root {
                --radius - override - xl: 24px;
                --radius - override - lg: 16px;
                --radius - override - md: 12px;
                --radius - override - sm: 8px;
                --blur - override: 12px;
                --density - zoom: 1;
                --font - override: 'Inter', sans - serif;
            }
                    /* Radius Overrides */
                    .rounded - 3xl, .rounded -\\[24px\\] { border - radius: var(--radius - override - xl)!important; }
                    .rounded - 2xl { border - radius: var(--radius - override - lg)!important; }
                    .rounded - xl { border - radius: var(--radius - override - md)!important; }
                    .rounded - lg { border - radius: var(--radius - override - sm)!important; }

                    /* Blur Overrides */
                    .glass - panel, .backdrop - blur - md, .backdrop - blur - xl, .backdrop - blur - 3xl
            {
                backdrop - filter: blur(var(--blur - override)) !important;
                -webkit - backdrop - filter: blur(var(--blur - override)) !important;
            }

                    /* Density */
                    html {
                font - size: 16px; /* Base */
                zoom: var(--density - zoom);
            }

            /* Typography Override */
            body, button, input, select, textarea, .font - sans {
                font - family: var(--font - override)!important;
            }
            `;
                document.head.appendChild(style);
            }
        }

        // Initialize immediately
        initDynamicStyles();
        const root = document.documentElement;

        function setAppRadius(mode) {
            initDynamicStyles();
            let xl, lg, md, sm;

            if (mode === 'sharp') {
                xl = '4px'; lg = '4px'; md = '4px'; sm = '2px';
            } else if (mode === 'round') {
                xl = '32px'; lg = '24px'; md = '18px'; sm = '14px';
            } else {
                // Standard
                xl = '24px'; lg = '16px'; md = '12px'; sm = '8px';
            }

            root.style.setProperty('--radius-override-xl', xl);
            root.style.setProperty('--radius-override-lg', lg);
            root.style.setProperty('--radius-override-md', md);
            root.style.setProperty('--radius-override-sm', sm);

            // Persist setting
            if (typeof appState !== 'undefined') {
                if (!appState.settings) appState.settings = {};
                appState.settings.radiusMode = mode;
                if (typeof saveState === 'function') saveState();
            }
        }

        function setAppBlur(val) {
            initDynamicStyles();
            // Map 0-100 to 0px-40px
            const px = (val / 100) * 40;
            root.style.setProperty('--blur-override', px + 'px');

            const label = document.getElementById('setting-blur-label');
            if (label) label.innerText = val + '%';

            if (typeof appState !== 'undefined') {
                if (!appState.settings) appState.settings = {};
                appState.settings.blurVal = val;
                if (typeof saveState === 'function') saveState();
            }
        }

        function setAppDensity(val) {
            initDynamicStyles();
            // Map 0-100 to 0.85 - 1.15 zoom
            // 50 is 1.0
            const min = 0.85;
            const max = 1.15;
            const zoom = min + ((val / 100) * (max - min));

            root.style.setProperty('--density-zoom', zoom.toFixed(2));

            const label = document.getElementById('setting-density-label');
            if (label) {
                if (val < 30) label.innerText = 'Compact';
                else if (val > 70) label.innerText = 'Spacious';
                else label.innerText = 'Normal';
            }

            if (typeof appState !== 'undefined') {
                if (!appState.settings) appState.settings = {};
                appState.settings.densityVal = val;
                if (typeof saveState === 'function') saveState();
            }
        }

        function setAppFont(mode) {
            initDynamicStyles();
            let fontStack;

            // Updated Font Stacks
            if (mode === 'serif') {
                fontStack = '"Merriweather", "Times New Roman", serif';
            } else if (mode === 'mono') {
                fontStack = '"JetBrains Mono", "Fira Code", monospace';
            } else if (mode === 'modern') {
                fontStack = '"Outfit", "Inter", sans-serif';
            } else if (mode === 'elegant') {
                fontStack = '"Playfair Display", serif';
            } else if (mode === 'tech') {
                fontStack = '"Rajdhani", "Segoe UI", sans-serif';
            } else {
                // Default / Sans
                fontStack = '"Inter", sans-serif';
            }

            root.style.setProperty('--font-override', fontStack);

            // Visual Feedback for Typography Buttons
            const allBtns = document.querySelectorAll('button[onclick^="setAppFont"]');
            allBtns.forEach(btn => {
                const isActive = btn.getAttribute('onclick').includes(`'${mode}'`);

                // Reset Base Styles (Remove potential active/inactive conflict)
                btn.classList.remove(
                    'bg-indigo-500', 'text-white', 'border-transparent', 'shadow-md', // Active classes
                    'bg-white/5', 'text-slate-400', 'border-white/5'  // Inactive classes
                );

                // Remove Ring
                btn.classList.remove('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-[#1a1d2e]');

                if (isActive) {
                    // Apply Active Styles
                    btn.classList.add('bg-indigo-500', 'text-white', 'border-transparent', 'shadow-md');
                    btn.classList.add('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-[#1a1d2e]');
                } else {
                    // Apply Inactive Styles
                    btn.classList.add('bg-white/5', 'text-slate-400', 'border-white/5');
                }
            });

            if (typeof appState !== 'undefined') {
                if (!appState.settings) appState.settings = {};
                appState.settings.fontMode = mode;
                if (typeof saveState === 'function') saveState();
            }
        }

        // --- SAVINGS TAB LOGIC ---

        // --- UNIFIED PORTFOLIO LOGIC ---

        function initSavingsData() {
            // 1. Initialize Portfolio if missing
            if (!appState.portfolio) {
                console.log("Initializing Unified Portfolio Structure...");
                appState.portfolio = [];
                // Only run full migration if creating from scratch

                // A. Migrate Core Assets (One-time from Legacy Balance)
                const coreAssets = [
                    { key: 'pocket', name: 'Efectivo', icon: 'wallet', color: 'emerald' },
                    { key: 'bank', name: 'Banco', icon: 'landmark', color: 'blue' },
                    { key: 'loan', name: 'Ahorro', icon: 'piggy-bank', color: 'indigo' }
                ];

                coreAssets.forEach(core => {
                    // Try to get existing balance, or 0
                    const currentAmt = appState.balanceAccounts ? (appState.balanceAccounts[core.key] || 0) : 0;
                    appState.portfolio.push({
                        id: `core - ${core.key} `,
                        type: 'asset',
                        subtype: 'core',
                        key: core.key,
                        name: core.name,
                        icon: core.icon,
                        amount: currentAmt,
                        target: 0,
                        theme: core.color,
                        history: [
                            { date: new Date().toISOString(), amount: currentAmt, type: 'in', note: 'Balance Inicial' }
                        ],
                        lastUpdated: new Date().toISOString()
                    });
                });

                // B. Migrate Custom Assets (Legacy)
                if (appState.customAssets && Array.isArray(appState.customAssets)) {
                    appState.customAssets.forEach((asset, idx) => {
                        appState.portfolio.push({
                            id: `custom - ${Date.now()} -${idx} `,
                            type: 'asset',
                            subtype: 'custom',
                            name: asset.name || 'Activo',
                            icon: asset.icon || 'archive',
                            amount: asset.amount || 0,
                            target: asset.target || 0,
                            theme: 'pink',
                            history: [
                                { date: new Date().toISOString(), amount: asset.amount || 0, type: 'in', note: 'Migración' }
                            ],
                            lastUpdated: new Date().toISOString()
                        });
                    });
                }

                // C. Migrate Goals
                if (appState.goals) {
                    appState.goals.forEach((goal, idx) => {
                        let theme = 'violet';
                        if (goal.icon === 'car' || (goal.name && goal.name.toLowerCase().includes('car'))) theme = 'cyan';
                        if (goal.icon === 'plane' || (goal.name && goal.name.toLowerCase().includes('viaje'))) theme = 'amber';

                        appState.portfolio.push({
                            id: `goal - ${goal.id || Date.now() + idx} `,
                            type: 'goal',
                            subtype: 'user',
                            name: goal.name || 'Meta',
                            icon: goal.icon || 'flag',
                            amount: goal.current || 0,
                            target: goal.target || 1000,
                            theme: theme,
                            history: [
                                { date: new Date().toISOString(), amount: goal.current || 0, type: 'in', note: 'Migración de Meta' }
                            ],
                            lastUpdated: new Date().toISOString()
                        });
                    });
                }
                saveData();
            } else {
                // FALLBACK: Ensure Core Assets exist even if portfolio exists (e.g. if it was wiped)
                const coreKeys = ['core-pocket', 'core-bank', 'core-loan'];
                // Check if any core key is missing
                const hasPocket = appState.portfolio.some(i => i.id === 'core-pocket' || i.key === 'pocket');

                if (!hasPocket) {
                    // Emergency Re-inject Core
                    const coreAssets = [
                        { key: 'pocket', name: 'Efectivo', icon: 'wallet', color: 'emerald' },
                        { key: 'bank', name: 'Banco', icon: 'landmark', color: 'blue' },
                        { key: 'loan', name: 'Ahorro', icon: 'piggy-bank', color: 'indigo' }
                    ];
                    coreAssets.forEach(core => {
                        if (!appState.portfolio.find(i => i.key === core.key)) {
                            const currentAmt = appState.balanceAccounts ? (appState.balanceAccounts[core.key] || 0) : 0;
                            appState.portfolio.push({
                                id: `core - ${core.key} `,
                                type: 'asset',
                                subtype: 'core',
                                key: core.key,
                                name: core.name,
                                icon: core.icon,
                                amount: currentAmt,
                                target: 0,
                                theme: core.color,
                                history: [], // Reset history for safety
                                lastUpdated: new Date().toISOString()
                            });
                        }
                    });
                }
            }

            // Ensure Fallbacks
            if (!appState.debts) appState.debts = [];

            syncLegacyData();
        }

        // --- Helper: Keep Old System Alive ---
        function syncLegacyData() {
            if (!appState.portfolio) return;

            // Sync Core Assets back to balanceAccounts
            appState.portfolio.filter(i => i.subtype === 'core').forEach(item => {
                if (appState.balanceAccounts) {
                    appState.balanceAccounts[item.key] = item.amount;
                }
            });

            // Note: We are NOT syncing goals/custom back to the old arrays to avoid duplication confusion. 
            // The new system is the master for those.
        }

        // --- CRUD ACTIONS ---

        function getPortfolioItem(id) {
            return appState.portfolio.find(i => i.id === id);
        }

        function addPortfolioItem(type, name, target, icon, theme) {
            const newItem = {
                id: `${type} -${Date.now()} `,
                type: type, // 'asset' or 'goal'
                subtype: 'user',
                name: name,
                amount: 0,
                target: target || 0,
                icon: icon || 'circle-dashed',
                theme: theme || 'emerald',
                history: [],
                lastUpdated: new Date().toISOString()
            };
            appState.portfolio.push(newItem);
            saveData();
            renderSavingsTab(); // Re-render
        }

        function updatePortfolioTransaction(itemId, amount, type, note) { // type: 'in' | 'out'
            const item = getPortfolioItem(itemId);
            if (!item) return;

            const numAmount = parseFloat(amount);

            // Add to History
            item.history.push({
                date: new Date().toISOString(),
                amount: numAmount,
                type: type,
                note: note || (type === 'in' ? 'Depósito' : 'Retiro')
            });

            // Recalculate Total
            recalcPortfolioItem(item);

            saveData();
            syncLegacyData(); // Update core if needed
            renderSavingsTab();
        }

        function deletePortfolioHistory(itemId, historyIndex) {
            const item = getPortfolioItem(itemId);
            if (!item) return;

            // Remove
            item.history.splice(historyIndex, 1);

            // Recalculate
            recalcPortfolioItem(item);

            saveData();
            syncLegacyData();
            renderSavingsTab();
            // If modal is open, we might need to refresh it? 
            // simpler to close and re-open or let user re-click for now.
            Swal.fire({
                title: 'Eliminado',
                text: 'Registro eliminado correctamente',
                icon: 'success',
                timer: 1000,
                showConfirmButton: false
            });
        }

        function deletePortfolioItem(itemId) {
            appState.portfolio = appState.portfolio.filter(i => i.id !== itemId);
            saveData();
            syncLegacyData();
            renderSavingsTab();
        }

        function recalcPortfolioItem(item) {
            // Re-sum history to get absolute truth
            let total = 0;
            item.history.forEach(h => {
                if (h.type === 'in') total += h.amount;
                if (h.type === 'out') total -= h.amount;
            });
            item.amount = Math.max(0, total); // Prevent negative assets for now? Or allow debt? Let's keep 0 floor for savings.
            item.lastUpdated = new Date().toISOString();
        }

        // --- UNIFIED SAVINGS ARCHITECTURE ---
        function _deprecated_createSavingsCard(params) {
            const { id, type, name, amount, target, icon, colorTheme, originalIdx } = params;

            // Theme Config
            const themes = {
                emerald: { text: 'text-emerald-400', bg: 'bg-emerald-500/10', border: 'hover:border-emerald-500/50', shadow: 'hover:shadow-emerald-500/20', bar: 'from-emerald-500 to-teal-400', iconBg: 'bg-emerald-500/20' },
                blue: { text: 'text-blue-400', bg: 'bg-blue-500/10', border: 'hover:border-blue-500/50', shadow: 'hover:shadow-blue-500/20', bar: 'from-blue-500 to-cyan-400', iconBg: 'bg-blue-500/20' },
                indigo: { text: 'text-indigo-400', bg: 'bg-indigo-500/10', border: 'hover:border-indigo-500/50', shadow: 'hover:shadow-indigo-500/20', bar: 'from-indigo-500 to-violet-400', iconBg: 'bg-indigo-500/20' },
                pink: { text: 'text-pink-400', bg: 'bg-pink-500/10', border: 'hover:border-pink-500/50', shadow: 'hover:shadow-pink-500/20', bar: 'from-pink-500 to-rose-400', iconBg: 'bg-pink-500/20' },
                violet: { text: 'text-violet-400', bg: 'bg-violet-500/10', border: 'hover:border-violet-500/50', shadow: 'hover:shadow-violet-500/20', bar: 'from-violet-500 to-fuchsia-400', iconBg: 'bg-violet-500/20' },
                amber: { text: 'text-amber-400', bg: 'bg-amber-500/10', border: 'hover:border-amber-500/50', shadow: 'hover:shadow-amber-500/20', bar: 'from-amber-500 to-orange-400', iconBg: 'bg-amber-500/20' },
                cyan: { text: 'text-cyan-400', bg: 'bg-cyan-500/10', border: 'hover:border-cyan-500/50', shadow: 'hover:shadow-cyan-500/20', bar: 'from-cyan-500 to-sky-400', iconBg: 'bg-cyan-500/20' },
            };

            const t = themes[colorTheme] || themes.emerald;
            const clickAction = type === 'goal' ? `manageGoal(${id})` : `manageAsset('${type}', ${type === 'custom' ? originalIdx : `'${id}'`})`;

            // Progress Logic
            let progressBlock = '';
            if (target > 0) {
                const pct = Math.min(100, Math.round((amount / target) * 100));
                progressBlock = `
            < div class="mt-5" >
                        <div class="flex justify-between items-end mb-2">
                            <span class="text-[9px] font-black uppercase tracking-widest text-slate-500">Meta: ${formatCurrency(target)}</span>
                            <span class="text-[10px] font-bold ${t.text}">${pct}%</span>
                        </div>
                        <div class="w-full h-1.5 bg-[#0B0D14] rounded-full overflow-hidden border border-white/5 relative">
                            <div class="absolute inset-0 bg-white/5"></div>
                            <div class="h-full bg-gradient-to-r ${t.bar} rounded-full shadow-[0_0_10px_rgba(0,0,0,0.5)] transition-all duration-1000 relative" style="width: ${pct}%">
                                <div class="absolute right-0 top-0 bottom-0 w-1 bg-white/50 blur-[1px]"></div>
                            </div>
                        </div>
                    </div >
            `;
            } else {
                progressBlock = `
            < div class="mt-5 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center gap-2" >
                         <span class="text-[9px] font-bold text-slate-600 uppercase tracking-widest">Sin Meta Global</span>
                         <div class="h-px flex-1 bg-white/5"></div>
                    </div >
            `;
            }

            return `
            < div onclick = "${clickAction}" class="relative group cursor-pointer flex flex-col p-6 rounded-[2rem] bg-[#161b22] border border-white/5 ${t.border} hover:bg-[#1a202c] transition-all duration-500 ${t.shadow} overflow-hidden min-h-[190px]" >

                    <!-- Ambient Light -->
                    <div class="absolute -top-20 -right-20 w-48 h-48 rounded-full ${t.bg} blur-[60px] opacity-20 group-hover:opacity-40 transition-opacity duration-700 pointer-events-none"></div>
                    
                    <!--Header -->
                    <div class="flex justify-between items-start relative z-10 mb-4">
                        <div class="w-12 h-12 rounded-2xl ${t.iconBg} flex items-center justify-center ${t.text} border border-white/5 shadow-inner transition-transform duration-500 group-hover:scale-110 group-hover:rotate-6">
                            <i data-lucide="${icon}" class="w-6 h-6"></i>
                        </div>
                        <div class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/5 transition-colors text-slate-600 hover:text-white group/btn">
                             <i data-lucide="arrow-up-right" class="w-4 h-4 transition-transform group-hover/btn:translate-x-0.5 group-hover/btn:-translate-y-0.5"></i>
                        </div>
                    </div>

                    <!--Body -->
                    <div class="relative z-10">
                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-1 group-hover:text-slate-400 transition ml-1">${name}</p>
                        <h3 class="text-3xl font-black text-white tracking-tighter maskable filter drop-shadow-md leading-none">${formatCurrency(amount)}</h3>
                    </div>

                    <!--Footer / Progress-- >
                    <div class="relative z-10 mt-auto">
                        ${progressBlock}
                    </div>

                    <!--Botton Active Line-- >
            <div class="absolute bottom-0 left-0 w-full h-[2px] bg-gradient-to-r ${t.bar} opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                </div >
            `;
        }

        function _deprecated_renderSavingsTab() {
            initSavingsData();
            if (!appState.assetMeta) appState.assetMeta = {};

            // 1. Calculate Totals (Hidden logic for net worth badge logic)
            // ... (keeping existing calculations if needed elsewhere, but focus on grid)
            let totalAssets = 0;
            totalAssets += (appState.balanceAccounts.pocket || 0);
            totalAssets += (appState.balanceAccounts.bank || 0);
            totalAssets += (appState.balanceAccounts.loan || 0);
            appState.customAssets.forEach(a => totalAssets += a.amount);
            let totalGoals = 0;
            appState.goals.forEach(g => totalGoals += g.current);
            const GRAND_TOTAL = totalAssets + totalGoals;

            // Update Badge
            // 3. Update Net Worth Badge and Header
            const totalDebt = (appState.debts || []).reduce((acc, d) => acc + (d.total - d.current_paid), 0);
            const netWorth = GRAND_TOTAL - totalDebt;
            const nwEl = document.getElementById('savings-net-worth');
            if (nwEl) nwEl.innerText = formatCurrency(netWorth);

            // New Header Element
            const nwHeaderEl = document.getElementById('savings-net-worth-header');
            if (nwHeaderEl) nwHeaderEl.innerText = formatCurrency(netWorth);

            // 4. Render Debt List (Preserved)
            const debtListEl = document.getElementById('savings-debt-list');
            if (debtListEl) {
                if (!appState.debts || appState.debts.length === 0) {
                    debtListEl.innerHTML = `< div class="text-center text-slate-500 py-4 text-xs" > Sin deudas registradas</div > `;
                } else {
                    debtListEl.innerHTML = appState.debts.map(d => {
                        const remaining = d.total - d.current_paid;
                        const pct = Math.min(100, Math.round((d.current_paid / d.total) * 100));
                        return `
            < div onclick = "manageDebtItem(${d.id})" class="bg-dark-800 rounded-2xl p-4 border border-white/5 relative overflow-hidden group cursor-pointer hover:border-white/10 transition" >
                             <div class="flex justify-between items-center mb-2 relative z-10">
                                 <div class="flex items-center gap-3">
                                     <div class="w-10 h-10 rounded-full bg-red-500/10 flex items-center justify-center text-red-500">
                                         <i data-lucide="${d.icon || 'credit-card'}" class="w-5 h-5"></i>
                                     </div>
                                     <div>
                                         <p class="text-white font-bold text-sm">${d.name}</p>
                                         <p class="text-xs text-slate-500 uppercase tracking-wider font-bold">Deuda</p>
                                     </div>
                                 </div>
                                 <div class="text-right">
                                     <p class="text-white font-bold">${formatCurrency(remaining)}</p>
                                     <p class="text-xs text-slate-500">Restante</p>
                                 </div>
                             </div>
                             <!--Bar -->
            <div class="w-full h-1.5 bg-dark-900 rounded-full overflow-hidden mt-2">
                <div class="h-full bg-red-500 w-0 transition-all duration-1000 group-hover:bg-red-400" style="width: ${pct}%"></div>
            </div>
                         </div >
            `;
                    }).join('');
                }
            }

            // 5. UNIFIED GRID RENDER
            const gridEl = document.getElementById('savings-goals-grid');
            if (gridEl) {
                let itemsHtml = '';

                // A. Core Assets
                const coreDefaults = [
                    { key: 'pocket', name: 'Efectivo', icon: 'wallet', theme: 'emerald' },
                    { key: 'bank', name: 'Banco', icon: 'landmark', theme: 'blue' },
                    { key: 'loan', name: 'Ahorro', icon: 'piggy-bank', theme: 'indigo' }
                ];

                coreDefaults.forEach(core => {
                    const amt = appState.balanceAccounts[core.key] || 0;
                    const meta = appState.assetMeta[core.key] || {};
                    const displayName = meta.name || core.name;
                    const displayIcon = meta.icon || core.icon;
                    const target = meta.target || 0;

                    itemsHtml += createSavingsCard({
                        id: core.key,
                        type: 'core',
                        name: displayName,
                        amount: amt,
                        target: target,
                        icon: displayIcon,
                        colorTheme: core.theme, // Explicit Theme
                        originalIdx: core.key
                    });
                });

                // B. Custom Assets
                appState.customAssets.forEach((asset, idx) => {
                    itemsHtml += createSavingsCard({
                        id: 'custom-' + idx, // itemsHtml ID not strictly used for click
                        type: 'custom',
                        name: asset.name,
                        amount: asset.amount,
                        target: asset.target || 0,
                        icon: asset.icon || 'archive',
                        colorTheme: 'pink', // Assets are cold/neutral
                        originalIdx: idx
                    });
                });

                // C. Goals (Now integrated as Cards!)
                appState.goals.forEach((goal, idx) => {
                    // Heuristic for Goal Themes
                    let theme = 'violet';
                    if (goal.icon === 'car' || goal.name.toLowerCase().includes('car')) theme = 'cyan';
                    if (goal.icon === 'plane' || goal.name.toLowerCase().includes('viaje')) theme = 'amber';

                    itemsHtml += createSavingsCard({
                        id: goal.id,
                        type: 'goal',
                        name: goal.name,
                        amount: goal.current,
                        target: goal.target,
                        icon: goal.icon || 'flag',
                        colorTheme: theme,
                        originalIdx: idx
                    });
                });

                // D. "Add New" Action Button
                itemsHtml += `
            < button onclick = "addSavingsAsset()" class="flex flex-col items-center justify-center p-6 rounded-[2rem] bg-[#161b22] border border-white/5 border-dashed hover:bg-[#1a202c] hover:border-emerald-500/50 hover:shadow-[0_0_30px_rgba(16,185,129,0.1)] transition-all duration-500 gap-4 group min-h-[190px] relative overflow-hidden" >
                    <div class="absolute inset-0 bg-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <div class="w-16 h-16 rounded-2xl bg-white/5 flex items-center justify-center group-hover:bg-emerald-500/20 group-hover:text-emerald-400 text-slate-500 transition-all duration-500 group-hover:scale-110 shadow-inner group-hover:rotate-3 relative z-10">
                        <i data-lucide="plus" class="w-8 h-8"></i>
                    </div>
                    <span class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500 group-hover:text-emerald-400 transition-colors relative z-10">Nuevo Activo</span>
                 </button >
            `;

                gridEl.innerHTML = itemsHtml;
                lucide.createIcons();
            }
        }

        function renderSavingsCharts(currentNetWorth, currentTotalDebt) {
            // General Options
            const commonOptions = {
                chart: { background: 'transparent', toolbar: { show: false }, zoom: { enabled: false }, foreColor: '#94a3b8' },
                theme: { mode: 'dark' },
                grid: { borderColor: '#334155', strokeDashArray: 4, xaxis: { lines: { show: false } } },
                dataLabels: { enabled: false },
                stroke: { curve: 'smooth', width: 2 },
                xaxis: { labels: { style: { fontSize: '10px' } }, categories: ['2025', '2026', '2027', '2028', '2029', '2030'] },
                yaxis: { labels: { style: { fontSize: '10px' }, formatter: (val) => '$' + (val / 1000).toFixed(0) + 'k' } },
                legend: { position: 'top', horizontalAlign: 'right', fontSize: '11px' }
            };

            // 0. Mini Sparkline (Header)
            if (document.querySelector("#chart-mini-sparkline")) {
                new ApexCharts(document.querySelector("#chart-mini-sparkline"), {
                    series: [{ name: 'Net Worth', data: [currentNetWorth * 0.8, currentNetWorth * 0.85, currentNetWorth * 0.9, currentNetWorth * 0.95, currentNetWorth] }],
                    chart: { type: 'area', height: 96, sparkline: { enabled: true } },
                    stroke: { curve: 'smooth', width: 2 },
                    fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.05, stops: [0, 100] } },
                    colors: ['#6366f1'],
                    tooltip: { fixed: { enabled: false }, x: { show: false }, y: { title: { formatter: () => '' } }, marker: { show: false } }
                }).render();
            }

            // 1. "Snowball" (Net Worth vs Assets vs Debt) - Area
            if (document.querySelector("#chart-proj-snowball")) {
                new ApexCharts(document.querySelector("#chart-proj-snowball"), {
                    ...commonOptions,
                    chart: { type: 'area', height: 250, toolbar: { show: false } }, // Ensure HEIGHT is set!
                    series: [
                        { name: 'Net Worth', data: [10000, 25000, 45000, 70000, 105000, 150000] },
                        { name: 'Total Assets', data: [25000, 35000, 50000, 72000, 106000, 150000] },
                        { name: 'Total Debt', data: [15000, 10000, 5000, 2000, 1000, 0] }
                    ],
                    colors: ['#8b5cf6', '#10b981', '#ef4444'],
                    fill: { type: 'gradient', gradient: { opacityFrom: 0.4, opacityTo: 0.1 } }
                }).render();
            }

            // 2. Retirement Glidepath (Growth Rates) - Line
            if (document.querySelector("#chart-proj-retirement")) {
                new ApexCharts(document.querySelector("#chart-proj-retirement"), {
                    ...commonOptions,
                    chart: { type: 'line', height: 250, toolbar: { show: false } },
                    series: [
                        { name: 'Aggressive', data: [10000, 30000, 60000, 100000, 160000, 250000] },
                        { name: 'Balanced', data: [10000, 22000, 38000, 58000, 82000, 115000] },
                        { name: 'Conservative', data: [10000, 15000, 21000, 28000, 36000, 45000] }
                    ],
                    colors: ['#ec4899', '#f59e0b', '#3b82f6'],
                    stroke: { width: 3, dashArray: [0, 0, 5] } // Dash conservative
                }).render();
            }

            // 3. Lifestyle Scenarios - Area
            if (document.querySelector("#chart-proj-lifestyle")) {
                new ApexCharts(document.querySelector("#chart-proj-lifestyle"), {
                    ...commonOptions,
                    chart: { type: 'area', height: 250, toolbar: { show: false } },
                    series: [
                        { name: 'Luxury', data: [5000, 5500, 6200, 7000, 8500, 10000] },
                        { name: 'Comfort', data: [3500, 3700, 4000, 4200, 4500, 4800] },
                        { name: 'Lean', data: [2000, 2100, 2200, 2300, 2400, 2500] }
                    ],
                    colors: ['#a855f7', '#6366f1', '#94a3b8'],
                    yaxis: { labels: { formatter: (val) => '$' + val } }, // No 'k' for monthly
                    xaxis: { categories: ['Y1', 'Y2', 'Y3', 'Y4', 'Y5', 'Y6'] }
                }).render();
            }

            // 4. Debt Strategy - Bar
            if (document.querySelector("#chart-proj-debt-strategy")) {
                new ApexCharts(document.querySelector("#chart-proj-debt-strategy"), {
                    ...commonOptions,
                    chart: { type: 'bar', height: 250, toolbar: { show: false } },
                    series: [
                        { name: 'Min Pay', data: [15000, 13500, 12000, 10500, 9000] },
                        { name: '+ $100', data: [15000, 11000, 7000, 3000, 0] },
                        { name: '+ $500', data: [15000, 8000, 1000, 0, 0] }
                    ],
                    colors: ['#cbd5e1', '#60a5fa', '#3b82f6'],
                    xaxis: { categories: ['Year 1', 'Year 2', 'Year 3', 'Year 4', 'Year 5'] },
                    stroke: { width: 0 }
                }).render();
            }
        }

        function addDebtItem() {
            Swal.fire({
                title: 'Nuevo Pasivo',
                background: '#1e293b',
                color: '#fff',
                html: `
            < div >
                         <label class="block text-left text-xs mb-1 text-slate-400">Nombre del Pasivo</label>
                         <input id="swal-debt-name" class="swal2-input bg-dark-900 border-white/10 text-white placeholder-slate-600" placeholder="Ej. Préstamo Auto">
                    </div>
                    <div class="mt-4">
                         <label class="block text-left text-xs mb-1 text-slate-400">Deuda Total ($)</label>
                         <input id="swal-debt-total" type="number" class="swal2-input bg-dark-900 border-white/10 text-white placeholder-slate-600" placeholder="0.00">
                    </div>
                    <div class="mt-4">
                         <label class="block text-left text-xs mb-1 text-slate-400">Ya Pagado / Abonado ($)</label>
                         <input id="swal-debt-paid" type="number" class="swal2-input bg-dark-900 border-white/10 text-white placeholder-slate-600" placeholder="0.00">
                    </div>
        `,
                confirmButtonText: 'Crear Pasivo',
                confirmButtonColor: '#ef4444',
                focusConfirm: false,
                preConfirm: () => {
                    return [
                        document.getElementById('swal-debt-name').value,
                        document.getElementById('swal-debt-total').value,
                        document.getElementById('swal-debt-paid').value
                    ]
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const [name, total, paid] = result.value;
                    if (name && total) {
                        appState.debts.push({
                            id: Date.now(),
                            name: name,
                            total: parseFloat(total),
                            current_paid: parseFloat(paid) || 0
                        });
                        saveState();
                        renderSavingsTab();
                        Swal.fire({ icon: 'success', title: 'Added', toast: true, position: 'top', timer: 1500, showConfirmButton: false, background: '#1E293B', color: '#fff' });
                    }
                }
            });
        }

        function manageDebtItem(id) {

            // UNIVERSAL HISTORY FIX (DEBTS)
            const dFix = appState.debts.find(d => d.id === id);
            if (dFix && dFix.current_paid > 0 && (!dFix.history || dFix.history.length === 0)) {
                if (!dFix.history) dFix.history = [];
                dFix.history.push({
                    date: new Date().toISOString(),
                    amount: dFix.current_paid,
                    description: 'Abono Inicial'
                });
                saveState();
            }

            const debt = appState.debts.find(d => d.id === id);
            if (!debt) return;

            const remaining = Math.max(0, debt.total - debt.current_paid);
            const pct = Math.min(100, Math.round((debt.current_paid / debt.total) * 100));

            const interest = debt.interest_rate || '';
            const monthly = debt.monthly_payment || '';

            Swal.fire({
                title: ' ',
                background: '#0B0D14',
                color: '#fff',
                scrollbarPadding: false,
                html: `
            < !--HEADER -->
                    <div class="flex flex-col items-center gap-1 -mt-6 mb-6">
                        <div onclick="event.stopPropagation(); selectDebtIcon(${id})" class="w-16 h-16 rounded-2xl bg-gradient-to-br from-red-500/20 to-orange-500/20 flex items-center justify-center mb-3 border border-red-500/30 shadow-[0_0_30px_rgba(239,68,68,0.3)] cursor-pointer hover:scale-105 transition group">
                            <i data-lucide="${debt.icon || 'zap'}" class="w-8 h-8 text-red-500 group-hover:animate-pulse"></i>
                            <div class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-2xl opacity-0 group-hover:opacity-100 transition">
                                <i data-lucide="edit-2" class="w-4 h-4 text-white"></i>
                            </div>
                        </div>
                        <h2 class="text-3xl font-black text-white tracking-tight leading-none">${debt.name}</h2>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-[0.2em]">Gestión de Pasivos</p>
                    </div>

                    <div class="text-left space-y-6">
                        
                        <!-- MAIN STATUS CARD -->
                        <div class="p-6 bg-[#141724] rounded-3xl border border-white/5 relative overflow-hidden group shadow-2xl">
                             <div class="absolute top-0 right-0 w-40 h-40 bg-gradient-to-bl from-red-500/10 to-transparent rounded-bl-full -mr-10 -mt-10 pointer-events-none"></div>
                            
                            <div class="flex justify-between items-end mb-5 relative z-10">
                                <div>
                                    <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mb-1.5 flex items-center gap-1">
                                        <span class="w-1.5 h-1.5 rounded-full bg-red-500"></span> Restante
                                    </p>
                                    <h3 class="text-4xl font-black text-white tracking-tight">${formatCurrency(remaining)}</h3>
                                </div>
                                <div class="text-right">
                                    <div class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-emerald-500/10 border border-emerald-500/20 mb-1">
                                        <i data-lucide="check-circle-2" class="w-3 h-3 text-emerald-400"></i>
                                        <span class="text-emerald-400 text-[10px] font-black uppercase tracking-wide">${pct}% LISTO</span>
                                    </div>
                                    <p class="text-[10px] text-slate-500 font-bold">de ${formatCurrency(debt.total)}</p>
                                </div>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="w-full h-3 bg-black/40 rounded-full overflow-hidden border border-white/5 relative z-10">
                                <div class="h-full bg-gradient-to-r from-red-600 via-red-500 to-orange-500 transition-all duration-1000 shadow-[0_0_20px_rgba(239,68,68,0.4)] relative" style="width: ${pct}%">
                                    <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
                                </div>
                            </div>
                        </div>

                        <!-- QUICK PAYMENT SECTION -->
                        <div class="bg-[#141724] p-5 rounded-3xl border border-white/5 shadow-lg">
                             <div class="flex justify-between items-center mb-3">
                                 <label class="block text-[10px] font-black text-indigo-400 uppercase tracking-widest flex items-center gap-2">
                                    <i data-lucide="plus" class="w-3.5 h-3.5"></i> Nuevo Abono
                                 </label>
                                 <button onclick="viewDebtHistory(${id})" class="text-[10px] font-bold text-slate-500 hover:text-white transition uppercase tracking-wider flex items-center gap-1 px-2 py-1 hover:bg-white/5 rounded-lg">
                                    <i data-lucide="history" class="w-3 h-3"></i> Historial
                                 </button>
                             </div>
                             <div class="flex gap-3">
                                <div class="relative flex-1 group">
                                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                        <span class="text-slate-500 font-bold">$</span>
                                    </div>
                                    <input id="swal-manage-payment" type="number" class="w-full bg-[#0B0D14] border border-white/10 rounded-xl pl-8 pr-4 py-3 text-white font-bold focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition placeholder-slate-700" placeholder="0.00">
                                </div>
                                <button onclick="updateDebtPayment(${id})" class="bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-2 rounded-xl font-black text-xs uppercase tracking-wider transition shadow-[0_4px_20px_-5px_rgba(79,70,229,0.5)] transform hover:scale-[1.02] active:scale-95 flex items-center gap-2">
                                    Abonar
                                </button>
                             </div>
                        </div>

                        <!-- SETTINGS / DETAILS -->
                        <div class="space-y-4 pt-2">
                             <div class="flex items-center gap-3 px-1 opacity-60">
                                <div class="h-px flex-1 bg-gradient-to-r from-transparent via-slate-600 to-transparent"></div>
                                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-[0.2em] flex items-center gap-2"><i data-lucide="sliders" class="w-3 h-3"></i> Configuración</span>
                                <div class="h-px flex-1 bg-gradient-to-r from-transparent via-slate-600 to-transparent"></div>
                             </div>
                             
                             <div class="grid grid-cols-2 gap-4">
                                <!-- Name -->
                                <div class="col-span-2 group">
                                    <label class="text-[9px] text-slate-500 font-bold uppercase mb-1.5 block pl-1">Nombre</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i data-lucide="tag" class="w-3.5 h-3.5 text-slate-600 group-hover:text-slate-400 transition"></i>
                                        </div>
                                        <input id="swal-manage-name" value="${debt.name}" class="w-full bg-[#141724] border border-white/5 hover:border-white/10 rounded-xl pl-9 pr-3 py-2.5 text-slate-200 text-xs font-bold focus:border-red-500 focus:ring-1 focus:ring-red-500/20 focus:bg-[#0B0D14] focus:outline-none transition">
                                    </div>
                                </div>
                                
                                <!-- Total -->
                                <div class="group">
                                    <label class="text-[9px] text-slate-500 font-bold uppercase mb-1.5 block pl-1">Total Deuda</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i data-lucide="dollar-sign" class="w-3.5 h-3.5 text-slate-600 group-hover:text-slate-400 transition"></i>
                                        </div>
                                        <input id="swal-manage-total" type="number" value="${debt.total}" class="w-full bg-[#141724] border border-white/5 hover:border-white/10 rounded-xl pl-9 pr-3 py-2.5 text-slate-200 text-xs font-bold focus:border-red-500 focus:ring-1 focus:ring-red-500/20 focus:bg-[#0B0D14] focus:outline-none transition">
                                    </div>
                                </div>
                                
                                <!-- Interest -->
                                <div class="group">
                                    <label class="text-[9px] text-slate-500 font-bold uppercase mb-1.5 block pl-1">Interés (%)</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i data-lucide="percent" class="w-3.5 h-3.5 text-slate-600 group-hover:text-slate-400 transition"></i>
                                        </div>
                                        <input id="swal-manage-interest" type="number" value="${interest}" placeholder="0" class="w-full bg-[#141724] border border-white/5 hover:border-white/10 rounded-xl pl-9 pr-3 py-2.5 text-slate-200 text-xs font-bold focus:border-red-500 focus:ring-1 focus:ring-red-500/20 focus:bg-[#0B0D14] focus:outline-none transition">
                                    </div>
                                </div>

                                <!-- Monthly Payment -->
                                <div class="group">
                                    <label class="text-[9px] text-slate-500 font-bold uppercase mb-1.5 block pl-1">Cuota Mensual</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i data-lucide="calendar-clock" class="w-3.5 h-3.5 text-slate-600 group-hover:text-slate-400 transition"></i>
                                        </div>
                                        <input id="swal-manage-monthly" type="number" value="${monthly}" placeholder="0.00" class="w-full bg-[#141724] border border-white/5 hover:border-white/10 rounded-xl pl-9 pr-3 py-2.5 text-slate-200 text-xs font-bold focus:border-red-500 focus:ring-1 focus:ring-red-500/20 focus:bg-[#0B0D14] focus:outline-none transition">
                                    </div>
                                </div>

                                <!-- Next Payment Date -->
                                <div class="group">
                                     <label class="text-[9px] text-slate-500 font-bold uppercase mb-1.5 block pl-1">Próximo Pago</label>
                                     <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i data-lucide="calendar-days" class="w-3.5 h-3.5 text-slate-600 group-hover:text-slate-400 transition"></i>
                                        </div>
                                        <input id="swal-manage-date" type="date" class="w-full bg-[#141724] border border-white/5 hover:border-white/10 rounded-xl pl-9 pr-3 py-2.5 text-slate-300 text-xs font-bold focus:border-red-500 focus:ring-1 focus:ring-red-500/20 focus:bg-[#0B0D14] focus:outline-none transition" style="color-scheme: dark;">
                                     </div>
                                </div>
                             </div>
                        </div>

                    </div>
        `,
                showConfirmButton: true,
                confirmButtonText: 'Guardar',
                confirmButtonColor: '#10b981',
                showDenyButton: true,
                denyButtonText: 'Eliminar',
                denyButtonColor: '#ef4444',
                showCancelButton: true,
                cancelButtonText: 'Cerrar',
                cancelButtonColor: '#334155',
                width: '500px',
                padding: '2rem 1rem 2rem 1rem',
                customClass: {
                    popup: 'rounded-[2.5rem] border border-white/10 shadow-2xl overflow-hidden glass-panel',
                    actions: 'gap-3'
                },
                didOpen: () => {
                    lucide.createIcons();
                },
                preConfirm: () => {
                    return {
                        name: document.getElementById('swal-manage-name').value,
                        total: document.getElementById('swal-manage-total').value,
                        interest: document.getElementById('swal-manage-interest').value,
                        monthly: document.getElementById('swal-manage-monthly').value
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // Update Details
                    const data = result.value;
                    if (data.name && data.total) {
                        debt.name = data.name;
                        debt.total = parseFloat(data.total);
                        debt.interest_rate = parseFloat(data.interest) || 0;
                        debt.monthly_payment = parseFloat(data.monthly) || 0;

                        saveState();
                        renderSavingsTab();
                        Swal.fire({ icon: 'success', title: 'Actualizado', background: '#0f172a', color: '#fff', timer: 1500, showConfirmButton: false });
                    }
                } else if (result.isDenied) {
                    // Delete
                    deleteDebtItem(id);
                }
            });

            // Helper for simple payment
            window.updateDebtPayment = (debtId) => {
                const amount = parseFloat(document.getElementById('swal-manage-payment').value);
                if (amount && amount > 0) {
                    const d = appState.debts.find(x => x.id === debtId);
                    if (d) {
                        d.current_paid += amount;
                        if (d.current_paid > d.total) d.current_paid = d.total;

                        if (!d.history) d.history = [];
                        d.history.push({
                            date: new Date().toISOString(),
                            amount: amount
                        });

                        saveState();
                        renderSavingsTab();
                        Swal.close();
                        Swal.fire({ icon: 'success', title: 'Pago Registrado!', text: `Nuevo balance: ${formatCurrency(d.total - d.current_paid)} `, background: '#0f172a', color: '#fff', timer: 2000, showConfirmButton: false });
                    }
                }
            };

            // Helper to view history
            window.viewDebtHistory = (debtId) => {
                const debt = appState.debts.find(d => d.id === debtId);
                if (!debt) return;

                const history = debt.history || [];
                let historyHtml = '';

                if (history.length === 0) {
                    historyHtml = `
            < div class="flex flex-col items-center justify-center py-8 opacity-50" >
                            <i data-lucide="clock" class="w-12 h-12 mb-2 text-slate-500"></i>
                            <p class="text-slate-400 text-sm font-bold">No hay abonos registrados.</p>
                        </div >
            `;
                } else {
                    historyHtml = '<div class="max-h-[300px] overflow-y-auto space-y-2 pr-2 custom-scrollbar">';
                    // Map with index
                    const sortedHistory = history.map((h, i) => ({ ...h, idx: i })).reverse();

                    sortedHistory.forEach((h) => {
                        const d = new Date(h.date);
                        const dateStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                        historyHtml += `
            < div onclick = "event.stopPropagation(); editDebtHistoryItem(${debtId}, ${h.idx})" class="flex justify-between items-center p-3 rounded-xl bg-white/5 border border-white/5 hover:border-white/10 hover:bg-white/10 transition cursor-pointer group" >
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-emerald-500/10 flex items-center justify-center text-emerald-400 group-hover:scale-110 transition">
                                        <i data-lucide="edit-2" class="w-4 h-4 opacity-0 group-hover:opacity-100 absolute transition"></i>
                                        <i data-lucide="arrow-up-right" class="w-4 h-4 group-hover:opacity-0 transition"></i>
                                    </div>
                                    <div class="text-left">
                                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider group-hover:text-white transition">Abono</div>
                                        <div class="text-xs text-slate-500 font-medium group-hover:text-slate-300 transition">${dateStr}</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                     <span class="text-emerald-400 font-bold font-mono text-sm">+${formatCurrency(h.amount)}</span>
                                </div>
                            </div >
            `;
                    });
                    historyHtml += '</div>';
                }

                Swal.fire({
                    title: 'Historial de Abonos',
                    html: historyHtml,
                    background: '#0B0D14',
                    color: '#fff',
                    scrollbarPadding: false,
                    showConfirmButton: true,
                    confirmButtonText: 'Cerrar',
                    confirmButtonColor: '#334155',
                    width: '450px',
                    padding: '2rem',
                    customClass: {
                        popup: 'rounded-[2rem] border border-white/10 shadow-2xl glass-panel'
                    },
                    didOpen: () => {
                        lucide.createIcons();
                    }
                });
            };

            // NEW Helper to Edit History Item (PREMIUM REDESIGN)

            // ICON PICKER FOR DEBTS
            window.selectDebtIcon = (dId) => {
                const icons = ['credit-card', 'zap', 'alert-circle', 'dollar-sign', 'home', 'car', 'briefcase', 'graduation-cap', 'heart-pulse', 'shopping-bag', 'smartphone', 'wifi', 'tv', 'music', 'book'];
                Swal.fire({
                    title: 'Selecciona un Icono',
                    html: `
            < div class="grid grid-cols-5 gap-4 p-2" >
                ${icons.map(ic => `
                                <div onclick="window.confirmDebtIcon('${dId}', '${ic}')" class="w-10 h-10 rounded-xl bg-white/5 hover:bg-red-500/20 hover:text-red-400 flex items-center justify-center cursor-pointer transition">
                                    <i data-lucide="${ic}" class="w-5 h-5"></i>
                                </div>
                            `).join('')
                        }
                        </div >
            `,
                    background: '#1E293B', color: '#fff',
                    scrollbarPadding: false,
                    showConfirmButton: false,
                    didOpen: () => lucide.createIcons()
                });
            };

            window.confirmDebtIcon = (dId, iconName) => {
                const debt = appState.debts.find(d => d.id == dId);
                if (debt) {
                    debt.icon = iconName;
                    saveState();
                    renderSavingsTab();
                }
                Swal.close(); // Close icon picker
                manageDebtItem(parseInt(dId)); // Re-open management
            };

            window.editDebtHistoryItem = (debtId, idx) => {
                const debt = appState.debts.find(d => d.id === debtId);
                if (!debt || !debt.history[idx]) return;
                const item = debt.history[idx];

                const dateObj = new Date(item.date);
                const dateYMD = dateObj.toISOString().split('T')[0];
                const h = String(dateObj.getHours()).padStart(2, '0');
                const m = String(dateObj.getMinutes()).padStart(2, '0');

                Swal.fire({
                    title: ' ', // Custom Header
                    background: '#0B0D14',
                    color: '#fff',
                    scrollbarPadding: false,
                    html: `
            < !--HEADER -->
                        <div class="flex flex-col items-center gap-1 -mt-6 mb-6">
                            <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-500/20 to-purple-500/20 flex items-center justify-center mb-3 border border-indigo-500/30 shadow-[0_0_30px_rgba(99,102,241,0.3)]">
                                <i data-lucide="edit" class="w-8 h-8 text-indigo-400"></i>
                            </div>
                            <h2 class="text-2xl font-black text-white tracking-tight leading-none">Editar Abono</h2>
                            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-[0.2em]">Registro Histórico</p>
                        </div>

                        <div class="space-y-4 text-left px-2">
                             
                             <!-- Amount -->
                             <div class="group">
                                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Monto ($)</label>
                                <div class="relative">
                                     <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i data-lucide="dollar-sign" class="w-4 h-4 text-indigo-500"></i>
                                     </div>
                                    <input id="edit-hist-amount" type="number" value="${item.amount}" class="w-full bg-[#141724] border border-white/10 hover:border-indigo-500/50 rounded-xl pl-9 pr-4 py-3 text-white font-bold transition focus:outline-none focus:ring-1 focus:ring-indigo-500/50 focus:border-indigo-500">
                                </div>
                             </div>

                             <div class="grid grid-cols-2 gap-3">
                                 <!-- Date -->
                                 <div class="group">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Fecha</label>
                                    <div class="relative">
                                         <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i data-lucide="calendar" class="w-4 h-4 text-slate-500"></i>
                                         </div>
                                        <input id="edit-hist-date" type="date" value="${dateYMD}" class="w-full bg-[#141724] border border-white/10 hover:border-indigo-500/50 rounded-xl pl-9 pr-3 py-3 text-white font-bold transition focus:outline-none focus:ring-1 focus:ring-indigo-500/50 focus:border-indigo-500" style="color-scheme: dark;">
                                    </div>
                                 </div>
                                 
                                 <!-- Time -->
                                 <div class="group">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Hora</label>
                                    <div class="relative">
                                         <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i data-lucide="clock" class="w-4 h-4 text-slate-500"></i>
                                         </div>
                                        <input id="edit-hist-time" type="time" value="${h}:${m}" class="w-full bg-[#141724] border border-white/10 hover:border-indigo-500/50 rounded-xl pl-9 pr-3 py-3 text-white font-bold transition focus:outline-none focus:ring-1 focus:ring-indigo-500/50 focus:border-indigo-500" style="color-scheme: dark;">
                                    </div>
                                 </div>
                             </div>
                        </div>
        `,
                    showDenyButton: true,
                    denyButtonText: 'Eliminar',
                    denyButtonColor: '#ef4444',
                    confirmButtonText: 'Guardar Cambios',
                    confirmButtonColor: '#10b981',
                    showCancelButton: true,
                    cancelButtonText: 'Cancelar',
                    cancelButtonColor: '#334155',
                    width: '400px',
                    padding: '2rem',
                    customClass: {
                        popup: 'rounded-[2rem] border border-white/10 shadow-2xl glass-panel',
                        actions: 'gap-2 mt-6'
                    },
                    didOpen: () => lucide.createIcons(),
                }).then((r) => {
                    if (r.isConfirmed) {
                        // Save
                        const newAmt = parseFloat(document.getElementById('edit-hist-amount').value);
                        const newDate = document.getElementById('edit-hist-date').value;
                        const newTime = document.getElementById('edit-hist-time').value;

                        if (newAmt && newDate && newTime) {
                            const d = new Date(`${newDate}T${newTime} `);

                            const diff = newAmt - item.amount;

                            item.amount = newAmt;
                            item.date = d.toISOString();

                            debt.current_paid += diff;
                            // Cap? Not necessarily if input was manual, but logic says max total.
                            // if (debt.current_paid > debt.total) debt.current_paid = debt.total; 

                            saveState();
                            renderSavingsTab();
                            Swal.close();
                            viewDebtHistory(debtId);
                        }
                    } else if (r.isDenied) {
                        // Delete
                        debt.current_paid -= item.amount;
                        debt.history.splice(idx, 1);

                        saveState();
                        renderSavingsTab();
                        Swal.close();
                        viewDebtHistory(debtId);
                    }
                });
            };
        }

        function deleteDebtItem(id) {
            Swal.fire({
                title: '¿Eliminar Deuda?',
                text: "No podrás revertir esto.",
                icon: 'warning',
                background: '#0f172a',
                color: '#fff',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#334155',
                confirmButtonText: 'Sí, eliminar'
            }).then((result) => {
                if (result.isConfirmed) {
                    appState.debts = appState.debts.filter(d => d.id !== id);
                    saveState();
                    renderSavingsTab();
                    Swal.fire({ title: 'Eliminado', icon: 'success', background: '#0f172a', color: '#fff', timer: 1500, showConfirmButton: false });
                }
            });
        }

        function createAssetCard(name, amount, icon, isCustom, idx) {
            // idx is either the core 'key' (string) or custom index (number)
            // We wrap arguments in quotes correctly
            const typeArg = isCustom ? 'custom' : 'core';
            const idArg = isCustom ? idx : `'${idx}'`;

            return `
            < div onclick = "manageAsset('${typeArg}', ${idArg})" class="flex items-center justify-between p-4 rounded-2xl bg-dark-800 border border-white/5 hover:border-emerald-500/30 hover:bg-emerald-500/5 hover:shadow-[0_0_15px_-5px_rgba(16,185,129,0.3)] transition group cursor-pointer relative overflow-hidden" >
                <div class="flex items-center gap-4 relative z-10">
                    <div class="w-10 h-10 rounded-xl bg-dark-900 flex items-center justify-center text-slate-400 group-hover:text-emerald-400 transition shadow-inner border border-white/5 group-hover:border-emerald-500/20">
                        <i data-lucide="${icon}" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                    </div>
                    <div>
                        <p class="text-slate-400 text-xs font-bold uppercase tracking-wider group-hover:text-emerald-300 transition">${name}</p>
                        <p class="text-white font-bold text-lg leading-tight tracking-tight group-hover:text-white transition">${formatCurrency(amount)}</p>
                    </div>
                </div>
                 <div class="absolute right-0 top-1/2 -translate-y-1/2 p-4 text-slate-600 opacity-0 group-hover:opacity-20 transition transform group-hover:-translate-x-2">
                    <i data-lucide="settings-2" class="w-12 h-12"></i>
                 </div>
             </div >
            `;
        }

        function addSavingsAsset() {
            Swal.fire({
                title: ' ',
                background: '#0B0D14',
                color: '#fff',
                scrollbarPadding: false,
                html: `
            < !--Header -->
                    <div class="flex flex-col items-center mb-6 -mt-4">
                        <div class="w-16 h-16 rounded-full bg-emerald-500/10 flex items-center justify-center mb-3 ring-4 ring-emerald-500/5">
                            <i data-lucide="plus" class="w-8 h-8 text-emerald-500"></i>
                        </div>
                        <h2 class="text-2xl font-black text-white">Nuevo Activo</h2>
                        <p class="text-slate-500 text-xs font-medium">Incrementa tu patrimonio</p>
                    </div>

                    <div class="space-y-4 px-2">
                        <!-- Name Input -->
                        <div class="group text-left">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Nombre del Activo</label>
                            <div class="relative">
                                <span class="absolute left-4 top-3.5 text-slate-500">
                                    <i data-lucide="tag" class="w-4 h-4"></i>
                                </span>
                                <input id="swal-asset-name" class="w-full bg-[#141724] border border-white/10 rounded-xl py-3 pl-10 pr-4 text-white font-bold focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500/50 transition placeholder-slate-700" placeholder="Ej. Caja Fuerte, Inversión X">
                            </div>
                        </div>

                        <!-- Amount Input -->
                        <div class="group text-left">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Valor Inicial</label>
                            <div class="relative">
                                <span class="absolute left-4 top-3.5 text-emerald-500 font-bold">$</span>
                                <input id="swal-asset-amt" type="number" class="w-full bg-[#141724] border border-white/10 rounded-xl py-3 pl-10 pr-4 text-white font-bold focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500/50 transition placeholder-slate-700" placeholder="0.00">
                            </div>
                        </div>
                    </div>
        `,
                showCancelButton: true,
                confirmButtonText: 'Crear Activo',
                confirmButtonColor: '#10B981',
                cancelButtonText: 'Cancelar',
                cancelButtonColor: '#334155',
                width: '400px',
                padding: '2rem',
                customClass: {
                    popup: 'rounded-[2rem] border border-white/10 shadow-2xl glass-panel',
                    actions: 'gap-3 mt-6'
                },
                didOpen: () => lucide.createIcons(),
                preConfirm: () => {
                    const name = document.getElementById('swal-asset-name').value;
                    const amt = document.getElementById('swal-asset-amt').value;
                    if (!name || !amt) {
                        Swal.showValidationMessage('Por favor completa los campos');
                    }
                    return [name, amt];
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const [name, amt] = result.value;
                    if (name && amt) {
                        initSavingsData();
                        const amount = parseFloat(amt);
                        const newAsset = {
                            name: name,
                            amount: amount,
                            icon: 'archive',
                            history: [{ date: new Date().toISOString(), amount: amount }] // Log initial creation
                        };
                        appState.customAssets.push(newAsset);
                        saveState();
                        renderSavingsTab();
                        Swal.fire({ icon: 'success', title: 'Activo Creado', toast: true, position: 'top', timer: 1500, showConfirmButton: false, background: '#1E293B', color: '#fff' });
                    }
                }
            });
        }

        function deleteCustomAsset(idx) {
            Swal.fire({
                title: '¿Eliminar?', icon: 'warning', showCancelButton: true,
                confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'Sí',
                background: '#1E293B', color: '#fff'
            }).then((r) => {
                if (r.isConfirmed) {
                    appState.customAssets.splice(idx, 1);
                    saveState();
                    renderSavingsTab();
                }
            });
        }

        // --- ASSET MANAGEMENT ---
        // --- ASSET MANAGEMENT ---
        // --- ASSET MANAGEMENT ---
        // --- ASSET MANAGEMENT ---
        // --- ASSET MANAGEMENT ---
        function manageAsset(type, id) {

            // UNIVERSAL HISTORY FIX (ASSETS)
            // Ensure consistency between current amount and history
            if (type === 'custom') {
                const a = appState.customAssets[id];
                if (a && a.amount > 0 && (!a.history || a.history.length === 0)) {
                    if (!a.history) a.history = [];
                    a.history.push({
                        date: new Date().toISOString(),
                        amount: a.amount,
                        description: 'Balance Inicial'
                    });
                    saveState();
                }
            } else if (type === 'core') {
                if (!appState.assetMeta) appState.assetMeta = {};
                if (!appState.assetMeta[id]) appState.assetMeta[id] = {};

                const currentAmt = appState.balanceAccounts[id] || 0;
                const meta = appState.assetMeta[id];

                if (currentAmt > 0 && (!meta.history || meta.history.length === 0)) {
                    if (!meta.history) meta.history = [];
                    meta.history.push({
                        date: new Date().toISOString(),
                        amount: currentAmt,
                        description: 'Balance Inicial'
                    });
                    saveState();
                }
            }

            let name = '';
            let currentAmount = 0;
            let icon = '';
            let history = [];
            let target = 0; // New: Target support
            let metaRef = null;

            if (type === 'core') {
                currentAmount = appState.balanceAccounts[id] || 0;
                if (!appState.assetMeta) appState.assetMeta = {};
                metaRef = appState.assetMeta;

                if (!metaRef[id]) metaRef[id] = {};

                // Defaults
                const coreMap = {
                    'pocket': { name: 'Efectivo', icon: 'wallet' },
                    'bank': { name: 'Banco', icon: 'landmark' },
                    'loan': { name: 'Ahorro', icon: 'piggy-bank' }
                };
                const def = coreMap[id] || { name: 'Activo', icon: 'circle-dollar-sign' };

                name = metaRef[id].name || def.name;
                icon = metaRef[id].icon || def.icon;
                history = metaRef[id].history || [];
                target = metaRef[id].target || 0;
            } else {
                const asset = appState.customAssets[id];
                if (!asset) return;
                currentAmount = asset.amount;
                name = asset.name;
                icon = asset.icon || 'archive';
                history = asset.history || [];
                target = asset.target || 0;
            }

            // Calculate Progress if target exists
            let statusCardHtml = '';
            if (target > 0) {
                const pct = Math.min(100, Math.round((currentAmount / target) * 100));
                statusCardHtml = `
            < p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mb-2" > Progreso Actual</p >
                    <h3 class="text-5xl font-black text-white tracking-tighter drop-shadow-lg maskable">${formatCurrency(currentAmount)}</h3>
                    <p class="text-xs text-emerald-400 font-bold mt-1">de <span class="maskable">${formatCurrency(target)}</span></p>
                    
                    <!--Progress Bar-- >
                    <div class="w-3/4 mx-auto h-2 bg-black/40 rounded-full overflow-hidden border border-white/5 mt-4 relative">
                        <div class="h-full bg-gradient-to-r from-emerald-500 to-teal-500 transition-all duration-1000 shadow-[0_0_10px_rgba(16,185,129,0.5)]" style="width: ${pct}%"></div>
                    </div>
                    <p class="text-[9px] text-slate-500 mt-2 font-mono">${pct}% Completado</p>
        `;
            } else {
                statusCardHtml = `
            < p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mb-2" > Total Acumulado</p >
                <h3 class="text-5xl font-black text-white tracking-tighter drop-shadow-lg maskable">${formatCurrency(currentAmount)}</h3>
        `;
            }

            // 2. Render Modal
            Swal.fire({
                title: ' ',
                background: '#0B0D14',
                color: '#fff',
                scrollbarPadding: false,
                html: `
            < div class="grid grid-cols-1 md:grid-cols-12 gap-8 text-left pb-4" >
        
        < !--LEFT COLUMN: VISUAL IDENTITY & ACTIONS(5 cols)-- >
        <div class="md:col-span-5 flex flex-col gap-6 border-r border-white/5 pr-6">
            
            <!-- HEADER -->
            <div class="flex flex-col items-center gap-2 text-center pb-4 border-b border-white/5">
                <div onclick="event.stopPropagation(); selectAssetIcon('${type}', '${id}')" class="w-20 h-20 rounded-3xl bg-gradient-to-br from-emerald-500/20 to-teal-500/20 flex items-center justify-center mb-2 border border-emerald-500/30 shadow-[0_0_40px_rgba(16,185,129,0.3)] cursor-pointer hover:scale-105 transition group relative">
                     <i data-lucide="${icon}" class="w-10 h-10 text-emerald-500 group-hover:animate-pulse"></i>
                     <div class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-3xl opacity-0 group-hover:opacity-100 transition">
                        <i data-lucide="edit-2" class="w-5 h-5 text-white"></i>
                     </div>
                </div>
                <h2 class="text-3xl font-black text-white tracking-tight leading-none">${name}</h2>
                <div class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-lg bg-white/5 border border-white/5 mt-1">
                     <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                     <span class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Activo Patrimonial</span>
                </div>
            </div>

            <!-- STATUS CARD -->
            <div class="p-5 bg-gradient-to-br from-[#141724] to-[#0B0D14] rounded-2xl border border-white/10 relative overflow-hidden shadow-xl">
                 <div class="absolute top-0 right-0 w-32 h-32 bg-emerald-500/10 rounded-bl-full -mr-8 -mt-8 pointer-events-none blur-2xl"></div>
                 ${statusCardHtml} <!-- This contains the big number and progress bar -->
            </div>

            <!-- QUICK ACTIONS -->
            <div class="grid grid-cols-2 gap-3">
                 <button onclick="handleAssetTransaction('${type}', '${id}', 'deposit')" class="col-span-1 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white font-black text-xs uppercase tracking-wider transition shadow-lg shadow-emerald-500/20 flex flex-col items-center justify-center gap-1 active:scale-95 group">
                     <i data-lucide="plus" class="w-5 h-5 group-hover:scale-110 transition"></i>
                     Abonar
                 </button>
                 <button onclick="handleAssetTransaction('${type}', '${id}', 'withdraw')" class="col-span-1 py-3 rounded-xl bg-slate-800 hover:bg-red-500/20 hover:text-red-400 border border-white/5 hover:border-red-500/30 text-slate-400 font-bold text-xs uppercase tracking-wider transition flex flex-col items-center justify-center gap-1 active:scale-95">
                     <i data-lucide="minus" class="w-5 h-5"></i>
                     Retirar
                 </button>
            </div>

        </div>

        <!--RIGHT COLUMN: MANAGEMENT & DATA(7 cols)-- >
            <div class="md:col-span-7 flex flex-col gap-5 pt-1">

                <!-- SECTION TABS/TITLE -->
                <div class="flex items-center gap-3 pb-2 border-b border-white/5 opacity-60">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] flex items-center gap-2"><i data-lucide="sliders" class="w-3 h-3"></i> Panel de Control</span>
                </div>

                <!-- CONFIGURATION GRID -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="group col-span-2">
                        <label class="text-[9px] text-slate-500 font-bold uppercase mb-1.5 block pl-1">Nombre</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="tag" class="w-3.5 h-3.5 text-slate-600"></i></div>
                            <input id="edit-asset-name-inp" value="${name}" class="w-full bg-[#141724] border border-white/5 rounded-xl pl-9 pr-3 py-2.5 text-slate-200 text-xs font-bold focus:border-emerald-500 focus:outline-none transition">
                        </div>
                    </div>
                    <div class="group col-span-2">
                        <label class="text-[9px] text-slate-500 font-bold uppercase mb-1.5 block pl-1">Meta Financiera (Target)</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="target" class="w-3.5 h-3.5 text-slate-600"></i></div>
                            <input id="edit-asset-target-inp" type="number" value="${target || ''}" placeholder="Sin objetivo" class="w-full bg-[#141724] border border-white/5 rounded-xl pl-9 pr-3 py-2.5 text-slate-200 text-xs font-bold focus:border-emerald-500 focus:outline-none transition">
                        </div>
                    </div>
                </div>

                <!-- PROJECTION MINI -->
                <div class="bg-[#141724] p-4 rounded-2xl border border-white/5 flex gap-3 items-center">
                    <div class="p-2 bg-indigo-500/10 rounded-lg shrink-0"><i data-lucide="calculator" class="w-5 h-5 text-indigo-400"></i></div>
                    <div class="flex-1 grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[9px] text-slate-500 font-bold uppercase block mb-1">Abono Mensual</label>
                            <input id="proj-monthly" type="number" placeholder="0" class="w-full bg-[#0B0D14] border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs font-bold focus:border-indigo-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="text-[9px] text-slate-500 font-bold uppercase block mb-1">Meses</label>
                            <input id="proj-months" type="number" placeholder="12" value="12" class="w-full bg-[#0B0D14] border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs font-bold focus:border-indigo-500 focus:outline-none">
                        </div>
                    </div>
                    <button onclick="calculateProjection(${currentAmount})" class="h-10 w-10 bg-indigo-600 hover:bg-indigo-500 rounded-xl flex items-center justify-center text-white transition shadow-lg"><i data-lucide="arrow-right" class="w-4 h-4"></i></button>
                </div>
                <div id="proj-result" class="hidden p-2 bg-indigo-500/10 rounded-xl text-center border border-indigo-500/20"><span class="text-xs text-indigo-300 font-bold">Proyección: </span><span id="proj-val" class="text-lg font-black text-white ml-2">---</span></div>

                <!-- HISTORY LIST (Compact) -->
                <div class="flex-1 flex flex-col min-h-[150px]">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-[9px] font-bold text-slate-500 uppercase tracking-widest flex items-center gap-1"><i data-lucide="history" class="w-3 h-3"></i> Historial</span>
                    </div>
                    <div class="flex-1 max-h-[180px] overflow-y-auto custom-scrollbar bg-[#0f1116] rounded-xl border border-white/5 p-1 space-y-1">
                        ${history.length === 0 ? '<div class="h-full flex flex-col items-center justify-center opacity-40"><p class="text-[10px] text-slate-500 font-bold">Sin movimientos</p></div>' :
                        [...history].map((h, originalIdx) => ({ ...h, idx: originalIdx })).reverse().map(h => `
                         <div onclick="event.stopPropagation(); editAssetHistory('${type}', ${type === 'custom' ? id : `'${id}'`}, ${h.idx})" class="flex justify-between items-center p-2.5 rounded-lg bg-white/5 hover:bg-white/10 transition cursor-pointer group">
                             <div class="flex items-center gap-2.5">
                                 <div class="w-6 h-6 rounded-full ${h.amount >= 0 ? 'bg-emerald-500/10 text-emerald-500' : 'bg-red-500/10 text-red-500'} flex items-center justify-center">
                                     <i data-lucide="${h.amount >= 0 ? 'arrow-up-right' : 'arrow-down-left'}" class="w-3 h-3"></i>
                                 </div>
                                 <div class="flex flex-col">
                                     <span class="text-[9px] text-slate-300 font-bold uppercase truncate max-w-[100px]">${h.description || "Movimiento"}</span>
                                     <span class="text-[9px] text-slate-600 font-mono">${new Date(h.date).toLocaleDateString()}</span>
                                 </div>
                             </div>
                             <span class="text-[10px] font-bold font-mono ${h.amount >= 0 ? 'text-emerald-400' : 'text-red-400'} maskable">${h.amount >= 0 ? '+' : ''}${formatCurrency(h.amount)}</span>
                         </div>
                       `).join('')}
                    </div>
                </div>

            </div>
    </div >
            `,
                showConfirmButton: true,
                confirmButtonText: '<i class="fa fa-save"></i> Guardar Cambios',
                showDenyButton: true,
                denyButtonText: 'Eliminar',
                showCancelButton: true,
                cancelButtonText: 'Cerrar',
                buttonsStyling: false,
                width: '900px',
                padding: '0 0 2rem 0',
                customClass: {
                    popup: 'rounded-[2.5rem] border border-white/10 shadow-2xl overflow-hidden glass-panel',
                    htmlContainer: '!m-0 !p-0',
                    actions: 'w-full grid grid-cols-2 gap-3 px-8 pb-6',
                    confirmButton: 'col-span-2 bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-500 hover:to-emerald-400 text-white py-3.5 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg shadow-emerald-500/20 transition transform hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-2',
                    denyButton: 'bg-red-500/10 border border-red-500/20 hover:bg-red-500/20 text-red-500 py-3 rounded-xl font-bold text-[10px] uppercase tracking-wider transition flex items-center justify-center gap-2',
                    cancelButton: 'bg-slate-700/30 border border-white/5 hover:bg-slate-700/50 text-slate-400 hover:text-white py-3 rounded-xl font-bold text-[10px] uppercase tracking-wider transition'
                },
                didOpen: () => lucide.createIcons(),
                preConfirm: () => {
                    const newName = document.getElementById('edit-asset-name-inp').value;
                    const newTarget = parseFloat(document.getElementById('edit-asset-target-inp').value) || 0;
                    if (newName) {
                        if (type === 'core') {
                            if (!appState.assetMeta[id]) appState.assetMeta[id] = {};
                            appState.assetMeta[id].name = newName;
                            appState.assetMeta[id].target = newTarget;
                        } else {
                            appState.customAssets[id].name = newName;
                            appState.customAssets[id].target = newTarget;
                        }
                        saveState();
                        renderSavingsTab();
                    }
                }
            }).then((result) => {
                if (result.isDenied) {
                    // Delete functionality
                    if (type === 'core') {
                        Swal.fire({ title: 'No se pueden eliminar activos principales', icon: 'error', background: '#0B0D14', color: '#fff', confirmButtonColor: '#334155' });
                    } else {
                        Swal.fire({
                            title: '¿Eliminar?',
                            text: 'Se perderá este activo y su historial.',
                            icon: 'warning',
                            background: '#0B0D14', color: '#fff',
                            showCancelButton: true, confirmButtonColor: '#ef4444',
                            confirmButtonText: 'Eliminar'
                        }).then(r => {
                            if (r.isConfirmed) {
                                delete appState.customAssets[id];
                                saveState();
                                renderSavingsTab();
                            }
                        });
                    }
                } else if (result.dismiss === Swal.DismissReason.backdrop || result.dismiss === Swal.DismissReason.cancel) {
                    // Just close
                } else {
                    // Saved via preConfirm, trigger toast
                    Swal.fire({ icon: 'success', title: 'Guardado', toast: true, position: 'top', timer: 1500, showConfirmButton: false, background: '#1E293B', color: '#fff' });
                }
            });
        }

        function addSavingsGoal() {
            Swal.fire({
                title: ' ',
                background: '#0B0D14',
                color: '#fff',
                scrollbarPadding: false,
                html: `
            < !--Header -->
                    <div class="flex flex-col items-center mb-6 -mt-4">
                        <div class="w-16 h-16 rounded-full bg-indigo-500/10 flex items-center justify-center mb-3 ring-4 ring-indigo-500/5">
                            <i data-lucide="flag" class="w-8 h-8 text-indigo-500"></i>
                        </div>
                        <h2 class="text-2xl font-black text-white">Nueva Meta</h2>
                        <p class="text-slate-500 text-xs font-medium">Define tu próximo objetivo</p>
                    </div>

                    <div class="space-y-4 px-2">
                        <!-- Name Input -->
                        <div class="group text-left">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Nombre de la Meta</label>
                            <div class="relative">
                                <span class="absolute left-4 top-3.5 text-slate-500">
                                    <i data-lucide="tag" class="w-4 h-4"></i>
                                </span>
                                <input id="swal-goal-name" class="w-full bg-[#141724] border border-white/10 rounded-xl py-3 pl-10 pr-4 text-white font-bold focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50 transition placeholder-slate-700" placeholder="Ej. Viaje a Japón">
                            </div>
                        </div>

                        <!-- Target Input -->
                        <div class="group text-left">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Meta Financiera</label>
                            <div class="relative">
                                <span class="absolute left-4 top-3.5 text-indigo-500 font-bold">$</span>
                                <input id="swal-goal-target" type="number" class="w-full bg-[#141724] border border-white/10 rounded-xl py-3 pl-10 pr-4 text-white font-bold focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50 transition placeholder-slate-700" placeholder="0.00">
                            </div>
                        </div>

                        <!-- Date Input -->
                        <div class="group text-left">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Fecha Límite</label>
                            <div class="relative">
                                <span class="absolute left-4 top-3.5 text-slate-500">
                                    <i data-lucide="calendar" class="w-4 h-4"></i>
                                </span>
                                <input id="swal-goal-date" type="date" class="w-full bg-[#141724] border border-white/10 rounded-xl py-3 pl-10 pr-4 text-white font-bold focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50 transition text-slate-300" style="color-scheme: dark;">
                            </div>
                        </div>
                    </div>
        `,
                showCancelButton: true,
                confirmButtonText: 'Crear Meta',
                confirmButtonColor: '#6366F1',
                cancelButtonText: 'Cancelar',
                cancelButtonColor: '#334155',
                width: '400px',
                padding: '2rem',
                customClass: {
                    popup: 'rounded-[2rem] border border-white/10 shadow-2xl glass-panel',
                    actions: 'gap-3 mt-6'
                },
                didOpen: () => lucide.createIcons(),
                preConfirm: () => {
                    const name = document.getElementById('swal-goal-name').value;
                    const target = document.getElementById('swal-goal-target').value;
                    const date = document.getElementById('swal-goal-date').value;
                    if (!name || !target || !date) {
                        Swal.showValidationMessage('Todos los campos son obligatorios');
                    }
                    return [name, target, date];
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const [name, target, date] = result.value;
                    if (name && target) {
                        initSavingsData();
                        const newId = Date.now();
                        appState.goals.push({
                            id: newId,
                            name: name,
                            target: parseFloat(target),
                            current: 0,
                            deadline: date,
                            icon: 'flag',
                            bgClass: 'bg-indigo-500/20',
                            colorClass: 'text-indigo-400'
                        });
                        saveState();
                        renderSavingsTab();
                        Swal.fire({ icon: 'success', title: 'Meta Creada', toast: true, position: 'top', timer: 1500, showConfirmButton: false, background: '#1E293B', color: '#fff' });
                    }
                }
            });
        }

        // --- GOAL MANAGEMENT (UNIFIED "WEALTH ACCUMULATION" MECHANIC) ---
        // --- GOAL MANAGEMENT (UNIFIED "WEALTH ACCUMULATION" MECHANIC) ---
        function manageGoal(id) {

            // UNIVERSAL HISTORY FIX (GOALS)
            const goalFix = appState.goals.find(g => g.id === id);
            if (goalFix && goalFix.current > 0 && (!goalFix.history || goalFix.history.length === 0)) {
                if (!goalFix.history) goalFix.history = [];
                goalFix.history.push({
                    date: new Date().toISOString(),
                    amount: goalFix.current,
                    description: 'Balance Inicial'
                });
                saveState();
            }

            const goal = appState.goals.find(g => g.id === id);
            if (!goal) return;

            // 1. Retroactive History Fix for old goals
            if (goal.current > 0 && (!goal.history || goal.history.length === 0)) {
                goal.history = [{
                    date: new Date().toISOString(),
                    amount: goal.current
                }];
            }
            if (!goal.history) goal.history = [];

            const pct = Math.min(100, Math.round((goal.current / goal.target) * 100));
            const remaining = Math.max(0, goal.target - goal.current);
            const icon = goal.icon || 'flag';

            // Calculate "Needed Monthly" if deadline exists
            let neededMonthlyMsg = '---';
            if (goal.deadline) {
                const today = new Date();
                const dDate = new Date(goal.deadline);
                const months = (dDate.getFullYear() - today.getFullYear()) * 12 + (dDate.getMonth() - today.getMonth());
                if (months > 0 && remaining > 0) {
                    neededMonthlyMsg = formatCurrency(remaining / months) + ' / mes';
                } else if (remaining <= 0) {
                    neededMonthlyMsg = '¡Meta Lograda!';
                } else {
                    neededMonthlyMsg = 'Vence pronto';
                }
            }

            Swal.fire({
                title: ' ',
                background: '#0B0D14',
                color: '#fff',
                scrollbarPadding: false,
                html: `
            < div class="grid grid-cols-1 md:grid-cols-12 gap-8 text-left pb-4" >
        
        < !--LEFT COLUMN: VISUAL IMAGE & STATUS(5 cols)-- >
        <div class="md:col-span-5 flex flex-col gap-6 border-r border-white/5 pr-6">
            
            <!-- HEADER -->
            <div class="flex flex-col items-center gap-2 text-center pb-4 border-b border-white/5">
                <div onclick="event.stopPropagation(); selectGoalIcon('${id}')" class="w-20 h-20 rounded-3xl bg-gradient-to-br from-indigo-500/20 to-purple-500/20 flex items-center justify-center mb-2 border border-indigo-500/30 shadow-[0_0_40px_rgba(99,102,241,0.3)] cursor-pointer hover:scale-105 transition group relative">
                     <i data-lucide="${goal.icon}" class="w-10 h-10 text-indigo-400 group-hover:animate-pulse"></i>
                     <div class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-3xl opacity-0 group-hover:opacity-100 transition">
                        <i data-lucide="edit-2" class="w-5 h-5 text-white"></i>
                     </div>
                </div>
                <h2 class="text-3xl font-black text-white tracking-tight leading-none">${goal.name}</h2>
                <div class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-lg bg-white/5 border border-white/5 mt-1">
                     <span class="w-1.5 h-1.5 rounded-full bg-indigo-500 animate-pulse"></span>
                     <span class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Meta de Ahorro</span>
                </div>
            </div>

            <!-- STATUS CARD -->
            <div class="p-5 bg-gradient-to-br from-[#141724] to-[#0B0D14] rounded-2xl border border-white/10 relative overflow-hidden shadow-xl">
                 <div class="absolute top-0 right-0 w-32 h-32 bg-indigo-500/10 rounded-bl-full -mr-8 -mt-8 pointer-events-none blur-2xl"></div>
                 
                 <div class="relative z-10 text-center mb-4">
                    <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mb-1.5">Progreso Actual</p>
                    <h3 class="text-5xl font-black text-white tracking-tight leading-none mb-1">${formatCurrency(goal.current)}</h3>
                    <p class="text-[10px] text-indigo-400 font-bold uppercase tracking-wide">de ${formatCurrency(goal.target)}</p>
                 </div>

                 <!-- Bar -->
                 <div class="w-full h-3 bg-black/40 rounded-full overflow-hidden border border-white/5 relative z-10 mb-2">
                    <div class="h-full bg-gradient-to-r from-indigo-600 via-purple-500 to-indigo-400 transition-all duration-1000 shadow-[0_0_20px_rgba(99,102,241,0.4)] relative" style="width: ${pct}%">
                        <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
                    </div>
                 </div>
                 <p class="text-center text-[9px] text-slate-500 font-bold uppercase tracking-widest">${pct}% Completado</p>
            </div>

            <!-- QUICK ACTIONS -->
            <div class="grid grid-cols-2 gap-3">
                 <button onclick="handleGoalTransaction('${id}', 'deposit')" class="col-span-1 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-black text-xs uppercase tracking-wider transition shadow-lg shadow-indigo-500/20 flex flex-col items-center justify-center gap-1 active:scale-95 group">
                     <i data-lucide="plus" class="w-5 h-5 group-hover:scale-110 transition"></i>
                     Abonar
                 </button>
                 <button onclick="handleGoalTransaction('${id}', 'withdraw')" class="col-span-1 py-3 rounded-xl bg-slate-800 hover:bg-red-500/20 hover:text-red-400 border border-white/5 hover:border-red-500/30 text-slate-400 font-bold text-xs uppercase tracking-wider transition flex flex-col items-center justify-center gap-1 active:scale-95">
                     <i data-lucide="minus" class="w-5 h-5"></i>
                     Retirar
                 </button>
            </div>
            
            <!-- Quick Stats -->
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-[#141724] p-3 rounded-xl border border-white/5 text-center">
                    <p class="text-[9px] text-slate-500 uppercase font-bold">Falta</p>
                    <p class="text-xs font-black text-white">${formatCurrency(remaining)}</p>
                </div>
                <div class="bg-[#141724] p-3 rounded-xl border border-white/5 text-center">
                     <p class="text-[9px] text-slate-500 uppercase font-bold">Mensual Esp.</p>
                     <p class="text-xs font-black text-emerald-400 break-words">${monthlyNeededStr}</p>
                </div>
            </div>

        </div>

        <!--RIGHT COLUMN: MANAGEMENT & DATA(7 cols)-- >
            <div class="md:col-span-7 flex flex-col gap-5 pt-1">

                <!-- SECTION TABS -->
                <div class="flex items-center gap-3 pb-2 border-b border-white/5 opacity-60">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] flex items-center gap-2"><i data-lucide="sliders" class="w-3 h-3"></i> Configuración</span>
                </div>

                <!-- CONFIGURATION GRID -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="group col-span-2">
                        <label class="text-[9px] text-slate-500 font-bold uppercase mb-1.5 block pl-1">Nombre Meta</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="tag" class="w-3.5 h-3.5 text-slate-600"></i></div>
                            <input id="swal-goal-name" value="${goal.name}" class="w-full bg-[#141724] border border-white/5 rounded-xl pl-9 pr-3 py-2.5 text-slate-200 text-xs font-bold focus:border-indigo-500 focus:outline-none transition">
                        </div>
                    </div>
                    <div class="group">
                        <label class="text-[9px] text-slate-500 font-bold uppercase mb-1.5 block pl-1">Objetivo ($)</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="target" class="w-3.5 h-3.5 text-slate-600"></i></div>
                            <input id="swal-goal-target" type="number" value="${goal.target}" class="w-full bg-[#141724] border border-white/5 rounded-xl pl-9 pr-3 py-2.5 text-slate-200 text-xs font-bold focus:border-indigo-500 focus:outline-none transition">
                        </div>
                    </div>
                    <div class="group">
                        <label class="text-[9px] text-slate-500 font-bold uppercase mb-1.5 block pl-1">Fecha Límite</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="calendar" class="w-3.5 h-3.5 text-slate-600"></i></div>
                            <input id="swal-goal-date" type="date" value="${dateVal}" class="w-full bg-[#141724] border border-white/5 rounded-xl pl-9 pr-3 py-2.5 text-slate-200 text-xs font-bold focus:border-indigo-500 focus:outline-none transition" style="color-scheme: dark;">
                        </div>
                    </div>
                </div>

                <!-- PROJECTION MINI -->
                <div class="bg-[#141724] p-4 rounded-2xl border border-white/5 flex gap-3 items-center">
                    <div class="p-2 bg-indigo-500/10 rounded-lg shrink-0"><i data-lucide="trending-up" class="w-5 h-5 text-indigo-400"></i></div>
                    <div class="flex-1 grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[9px] text-slate-500 font-bold uppercase block mb-1">Abono Mensual</label>
                            <input id="proj-monthly" type="number" placeholder="0" class="w-full bg-[#0B0D14] border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs font-bold focus:border-indigo-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="text-[9px] text-slate-500 font-bold uppercase block mb-1">Meses</label>
                            <input id="proj-months" type="number" placeholder="12" value="12" class="w-full bg-[#0B0D14] border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs font-bold focus:border-indigo-500 focus:outline-none">
                        </div>
                    </div>
                    <button onclick="calculateProjection(${goal.current})" class="h-10 w-10 bg-indigo-600 hover:bg-indigo-500 rounded-xl flex items-center justify-center text-white transition shadow-lg"><i data-lucide="arrow-right" class="w-4 h-4"></i></button>
                </div>
                <div id="proj-result" class="hidden p-2 bg-indigo-500/10 rounded-xl text-center border border-indigo-500/20"><span class="text-xs text-indigo-300 font-bold">Proyección: </span><span id="proj-val" class="text-lg font-black text-white ml-2">---</span></div>

                <!-- HISTORY LIST (Compact) -->
                <div class="flex-1 flex flex-col min-h-[150px]">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-[9px] font-bold text-slate-500 uppercase tracking-widest flex items-center gap-1"><i data-lucide="history" class="w-3 h-3"></i> Historial</span>
                    </div>
                    <div class="flex-1 max-h-[180px] overflow-y-auto custom-scrollbar bg-[#0f1116] rounded-xl border border-white/5 p-1 space-y-1">
                        ${!goal.history || goal.history.length === 0 ? '<div class="h-full flex flex-col items-center justify-center opacity-40"><p class="text-[10px] text-slate-500 font-bold">Sin movimientos</p></div>' :
                        [...goal.history].map((h, i) => ({ ...h, idx: i })).reverse().map(h => `
                         <div onclick="event.stopPropagation(); editGoalHistory('${id}', ${h.idx})" class="flex justify-between items-center p-2.5 rounded-lg bg-white/5 hover:bg-white/10 transition cursor-pointer group">
                             <div class="flex items-center gap-2.5">
                                 <div class="w-6 h-6 rounded-full ${h.amount >= 0 ? 'bg-indigo-500/10 text-indigo-500' : 'bg-red-500/10 text-red-500'} flex items-center justify-center">
                                     <i data-lucide="${h.amount >= 0 ? 'arrow-up-right' : 'arrow-down-left'}" class="w-3 h-3"></i>
                                 </div>
                                 <div class="flex flex-col">
                                     <span class="text-[9px] text-slate-300 font-bold uppercase truncate max-w-[100px]">${h.description || "Abono"}</span>
                                     <span class="text-[9px] text-slate-600 font-mono">${new Date(h.date).toLocaleDateString()}</span>
                                 </div>
                             </div>
                             <span class="text-[10px] font-bold font-mono ${h.amount >= 0 ? 'text-indigo-400' : 'text-red-400'}">${h.amount >= 0 ? '+' : ''}${formatCurrency(h.amount)}</span>
                         </div>
                       `).join('')}
                    </div>
                </div>

            </div>
    </div >
            `,
                showConfirmButton: true,
                confirmButtonText: '<i class="fa fa-save"></i> Guardar Cambios',
                showDenyButton: true,
                denyButtonText: 'Eliminar',
                showCancelButton: true,
                cancelButtonText: 'Cerrar',
                buttonsStyling: false,
                width: '450px',
                padding: '0 0 2rem 0', // Remove top padding to let header flush, add bottom
                customClass: {
                    popup: 'rounded-[2.5rem] border border-white/10 shadow-2xl overflow-hidden glass-panel',
                    htmlContainer: '!m-0 !p-0', // Reset container padding
                    actions: 'w-full grid grid-cols-2 gap-3 px-8 pb-6', // Grid layout for buttons
                    confirmButton: 'col-span-2 bg-gradient-to-r from-indigo-600 to-indigo-500 hover:from-indigo-500 hover:to-indigo-400 text-white py-3.5 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg shadow-indigo-500/20 transition transform hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-2',
                    denyButton: 'bg-red-500/10 border border-red-500/20 hover:bg-red-500/20 text-red-500 py-3 rounded-xl font-bold text-[10px] uppercase tracking-wider transition flex items-center justify-center gap-2',
                    cancelButton: 'bg-slate-700/30 border border-white/5 hover:bg-slate-700/50 text-slate-400 hover:text-white py-3 rounded-xl font-bold text-[10px] uppercase tracking-wider transition'
                },
                didOpen: () => lucide.createIcons(),
                preConfirm: () => {
                    return {
                        name: document.getElementById('mg-name').value,
                        target: document.getElementById('mg-target').value,
                        deadline: document.getElementById('mg-date').value
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const d = result.value;
                    if (d.name && d.target) {
                        goal.name = d.name;
                        goal.target = parseFloat(d.target);
                        goal.deadline = d.deadline;
                        saveState();
                        renderSavingsTab();
                        Swal.fire({ icon: 'success', title: 'Guardado', toast: true, position: 'top', timer: 1500, showConfirmButton: false, background: '#1E293B', color: '#fff' });
                    }
                } else if (result.isDenied) {
                    Swal.fire({
                        title: '¿Eliminar Meta?', text: "Se perderá el registro.", icon: 'warning',
                        background: '#0f172a', color: '#fff', showCancelButton: true,
                        confirmButtonColor: '#ef4444', cancelButtonColor: '#334155', confirmButtonText: 'Sí, eliminar'
                    }).then((r) => {
                        if (r.isConfirmed) {
                            appState.goals = appState.goals.filter(g => g.id !== id);
                            saveState();
                            renderSavingsTab();
                            Swal.fire({ title: 'Eliminado', icon: 'success', background: '#0f172a', color: '#fff', timer: 1500, showConfirmButton: false });
                        }
                    });
                }
            });

            // WINDOW HELPERS for Goal Scope
            window.calculateGoalProjection = (base) => {
                const monthly = parseFloat(document.getElementById('gp-monthly').value) || 0;
                const months = parseFloat(document.getElementById('gp-months').value) || 0;
                const total = base + (monthly * months);
                const el = document.getElementById('gp-result');
                const pVal = document.getElementById('gp-val');
                if (el && pVal) {
                    el.classList.remove('hidden');
                    pVal.innerText = formatCurrency(total);
                }
            };

            window.selectGoalIcon = (gId) => {
                const icons = ['flag', 'target', 'trophy', 'rocket', 'plane', 'car', 'home', 'star', 'heart', 'camera', 'gamepad-2', 'gift', 'shopping-cart', 'monitor', 'smartphone'];
                Swal.fire({
                    title: 'Selecciona un Icono',
                    html: `
            < div class="grid grid-cols-5 gap-4 p-2" >
                ${icons.map(ic => `
                                <div onclick="window.confirmGoalIcon('${gId}', '${ic}')" class="w-10 h-10 rounded-xl bg-white/5 hover:bg-indigo-500/20 hover:text-indigo-400 flex items-center justify-center cursor-pointer transition">
                                    <i data-lucide="${ic}" class="w-5 h-5"></i>
                                </div>
                            `).join('')
                        }
                        </div >
            `,
                    background: '#1E293B', color: '#fff',
                    scrollbarPadding: false,
                    showConfirmButton: false,
                    didOpen: () => lucide.createIcons()
                });
            };

            window.confirmGoalIcon = (gId, iconName) => {
                const goal = appState.goals.find(g => g.id == gId);
                if (goal) {
                    goal.icon = iconName;
                    saveState();
                    renderSavingsTab();
                }
                Swal.close(); // Close icon picker
                manageGoal(parseInt(gId)); // Re-open management
            };

            window.handleGoalTransaction = (gId, action) => {
                Swal.fire({
                    title: action === 'deposit' ? 'Abonar a la Meta' : 'Retirar de la Meta',
                    html: `
            < div class="relative mt-4 mb-2" >
                             <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <span class="text-slate-500 font-bold">$</span>
                             </div>
                             <input id="goal-txn-amount" type="number" class="w-full bg-[#1e293b] border border-white/10 rounded-xl pl-8 pr-4 py-3 text-white font-bold focus:outline-none focus:border-${action === 'deposit' ? 'indigo' : 'red'}-500 transition placeholder-slate-600" placeholder="0.00">
                        </div>
        `,
                    background: '#0B0D14', color: '#fff', scrollbarPadding: false,
                    confirmButtonText: 'CONFIRMAR', confirmButtonColor: action === 'deposit' ? '#6366f1' : '#ef4444',
                    showCancelButton: true, cancelButtonColor: '#334155',
                    preConfirm: () => document.getElementById('goal-txn-amount').value
                }).then((r) => {
                    if (r.isConfirmed && r.value) {
                        const val = parseFloat(r.value);
                        if (!val || val <= 0) return;

                        const amount = action === 'deposit' ? val : -val;
                        const date = new Date().toISOString();

                        const g = appState.goals.find(x => x.id === gId);
                        if (g) {
                            g.current += amount;
                            if (g.current < 0) g.current = 0;
                            if (!g.history) g.history = [];
                            g.history.push({ date, amount });

                            saveState();
                            renderSavingsTab();
                            Swal.close();
                            setTimeout(() => manageGoal(gId), 300);
                        }
                    }
                });
            };

            window.editGoalHistory = (gId, hIdx) => {
                const g = appState.goals.find(x => x.id === gId);
                if (!g || !g.history[hIdx]) return;
                const item = g.history[hIdx];
                const dateObj = new Date(item.date);
                const dateYMD = dateObj.toISOString().split('T')[0];
                const h = String(dateObj.getHours()).padStart(2, '0');
                const m = String(dateObj.getMinutes()).padStart(2, '0');
                const desc = item.description || 'Abono';

                Swal.fire({
                    title: ' ', background: '#0B0D14', color: '#fff', scrollbarPadding: false,
                    html: `
            < div class="flex flex-col items-center gap-1 -mt-6 mb-6" >
                            <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-500/20 to-purple-500/20 flex items-center justify-center mb-3 border border-indigo-500/30 shadow-[0_0_30px_rgba(99,102,241,0.3)]">
                                <i data-lucide="edit" class="w-8 h-8 text-indigo-400"></i>
                            </div>
                            <h2 class="text-2xl font-black text-white tracking-tight leading-none">Editar Abono</h2>
                            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-[0.2em]">Registro Histórico</p>
                        </div >
            <div class="space-y-4 text-left px-2">
                <div class="group">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Concepto</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="file-text" class="w-4 h-4 text-slate-500"></i></div>
                        <input id="gh-desc" type="text" value="${desc}" class="w-full bg-[#141724] border border-white/10 rounded-xl pl-9 pr-4 py-3 text-white font-bold transition focus:outline-none focus:border-indigo-500">
                    </div>
                </div>
                <div class="group">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Monto ($)</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="dollar-sign" class="w-4 h-4 text-indigo-500"></i></div>
                        <input id="gh-amt" type="number" value="${Math.abs(item.amount)}" class="w-full bg-[#141724] border border-white/10 rounded-xl pl-9 pr-4 py-3 text-white font-bold transition focus:outline-none focus:border-indigo-500">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="group">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Fecha</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="calendar" class="w-4 h-4 text-slate-500"></i></div>
                            <input id="gh-date" type="date" value="${dateYMD}" class="w-full bg-[#141724] border border-white/10 rounded-xl pl-9 pr-3 py-3 text-white font-bold transition focus:outline-none focus:border-indigo-500" style="color-scheme: dark;">
                        </div>
                    </div>
                    <div class="group">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Hora</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="clock" class="w-4 h-4 text-slate-500"></i></div>
                            <input id="gh-time" type="time" value="${h}:${m}" class="w-full bg-[#141724] border border-white/10 rounded-xl pl-9 pr-3 py-3 text-white font-bold transition focus:outline-none focus:border-indigo-500" style="color-scheme: dark;">
                        </div>
                    </div>
                </div>
            </div>
        `,
                    showDenyButton: true, denyButtonText: 'Eliminar',
                    confirmButtonText: '<i class="fa fa-save"></i> Guardar Cambios',
                    showCancelButton: true, cancelButtonText: 'Cerrar',
                    width: '400px', padding: '0 0 2rem 0',
                    buttonsStyling: false,
                    customClass: {
                        popup: 'rounded-[2rem] border border-white/10 shadow-2xl glass-panel',
                        htmlContainer: '!m-0 !p-0',
                        actions: 'w-full grid grid-cols-2 gap-3 px-6 mt-4',
                        confirmButton: 'col-span-2 bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white py-3 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg shadow-red-500/20 transition transform hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-2',
                        denyButton: 'bg-slate-700/30 border border-white/5 hover:bg-slate-700/50 text-slate-400 py-2.5 rounded-xl font-bold text-[10px] uppercase tracking-wider transition',
                        cancelButton: 'bg-slate-700/30 border border-white/5 hover:bg-slate-700/50 text-slate-400 hover:text-white py-2.5 rounded-xl font-bold text-[10px] uppercase tracking-wider transition'
                    },
                    didOpen: () => lucide.createIcons(),
                }).then((r) => {
                    if (r.isConfirmed) {
                        // Save
                        const newAmt = parseFloat(document.getElementById('edit-hist-amount').value);
                        const newDate = document.getElementById('edit-hist-date').value;
                        const newTime = document.getElementById('edit-hist-time').value;

                        if (newAmt && newDate && newTime) {
                            const d = new Date(`${newDate}T${newTime} `);

                            const diff = newAmt - item.amount;

                            item.amount = newAmt;
                            item.date = d.toISOString();

                            debt.current_paid += diff;
                            // Cap? Not necessarily if input was manual, but logic says max total.
                            // if (debt.current_paid > debt.total) debt.current_paid = debt.total; 

                            saveState();
                            renderSavingsTab();
                            Swal.close();
                            viewDebtHistory(debtId);
                        }
                    } else if (r.isDenied) {
                        // Delete
                        debt.current_paid -= item.amount;
                        debt.history.splice(idx, 1);

                        saveState();
                        renderSavingsTab();
                        Swal.close();
                        viewDebtHistory(debtId);
                    }
                });
            };
        }

        function deleteDebtItem(id) {
            Swal.fire({
                title: '¿Eliminar Deuda?',
                text: "No podrás revertir esto.",
                icon: 'warning',
                background: '#0f172a',
                color: '#fff',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#334155',
                confirmButtonText: 'Sí, eliminar'
            }).then((result) => {
                if (result.isConfirmed) {
                    appState.debts = appState.debts.filter(d => d.id !== id);
                    saveState();
                    renderSavingsTab();
                    Swal.fire({ title: 'Eliminado', icon: 'success', background: '#0f172a', color: '#fff', timer: 1500, showConfirmButton: false });
                }
            });
        }

        function createAssetCard(name, amount, icon, isCustom, idx) {
            const typeArg = isCustom ? 'custom' : 'core';
            const idArg = isCustom ? idx : `'${idx}'`;

            // Retrieve Target Data
            let target = 0;
            if (isCustom) {
                if (appState.customAssets && appState.customAssets[idx]) target = appState.customAssets[idx].target || 0;
            } else {
                if (appState.assetMeta && appState.assetMeta[idx]) target = appState.assetMeta[idx].target || 0;
            }

            // Calculate Progress
            let progressHtml = '';
            let pct = 0;
            if (target > 0) {
                pct = Math.min(100, Math.round((amount / target) * 100));
                progressHtml = `
            < div class="mt-auto pt-4" >
                        <div class="flex justify-between items-end mb-1.5">
                            <span class="text-[9px] font-bold text-slate-500 uppercase tracking-wider">Meta: ${formatCurrency(target)}</span>
                            <span class="text-[9px] font-bold text-slate-400">${pct}%</span>
                        </div>
                        <div class="w-full h-1.5 bg-[#0B0D14] rounded-full overflow-hidden border border-white/5">
                            <div class="h-full bg-current opacity-80 rounded-full transition-all duration-1000" style="width: ${pct}%"></div>
                        </div>
                    </div > `;
            } else {
                progressHtml = `
            < div class="mt-auto pt-4 flex items-center justify-between opacity-0 group-hover:opacity-100 transition-opacity duration-500" >
                         <span class="text-[9px] font-bold text-slate-600 uppercase tracking-wider">Sin Meta</span>
                         <i data-lucide="arrow-right" class="w-3 h-3 text-slate-600"></i>
                    </div > `;
            }

            // Color Themes based on Asset Type (Heuristic)
            let colorClass = 'text-emerald-400';
            let bgClass = 'bg-emerald-500/10';
            let borderClass = 'group-hover:border-emerald-500/50';
            let shadowClass = 'group-hover:shadow-[0_0_20px_rgba(16,185,129,0.2)]';
            let iconBg = 'bg-emerald-500/20';

            if (name.toLowerCase().includes('banco') || name.toLowerCase().includes('bank')) {
                colorClass = 'text-blue-400';
                bgClass = 'bg-blue-500/10';
                borderClass = 'group-hover:border-blue-500/50';
                shadowClass = 'group-hover:shadow-[0_0_20px_rgba(59,130,246,0.2)]';
                iconBg = 'bg-blue-500/20';
            } else if (name.toLowerCase().includes('ahorro') || name.toLowerCase().includes('savings')) {
                colorClass = 'text-indigo-400';
                bgClass = 'bg-indigo-500/10';
                borderClass = 'group-hover:border-indigo-500/50';
                shadowClass = 'group-hover:shadow-[0_0_20px_rgba(99,102,241,0.2)]';
                iconBg = 'bg-indigo-500/20';
            } else if (name.toLowerCase().includes('pareja') || name.toLowerCase().includes('love')) {
                colorClass = 'text-pink-400';
                bgClass = 'bg-pink-500/10';
                borderClass = 'group-hover:border-pink-500/50';
                shadowClass = 'group-hover:shadow-[0_0_20px_rgba(236,72,153,0.2)]';
                iconBg = 'bg-pink-500/20';
            }

            // Gradient Titles
            let gradientTitle = 'from-emerald-400 to-teal-400';
            if (colorClass.includes('blue')) gradientTitle = 'from-blue-400 to-cyan-400';
            if (colorClass.includes('indigo')) gradientTitle = 'from-indigo-400 to-violet-400';
            if (colorClass.includes('pink')) gradientTitle = 'from-pink-400 to-rose-400';

            return `
            < div onclick = "manageAsset('${typeArg}', ${idArg})" class="relative group cursor-pointer flex flex-col justify-between p-5 rounded-[1.75rem] bg-[#161b22] border border-white/5 ${borderClass} hover:bg-[#1c222e] transition-all duration-300 ${shadowClass} overflow-hidden min-h-[170px]" >
                
                < !--Background Blob-- >
                <div class="absolute -top-12 -right-12 w-40 h-40 rounded-full ${bgClass} blur-[50px] opacity-20 group-hover:opacity-40 transition-opacity duration-500 pointer-events-none"></div>

                <div class="flex justify-between items-start relative z-10">
                    <div class="w-12 h-12 rounded-2xl ${iconBg} flex items-center justify-center ${colorClass} border border-white/5 shadow-[inset_0_1px_1px_rgba(255,255,255,0.1)] transition-transform duration-300 group-hover:scale-110 group-hover:rotate-3">
                        <i data-lucide="${icon}" class="w-6 h-6"></i>
                    </div>
                    <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-300 transform translate-x-2 group-hover:translate-x-0">
                        <div class="p-2 rounded-lg bg-white/5 hover:bg-white/10 text-slate-400 hover:text-white transition">
                             <i data-lucide="settings-2" class="w-4 h-4"></i>
                        </div>
                    </div>
                </div>

                <div class="relative z-10 mt-auto">
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1 group-hover:text-slate-400 transition ml-1">${name}</p>
                    <h3 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r ${gradientTitle} tracking-tight maskable leading-none filter drop-shadow-sm">${formatCurrency(amount)}</h3>
                    
                    <!-- Progress Section -->
                    <div class="${colorClass}">
                        ${progressHtml}
                    </div>
                </div>
             </div >
            `;
        }

        function addSavingsAsset() {
            Swal.fire({
                title: ' ',
                background: '#0B0D14',
                color: '#fff',
                scrollbarPadding: false,
                html: `
            < !--Header -->
                    <div class="flex flex-col items-center mb-6 -mt-4">
                        <div class="w-16 h-16 rounded-full bg-emerald-500/10 flex items-center justify-center mb-3 ring-4 ring-emerald-500/5">
                            <i data-lucide="plus" class="w-8 h-8 text-emerald-500"></i>
                        </div>
                        <h2 class="text-2xl font-black text-white">Nuevo Activo</h2>
                        <p class="text-slate-500 text-xs font-medium">Incrementa tu patrimonio</p>
                    </div>

                    <div class="space-y-4 px-2">
                        <!-- Name Input -->
                        <div class="group text-left">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Nombre del Activo</label>
                            <div class="relative">
                                <span class="absolute left-4 top-3.5 text-slate-500">
                                    <i data-lucide="tag" class="w-4 h-4"></i>
                                </span>
                                <input id="swal-asset-name" class="w-full bg-[#141724] border border-white/10 rounded-xl py-3 pl-10 pr-4 text-white font-bold focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500/50 transition placeholder-slate-700" placeholder="Ej. Caja Fuerte, Inversión X">
                            </div>
                        </div>

                        <!-- Amount Input -->
                        <div class="group text-left">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Valor Inicial</label>
                            <div class="relative">
                                <span class="absolute left-4 top-3.5 text-emerald-500 font-bold">$</span>
                                <input id="swal-asset-amt" type="number" class="w-full bg-[#141724] border border-white/10 rounded-xl py-3 pl-10 pr-4 text-white font-bold focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500/50 transition placeholder-slate-700" placeholder="0.00">
                            </div>
                        </div>
                    </div>
        `,
                showCancelButton: true,
                confirmButtonText: 'Crear Activo',
                confirmButtonColor: '#10B981',
                cancelButtonText: 'Cancelar',
                cancelButtonColor: '#334155',
                width: '400px',
                padding: '2rem',
                customClass: {
                    popup: 'rounded-[2rem] border border-white/10 shadow-2xl glass-panel',
                    actions: 'gap-3 mt-6'
                },
                didOpen: () => lucide.createIcons(),
                preConfirm: () => {
                    const name = document.getElementById('swal-asset-name').value;
                    const amt = document.getElementById('swal-asset-amt').value;
                    if (!name || !amt) {
                        Swal.showValidationMessage('Por favor completa los campos');
                    }
                    return [name, amt];
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const [name, amt] = result.value;
                    if (name && amt) {
                        initSavingsData();
                        const amount = parseFloat(amt);
                        const newAsset = {
                            name: name,
                            amount: amount,
                            icon: 'archive',
                            history: [{ date: new Date().toISOString(), amount: amount }] // Log initial creation
                        };
                        appState.customAssets.push(newAsset);
                        saveState();
                        renderSavingsTab();
                        Swal.fire({ icon: 'success', title: 'Activo Creado', toast: true, position: 'top', timer: 1500, showConfirmButton: false, background: '#1E293B', color: '#fff' });
                    }
                }
            });
        }

        function deleteCustomAsset(idx) {
            Swal.fire({
                title: '¿Eliminar?', icon: 'warning', showCancelButton: true,
                confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'Sí',
                background: '#1E293B', color: '#fff'
            }).then((r) => {
                if (r.isConfirmed) {
                    appState.customAssets.splice(idx, 1);
                    saveState();
                    renderSavingsTab();
                }
            });
        }

        // --- ASSET MANAGEMENT ---
        // --- ASSET MANAGEMENT ---
        // --- ASSET MANAGEMENT ---
        // --- ASSET MANAGEMENT ---
        // --- ASSET MANAGEMENT ---
        // New: Delete History Item Function
        window.deleteAssetHistoryItem = function (type, id, originalIdx) {
            Swal.fire({
                title: 'Eliminar Registro',
                text: "¿Estás seguro? Esta acción eliminará el registro del historial.",
                icon: 'warning',
                background: '#0B0D14',
                color: '#fff',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#334155',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    let historyArr = null;

                    if (type === 'core') {
                        if (appState.assetMeta && appState.assetMeta[id] && appState.assetMeta[id].history) {
                            historyArr = appState.assetMeta[id].history;
                        }
                    } else {
                        if (appState.customAssets && appState.customAssets[id] && appState.customAssets[id].history) {
                            historyArr = appState.customAssets[id].history;
                        }
                    }

                    if (historyArr) {
                        // Remove item at index
                        historyArr.splice(originalIdx, 1);
                        saveState();

                        // Re-render modal efficiently
                        manageAsset(type, id);

                        Swal.fire({
                            title: 'Eliminado',
                            icon: 'success',
                            toast: true,
                            position: 'top-end',
                            timer: 1500,
                            showConfirmButton: false,
                            background: '#0B0D14',
                            color: '#fff'
                        });
                    }
                }
            });
        }

        function manageAsset(type, id) {

            // UNIVERSAL HISTORY FIX (ASSETS)
            // Ensure consistency between current amount and history
            if (type === 'custom') {
                const a = appState.customAssets[id];
                if (a && a.amount > 0 && (!a.history || a.history.length === 0)) {
                    if (!a.history) a.history = [];
                    a.history.push({
                        date: new Date().toISOString(),
                        amount: a.amount,
                        description: 'Balance Inicial'
                    });
                    saveState();
                }
            } else if (type === 'core') {
                if (!appState.assetMeta) appState.assetMeta = {};
                if (!appState.assetMeta[id]) appState.assetMeta[id] = {};

                const currentAmt = appState.balanceAccounts[id] || 0;
                const meta = appState.assetMeta[id];

                if (currentAmt > 0 && (!meta.history || meta.history.length === 0)) {
                    if (!meta.history) meta.history = [];
                    meta.history.push({
                        date: new Date().toISOString(),
                        amount: currentAmt,
                        description: 'Balance Inicial'
                    });
                    saveState();
                }
            }

            let name = '';
            let currentAmount = 0;
            let icon = '';
            let history = [];
            let target = 0; // New: Target support
            let metaRef = null;

            if (type === 'core') {
                currentAmount = appState.balanceAccounts[id] || 0;
                if (!appState.assetMeta) appState.assetMeta = {};
                metaRef = appState.assetMeta;

                if (!metaRef[id]) metaRef[id] = {};

                // Defaults
                const coreMap = {
                    'pocket': { name: 'Efectivo', icon: 'wallet' },
                    'bank': { name: 'Banco', icon: 'landmark' },
                    'loan': { name: 'Ahorro', icon: 'piggy-bank' }
                };
                const def = coreMap[id] || { name: 'Activo', icon: 'circle-dollar-sign' };

                name = metaRef[id].name || def.name;
                icon = metaRef[id].icon || def.icon;
                history = metaRef[id].history || [];
                target = metaRef[id].target || 0;
            } else {
                const asset = appState.customAssets[id];
                if (!asset) return;
                currentAmount = asset.amount;
                name = asset.name;
                icon = asset.icon || 'archive';
                history = asset.history || [];
                target = asset.target || 0;
            }

            // MERGE HISTORY FOR DISPLAY (Fix for -1011 mystery)
            // We convert the base history to "Display Items" first
            let displayHistory = history.map((h, i) => ({ ...h, source: 'meta', originalIdx: i }));

            // If Pocket (Efectivo), include ALL regular transactions as they verify the balance
            if (type === 'core' && id === 'pocket' && appState.transactions) {
                const globalTx = appState.transactions.map(t => ({
                    date: t.dateIso || ((t.id && !isNaN(new Date(t.id).getTime())) ? new Date(t.id).toISOString() : new Date().toISOString()),
                    amount: t.type === 'income' ? parseFloat(t.amount) : -parseFloat(t.amount),
                    description: t.name + (t.category ? ` (${t.category})` : ''),
                    source: 'global',
                    originalId: t.id
                }));
                displayHistory = displayHistory.concat(globalTx);
            }

            // Sort by Date Descending
            displayHistory.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Calculate Progress if target exists
            let statusCardHtml = '';
            if (target > 0) {
                const pct = Math.min(100, Math.round((currentAmount / target) * 100));
                statusCardHtml = `
            < p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mb-2" > Progreso Actual</p >
                    <h3 class="text-5xl font-black text-white tracking-tighter drop-shadow-lg">${formatCurrency(currentAmount)}</h3>
                    <p class="text-xs text-emerald-400 font-bold mt-1">de ${formatCurrency(target)}</p>
                    
                    <!--Progress Bar-- >
                    <div class="w-3/4 mx-auto h-2 bg-black/40 rounded-full overflow-hidden border border-white/5 mt-4 relative">
                        <div class="h-full bg-gradient-to-r from-emerald-500 to-teal-500 transition-all duration-1000 shadow-[0_0_10px_rgba(16,185,129,0.5)]" style="width: ${pct}%"></div>
                    </div>
                    <p class="text-[9px] text-slate-500 mt-2 font-mono">${pct}% Completado</p>
        `;
            } else {
                statusCardHtml = `
            < p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mb-2" > Total Acumulado</p >
                <h3 class="text-5xl font-black text-white tracking-tighter drop-shadow-lg">${formatCurrency(currentAmount)}</h3>
        `;
            }

            // 2. Render Modal
            Swal.fire({
                title: ' ',
                background: '#0B0D14',
                color: '#fff',
                scrollbarPadding: false,
                html: `
            < !--HEADER -->
                     <div class="flex flex-col items-center gap-1 -mt-6 mb-6">
                         <div onclick="event.stopPropagation(); selectAssetIcon('${type}', '${id}')" class="w-16 h-16 rounded-2xl bg-gradient-to-br from-emerald-500/20 to-teal-500/20 flex items-center justify-center mb-3 border border-emerald-500/30 shadow-[0_0_30px_rgba(16,185,129,0.3)] cursor-pointer hover:scale-105 transition group">
                             <i data-lucide="${icon}" class="w-8 h-8 text-emerald-500 group-hover:animate-pulse"></i>
                             <div class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-2xl opacity-0 group-hover:opacity-100 transition">
                                 <i data-lucide="edit-2" class="w-4 h-4 text-white"></i>
                             </div>
                         </div>
                         <h2 class="text-3xl font-black text-white tracking-tight leading-none">${name}</h2>
                         <p class="text-[10px] text-slate-500 font-bold uppercase tracking-[0.2em] mt-1">Gestión de Activos</p>
                     </div>
 
                     <div class="text-left space-y-6">
                         
                         <!-- MAIN STATUS CARD -->
                         <div class="p-6 bg-[#141724] rounded-3xl border border-white/5 relative overflow-hidden shadow-2xl group">
                              <div class="absolute top-0 right-0 w-40 h-40 bg-gradient-to-bl from-emerald-500/10 to-transparent rounded-bl-full -mr-10 -mt-10 pointer-events-none"></div>
                             
                              <div class="relative z-10 text-center">
                                  ${statusCardHtml}
                                  
                                  <div class="mt-4 flex justify-center gap-4">
                                      <button onclick="handleAssetTransaction('${type}', '${id}', 'deposit')" class="px-6 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-400 text-white font-bold text-xs uppercase tracking-wider transition shadow-lg shadow-emerald-500/20 flex items-center gap-2 transform active:scale-95">
                                         <i data-lucide="plus" class="w-4 h-4"></i> Abonar
                                      </button>
                                      <button onclick="handleAssetTransaction('${type}', '${id}', 'withdraw')" class="px-6 py-2 rounded-xl bg-red-500/10 border border-red-500/20 hover:bg-red-500/20 text-red-500 font-bold text-xs uppercase tracking-wider transition flex items-center gap-2 transform active:scale-95">
                                         <i data-lucide="minus" class="w-4 h-4"></i> Retirar
                                      </button>
                                  </div>
                              </div>
                         </div>
 
                         <!-- SETTINGS (Name & Target) -->
                         <div class="space-y-4">
                              <div class="flex items-center gap-3 px-1 opacity-60">
                                 <span class="text-[9px] font-bold text-slate-400 uppercase tracking-[0.2em] flex items-center gap-2"><i data-lucide="sliders" class="w-3 h-3"></i> Configuración</span>
                                 <div class="h-px flex-1 bg-gradient-to-r from-transparent via-slate-600 to-transparent"></div>
                              </div>
                              
                              <div class="grid grid-cols-2 gap-4">
                                  <div class="group col-span-2">
                                     <label class="text-[9px] text-slate-500 font-bold uppercase mb-1.5 block pl-1">Nombre del Activo</label>
                                     <div class="relative">
                                         <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                             <i data-lucide="tag" class="w-3.5 h-3.5 text-slate-600 group-hover:text-slate-400 transition"></i>
                                         </div>
                                         <input id="edit-asset-name-inp" value="${name}" class="w-full bg-[#141724] border border-white/5 hover:border-white/10 rounded-xl pl-9 pr-3 py-2.5 text-slate-200 text-xs font-bold focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500/20 focus:bg-[#0B0D14] focus:outline-none transition">
                                     </div>
                                 </div>
                                 
                                 <div class="group col-span-2">
                                     <label class="text-[9px] text-slate-500 font-bold uppercase mb-1.5 block pl-1">Meta Financiera (Opcional)</label>
                                     <div class="relative">
                                         <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                             <i data-lucide="target" class="w-3.5 h-3.5 text-slate-600 group-hover:text-slate-400 transition"></i>
                                         </div>
                                         <input id="edit-asset-target-inp" type="number" value="${target || ''}" placeholder="Sin objetivo" class="w-full bg-[#141724] border border-white/5 hover:border-white/10 rounded-xl pl-9 pr-3 py-2.5 text-slate-200 text-xs font-bold focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500/20 focus:bg-[#0B0D14] focus:outline-none transition">
                                     </div>
                                 </div>
                             </div>
                         </div>
 
                         <!-- PROJECTION CALCULATOR -->
                         <div class="bg-[#141724] p-5 rounded-3xl border border-white/5">
                              <label class="block text-[10px] font-black text-indigo-400 mb-4 uppercase tracking-widest flex items-center gap-2">
                                 <i data-lucide="trending-up" class="w-3.5 h-3.5"></i> Proyección de Crecimiento
                              </label>
                              <div class="flex gap-3 items-end">
                                 <div class="flex-1">
                                     <label class="text-[9px] text-slate-500 font-bold uppercase block mb-1">Abono Mensual</label>
                                     <input id="proj-monthly" type="number" placeholder="0" class="w-full bg-[#0B0D14] border border-white/10 rounded-xl px-3 py-2 text-white text-xs font-bold focus:border-indigo-500 focus:outline-none transition">
                                 </div>
                                 <div class="flex-1">
                                     <label class="text-[9px] text-slate-500 font-bold uppercase block mb-1">Meses</label>
                                     <input id="proj-months" type="number" placeholder="12" value="12" class="w-full bg-[#0B0D14] border border-white/10 rounded-xl px-3 py-2 text-white text-xs font-bold focus:border-indigo-500 focus:outline-none transition">
                                 </div>
                                 <button onclick="calculateProjection(${currentAmount})" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-xl font-bold text-xs transition h-[38px] shadow-lg shadow-indigo-500/20">
                                     <i data-lucide="calculator" class="w-4 h-4"></i>
                                 </button>
                              </div>
                              <div id="proj-result" class="mt-4 p-3 bg-indigo-500/10 rounded-xl border border-indigo-500/20 text-center hidden">
                                 <span class="text-[10px] text-indigo-300 font-bold uppercase">Valor Futuro Estimado</span>
                                 <div id="proj-val" class="text-xl font-black text-indigo-400">---</div>
                              </div>
                         </div>
 
                         <!-- HISTORY LIST -->
                         <div class="pt-2">
                             <div class="flex items-center justify-between mb-3 px-1">
                                 <span class="text-[9px] font-bold text-slate-500 uppercase tracking-widest"><i data-lucide="history" class="w-3 h-3 inline mr-1"></i> Historial Reciente</span>
                             </div>
                            <div class="space-y-2 max-h-[150px] overflow-y-auto custom-scrollbar pr-1">
                                 ${displayHistory.length === 0 ? '<div class="py-6 flex flex-col items-center justify-center opacity-40"><i data-lucide="clock" class="w-8 h-8 mb-2"></i><p class="text-xs text-slate-400">Sin movimientos</p></div>' :
                        displayHistory.map(h => {
                            const isMeta = h.source === 'meta';
                            const clickAction = isMeta ? `onclick="event.stopPropagation(); editAssetHistory('${type}', ${type === 'custom' ? id : `'${id}'`}, ${h.originalIdx})"` : '';
                            const cursorStyle = isMeta ? 'cursor-pointer hover:bg-white/10' : 'cursor-default opacity-80';

                            return `
                                     <div ${clickAction} class="flex justify-between items-center p-3 rounded-xl bg-white/5 border border-white/5 ${cursorStyle} transition group relative overflow-hidden">
                                         <div class="flex items-center gap-3">
                                             <div class="w-8 h-8 rounded-full ${h.amount >= 0 ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'} flex items-center justify-center group-hover:scale-110 transition">
                                                 <i data-lucide="${h.amount >= 0 ? 'arrow-up-right' : 'arrow-down-left'}" class="w-4 h-4"></i>
                                             </div>
                                             <div>
                                                  <p class="text-[10px] text-slate-400 font-bold uppercase truncate max-w-[120px]">${h.description || "Movimiento"}</p>
                                                  <div class="flex items-center gap-1">
                                                      <span class="text-[9px] text-slate-500 font-mono">${new Date(h.date).toLocaleDateString()}</span>
                                                      ${!isMeta ? '<span class="text-[8px] px-1 rounded bg-indigo-500/20 text-indigo-400 border border-indigo-500/20">WALLET</span>' : ''}
                                                  </div>
                                             </div>
                                         </div>
                                         <div class="flex items-center gap-3">
                                            <span class="text-xs font-bold ${h.amount >= 0 ? 'text-emerald-400' : 'text-red-400'}">${h.amount >= 0 ? '+' : ''}${formatCurrency(h.amount)}</span>
                                            ${isMeta ? `
                                            <button onclick="event.stopPropagation(); deleteAssetHistoryItem('${type}', ${type === 'custom' ? id : `'${id}'`}, ${h.originalIdx})" class="w-6 h-6 rounded-lg bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white flex items-center justify-center transition opacity-0 group-hover:opacity-100">
                                                <i data-lucide="trash-2" class="w-3 h-3"></i>
                                            </button>` : ''}
                                         </div>
                                     </div>
                                   `
                        }).join('')}
                             </div>
                         </div>
 
                     </div>
        `,
                showConfirmButton: true,
                confirmButtonText: '<i class="fa fa-save"></i> Guardar Cambios',
                showDenyButton: true,
                denyButtonText: 'Eliminar',
                showCancelButton: true,
                cancelButtonText: 'Cerrar',
                buttonsStyling: false,
                width: '450px',
                padding: '0 0 2rem 0',
                customClass: {
                    popup: 'rounded-[2.5rem] border border-white/10 shadow-2xl overflow-hidden glass-panel',
                    htmlContainer: '!m-0 !p-0',
                    actions: 'w-full grid grid-cols-2 gap-3 px-8 pb-6',
                    confirmButton: 'col-span-2 bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-500 hover:to-emerald-400 text-white py-3.5 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg shadow-emerald-500/20 transition transform hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-2',
                    denyButton: 'bg-red-500/10 border border-red-500/20 hover:bg-red-500/20 text-red-500 py-3 rounded-xl font-bold text-[10px] uppercase tracking-wider transition flex items-center justify-center gap-2',
                    cancelButton: 'bg-slate-700/30 border border-white/5 hover:bg-slate-700/50 text-slate-400 hover:text-white py-3 rounded-xl font-bold text-[10px] uppercase tracking-wider transition'
                },
                didOpen: () => lucide.createIcons(),
                preConfirm: () => {
                    const newName = document.getElementById('edit-asset-name-inp').value;
                    const newTarget = parseFloat(document.getElementById('edit-asset-target-inp').value) || 0;
                    if (newName) {
                        if (type === 'core') {
                            if (!appState.assetMeta[id]) appState.assetMeta[id] = {};
                            appState.assetMeta[id].name = newName;
                            appState.assetMeta[id].target = newTarget;
                        } else {
                            appState.customAssets[id].name = newName;
                            appState.customAssets[id].target = newTarget;
                        }
                        saveState();
                        renderSavingsTab();
                    }
                }
            }).then((result) => {
                if (result.isDenied) {
                    // Delete functionality
                    if (type === 'core') {
                        Swal.fire({ title: 'No se pueden eliminar activos principales', icon: 'error', background: '#0B0D14', color: '#fff', confirmButtonColor: '#334155' });
                    } else {
                        Swal.fire({
                            title: '¿Eliminar?',
                            text: 'Se perderá este activo y su historial.',
                            icon: 'warning',
                            background: '#0B0D14', color: '#fff',
                            showCancelButton: true, confirmButtonColor: '#ef4444',
                            confirmButtonText: 'Eliminar'
                        }).then(r => {
                            if (r.isConfirmed) {
                                delete appState.customAssets[id];
                                saveState();
                                renderSavingsTab();
                            }
                        });
                    }
                } else if (result.dismiss === Swal.DismissReason.backdrop || result.dismiss === Swal.DismissReason.cancel) {
                    // Just close
                } else {
                    // Saved via preConfirm, trigger toast
                    Swal.fire({ icon: 'success', title: 'Guardado', toast: true, position: 'top', timer: 1500, showConfirmButton: false, background: '#1E293B', color: '#fff' });
                }
            });
        }

        function addSavingsGoal() {
            Swal.fire({
                title: ' ',
                background: '#0B0D14',
                color: '#fff',
                scrollbarPadding: false,
                html: `
            < !--Header -->
                    <div class="flex flex-col items-center mb-6 -mt-4">
                        <div class="w-16 h-16 rounded-full bg-indigo-500/10 flex items-center justify-center mb-3 ring-4 ring-indigo-500/5">
                            <i data-lucide="flag" class="w-8 h-8 text-indigo-500"></i>
                        </div>
                        <h2 class="text-2xl font-black text-white">Nueva Meta</h2>
                        <p class="text-slate-500 text-xs font-medium">Define tu próximo objetivo</p>
                    </div>

                    <div class="space-y-4 px-2">
                        <!-- Name Input -->
                        <div class="group text-left">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Nombre de la Meta</label>
                            <div class="relative">
                                <span class="absolute left-4 top-3.5 text-slate-500">
                                    <i data-lucide="tag" class="w-4 h-4"></i>
                                </span>
                                <input id="swal-goal-name" class="w-full bg-[#141724] border border-white/10 rounded-xl py-3 pl-10 pr-4 text-white font-bold focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50 transition placeholder-slate-700" placeholder="Ej. Viaje a Japón">
                            </div>
                        </div>

                        <!-- Target Input -->
                        <div class="group text-left">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Meta Financiera</label>
                            <div class="relative">
                                <span class="absolute left-4 top-3.5 text-indigo-500 font-bold">$</span>
                                <input id="swal-goal-target" type="number" class="w-full bg-[#141724] border border-white/10 rounded-xl py-3 pl-10 pr-4 text-white font-bold focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50 transition placeholder-slate-700" placeholder="0.00">
                            </div>
                        </div>

                        <!-- Date Input -->
                        <div class="group text-left">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Fecha Límite</label>
                            <div class="relative">
                                <span class="absolute left-4 top-3.5 text-slate-500">
                                    <i data-lucide="calendar" class="w-4 h-4"></i>
                                </span>
                                <input id="swal-goal-date" type="date" class="w-full bg-[#141724] border border-white/10 rounded-xl py-3 pl-10 pr-4 text-white font-bold focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50 transition text-slate-300" style="color-scheme: dark;">
                            </div>
                        </div>
                    </div>
        `,
                showCancelButton: true,
                confirmButtonText: 'Crear Meta',
                confirmButtonColor: '#6366F1',
                cancelButtonText: 'Cancelar',
                cancelButtonColor: '#334155',
                width: '400px',
                padding: '2rem',
                customClass: {
                    popup: 'rounded-[2rem] border border-white/10 shadow-2xl glass-panel',
                    actions: 'gap-3 mt-6'
                },
                didOpen: () => lucide.createIcons(),
                preConfirm: () => {
                    const name = document.getElementById('swal-goal-name').value;
                    const target = document.getElementById('swal-goal-target').value;
                    const date = document.getElementById('swal-goal-date').value;
                    if (!name || !target || !date) {
                        Swal.showValidationMessage('Todos los campos son obligatorios');
                    }
                    return [name, target, date];
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const [name, target, date] = result.value;
                    if (name && target) {
                        initSavingsData();
                        const newId = Date.now();
                        appState.goals.push({
                            id: newId,
                            name: name,
                            target: parseFloat(target),
                            current: 0,
                            deadline: date,
                            icon: 'flag',
                            bgClass: 'bg-indigo-500/20',
                            colorClass: 'text-indigo-400'
                        });
                        saveState();
                        renderSavingsTab();
                        Swal.fire({ icon: 'success', title: 'Meta Creada', toast: true, position: 'top', timer: 1500, showConfirmButton: false, background: '#1E293B', color: '#fff' });
                    }
                }
            });
        }

        // --- GOAL MANAGEMENT (UNIFIED "WEALTH ACCUMULATION" MECHANIC) ---
        // --- GOAL MANAGEMENT (UNIFIED "WEALTH ACCUMULATION" MECHANIC) ---
        function manageGoal(id) {

            // UNIVERSAL HISTORY FIX (GOALS)
            const goalFix = appState.goals.find(g => g.id === id);
            if (goalFix && goalFix.current > 0 && (!goalFix.history || goalFix.history.length === 0)) {
                if (!goalFix.history) goalFix.history = [];
                goalFix.history.push({
                    date: new Date().toISOString(),
                    amount: goalFix.current,
                    description: 'Balance Inicial'
                });
                saveState();
            }

            const goal = appState.goals.find(g => g.id === id);
            if (!goal) return;

            // 1. Retroactive History Fix for old goals
            if (goal.current > 0 && (!goal.history || goal.history.length === 0)) {
                goal.history = [{
                    date: new Date().toISOString(),
                    amount: goal.current
                }];
            }
            if (!goal.history) goal.history = [];

            const pct = Math.min(100, Math.round((goal.current / goal.target) * 100));
            const remaining = Math.max(0, goal.target - goal.current);
            const icon = goal.icon || 'flag';

            // Calculate "Needed Monthly" if deadline exists
            let neededMonthlyMsg = '---';
            if (goal.deadline) {
                const today = new Date();
                const dDate = new Date(goal.deadline);
                const months = (dDate.getFullYear() - today.getFullYear()) * 12 + (dDate.getMonth() - today.getMonth());
                if (months > 0 && remaining > 0) {
                    neededMonthlyMsg = formatCurrency(remaining / months) + ' / mes';
                } else if (remaining <= 0) {
                    neededMonthlyMsg = '¡Meta Lograda!';
                } else {
                    neededMonthlyMsg = 'Vence pronto';
                }
            }

            Swal.fire({
                title: ' ',
                background: '#0B0D14',
                color: '#fff',
                scrollbarPadding: false,
                html: `
            < !--HEADER -->
                    <div class="flex flex-col items-center gap-1 -mt-6 mb-6">
                        <div onclick="event.stopPropagation(); selectGoalIcon(${id})" class="w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-500/20 to-purple-500/20 flex items-center justify-center mb-3 border border-indigo-500/30 shadow-[0_0_30px_rgba(99,102,241,0.3)] cursor-pointer hover:scale-105 transition group">
                            <i data-lucide="${icon}" class="w-8 h-8 text-indigo-500 group-hover:animate-pulse"></i>
                            <div class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-2xl opacity-0 group-hover:opacity-100 transition">
                                <i data-lucide="edit-2" class="w-4 h-4 text-white"></i>
                            </div>
                        </div>
                        <h2 class="text-3xl font-black text-white tracking-tight leading-none">${goal.name}</h2>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-[0.2em] mt-1">Gestión de Metas</p>
                    </div>

                    <div class="text-left space-y-6">
                        
                        <!-- MAIN STATUS CARD -->
                        <div class="p-6 bg-[#141724] rounded-3xl border border-white/5 relative overflow-hidden shadow-2xl group">
                             <div class="absolute top-0 right-0 w-40 h-40 bg-gradient-to-bl from-indigo-500/10 to-transparent rounded-bl-full -mr-10 -mt-10 pointer-events-none"></div>
                            
                            <div class="relative z-10 text-center">
                                 <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mb-2">Progreso Actual</p>
                                 <h3 class="text-5xl font-black text-white tracking-tighter drop-shadow-lg">${formatCurrency(goal.current)}</h3>
                                 <p class="text-xs text-indigo-400 font-bold mt-1">de ${formatCurrency(goal.target)}</p>
                                 
                                 <!-- Progress Bar -->
                                 <div class="w-3/4 mx-auto h-2 bg-black/40 rounded-full overflow-hidden border border-white/5 mt-4 relative">
                                    <div class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-1000 shadow-[0_0_10px_rgba(99,102,241,0.5)]" style="width: ${pct}%"></div>
                                 </div>
                                 <p class="text-[9px] text-slate-500 mt-2 font-mono">${pct}% Completado</p>

                                 <div class="mt-5 flex justify-center gap-4">
                                     <button onclick="handleGoalTransaction(${id}, 'deposit')" class="px-6 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-bold text-xs uppercase tracking-wider transition shadow-lg shadow-indigo-500/20 flex items-center gap-2 transform active:scale-95">
                                        <i data-lucide="plus" class="w-4 h-4"></i> Abonar
                                     </button>
                                     <button onclick="handleGoalTransaction(${id}, 'withdraw')" class="px-6 py-2 rounded-xl bg-red-500/10 border border-red-500/20 hover:bg-red-500/20 text-red-500 font-bold text-xs uppercase tracking-wider transition flex items-center gap-2 transform active:scale-95">
                                        <i data-lucide="minus" class="w-4 h-4"></i> Retirar
                                     </button>
                                 </div>
                            </div>
                        </div>

                        <!-- PLANNING INFO -->
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-[#1e293b]/50 p-4 rounded-2xl border border-white/5 text-center">
                                <p class="text-[9px] text-slate-500 font-bold uppercase">Falta para la meta</p>
                                <p class="text-lg font-black text-white">${formatCurrency(remaining)}</p>
                            </div>
                            <div class="bg-[#1e293b]/50 p-4 rounded-2xl border border-white/5 text-center">
                                <p class="text-[9px] text-slate-500 font-bold uppercase">Ahorro Mensual Esp.</p>
                                <p class="text-lg font-black text-emerald-400">${neededMonthlyMsg}</p>
                            </div>
                        </div>
                        
                        <!-- PROJECTION CALCULATOR (REQUESTED ITEM) -->
                        <div class="bg-[#141724] p-5 rounded-3xl border border-white/5">
                             <label class="block text-[10px] font-black text-indigo-400 mb-4 uppercase tracking-widest flex items-center gap-2">
                                <i data-lucide="trending-up" class="w-3.5 h-3.5"></i> Proyección de Crecimiento
                             </label>
                             <div class="flex gap-3 items-end">
                                <div class="flex-1">
                                    <label class="text-[9px] text-slate-500 font-bold uppercase block mb-1">Abono Mensual</label>
                                    <input id="gp-monthly" type="number" placeholder="0" class="w-full bg-[#0B0D14] border border-white/10 rounded-xl px-3 py-2 text-white text-xs font-bold focus:border-indigo-500 focus:outline-none transition">
                                </div>
                                <div class="flex-1">
                                    <label class="text-[9px] text-slate-500 font-bold uppercase block mb-1">Meses</label>
                                    <input id="gp-months" type="number" placeholder="12" value="12" class="w-full bg-[#0B0D14] border border-white/10 rounded-xl px-3 py-2 text-white text-xs font-bold focus:border-indigo-500 focus:outline-none transition">
                                </div>
                                <button onclick="calculateGoalProjection(${goal.current})" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-xl font-bold text-xs transition h-[38px] shadow-lg shadow-indigo-500/20">
                                    <i data-lucide="calculator" class="w-4 h-4"></i>
                                </button>
                             </div>
                             <div id="gp-result" class="mt-4 p-3 bg-indigo-500/10 rounded-xl border border-indigo-500/20 text-center hidden">
                                <span class="text-[10px] text-indigo-300 font-bold uppercase">Valor Futuro Estimado</span>
                                <div id="gp-val" class="text-xl font-black text-indigo-400">---</div>
                             </div>
                        </div>

                        <!-- SETTINGS -->
                        <div class="space-y-4 pt-2">
                             <div class="flex items-center gap-3 px-1 opacity-60">
                                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-[0.2em] flex items-center gap-2"><i data-lucide="sliders" class="w-3 h-3"></i> Configuración</span>
                                <div class="h-px flex-1 bg-gradient-to-r from-transparent via-slate-600 to-transparent"></div>
                             </div>

                             <div class="group">
                                <label class="text-[9px] text-slate-500 font-bold uppercase mb-1.5 block pl-1">Nombre Meta</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i data-lucide="tag" class="w-3.5 h-3.5 text-slate-600 group-hover:text-slate-400 transition"></i>
                                    </div>
                                    <input id="mg-name" value="${goal.name}" class="w-full bg-[#141724] border border-white/5 hover:border-white/10 rounded-xl pl-9 pr-3 py-2.5 text-slate-200 text-xs font-bold focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/20 focus:bg-[#0B0D14] focus:outline-none transition">
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="group">
                                    <label class="text-[9px] text-slate-500 font-bold uppercase mb-1.5 block pl-1">Objetivo ($)</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i data-lucide="target" class="w-3.5 h-3.5 text-slate-600 group-hover:text-slate-400 transition"></i>
                                        </div>
                                        <input id="mg-target" type="number" value="${goal.target}" class="w-full bg-[#141724] border border-white/5 hover:border-white/10 rounded-xl pl-9 pr-3 py-2.5 text-slate-200 text-xs font-bold focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/20 focus:bg-[#0B0D14] focus:outline-none transition">
                                    </div>
                                </div>
                                <div class="group">
                                     <label class="text-[9px] text-slate-500 font-bold uppercase mb-1.5 block pl-1">Fecha Límite</label>
                                     <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i data-lucide="calendar" class="w-3.5 h-3.5 text-slate-600 group-hover:text-slate-400 transition"></i>
                                        </div>
                                        <input id="mg-date" type="date" value="${goal.deadline}" class="w-full bg-[#141724] border border-white/5 hover:border-white/10 rounded-xl pl-9 pr-3 py-2.5 text-slate-300 text-xs font-bold focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/20 focus:bg-[#0B0D14] focus:outline-none transition" style="color-scheme: dark;">
                                     </div>
                                </div>
                            </div>
                        </div>

                        <!-- HISTORY LIST -->
                        <div class="pt-2">
                             <div class="flex items-center justify-between mb-3 px-1">
                                <span class="text-[9px] font-bold text-slate-500 uppercase tracking-widest"><i data-lucide="history" class="w-3 h-3 inline mr-1"></i> Historial</span>
                            </div>
                            <div class="space-y-2 max-h-[150px] overflow-y-auto custom-scrollbar pr-1">
                                ${goal.history.length === 0 ? '<div class="py-6 flex flex-col items-center justify-center opacity-40"><i data-lucide="clock" class="w-8 h-8 mb-2"></i><p class="text-xs text-slate-400">Sin movimientos</p></div>' :
                        [...goal.history].map((h, originalIdx) => ({ ...h, idx: originalIdx })).reverse().map(h => `
                                    <div onclick="event.stopPropagation(); editGoalHistory(${id}, ${h.idx})" class="flex justify-between items-center p-3 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 transition cursor-pointer group">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-full ${h.amount >= 0 ? 'bg-indigo-500/20 text-indigo-400' : 'bg-red-500/20 text-red-400'} flex items-center justify-center group-hover:scale-110 transition">
                                                <i data-lucide="${h.amount >= 0 ? 'arrow-up-right' : 'arrow-down-left'}" class="w-4 h-4"></i>
                                            </div>
                                            <div>
                                                 <p class="text-[10px] text-slate-400 font-bold uppercase">${h.description || "Abono"}</p>
                                                 <p class="text-[10px] text-slate-500 font-mono">${new Date(h.date).toLocaleDateString()}</p>
                                            </div>
                                        </div>
                                        <span class="text-xs font-bold ${h.amount >= 0 ? 'text-indigo-400' : 'text-red-400'}">${h.amount >= 0 ? '+' : ''}${formatCurrency(h.amount)}</span>
                                    </div>
                                  `).join('')}
                            </div>
                        </div>

                    </div>
        `,
                showConfirmButton: true,
                confirmButtonText: '<i class="fa fa-save"></i> Guardar Cambios',
                showDenyButton: true,
                denyButtonText: 'Eliminar',
                showCancelButton: true,
                cancelButtonText: 'Cerrar',
                buttonsStyling: false,
                width: '450px',
                padding: '0 0 2rem 0', // Remove top padding to let header flush, add bottom
                customClass: {
                    popup: 'rounded-[2.5rem] border border-white/10 shadow-2xl overflow-hidden glass-panel',
                    htmlContainer: '!m-0 !p-0', // Reset container padding
                    actions: 'w-full grid grid-cols-2 gap-3 px-8 pb-6', // Grid layout for buttons
                    confirmButton: 'col-span-2 bg-gradient-to-r from-indigo-600 to-indigo-500 hover:from-indigo-500 hover:to-indigo-400 text-white py-3.5 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg shadow-indigo-500/20 transition transform hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-2',
                    denyButton: 'bg-red-500/10 border border-red-500/20 hover:bg-red-500/20 text-red-500 py-3 rounded-xl font-bold text-[10px] uppercase tracking-wider transition flex items-center justify-center gap-2',
                    cancelButton: 'bg-slate-700/30 border border-white/5 hover:bg-slate-700/50 text-slate-400 hover:text-white py-3 rounded-xl font-bold text-[10px] uppercase tracking-wider transition'
                },
                didOpen: () => lucide.createIcons(),
                preConfirm: () => {
                    return {
                        name: document.getElementById('mg-name').value,
                        target: document.getElementById('mg-target').value,
                        deadline: document.getElementById('mg-date').value
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const d = result.value;
                    if (d.name && d.target) {
                        goal.name = d.name;
                        goal.target = parseFloat(d.target);
                        goal.deadline = d.deadline;
                        saveState();
                        renderSavingsTab();
                        Swal.fire({ icon: 'success', title: 'Guardado', toast: true, position: 'top', timer: 1500, showConfirmButton: false, background: '#1E293B', color: '#fff' });
                    }
                } else if (result.isDenied) {
                    Swal.fire({
                        title: '¿Eliminar Meta?', text: "Se perderá el registro.", icon: 'warning',
                        background: '#0f172a', color: '#fff', showCancelButton: true,
                        confirmButtonColor: '#ef4444', cancelButtonColor: '#334155', confirmButtonText: 'Sí, eliminar'
                    }).then((r) => {
                        if (r.isConfirmed) {
                            appState.goals = appState.goals.filter(g => g.id !== id);
                            saveState();
                            renderSavingsTab();
                            Swal.fire({ title: 'Eliminado', icon: 'success', background: '#0f172a', color: '#fff', timer: 1500, showConfirmButton: false });
                        }
                    });
                }
            });

            // WINDOW HELPERS for Goal Scope
            window.calculateGoalProjection = (base) => {
                const monthly = parseFloat(document.getElementById('gp-monthly').value) || 0;
                const months = parseFloat(document.getElementById('gp-months').value) || 0;
                const total = base + (monthly * months);
                const el = document.getElementById('gp-result');
                const pVal = document.getElementById('gp-val');
                if (el && pVal) {
                    el.classList.remove('hidden');
                    pVal.innerText = formatCurrency(total);
                }
            };

            window.selectGoalIcon = (gId) => {
                const icons = ['flag', 'target', 'trophy', 'rocket', 'plane', 'car', 'home', 'star', 'heart', 'camera', 'gamepad-2', 'gift', 'shopping-cart', 'monitor', 'smartphone'];
                Swal.fire({
                    title: 'Selecciona un Icono',
                    html: `
            < div class="grid grid-cols-5 gap-4 p-2" >
                ${icons.map(ic => `
                                <div onclick="window.confirmGoalIcon('${gId}', '${ic}')" class="w-10 h-10 rounded-xl bg-white/5 hover:bg-indigo-500/20 hover:text-indigo-400 flex items-center justify-center cursor-pointer transition">
                                    <i data-lucide="${ic}" class="w-5 h-5"></i>
                                </div>
                            `).join('')
                        }
                        </div >
            `,
                    background: '#1E293B', color: '#fff',
                    scrollbarPadding: false,
                    showConfirmButton: false,
                    didOpen: () => lucide.createIcons()
                });
            };

            window.confirmGoalIcon = (gId, iconName) => {
                const goal = appState.goals.find(g => g.id == gId);
                if (goal) {
                    goal.icon = iconName;
                    saveState();
                    renderSavingsTab();
                }
                Swal.close(); // Close icon picker
                manageGoal(parseInt(gId)); // Re-open management
            };

            window.handleGoalTransaction = (gId, action) => {
                Swal.fire({
                    title: action === 'deposit' ? 'Abonar a la Meta' : 'Retirar de la Meta',
                    html: `
            < div class="relative mt-4 mb-2" >
                             <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <span class="text-slate-500 font-bold">$</span>
                             </div>
                             <input id="goal-txn-amount" type="number" class="w-full bg-[#1e293b] border border-white/10 rounded-xl pl-8 pr-4 py-3 text-white font-bold focus:outline-none focus:border-${action === 'deposit' ? 'indigo' : 'red'}-500 transition placeholder-slate-600" placeholder="0.00">
                        </div>
        `,
                    background: '#0B0D14', color: '#fff', scrollbarPadding: false,
                    confirmButtonText: 'CONFIRMAR', confirmButtonColor: action === 'deposit' ? '#6366f1' : '#ef4444',
                    showCancelButton: true, cancelButtonColor: '#334155',
                    preConfirm: () => document.getElementById('goal-txn-amount').value
                }).then((r) => {
                    if (r.isConfirmed && r.value) {
                        const val = parseFloat(r.value);
                        if (!val || val <= 0) return;

                        const amount = action === 'deposit' ? val : -val;
                        const date = new Date().toISOString();

                        const g = appState.goals.find(x => x.id === gId);
                        if (g) {
                            g.current += amount;
                            if (g.current < 0) g.current = 0;
                            if (!g.history) g.history = [];
                            g.history.push({ date, amount });

                            saveState();
                            renderSavingsTab();
                            Swal.close();
                            setTimeout(() => manageGoal(gId), 300);
                        }
                    }
                });
            };

            window.editGoalHistory = (gId, hIdx) => {
                const g = appState.goals.find(x => x.id === gId);
                if (!g || !g.history[hIdx]) return;
                const item = g.history[hIdx];
                const dateObj = new Date(item.date);
                const dateYMD = dateObj.toISOString().split('T')[0];
                const h = String(dateObj.getHours()).padStart(2, '0');
                const m = String(dateObj.getMinutes()).padStart(2, '0');
                const desc = item.description || 'Abono';

                Swal.fire({
                    title: ' ', background: '#0B0D14', color: '#fff', scrollbarPadding: false,
                    html: `
            < div class="flex flex-col items-center gap-1 -mt-6 mb-6" >
                            <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-500/20 to-purple-500/20 flex items-center justify-center mb-3 border border-indigo-500/30 shadow-[0_0_30px_rgba(99,102,241,0.3)]">
                                <i data-lucide="edit" class="w-8 h-8 text-indigo-400"></i>
                            </div>
                            <h2 class="text-2xl font-black text-white tracking-tight leading-none">Editar Abono</h2>
                            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-[0.2em]">Registro Histórico</p>
                        </div >
            <div class="space-y-4 text-left px-2">
                <div class="group">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Concepto</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="file-text" class="w-4 h-4 text-slate-500"></i></div>
                        <input id="gh-desc" type="text" value="${desc}" class="w-full bg-[#141724] border border-white/10 rounded-xl pl-9 pr-4 py-3 text-white font-bold transition focus:outline-none focus:border-indigo-500">
                    </div>
                </div>
                <div class="group">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Monto ($)</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="dollar-sign" class="w-4 h-4 text-indigo-500"></i></div>
                        <input id="gh-amt" type="number" value="${Math.abs(item.amount)}" class="w-full bg-[#141724] border border-white/10 rounded-xl pl-9 pr-4 py-3 text-white font-bold transition focus:outline-none focus:border-indigo-500">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="group">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Fecha</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="calendar" class="w-4 h-4 text-slate-500"></i></div>
                            <input id="gh-date" type="date" value="${dateYMD}" class="w-full bg-[#141724] border border-white/10 rounded-xl pl-9 pr-3 py-3 text-white font-bold transition focus:outline-none focus:border-indigo-500" style="color-scheme: dark;">
                        </div>
                    </div>
                    <div class="group">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Hora</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="clock" class="w-4 h-4 text-slate-500"></i></div>
                            <input id="gh-time" type="time" value="${h}:${m}" class="w-full bg-[#141724] border border-white/10 rounded-xl pl-9 pr-3 py-3 text-white font-bold transition focus:outline-none focus:border-indigo-500" style="color-scheme: dark;">
                        </div>
                    </div>
                </div>
            </div>
        `,
                    showDenyButton: true, denyButtonText: 'Eliminar',
                    confirmButtonText: '<i class="fa fa-save"></i> Guardar Cambios',
                    showCancelButton: true, cancelButtonText: 'Cerrar',
                    width: '400px', padding: '0 0 2rem 0',
                    buttonsStyling: false,
                    customClass: {
                        popup: 'rounded-[2rem] border border-white/10 shadow-2xl glass-panel',
                        htmlContainer: '!m-0 !p-0',
                        actions: 'w-full grid grid-cols-2 gap-3 px-6 mt-4',
                        confirmButton: 'col-span-2 bg-gradient-to-r from-indigo-600 to-indigo-500 hover:from-indigo-500 hover:to-indigo-400 text-white py-3 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg shadow-indigo-500/20 transition transform hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-2',
                        denyButton: 'bg-red-500/10 border border-red-500/20 hover:bg-red-500/20 text-red-500 py-2.5 rounded-xl font-bold text-[10px] uppercase tracking-wider transition',
                        cancelButton: 'bg-slate-700/30 border border-white/5 hover:bg-slate-700/50 text-slate-400 hover:text-white py-2.5 rounded-xl font-bold text-[10px] uppercase tracking-wider transition'
                    },
                    didOpen: () => lucide.createIcons(),
                }).then((r) => {
                    if (r.isConfirmed) {
                        const newAmt = parseFloat(document.getElementById('gh-amt').value);
                        const newDesc = document.getElementById('gh-desc').value;
                        const dStr = document.getElementById('gh-date').value;
                        const tStr = document.getElementById('gh-time').value;
                        if (newAmt && dStr && tStr) {
                            const sign = item.amount >= 0 ? 1 : -1;
                            const finalAmt = Math.abs(newAmt) * sign;
                            const diff = finalAmt - item.amount;

                            item.amount = finalAmt;
                            item.description = newDesc; // Save Description
                            item.date = new Date(`${dStr}T${tStr} `).toISOString();
                            g.current += diff;
                            if (g.current < 0) g.current = 0;

                            saveState(); renderSavingsTab(); Swal.close();
                            setTimeout(() => manageGoal(gId), 200);
                        }
                    } else if (r.isDenied) {
                        g.current -= item.amount;
                        if (g.current < 0) g.current = 0;
                        g.history.splice(hIdx, 1);
                        saveState(); renderSavingsTab(); Swal.close();
                        setTimeout(() => manageGoal(gId), 200);
                    }
                });
            };
        }

        function fireConfetti() {
            if (typeof confetti === 'function') {
                confetti({
                    particleCount: 150,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#34D399', '#6366F1', '#F472B6']
                });
            }
        }

        // Restore Settings on Load
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof appState !== 'undefined' && appState.settings) {
                if (appState.settings.radiusMode) setAppRadius(appState.settings.radiusMode);
                if (appState.settings.blurVal) {
                    const el = document.getElementById('setting-blur-slider');
                    if (el) el.value = appState.settings.blurVal;
                    setAppBlur(appState.settings.blurVal);
                }
                if (appState.settings.densityVal) {
                    const el = document.getElementById('setting-density-slider');
                    if (el) el.value = appState.settings.densityVal;
                    setAppDensity(appState.settings.densityVal);
                }
                if (appState.settings.fontMode) {
                    setAppFont(appState.settings.fontMode);
                }

                // Restore Colors
                if (appState.settings.gradientStart) {
                    // 1. Set State
                    if (typeof currentGradient === 'undefined') window.currentGradient = { start: '#6366F1', end: '#A855F7' };
                    currentGradient.start = appState.settings.gradientStart;
                    document.documentElement.style.setProperty('--color-primary', currentGradient.start);

                    // 2. Highlight Button
                    const allButtons = document.querySelectorAll('button[onclick^="setThemeColorEnhanced"]');
                    allButtons.forEach(btn => {
                        const onclickStr = btn.getAttribute('onclick');
                        if ((onclickStr.includes("'primary'") || onclickStr.includes('"primary"')) &&
                            (onclickStr.includes(`'${currentGradient.start}'`) || onclickStr.includes(`"${currentGradient.start}"`))) {
                            btn.classList.add('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-[#1a1d2e]', 'scale-110');
                        }
                    });
                }

                if (appState.settings.gradientEnd) {
                    // 1. Set State
                    if (typeof currentGradient === 'undefined') window.currentGradient = { start: '#6366F1', end: '#A855F7' };
                    currentGradient.end = appState.settings.gradientEnd;
                    document.documentElement.style.setProperty('--color-secondary', currentGradient.end);

                    // 2. Highlight Button
                    const allButtons = document.querySelectorAll('button[onclick^="setThemeColorEnhanced"]');
                    allButtons.forEach(btn => {
                        const onclickStr = btn.getAttribute('onclick');
                        if ((onclickStr.includes("'secondary'") || onclickStr.includes('"secondary"')) &&
                            (onclickStr.includes(`'${currentGradient.end}'`) || onclickStr.includes(`"${currentGradient.end}"`))) {
                            btn.classList.add('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-[#1a1d2e]', 'scale-110');
                        }
                    });
                }

                if (typeof updateGradientPreview === 'function') setTimeout(updateGradientPreview, 100);
            }
        });

        // Injected Helper: editAssetHistory
        window.editAssetHistory = (tType, tId, hIdx) => {
            let historyArr = null;
            if (tType === 'core') {
                if (appState.assetMeta && appState.assetMeta[tId] && appState.assetMeta[tId].history) {
                    historyArr = appState.assetMeta[tId].history;
                }
            } else {
                if (appState.customAssets && appState.customAssets[tId] && appState.customAssets[tId].history) {
                    historyArr = appState.customAssets[tId].history;
                }
            }

            if (!historyArr || !historyArr[hIdx]) {
                console.warn("History item not found:", tType, tId, hIdx);
                return;
            }

            const item = historyArr[hIdx];
            const dateObj = new Date(item.date);
            const dateYMD = dateObj.toISOString().split('T')[0];
            const h = String(dateObj.getHours()).padStart(2, '0');
            const m = String(dateObj.getMinutes()).padStart(2, '0');
            const desc = item.description || 'Movimiento';

            Swal.fire({
                title: ' ',
                background: '#0B0D14',
                color: '#fff',
                scrollbarPadding: false,
                buttonsStyling: false,
                customClass: {
                    popup: 'rounded-[2rem] border border-white/10 shadow-2xl glass-panel',
                    htmlContainer: '!m-0 !p-0',
                    actions: 'w-full grid grid-cols-2 gap-3 px-6 mt-4',
                    confirmButton: 'col-span-2 bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-500 hover:to-emerald-400 text-white py-3 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg shadow-emerald-500/20 transition transform hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-2',
                    denyButton: 'bg-red-500/10 border border-red-500/20 hover:bg-red-500/20 text-red-500 py-2.5 rounded-xl font-bold text-[10px] uppercase tracking-wider transition',
                    cancelButton: 'bg-slate-700/30 border border-white/5 hover:bg-slate-700/50 text-slate-400 hover:text-white py-2.5 rounded-xl font-bold text-[10px] uppercase tracking-wider transition'
                },
                html: `
            < !--HEADER -->
                    <div class="flex flex-col items-center gap-1 -mt-6 mb-6">
                        <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-emerald-500/20 to-teal-500/20 flex items-center justify-center mb-3 border border-emerald-500/30 shadow-[0_0_30px_rgba(16,185,129,0.3)]">
                            <i data-lucide="edit" class="w-8 h-8 text-emerald-500"></i>
                        </div>
                        <h2 class="text-2xl font-black text-white tracking-tight leading-none">Editar Movimiento</h2>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-[0.2em]">Registro Histórico</p>
                    </div>
                    
                    <div class="space-y-4 text-left px-2">
                         <div class="group">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Concepto</label>
                            <div class="relative">
                                 <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="file-text" class="w-4 h-4 text-slate-500"></i></div>
                                <input id="edit-ah-desc" type="text" value="${desc}" class="w-full bg-[#141724] border border-white/10 rounded-xl pl-9 pr-4 py-3 text-white font-bold transition focus:outline-none focus:border-emerald-500">
                            </div>
                         </div>
                         <div class="group">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Monto ($)</label>
                            <div class="relative">
                                 <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="dollar-sign" class="w-4 h-4 text-emerald-500"></i></div>
                                <input id="edit-ah-amt" type="number" value="${Math.abs(item.amount)}" class="w-full bg-[#141724] border border-white/10 rounded-xl pl-9 pr-4 py-3 text-white font-bold transition focus:outline-none focus:border-emerald-500">
                            </div>
                         </div>
                         <div class="grid grid-cols-2 gap-3">
                             <div class="group">
                                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Fecha</label>
                                <div class="relative">
                                     <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="calendar" class="w-4 h-4 text-slate-500"></i></div>
                                    <input id="edit-ah-date" type="date" value="${dateYMD}" class="w-full bg-[#141724] border border-white/10 rounded-xl pl-9 pr-3 py-3 text-white font-bold transition focus:outline-none focus:border-emerald-500" style="color-scheme: dark;">
                                </div>
                             </div>
                             <div class="group">
                                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Hora</label>
                                <div class="relative">
                                     <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="clock" class="w-4 h-4 text-slate-500"></i></div>
                                    <input id="edit-ah-time" type="time" value="${h}:${m}" class="w-full bg-[#141724] border border-white/10 rounded-xl pl-9 pr-3 py-3 text-white font-bold transition focus:outline-none focus:border-emerald-500" style="color-scheme: dark;">
                                </div>
                             </div>
                         </div>
                    </div>
        `,
                showDenyButton: true, denyButtonText: 'Eliminar',
                confirmButtonText: '<i class="fa fa-save"></i> Guardar Cambios',
                showCancelButton: true, cancelButtonText: 'Cerrar',
                didOpen: () => lucide.createIcons(),
            }).then((r) => {
                if (r.isConfirmed) {
                    const newAmtVal = parseFloat(document.getElementById('edit-ah-amt').value);
                    const newDesc = document.getElementById('edit-ah-desc').value;
                    const dStr = document.getElementById('edit-ah-date').value;
                    const tStr = document.getElementById('edit-ah-time').value;

                    if (newAmtVal) {
                        const sign = item.amount >= 0 ? 1 : -1;
                        const finalAmount = Math.abs(newAmtVal) * sign;
                        const diff = finalAmount - item.amount;

                        item.amount = finalAmount;
                        item.description = newDesc;
                        item.date = new Date(`${dStr}T${tStr} `).toISOString();

                        // Update Balance logic
                        if (tType === 'core') {
                            appState.balanceAccounts[tId] = (appState.balanceAccounts[tId] || 0) + diff;
                            if (appState.balanceAccounts[tId] < 0) appState.balanceAccounts[tId] = 0;
                        } else {
                            appState.customAssets[tId].amount += diff;
                            if (appState.customAssets[tId].amount < 0) appState.customAssets[tId].amount = 0;
                        }

                        saveState(); renderSavingsTab(); Swal.close();
                        setTimeout(() => manageAsset(tType, tId), 200);
                    }
                } else if (r.isDenied) {
                    if (tType === 'core') {
                        appState.balanceAccounts[tId] -= item.amount;
                        if (appState.balanceAccounts[tId] < 0) appState.balanceAccounts[tId] = 0;
                    } else {
                        appState.customAssets[tId].amount -= item.amount;
                        if (appState.customAssets[tId].amount < 0) appState.customAssets[tId].amount = 0;
                    }
                    historyArr.splice(hIdx, 1);
                    saveState(); renderSavingsTab(); Swal.close();
                    setTimeout(() => manageAsset(tType, tId), 200);
                }
            });
        };

        window.editGoalHistory = (gId, hIdx) => {
            const goal = appState.goals.find(g => g.id == gId);
            if (!goal || !goal.history || !goal.history[hIdx]) return;

            const item = goal.history[hIdx];
            const dateObj = new Date(item.date);
            const dateYMD = dateObj.toISOString().split('T')[0];
            const h = String(dateObj.getHours()).padStart(2, '0');
            const m = String(dateObj.getMinutes()).padStart(2, '0');
            const desc = item.description || 'Abono';

            Swal.fire({
                title: ' ',
                background: '#0B0D14',
                color: '#fff',
                scrollbarPadding: false,
                html: `
            < div class="flex flex-col items-center gap-1 -mt-6 mb-6" >
                        <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-500/20 to-purple-500/20 flex items-center justify-center mb-3 border border-indigo-500/30">
                            <i data-lucide="edit" class="w-8 h-8 text-indigo-500"></i>
                        </div>
                        <h2 class="text-2xl font-black text-white tracking-tight leading-none">Editar Movimiento</h2>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-[0.2em] mt-1">Historial de Meta</p>
                    </div >

            <div class="space-y-4 text-left px-2">
                <div class="group">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Concepto</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="file-text" class="w-4 h-4 text-slate-500"></i></div>
                        <input id="edit-gh-desc" type="text" value="${desc}" class="w-full bg-[#141724] border border-white/10 rounded-xl pl-9 pr-4 py-3 text-white font-bold transition focus:outline-none focus:border-indigo-500">
                    </div>
                </div>
                <div class="group">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Monto ($)</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="dollar-sign" class="w-4 h-4 text-indigo-500"></i></div>
                        <input id="edit-gh-amt" type="number" value="${Math.abs(item.amount)}" class="w-full bg-[#141724] border border-white/10 rounded-xl pl-9 pr-4 py-3 text-white font-bold transition focus:outline-none focus:border-indigo-500">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="group">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Fecha</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="calendar" class="w-4 h-4 text-slate-500"></i></div>
                            <input id="edit-gh-date" type="date" value="${dateYMD}" class="w-full bg-[#141724] border border-white/10 rounded-xl pl-9 pr-3 py-3 text-white font-bold transition focus:outline-none focus:border-indigo-500" style="color-scheme: dark;">
                        </div>
                    </div>
                    <div class="group">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">Hora</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="clock" class="w-4 h-4 text-slate-500"></i></div>
                            <input id="edit-gh-time" type="time" value="${h}:${m}" class="w-full bg-[#141724] border border-white/10 rounded-xl pl-9 pr-3 py-3 text-white font-bold transition focus:outline-none focus:border-indigo-500" style="color-scheme: dark;">
                        </div>
                    </div>
                </div>
            </div>
        `,
                showDenyButton: true, denyButtonText: 'Eliminar',
                confirmButtonText: '<i class="fa fa-save"></i> Guardar Cambios',
                showCancelButton: true, cancelButtonText: 'Cerrar',
                buttonsStyling: false,
                customClass: {
                    popup: 'rounded-[2rem] border border-white/10 shadow-2xl glass-panel',
                    htmlContainer: '!m-0 !p-0',
                    actions: 'w-full grid grid-cols-2 gap-3 px-6 mt-4',
                    confirmButton: 'col-span-2 bg-gradient-to-r from-indigo-600 to-indigo-500 hover:from-indigo-500 hover:to-indigo-400 text-white py-3 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg shadow-indigo-500/20 transition transform hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-2',
                    denyButton: 'bg-red-500/10 border border-red-500/20 hover:bg-red-500/20 text-red-500 py-2.5 rounded-xl font-bold text-[10px] uppercase tracking-wider transition',
                    cancelButton: 'bg-slate-700/30 border border-white/5 hover:bg-slate-700/50 text-slate-400 hover:text-white py-2.5 rounded-xl font-bold text-[10px] uppercase tracking-wider transition'
                },
                didOpen: () => lucide.createIcons(),
            }).then((r) => {
                if (r.isConfirmed) {
                    const newAmtVal = parseFloat(document.getElementById('edit-gh-amt').value);
                    const newDesc = document.getElementById('edit-gh-desc').value;
                    const dStr = document.getElementById('edit-gh-date').value;
                    const tStr = document.getElementById('edit-gh-time').value;

                    if (newAmtVal) {
                        const sign = item.amount >= 0 ? 1 : -1;
                        const finalAmount = Math.abs(newAmtVal) * sign;

                        // Update Goal Current using difference
                        const diff = finalAmount - item.amount;
                        goal.current += diff;
                        if (goal.current < 0) goal.current = 0;
                        // if (goal.current > goal.target) goal.current = goal.target; // Optional cap

                        item.amount = finalAmount;
                        item.description = newDesc;
                        item.date = new Date(`${dStr}T${tStr} `).toISOString();

                        saveState(); renderSavingsTab(); Swal.close();
                        setTimeout(() => manageGoal(gId), 200);
                    }
                } else if (r.isDenied) {
                    goal.current -= item.amount;
                    if (goal.current < 0) goal.current = 0;

                    goal.history.splice(hIdx, 1);
                    saveState(); renderSavingsTab(); Swal.close();
                    setTimeout(() => manageGoal(gId), 200);
                }
            });
        };


        // Duplicate function removed



        // Function to update Sidebar Today Stats (Fixed Layout) with Robust Date Check
        function updateSidebarCategories() {
            const amountEl = document.getElementById('sidebar-today-amount');
            const countEl = document.getElementById('sidebar-today-count');
            if (!amountEl || !countEl) return;

            const today = new Date();
            // Reset hours to avoid timezone shifting when comparing strict timestamps if needed, 
            // but toDateString() is safest for "Calendar Day" comparison in local time.
            const todayStr = today.toDateString();

            let totalAmount = 0;
            let totalCount = 0;

            if (appState.transactions) {
                appState.transactions.forEach(t => {
                    // Handle flexible date formats
                    // Robust Date Parsing for Filter
                    let raw = t.dateIso || t.id;
                    if (typeof raw === 'string' && raw.length === 10) raw += 'T12:00:00'; // Force middle of day for YYYY-MM-DD
                    const d = new Date(raw);

                    // Check if valid date
                    if (isNaN(d.getTime())) return;

                    // STRICT MATCH: Same Calendar Day
                    if (d.toDateString() === todayStr) {
                        // Check Type
                        if (t.type === 'expense') {
                            totalAmount += Math.abs(t.amount); // Ensure positive
                            totalCount++;
                        }
                    }
                });
            }

            // Render
            amountEl.innerText = formatCurrency(totalAmount);
            countEl.innerText = totalCount;

            // Remove/Add Color Emphasis
            if (totalAmount > 0) {
                amountEl.classList.remove('text-white');
                amountEl.classList.add('text-rose-400');
            } else {
                amountEl.classList.add('text-white');
                amountEl.classList.remove('text-rose-400');
            }
        }

        // Ensure Sidebar Updates on Load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(updateSidebarCategories, 1000);

            // Force Filter to Current Month
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            if (typeof filterWallet === 'function') filterWallet('month', `${yyyy} -${mm}`);
        });
        // Also trigger immediately just in case
        setTimeout(updateSidebarCategories, 2000);

        // Sidebar Wants Logic
        function updateSidebarWants() {
            const pctEl = document.getElementById('sidebar-wants-pct');
            if (!pctEl) return;

            const now = new Date();
            const cm = now.getMonth();
            const cy = now.getFullYear();

            let wantsExp = 0;

            if (appState.transactions) {
                appState.transactions.forEach(t => {
                    if (t.type === 'expense') {
                        // Robust Date Parsing
                        let txDate;
                        if (t.dateIso) txDate = new Date(t.dateIso);
                        else if (t.id && !isNaN(new Date(t.id).getTime())) txDate = new Date(t.id);
                        else if (t.date) txDate = new Date(t.date);
                        else if (typeof t.id === 'number') txDate = new Date(t.id);

                        if (txDate && txDate.getMonth() === cm && txDate.getFullYear() === cy) {
                            if (t.budgetFocus === 'Wants' || t.category === 'Wants' || (t.category && t.category.toLowerCase().includes('want'))) {
                                wantsExp += t.amount;
                            }
                        }
                    }
                });
            }

            // Display Monetary Sum
            if (typeof formatCurrency === 'function') {
                pctEl.innerText = formatCurrency(wantsExp).split('.')[0];
            } else {
                pctEl.innerText = '$' + wantsExp.toLocaleString('en-US', { maximumFractionDigits: 0 });
            }

            // Remove previous percentage coloring
            pctEl.classList.remove('text-rose-400');
        }
        setInterval(updateSidebarWants, 3000); // Periodic Update
        setTimeout(updateSidebarWants, 1000);
    </script>
    <script>
        // FIX: Auto-select current date in Wallet when opening
        (function () {
            const originalSwitchTab = window.switchTab;
            window.switchTab = function (tabId) {
                if (typeof originalSwitchTab === 'function') {
                    originalSwitchTab(tabId);
                }

                if (tabId === 'wallet') {
                    setTimeout(() => {
                        const dateEl = document.getElementById('w-date');
                        if (dateEl) {
                            const now = new Date();
                            const yyyy = now.getFullYear();
                            const mm = String(now.getMonth() + 1).padStart(2, '0');
                            const dd = String(now.getDate()).padStart(2, '0');
                            dateEl.value = `${yyyy} -${mm} -${dd}`;
                        }
                    }, 100);
                }
            };
        })();
    </script>

    <!-- AUTOMATED SETTINGS PERSISTENCE MODULE (Agent Injected & Enhanced v3) -->
    <script>
        (function () {
            console.log("🚀 Initializing Settings Persistence Module (Enhanced v3)...");

            // 1. Ensure appState.settings structure exists
            if (typeof appState !== 'undefined') {
                if (!appState.settings) appState.settings = {};
            }
            if (typeof window.currentGradient === 'undefined') window.currentGradient = { start: '#6366F1', end: '#A855F7' };

            // 2. Override/Define Theme Setter with Persistence
            window.setThemeColorEnhanced = function (type, color) {
                console.log(`🎨 Setting Theme Color: ${type} = ${color} `);

                // Normalize color to Hex if possible or keep as is
                // Update CSS Variable
                const varName = type === 'primary' ? '--color-primary' : '--color-secondary';
                document.documentElement.style.setProperty(varName, color);

                // Update State Object
                if (type === 'primary') window.currentGradient.start = color;
                else window.currentGradient.end = color;

                // Update AppState for Storage
                if (!appState.settings) appState.settings = {};
                if (type === 'primary') appState.settings.gradientStart = color;
                else appState.settings.gradientEnd = color;

                // 2b. Apply Gradient Transition to Body (User Request)
                // Only if user hasn't chosen a custom image wallpaper, or if current wallpaper is already a gradient
                const currentBg = document.body.style.backgroundImage || '';
                const isImage = currentBg.includes('url(');

                if (!isImage) {
                    const start = window.currentGradient.start;
                    const end = window.currentGradient.end;
                    // Create a premium nebula effect
                    const newGradient = `radial - gradient(at 0 % 0 %, ${start}26 0px, transparent 50 %), radial - gradient(at 100 % 0 %, ${end}26 0px, transparent 50 %)`;

                    document.body.style.backgroundImage = newGradient;
                    document.body.style.backgroundColor = '#0B0D14'; // Ensure dark base
                    appState.settings.wallpaperImage = newGradient;
                }

                // Update UI Feedback (Ring on selected button)
                const selector = `button[onclick *= "setThemeColorEnhanced"]`;
                const allBtns = document.querySelectorAll(selector);
                const patchedBtns = document.querySelectorAll('button[data-patched="true"]');

                [...allBtns, ...patchedBtns].forEach(btn => {
                    // Check if this button represents the clicked color
                    let btnColor = btn.style.backgroundColor;
                    if (!btnColor && btn.className.match(/bg-\[(.*?)\]/)) btnColor = btn.className.match(/bg-\[(.*?)\]/)[1];

                    // Compare colors (simple string match)
                    if (btnColor === color || (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(color))) {
                        btn.classList.add('ring-2', 'ring-white', 'scale-110');
                        // Remove ring from others of same type
                        [...allBtns, ...patchedBtns].forEach(other => {
                            if (other !== btn && other.getAttribute('onclick') && other.getAttribute('onclick').includes(type)) {
                                other.classList.remove('ring-2', 'ring-white', 'scale-110');
                            }
                        });
                    }
                });

                // Trigger Preview Update if available
                if (typeof updateGradientPreview === 'function') updateGradientPreview();

                // SAVE STATE
                if (typeof saveState === 'function') saveState();
            };

            // 3. Override Radius Setter
            window.setAppRadius = function (mode) {
                const radiusMap = { 'square': '0px', 'subtle': '8px', 'modern': '16px', 'playful': '24px' };
                const val = radiusMap[mode] || '16px';
                document.documentElement.style.setProperty('--radius-app', val);

                // Update UI Active State
                const buttons = document.querySelectorAll('button');
                buttons.forEach(b => {
                    const txt = b.innerText.toLowerCase();
                    if (txt === mode || (b.onclick && b.onclick.toString().toLowerCase().includes(mode))) {
                        b.classList.add('bg-indigo-500', 'text-white');
                        b.classList.remove('text-slate-400');
                    } else if (txt.match(/square|subtle|modern|playful/)) {
                        b.classList.remove('bg-indigo-500', 'text-white');
                        b.classList.add('text-slate-400');
                    }
                });

                if (!appState.settings) appState.settings = {};
                appState.settings.radiusMode = mode;
                if (typeof saveState === 'function') saveState();
            };

            // 4. Blur Slider Persistence
            function attachBlurListener() {
                const slider = document.getElementById('setting-blur-slider');
                if (slider) {
                    if (slider.dataset.patched) return;

                    slider.addEventListener('input', (e) => {
                        const val = e.target.value;
                        document.documentElement.style.setProperty('--glass-blur', `${val} px`);
                        const panels = document.querySelectorAll('.glass-panel');
                        panels.forEach(p => p.style.backdropFilter = `blur(${val}px)`);

                        if (!appState.settings) appState.settings = {};
                        appState.settings.blurVal = val;

                        if (window._blurSaveTimeout) clearTimeout(window._blurSaveTimeout);
                        window._blurSaveTimeout = setTimeout(() => { if (typeof saveState === 'function') saveState(); }, 500);
                    });
                    slider.dataset.patched = "true";

                    if (appState.settings && appState.settings.blurVal) {
                        slider.value = appState.settings.blurVal;
                    }
                }
            }

            // 5. Wallpaper Persistence (Delegation)
            document.addEventListener('click', (e) => {
                const target = e.target.closest('button') || e.target.closest('label');
                if (!target) return;

                const text = target.innerText || '';
                const onclick = target.getAttribute('onclick') || '';

                if (text.includes('Solid Dark') || text.includes('Slate') || onclick.includes('setWallpaper') || target.querySelector('img')) {
                    if (!target.closest('#view-settings') && !target.closest('.tab-content')) return;

                    setTimeout(() => {
                        const bgImage = document.body.style.backgroundImage;
                        const bgColor = document.body.style.backgroundColor;

                        if (!appState.settings) appState.settings = {};
                        appState.settings.wallpaperImage = bgImage;
                        if (bgColor) appState.settings.wallpaperColor = bgColor;
                        else appState.settings.wallpaperColor = '';

                        if (typeof saveState === 'function') saveState();
                    }, 500);
                }
            });

            // 6. Profile Persistence 
            function attachProfileListeners() {
                const candidates = [
                    document.getElementById('profile-name'),
                    document.getElementById('profile-email'),
                    ...document.querySelectorAll('input[placeholder*="Name"]'),
                    ...document.querySelectorAll('input[placeholder*="Email"]')
                ];

                candidates.forEach(inp => {
                    if (inp && !inp.dataset.persistAttached) {
                        inp.dataset.persistAttached = "true";
                        inp.addEventListener('change', (e) => {
                            if (!appState.profile) appState.profile = {};
                            if (inp.id === 'profile-name' || inp.placeholder.includes('Name')) appState.profile.name = e.target.value;
                            if (inp.id === 'profile-email' || inp.placeholder.includes('Email')) appState.profile.email = e.target.value;
                            if (typeof saveState === 'function') saveState();
                        });

                        if (appState.profile) {
                            if ((inp.id === 'profile-name' || inp.placeholder.includes('Name')) && appState.profile.name) inp.value = appState.profile.name;
                            if ((inp.id === 'profile-email' || inp.placeholder.includes('Email')) && appState.profile.email) inp.value = appState.profile.email;
                        }
                    }
                });
            }

            // 8. DYNAMIC PATCHER FOR LEGACY UI (More Robust)
            function patchSettingsUI() {
                console.log("🔧 Patching Settings UI (Robust Attempt)...");

                // Helper to clean text
                const clean = (t) => t ? t.innerText.trim().toUpperCase() : '';

                // Find all potential headers
                // We expand search to headings and labels
                const allElements = document.querySelectorAll('h1, h2, h3, h4, 5, p, span, label, div');

                let primaryContainer = null;
                let accentContainer = null;

                for (let el of allElements) {
                    const txt = clean(el);
                    // Match "PRIMARY COLOR" EXACTLY or contained if brief
                    if (txt === 'PRIMARY COLOR' || (txt.includes('PRIMARY COLOR') && txt.length < 30)) {
                        // Look for buttons nearby
                        let next = el.nextElementSibling;
                        // Case 1: The very next element is the container
                        if (next && next.querySelector('button')) {
                            primaryContainer = next;
                        }
                        // Case 2: It's inside the same parent div
                        else {
                            const parent = el.parentElement;
                            if (parent) {
                                // Try finding a flex container inside parent with buttons
                                const flexOpts = parent.querySelectorAll('div.flex');
                                flexOpts.forEach(f => {
                                    if (f.querySelector('button')) primaryContainer = f;
                                });
                                // Or maybe the parent IS the container?
                                if (!primaryContainer && parent.querySelector('button')) primaryContainer = parent;
                            }
                        }
                    }

                    if (txt === 'ACCENT COLOR' || (txt.includes('ACCENT COLOR') && txt.length < 30)) {
                        let next = el.nextElementSibling;
                        if (next && next.querySelector('button')) {
                            accentContainer = next;
                        }
                        else {
                            const parent = el.parentElement;
                            if (parent) {
                                const flexOpts = parent.querySelectorAll('div.flex');
                                flexOpts.forEach(f => {
                                    if (f.querySelector('button')) accentContainer = f;
                                });
                                if (!accentContainer && parent.querySelector('button')) accentContainer = parent;
                            }
                        }
                    }
                }

                // Apply logic
                const fixButtons = (container, type) => {
                    if (!container) return;
                    // Filter for circular color buttons only
                    const buttons = Array.from(container.querySelectorAll('button')).filter(btn => {
                        // Heuristic: Color buttons usually have bg color or class and no text (or minimal text)
                        const hasBg = btn.style.backgroundColor || btn.className.includes('bg-');
                        const isEmpty = btn.innerText.trim().length === 0;
                        const isRounded = btn.className.includes('rounded-full');
                        return hasBg && (isEmpty || isRounded);
                    });

                    if (buttons.length === 0) return;

                    console.log(`✅ Found ${buttons.length} buttons for ${type}`);

                    buttons.forEach(btn => {
                        // Extract color
                        let color = btn.style.backgroundColor;
                        if ((!color || color === 'rgba(0, 0, 0, 0)') && btn.className.includes('bg-[')) {
                            const match = btn.className.match(/bg-\[(.*?)\]/);
                            if (match) color = match[1];
                        }
                        // If still no color, try computed style
                        if (!color || color === 'rgba(0, 0, 0, 0)') {
                            color = window.getComputedStyle(btn).backgroundColor;
                        }

                        // Apply fix
                        if (color && color !== 'rgba(0, 0, 0, 0)' && !btn.dataset.patched) {
                            btn.onclick = (e) => {
                                e.preventDefault(); e.stopImmediatePropagation();
                                setThemeColorEnhanced(type, color);
                            };
                            btn.dataset.patched = "true";
                            btn.style.cursor = 'pointer';
                        }
                    });
                };

                fixButtons(primaryContainer, 'primary');
                fixButtons(accentContainer, 'secondary');
            }

            // 7. Init Logic
            function initSettingsPersistence() {
                console.log("⚙️ INITIALIZING SETTINGS PERSISTENCE...");

                // Restore logic
                if (appState.settings) {
                    // Init gradient object if missing
                    if (typeof window.currentGradient === 'undefined') window.currentGradient = { start: '#6366F1', end: '#A855F7' };

                    // Restore Colors
                    if (appState.settings.gradientStart) window.currentGradient.start = appState.settings.gradientStart;
                    if (appState.settings.gradientEnd) window.currentGradient.end = appState.settings.gradientEnd;

                    document.documentElement.style.setProperty('--color-primary', window.currentGradient.start);
                    document.documentElement.style.setProperty('--color-secondary', window.currentGradient.end);

                    // RESTORE INPUT VALUES (Critical Fix)
                    const pPicker = document.getElementById('tm-primary-picker');
                    const pInput = document.getElementById('tm-primary-input');
                    const aPicker = document.getElementById('tm-accent-picker');
                    const aInput = document.getElementById('tm-accent-input');

                    if (pPicker) pPicker.value = window.currentGradient.start;
                    if (pInput) pInput.value = window.currentGradient.start;
                    if (aPicker) aPicker.value = window.currentGradient.end;
                    if (aInput) aInput.value = window.currentGradient.end;

                    // Restore Wallpaper
                    if (appState.settings.wallpaperImage) {
                        document.body.style.backgroundImage = appState.settings.wallpaperImage;
                        if (appState.settings.wallpaperImage === 'none' && appState.settings.wallpaperColor) {
                            document.body.style.backgroundColor = appState.settings.wallpaperColor;
                        }
                    } else if (appState.settings.wallpaperColor) {
                        document.body.style.backgroundImage = 'none';
                        document.body.style.backgroundColor = appState.settings.wallpaperColor;
                    }

                    // Restore Font Scale/Spacing
                    if (appState.settings.fontScale && window.setFontScale) {
                        window.setFontScale(appState.settings.fontScale);
                        const slider = document.getElementById('setting-font-scale');
                        if (slider) slider.value = appState.settings.fontScale;
                    }
                    if (appState.settings.fontSpacing && window.setFontSpacing) {
                        window.setFontSpacing(appState.settings.fontSpacing);
                    }

                    // Restore Radius
                    if (appState.settings.radiusMode && window.setAppRadius) {
                        window.setAppRadius(appState.settings.radiusMode);
                    }

                    // Restore Blur
                    if (appState.settings.blurVal) {
                        document.documentElement.style.setProperty('--glass-blur', `${appState.settings.blurVal} px`);
                        const panels = document.querySelectorAll('.glass-panel');
                        panels.forEach(p => p.style.backdropFilter = `blur(${appState.settings.blurVal}px)`);
                        const slider = document.getElementById('setting-blur-slider');
                        if (slider) slider.value = appState.settings.blurVal;
                    }
                }

                // FORCE VISUAL UPDATE
                if (typeof updateGradientPreview === 'function') updateGradientPreview();

                // ATTACH LISTENERS TO NEW INPUTS (Critical Fix)
                attachColorPickerListeners();

                attachBlurListener();
                attachProfileListeners();

                // Run Patcher
                patchSettingsUI();
            }

            // Helper to attach listeners to the clean UI inputs
            function attachColorPickerListeners() {
                const attach = (pickerId, inputId, type) => {
                    const picker = document.getElementById(pickerId);
                    const input = document.getElementById(inputId);

                    if (picker && input) {
                        // Picker Change
                        picker.oninput = (e) => {
                            input.value = e.target.value;
                            if (typeof setThemeColorEnhanced === 'function') setThemeColorEnhanced(null, e.target.value, type);
                        };
                        // Input Change
                        input.onchange = (e) => {
                            picker.value = e.target.value;
                            if (typeof setThemeColorEnhanced === 'function') setThemeColorEnhanced(null, e.target.value, type);
                        };
                    }
                };

                attach('tm-primary-picker', 'tm-primary-input', 'primary');
                attach('tm-accent-picker', 'tm-accent-input', 'secondary');
            }

            // Hook SwitchTab to re-attach persistence when entering Settings
            const originalSwitchTabSettings = window.switchTab;
            window.switchTab = function (tabId) {
                if (typeof originalSwitchTabSettings === 'function') originalSwitchTabSettings(tabId);
                if (tabId === 'settings') {
                    console.log("⚙️ Settings Tab Activated - Attaching Persistence...");
                    setTimeout(initSettingsPersistence, 500);
                    let attempts = 0;
                    const interval = setInterval(() => {
                        patchSettingsUI();
                        attempts++;
                        if (attempts > 10) clearInterval(interval);
                    }, 500);
                }
            };


            // Bootstrap - Robust
            const bootSettings = () => {
                initSettingsPersistence();
                // Double check visual update in case DOM wasn't fully ready inside init
                setTimeout(() => {
                    if (typeof updateGradientPreview === 'function') updateGradientPreview();
                }, 100);
            };

            if (document.readyState === 'complete') bootSettings();
            else window.addEventListener('load', bootSettings);

            // Also hook into the global saveState to re-trigger visuals if needed
            const _originalSaveState = window.saveState;
            window.saveState = function () {
                if (typeof _originalSaveState === 'function') _originalSaveState();
                // Ensure visuals stay synced
                if (typeof updateGradientPreview === 'function') updateGradientPreview();
            };

        })();
    </script>
    <script src="focus_logic.js"></script>
    <script>
        // Ensure Wallet Totals update on load (Double check)
        if (window.updateMonthlyTotals) window.addEventListener('load', window.updateMonthlyTotals);
    </script>


    <script>
        // --- LEGACY THEME TOGGLE COMPATIBILITY ---

        // --- MISSING APPEARANCE FUNCTIONS (Restored) ---
        // 1. Wallpaper Logic
        // 1. Wallpaper Logic (Robust Polymorphic Fix)
        window.setWallpaper = function (arg1, arg2, arg3) {
            let type, value, btn;

            // Determine signature
            // Case A: setWallpaper('image', 'url', btn) or setWallpaper('solid', 'color', btn)
            if (arg1 === 'image' || arg1 === 'solid') {
                type = arg1;
                value = arg2;
                btn = arg3;
            }
            // Case B: setWallpaper('url(...)', btn) - Legacy/Upload
            else {
                value = arg1;
                btn = arg2;
                type = value.includes('url(') ? 'image' : 'solid';
            }

            console.log(`🖼️ Setting Wallpaper: Type = ${type}, Value = ${value.substring(0, 30)}...`);

            if (type === 'image') {
                // Ensure URL format
                if (!value.includes('url(')) value = `url('${value}')`;

                document.body.style.backgroundImage = value;
                document.body.style.backgroundColor = '#0f1115'; // Fallback
                document.body.className = "bg-fixed bg-cover bg-center text-adaptive flex h-screen overflow-hidden transition-all duration-700";

                // Save
                if (window.appState) {
                    appState.settings = appState.settings || {};
                    appState.settings.wallpaperImage = value;
                    appState.settings.wallpaperColor = 'none';
                    if (window.saveState) saveState();
                }
            } else {
                // Solid Color
                document.body.style.backgroundImage = 'none';
                document.body.style.backgroundColor = value;
                document.body.className = "text-adaptive transition-colors duration-500 flex h-screen overflow-hidden";

                // Save
                if (window.appState) {
                    appState.settings = appState.settings || {};
                    appState.settings.wallpaperImage = 'none';
                    appState.settings.wallpaperColor = value;
                    if (window.saveState) saveState();
                }
            }

            // Add Active Ring Logic
            // Remove ring from all wallpaper buttons
            const allWpBtns = document.querySelectorAll('button[onclick*="setWallpaper"]');
            allWpBtns.forEach(b => b.classList.remove('ring-2', 'ring-primary', 'ring-emerald-400', 'ring-offset-2', 'ring-offset-[#0f1115]'));

            // Add to current if passed
            // If passed from HTML onclick, 'btn' might be undefined if we didn't pass 'this'
            // But we can try to find the button that was clicked via event? No, safely use arg.
            if (btn) {
                btn.classList.add('ring-2', 'ring-emerald-400', 'ring-offset-2', 'ring-offset-[#0f1115]');
            } else {
                // Try to find matching button by content? Hard.
                // Try explicit 'this' from event if possible? 
                if (window.event && window.event.currentTarget) {
                    window.event.currentTarget.classList.add('ring-2', 'ring-emerald-400', 'ring-offset-2', 'ring-offset-[#0f1115]');
                }
            }

            if (typeof Swal !== 'undefined') {
                const Toast = Swal.mixin({ toast: true, position: 'top', showConfirmButton: false, timer: 1500, timerProgressBar: true });
                Toast.fire({ icon: 'success', title: 'Wallpaper Updated', background: '#1E293B', color: '#fff' });
            }
        };

        window.uploadWallpaper = function (input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    // Determine logic
                    const url = e.target.result;
                    // use 'image' type explicit
                    setWallpaper('image', url, input.closest('label'));
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        // 2. Font Logic
        // 2. Font Logic
        // --- PREMIUM 200+ FONT LIBRARY & LOGIC ---

        window.fontLibrary = [
            // SANS SERIF
            { name: "Inter", cat: "sans" }, { name: "Roboto", cat: "sans" }, { name: "Open Sans", cat: "sans" }, { name: "Montserrat", cat: "sans" },
            { name: "Lato", cat: "sans" }, { name: "Poppins", cat: "sans" }, { name: "Nunito", cat: "sans" }, { name: "Raleway", cat: "sans" },
            { name: "Ubuntu", cat: "sans" }, { name: "Oswald", cat: "sans" }, { name: "Rubik", cat: "sans" }, { name: "Work Sans", cat: "sans" },
            { name: "Quicksand", cat: "sans" }, { name: "Kanit", cat: "sans" }, { name: "Fira Sans", cat: "sans" }, { name: "Barlow", cat: "sans" },
            { name: "Mulish", cat: "sans" }, { name: "DM Sans", cat: "sans" }, { name: "PT Sans", cat: "sans" }, { name: "Exo 2", cat: "sans" },
            { name: "Josefin Sans", cat: "sans" }, { name: "Mukta", cat: "sans" }, { name: "Hind", cat: "sans" }, { name: "Cabin", cat: "sans" },
            { name: "Catamaran", cat: "sans" }, { name: "Anton", cat: "sans" }, { name: "Cairo", cat: "sans" }, { name: "Oxygen", cat: "sans" },
            { name: "Varela Round", cat: "sans" }, { name: "Comfortaa", cat: "sans" }, { name: "Dosis", cat: "sans" }, { name: "Teko", cat: "sans" },
            { name: "Assistant", cat: "sans" }, { name: "Prompt", cat: "sans" }, { name: "Maven Pro", cat: "sans" }, { name: "Rajdhani", cat: "sans" },
            { name: "Signika", cat: "sans" }, { name: "ABeeZee", cat: "sans" }, { name: "Orbitron", cat: "sans" }, { name: "Electrolize", cat: "sans" },
            { name: "Jura", cat: "sans" }, { name: "Michroma", cat: "sans" }, { name: "Audiowide", cat: "sans" }, { name: "Syncopate", cat: "sans" },
            { name: "Syne", cat: "sans" }, { name: "Outfit", cat: "sans" }, { name: "Be Vietnam Pro", cat: "sans" }, { name: "Urbanist", cat: "sans" },
            { name: "Manrope", cat: "sans" }, { name: "Plus Jakarta Sans", cat: "sans" }, { name: "Lexend", cat: "sans" }, { name: "Epilogue", cat: "sans" },
            { name: "Sora", cat: "sans" }, { name: "Hanken Grotesk", cat: "sans" }, { name: "Space Grotesk", cat: "sans" }, { name: "Public Sans", cat: "sans" },
            { name: "Archivo", cat: "sans" }, { name: "Encode Sans", cat: "sans" }, { name: "Saira", cat: "sans" }, { name: "Chakra Petch", cat: "sans" },

            // SERIF
            { name: "Merriweather", cat: "serif" }, { name: "Playfair Display", cat: "serif" }, { name: "Lora", cat: "serif" }, { name: "PT Serif", cat: "serif" },
            { name: "Roboto Slab", cat: "serif" }, { name: "Slabo 27px", cat: "serif" }, { name: "Arvo", cat: "serif" }, { name: "Noto Serif", cat: "serif" },
            { name: "Crimson Text", cat: "serif" }, { name: "Cormorant Garamond", cat: "serif" }, { name: "Libre Baskerville", cat: "serif" }, { name: "Bitter", cat: "serif" },
            { name: "Josefin Slab", cat: "serif" }, { name: "EB Garamond", cat: "serif" }, { name: "Zilla Slab", cat: "serif" }, { name: "Bree Serif", cat: "serif" },
            { name: "Vollkorn", cat: "serif" }, { name: "Abhaya Libre", cat: "serif" }, { name: "Cinzel", cat: "serif" }, { name: "Alegreya", cat: "serif" },
            { name: "Frank Ruhl Libre", cat: "serif" }, { name: "Cardo", cat: "serif" }, { name: "Domine", cat: "serif" }, { name: "Old Standard TT", cat: "serif" },
            { name: "Prata", cat: "serif" }, { name: "Spectral", cat: "serif" }, { name: "Rokkitt", cat: "serif" }, { name: "Mate", cat: "serif" },
            { name: "Caudex", cat: "serif" }, { name: "Amiri", cat: "serif" }, { name: "Glegoo", cat: "serif" }, { name: "Kreon", cat: "serif" },
            { name: "Sanchez", cat: "serif" }, { name: "Habibi", cat: "serif" }, { name: "Gilda Display", cat: "serif" }, { name: "Philosopher", cat: "serif" },
            { name: "Baskervville", cat: "serif" }, { name: "Bodoni Moda", cat: "serif" }, { name: "Castoro", cat: "serif" }, { name: "Fraunces", cat: "serif" },
            { name: "Newsreader", cat: "serif" }, { name: "Petrona", cat: "serif" }, { name: "Besley", cat: "serif" }, { name: "Brygada 1918", cat: "serif" },

            // HANDWRITING / SCRIPT
            { name: "Indie Flower", cat: "hand" }, { name: "Pacifico", cat: "hand" }, { name: "Dancing Script", cat: "hand" }, { name: "Shadows Into Light", cat: "hand" },
            { name: "Amatic SC", cat: "hand" }, { name: "Caveat", cat: "hand" }, { name: "Satisfy", cat: "hand" }, { name: "Great Vibes", cat: "hand" },
            { name: "Courgette", cat: "hand" }, { name: "Sacramento", cat: "hand" }, { name: "Permanent Marker", cat: "hand" }, { name: "Kalam", cat: "hand" },
            { name: "Patrick Hand", cat: "hand" }, { name: "Cookie", cat: "hand" }, { name: "Handlee", cat: "hand" }, { name: "Gloria Hallelujah", cat: "hand" },
            { name: "Yellowtail", cat: "hand" }, { name: "Tangerine", cat: "hand" }, { name: "Allura", cat: "hand" }, { name: "Damion", cat: "hand" },
            { name: "Nothing You Could Do", cat: "hand" }, { name: "Covered By Your Grace", cat: "hand" }, { name: "Reenie Beanie", cat: "hand" }, { name: "Homemade Apple", cat: "hand" },
            { name: "La Belle Aurore", cat: "hand" }, { name: "Cedarville Cursive", cat: "hand" }, { name: "Meddon", cat: "hand" }, { name: "Mr Dafoe", cat: "hand" },
            { name: "Rock Salt", cat: "hand" }, { name: "Pinyon Script", cat: "hand" }, { name: "Bad Script", cat: "hand" }, { name: "Nanum Pen Script", cat: "hand" },
            { name: "Waiting for the Sunrise", cat: "hand" }, { name: "Just Another Hand", cat: "hand" }, { name: "Gochi Hand", cat: "hand" }, { name: "Marck Script", cat: "hand" },
            { name: "Parisienne", cat: "hand" }, { name: "Norican", cat: "hand" }, { name: "Kaushan Script", cat: "hand" }, { name: "Alex Brush", cat: "hand" },

            // MONOSPACE
            { name: "Roboto Mono", cat: "mono" }, { name: "Inconsolata", cat: "mono" }, { name: "Source Code Pro", cat: "mono" }, { name: "Fira Code", cat: "mono" },
            { name: "IBM Plex Mono", cat: "mono" }, { name: "Ubuntu Mono", cat: "mono" }, { name: "Space Mono", cat: "mono" }, { name: "Anonymous Pro", cat: "mono" },
            { name: "Cousine", cat: "mono" }, { name: "PT Mono", cat: "mono" }, { name: "Oxygen Mono", cat: "mono" }, { name: "Share Tech Mono", cat: "mono" },
            { name: "VT323", cat: "mono" }, { name: "Cutive Mono", cat: "mono" }, { name: "JetBrains Mono", cat: "mono" }, { name: "Sono", cat: "mono" },
            { name: "DM Mono", cat: "mono" }, { name: "B612 Mono", cat: "mono" }, { name: "Martian Mono", cat: "mono" }, { name: "Azeret Mono", cat: "mono" },

            // DISPLAY / DECORATIVE
            { name: "Lobster", cat: "display" }, { name: "Abril Fatface", cat: "display" }, { name: "Bangers", cat: "display" }, { name: "Fredoka One", cat: "display" },
            { name: "Righteous", cat: "display" }, { name: "Alfa Slab One", cat: "display" }, { name: "Chewy", cat: "display" }, { name: "Russo One", cat: "display" },
            { name: "Luckiest Guy", cat: "display" }, { name: "Passion One", cat: "display" }, { name: "Squada One", cat: "display" }, { name: "Patua One", cat: "display" },
            { name: "Unica One", cat: "display" }, { name: "Carter One", cat: "display" }, { name: "Special Elite", cat: "display" }, { name: "Monoton", cat: "display" },
            { name: "Press Start 2P", cat: "display" }, { name: "Bungee", cat: "display" }, { name: "Creepster", cat: "display" }, { name: "Faster One", cat: "display" },
            { name: "Fugaz One", cat: "display" }, { name: "Graduate", cat: "display" }, { name: "Gruppo", cat: "display" }, { name: "Kelly Slab", cat: "display" },
            { name: "Megrim", cat: "display" }, { name: "Metamorphous", cat: "display" }, { name: "New Rocker", cat: "display" }, { name: "Metal Mania", cat: "display" }, { name: "MedievalSharp", cat: "display" }, { name: "Pirata One", cat: "display" },
            { name: "Plaster", cat: "display" }, { name: "Poiret One", cat: "display" }, { name: "Pompiere", cat: "display" }, { name: "Rye", cat: "display" },
            { name: "Sancreek", cat: "display" }, { name: "Shojumaru", cat: "display" }, { name: "Six Caps", cat: "display" }, { name: "Staatliches", cat: "display" },
            { name: "Trade Winds", cat: "display" }, { name: "Ultra", cat: "display" }, { name: "UnifrakturMaguntia", cat: "display" }, { name: "Wallpoet", cat: "display" }
        ];

        // Ensure Favorites Exist
        if (!appState.settings) appState.settings = {};
        if (!appState.settings.favorites) {
            appState.settings.favorites = ['Inter', 'Outfit', 'Playfair Display', 'Pirata One', 'MedievalSharp', 'Metal Mania', 'UnifrakturMaguntia'];
        } else {
            // Ensure gothic fonts are in favorites for this update
            ['Pirata One', 'MedievalSharp', 'Metal Mania', 'UnifrakturMaguntia'].forEach(f => {
                if (!appState.settings.favorites.includes(f)) appState.settings.favorites.push(f);
            });
        }

        window.loadFont = function (fontName) {
            const id = 'font-link-' + fontName.replace(/\s+/g, '-').toLowerCase();
            if (!document.getElementById(id)) {
                const link = document.createElement('link');
                link.id = id;
                link.rel = 'stylesheet';
                link.href = `https://fonts.googleapis.com/css2?family=${fontName.replace(/\s+/g, '+')}&display=swap`;
                document.head.appendChild(link);
            }
        };

        // Main Font Setter
        window.setAppFont = function (fontNameOrMode) {
            let fontName = fontNameOrMode;
            let finalCat = 'sans';

            // Map legacy modes to specific fonts
            if (fontNameOrMode === 'sans') fontName = 'Inter';
            else if (fontNameOrMode === 'serif') fontName = 'Playfair Display';
            else if (fontNameOrMode === 'mono') fontName = 'Fira Code';
            else if (fontNameOrMode === 'modern') fontName = 'Outfit';
            else if (fontNameOrMode === 'elegant') fontName = 'Playfair Display';
            else if (fontNameOrMode === 'tech') fontName = 'Rajdhani';
            else if (fontNameOrMode === 'handwriting') fontName = 'Indie Flower';
            else if (fontNameOrMode === 'slab') fontName = 'Roboto Slab';
            else if (fontNameOrMode === 'custom') fontName = appState.settings.customFont || 'Inter';

            // Load & Apply
            loadFont(fontName);
            document.documentElement.style.setProperty('--font-override', `'${fontName}', sans-serif`);
            document.body.style.fontFamily = `'${fontName}', sans-serif`;

            // Persist
            if (window.appState) {
                appState.settings = appState.settings || {};
                appState.settings.fontMode = fontNameOrMode; // Keep mode if it was a mode
                appState.settings.customFont = fontName;     // Also save the actual name
                if (window.saveState) saveState();
            }

            // Toast
            if (typeof Swal !== 'undefined' && !window._suppressFontToast) {
                const Toast = Swal.mixin({ toast: true, position: 'top', showConfirmButton: false, timer: 1500, timerProgressBar: true });
                Toast.fire({
                    icon: 'success',
                    title: `Typeface Active`,
                    text: fontName,
                    background: '#1E293B', color: '#fff'
                });
            }

            // Update UI
            updateFontUI();
        };

        window.toggleFavorite = function (fontName) {
            if (!appState.settings.favorites) appState.settings.favorites = [];

            const idx = appState.settings.favorites.indexOf(fontName);
            if (idx > -1) {
                appState.settings.favorites.splice(idx, 1);
            } else {
                appState.settings.favorites.push(fontName);
            }

            if (window.saveState) saveState();

            // Rerender if modal open
            if (document.getElementById('font-library-grid')) {
                renderFontLibraryGrid();
            }
            // Update main UI
            updateFontUI();
        };

        window.openFontLibrary = function () {
            Swal.fire({
                title: ' ',
                html: `
                    <div class="flex flex-col h-[80vh]">
                        <div class="flex items-center gap-4 mb-4 px-1">
                            <div class="relative flex-1">
                                <i data-lucide="search" class="absolute left-3 top-3 w-5 h-5 text-slate-500"></i>
                                <input id="font-search" type="text" placeholder="Search 200+ fonts..." 
                                    class="w-full bg-[#0B0D14] border border-white/10 rounded-xl pl-10 pr-4 py-2.5 text-white font-bold focus:outline-none focus:border-indigo-500 transition shadow-inner placeholder-slate-600"
                                    onkeyup="renderFontLibraryGrid()">
                            </div>
                            <select id="font-category" onchange="renderFontLibraryGrid()" 
                                class="bg-[#0B0D14] border border-white/10 rounded-xl px-4 py-2.5 text-white font-bold focus:outline-none focus:border-indigo-500 shadow-sm cursor-pointer hover:border-white/20">
                                <option value="all">All Categories</option>
                                <option value="sans">Sans Serif</option>
                                <option value="serif">Serif</option>
                                <option value="display">Display</option>
                                <option value="hand">Handwriting</option>
                                <option value="mono">Monospace</option>
                            </select>
                        </div>
                        <div id="font-library-grid" class="flex-1 overflow-y-auto grid grid-cols-2 lg:grid-cols-4 gap-3 pr-2 custom-scrollbar content-start">
                            <!-- Injected JS -->
                        </div>
                    </div>
                `,
                width: '1100px',
                padding: '2rem',
                background: '#141724',
                color: '#fff',
                showConfirmButton: false,
                showCloseButton: true,
                customClass: { popup: 'rounded-[1.5rem] border border-white/5 glass-panel shadow-[0_0_50px_rgba(0,0,0,0.5)]' },
                didOpen: () => {
                    lucide.createIcons();
                    renderFontLibraryGrid();
                }
            });
        };

        window.renderFontLibraryGrid = function () {
            const grid = document.getElementById('font-library-grid');
            const searchEl = document.getElementById('font-search');
            if (!grid || !searchEl) return;

            const search = searchEl.value.toLowerCase();
            const cat = document.getElementById('font-category').value;

            const favs = appState.settings.favorites || [];
            const current = appState.settings.customFont || 'Inter';

            // Filter
            const filtered = window.fontLibrary.filter(f => {
                const matchSearch = f.name.toLowerCase().includes(search);
                const matchCat = cat === 'all' || f.cat === cat;
                return matchSearch && matchCat;
            });

            // Add fonts to document dynamically BUT limited batch if too many?
            // Browser handles multiple link tags fine usually.

            grid.innerHTML = filtered.map(f => {
                const isFav = favs.includes(f.name);
                const isActive = current === f.name;

                // Only load font if we are rendering it
                loadFont(f.name);

                return `
                    <div class="group relative bg-[#0B0D14]/50 hover:bg-[#1E293B] border ${isActive ? 'border-indigo-500 ring-1 ring-indigo-500/50' : 'border-white/5 hover:border-indigo-500/30'} rounded-xl p-4 transition-all cursor-pointer flex flex-col gap-2 h-28 overflow-hidden"
                         onclick="setAppFont('${f.name}')">
                        <div class="flex justify-between items-start z-10">
                            <span class="text-[10px] uppercase font-bold ${isActive ? 'text-indigo-400' : 'text-slate-500 group-hover:text-slate-300'} tracking-wider truncate pr-2">${f.name}</span>
                            <button onclick="event.stopPropagation(); toggleFavorite('${f.name}')" class="hover:scale-110 transition z-20">
                                <i data-lucide="heart" class="w-4 h-4 ${isFav ? 'text-pink-500 fill-pink-500 drop-shadow-[0_0_8px_rgba(236,72,153,0.5)]' : 'text-slate-700 group-hover:text-slate-500'}"></i>
                            </button>
                        </div>
                        <div class="flex-1 flex items-center justify-center -mt-1">
                            <span style="font-family: '${f.name}', sans-serif; font-size: 1.75rem;" class="${isActive ? 'text-white' : 'text-slate-300 group-hover:text-white'} transition-colors whitespace-nowrap">Aa Bb Cc</span>
                        </div>
                        ${isFav ? '<div class="absolute -top-6 -right-6 w-12 h-12 bg-pink-500/10 blur-xl rounded-full pointer-events-none"></div>' : ''}
                    </div>
                `;
            }).join('');

            lucide.createIcons();
        };

        window.updateFontUI = function () {
            // Update the favorites list in the main settings panel if it exists
            const container = document.getElementById('typography-favorites-container');
            const currentNameEl = document.getElementById('typ-current-name');
            const currentPreviewEl = document.getElementById('typ-active-preview');

            const currentFont = (appState.settings && appState.settings.customFont) ? appState.settings.customFont : 'Inter';

            if (currentNameEl) currentNameEl.innerText = currentFont;
            if (currentPreviewEl) {
                currentPreviewEl.style.fontFamily = `'${currentFont}', sans-serif`;
            }

            // Sync the live test preview
            const liveTestEl = document.getElementById('typ-live-test');
            if (liveTestEl) {
                liveTestEl.style.fontFamily = `'${currentFont}', sans-serif`;
            }

            if (container) {
                const favs = appState.settings.favorites || ['Inter', 'Outfit'];

                // Generate HTML for favorites
                container.innerHTML = favs.map(f => {
                    const isActive = f === currentFont;
                    loadFont(f);
                    return `
                        <div onclick="setAppFont('${f}')" 
                             class="flex-shrink-0 w-20 h-20 rounded-xl border ${isActive ? 'bg-indigo-600 border-indigo-500 shadow-lg shadow-indigo-500/20' : 'bg-[#151820] border-white/5 hover:border-white/10 hover:bg-white/5'} flex flex-col items-center justify-center cursor-pointer transition relative group overflow-hidden">
                            <span style="font-family: '${f}', sans-serif;" class="text-2xl text-white mb-1 relative z-10">Aa</span>
                            <span class="text-[9px] ${isActive ? 'text-indigo-100' : 'text-slate-500 group-hover:text-slate-300'} font-bold truncate w-full text-center px-1 relative z-10">${f}</span>
                        </div>
                    `;
                }).join('');
            }
        };

        // --- SYSTEM PREFERENCES LOGIC ---
        window.toggleBiometric = function (el) {
            if (!window.appState) return;
            const isChecked = el.checked;
            appState.settings = appState.settings || {};
            appState.settings.biometric = isChecked;
            if (window.saveState) saveState();

            if (isChecked) {
                if (typeof Swal !== 'undefined') {
                    const Toast = Swal.mixin({ toast: true, position: 'top', showConfirmButton: false, timer: 2000, timerProgressBar: true });
                    Toast.fire({
                        icon: 'success',
                        title: 'Biometric Login Enabled',
                        background: '#1E293B', color: '#fff'
                    });
                }
            }
        };

        window.setAutoLock = function (val) {
            if (!window.appState) return;
            appState.settings = appState.settings || {};
            appState.settings.autoLock = val;
            if (window.saveState) saveState();
        };

        window.setAIPersona = function (persona) {
            if (!window.appState) return;
            appState.settings = appState.settings || {};
            appState.settings.aiPersona = persona;
            if (window.saveState) saveState();
            updatePersonaUI();
        };

        window.updatePersonaUI = function () {
            if (!window.appState) return;
            // Restore Biometric Checkbox
            const bioCheck = document.getElementById('chk-biometric');
            if (bioCheck) bioCheck.checked = !!appState.settings.biometric;

            // Restore Auto-Lock Select
            const lockSel = document.getElementById('sel-autolock');
            if (lockSel && appState.settings.autoLock) lockSel.value = appState.settings.autoLock;

            // Restore Persona Cards
            const persona = (appState.settings && appState.settings.aiPersona) ? appState.settings.aiPersona : 'advisor';

            // Restore Persona Cards
            const activePersona = (appState.settings && appState.settings.aiPersona) ? appState.settings.aiPersona : 'advisor';

            const personaStyles = {
                advisor: { activeBorder: 'border-indigo-500/50', activeBg: 'bg-indigo-500/10', glow: 'shadow-[0_0_20px_rgba(99,102,241,0.1)]', dot: 'bg-indigo-500', dotBorder: 'border-indigo-500' },
                coach: { activeBorder: 'border-orange-500/50', activeBg: 'bg-orange-500/10', glow: 'shadow-[0_0_20px_rgba(249,115,22,0.1)]', dot: 'bg-orange-500', dotBorder: 'border-orange-500' },
                strategist: { activeBorder: 'border-emerald-500/50', activeBg: 'bg-emerald-500/10', glow: 'shadow-[0_0_20px_rgba(16,185,129,0.1)]', dot: 'bg-emerald-500', dotBorder: 'border-emerald-500' }
            };

            ['advisor', 'coach', 'strategist'].forEach(p => {
                const el = document.getElementById(`persona-${p}`);
                if (!el) return;

                const styles = personaStyles[p];
                const isSelected = p === activePersona;
                const statusIndicator = el.querySelector('.status-indicator');

                // Reset standard classes
                el.className = `relative p-4 rounded-2xl border transition-all duration-300 cursor-pointer group overflow-hidden ${isSelected ? styles.activeBorder + ' ' + styles.activeBg + ' ' + styles.glow : 'border-white/5 bg-[#161b22] hover:bg-[#1c222e]'}`;

                if (statusIndicator) {
                    statusIndicator.className = `status-indicator w-4 h-4 rounded-full border-2 flex items-center justify-center transition-all ${isSelected ? styles.dotBorder : 'border-slate-700'}`;
                    statusIndicator.innerHTML = isSelected ? `<div class="w-2 h-2 rounded-full ${styles.dot} shadow-lg"></div>` : '';
                }
            });
        };

        window.checkForUpdates = function (btn) {
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-3.5 h-3.5 animate-spin"></i> Checking...`;
            if (window.lucide) lucide.createIcons();

            setTimeout(() => {
                btn.innerHTML = `<i data-lucide="check" class="w-3.5 h-3.5 text-emerald-400"></i> Up to Date`;
                if (window.lucide) lucide.createIcons();

                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                    if (window.lucide) lucide.createIcons();
                }, 2000);
            }, 1500);
        };

        // Init on load
        document.addEventListener('DOMContentLoaded', () => {
            updateFontUI();
            updatePersonaUI();
        });

        // 2a. Advanced Typography Logic
        window.setFontScale = function (val) {
            const percentage = val;
            document.documentElement.style.fontSize = percentage + '%';

            // Update Label
            const lbl = document.getElementById('lbl-font-scale');
            if (lbl) lbl.innerText = percentage + '%';

            // Persist
            if (window.appState) {
                appState.settings = appState.settings || {};
                appState.settings.fontScale = val;
                if (window.saveState) saveState();
            }
        };

        window.setFontSpacing = function (val) {
            // val is -1, 0, 1, 2
            const pxMap = { '-1': '-0.5px', '0': '0px', '1': '0.5px', '2': '1px' };
            const pxVal = pxMap[val] || '0px';

            document.body.style.letterSpacing = pxVal;

            // Update Active State Visuals for Spacing Buttons
            document.querySelectorAll('[data-spacing-btn]').forEach(btn => {
                if (btn.dataset.value == val) {
                    btn.classList.add('bg-indigo-500', 'text-white', 'border-transparent');
                    btn.classList.remove('bg-white/5', 'text-slate-400', 'border-white/10');
                } else {
                    btn.classList.remove('bg-indigo-500', 'text-white', 'border-transparent');
                    btn.classList.add('bg-white/5', 'text-slate-400', 'border-white/10');
                }
            });

            // Persist
            if (window.appState) {
                appState.settings = appState.settings || {};
                appState.settings.fontSpacing = val;
                if (window.saveState) saveState();
            }
        };

        // 3. Radius Logic
        window.setAppRadius = function (mode) {
            const val = { 'sharp': '0px', 'standard': '0.75rem', 'round': '1.5rem', 'playful': '2rem' }[mode] || '0.75rem';
            document.documentElement.style.setProperty('--radius-app', val);

            let styleEl = document.getElementById('dynamic-radius-style');
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = 'dynamic-radius-style';
                document.head.appendChild(styleEl);
            }
            styleEl.innerHTML = `.rounded-xl, .rounded-2xl, .rounded-lg, .rounded-3xl { border-radius: ${val} !important; } .rounded-full { border-radius: 9999px !important; }`;

            if (window.appState) {
                appState.settings = appState.settings || {};
                appState.settings.radiusMode = mode;
                if (window.saveState) saveState();
            }
        };


        window.toggleTheme = function () {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');
            const newMode = isDark ? 'light' : 'dark';
            if (typeof toggleInterfaceMode === 'function') {
                toggleInterfaceMode(newMode);
            } else {
                // Fallback if toggleInterfaceMode not ready
                if (isDark) {
                    html.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                } else {
                    html.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                }
            }
        };


        // --- CRITICAL FIX: SIDEBAR TRANSACTION HANDLER ---
        // Re-implementing this function to ensure data persistence works correctly from the sidebar form.

        function addWalletTransaction() {
            console.log("🚀 Processing New Transaction from Sidebar...");

            try {
                // 1. Get DOM Elements
                const amountEl = document.getElementById('w-amount');
                const descEl = document.getElementById('w-desc');
                const dateEl = document.getElementById('w-date');
                const focusEl = document.getElementById('w-focus');
                const typeInc = document.getElementById('wt-income');
                const catInput = document.getElementById('w-category'); // Hidden input from grid

                if (!amountEl || !descEl) {
                    console.error("❌ Missing Form Elements");
                    return;
                }

                // 2. Validate
                const amount = parseFloat(amountEl.value);
                if (isNaN(amount) || amount <= 0) {
                    Swal.fire({
                        toast: true, position: 'top', icon: 'warning',
                        title: 'Monto inválido', text: 'Por favor ingresa un valor positivo.',
                        timer: 2000, showConfirmButton: false, background: '#1E293B', color: '#fff'
                    });
                    return;
                }

                // 3. Extract Values
                const desc = descEl.value.trim() || 'Movimiento';
                const type = typeInc && typeInc.checked ? 'income' : 'expense';
                const focus = focusEl ? focusEl.value : 'Wants';
                const category = catInput ? (catInput.value || 'General') : 'General';

                // 4. Date Logic (Crucial for "Today" bug)
                let dateIso = dateEl.value;
                // Fallback to today if empty
                if (!dateIso) {
                    const now = new Date();
                    dateIso = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
                }

                // Append Time
                const now = new Date();
                const todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');

                if (dateIso === todayStr) {
                    // It's today: Use LOCAL time components to avoid UTC-shifting to tomorrow in the ISO string
                    const pad = (n) => String(n).padStart(2, '0');
                    dateIso = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
                } else {
                    // It's another day: Force Noon to avoid Timezone shifts (e.g. becoming "Yesterday")
                    dateIso += 'T12:00:00';
                }

                // 5. Create Transaction Object
                const newTxn = {
                    id: Date.now(),
                    amount: amount,
                    name: desc,
                    type: type,
                    category: category,
                    dateIso: dateIso,
                    budgetFocus: type === 'expense' ? focus : 'Income',
                    date: new Date(dateIso).toLocaleDateString() // Legacy field
                };

                // 6. Add to Global State
                if (!appState.transactions) appState.transactions = [];
                appState.transactions.unshift(newTxn);
                console.log("✅ Transaction Added to State:", newTxn);

                // 7. PERSIST TO STORAGE (The most important step!)
                if (typeof saveState === 'function') {
                    saveState();
                    console.log("💾 State Saved to LocalStorage.");
                } else {
                    console.error("❌ saveState function missing! Data will be lost on reload.");
                    localStorage.setItem('financeApp_State_V2', JSON.stringify(appState)); // Emergency Fallback
                }

                // 8. UI Feedback
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: 'Guardado',
                    text: `${type === 'income' ? '+' : '-'}${formatCurrency(amount)}`,
                    background: '#0f111a',
                    color: '#fff',
                    timer: 2000,
                    showConfirmButton: false
                });

                // 9. Reset Form
                amountEl.value = '';
                descEl.value = '';
                // Optional: Reset date or keep it? Keeping it is usually better for sequential entry.

                // 10. Update UI Components (Protected)
                setTimeout(() => {
                    // Update Local View First (Priority)
                    try { if (typeof renderWalletHistory === 'function') renderWalletHistory(); } catch (e) { console.error("History Render failed", e); }
                    try { if (typeof updateMonthlyTotals === 'function') updateMonthlyTotals(); } catch (e) { console.error("Monthly Totals failed", e); }
                    try { if (typeof renderWeeklyActivityChart === 'function') renderWeeklyActivityChart(); } catch (e) { console.error("Activity Chart failed", e); }

                    // Update other views (Background)
                    try { if (typeof renderMergedDashboard === 'function') renderMergedDashboard(); } catch (e) { console.error("Dashboard Render failed", e); }
                }, 50);

            } catch (e) {
                console.error("🔥 Critical Error adding transaction:", e);
                Swal.fire({ icon: 'error', title: 'Error', text: e.message });
            }
        }
    </script>
    <script src="update_sidebar_stats.js"></script>
    <script>
        // --- FINAL FAIL-SAFE & OVERRIDES ---
        window.addEventListener('load', function () {
            console.log("🔒 FINAL CHECK: Ensuring Visual Identity & Stats Format...");

            // GLOBAL FORMATTER: Enforce No Cents Application-Wide
            window.formatCurrency = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(num);

            // 1. Re-read critical settings
            try {
                const key = (typeof window.getCurrentUserKey === 'function') ? window.getCurrentUserKey() : 'developMeApp_v1';
                const savedRaw = localStorage.getItem(key);
                if (savedRaw) {
                    const s = JSON.parse(savedRaw);
                    if (s && s.settings) {
                        if (s.settings.gradientStart) window.currentGradient.start = s.settings.gradientStart;
                        if (s.settings.gradientEnd) window.currentGradient.end = s.settings.gradientEnd;
                    }
                }
            } catch (e) { console.warn("Fail-safe read error", e); }

            // 2. Force CSS Variables
            document.documentElement.style.setProperty('--color-primary', window.currentGradient.start);
            document.documentElement.style.setProperty('--color-secondary', window.currentGradient.end);

            // 3. OVERRIDE: Dashboard Stats (Force NO CENTS)
            // We define this here to overwrite the external script if it loaded, or provide it if it failed.
            window.updateSidebarStats = function () {
                console.log("📊 Updating Dashboard Stats (Inline No-Cents Override)...");
                if (!window.appState || !window.appState.transactions) return;

                const txns = window.appState.transactions;
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth();

                let totalBalance = 0;
                // 1. Balance = Initial + Transactions
                if (window.appState.profile && window.appState.profile.balance !== undefined) {
                    const rawIB = window.appState.profile.balance;
                    const val = typeof rawIB === 'string' ? parseFloat(rawIB.replace(/[^0-9.-]/g, '')) : parseFloat(rawIB);
                    totalBalance += val || 0;
                }

                let totalIncomeYTD = 0;
                let totalExpenseYTD = 0;
                // For Month Comparison
                let incomeCurrentMonth = 0;
                let incomePrevMonth = 0;
                let expenseCurrentMonth = 0;
                let expensePrevMonth = 0;

                txns.forEach(t => {
                    const amount = parseFloat(t.amount);
                    const date = new Date(t.dateIso || t.date);
                    const tYear = date.getFullYear();
                    const tMonth = date.getMonth();

                    if (t.type === 'income') totalBalance += amount;
                    else if (t.type === 'expense') totalBalance -= amount;

                    if (tYear === currentYear) {
                        if (t.type === 'income') totalIncomeYTD += amount;
                        else if (t.type === 'expense') totalExpenseYTD += amount;

                        if (tMonth === currentMonth) {
                            if (t.type === 'income') incomeCurrentMonth += amount;
                            else if (t.type === 'expense') expenseCurrentMonth += amount;
                        }
                        if (tMonth === (currentMonth - 1)) {
                            if (t.type === 'income') incomePrevMonth += amount;
                            else if (t.type === 'expense') expensePrevMonth += amount;
                        }
                    }
                });

                // NO CENTS FORMATTER
                const fmt = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(num);

                // Update DOM
                const balanceEl = document.getElementById('dash-balance');
                const incomeEl = document.getElementById('dash-income');
                const expenseEl = document.getElementById('dash-expense');
                const sidebarBalance = document.getElementById('sidebar-balance-display');

                if (balanceEl) balanceEl.innerText = fmt(totalBalance);
                if (sidebarBalance) sidebarBalance.innerText = fmt(totalBalance);
                if (incomeEl) incomeEl.innerText = fmt(totalIncomeYTD);
                if (expenseEl) expenseEl.innerText = fmt(totalExpenseYTD);

                // Comparison Badges Logic (Simplified import)
                const calculateGrowth = (current, previous) => previous === 0 ? (current > 0 ? 100 : 0) : ((current - previous) / previous) * 100;
                const incomeGrowth = calculateGrowth(incomeCurrentMonth, incomePrevMonth);
                const expenseGrowth = calculateGrowth(expenseCurrentMonth, expensePrevMonth);

                // Helper to update badges if they exist (relying on structure)
                const updateBadge = (el, growth, isIncome) => {
                    if (!el) return;
                    const container = el.nextElementSibling;
                    if (!container || !container.classList.contains('inline-flex')) return; // Safety check

                    const growthVal = Math.round(growth);
                    const sign = growthVal >= 0 ? '+' : '';
                    const isPositive = isIncome ? growthVal >= 0 : growthVal <= 0; // Green if income up OR expense down? 
                    // Wait, standard UI: Green = Up, Red = Down. 
                    // But for Expense: Green = Good (Down), Red = Bad (Up).
                    // Let's stick to Green/Red based on 'Good/Bad'

                    let colorClass = 'text-slate-400';
                    if (isIncome) colorClass = growthVal >= 0 ? 'text-emerald-400' : 'text-rose-400';
                    else colorClass = growthVal <= 0 ? 'text-emerald-400' : 'text-rose-400'; // Expensive down is good

                    // Override: User just wants visual trend. Let's keep it simple.
                    // Income: Green if > 0. Expense: Red if > 0.
                    if (isIncome) colorClass = growthVal >= 0 ? 'text-emerald-400' : 'text-rose-400';
                    else colorClass = growthVal > 0 ? 'text-rose-400' : 'text-emerald-400';

                    const bgClass = colorClass.replace('text-', 'bg-').replace('400', '500/10');
                    const borderClass = colorClass.replace('text-', 'border-').replace('400', '500/10');

                    container.className = `inline-flex items-center gap-1.5 px-2 py-1 rounded-lg ${bgClass} ${borderClass} border w-fit`;
                    const icon = container.querySelector('svg');
                    const text = container.querySelector('span');
                    if (text) {
                        text.innerText = `${sign}${growthVal}% VS. MES ANTERIOR`;
                        text.className = `text-[9px] font-bold ${colorClass}`;
                    }
                    if (icon) icon.setAttribute('class', `w-3 h-3 ${colorClass}`);
                };

                updateBadge(incomeEl, incomeGrowth, true);
                updateBadge(expenseEl, expenseGrowth, false);
            };

            // 4. CALL IT IMMEDIATELY
            window.updateSidebarStats();

            // 5. Force Sidebar & Visual Restoration
            const icon = document.getElementById('sidebar-app-icon');
            if (icon) {
                icon.style.backgroundImage = `linear-gradient(to top right, ${window.currentGradient.start}, ${window.currentGradient.end})`;
                icon.style.boxShadow = `0 0 35px ${window.currentGradient.start}66`;
            }
            const aiText = document.getElementById('sidebar-app-text-ai');
            if (aiText) {
                aiText.style.background = `linear-gradient(to right, ${window.currentGradient.start}, ${window.currentGradient.end})`;
                aiText.style.webkitBackgroundClip = 'text';
                aiText.style.webkitTextFillColor = 'transparent';
            }

            const indPrim = document.getElementById('tm-indicator-primary');
            const indAcc = document.getElementById('tm-indicator-accent');
            const badgePrim = document.getElementById('tm-badge-primary');
            const badgeAcc = document.getElementById('tm-badge-accent');

            if (indPrim) indPrim.style.backgroundColor = window.currentGradient.start;
            if (indAcc) indAcc.style.backgroundColor = window.currentGradient.end;
            if (badgePrim) { badgePrim.innerText = window.currentGradient.start; badgePrim.style.color = window.currentGradient.start; }
            if (badgeAcc) { badgeAcc.innerText = window.currentGradient.end; badgeAcc.style.color = window.currentGradient.end; }

            const orb = document.getElementById('tm-preview-gradient');
            if (orb) {
                orb.style.background = `linear-gradient(135deg, ${window.currentGradient.start}, ${window.currentGradient.end})`;
            }

            if (typeof window.sidebarRingChart !== 'undefined' && window.sidebarRingChart) {
                window.sidebarRingChart.updateOptions({ colors: [window.currentGradient.start] });
                const chartEl = document.getElementById('sidebarRingChart');
                if (chartEl) chartEl.style.transform = "scale(1.25)";
            }
        });
    </script>

    <script>
        // OVERRIDE: Update Monthly Totals with NO CENTS (User Request)
        window.updateMonthlyTotals = function () {
            // Fallback to safe defaults
            const incomeEl = document.getElementById('monthly-income');
            const expensesEl = document.getElementById('monthly-expenses');
            const balanceEl = document.getElementById('w-net-balance');

            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            let monthlyIncome = 0;
            let monthlyExpenses = 0;
            let netBalance = 0; // Calculated from scratch to ensure sync

            if (window.appState && window.appState.transactions) {
                window.appState.transactions.forEach(t => {
                    const txDate = new Date(t.dateIso || t.id);
                    if (txDate.getMonth() === currentMonth && txDate.getFullYear() === currentYear) {
                        if (t.type === 'income') monthlyIncome += parseFloat(t.amount);
                        else if (t.type === 'expense') monthlyExpenses += parseFloat(t.amount);
                    }
                });
            }

            // READ PROFILE BALANCE for accurate Wallet Balance
            // Wallet Balance = Initial Balance + All Time Income - All Time Expenses
            // OR: Just sum appState.balanceAccounts? 
            // User wants "Total Balance" consistent. 
            // Let's use the same logic as Dashboard Stats if possible, or just sum account balances if they exist.

            // OPTION B: Calculated Global Net Worth (Consistent with Dashboard)
            // User requested consistency between Dashboard and Wallet.

            // 1. Get Initial Balance
            let globalBalance = 0;
            if (window.appState && window.appState.profile && window.appState.profile.balance !== undefined) {
                const rawIB = window.appState.profile.balance;
                const val = typeof rawIB === 'string' ? parseFloat(rawIB.replace(/[^0-9.-]/g, '')) : parseFloat(rawIB);
                globalBalance += val || 0;
            }

            // 2. Add All Time Transactions
            if (window.appState && window.appState.transactions) {
                window.appState.transactions.forEach(t => {
                    const amount = parseFloat(t.amount);
                    if (t.type === 'income') globalBalance += amount;
                    else if (t.type === 'expense') globalBalance -= amount;
                });
            }

            // FORMATTER: No Cents
            const fmt = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(num);

            if (incomeEl) incomeEl.innerText = fmt(monthlyIncome);
            if (expensesEl) expensesEl.innerText = fmt(monthlyExpenses);
            if (balanceEl) {
                // Now using Global Balance for consistency
                balanceEl.innerText = fmt(globalBalance);
            }
        };

        // --- SYSTEM PREFERENCES LOGIC ---

        function changePassword() {
            Swal.fire({
                title: 'Cambiar Contraseña',
                text: 'Por seguridad, este cambio requerirá verificación de dos pasos en el futuro. Por ahora, ingresa tu nueva contraseña:',
                input: 'password',
                inputPlaceholder: 'Nueva contraseña',
                showCancelButton: true,
                confirmButtonText: 'Actualizar',
                confirmButtonColor: '#6366f1',
                background: '#1e293b',
                color: '#fff',
                customClass: {
                    input: 'bg-slate-800 border-slate-600 text-white'
                }
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    const newPass = result.value;
                    document.getElementById('profile-password-input').value = newPass; // Update UI

                    // Update AppState if needed (Mock)
                    if (appState.profile) {
                        appState.profile.password = newPass;
                        saveState();
                    }

                    Swal.fire({
                        icon: 'success',
                        title: 'Actualizado',
                        text: 'Tu contraseña ha sido actualizada correctamente.',
                        background: '#1e293b',
                        color: '#fff',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
            });
        }

        function setAIPersona(type) {
            // Reset all
            document.querySelectorAll('.persona-card').forEach(el => {
                // Reset to default inert state
                el.className = 'persona-card relative p-4 rounded-2xl border border-white/5 bg-[#161b22] hover:bg-[#1c222e] hover:border-white/10 cursor-pointer group overflow-hidden transition-all duration-300';
            });

            // Set Active
            const activeEl = document.getElementById('persona-' + type);
            if (!activeEl) return;

            // Define styles map
            const styles = {
                'advisor': {
                    card: 'bg-indigo-500/10 border-indigo-500 shadow-[0_0_20px_rgba(99,102,241,0.15)] ring-1 ring-indigo-500/50',
                },
                'coach': {
                    card: 'bg-orange-500/10 border-orange-500 shadow-[0_0_20px_rgba(249,115,22,0.15)] ring-1 ring-orange-500/50',
                },
                'strategist': {
                    card: 'bg-emerald-500/10 border-emerald-500 shadow-[0_0_20px_rgba(16,185,129,0.15)] ring-1 ring-emerald-500/50',
                }
            };

            const s = styles[type];
            if (s) {
                activeEl.className = `persona-card active relative p-4 rounded-2xl border ${s.card} cursor-pointer group overflow-hidden transition-all duration-300`;
            }

            // Optional Notification
            const titles = { 'advisor': 'Balanced Advisor', 'coach': 'Strict Coach', 'strategist': 'Growth Strategist' };
            if (typeof Swal !== 'undefined') {
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.onmouseenter = Swal.stopTimer;
                        toast.onmouseleave = Swal.resumeTimer;
                    }
                });
                Toast.fire({
                    icon: 'success',
                    title: `Persona Activated: ${titles[type]}`
                });
            }
        }

        function toggleBiometric(el) {
            const isChecked = el.checked;
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: isChecked ? 'success' : 'info',
                    title: isChecked ? 'Biometrics Enabled' : 'Biometrics Disabled',
                    text: isChecked ? 'FaceID login is now active' : 'You will need to use your password',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    background: '#1e293b',
                    color: '#fff'
                });
            }
        }

        function setAutoLock(minutes) {
            if (typeof Swal !== 'undefined') {
                const text = minutes === 'off' ? 'Auto-Lock Disabled' : `Auto-Lock set to ${minutes} min`;
                Swal.fire({
                    icon: 'info',
                    title: 'Security Updated',
                    text: text,
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    background: '#1e293b',
                    color: '#fff'
                });
            }
        }

        function togglePrivacyMask(enabled) {
            if (enabled) {
                document.body.classList.add('mask-active');
            } else {
                document.body.classList.remove('mask-active');
            }

            // Persist in AppState
            if (typeof appState !== 'undefined') {
                if (!appState.settings) appState.settings = {};
                appState.settings.privacyMask = enabled;
                if (typeof saveState === 'function') saveState();
            }

            // Feedback
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: enabled ? 'success' : 'info',
                    title: enabled ? 'Privacy Mode Active' : 'Privacy Mode Disabled',
                    text: enabled ? 'Sensitive data is now masked' : 'All balances are visible',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    background: '#1e293b',
                    color: '#fff'
                });
            }
        }

        // Restore Privacy Mask on Load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (typeof appState !== 'undefined' && appState.settings && appState.settings.privacyMask) {
                    const chk = document.getElementById('chk-privacy-mask');
                    if (chk) chk.checked = true;
                    document.body.classList.add('mask-active');
                }
            }, 500); // Slight delay to ensure elements exist
        });
    </script>

    <!-- --- APP LOCK OVERLAY --- -->
    <div id="view-login"
        class="fixed inset-0 z-[1000] hidden pointer-events-auto flex flex-col items-center justify-center">
        <!-- Blur Backdrop -->
        <div class="absolute inset-0 bg-[#0B0D14]/90 backdrop-blur-3xl transition-all duration-1000"></div>

        <!-- Firebase SDK (Modular) -->
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
            import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
            window.firebaseModules = { initializeApp, getAuth, signInWithPopup, GoogleAuthProvider };
        </script>

        <!-- Lock Content -->
        <div class="absolute inset-0 flex flex-col items-center justify-center p-6">
            <div id="lock-modal-container"
                class="w-full max-w-sm bg-[#141724]/60 backdrop-blur-2xl rounded-[3rem] p-12 border border-white/10 shadow-[0_0_80px_rgba(0,0,0,0.6)] flex flex-col items-center relative overflow-hidden group">

                <!-- Ambient Deco -->
                <div class="absolute -top-20 -right-20 w-40 h-40 bg-indigo-500/20 rounded-full blur-[60px]"></div>
                <div class="absolute -bottom-20 -left-20 w-40 h-40 bg-purple-500/20 rounded-full blur-[60px]"></div>

                <!-- Brand Logo (Centered Branding) -->
                <div
                    class="w-24 h-24 rounded-full p-0.5 bg-gradient-to-tr from-indigo-500/20 to-purple-500/20 mb-8 shadow-2xl relative z-10 scale-100 group-hover:scale-105 transition-transform duration-700">
                    <div
                        class="w-full h-full rounded-full bg-[#141724] border border-white/10 flex items-center justify-center overflow-hidden relative">
                        <!-- Ambient Glow inside circle -->
                        <div class="absolute inset-0 bg-indigo-500/10 blur-xl"></div>
                        <img src="assets/logo.svg" alt="Aureus Logo"
                            class="w-16 h-16 relative z-10 drop-shadow-[0_0_15px_rgba(99,102,241,0.5)]">
                    </div>
                </div>

                <h2 class="text-3xl font-black text-white tracking-tight mb-2 relative z-10">AUREUS AI</h2>
                <p id="login-subtext"
                    class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.25em] mb-10 relative z-10">System
                    Locked</p>

                <!-- Onboarding Message (Shown for new users) -->
                <div id="login-onboarding-msg" class="hidden text-center mb-8 relative z-10 animate-fade-in-up">
                    <p class="text-indigo-400 font-bold text-sm mb-2">Bienvenido a Aureus OS</p>
                    <p class="text-slate-400 text-[10px] leading-relaxed uppercase tracking-wider">Por favor, inicie
                        sesión con Google para configurar su cuenta.</p>
                </div>

                <!-- Login Methods Container -->
                <div class="w-full relative z-10">
                    <!-- Credentials Section (Primary) -->
                    <div id="login-credentials-section" class="flex flex-col gap-4 animate-fade-in-up">
                        <div class="space-y-3">
                            <input type="text" id="login-user" placeholder="Usuario"
                                class="w-full bg-[#0B0D14] border border-white/5 rounded-2xl px-5 py-3.5 text-white text-sm font-medium focus:outline-none focus:border-indigo-500/50 transition-all placeholder-slate-700">
                            <input type="password" id="login-pass" placeholder="Contraseña"
                                class="w-full bg-[#0B0D14] border border-white/5 rounded-2xl px-5 py-3.5 text-white text-sm font-medium focus:outline-none focus:border-indigo-500/50 transition-all placeholder-slate-700 font-mono tracking-widest"
                                onkeypress="if(event.key === 'Enter') AuthService.loginWithCredentials()">
                        </div>
                        <button onclick="AuthService.loginWithCredentials()"
                            class="w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-2xl font-black text-[10px] tracking-[0.2em] shadow-lg shadow-indigo-500/20 transition-all active:scale-[0.98] uppercase">
                            ENTRAR
                        </button>
                    </div>
                </div>

                <!-- GOOGLE BUTTON (Primary for new users) -->
                <div class="relative z-10 w-full mt-8 pt-8 border-t border-white/5">
                    <button onclick="AuthService.loginWithGoogle()"
                        class="w-full bg-white text-slate-900 rounded-2xl py-4 px-4 font-black text-[11px] tracking-[0.15em] flex items-center justify-center gap-3 hover:bg-slate-100 transition-all shadow-xl active:scale-[0.98] uppercase group">
                        <svg class="w-5 h-5 flex-shrink-0" viewBox="0 0 24 24">
                            <path fill="#4285F4"
                                d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                            <path fill="#34A853"
                                d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                            <path fill="#FBBC05"
                                d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                            <path fill="#EA4335"
                                d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                        </svg>
                        Sign in with Google
                    </button>
                    <p id="google-auth-note"
                        class="hidden text-[10px] text-center text-slate-600 mt-4 uppercase tracking-widest font-bold">
                        Secure Verification Required</p>
                </div>

                <!-- USER ACTIONS (Add User / Logout) -->
                <div class="relative z-10 w-full mt-6 flex flex-wrap justify-center gap-3">
                    <button onclick="AuthService.showRegister()"
                        class="min-w-[140px] py-3.5 px-6 rounded-2xl bg-indigo-500/5 hover:bg-indigo-500/10 border border-indigo-500/10 text-indigo-400/60 hover:text-indigo-400 text-[9px] font-black tracking-[0.2em] transition-all uppercase flex items-center justify-center gap-2">
                        <i data-lucide="user-plus" class="w-3.5 h-3.5"></i>
                        Nuevo Usuario
                    </button>
                    <button id="btn-lock-logout" onclick="handleLogout()"
                        class="hidden min-w-[140px] py-3.5 px-6 rounded-2xl bg-rose-500/5 hover:bg-rose-500/10 border border-rose-500/10 text-rose-500/60 hover:text-rose-400 text-[9px] font-black tracking-[0.2em] transition-all uppercase flex items-center justify-center gap-2">
                        <i data-lucide="log-out" class="w-3.5 h-3.5"></i>
                        Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- --- ARCHITECTURE: SECURITY & ACCESS ENGINE-- - -->
    <script>
        let idleSeconds = 0;
        let isLocked = false;

        // 1. Initialize Settings
        function initSecuritySettings() {
            if (!appState.settings) appState.settings = {};
            if (!appState.settings.security) {
                appState.settings.security = {
                    biometricEnabled: false,
                    autoLockMinutes: 5
                };
            }

            // Sync UI
            const chkBio = document.getElementById('chk-biometric');
            const selLock = document.getElementById('sel-autolock');
            if (chkBio) chkBio.checked = appState.settings.security.biometricEnabled;
            if (selLock) selLock.value = appState.settings.security.autoLockMinutes;
        }

        // 2. Toggle Biometric
        function toggleBiometric(enabled) {
            appState.settings.security.biometricEnabled = enabled;
            saveState();

            Swal.fire({
                toast: true, position: 'top-end', icon: 'success',
                title: enabled ? 'Biometrics Enabled' : 'Biometrics Disabled',
                background: '#1E293B', color: '#fff', showConfirmButton: false, timer: 1500
            });
        }

        // 3. Set Auto-Lock
        function setAutoLock(minutes) {
            appState.settings.security.autoLockMinutes = minutes;
            saveState();
            idleSeconds = 0; // Reset on change
        }

        // 4. Lock Logic
        function lockApp() {
            if (isLocked) return;
            const screen = document.getElementById('view-login');
            if (!screen) return;

            isLocked = true;
            screen.classList.remove('hidden');
            screen.classList.add('flex');

            // Sync UI state for Lock Screen
            syncLockScreenSessionState();

            // Prepare UI
            const userBox = document.getElementById('login-user');
            if (userBox) userBox.focus();

            // Sync image
            if (appState.profile && appState.profile.image && document.getElementById('lock-profile-img')) {
                document.getElementById('lock-profile-img').src = appState.profile.image;
            }
        }

        function unlockApp() {
            isLocked = false;
            idleSeconds = 0;
            const screen = document.getElementById('view-login');
            if (screen) screen.classList.add('hidden');

            Swal.fire({
                toast: true, position: 'top-end', icon: 'success', title: 'Unlocked',
                background: '#1E293B', color: '#fff', showConfirmButton: false, timer: 1000
            });
        }

        // 5. Session Sync Logic
        function syncLockScreenSessionState() {
            const hasSession = localStorage.getItem('aureus_session_token');
            const logoutBtn = document.getElementById('btn-lock-logout');
            const subtext = document.getElementById('login-subtext');
            const welcomeMsg = document.getElementById('login-onboarding-msg');

            if (logoutBtn) {
                if (hasSession) {
                    logoutBtn.classList.remove('hidden');
                    logoutBtn.classList.add('flex');
                    subtext.innerText = "System Locked";
                    if (welcomeMsg) welcomeMsg.classList.add('hidden');
                } else {
                    logoutBtn.classList.add('hidden');
                    logoutBtn.classList.remove('flex');
                    subtext.innerText = "Bienvenido";
                    // If no session and no registered user, show onboarding
                    if (welcomeMsg && !localStorage.getItem('aureus_custom_user')) {
                        welcomeMsg.classList.remove('hidden');
                    }
                }
            }
        }

        // Simulated FaceID/TouchID Success
        function simulatedBiometricAuth() {
            const status = document.getElementById('lock-status');
            status.innerText = "Authenticating...";
            status.classList.add('text-emerald-400');

            setTimeout(() => {
                unlockApp();
            }, 800);
        }

        // 6. Global Monitor
        document.addEventListener('DOMContentLoaded', () => {
            initSecuritySettings();
            syncLockScreenSessionState();

            // Activity Tracking
            const resetIdle = () => { idleSeconds = 0; };
            ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart'].forEach(evt => {
                document.addEventListener(evt, resetIdle, true);
            });

            setInterval(() => {
                if (isLocked) return;
                const limit = appState.settings.security.autoLockMinutes;
                if (limit === 'off') return;

                idleSeconds++;
                if (idleSeconds >= parseInt(limit) * 60) {
                    lockApp();
                }
            }, 1000);
        });

        // ============================================
        //      NEW SAVINGS INFRASTRUCTURE (v2)
        // ============================================

        function _deprecated_renderSavingsTab_v2() {
            initSavingsData(); // Ensure migration runs once

            // Calculation Constants
            const portfolio = appState.portfolio || [];
            const assets = portfolio.filter(i => i.type === 'asset');
            const goals = portfolio.filter(i => i.type === 'goal');

            const totalAssets = assets.reduce((sum, i) => sum + i.amount, 0);
            const totalGoals = goals.reduce((sum, i) => sum + i.amount, 0);
            const grandTotal = totalAssets + totalGoals;

            // Update Header Stats
            const totalDebt = (appState.debts || []).reduce((acc, d) => acc + (d.total - d.current_paid), 0);
            const netWorth = grandTotal - totalDebt;

            const nwEl = document.getElementById('savings-net-worth');
            if (nwEl) nwEl.innerText = formatCurrency(netWorth);
            const nwHeaderEl = document.getElementById('savings-net-worth-header');
            if (nwHeaderEl) nwHeaderEl.innerText = formatCurrency(netWorth);

            // Render Debt List (Preserved)
            const debtListEl = document.getElementById('savings-debt-list');
            if (debtListEl) {
                if (!appState.debts || appState.debts.length === 0) {
                    debtListEl.innerHTML = `<div class="text-center text-slate-500 py-4 text-xs">Sin deudas registradas</div>`;
                } else {
                    debtListEl.innerHTML = appState.debts.map(d => {
                        const remaining = d.total - d.current_paid;
                        const pct = Math.min(100, Math.round((d.current_paid / d.total) * 100));
                        return `
                         <div onclick="manageDebtItem(${d.id})" class="bg-[#161b22] rounded-2xl p-4 border border-white/5 relative overflow-hidden group cursor-pointer hover:border-red-500/30 transition shadow-lg">
                             <div class="flex justify-between items-center mb-2 relative z-10">
                                 <div class="flex items-center gap-3">
                                     <div class="w-10 h-10 rounded-full bg-red-500/10 flex items-center justify-center text-red-500 transition-transform group-hover:scale-110">
                                         <i data-lucide="${d.icon || 'credit-card'}" class="w-5 h-5"></i>
                                     </div>
                                     <div>
                                         <p class="text-white font-bold text-sm group-hover:text-red-400 transition">${d.name}</p>
                                         <p class="text-xs text-slate-500 uppercase tracking-wider font-bold">Deuda</p>
                                     </div>
                                 </div>
                                 <div class="text-right">
                                     <p class="text-white font-bold font-mono">${formatCurrency(remaining)}</p>
                                     <p class="text-[10px] text-slate-500 uppercase tracking-wide">Restante</p>
                                 </div>
                              </div>
                             <!-- Bar -->
                             <div class="w-full h-1.5 bg-[#0B0D14] rounded-full overflow-hidden mt-2 border border-white/5">
                                 <div class="h-full bg-gradient-to-r from-red-600 to-red-400 w-0 transition-all duration-1000 group-hover:shadow-[0_0_10px_rgba(239,68,68,0.5)]" style="width: ${pct}%"></div>
                             </div>
                         </div>
                         `;
                    }).join('');
                }
            }

            // Render Grid
            const gridEl = document.getElementById('savings-goals-grid');
            if (gridEl) {
                let itemsHtml = '';

                // Render ALL Portfolio Items
                portfolio.forEach(item => {
                    itemsHtml += createSavingsCard(item);
                });

                // Add "New Item" Button
                itemsHtml += `
                 <button onclick="addPortfolioItemModal()" class="flex flex-col items-center justify-center p-6 rounded-[2rem] bg-[#161b22] border border-white/5 border-dashed hover:bg-[#1a202c] hover:border-emerald-500/50 hover:shadow-[0_0_30px_rgba(16,185,129,0.1)] transition-all duration-500 gap-4 group min-h-[190px] relative overflow-hidden">
                    <div class="absolute inset-0 bg-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <div class="w-16 h-16 rounded-2xl bg-white/5 flex items-center justify-center group-hover:bg-emerald-500/20 group-hover:text-emerald-400 text-slate-500 transition-all duration-500 group-hover:scale-110 shadow-inner group-hover:rotate-3 relative z-10">
                        <i data-lucide="plus" class="w-8 h-8"></i>
                    </div>
                    <span class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500 group-hover:text-emerald-400 transition-colors relative z-10">Nuevo</span>
                 </button>
                `;

                gridEl.innerHTML = itemsHtml;
                lucide.createIcons();
            }
        }

        function createSavingsCard(item) {
            // Theme Config (Reusing your preferred styles)
            const themes = {
                emerald: { text: 'text-emerald-400', bg: 'bg-emerald-500/10', border: 'hover:border-emerald-500/50', shadow: 'hover:shadow-emerald-500/20', bar: 'from-emerald-500 to-teal-400', iconBg: 'bg-emerald-500/20' },
                blue: { text: 'text-blue-400', bg: 'bg-blue-500/10', border: 'hover:border-blue-500/50', shadow: 'hover:shadow-blue-500/20', bar: 'from-blue-500 to-cyan-400', iconBg: 'bg-blue-500/20' },
                indigo: { text: 'text-indigo-400', bg: 'bg-indigo-500/10', border: 'hover:border-indigo-500/50', shadow: 'hover:shadow-indigo-500/20', bar: 'from-indigo-500 to-violet-400', iconBg: 'bg-indigo-500/20' },
                pink: { text: 'text-pink-400', bg: 'bg-pink-500/10', border: 'hover:border-pink-500/50', shadow: 'hover:shadow-pink-500/20', bar: 'from-pink-500 to-rose-400', iconBg: 'bg-pink-500/20' },
                violet: { text: 'text-violet-400', bg: 'bg-violet-500/10', border: 'hover:border-violet-500/50', shadow: 'hover:shadow-violet-500/20', bar: 'from-violet-500 to-fuchsia-400', iconBg: 'bg-violet-500/20' },
                amber: { text: 'text-amber-400', bg: 'bg-amber-500/10', border: 'hover:border-amber-500/50', shadow: 'hover:shadow-amber-500/20', bar: 'from-amber-500 to-orange-400', iconBg: 'bg-amber-500/20' },
                cyan: { text: 'text-cyan-400', bg: 'bg-cyan-500/10', border: 'hover:border-cyan-500/50', shadow: 'hover:shadow-cyan-500/20', bar: 'from-cyan-500 to-sky-400', iconBg: 'bg-cyan-500/20' },
            };

            const t = themes[item.theme] || themes.emerald;

            // Progress Logic
            let progressBlock = '';
            if (item.target > 0) {
                const pct = Math.min(100, Math.round((item.amount / item.target) * 100));
                progressBlock = `
                    <div class="mt-5">
                        <div class="flex justify-between items-end mb-2">
                            <span class="text-[9px] font-black uppercase tracking-widest text-slate-500">Meta: ${formatCurrency(item.target)}</span>
                            <span class="text-[10px] font-bold ${t.text}">${pct}%</span>
                        </div>
                        <div class="w-full h-1.5 bg-[#0B0D14] rounded-full overflow-hidden border border-white/5 relative">
                            <div class="absolute inset-0 bg-white/5"></div>
                            <div class="h-full bg-gradient-to-r ${t.bar} rounded-full shadow-[0_0_10px_rgba(0,0,0,0.5)] transition-all duration-1000 relative" style="width: ${pct}%">
                                <div class="absolute right-0 top-0 bottom-0 w-1 bg-white/50 blur-[1px]"></div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                progressBlock = `
                    <div class="mt-5 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center gap-2">
                         <span class="text-[9px] font-bold text-slate-600 uppercase tracking-widest">Sin Meta Global</span>
                         <div class="h-px flex-1 bg-white/5"></div>
                    </div>
                `;
            }

            return `
                <div onclick="managePortfolioItem('${item.id}')" class="relative group cursor-pointer flex flex-col p-6 rounded-[2rem] bg-[#161b22] border border-white/5 ${t.border} hover:bg-[#1a202c] transition-all duration-500 ${t.shadow} overflow-hidden min-h-[190px]">
                    <!-- Ambient Light -->
                    <div class="absolute -top-20 -right-20 w-48 h-48 rounded-full ${t.bg} blur-[60px] opacity-20 group-hover:opacity-40 transition-opacity duration-700 pointer-events-none"></div>
                    
                    <!-- Header -->
                    <div class="flex justify-between items-start relative z-10 mb-4">
                        <div class="w-12 h-12 rounded-2xl ${t.iconBg} flex items-center justify-center ${t.text} border border-white/5 shadow-inner transition-transform duration-500 group-hover:scale-110 group-hover:rotate-6">
                            <i data-lucide="${item.icon}" class="w-6 h-6"></i>
                        </div>
                        <div class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/5 transition-colors text-slate-600 hover:text-white group/btn">
                             <i data-lucide="arrow-up-right" class="w-4 h-4 transition-transform group-hover/btn:translate-x-0.5 group-hover/btn:-translate-y-0.5"></i>
                        </div>
                    </div>

                    <!-- Body -->
                    <div class="relative z-10">
                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-1 group-hover:text-slate-400 transition ml-1">${item.name}</p>
                        <h3 class="text-3xl font-black text-white tracking-tighter maskable filter drop-shadow-md leading-none">${formatCurrency(item.amount)}</h3>
                    </div>

                    <!-- Footer / Progress -->
                    <div class="relative z-10 mt-auto">
                        ${progressBlock}
                    </div>
                </div>
            `;
        }

        // --- MANAGE MODAL WITH HISTORY ---
        function managePortfolioItem(id) {
            const item = getPortfolioItem(id);
            if (!item) return;

            // Generate History Table Rows
            const historyHtml = item.history.slice().reverse().map((h, idx) => {
                const originalIndex = item.history.length - 1 - idx; // Needed for delete
                const isPositive = h.type === 'in';
                return `
                <div class="flex items-center justify-between p-3 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 transition group/row">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full ${isPositive ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'} flex items-center justify-center">
                            <i data-lucide="${isPositive ? 'arrow-down-left' : 'arrow-up-right'}" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <p class="text-xs font-bold text-white">${h.note}</p>
                            <p class="text-[10px] text-slate-500 font-mono">${new Date(h.date).toLocaleDateString()}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-bold ${isPositive ? 'text-emerald-400' : 'text-red-400'} font-mono">
                            ${isPositive ? '+' : '-'}${formatCurrency(h.amount)}
                        </span>
                        <button onclick="deletePortfolioHistory('${item.id}', ${originalIndex})" class="opacity-0 group-hover/row:opacity-100 text-slate-500 hover:text-red-500 transition">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                `;
            }).join('');

            Swal.fire({
                title: ' ',
                background: '#0B0D14',
                color: '#fff',
                width: 600,
                html: `
                    <!-- Header -->
                    <div class="flex items-start justify-between mb-6 -mt-4">
                        <div class="flex items-center gap-4">
                             <div class="w-16 h-16 rounded-2xl bg-${item.theme}-500/10 flex items-center justify-center text-${item.theme}-400 border border-${item.theme}-500/20">
                                <i data-lucide="${item.icon}" class="w-8 h-8"></i>
                             </div>
                             <div class="text-left">
                                <h2 class="text-2xl font-black text-white">${item.name}</h2>
                                <p class="text-xs text-slate-500 uppercase tracking-widest font-bold">Saldo Actual</p>
                                <p class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-400">${formatCurrency(item.amount)}</p>
                             </div>
                        </div>
                        ${item.subtype !== 'core' ? `
                        <button onclick="deletePortfolioItem('${item.id}'); Swal.close()" class="p-2 rounded-lg bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white transition">
                            <i data-lucide="trash" class="w-5 h-5"></i>
                        </button>` : ''}
                    </div>

                    <!-- Actions -->
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <button onclick="promptTransaction('${item.id}', 'in')" class="p-4 rounded-xl bg-emerald-500/10 border border-emerald-500/20 hover:bg-emerald-500/20 group transition flex flex-col items-center gap-2">
                            <i data-lucide="plus-circle" class="w-6 h-6 text-emerald-400 group-hover:scale-110 transition-transform"></i>
                            <span class="text-xs font-bold text-emerald-400 uppercase tracking-wider">Depositar</span>
                        </button>
                        <button onclick="promptTransaction('${item.id}', 'out')" class="p-4 rounded-xl bg-red-500/10 border border-red-500/20 hover:bg-red-500/20 group transition flex flex-col items-center gap-2">
                             <i data-lucide="minus-circle" class="w-6 h-6 text-red-400 group-hover:scale-110 transition-transform"></i>
                            <span class="text-xs font-bold text-red-400 uppercase tracking-wider">Retirar</span>
                        </button>
                    </div>

                    <!-- History Label -->
                    <div class="text-left mb-3 border-b border-white/5 pb-2 flex justify-between items-end">
                        <h4 class="text-sm font-bold text-white uppercase tracking-wider">Historial</h4>
                        <span class="text-[10px] text-slate-500 font-mono">${item.history.length} transacciones</span>
                    </div>

                    <!-- History Scroll Area -->
                    <div class="max-h-[300px] overflow-y-auto space-y-2 pr-1 custom-scrollbar">
                        ${historyHtml.length > 0 ? historyHtml : '<p class="text-slate-600 text-xs italic py-4">Sin movimientos recientes</p>'}
                    </div>
                `,
                showConfirmButton: false,
                didOpen: () => lucide.createIcons()
            });
        }

        function promptTransaction(id, type) {
            Swal.fire({
                title: type === 'in' ? 'Depositar Fondos' : 'Retirar Fondos',
                background: '#1a1f2e',
                color: '#fff',
                html: `
                    <input id="swal-amount" type="number" class="w-full bg-[#0B0D14] border border-white/10 rounded-xl p-4 text-white text-xl font-mono mb-3 focus:outline-none focus:border-indigo-500 transition" placeholder="0.00">
                    <input id="swal-note" type="text" class="w-full bg-[#0B0D14] border border-white/10 rounded-xl p-3 text-slate-300 text-sm focus:outline-none focus:border-indigo-500 transition" placeholder="Nota opcional (ej: Ahorro mensual)">
                `,
                showCancelButton: true,
                confirmButtonText: 'Confirmar',
                confirmButtonColor: type === 'in' ? '#10b981' : '#ef4444',
                cancelButtonText: 'Cancelar',
                cancelButtonColor: '#334155',
                preConfirm: () => {
                    return {
                        amount: document.getElementById('swal-amount').value,
                        note: document.getElementById('swal-note').value
                    }
                }
            }).then((result) => {
                if (result.isConfirmed && result.value.amount) {
                    updatePortfolioTransaction(id, result.value.amount, type, result.value.note);
                    managePortfolioItem(id); // Re-open parent modal to show update
                }
            });
        }

        function addPortfolioItemModal() {
            // Simple implementation for creating new assets
            Swal.fire({
                title: 'Nuevo Activo',
                background: '#0B0D14',
                color: '#fff',
                html: `
                    <div class="space-y-4 text-left">
                        <div>
                            <label class="text-xs text-slate-500 uppercase font-bold">Nombre</label>
                            <input id="new-name" class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:outline-none focus:border-emerald-500">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs text-slate-500 uppercase font-bold">Tipo</label>
                                <select id="new-type" class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:outline-none">
                                    <option value="asset">Activo (Liquido)</option>
                                    <option value="goal">Meta (Ahorro)</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-slate-500 uppercase font-bold">Meta ($)</label>
                                <input id="new-target" type="number" class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:outline-none">
                            </div>
                        </div>
                    </div>
                `,
                confirmButtonText: 'Crear Activo',
                confirmButtonColor: '#10b981',
                preConfirm: () => {
                    const name = document.getElementById('new-name').value;
                    if (!name) Swal.showValidationMessage('El nombre es requerido');
                    return {
                        name: name,
                        type: document.getElementById('new-type').value,
                        target: document.getElementById('new-target').value
                    }
                }
            }).then(res => {
                if (res.isConfirmed) {
                    addPortfolioItem(res.value.type, res.value.name, res.value.target, 'piggy-bank', 'indigo');
                }
            });
        }
    </script>

    <script>
        // --- NAVIGATION & RENDERING LOGIC ---

        // LOGOUT HANDLER
        // LOGOUT HANDLER (Unified)
        window.handleLogout = function () {
            if (window.AuthService) {
                window.AuthService.logout();
            } else {
                console.warn("AuthService not found, falling back to basic logout.");
                localStorage.removeItem('aureus_session_token');
                window.location.reload();
            }
        };

        function switchTab(tabId) {
            console.log('Switching to tab:', tabId);

            // 1. Hide all tab content
            const allTabs = document.querySelectorAll('.tab-content');
            allTabs.forEach(tab => {
                tab.classList.add('hidden');
                tab.classList.remove('active');
            });

            // 2. Show target tab
            const targetId = 'view-' + tabId;
            const targetTab = document.getElementById(targetId);
            if (targetTab) {
                targetTab.classList.remove('hidden');
                setTimeout(() => targetTab.classList.add('active'), 50);
            } else {
                console.warn('Tab ID not found:', targetId);
                // Fallback: If wallet/budget are missing, specific handling might be needed
            }

            // 3. Update Sidebar Navigation
            const navLinks = document.querySelectorAll('.nav-item');
            navLinks.forEach(link => {
                // Reset styles
                link.classList.remove('bg-white/10', 'text-white', 'shadow-glow', 'border-white/20');
                link.classList.add('text-slate-400', 'border-white/5');
            });

            const activeLink = document.getElementById('nav-' + tabId);
            if (activeLink) {
                activeLink.classList.remove('text-slate-400', 'border-white/5');
                activeLink.classList.add('bg-white/10', 'text-white', 'shadow-glow', 'border-white/20');
            }

            // 4. Tab Specific Initializations
            if (tabId === 'dashboard') {
                if (typeof renderMegaDashboard === 'function') {
                    renderMegaDashboard();
                }
            } else if (tabId === 'savings') {
                if (typeof _deprecated_renderSavingsTab_v2 === 'function') _deprecated_renderSavingsTab_v2();
            } else if (tabId === 'settings') {
                if (typeof initSecuritySettings === 'function') initSecuritySettings();
            } else if (tabId === 'analytics-overview') {
                if (typeof renderAnalyticsOverview === 'function') renderAnalyticsOverview();
            } else if (tabId === 'budget') {
                if (typeof renderBudgetTab === 'function') renderBudgetTab();
            }

            // 5. Global UI Refresh
            if (typeof lucide !== 'undefined') lucide.createIcons();

            // 6. Persist
            localStorage.setItem('currentTab', tabId);
        }

        // Initialize on Load
        document.addEventListener('DOMContentLoaded', () => {
            const savedTab = localStorage.getItem('currentTab') || 'dashboard';
            // Delay slightly to ensure DOM is ready
            setTimeout(() => switchTab(savedTab), 100);
        });

        // Financial Summary Popup
        function showFinancialSummary() {
            // 1. Calculate Totals
            const transactions = appState.transactions || [];
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
            const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
            const balance = income - expenses;

            const budgetTotal = Object.values(appState.budget || {}).reduce((sum, val) => sum + (parseFloat(val) || 0), 0);

            // 2. Format Currency
            const fmt = (val) => {
                return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(val);
            };

            // 3. Show Popup
            Swal.fire({
                title: '<span class="text-white">Resumen Financiero</span>',
                html: `
                    <div class="space-y-4 text-left p-2">
                        <div class="bg-dark-900 p-4 rounded-xl border border-white/5">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-slate-400 text-xs uppercase font-bold tracking-wider">Total Ingresos</span>
                                <span class="text-emerald-400 font-mono font-bold text-lg">${fmt(income)}</span>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-slate-400 text-xs uppercase font-bold tracking-wider">Total Gastos</span>
                                <span class="text-rose-400 font-mono font-bold text-lg">${fmt(expenses)}</span>
                            </div>
                            <div class="h-px bg-white/10 my-2"></div>
                            <div class="flex justify-between items-center">
                                <span class="text-white text-sm uppercase font-bold tracking-wider">Balance Neto</span>
                                <span class="${balance >= 0 ? 'text-emerald-400' : 'text-rose-400'} font-mono font-black text-xl">${fmt(balance)}</span>
                            </div>
                        </div>

                        <div class="bg-dark-900 p-4 rounded-xl border border-white/5">
                            <div class="flex justify-between items-center">
                                <div class="flex flex-col">
                                    <span class="text-slate-400 text-xs uppercase font-bold tracking-wider">Presupuesto Mensual</span>
                                    <span class="text-[10px] text-slate-500">Límite Global Configurado</span>
                                </div>
                                <span class="text-indigo-400 font-mono font-bold text-lg">${fmt(budgetTotal)}</span>
                            </div>
                        </div>
                    </div>
                `,
                background: '#161b22',
                confirmButtonColor: '#6366f1',
                confirmButtonText: 'Cerrar',
                customClass: {
                    popup: 'border border-white/10 rounded-[2rem] shadow-2xl shadow-indigo-500/10'
                }
            });
        }
    </script>
    <script src="financial_analyst_v2.js"></script>

    <style>
        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            75% {
                transform: translateX(10px);
            }
        }

        .animate-shake {
            animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
        }
    </style>

    <script type="module" src="firebase_bootstrap.js"></script>
    <script src="chart_component.js?v=4"></script>
    <script src="budget_analytics.js"></script>
    <script src="theme_utils.js"></script>
    <script src="wallpaper_utils.js"></script>
    <script src="localization_utils.js"></script>
    <script src="financial_analyst_v2.js"></script>
    <script src="savings_core_v2.js"></script>
    <!-- --- MOBILE BOTTOM NAV --- -->
    <nav id="mobile-bottom-nav"
        class="lg:hidden fixed bottom-0 inset-x-0 z-50 bg-[#0B0D14]/80 backdrop-blur-xl border-t border-white/10 pb-6 pt-3 px-6 flex justify-between items-center animate-fade-in-up">
        <!-- Dashboard -->
        <button onclick="switchTab('dashboard'); setTimeout(renderMegaDashboard, 100);"
            class="flex flex-col items-center gap-1 group">
            <div
                class="w-10 h-10 rounded-2xl flex items-center justify-center bg-white/5 group-hover:bg-indigo-500/20 text-slate-400 group-hover:text-indigo-400 transition-all duration-300">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
            </div>
            <span
                class="text-[9px] font-bold text-slate-500 group-hover:text-white uppercase tracking-wider">Inicio</span>
        </button>

        <!-- Wallet -->
        <button onclick="switchTab('wallet');" class="flex flex-col items-center gap-1 group">
            <div
                class="w-10 h-10 rounded-2xl flex items-center justify-center bg-white/5 group-hover:bg-emerald-500/20 text-slate-400 group-hover:text-emerald-400 transition-all duration-300">
                <i data-lucide="wallet" class="w-5 h-5"></i>
            </div>
            <span
                class="text-[9px] font-bold text-slate-500 group-hover:text-white uppercase tracking-wider">Wallet</span>
        </button>

        <!-- Add Button (Floating Center) -->
        <button onclick="openAddTransactionModal()"
            class="-mt-8 w-14 h-14 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-600 shadow-[0_0_20px_rgba(99,102,241,0.5)] flex items-center justify-center text-white border-4 border-[#0B0D14] transform active:scale-95 transition-all">
            <i data-lucide="plus" class="w-6 h-6"></i>
        </button>

        <!-- Finanzas -->
        <button onclick="switchTab('budget'); setTimeout(renderBudgetTabAnalytics, 200);"
            class="flex flex-col items-center gap-1 group">
            <div
                class="w-10 h-10 rounded-2xl flex items-center justify-center bg-white/5 group-hover:bg-purple-500/20 text-slate-400 group-hover:text-purple-400 transition-all duration-300">
                <i data-lucide="landmark" class="w-5 h-5"></i>
            </div>
            <span
                class="text-[9px] font-bold text-slate-500 group-hover:text-white uppercase tracking-wider">Plan</span>
        </button>

        <!-- Settings -->
        <button onclick="switchTab('settings');" class="flex flex-col items-center gap-1 group">
            <div
                class="w-10 h-10 rounded-2xl flex items-center justify-center bg-white/5 group-hover:bg-pink-500/20 text-slate-400 group-hover:text-pink-400 transition-all duration-300">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </div>
            <span
                class="text-[9px] font-bold text-slate-500 group-hover:text-white uppercase tracking-wider">Ajustes</span>
        </button>
    </nav>
    <script>
        // --- ROBUST DATA RESET OVERRIDE ---
        // Dies ist der "Nuclear Option" Reset.
        window.clearAllData = function () {
            Swal.fire({
                title: '¿ALERTA: Borrar TODO?',
                text: "Esta acción eliminará TODOS los datos, incluyendo cuentas, historial y configuraciones. ¡Es irreversible!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#334155',
                confirmButtonText: 'Sí, Borrar Todo',
                cancelButtonText: 'Cancelar',
                background: '#0B0D14',
                color: '#fff',
                customClass: {
                    popup: 'rounded-[2rem] border border-red-500/20 shadow-[0_0_50px_rgba(239,68,68,0.2)]'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    console.log("🔥 INITIATING HARD RESET 🔥");

                    // 1. Wipe Storage
                    localStorage.clear();
                    sessionStorage.clear();

                    // 2. Define Empty State
                    const emptyState = {
                        transactions: [],
                        budget: { limit: 2000 },
                        profile: {
                            name: 'User',
                            balance: 0,
                            email: '',
                            image: ''
                        },
                        goals: [],
                        balanceAccounts: {
                            pocket: 0,
                            bank: 0,
                            credit: 0,
                            loan: 0
                        },
                        portfolio: [], // MUST be empty
                        customAssets: [],
                        debts: [],
                        settings: { densityVal: 50, blurVal: 10 }
                    };

                    // 3. FORCE SAVE the empty state to the main key.
                    // This creates a valid "existing" state of 0, so the app doesn't try to "generate" defaults.
                    localStorage.setItem('finance_app_state', JSON.stringify(emptyState));

                    // Also try to help State Manager if it looks for specific keys:
                    // (Though clear() wiped email, so it will likely default to finance_app_state)

                    // 4. Wipe Memory
                    window.appState = emptyState;

                    // 5. Feedback & Reload
                    Swal.fire({
                        title: 'Sistema Reiniciado',
                        text: 'La aplicación ha sido restablecida a cero absoluto.',
                        icon: 'success',
                        background: '#0B0D14',
                        color: '#fff',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        window.location.reload();
                    });
                }
            });
        };
    </script>
    <!-- Ticket Verification Modal -->
    <div id="modal-ticket-verification" class="fixed inset-0 z-[60] hidden" aria-labelledby="modal-title" role="dialog"
        aria-modal="true">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeTicketModal()">
        </div>

        <!-- Modal Panel -->
        <div class="absolute inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div
                    class="relative transform overflow-hidden rounded-[2rem] bg-[#0B0D14] text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-5xl border border-white/10 ring-1 ring-white/5">

                    <!-- Header -->
                    <div
                        class="bg-[#141724] px-6 py-4 border-b border-white/5 flex justify-between items-center relative overflow-hidden">
                        <div
                            class="absolute inset-0 bg-gradient-to-r from-indigo-500/10 to-transparent pointer-events-none">
                        </div>
                        <div class="flex items-center gap-3 relative z-10">
                            <div
                                class="w-10 h-10 rounded-xl bg-indigo-500/20 flex items-center justify-center text-indigo-400 shadow-lg shadow-indigo-500/20">
                                <i data-lucide="scan-line" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-black text-white leading-none tracking-tight">Verificar Ticket
                                </h3>
                                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mt-1">Review AI
                                    Suggestions</p>
                            </div>
                            <!-- Date Input -->
                            <div
                                class="ml-auto mr-4 flex items-center gap-2 bg-black/20 px-3 py-1.5 rounded-lg border border-white/5">
                                <span class="text-[10px] text-slate-400 font-bold uppercase">Date:</span>
                                <input type="date" id="ticket-date-input"
                                    class="bg-transparent border-none text-xs text-white p-0 focus:ring-0 font-mono tracking-tight text-right [color-scheme:dark]">
                            </div>
                        </div>
                        <button onclick="closeTicketModal()"
                            class="text-slate-400 hover:text-white transition bg-white/5 p-2 rounded-full hover:bg-white/10 z-10">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <!-- Content -->
                    <div class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-6">

                        <!-- Left: Image Preview -->
                        <div class="hidden lg:flex flex-col gap-2 h-full min-h-[400px]">
                            <h4 class="text-[10px] uppercase font-bold text-slate-500 tracking-wider">Original Receipt
                            </h4>
                            <div
                                class="flex-1 bg-black/40 rounded-xl border border-white/5 overflow-hidden relative group">
                                <img id="ticket-preview-img" src="" alt="Receipt Preview"
                                    class="w-full h-full object-contain absolute inset-0 transition-transform duration-300 group-hover:scale-110 cursor-zoom-in">
                            </div>
                            <p class="text-[9px] text-slate-600 text-center">Hover to Zoom</p>
                        </div>

                        <!-- Right: List -->
                        <div class="flex flex-col h-full">
                            <!-- List Header -->
                            <div
                                class="grid grid-cols-12 gap-2 text-[9px] uppercase font-bold text-slate-500 mb-2 px-2 tracking-wider">
                                <div class="col-span-1"></div>
                                <div class="col-span-5">Item</div>
                                <div class="col-span-3">Category</div>
                                <div class="col-span-3 text-right">Monto</div>
                            </div>

                            <!-- Scrollable List -->
                            <div id="ticket-items-list"
                                class="max-h-[50vh] overflow-y-auto custom-scrollbar flex flex-col gap-1 pr-2">
                                <!-- Items injected by JS -->
                            </div>

                            <!-- Add Item Button -->
                            <button onclick="addTicketItem()"
                                class="w-full py-2 mt-2 mb-2 text-[10px] font-bold uppercase tracking-wider text-indigo-400 hover:text-indigo-300 border border-dashed border-indigo-500/30 hover:border-indigo-500/50 rounded-lg transition-colors flex items-center justify-center gap-2 group">
                                <i data-lucide="plus-circle"
                                    class="w-3 h-3 group-hover:scale-110 transition-transform"></i> Agregar Item
                            </button>

                            <!-- Total Footer -->
                            <div class="mt-auto pt-4 border-t border-white/10 flex justify-between items-center px-2">
                                <div class="flex flex-col">
                                    <span class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Total
                                        Detectado</span>
                                    <span class="text-[9px] text-slate-600 font-mono">Items verified</span>
                                </div>
                                <div class="text-right">
                                    <span id="ticket-total-display"
                                        class="text-2xl font-black text-emerald-400 tracking-tighter drop-shadow-lg">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer / Actions -->
                    <div class="bg-[#0f111a] px-6 py-4 flex flex-row-reverse gap-3 border-t border-white/5">
                        <button type="button" onclick="saveTicketTransactions()"
                            class="inline-flex w-full justify-center items-center gap-2 rounded-xl bg-indigo-600 px-6 py-3 text-xs font-black text-white shadow-lg shadow-indigo-500/30 hover:bg-indigo-500 sm:w-auto uppercase tracking-wider transition-all hover:scale-105">
                            <i data-lucide="check-circle" class="w-4 h-4"></i> Guardar Todo
                        </button>
                        <button type="button" onclick="closeTicketModal()"
                            class="inline-flex w-full justify-center rounded-xl bg-[#141724] px-6 py-3 text-xs font-bold text-slate-400 shadow-sm ring-1 ring-inset ring-white/10 hover:bg-white/5 hover:text-white sm:mt-0 sm:w-auto uppercase tracking-wider transition-colors">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Budget Analytics (Comparativa Mensual & Burndown) -->
    <script src="budget_analytics.js"></script>

    <!-- Ticket Scanner Logic -->
    <script src="ticket_scanner.js"></script>

</body>

</html>
